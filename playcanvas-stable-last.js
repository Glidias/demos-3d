/*

 PlayCanvas Engine v1.29.0 revision fb8f6a3
 Copyright 2011-2020 PlayCanvas Ltd. All rights reserved.
*/
(function(f,gd){"object"===typeof exports&&"undefined"!==typeof module?gd(exports):"function"===typeof define&&define.amd?define(["exports"],gd):(f=f||self,gd(f.pc={}))})(this,function(f){function gd(a){var b,c=[],d=a.length;for(b=0;b<d;++b)c.push(a[b]);return c}function za(a){if(null===a)return"null";var b=typeof a;return"undefined"===b||"number"===b||"string"===b||"boolean"===b?b:ym[Object.prototype.toString.call(a)]}function Ec(a,b){var c;for(c in b){var d=b[c];"object"==za(d)?a[c]=Ec({},d):"array"==
za(d)?a[c]=Ec([],d):a[c]=d}return a}function kh(a){return void 0!==a}function H(){this._callbacks={};this._callbackActive={}}function lh(a,b){var c=a.length;b=b||0;if(0>b||b>=c)return null;var d=a.charCodeAt(b);return 1<c&&55296<=d&&56319>=d&&(a=a.charCodeAt(b+1),56320<=a&&57343>=a)?{code:1024*(d-55296)+a-56320+65536,long:!0}:{code:d,long:!1}}function Fc(a,b,c){return a?(a=lh(a))?(a=a.code,a>=b&&a<=c):!1:!1}function J(a,b,c,d){var e=a&&a.length;3===e||4===e?(this.r=a[0],this.g=a[1],this.b=a[2],this.a=
void 0!==a[3]?a[3]:1):(this.r=a||0,this.g=b||0,this.b=c||0,this.a=void 0!==d?d:1)}function mh(){this._list=[];this._index={}}function Dj(a){this._index={};this._key=a||null}function Gc(a){H.call(this);this._index={};this._list=[];this._parent=a}function nh(){this._isRunning=!1;this._b=this._a=0}function Kf(a){a=a.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/);this.scheme=a[2];this.authority=a[4];this.path=a[5];this.query=a[7];this.fragment=a[9];this.toString=function(){var a=
"";this.scheme&&(a+=this.scheme+":");this.authority&&(a+="//"+this.authority);a+=this.path;this.query&&(a+="?"+this.query);this.fragment&&(a+="#"+this.fragment);return a};this.getQuery=function(){var a,c={};if(this.query){var d=decodeURIComponent(this.query).split("&");d.forEach(function(b,d,k){a=b.split("=");c[a[0]]=a[1]},this)}return c};this.setQuery=function(a){var b="",d;for(d in a)a.hasOwnProperty(d)&&(""!==b&&(b+="&"),b+=encodeURIComponent(d)+"="+encodeURIComponent(a[d]));this.query=b}}function N(){}
function oh(a,b){this._curve=a;this._left=-Infinity;this._right=Infinity;this._m1=this._m0=this._p1=this._p0=this._recip=0;this._reset(b||0)}function Ya(a){this.keys=[];this.type=1;this.tension=.5;this._eval=new oh(this);if(a)for(var b=0;b<a.length-1;b+=2)this.keys.push([a[b],a[b+1]]);this.sort()}function rb(){var a;this.curves=[];this._type=1;if(1<arguments.length)for(a=0;a<arguments.length;a++)this.curves.push(new Ya(arguments[a]));else if(0===arguments.length)this.curves.push(new Ya);else{var b=
arguments[0];if("number"===pc.type(b))for(a=0;a<b;a++)this.curves.push(new Ya);else for(a=0;a<b.length;a++)this.curves.push(new Ya(b[a]))}}function Cb(){var a=new Float32Array(9);a[0]=a[4]=a[8]=1;this.data=a}function r(a,b,c){a&&3===a.length?(this.x=a[0],this.y=a[1],this.z=a[2]):(this.x=a||0,this.y=b||0,this.z=c||0)}function U(a,b,c,d){a&&4===a.length?(this.x=a[0],this.y=a[1],this.z=a[2],this.w=a[3]):(this.x=a||0,this.y=b||0,this.z=c||0,this.w=d||0)}function C(){var a=new Float32Array(16);a[0]=a[5]=
a[10]=a[15]=1;this.data=a}function T(a,b,c,d){a&&4===a.length?(this.x=a[0],this.y=a[1],this.z=a[2],this.w=a[3]):(this.x=void 0===a?0:a,this.y=void 0===b?0:b,this.z=void 0===c?0:c,this.w=void 0===d?1:d)}function M(a,b){a&&2===a.length?(this.x=a[0],this.y=a[1]):(this.x=a||0,this.y=b||0)}function ia(a,b){this.center=a||new r(0,0,0);this.halfExtents=b||new r(.5,.5,.5);this._min=new r;this._max=new r}function Pd(a,b){this.center=a||new r(0,0,0);this.radius=void 0===b?.5:b}function ph(a,b){a=a||(new C).setPerspective(90,
16/9,.1,1E3);b=b||new C;this.planes=[];for(var c=0;6>c;c++)this.planes[c]=[];this.update(a,b)}function Hc(a,b){this.origin=a||new r(0,0,0);this.direction=b||new r(0,0,-1)}function qh(a,b){this.halfExtents=b||new r(.5,.5,.5);a=a||Ej.setIdentity();this._modelTransform=a.clone().invert();this._worldTransform=a.clone();this._aabb=new ia(new r,this.halfExtents)}function rh(a,b){this.normal=b||new r(0,0,1);this.point=a||new r(0,0,0)}function Za(a,b,c,d,e){this.usage=d||0;this.format=b;this.numVertices=
c;this.numBytes=b.verticesByteSize?b.verticesByteSize:b.size*c;a._vram.vb+=this.numBytes;this.device=a;e?this.setData(e):this.storage=new ArrayBuffer(this.numBytes);this.device.buffers.push(this)}function Ne(a){for(var b=0,c=0,d=a.length;c<d;c++)b=(b<<5)-b+a.charCodeAt(c),b|=0;return b}function Ka(a,b,c){var d;this.elements=[];this.hasTangents=this.hasColor=this.hasUv1=this.hasUv0=!1;this._defaultInstancingFormat=null;this.verticesByteSize=0;this.vertexCount=c;this.interleaved=!c;this.size=b.reduce(function(a,
b){return a+4*Math.ceil(b.components*Lf[b.type]/4)},0);var e=0;var g=0;for(d=b.length;g<d;g++){var k=b[g];var l=k.components*Lf[k.type];c&&(e=pc.math.roundUp(e,l));var h={name:k.semantic,offset:c?e:k.hasOwnProperty("offset")?k.offset:e,stride:c?l:k.hasOwnProperty("stride")?k.stride:this.size,stream:-1,scopeId:a.scope.resolve(k.semantic),dataType:k.type,numComponents:k.components,normalize:void 0===k.normalize?!1:k.normalize,size:l};this.elements.push(h);e=c?e+l*c:e+4*Math.ceil(l/4);"TEXCOORD0"===
k.semantic?this.hasUv0=!0:"TEXCOORD1"===k.semantic?this.hasUv1=!0:"COLOR"===k.semantic?this.hasColor=!0:"TANGENT"===k.semantic&&(this.hasTangents=!0)}c&&(this.verticesByteSize=e);this.batchingHash=this._evaluateBatchingHash()}function Oe(a,b,c){this.index=0;this.numComponents=b.numComponents;this.array=c.interleaved?new Mf[b.dataType](a,b.offset):new Mf[b.dataType](a,b.offset,c.vertexCount*b.numComponents);this.stride=b.stride/this.array.constructor.BYTES_PER_ELEMENT;switch(b.numComponents){case 1:this.set=
zm;this.getToArray=Am;this.setFromArray=Bm;break;case 2:this.set=Cm;this.getToArray=Dm;this.setFromArray=Em;break;case 3:this.set=Fm;this.getToArray=Gm;this.setFromArray=Hm;break;case 4:this.set=Im,this.getToArray=Jm,this.setFromArray=Km}}function zm(a){this.array[this.index]=a}function Cm(a,b){this.array[this.index]=a;this.array[this.index+1]=b}function Fm(a,b,c){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c}function Im(a,b,c,d){this.array[this.index]=a;this.array[this.index+
1]=b;this.array[this.index+2]=c;this.array[this.index+3]=d}function Bm(a,b,c){this.array[a]=b[c]}function Em(a,b,c){this.array[a]=b[c];this.array[a+1]=b[c+1]}function Hm(a,b,c){this.array[a]=b[c];this.array[a+1]=b[c+1];this.array[a+2]=b[c+2]}function Km(a,b,c){this.array[a]=b[c];this.array[a+1]=b[c+1];this.array[a+2]=b[c+2];this.array[a+3]=b[c+3]}function Am(a,b,c){b[c]=this.array[a]}function Dm(a,b,c){b[c]=this.array[a];b[c+1]=this.array[a+1]}function Gm(a,b,c){b[c]=this.array[a];b[c+1]=this.array[a+
1];b[c+2]=this.array[a+2]}function Jm(a,b,c){b[c]=this.array[a];b[c+1]=this.array[a+1];b[c+2]=this.array[a+2];b[c+3]=this.array[a+3]}function Db(a){this.vertexBuffer=a;this.vertexFormatSize=a.getFormat().size;this.buffer=this.vertexBuffer.lock();this.accessors=[];this.element={};a=this.vertexBuffer.getFormat();for(var b=0;b<a.elements.length;b++){var c=a.elements[b];this.accessors[b]=new Oe(this.buffer,c,a);this.element[c.name]=this.accessors[b]}}function La(a,b,c,d,e,g){if(null===hd){var k=new Ka(a,
[{semantic:"POSITION",components:2,type:6}]);hd=new Za(a,k,4);k=new Db(hd);k.element.POSITION.set(-1,-1);k.next();k.element.POSITION.set(1,-1);k.next();k.element.POSITION.set(-1,1);k.next();k.element.POSITION.set(1,1);k.end()}k=a.renderTarget;a.setRenderTarget(b);a.updateBegin();if(d){var l=d.x;var h=d.y;var p=d.z;var f=d.w}else p=b?b.width:a.width,f=b?b.height:a.height,h=l=0;if(e){var m=e.x;var q=e.y;var u=e.z;var t=e.w}else m=l,q=h,u=p,t=f;e=a.vx;d=a.vy;b=a.vw;var y=a.vh;a.setViewport(l,h,p,f);
p=a.sx;l=a.sy;h=a.sw;f=a.sh;a.setScissor(m,q,u,t);m=a.getDepthTest();q=a.getDepthWrite();u=a.getCullMode();t=a.writeRed;var w=a.writeGreen,v=a.writeBlue,x=a.writeAlpha;a.setDepthTest(!1);a.setDepthWrite(!1);a.setCullMode(0);a.setColorWrite(!0,!0,!0,!0);g||a.setBlending(!1);a.setVertexBuffer(hd,0);a.setShader(c);a.draw(Lm);a.setDepthTest(m);a.setDepthWrite(q);a.setCullMode(u);a.setColorWrite(t,w,v,x);a.updateEnd();a.setRenderTarget(k);a.updateBegin();a.setViewport(e,d,b,y);a.setScissor(p,l,h,f)}function Qd(a,
b){this.device=a;this.definition=b;this.attributes=[];this.uniforms=[];this.samplers=[];this.ready=!1;this.device.createShader(this)}function L(a,b){this.device=a;this.name=null;this._height=this._width=4;this._depth=1;this._format=7;this.type="default";this.fixCubemapSeams=this._volume=this._cubemap=!1;this._flipY=!0;this._premultiplyAlpha=!1;this._mipmaps=!0;this._minFilter=5;this._anisotropy=this._magFilter=1;this._addressW=this._addressV=this._addressU=0;this._compareOnRead=!1;this._compareFunc=
1;void 0!==b&&(void 0!==b.name&&(this.name=b.name),this._width=void 0!==b.width?b.width:this._width,this._height=void 0!==b.height?b.height:this._height,this._format=void 0!==b.format?b.format:this._format,b.hasOwnProperty("type")?this.type=b.type:b.hasOwnProperty("rgbm")?this.type=b.rgbm?"rgbm":"default":b.hasOwnProperty("swizzleGGGR")&&(this.type=b.swizzleGGGR?"swizzleGGGR":"default"),this._mipmaps=void 0!==b.mipmaps?b.mipmaps:void 0!==b.autoMipmap?b.autoMipmap:this._mipmaps,this._levels=b.levels,
this._cubemap=void 0!==b.cubemap?b.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==b.fixCubemapSeams?b.fixCubemapSeams:this.fixCubemapSeams,this._minFilter=void 0!==b.minFilter?b.minFilter:this._minFilter,this._magFilter=void 0!==b.magFilter?b.magFilter:this._magFilter,this._anisotropy=void 0!==b.anisotropy?b.anisotropy:this._anisotropy,this._addressU=void 0!==b.addressU?b.addressU:this._addressU,this._addressV=void 0!==b.addressV?b.addressV:this._addressV,this._compareOnRead=void 0!==b.compareOnRead?
b.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==b._compareFunc?b._compareFunc:this._compareFunc,this._flipY=void 0!==b.flipY?b.flipY:this._flipY,this._premultiplyAlpha=void 0!==b.premultiplyAlpha?b.premultiplyAlpha:this._premultiplyAlpha,a.webgl2&&(this._depth=void 0!==b.depth?b.depth:this._depth,this._volume=void 0!==b.volume?b.volume:this._volume,this._addressW=void 0!==b.addressW?b.addressW:this._addressW));this._compressed=8===this._format||9===this._format||10===this._format||
21<=this._format;this._invalid=!1;this._lockedLevel=-1;this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]);this.dirtyAll();this._gpuSize=0}function Rb(a,b,c,d,e){this.usage=d||0;this.format=b;this.numIndices=c;this.device=a;c=this.device.gl;if(0===b){var g=1;this.glFormat=c.UNSIGNED_BYTE}else 1===b?(g=2,this.glFormat=c.UNSIGNED_SHORT):2===b&&(g=4,this.glFormat=c.UNSIGNED_INT);this.bytesPerIndex=g;this.numBytes=this.numIndices*g;e?this.setData(e):this.storage=new ArrayBuffer(this.numBytes);
a._vram.ib+=this.numBytes;this.device.buffers.push(this)}function Ic(){this.initDefaults()}function Mm(a,b,c,d){this.data=a;this.componentCount=b;this.dataType=c;this.dataTypeNormalize=d}function fb(a){this._refCount=0;this.id=Nm++;this.device=a||Y.getApplication().graphicsDevice;this.vertexBuffer=null;this.indexBuffer=[null];this.primitive=[{type:0,base:0,count:0}];this._geometryData=this.morph=this.skin=null;this._aabb=new ia;this.boneAabb=null}function ma(a,b,c){this._key=[0,0];this._shader=[null,
null,null];this.isStatic=!1;this._staticSource=this._staticLightList=null;this.node=a;this._mesh=b;b.incReference();this.material=c;this._shaderDefs=65536;this._shaderDefs|=b.vertexBuffer.format.hasUv0?4:0;this._shaderDefs|=b.vertexBuffer.format.hasUv1?8:0;this._shaderDefs|=b.vertexBuffer.format.hasColor?16:0;this._shaderDefs|=b.vertexBuffer.format.hasTangents?512:0;this._lightHash=0;this.visible=!0;this.layer=15;this.renderStyle=0;this.castShadow=!1;this._receiveShadow=!0;this._noDepthDrawGl1=this._screenSpace=
!1;this._updateAabb=this.pick=this.cull=!0;this._calculateSortDistance=this._updateAabbFunc=null;this.updateKey();this.instancingData=this._morphInstance=this._skinInstance=null;this.aabb=new ia;this._aabbVer=-1;this.visibleThisFrame=this.drawOrder=0;this.isVisibleFunc=null;this.parameters={};this.stencilBack=this.stencilFront=null;this.flipFaces=!1}function Nf(a,b,c){this._key=[];this._key[0]=(a&15)<<27|(3===b?1:0)<<26|33554432;this.command=c}function Om(a){this.count=a;this.vertexBuffer=null;this.offset=
0}function qc(a){this.morph=a;this._weights=[];this._dirty=!0;this._shaderMorphWeights=new Float32Array(qc.RENDER_TARGET_COUNT);this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4);this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4);this._activeTargets=[];this._activeVertexBuffers=Array(qc.RENDER_TARGET_COUNT)}function Of(a,b,c){this.device=a;this.inverseBindPose=b;this.boneNames=c}function Rd(a){this.skin=a;this._dirty=!0;this.bones=[];var b=
a.inverseBindPose.length;a=a.device;if(a.supportsBoneTextures){var c=16<b?O.nextPowerOfTwo(Math.ceil(Math.sqrt(4*b))):8;this.boneTexture=new L(a,{width:c,height:c,format:14,mipmaps:!1,minFilter:0,magFilter:0});this.boneTexture.name="skin";this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(16*b);this.matrices=[];for(a=0;a<b;a++)this.matrices[a]=new C}function gb(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.morphInstances=[];this.cameras=[];this.lights=
[];this._shadersVersion=0;this._immutable=!1}function sh(a,b,c){this.origMeshInstances=a;this._aabb=new ia;this.model=this.meshInstance=null;this.dynamic=b;this.batchGroupId=c;this.refCounter=0}function Ta(a,b,c,d,e){this.dynamic=c;this.maxAabbSize=d;this.id=a;this.name=b;this.layers=void 0===e?[0]:e;this._sprite=this._ui=!1;this._obj={model:[],element:[],sprite:[]}}function th(a,b,c){this.device=a;this.rootNode=c;this._dirty=!0;this.bones=b;b=b.length;a.supportsBoneTextures?(b=256<b?64:64<b?32:16<
b?16:8,this.boneTexture=new L(a,{width:b,height:b,format:14,mipmaps:!1,minFilter:0,magFilter:0}),this.boneTexture.name="batching",this.matrixPalette=this.boneTexture.lock()):this.matrixPalette=new Float32Array(16*b)}function Aa(a,b,c){this.device=a;this.rootNode=b;this.scene=c;this._init=!1;this._batchGroups={};this._batchGroupCounter=0;this._batchList=[];this._dirtyGroups=[]}function Fj(a,b){if(a&&!b||!a&&b)return!1;a=a.data;b=b.data;if(a===b)return!0;if(a instanceof Float32Array&&b instanceof Float32Array){if(a.length!==
b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}return!1}function Pm(a,b){for(var c in a)if(a.hasOwnProperty(c)&&!Fj(a[c],b[c]))return!1;for(c in b)if(b.hasOwnProperty(c)&&!Fj(b[c],a[c]))return!1;return!0}function Qm(a,b){var c;for(c=0;c<a.length;c++)if(0>b.indexOf(a[c]))return!1;for(c=0;c<b.length;c++)if(0>a.indexOf(b[c]))return!1;return!0}function uh(a){a=a.node.worldTransform;a.getX(Pf);a.getY(Gj);a.getZ(Hj);Pf.cross(Pf,Gj);return 0<=Pf.dot(Hj)?1:-1}function Pa(){this._projection=
0;this._nearClip=.1;this._farClip=1E4;this._shaderParams=new Float32Array(4);this._fov=45;this._orthoHeight=10;this._aspect=16/9;this._aspectRatioMode=0;this.frustumCulling=this._horizontalFov=!1;this.cullingMask=4294967295;this._renderDepthRequests=0;this._projMatDirty=!0;this._projMat=new C;this._projMatSkybox=new C;this._viewMatDirty=!0;this._viewMat=new C;this._viewProjMatDirty=!0;this._viewProjMat=new C;this.vrDisplay=null;this._rect={x:0,y:0,width:1,height:1};this._scissorRect={x:0,y:0,width:1,
height:1};this.frustum=new ph(this._projMat,this._viewMat);this._depthTarget=this.renderTarget=null;this._clearOptions={color:[.5,.5,.5,1],depth:1,stencil:0,flags:7};this.calculateTransform=this._node=null;this.overrideCalculateTransform=!1;this.calculateProjection=null;this.overrideCalculateProjection=!1;this._cullFaces=!0;this._flipFaces=!1;this._component=null}function Z(a){H.call(this);this.name="string"===typeof a?a:"Untitled";this.tags=new Gc(this);this._labels={};this.localPosition=new r(0,
0,0);this.localRotation=new T(0,0,0,1);this.localScale=new r(1,1,1);this.localEulerAngles=new r(0,0,0);this.position=new r(0,0,0);this.rotation=new T(0,0,0,1);this.eulerAngles=new r(0,0,0);this._scale=null;this.localTransform=new C;this._dirtyLocal=!1;this._aabbVer=0;this._frozen=!1;this.worldTransform=new C;this._dirtyWorld=!1;this.normalMatrix=new Cb;this._dirtyNormal=!0;this._parent=this._forward=this._up=this._right=null;this._children=[];this._graphDepth=0;this._enabled=!0;this.scaleCompensation=
this._enabledInHierarchy=!1}function Rm(a,b){return a.priority-b.priority}function Sm(a,b){return b.key-a.key}function Ij(){this.list=[];this.length=0;this.done=!1}function Jj(){this.opaqueMeshInstances=[];this.transparentMeshInstances=[];this.shadowCasters=[];this.visibleOpaque=[];this.visibleTransparent=[]}function fa(a){a=a||{};void 0!==a.id?(this.id=a.id,vh=Math.max(this.id+1,vh)):this.id=vh++;this.name=a.name;this._refCounter=(this._enabled=void 0===a.enabled?!0:a.enabled)?1:0;this.opaqueSortMode=
void 0===a.opaqueSortMode?2:a.opaqueSortMode;this.transparentSortMode=void 0===a.transparentSortMode?3:a.transparentSortMode;this.renderTarget=a.renderTarget;this.shaderPass=void 0===a.shaderPass?0:a.shaderPass;this.passThrough=void 0===a.passThrough?!1:a.passThrough;this.overrideClear=void 0===a.overrideClear?!1:a.overrideClear;this._clearColor=new J(0,0,0,1);a.clearColor&&this._clearColor.copy(a.clearColor);this._clearColorBuffer=void 0===a.clearColorBuffer?!1:a.clearColorBuffer;this._clearDepthBuffer=
void 0===a.clearDepthBuffer?!1:a.clearDepthBuffer;this._clearStencilBuffer=void 0===a.clearStencilBuffer?!1:a.clearStencilBuffer;this._clearOptions={color:[this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a],depth:1,stencil:0,flags:(this._clearColorBuffer?1:0)|(this._clearDepthBuffer?2:0)|(this._clearStencilBuffer?4:0)};this.onPreCull=a.onPreCull;this.onPreRender=a.onPreRender;this.onPreRenderOpaque=a.onPreRenderOpaque;this.onPreRenderTransparent=a.onPreRenderTransparent;
this.onPostCull=a.onPostCull;this.onPostRender=a.onPostRender;this.onPostRenderOpaque=a.onPostRenderOpaque;this.onPostRenderTransparent=a.onPostRenderTransparent;this.onDrawCall=a.onDrawCall;this.onEnable=a.onEnable;this.onDisable=a.onDisable;if(this._enabled&&this.onEnable)this.onEnable();this.instances=(this.layerReference=a.layerReference)?a.layerReference.instances:new Jj;this.cullingMask=a.cullingMask?a.cullingMask:4294967295;this.opaqueMeshInstances=this.instances.opaqueMeshInstances;this.transparentMeshInstances=
this.instances.transparentMeshInstances;this.shadowCasters=this.instances.shadowCasters;this.customCalculateSortValues=this.customSortCallback=null;this._lightComponents=[];this._lights=[];this._sortedLights=[[],[],[]];this.cameras=[];this._dirtyCameras=this._dirtyLights=this._dirty=!1;this._staticLightHash=this._lightHash=this._cameraHash=0;this._needsStaticPrepare=!0;this._staticPrepareDone=!1;this._shaderVersion=-1;this._version=0;this._lightCube=null}function Tm(a,b){if(0!==b||a.webgl2){if(3===
b)return a.extTextureFloatLinear?1:0;if(2===b)return a.extTextureHalfFloatLinear?1:0}else return 0;return 1}function Kj(a,b,c,d){var e=3===d?14:2===d?12:4===d||0===d&&a.webgl2?16:7,g=Tm(a,d);b=new L(a,{format:e,width:b,height:c,mipmaps:!1,minFilter:g,magFilter:g,addressU:1,addressV:1});b.name="shadowmap";return 4===d||0===d&&a.webgl2?(b.compareOnRead=!0,b.compareFunc=1,new oa({depthBuffer:b})):new oa({colorBuffer:b,depth:!0})}function Lj(a,b){a=new L(a,{format:7,width:b,height:b,cubemap:!0,mipmaps:!1,
minFilter:0,magFilter:0,addressU:1,addressV:1});a.name="shadowcube";b=[];for(var c,d=0;6>d;d++)c=new oa({colorBuffer:a,face:d,depth:!0}),b.push(c);return b}function Mj(a,b,c,d){d||(d=0);d=1E4*d+b;var e=Nj[c][d];e||(e=Kj(a,b,b,c?c:0),Nj[c][d]=e);return e}function Oj(a,b){if(1===b._type){0<b._shadowType&&(b._shadowType=0);if(b._cacheShadowMap){var c=Pj[b._shadowResolution];c||(c=Lj(a,b._shadowResolution),Pj[b._shadowResolution]=c)}else c=Lj(a,b._shadowResolution);b._shadowCamera.renderTarget=c[0];b._shadowCubeMap=
c}else c=b._cacheShadowMap?Mj(a,b._shadowResolution,b._shadowType):Kj(a,b._shadowResolution,b._shadowResolution,b._shadowType),b._shadowCamera.renderTarget=c;b._isCachedShadowMap=b._cacheShadowMap}function Qf(a){a=this.device=a;this._instancingTime=this._morphTime=this._skinTime=this._sortTime=this._cullTime=this._forwardTime=this._depthMapTime=this._shadowMapTime=this._shadowMapUpdates=this._materialSwitches=this._camerasRendered=this._skinDrawCalls=this._forwardDrawCalls=this._shadowDrawCalls=0;
this.library=a.getProgramLibrary();a=a.scope;this.projId=a.resolve("matrix_projection");this.projSkyboxId=a.resolve("matrix_projectionSkybox");this.viewId=a.resolve("matrix_view");this.viewId3=a.resolve("matrix_view3");this.viewInvId=a.resolve("matrix_viewInverse");this.viewProjId=a.resolve("matrix_viewProjection");this.viewPos=new Float32Array(3);this.viewPosId=a.resolve("view_position");this.nearClipId=a.resolve("camera_near");this.farClipId=a.resolve("camera_far");this.cameraParamsId=a.resolve("camera_params");
this.shadowMapLightRadiusId=a.resolve("light_radius");this.fogColorId=a.resolve("fog_color");this.fogStartId=a.resolve("fog_start");this.fogEndId=a.resolve("fog_end");this.fogDensityId=a.resolve("fog_density");this.modelMatrixId=a.resolve("matrix_model");this.normalMatrixId=a.resolve("matrix_normal");this.poseMatrixId=a.resolve("matrix_pose[0]");this.boneTextureId=a.resolve("texture_poseMap");this.boneTextureSizeId=a.resolve("texture_poseMapSize");this.morphWeightsA=a.resolve("morph_weights_a");this.morphWeightsB=
a.resolve("morph_weights_b");this.alphaTestId=a.resolve("alpha_ref");this.opacityMapId=a.resolve("texture_opacityMap");this.ambientId=a.resolve("light_globalAmbient");this.exposureId=a.resolve("exposure");this.skyboxIntensityId=a.resolve("skyboxIntensity");this.lightColorId=[];this.lightDir=[];this.lightDirId=[];this.lightShadowMapId=[];this.lightShadowMatrixId=[];this.lightShadowParamsId=[];this.lightShadowMatrixVsId=[];this.lightShadowParamsVsId=[];this.lightDirVs=[];this.lightDirVsId=[];this.lightRadiusId=
[];this.lightPos=[];this.lightPosId=[];this.lightInAngleId=[];this.lightOutAngleId=[];this.lightPosVsId=[];this.lightCookieId=[];this.lightCookieIntId=[];this.lightCookieMatrixId=[];this.lightCookieOffsetId=[];this.depthMapId=a.resolve("uDepthMap");this.screenSizeId=a.resolve("uScreenSize");this._screenSize=new Float32Array(4);this.sourceId=a.resolve("source");this.pixelOffsetId=a.resolve("pixelOffset");this.weightId=a.resolve("weight[0]");var b=K;this.blurVsmShaderCode=[b.blurVSMPS,"#define GAUSS\n"+
b.blurVSMPS];this.blurPackedVsmShaderCode=["#define PACKED\n"+this.blurVsmShaderCode[0],"#define PACKED\n"+this.blurVsmShaderCode[1]];this.blurVsmShader=[{},{}];this.blurPackedVsmShader=[{},{}];this.blurVsmWeights={};this.polygonOffsetId=a.resolve("polygonOffset");this.polygonOffset=new Float32Array(2);this.fogColor=new Float32Array(3);this.ambientColor=new Float32Array(3);this.tempSemanticArray=[]}function Rf(a,b){a.data[0]=b.data[0];a.data[1]=b.data[1];a.data[2]=b.data[2];a.data[3]=b.data[4];a.data[4]=
b.data[5];a.data[5]=b.data[6];a.data[6]=b.data[8];a.data[7]=b.data[9];a.data[8]=b.data[10]}function Jc(){da.call(this);this.color=new J(1,1,1,1);this.colorUniform=new Float32Array(4);this.colorMap=null;this.vertexColors=!1}function Sf(a){this.lineVertexFormat=new Ka(a,[{semantic:"POSITION",components:3,type:6},{semantic:"COLOR",components:4,type:1,normalize:!0}]);this.lineBatches=[];this.layers=[];this.layerToBatch={};this.cubeWorldPos=this.cubeLocalPos=this.quadMesh=null;this.identityGraphNode=new Z}
function Qj(){this.numLinesAllocated=128;this.mesh=this.vbRam=this.vb=null;this.linesUsed=0;this.layer=this.meshInstance=this.material=null}function pa(){H.call(this);this.layerList=[];this.subLayerList=[];this.subLayerEnabled=[];this._opaqueOrder={};this._transparentOrder={};this._dirtyCameras=this._dirtyLights=this._dirtyBlend=this._dirty=!1;this._meshInstances=[];this._lights=[];this.cameras=[];this._sortedLights=[[],[],[]];this._lightShadowCasters=[];this._globalLightCameras=[];this._globalLightCameraIds=
[];this._renderedRt=[];this._renderedByCam=[];this._renderedLayer=[];this._renderList=[];this._renderListCamera=[]}function Tf(a,b,c,d){if(a.enabled){var e;if(a.model&&a.model.model&&a.model.enabled&&(d&&d.push(a),a.model.lightmapped&&b)){var g=!0,k=a.model.model.meshInstances;for(e=0;e<k.length;e++)if(!k[e].mesh.vertexBuffer.format.hasUv1){g=!1;break}if(g){var l=[];for(e=0;e<k.length;e++){var h=!1;for(g=0;g<k.length;g++)e!==g&&k[e].mesh===k[g].mesh&&(h=!0);h?(b.push(a),c.push([k[e]])):l.push(k[e])}0<
l.length&&(b.push(a),c.push(l))}}for(e=0;e<a._children.length;e++)Tf(a._children[e],b,c,d)}}function wh(a,b,c,d,e){this.device=a;this.root=b;this.scene=c;this.renderer=d;this.assets=e}function Sd(a){return a-Math.floor(a)}function xh(a,b){return a-b*Math.floor(a/b)}function Uf(a){var b=Sd(a);a=Sd(255*a);return[b-a/255,a-a/255]}function yh(a){this._emitter=a}function Rj(a,b){b.data[0]=a.data[0];b.data[1]=a.data[1];b.data[2]=a.data[2];b.data[3]=a.data[4];b.data[4]=a.data[5];b.data[5]=a.data[6];b.data[6]=
a.data[8];b.data[7]=a.data[9];b.data[8]=a.data[10]}function Vf(a,b){this._emitter=a;this.frameRandomUniform=new Float32Array(3);this.emitterPosUniform=new Float32Array(3);this.emitterScaleUniform=new Float32Array([1,1,1]);this.worldBoundsMulUniform=new Float32Array(3);this.worldBoundsAddUniform=new Float32Array(3);this.inBoundsSizeUniform=new Float32Array(3);this.inBoundsCenterUniform=new Float32Array(3);this.constantParticleTexIN=b.scope.resolve("particleTexIN");this.constantParticleTexOUT=b.scope.resolve("particleTexOUT");
this.constantEmitterPos=b.scope.resolve("emitterPos");this.constantEmitterScale=b.scope.resolve("emitterScale");this.constantSpawnBounds=b.scope.resolve("spawnBounds");this.constantSpawnPosInnerRatio=b.scope.resolve("spawnPosInnerRatio");this.constantSpawnBoundsSphere=b.scope.resolve("spawnBoundsSphere");this.constantSpawnBoundsSphereInnerRatio=b.scope.resolve("spawnBoundsSphereInnerRatio");this.constantInitialVelocity=b.scope.resolve("initialVelocity");this.constantFrameRandom=b.scope.resolve("frameRandom");
this.constantDelta=b.scope.resolve("delta");this.constantRate=b.scope.resolve("rate");this.constantRateDiv=b.scope.resolve("rateDiv");this.constantLifetime=b.scope.resolve("lifetime");this.constantGraphSampleSize=b.scope.resolve("graphSampleSize");this.constantGraphNumSamples=b.scope.resolve("graphNumSamples");this.constantInternalTex0=b.scope.resolve("internalTex0");this.constantInternalTex1=b.scope.resolve("internalTex1");this.constantInternalTex2=b.scope.resolve("internalTex2");this.constantInternalTex3=
b.scope.resolve("internalTex3");this.constantEmitterMatrix=b.scope.resolve("emitterMatrix");this.constantEmitterMatrixInv=b.scope.resolve("emitterMatrixInv");this.constantNumParticles=b.scope.resolve("numParticles");this.constantNumParticlesPot=b.scope.resolve("numParticlesPot");this.constantLocalVelocityDivMult=b.scope.resolve("localVelocityDivMult");this.constantVelocityDivMult=b.scope.resolve("velocityDivMult");this.constantRotSpeedDivMult=b.scope.resolve("rotSpeedDivMult");this.constantSeed=b.scope.resolve("seed");
this.constantStartAngle=b.scope.resolve("startAngle");this.constantStartAngle2=b.scope.resolve("startAngle2");this.constantOutBoundsMul=b.scope.resolve("outBoundsMul");this.constantOutBoundsAdd=b.scope.resolve("outBoundsAdd");this.constantInBoundsSize=b.scope.resolve("inBoundsSize");this.constantInBoundsCenter=b.scope.resolve("inBoundsCenter");this.constantMaxVel=b.scope.resolve("maxVel");this.constantFaceTangent=b.scope.resolve("faceTangent");this.constantFaceBinorm=b.scope.resolve("faceBinorm")}
function P(a,b){Sj[a]=void 0!==Wf[a]&&null!==Wf[a]?Wf[a]:b}function Tj(a,b){for(var c=a.length/3,d=Array(4*c),e=0;e<c;e++)d[4*e]=a[3*e],d[4*e+1]=a[3*e+1],d[4*e+2]=a[3*e+2],d[4*e+3]=(255*b[3*e]<<16|255*b[3*e+1]<<8|255*b[3*e+2])/16777216;return d}function id(a,b){var c,d,e=b.length,g=a.length/e;for(c=0;c<g;c++)for(d=0;d<e;d++)b[d]=Math.max(b[d],Math.abs(a[c*e+d]))}function jd(a,b,c){for(var d=new Float32Array(b.length),e=0;e<b.length;e++)d[e]=b[e]-a[e];id(d,c);a=c.length;var g=d.length/a;for(b=0;b<
g;b++)for(e=0;e<a;e++)d[b*a+e]/=0===c[e]?1:c[e],d[b*a+e]*=.5,d[b*a+e]+=.5;return d}function Uj(a,b){var c=b.length/3,d=a.length/3,e,g=new r,k=new r,l=new r,h=new r,p=new r,f=new r,m=[];for(e=0;e<a.length;e++)m[e]=0;for(e=0;e<c;e++){var q=b[3*e];var u=b[3*e+1];var t=b[3*e+2];g.set(a[3*q],a[3*q+1],a[3*q+2]);k.set(a[3*u],a[3*u+1],a[3*u+2]);l.set(a[3*t],a[3*t+1],a[3*t+2]);h.sub2(k,g);p.sub2(l,g);f.cross(h,p).normalize();m[3*q]+=f.x;m[3*q+1]+=f.y;m[3*q+2]+=f.z;m[3*u]+=f.x;m[3*u+1]+=f.y;m[3*u+2]+=f.z;m[3*
t]+=f.x;m[3*t+1]+=f.y;m[3*t+2]+=f.z}for(e=0;e<d;e++)a=m[3*e],b=m[3*e+1],c=m[3*e+2],a=1/Math.sqrt(a*a+b*b+c*c),m[3*e]*=a,m[3*e+1]*=a,m[3*e+2]*=a;return m}function Vj(a,b,c,d){var e=d.length/3,g=a.length/3,k=new r,l=new r,h=new r,p=new r,f=new r,m=new M,q=new M,u=new M,t,y=new Float32Array(3*g),w=new Float32Array(3*g),v=[];for(t=0;t<e;t++){var x=d[3*t];var z=d[3*t+1];var A=d[3*t+2];h.set(a[3*x],a[3*x+1],a[3*x+2]);p.set(a[3*z],a[3*z+1],a[3*z+2]);f.set(a[3*A],a[3*A+1],a[3*A+2]);m.set(c[2*x],c[2*x+1]);
q.set(c[2*z],c[2*z+1]);u.set(c[2*A],c[2*A+1]);var F=p.x-h.x;var Q=f.x-h.x;var D=p.y-h.y;var E=f.y-h.y;var Wj=p.z-h.z;var B=f.z-h.z;var C=q.x-m.x;var H=u.x-m.x;var I=q.y-m.y;var G=u.y-m.y;var W=C*G-H*I;0==W?(k.set(0,1,0),l.set(1,0,0)):(W=1/W,k.set((G*F-I*Q)*W,(G*D-I*E)*W,(G*Wj-I*B)*W),l.set((C*Q-H*F)*W,(C*E-H*D)*W,(C*B-H*Wj)*W));y[3*x]+=k.x;y[3*x+1]+=k.y;y[3*x+2]+=k.z;y[3*z]+=k.x;y[3*z+1]+=k.y;y[3*z+2]+=k.z;y[3*A]+=k.x;y[3*A+1]+=k.y;y[3*A+2]+=k.z;w[3*x]+=l.x;w[3*x+1]+=l.y;w[3*x+2]+=l.z;w[3*z]+=l.x;
w[3*z+1]+=l.y;w[3*z+2]+=l.z;w[3*A]+=l.x;w[3*A+1]+=l.y;w[3*A+2]+=l.z}I=new r;G=new r;a=new r;c=new r;for(t=0;t<g;t++)a.set(b[3*t],b[3*t+1],b[3*t+2]),I.set(y[3*t],y[3*t+1],y[3*t+2]),G.set(w[3*t],w[3*t+1],w[3*t+2]),d=a.dot(I),c.copy(a).scale(d),c.sub2(I,c).normalize(),v[4*t]=c.x,v[4*t+1]=c.y,v[4*t+2]=c.z,c.cross(a,I),v[4*t+3]=0>c.dot(G)?-1:1;return v}function Eb(a,b,c){var d=c&&void 0!==c.normals?c.normals:null,e=c&&void 0!==c.tangents?c.tangents:null,g=c&&void 0!==c.colors?c.colors:null,k=c&&void 0!==
c.uvs?c.uvs:null,l=c&&void 0!==c.uvs1?c.uvs1:null,h=c&&void 0!==c.indices?c.indices:null,p=c&&void 0!==c.blendIndices?c.blendIndices:null,f=c&&void 0!==c.blendWeights?c.blendWeights:null;c=[{semantic:"POSITION",components:3,type:6}];null!==d&&c.push({semantic:"NORMAL",components:3,type:6});null!==e&&c.push({semantic:"TANGENT",components:4,type:6});null!==g&&c.push({semantic:"COLOR",components:4,type:1,normalize:!0});null!==k&&c.push({semantic:"TEXCOORD0",components:2,type:6});null!==l&&c.push({semantic:"TEXCOORD1",
components:2,type:6});null!==p&&c.push({semantic:"BLENDINDICES",components:2,type:1});null!==f&&c.push({semantic:"BLENDWEIGHT",components:2,type:6});var m=new Ka(a,c);c=b.length/3;m=new Za(a,m,c);for(var q=new Db(m),u=0;u<c;u++)q.element.POSITION.set(b[3*u],b[3*u+1],b[3*u+2]),null!==d&&q.element.NORMAL.set(d[3*u],d[3*u+1],d[3*u+2]),null!==e&&q.element.TANGENT.set(e[4*u],e[4*u+1],e[4*u+2],e[4*u+3]),null!==g&&q.element.COLOR.set(g[4*u],g[4*u+1],g[4*u+2],g[4*u+3]),null!==k&&q.element.TEXCOORD0.set(k[2*
u],k[2*u+1]),null!==l&&q.element.TEXCOORD1.set(l[2*u],l[2*u+1]),null!==p&&q.element.BLENDINDICES.set(p[2*u],p[2*u+1]),null!==f&&q.element.BLENDWEIGHT.set(f[2*u],f[2*u+1]),q.next();q.end();d=null;if(e=null!==h)d=new Rb(a,1,h.length),(new Uint16Array(d.lock())).set(h),d.unlock();g=new ia;g.compute(b);a=new fb(a);a.vertexBuffer=m;a.indexBuffer[0]=d;a.primitive[0].type=4;a.primitive[0].base=0;a.primitive[0].count=e?h.length:c;a.primitive[0].indexed=e;a.aabb=g;return a}function Xj(a,b){var c=b&&void 0!==
b.tubeRadius?b.tubeRadius:.2,d=b&&void 0!==b.ringRadius?b.ringRadius:.3,e=b&&void 0!==b.segments?b.segments:30,g=b&&void 0!==b.sides?b.sides:20;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var k,l,h=[],p=[],f=[],m=[];for(k=0;k<=g;k++)for(l=0;l<=e;l++){var q=Math.cos(2*Math.PI*l/e)*(d+c*Math.cos(2*Math.PI*k/g));var u=Math.sin(2*Math.PI*k/g)*c;var t=Math.sin(2*Math.PI*l/e)*(d+c*Math.cos(2*Math.PI*k/g));var y=Math.cos(2*Math.PI*l/e)*Math.cos(2*Math.PI*k/g);var w=Math.sin(2*Math.PI*k/g);var v=
Math.sin(2*Math.PI*l/e)*Math.cos(2*Math.PI*k/g);var x=k/g;var z=1-l/e;h.push(q,u,t);p.push(y,w,v);f.push(x,z);k<g&&l<e&&(q=k*(e+1)+l,u=(k+1)*(e+1)+l,t=k*(e+1)+(l+1),y=(k+1)*(e+1)+(l+1),m.push(q,u,t),m.push(u,y,t))}c={normals:p,uvs:f,indices:m};b&&(c.tangents=b(h,p,f,m));return Eb(a,h,c)}function zh(a,b,c,d,e,g){var k,l,h=new r,f=new r;var n=new r;var m=[],q=[],u=[],t=[],y=[];if(0<c)for(k=0;k<=d;k++)for(l=0;l<=e;l++){var w=l/e*2*Math.PI-Math.PI;var v=Math.sin(w);w=Math.cos(w);var x=new r(v*a,-c/2,
w*a);var z=new r(v*b,c/2,w*b);h.lerp(x,z,k/d);f.sub2(z,x).normalize();v=new r(w,0,-v);n.cross(v,f).normalize();m.push(h.x,h.y,h.z);q.push(n.x,n.y,n.z);z=l/e;x=k/d;u.push(z,x);v=x;x=z;z=v;z/=3;z=.875*z+.0625;x=.875*x+.0625;t.push(z,x);k<d&&l<e&&(v=k*(e+1)+l,w=k*(e+1)+(l+1),z=(k+1)*(e+1)+l,x=(k+1)*(e+1)+(l+1),y.push(v,w,z),y.push(w,x,z))}if(g){a=Math.floor(e/2);k=c/2;for(c=0;c<=a;c++)for(w=c*Math.PI*.5/a,v=Math.sin(w),w=Math.cos(w),h=0;h<=e;h++)g=2*h*Math.PI/e-Math.PI/2,z=Math.sin(g),g=Math.cos(g),
g*=v,l=w,n=z*v,z=1-h/e,x=1-c/a,m.push(g*b,l*b+k,n*b),q.push(g,l,n),u.push(z,x),z/=3,x/=3,z=.875*z+.0625,x=.875*x+.0625,z+=1/3,t.push(z,x);f=(d+1)*(e+1);for(c=0;c<a;++c)for(h=0;h<e;++h)v=c*(e+1)+h,w=v+e+1,y.push(f+v+1,f+w,f+v),y.push(f+v+1,f+w+1,f+w);for(c=0;c<=a;c++)for(w=.5*Math.PI+c*Math.PI*.5/a,v=Math.sin(w),w=Math.cos(w),h=0;h<=e;h++)g=2*h*Math.PI/e-Math.PI/2,z=Math.sin(g),g=Math.cos(g),g*=v,l=w,n=z*v,z=1-h/e,x=1-c/a,m.push(g*b,l*b-k,n*b),q.push(g,l,n),u.push(z,x),z/=3,x/=3,z=.875*z+.0625,x=.875*
x+.0625,z+=2/3,t.push(z,x);f=(d+1)*(e+1)+(e+1)*(a+1);for(c=0;c<a;++c)for(h=0;h<e;++h)v=c*(e+1)+h,w=v+e+1,y.push(f+v+1,f+w,f+v),y.push(f+v+1,f+w+1,f+w)}else{f=(d+1)*(e+1);if(0<a)for(k=0;k<e;k++)w=k/e*2*Math.PI,g=Math.sin(w),l=-c/2,n=Math.cos(w),z=1-(g+1)/2,x=(n+1)/2,m.push(g*a,l,n*a),q.push(0,-1,0),u.push(z,x),z/=3,x/=3,z=.875*z+.0625,x=.875*x+.0625,z+=1/3,t.push(z,x),1<k&&y.push(f,f+k,f+k-1);f+=e;if(0<b)for(k=0;k<e;k++)w=k/e*2*Math.PI,g=Math.sin(w),l=c/2,n=Math.cos(w),z=1-(g+1)/2,x=(n+1)/2,m.push(g*
b,l,n*b),q.push(0,1,0),u.push(z,x),z/=3,x/=3,z=.875*z+.0625,x=.875*x+.0625,z+=2/3,t.push(z,x),1<k&&y.push(f,f+k-1,f+k)}return{positions:m,normals:q,uvs:u,uvs1:t,indices:y}}function Ah(a,b){var c=b&&(b.radius||b.baseRadius);c=void 0!==c?c:.5;var d=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;b=zh(c,c,b&&void 0!==b.height?b.height:1,b&&void 0!==b.heightSegments?b.heightSegments:5,b&&void 0!==b.capSegments?b.capSegments:20,!1);d&&(b.tangents=d(b.positions,b.normals,b.uvs,b.indices));return Eb(a,
b.positions,b)}function Bh(a,b){var c=b&&void 0!==b.radius?b.radius:.3,d=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;b=zh(c,c,(b&&void 0!==b.height?b.height:1)-2*c,b&&void 0!==b.heightSegments?b.heightSegments:1,b&&void 0!==b.sides?b.sides:20,!0);d&&(b.tangents=d(b.positions,b.normals,b.uvs,b.indices));return Eb(a,b.positions,b)}function Ch(a,b){var c=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;b=zh(b&&void 0!==b.baseRadius?b.baseRadius:.5,b&&void 0!==b.peakRadius?b.peakRadius:
0,b&&void 0!==b.height?b.height:1,b&&void 0!==b.heightSegments?b.heightSegments:5,b&&void 0!==b.capSegments?b.capSegments:18,!1);c&&(b.tangents=c(b.positions,b.normals,b.uvs,b.indices));return Eb(a,b.positions,b)}function Dh(a,b){var c=b&&void 0!==b.radius?b.radius:.5,d=b&&void 0!==b.latitudeBands?b.latitudeBands:16,e=b&&void 0!==b.longitudeBands?b.longitudeBands:16;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var g,k=[],l=[],h=[],f=[];for(g=0;g<=d;g++){var n=g*Math.PI/d;var m=Math.sin(n);
var q=Math.cos(n);for(n=0;n<=e;n++){var u=2*n*Math.PI/e-Math.PI/2;var t=Math.sin(u);u=Math.cos(u);u*=m;var y=q;t*=m;var w=1-n/e;var v=1-g/d;k.push(u*c,y*c,t*c);l.push(u,y,t);h.push(w,v)}}for(g=0;g<d;++g)for(n=0;n<e;++n)c=g*(e+1)+n,m=c+e+1,f.push(c+1,m,c),f.push(c+1,m+1,m);d={normals:l,uvs:h,uvs1:h,indices:f};b&&(d.tangents=b(k,l,h,f));return Eb(a,k,d)}function Eh(a,b){var c=b&&void 0!==b.halfExtents?b.halfExtents:new M(.5,.5),d=b&&void 0!==b.widthSegments?b.widthSegments:5,e=b&&void 0!==b.lengthSegments?
b.lengthSegments:5;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var g,k,l=[],h=[],f=[],n=[],m=0;for(g=0;g<=d;g++)for(k=0;k<=e;k++){var q=-c.x+2*c.x*g/d;var u=-(-c.y+2*c.y*k/e);var t=g/d;var y=k/e;l.push(q,0,u);h.push(0,1,0);f.push(t,y);g<d&&k<e&&(n.push(m+e+1,m+1,m),n.push(m+e+1,m+e+2,m+1));m++}c={normals:h,uvs:f,uvs1:f,indices:n};b&&(c.tangents=b(l,h,f,n));return Eb(a,l,c)}function Xf(a,b){var c=b&&void 0!==b.halfExtents?b.halfExtents:new r(.5,.5,.5),d=b&&void 0!==b.widthSegments?b.widthSegments:
1,e=b&&void 0!==b.lengthSegments?b.lengthSegments:1,g=b&&void 0!==b.heightSegments?b.heightSegments:1;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var k=[new r(-c.x,-c.y,c.z),new r(c.x,-c.y,c.z),new r(c.x,c.y,c.z),new r(-c.x,c.y,c.z),new r(c.x,-c.y,-c.z),new r(-c.x,-c.y,-c.z),new r(-c.x,c.y,-c.z),new r(c.x,c.y,-c.z)],l=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],h=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],f=[],n=[],m=[],q=[],u=[],t=0;c=function(a,b,c){var d,e;for(d=0;d<=
b;d++)for(e=0;e<=c;e++){var g=new r;var p=new r;var y=new r,v=new r;g.lerp(k[l[a][0]],k[l[a][1]],d/b);p.lerp(k[l[a][0]],k[l[a][2]],e/c);y.sub2(p,k[l[a][0]]);v.add2(g,y);g=d/b;p=e/c;f.push(v.x,v.y,v.z);n.push(h[a][0],h[a][1],h[a][2]);m.push(g,p);g/=3;p/=3;g=.875*g+.0625;p=.875*p+.0625;g+=a%3/3;p+=Math.floor(a/3)/3;q.push(g,p);d<b&&e<c&&(u.push(t+c+1,t+1,t),u.push(t+c+1,t+c+2,t+1));t++}};c(0,d,g);c(1,d,g);c(2,d,e);c(3,d,e);c(4,e,g);c(5,e,g);d={normals:n,uvs:m,uvs1:q,indices:u};b&&(d.tangents=b(f,n,
m,u));return Eb(a,f,d)}function ka(){H.call(this);this.root=null;this._gravity=new r(0,-9.8,0);this._layers=null;this._fog="none";this.fogColor=new J(0,0,0);this.fogStart=1;this.fogEnd=1E3;this.fogDensity=0;this.ambientLight=new J(0,0,0);this._toneMapping=this._gammaCorrection=0;this.exposure=1;this._skyboxPrefiltered=[null,null,null,null,null,null];this._firstUpdateSkybox=!0;this.skyboxModel=this._skyboxCubeMap=null;this._skyboxIntensity=1;this._skyboxMip=0;this.lightmapSizeMultiplier=1;this.lightmapMaxResolution=
2048;this.lightmapMode=1;this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0};this.updateSkybox=this.updateShaders=!0;this._shaderVersion=0;this._statsUpdated=!1;this._models=[];this.defaultMaterial=new ea;this.defaultMaterial.name="Default Material";this.defaultMaterial.shadingModel=1}function Td(){return"undefined"!==
typeof Audio}function Kc(){return!("undefined"===typeof AudioContext&&"undefined"===typeof webkitAudioContext)}function Fh(a){this.position=new r;this.velocity=new r;this.orientation=new C;Kc()&&(this.listener=a.context.listener)}function Sb(a){H.call(this);if(Kc()||a.forceWebAudioApi){if("undefined"!==typeof AudioContext?this.context=new AudioContext:"undefined"!==typeof webkitAudioContext&&(this.context=new webkitAudioContext),this.context){var b=this.context;this.resumeContext=function(){this.context.resume();
window.removeEventListener("mousedown",this.resumeContext);window.removeEventListener("touchend",this.resumeContext)}.bind(this);window.addEventListener("mousedown",this.resumeContext);window.addEventListener("touchend",this.resumeContext);if(va.ios){var c=function(){var a=b.createBuffer(1,1,44100),e=b.createBufferSource();e.buffer=a;e.connect(b.destination);e.start(0);e.disconnect();window.removeEventListener("touchend",c)};window.addEventListener("touchend",c)}}}else console.warn("No support for 3D audio found");
Td()||console.warn("No support for 2D audio found");this.listener=new Fh(this);this._volume=1;this.suspended=!1}function Yf(a,b,c,d){this.time=a;this.position=b;this.rotation=c;this.scale=d}function Zf(){this._name="";this._keys=[]}function Fb(){this.name="";this.duration=0;this._nodes=[];this._nodeDict={}}function Pe(a){this._targets=a;this._updateMorphFlags();this._calculateAabb()}function Qe(a,b){this.name=b.name;this.defaultWeight=b.defaultWeight||0;this._vertexBufferPositions=this._createVertexBuffer(a,
b.deltaPositions,b.deltaPositionsType);this._vertexBufferNormals=this._createVertexBuffer(a,b.deltaNormals,b.deltaNormalsType);this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock());this.aabb=b.aabb;this.aabb||(this.aabb=new ia,this.deltaPositions&&this.aabb.compute(this.deltaPositions))}function $f(){}function S(a,b){Z.call(this,a);a instanceof Y&&(b=a);this._batchHandle=null;this.c={};this._app=b;if(!b&&(this._app=Y.getApplication(),!this._app))throw Error("Couldn't find current application");
this._guid=null;this._destroying=!1}function Yj(a,b,c,d){var e;if(b instanceof S){var g=b.c,k;for(k in g){var l=g[k],h=l.system.getPropertiesOfType("entity");var f=0;for(e=h.length;f<e;f++){var n=h[f].name,m=l[n];a.findByGuid(m)&&((m=d[m].getGuid())?c.c[k][n]=m:console.warn("Could not find corresponding entity id when resolving duplicated entity references"))}}g.script&&!c._app.useLegacyScriptAttributeCloning&&c.script.resolveDuplicatedEntityReferenceProperties(g.script,d);b=b.children.filter(function(a){return a instanceof
S});c=c.children.filter(function(a){return a instanceof S});f=0;for(e=b.length;f<e;f++)Yj(a,b[f],c[f],d)}}function Re(a,b){this._components=a;this._data=b}function Zj(){this._left=Infinity;this._right=-Infinity;this._t=this._p1=this._p0=this._recip=this._len=0;this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}function ag(a,b,c,d){this._paths=a;this._input=b;this._output=c;this._interpolation=d}function Ud(a,b,c,d,e){this._name=a;this._duration=b;this._inputs=c;this._outputs=d;this._curves=e}function ak(a){this._name=
a.name+"Snapshot";this._time=-1;this._cache=[];this._results=[];var b;for(b=0;b<a._inputs.length;++b)this._cache[b]=new Zj;var c=a._curves;a=a._outputs;for(b=0;b<c.length;++b){for(var d=a[c[b]._output],e=[],g=0;g<d._components;++g)e[g]=0;this._results[b]=e}}function Se(a,b,c,d,e){this._name=a.name;this._track=a;this._snapshot=new ak(a);this._playing=d;this._time=b;this._speed=c;this._loop=e;this._blendWeight=1;this._blendOrder=0}function rc(a,b,c){this._func=a;this._type=b;this._components=c}function Tb(){}
function Te(a){var b={},c=function(a){b[a.name]={node:a,count:0};for(var d=0;d<a.children.length;++d)c(a.children[d])};c(a);this.nodes=b;this.activeNodes=[];this.handlers={localPosition:function(a){var b=a.localPosition;return new rc(function(a){b.set.apply(b,a)},"vector",3)},localRotation:function(a){var b=a.localRotation;return new rc(function(a){b.set.apply(b,a)},"quaternion",4)},localScale:function(a){var b=a.localScale;return new rc(function(a){b.set.apply(b,a)},"vector",3)},weights:function(a){for(var b=
a;b&&b.constructor!==S;)b=b.parent;if(!(b&&b.model&&b.model.model&&b.model.model.morphInstances))return null;b=b.model.meshInstances;for(var c,d=0;d<b.length;++d)if(b[d].node.name===a.name){c=b[d].morphInstance;break}return c?new rc(function(a){for(var b=0;b<a.length;++b)c.setWeight(b,a[b])},"vector",c.morph._targets.length):null}};this.propertyLocator=new $f}function Ba(a){this._binder=a;this._clips=[];this._inputs=[];this._outputs=[];this._targets={}}function Gh(){}function Ha(a){H.call(this);this.locale=
bg;this._translations={};this._availableLangs={};this._app=a;this._assets=[];this._parser=new Gh}function Hh(a){this.asset=a}function X(a,b,c,d,e){H.call(this);this._id=Um--;this.name=a||"";this.type=b;this.tags=new Gc(this);this._preload=!1;this.variants=new Hh(this);this._file=null;this._data=d||{};this.options=e||{};this._resources=[];this._i18n={};this.loading=this.loaded=!1;this.registry=null;c&&(this.file=c)}function Lc(){}function Ih(){this.retryRequests=!1}function Jh(){this.retryRequests=
!1}function Kh(a){this._layers=[];this._parameters={};a&&(a.states?(this._layers=[],this._layers.push({name:"DEFAULT_LAYER",states:a.states,transitions:a.transitions})):this._layers=a.layers,this._parameters=Object.assign({},a.parameters))}function Lh(){this.retryRequests=!1}function cg(a){a instanceof Audio?this.audio=a:this.buffer=a}function Ue(a){this.manager=a;this.retryRequests=!1}function Mh(){this.retryRequests=!1}function Ve(a){this._blobUrls={};for(var b=0,c=a.length;b<c;b++)a[b].url&&(this._blobUrls[a[b].name]=
a[b].url)}function bk(a){function b(a){this._fields=a}function c(a){this._arrayBuffer=a||new ArrayBuffer(0);this._bufferView=new DataView(this._arrayBuffer);this._paxHeader=this._globalPaxHeader=null;this._bytesRead=0}if("undefined"!==typeof TextDecoder){var d=new TextDecoder("utf-8");var e=new TextDecoder("windows-1252")}else console.warn("TextDecoder not supported - pc.Untar module will not work");b.parse=function(a,c,e){for(var g=new Uint8Array(a,c,e),k=0,l=[];k<e;){var f;for(f=k;f<e&&32!=g[f];f++);
if(f>=e)throw Error("Invalid PAX header data format.");var q=parseInt(d.decode(new Uint8Array(a,c+k,f-k)),10);f=d.decode(new Uint8Array(a,c+f+1,q-(f-k)-2)).split("=");if(2!==f.length)throw Error("Invalid PAX header data format.");0===f[1].length&&(f[1]=null);l.push({name:f[0],value:f[1]});k+=q}return new b(l)};b.prototype.applyHeader=function(a){for(var b=0;b<this._fields.length;b++){var c=this._fields[b].name,d=this._fields[b].value;"path"===c&&(c="name");null===d?delete a[c]:a[c]=d}};a||(ck=c);
c.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)};c.prototype._readNextFile=function(){var c=new DataView(this._arrayBuffer,this._bytesRead,512),d=e.decode(c);this._bytesRead+=512;c=d.substr(0,100).replace(/\0/g,"");var l=d.substr(257,6),h=parseInt(d.substr(124,12),8),f=d.substr(156,1),n=this._bytesRead,m=null,q=!1;switch(f){case "0":case "":q=!0;a||(m=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+
h)]),m=URL.createObjectURL(m));break;case "g":this._globalPaxHeader=b.parse(this._arrayBuffer,this._bytesRead,h);break;case "x":this._paxHeader=b.parse(this._arrayBuffer,this._bytesRead,h)}this._bytesRead+=h;f=h%512;0!==f&&(this._bytesRead+=512-f);if(!q)return null;-1!==l.indexOf("ustar")&&(d=d.substr(345,155).replace(/\0/g,""),0<d.length&&(c=d.trim()+c.trim()));c={name:c,start:n,size:h,url:m};this._globalPaxHeader&&this._globalPaxHeader.applyHeader(c);this._paxHeader&&(this._paxHeader.applyHeader(c),
this._paxHeader=null);return c};c.prototype.untar=function(a){if(!d)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];for(var b=[];this._hasNext();){var c=this._readNextFile();c&&(a&&c.name&&(c.name=a+c.name),b.push(c))}return b};a&&(self.onmessage=function(a){var b=a.data.id;try{var d=(new c(a.data.arrayBuffer)).untar(a.data.prefix);postMessage({id:b,files:d,arrayBuffer:a.data.arrayBuffer},[a.data.arrayBuffer])}catch(h){postMessage({id:b,error:h.toString()})}})}
function We(a){this._requestId=0;this._pendingRequests={};this._filenamePrefix=a;a=Worker;if(!Nh){var b=new Blob(["("+bk.toString()+")(true)\n\n"],{type:"application/javascript"});Nh=URL.createObjectURL(b)}this._worker=new a(Nh);this._worker.addEventListener("message",this._onMessage.bind(this))}function Oh(a){this._assets=a;this._worker=null;this.retryRequests=!1}function Ph(a){this.data=a;this.model=null;this.materials=[];this.textures=[];this.animations=[];this.registry=null}function Qh(a,b){this._device=
a;this._defaultMaterial=b}function Rh(){this.retryRequests=!1}function Sh(a,b,c){this._device=a;this._assets=b;this._loader=c}function Th(){}function dg(a,b){this.type=b?b.type||"msdf":"msdf";this.em=1;this.textures=a;this.intensity=0;this._data=null;this.data=b}function Uh(a){3>a.version&&(2>a.version&&(a.info.maps=a.info.maps||[{width:a.info.width,height:a.info.height}]),a.chars=Object.keys(a.chars||{}).reduce(function(b,c){var d=a.chars[c];c=void 0!==d.letter?d.letter:dc.fromCodePoint(c);2>a.version&&
(d.map=d.map||0);b[c]=d;return b},{}),a.version=3);return a}function Vh(a){this._loader=a;this.retryRequests=!1}function sb(a,b){H.call(this);this._assets=[];this._registry=b;this._loaded=!1;this._total=this._count=0;this._failed=[];this._waitingAssets=[];if(a.length&&a[0]instanceof X)this._assets=a;else for(var c=0;c<a.length;c++){var d=b.get(a[c]);d?this._assets.push(d):(this._waitForAsset(a[c]),this._total++)}}function eg(a,b){this._app=a;this._isTemplate=b}function Wh(a){this._app=a;this.retryRequests=
!1}function Xh(){this.retryRequests=!1}function Yh(){this.retryRequests=!1}function ec(a,b,c,d,e){this.propertyName=a;this.parent=b;this._scope=e;this._registry=c;this.asset=this.url=this.id=null;this._onAssetLoad=d.load;this._onAssetAdd=d.add;this._onAssetRemove=d.remove}function Xe(){this.valid=this.removeInvalid=!0;this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),shadingModel:this._createEnumValidator([0,
1])}}function Vd(){this._validator=null}function Zh(a){this._assets=a.assets;this._device=a.graphicsDevice;this._placeholderTextures=null;this._parser=new Vd;this.retryRequests=!1}function dk(a){this._device=a;this._defaultMaterial=Y.getApplication().scene.defaultMaterial}function Vm(){this.index=0;this.boneIndices=[0,0,0,0]}function ek(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}function Wm(a){var b=
a.vertices,c=a.skins,d=a.meshes,e=a.meshInstances;for(a=0;a<d.length;a++)d[a].vertices=b[d[a].vertices],void 0!==d[a].skin&&(d[a].skin=c[d[a].skin]);for(a=0;a<e.length;a++)e[a].mesh=d[e[a].mesh]}function Xm(a){var b=a.vertices,c=a.skins,d=a.meshes,e=a.meshInstances;for(a=0;a<d.length;a++)d[a].vertices=b.indexOf(d[a].vertices),void 0!==d[a].skin&&(d[a].skin=c.indexOf(d[a].skin));for(a=0;a<e.length;a++)e[a].mesh=d.indexOf(e[a].mesh)}function fk(a,b,c){var d,e;Wm(a);var g=a.vertices,k=a.skins,l=a.meshes,
h=a.meshInstances,f=function(a){var b=new Vm;b.index=a;return b};for(d=k.length-1;0<=d;d--)if(k[d].boneNames.length>c){var n=k.splice(d,1)[0],m=[];for(e=0;e<l.length;e++)l[e].skin===n&&m.push(l[e]);for(e=0;e<m.length;e++){var q=l.indexOf(m[e]);-1!==q&&l.splice(q,1)}if(0===m.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var u=m[0].vertices;for(e=1;e<m.length;e++)if(m[e].vertices!==u)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");
var t=[],y=[];var w=[];var v=0;for(e=0;e<m.length;e++){var x=m[e];for(var z=x.indices,r=x.base;r<x.base+x.count;){q=z[r++];y[0]=f(q);w[0]=q;q=z[r++];y[1]=f(q);w[1]=q;q=z[r++];y[2]=f(q);w[2]=q;for(var F=!1,Q=v;Q<t.length;Q++)if(q=t[Q],q.addPrimitive(y,w,u,c)){F=!0;break}F||(q=new ek,q.originalMesh=x,q.addPrimitive(y,w,u,c),t.push(q))}v=t.length}x=[];m=[];for(e=0;e<t.length;e++)if(q=t[e],q.vertices.length&&q.indices.length){y=x.length;w=q.vertices.length;v=m.length;z=q.indices.length;q.partition=e;
q.vertexStart=y;q.vertexCount=w;q.indexStart=v;q.indexCount=z;r=0;for(F=y;r<w;)x[F++]=q.vertices[r++];r=0;for(F=v;r<z;)m[F++]=q.indices[r++]+y}y=[];for(e=0;e<t.length;e++){q=t[e];v=[];z=[];for(w=0;w<q.boneIndices.length;w++)v.push(n.inverseBindMatrices[q.boneIndices[w]]),z.push(n.boneNames[q.boneIndices[w]]);q={inverseBindMatrices:v,boneNames:z};y.push(q);k.push(q)}var D;n={};for(D in u)n[D]={components:u[D].components,data:[],type:u[D].type};for(D in u)if("blendIndices"===D)for(q=n[D].data,e=0;e<
x.length;e++)w=x[e].boneIndices,q.push(w[0],w[1],w[2],w[3]);else for(e=u[D],v=e.data,z=e.components,e=0;e<x.length;e++)for(q=x[e].index,w=0;w<z;w++)n[D].data.push(v[q*z+w]);g[g.indexOf(u)]=n;for(e=0;e<t.length;e++)for(q=t[e],x={aabb:{min:[0,0,0],max:[0,0,0]},vertices:n,skin:y[e],indices:m.splice(0,q.indexCount),type:"triangles",base:0,count:q.indexCount},l.push(x),w=h.length-1;0<=w;w--)h[w].mesh===q.originalMesh&&(h.push({mesh:x,node:h[w].node}),b&&b.push({material:b[w].material,path:b[w].path}));
for(e=0;e<t.length;e++)for(q=t[e],w=h.length-1;0<=w;w--)h[w].mesh===q.originalMesh&&(h.splice(w,1),b&&b.splice(w,1))}Xm(a)}function gk(a){this._device=a;this._defaultMaterial=Y.getApplication().scene.defaultMaterial}function $h(a,b){this._device=a;this._parsers=[];this._defaultMaterial=b;this.retryRequests=!1;this.addParser(new gk(this._device),function(a,b){return".json"===V.getExtension(a)});this.addParser(new dk(this._device),function(a,b){return".glb"===V.getExtension(a)})}function ai(a){this._handlers=
{};this._requests={};this._cache={};this._app=a}function bi(a){this._app=a;this.retryRequests=!1}function ci(a){this._app=a;this.retryRequests=!1}function hb(a){this._app=a;this._scripts={};this._cache={}}function di(){this.retryRequests=!1}function Ma(a,b){H.call(this);this._device=a;this._pixelsPerUnit=b&&void 0!==b.pixelsPerUnit?b.pixelsPerUnit:1;this._renderMode=b&&void 0!==b.renderMode?b.renderMode:0;this._atlas=b&&void 0!==b.atlas?b.atlas:null;this._frameKeys=b&&void 0!==b.frameKeys?b.frameKeys:
null;this._meshes=[];this._meshesDirty=this._updatingProperties=!1;this._atlas&&this._frameKeys&&this._createMeshes()}function ei(a,b){this._assets=a;this._device=b;this.retryRequests=!1}function fi(a){this.resource&&(this.resource.atlas=a.resource)}function gi(a){this.registry.load(a)}function Ye(a,b){this._app=a;this._data=b;this._expandedData={};this._templateRoot=null}function hi(a){this._app=a}function ii(){this.retryRequests=!1}function fc(){H.call(this);this._frames=this._texture=null}function ji(a){this._loader=
a;this.retryRequests=!1}function ki(a,b){this.retryRequests=!!b}function li(a,b){this.crossOrigin=a.prefix?"anonymous":null;this.retryRequests=!!b}function mi(a,b){this.retryRequests=!!b}function ni(a,b){this.retryRequests=b}function hk(){}function fg(a,b,c){this._device=a;this._assets=b;this._loader=c;this.imgParser=new li(b,!1);this.parsers={dds:new ni(b,!1),ktx:new mi(b,!1),basis:new ki(b,!1)}}function kd(a){H.call(this);this._loader=a;this._assets=[];this._cache={};this._names={};this._tags=new Dj("_id");
this._urls={};this.prefix=null}function oi(a){this._assets=a;this._bundleAssets={};this._assetsInBundles={};this._urlsInBundles={};this._fileRequests={};this._assets.on("add",this._onAssetAdded,this);this._assets.on("remove",this._onAssetRemoved,this)}function Ub(a){H.call(this);this.app=a;this._scripts={};this._list=[]}function ld(a,b){H.call(this);var c=this;this._app=a;this._device=a.graphicsDevice;this.id=b.displayId;this._frameData=null;window.VRFrameData&&(this._frameData=new window.VRFrameData);
this.display=b;this._camera=null;this.sitToStandInv=new C;this.leftView=new C;this.leftProj=new C;this.leftViewInv=new C;this.leftPos=new r;this.rightView=new C;this.rightProj=new C;this.rightViewInv=new C;this.rightPos=new r;this.combinedPos=new r;this.combinedView=new C;this.combinedProj=new C;this.combinedViewInv=new C;this.combinedAspect=this.combinedFov=0;this.presenting=!1;c._presentChange=function(a){if((a.display?a.display:a.detail&&a.detail.display?a.detail.display:a.detail&&a.detail.vrdisplay?
a.detail.vrdisplay:c.display)===c.display){c.presenting=c.display&&c.display.isPresenting;if(c.presenting){a=c.display.getEyeParameters("left");var b=c.display.getEyeParameters("right");c._app.graphicsDevice.setResolution(2*Math.max(a.renderWidth,b.renderWidth),Math.max(a.renderHeight,b.renderHeight));c._app._allowResize=!1}else c._app.setCanvasResolution("AUTO"),c._app._allowResize=!0;c.fire("beforepresentchange",c);c.fire("presentchange",c)}};window.addEventListener("vrdisplaypresentchange",c._presentChange,
!1)}function Mc(a){H.call(this);var b=this;this.isSupported=Mc.isSupported;this._index={};this.displays=[];this.display=null;this._app=a;this._onDisplayConnect=this._onDisplayConnect.bind(this);this._onDisplayDisconnect=this._onDisplayDisconnect.bind(this);b._attach();this._getDisplays(function(a,d){if(a)b.fire("error",a);else{for(a=0;a<d.length;a++)b._addDisplay(d[a]);b.fire("ready",b.displays)}})}function sc(a,b,c){H.call(this);this.manager=a;this._xrHitTestSource=b;this._transient=c}function Gb(a){H.call(this);
this.manager=a;this._supported=!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource);this._session=null;this.sources=[];this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}function na(a,b){H.call(this);this._id=++Ym;this._manager=a;this._xrInputSource=b;this._ray=new Hc;this._rayLocal=new Hc;this._grip=!1;this._worldTransform=this._localTransform=null;this._position=new r;this._rotation=new T;this._localRotation=this._localPosition=
null;this._dirtyLocal=!0;this._selecting=!1;this._elementInput=!0;this._elementEntity=null;this._hitTestSources=[]}function tb(a){H.call(this);var b=this;this.manager=a;this._session=null;this._inputSources=[];this._onInputSourcesChangeEvt=function(a){b._onInputSourcesChange(a)};this.manager.on("start",this._onSessionStart,this);this.manager.on("end",this._onSessionEnd,this)}function $a(a){H.call(this);this._manager=a;this._lightProbeRequested=this._available=this._supported=!1;this._lightProbe=null;
this._intensity=0;this._rotation=new T;this._color=new J;this._sphericalHarmonics=new Float32Array(27);this._manager.on("start",this._onSessionStart,this);this._manager.on("end",this._onSessionEnd,this)}function Ia(a){H.call(this);var b=this;this.app=a;this._supported=!!navigator.xr;this._available={XRTYPE_AR:!1,XRTYPE_VR:!1,XRTYPE_INLINE:!1};this._referenceSpace=this._baseLayer=this._session=this._spaceType=this._type=null;this.input=new tb(this);this.hitTest=new Gb(this);this.lightEstimation=new $a(this);
this._camera=null;this.views=[];this.viewsPool=[];this._localPosition=new r;this._localRotation=new T;this._depthNear=.1;this._depthFar=1E3;this._height=this._width=0;this._supported&&(navigator.xr.addEventListener("devicechange",function(){b._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck())}function G(a,b){H.call(this);this.system=a;this.entity=b;this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema);this.on("set",function(a,b,e){this.fire("set_"+a,a,b,e)});
this.on("set_enabled",this.onSetEnabled,this)}function B(a){H.call(this);this.app=a;this.store={};this.schema=[]}function Zm(a,b){if(!a)return a;switch(b){case "rgb":return a instanceof J?a.clone():new J(a[0],a[1],a[2]);case "rgba":return a instanceof J?a.clone():new J(a[0],a[1],a[2],a[3]);case "vec2":return a instanceof M?a.clone():new M(a[0],a[1]);case "vec3":return a instanceof r?a.clone():new r(a[0],a[1],a[2]);case "vec4":return a instanceof U?a.clone():new U(a[0],a[1],a[2],a[3]);case "boolean":case "number":case "string":return a;
case "entity":return a;default:throw Error("Could not convert unhandled type: "+b);}}function ik(){this._written=!1;this._name="";this._keyFrames=[];this._quat=new T;this._pos=new r;this._scale=new r;this._targetNode=null}function Na(a){function b(a){var d=new ik;d._name=a.name;c._interpolatedKeys.push(d);c._interpolatedKeyDict[a.name]=d;for(d=c._currKeyIndices[a.name]=0;d<a._children.length;d++)b(a._children[d])}this._animation=null;this._time=0;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict=
{};this._currKeyIndices={};this.graph=null;var c=this;b(a)}function Nc(a,b){G.call(this,a,b);this.animationsIndex={};this.on("set_animations",this.onSetAnimations,this);this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this)}function $m(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.animations={};this.currAnim=this.prevAnim=this.model=null;this.blending=!1;this.blendSpeed=this.blend=0;this.playing=!1;this.animEvaluator=this.toSkel=this.fromSkel=
this.skeleton=null}function Wd(a){B.call(this,a);this.id="animation";this.description="Specifies the animation assets that can run on the model specified by the Entity's model Component.";this.ComponentType=Nc;this.DataType=$m;this.schema=jk;this.on("beforeremove",this.onBeforeRemove,this);this.on("update",this.onUpdate,this);B.bind("update",this.onUpdate,this)}function Ze(a,b){this.animComponent=a;b?Te.call(this,b):this.propertyLocator=new $f}function gg(a,b,c){this._name=a;this._controller=b;this._component=
c}function kk(a,b,c){this._controller=a;this._name=b;this._animations=[];this._speed=c||1}function pi(a,b,c,d,e,g,k,l,h){this._controller=a;this._from=b;this._to=c;this._time=d;this._priority=e;this._conditions=g||[];this._exitTime=k||null;this._transitionOffset=l||null;this._interruptionSource=h||"NONE"}function hg(a,b,c,d,e){this._animEvaluator=a;this._states={};this._stateNames=[];for(a=0;a<b.length;a++)this._states[b[a].name]=new kk(this,b[a].name,b[a].speed),this._stateNames.push(b[a].name);
this._transitions=c.map(function(a){return new pi(this,a.from,a.to,a.time,a.priority,a.conditions,a.exitTime,a.transitionOffset,a.interruptionSource)}.bind(this));this._findTransitionsFromStateCache={};this._findTransitionsBetweenStatesCache={};this._parameters=d;this._previousStateName=null;this._activeStateName="START";this._playing=!1;this._activate=e;this._totalTransitionTime=this._currTransitionTime=1;this._isTransitioning=!1;this._transitionInterruptionSource="NONE";this._transitionPreviousStates=
[];this._timeInStateBefore=this._timeInState=0}function Oc(a,b){G.call(this,a,b)}function an(){this.stateGraphAsset=null;this.speed=1;this.enabled=this.activate=!0;this.playing=!1;this.stateGraph=null;this.layers=[];this.layerIndices={};this.parameters={}}function Xd(a){B.call(this,a);this.id="anim";this.description="State based animation system that can animate the models and component properties of this entity and its children";this.ComponentType=Oc;this.DataType=an;this.schema=lk;this.on("beforeremove",
this.onBeforeRemove,this);this.on("animationUpdate",this.onAnimationUpdate,this);B.bind("animationUpdate",this.onAnimationUpdate,this)}function md(a,b){G.call(this,a,b)}function bn(){this.enabled=!0}function Yd(a,b){B.call(this,a);this.id="audiolistener";this.description="Specifies the location of the listener for 3D audio playback.";this.ComponentType=md;this.DataType=bn;this.schema=mk;this.manager=b;this.current=null;B.bind("update",this.onUpdate,this)}function nd(a,b){G.call(this,a,b);this.on("set_assets",
this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_minDistance",this.onSetMinDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this);this.on("set_distanceModel",this.onSetDistanceModel,this);this.on("set_3d",this.onSet3d,this)}function cn(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=
!1;this["3d"]=!0;this.minDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel=$e;this.paused=!0;this.sources={};this.channel=this.currentSource=null}function Zd(a,b){B.call(this,a);this.id="audiosource";this.description="Specifies audio assets that can be played at the position of the Entity.";this.ComponentType=nd;this.DataType=cn;this.schema=nk;this.manager=b;this.initialized=!1;B.bind("initialize",this.onInitialize,this);B.bind("update",this.onUpdate,this);this.on("remove",this.onRemove,
this)}function tc(a,b,c){if(a&&a instanceof G){if(!b||"string"!==typeof b)throw Error("The propertyName argument is required and must be a string");if(c&&"object"!==typeof c)throw Error("If provided, the eventConfig argument must be an object");}else throw Error("The parentComponent argument is required and must be a Component");this._parentComponent=a;this._entityPropertyName=b;this._entity=null;this._app=a.system.app;this._configureEventListeners(c||{},{"entity#destroy":this._onEntityDestroy});
this._toggleLifecycleListeners("on")}function od(a,b){G.call(this,a,b);this._visualState=Fa.DEFAULT;this._isHovering=!1;this._hoveringCounter=0;this._isPressed=!1;this._defaultTint=new J(1,1,1,1);this._defaultSpriteAsset=null;this._defaultSpriteFrame=0;this._imageReference=new tc(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,
"element#set:spriteFrame":this._onSetSpriteFrame});this._toggleLifecycleListeners("on",a)}function dn(){this.active=this.enabled=!0;this.imageEntity=null;this.hitPadding=new U;this.transitionMode=ig;this.hoverTint=new J(.75,.75,.75);this.pressedTint=new J(.5,.5,.5);this.inactiveTint=new J(.25,.25,.25);this.fadeDuration=0;this.hoverSpriteAsset=null;this.hoverSpriteFrame=0;this.pressedSpriteAsset=null;this.pressedSpriteFrame=0;this.inactiveSpriteAsset=null;this.inactiveSpriteFrame=0}function $d(a){B.call(this,
a);this.id="button";this.ComponentType=od;this.DataType=dn;this.schema=qi;this.on("beforeremove",this._onRemoveComponent,this);B.bind("update",this.onUpdate,this)}function en(){this.clearColor=new J(.722,.722,.722,1);this.clearStencilBuffer=this.clearDepthBuffer=this.clearColorBuffer=!0;this.nearClip=.1;this.farClip=1E3;this.fov=45;this.orthoHeight=100;this.priority=this.projection=0;this.rect=new U(0,0,1,1);this.scissorRect=new U(0,0,1,1);this.enabled=!0;this.frustumCulling=!1;this.cullFaces=!0;
this.flipFaces=!1;this.layers=[0,1,2,4,3];this.camera=null;this.aspectRatio=16/9;this.aspectRatioMode=0;this.postEffects=this.renderTarget=null;this.isRendering=!1;this.calculateProjection=this.calculateTransform=null}function jg(a,b){var c=this;this.app=a;this.camera=b;this.effects=[];this.enabled=!1;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;this.resizeLast=0;this._resizeTimeoutCallback=function(){c.resizeRenderTargets()};b.on("set_rect",this.onCameraRectChanged,this);
this._origStencilColorBuffer=this._origDepthColorBuffer=this._origClearColorBuffer=this._origOverrideClear=!1}function fn(){this.enabled=!0;this.type="box";this.halfExtents=new r(.5,.5,.5);this.radius=.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1}function ri(a,b,c){this.entity=b.entity;this.component=b;this.app=a;"undefined"===typeof Ammo||uc||(uc=new Ammo.btVector3,af=new Ammo.btQuaternion,ae=new Ammo.btTransform);this.initialize(c)}function si(){this.list=
[]}function pd(a){this.func=void 0===a.func?7:a.func;this.ref=a.ref||0;this.readMask=void 0===a.readMask?255:a.readMask;this.writeMask=void 0===a.writeMask?255:a.writeMask;this.fail=a.fail||0;this.zfail=a.zfail||0;this.zpass=a.zpass||0}function ob(a,b,c){this._entity=a;this._element=a.element;this.model=new gb;this.node=new Z;this.model.graph=this.node;this.mesh=b;this.meshInstance=new ma(this.node,this.mesh,c);this.meshInstance.name="ImageElement: "+a.name;this.meshInstance.castShadow=!1;this._meshDirty=
this.meshInstance.receiveShadow=!1;this.model.meshInstances.push(this.meshInstance);this._entity.addChild(this.model.graph);this.model._entity=this._entity;this.unmaskMeshInstance=null}function Ua(a){this._element=a;this._entity=a.entity;this._system=a.system;this._sprite=this._spriteAsset=this._material=this._materialAsset=this._texture=this._textureAsset=null;this._spriteFrame=0;this._pixelsPerUnit=null;this._rect=new U(0,0,1,1);this._mask=!1;this._maskRef=0;this._outerScale=new M;this._outerScaleUniform=
new Float32Array(2);this._innerOffset=new U;this._innerOffsetUniform=new Float32Array(4);this._atlasRect=new U;this._atlasRectUniform=new Float32Array(4);this._defaultMesh=this._createMesh();this._renderable=new ob(this._entity,this._defaultMesh,this._material);this._color=new J(1,1,1,1);this._colorUniform=new Float32Array([1,1,1]);this._renderable.setParameter("material_emissive",this._colorUniform);this._renderable.setParameter("material_opacity",1);this._updateAabbFunc=this._updateAabb.bind(this);
this._onScreenChange(this._element.screen);this._element.on("resize",this._onParentResizeOrPivotChange,this);this._element.on("set:pivot",this._onParentResizeOrPivotChange,this);this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.on("set:screen",this._onScreenChange,this);this._element.on("set:draworder",this._onDrawOrderChange,this);this._element.on("screen:set:resolution",this._onResolutionChange,this)}function ya(a){H.call(this);this._app=a;a.i18n.on("set:locale",
this._onSetLocale,this);this._disableLocalization=this._autoLoad=!1;this._localizedAsset=this._defaultAsset=null}function ok(a){this._symbols=a;this._last=this._index=0;this._cur=0<this._symbols.length?this._symbols[0]:null;this._buf=[];this._mode="text";this._error=null}function pk(a,b){for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];d instanceof Object?(a.hasOwnProperty(c)||(a[c]={}),pk(a[c],b[c])):a[c]=d}}function gn(a){if(0===a.length)return null;for(var b={},c=0;c<a.length;++c){var d=a[c],
e={};e[d.name]={value:d.value,attributes:d.attributes};pk(b,e)}return b}function hn(a,b){function c(a){l=l.filter(function(b){return void 0===a.find(function(a){return a===b})})}function d(a){for(var b=0;b<a.length;++b)l.push(a[b])}var e;if(0===a.length)return null;var g={};for(e=0;e<a.length;++e){var k=a[e];g.hasOwnProperty(k.start)?null===g[k.start].open?g[k.start].open=[k]:g[k.start].open.push(k):g[k.start]={open:[k],close:null};g.hasOwnProperty(k.end)?null===g[k.end].close?g[k.end].close=[k]:
g[k.end].close.push(k):g[k.end]={open:null,close:[k]}}var l=[];k=Object.keys(g).sort(function(a,b){return a-b});a=[];for(e=0;e<k.length;++e){var h=g[k[e]];null!==h.close&&c(h.close);null!==h.open&&d(h.open);a.push({start:k[e],tags:gn(l)})}g=[];k=null;for(e=0;e<a.length;++e){for(h=a[e];g.length<h.start;)g.push(k?k.tags:null);k=h}for(;g.length<b;)g.push(null);return g}function jn(a){var b=new qk(a),c=[],d=[];if(!b.parse(c,d))return console.warn(b.error()),{symbols:a,tags:null};if(b=d.find(function(a){return null===
a.end}))return console.warn("Markup error: found unclosed tag='"+b.name+"'"),{symbols:a,tags:null};a=hn(d,c.length);return{symbols:c,tags:a}}function rk(){}function kn(){this.quad=this.count=0;this.lines={};this.positions=[];this.normals=[];this.uvs=[];this.colors=[];this.indices=[];this.meshInstance=null}function ha(a){this._element=a;this._system=a.system;this._entity=a.entity;this._text="";this._symbols=[];this._colorPalette=[];this._i18nKey=this._symbolColors=null;this._fontAsset=new ya(this._system.app);
this._fontAsset.disableLocalization=!0;this._fontAsset.on("load",this._onFontLoad,this);this._fontAsset.on("change",this._onFontChange,this);this._fontAsset.on("remove",this._onFontRemove,this);this._font=null;this._color=new J(1,1,1,1);this._colorUniform=new Float32Array(3);this._spacing=1;this._fontSize=32;this._fontMaxY=this._fontMinY=0;this._maxFontSize=this._originalFontSize=32;this._minFontSize=8;this._autoFitHeight=this._autoFitWidth=!1;this._maxLines=-1;this._scaledLineHeight=this._lineHeight=
32;this._wrapLines=!1;this._drawOrder=0;this._alignment=new M(.5,.5);this._autoHeight=this._autoWidth=!0;this.height=this.width=0;this._node=new Z;this._model=new gb;this._model.graph=this._node;this._entity.addChild(this._node);this._meshInfo=[];this._material=null;this._aabbDirty=!0;this._aabb=new ia;this._noResize=!1;this._maskedMaterialSrc=this._currentMaterialType=null;this._rtl=this._unicodeConverter=this._rtlReorder=!1;this._outlineColor=new J(0,0,0,1);this._outlineColorUniform=new Float32Array(4);
this._outlineThicknessScale=.2;this._outlineThickness=0;this._shadowColor=new J(0,0,0,1);this._shadowColorUniform=new Float32Array(4);this._shadowOffsetScale=.005;this._shadowOffset=new M(0,0);this._shadowOffsetUniform=new Float32Array(2);this._enableMarkup=!1;this._onScreenChange(this._element.screen);a.on("resize",this._onParentResize,this);a.on("set:screen",this._onScreenChange,this);a.on("screen:set:screenspace",this._onScreenSpaceChange,this);a.on("set:draworder",this._onDrawOrderChange,this);
a.on("set:pivot",this._onPivotChange,this);this._system.app.i18n.on("set:locale",this._onLocaleSet,this);this._system.app.i18n.on("data:add",this._onLocalizationData,this);this._system.app.i18n.on("data:remove",this._onLocalizationData,this);this._rangeEnd=this._rangeStart=0}function ba(a,b){G.call(this,a,b);this._beingInitialized=!1;this._anchor=new U;this._localAnchor=new U;this._pivot=new M;this._height=this._calculatedHeight=this._width=this._calculatedWidth=32;this._margin=new U(0,0,-32,-32);
this._modelTransform=new C;this._screenToWorld=new C;this._anchorTransform=new C;this._anchorDirty=!0;this._parentWorldTransform=new C;this._screenTransform=new C;this._screenCorners=[new r,new r,new r,new r];this._canvasCorners=[new M,new M,new M,new M];this._worldCorners=[new r,new r,new r,new r];this._worldCornersDirty=this._canvasCornersDirty=this._cornersDirty=!0;this.entity.on("insert",this._onInsert,this);this._patch();this.screen=null;this._type=sk;this._group=this._text=this._image=null;
this._drawOrder=0;this._useInput=!1;this._layers=[4];this._addedModels=[];this._batchGroupId=-1;this._offsetReadAt=0;this._maskOffset=.5;this._maskedBy=null}function ln(){this.enabled=!0}function be(a){B.call(this,a);this.id="element";this.ComponentType=ba;this.DataType=ln;this.schema=tk;this._rtlReorder=this._unicodeConverter=null;this._defaultTexture=new L(a.graphicsDevice,{width:1,height:1,format:7});this._defaultTexture.name="element-system";a=this._defaultTexture.lock();var b=new Uint8Array(4);
b[0]=255;b[1]=255;b[2]=255;b[3]=255;a.set(b);this._defaultTexture.unlock();this.defaultScreenSpaceBitmapTextMaterial=this.defaultScreenSpaceTextMaterial=this.defaultBitmapTextMaterial=this.defaultTextMaterial=this.defaultScreenSpaceImageMaskMaterial=this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImageMask9SlicedMaterial=this.defaultScreenSpaceImage9TiledMaterial=this.defaultScreenSpaceImage9SlicedMaterial=this.defaultScreenSpaceImageMaterial=this.defaultImage9TiledMaskMaterial=
this.defaultImage9SlicedMaskMaterial=this.defaultImageMaskMaterial=this.defaultImage9TiledMaterial=this.defaultImage9SlicedMaterial=this.defaultImageMaterial=null;this.defaultImageMaterials=[];this.on("beforeremove",this.onRemoveComponent,this)}function qd(a,b){G.call(this,a,b);this._minHeight=this._minWidth=0;this._maxHeight=this._maxWidth=null;this._fitHeightProportion=this._fitWidthProportion=0;this._excludeFromLayout=!1}function rd(a){var b="_"+a;Object.defineProperty(qd.prototype,a,{get:function(){return this[b]},
set:function(a){this[b]!==a&&(this[b]=a,this.fire("resize"))}})}function mn(){this.enabled=!0}function ti(){}function uk(a){function b(a){a=a.entity.layoutchild;return!a||!a.enabled||!a.excludeFromLayout}function c(a,b,c){switch(a){case ui:return pb.NONE;case 1:return b<c?pb.APPLY_STRETCHING:pb.NONE;case 2:return b>=c?pb.APPLY_SHRINKING:pb.NONE;case 3:return b<c?pb.APPLY_STRETCHING:b>=c?pb.APPLY_SHRINKING:pb.NONE;default:throw Error("Unrecognized fitting mode: "+a);}}function d(a,b){return f(a,b.size)+
(a.length-1)*y.spacing[b.axis]}function e(a,b,c){var d=m(a,c.maxSize),e=n(a,c.fittingProportion),g=t(e,d);b=ub[c.axis]-b;for(var h=0;h<a.length;++h){var l=d[h],f=k(l,b,e,g),p=a[l][c.size]+f,q=Math.min(p,a[l][c.maxSize]);a[l][c.size]=q;b-=f-Math.max(p-q,0)}}function g(a,b,c){var d=m(a,c.minSize,!0);var e=n(a,c.fittingProportion);if(1===e.length)e=[1];else{for(var g=[],h=e.length,l=0;l<h;++l)g.push((1-e[l])/(h-1));e=g}g=t(e,d);b-=ub[c.axis];for(h=0;h<a.length;++h){l=d[h];var f=k(l,b,e,g),p=a[l][c.size]-
f,q=Math.max(p,a[l][c.minSize]);a[l][c.size]=q;b-=f-Math.max(q-p,0)}}function k(a,b,c,d){c=c[a];a=d[a];return 1E-5>Math.abs(c)&&1E-5>Math.abs(a)?b:b*c/a}function l(a){for(var b=[],c=0;c<a.length;++c){var d=a[c],e=Math.max(h(d,"minWidth"),0),g=Math.max(h(d,"minHeight"),0),k=Math.max(h(d,"maxWidth"),e),l=Math.max(h(d,"maxHeight"),g);var f=h(d,"width");f=Math.min(Math.max(f,e),k);var p=h(d,"height");p=Math.min(Math.max(p,g),l);var m=h(d,"fitWidthProportion");d=h(d,"fitHeightProportion");b.push({minWidth:e,
minHeight:g,maxWidth:k,maxHeight:l,width:f,height:p,fitWidthProportion:m,fitHeightProportion:d})}return b}function h(a,b){var c=a.entity.layoutchild;return c&&c.enabled&&void 0!==c[b]&&null!==c[b]?c[b]:void 0!==a[b]?a[b]:nn[b]}function f(a,b){return a.reduce(function(a,c){return a+c[b]},0)}function n(a,b){var c=f(a,b),d=[],e=a.length,g;if(0===c)for(g=0;g<e;++g)d.push(1/e);else for(g=0;g<e;++g)d.push(a[g][b]/c);return d}function m(a,b,c){a.forEach(q);return a.slice().sort(function(a,d){return c?d[b]-
a[b]:a[b]-d[b]}).map(u)}function q(a,b){a.index=b}function u(a){return a.index}function t(a,b){var c=[];c[b[a.length-1]]=a[b[a.length-1]];for(var d=a.length-2;0<=d;--d)c[b[d]]=c[b[d+1]]+a[b[d]];return c}var y,w=vk[a],v=vk[on[a]];return function(a,k){a=a.filter(b);y=k;ub.x=y.containerSize.x-y.padding.x-y.padding.z;ub.y=y.containerSize.y-y.padding.y-y.padding.w;k=a;for(var h=0;h<k.length;++h){var f=k[h],p=f.anchor;if(0!==p.x||0!==p.y||0!==p.z||0!==p.w)f.anchor=U.ZERO}if(y.wrap){k=[[]];h=l(a);f=0;p=
2===y[w.fitting];for(var m=0;m<a.length;++m){0<k[k.length-1].length&&(f+=y.spacing[w.axis]);var n=h[m][w.size];f+=n;!p&&f>ub[w.axis]&&0!==k[k.length-1].length&&(f=n,k.push([]));k[k.length-1].push(a[m]);p&&f>ub[w.axis]&&m!==a.length-1&&(f=0,k.push([]))}a=k}else a=[a];k=0===y.orientation&&y.reverseX||1===y.orientation&&y.reverseY;h=0===y.orientation&&y.reverseY||1===y.orientation&&y.reverseX;if(k)for(f=0;f<a.length;++f)k&&a[f].reverse();h&&a.reverse();k=[];for(h=0;h<a.length;++h)f=l(a[h]),p=d(f,w),
m=c(y[w.fitting],p,ub[w.axis]),m===pb.APPLY_STRETCHING?e(f,p,w):m===pb.APPLY_SHRINKING&&g(f,p,w),k.push(f);n=[];m=[];for(f=0;f<a.length;++f){p=a[f];p.largestElement=null;p.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(h=0;h<p.length;++h){var q=k[f][h];q[v.size]>p.largestSize[v.size]&&(p.largestElement=p[h],p.largestSize=q)}n.push(p.largestElement);m.push(p.largestSize)}h=d(m,v);f=c(y[v.fitting],h,ub[v.axis]);f===pb.APPLY_STRETCHING?e(m,h,v):f===pb.APPLY_SHRINKING&&
g(m,h,v);for(f=0;f<a.length;++f)for(p=a[f],h=0;h<p.length;++h)m=k[f][h],n=1===a.length?ub[v.axis]:p.largestSize[v.size],q=c(y[v.fitting],m[v.size],n),q===pb.APPLY_STRETCHING?m[v.size]=Math.min(n,m[v.maxSize]):q===pb.APPLY_SHRINKING&&(m[v.size]=Math.max(n,m[v.minSize]));a:{h={};h[w.axis]=0;h[v.axis]=0;a[w.size]=Number.NEGATIVE_INFINITY;f=[];for(p=0;p<a.length;++p){m=a[p];if(0===m.length){h=void 0;break a}n=[];q=k[p];for(var u=0;u<m.length;++u){var t=m[u],r=q[u];h[v.axis]-=-r[v.size]*t.pivot[v.axis];
h[w.axis]-=-r[w.size]*t.pivot[w.axis];n[u]={};n[u][w.axis]=h[w.axis];n[u][v.axis]=h[v.axis];h[v.axis]+=-r[v.size]*t.pivot[v.axis];h[w.axis]+=r[w.size]*(1-t.pivot[w.axis])+y.spacing[w.axis]}m[w.size]=h[w.axis]-y.spacing[w.axis];m[v.size]=m.largestSize[v.size];a[w.size]=Math.max(a[w.size],m[w.size]);h[w.axis]=0;h[v.axis]+=m[v.size]+y.spacing[v.axis];f.push(n)}a[v.size]=h[v.axis]-y.spacing[v.axis];h=f}f=h;p=y.alignment[w.axis];m=y.alignment[v.axis];n=y.padding[w.axis];q=y.padding[v.axis];for(u=0;u<a.length;++u){t=
a[u];r=k[u];for(var x=f[u],z=(ub[w.axis]-t[w.size])*p+n,B=(ub[v.axis]-a[v.size])*m+q,C=0;C<t.length;++C){var H=(t[v.size]-r[C][v.size])*y.alignment[v.axis];x[C][w.axis]+=z;x[C][v.axis]+=B+H}}for(f=0;f<a.length;++f)for(p=a[f],m=k[f],n=h[f],q=0;q<p.length;++q)u=p[q],u[w.calculatedSize]=m[q][w.size],u[v.calculatedSize]=m[q][v.size],0===y.orientation?u.entity.setLocalPosition(n[q][w.axis],n[q][v.axis],u.entity.getLocalPosition().z):u.entity.setLocalPosition(n[q][v.axis],n[q][w.axis],u.entity.getLocalPosition().z);
k=a.width;a=a.height;return{bounds:new U((ub.x-k)*y.alignment.x+y.padding.x,(ub.y-a)*y.alignment.y+y.padding.y,k,a)}}}function Pc(a,b){G.call(this,a,b);this._orientation=0;this._reverseX=!1;this._reverseY=!0;this._alignment=new M(0,1);this._padding=new U;this._spacing=new M;this._heightFitting=this._widthFitting=ui;this._wrap=!1;this._layoutCalculator=new ti;this._listenForReflowEvents(this.entity,"on");this.entity.children.forEach(function(a){this._listenForReflowEvents(a,"on")}.bind(this));this.entity.on("childinsert",
this._onChildInsert,this);this.entity.on("childremove",this._onChildRemove,this);a.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this);a.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this);a.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this);a.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}function pn(a){return a.element}function qn(a){return a.enabled&&a.element&&a.element.enabled}function vc(a){var b=
"_"+a;Object.defineProperty(Pc.prototype,a,{get:function(){return this[b]},set:function(a){this[b]!==a&&(this[b]=a,this._scheduleReflow())}})}function rn(){this.enabled=!0}function ce(a){B.call(this,a);this.id="layoutgroup";this.ComponentType=Pc;this.DataType=rn;this.schema=wk;this._reflowQueue=[];this.on("beforeremove",this._onRemoveComponent,this);B.bind("postUpdate",this._onPostUpdate,this)}function Qc(a,b){G.call(this,a,b);this._cookieAssetId=this._cookieAsset=null;this._cookieAssetAdd=!1;this._cookieMatrix=
null}function sn(){for(var a=vi,b=tn,c,d=0;d<a.length;d++)c=b[d],this[a[d]]=c&&c.clone?c.clone():c}function de(a){B.call(this,a);this.id="light";this.description="Enables the Entity to emit light.";this.ComponentType=Qc;this.DataType=sn;this.on("beforeremove",this._onRemoveComponent,this)}function Ca(a,b){G.call(this,a,b);this._type="asset";this._model=this._asset=null;this._mapping={};this._receiveShadows=this._castShadows=!0;this._materialAsset=null;this._material=a.defaultMaterial;this._castShadowsLightmap=
!0;this._lightmapped=!1;this._lightmapSizeMultiplier=1;this._isStatic=!1;this._layers=[0];this._batchGroupId=-1;this._area=null;this._assetOld=0;this._materialEvents=null;this._clonedModel=this._dirtyMaterialAsset=this._dirtyModelAsset=!1;b.on("remove",this.onRemoveChild,this);b.on("insert",this.onInsertChild,this)}function un(){this.enabled=!0}function ee(a){B.call(this,a);this.id="model";this.description="Renders a 3D model at the location of the Entity.";this.ComponentType=Ca;this.DataType=un;
this.schema=xk;this.sphere=this.plane=this.cylinder=this.cone=this.capsule=this.box=null;this.defaultMaterial=a.scene.defaultMaterial;this.on("beforeremove",this.onRemove,this)}function vn(){this.rate=this.numParticles=1;this.rate2=null;this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.emitterExtents=new r;this.emitterExtentsInner=new r;this.initialVelocity=this.emitterShape=this.emitterRadiusInner=this.emitterRadius=0;this.wrapBounds=new r;this.localSpace=!1;this.normalMapAsset=this.normalMap=
this.colorMapAsset=this.colorMap=null;this.loop=!0;this.preWarm=!1;this.mode=this.sort=0;this.scene=null;this.halfLambert=this.lighting=!1;this.intensity=1;this.stretch=0;this.alignToMotion=!1;this.depthSoftening=0;this.mesh=this.meshAsset=null;this.noFog=this.depthWrite=!1;this.orientation=0;this.particleNormal=new r(0,1,0);this.animTilesY=this.animTilesX=1;this.animStartFrame=0;this.animNumAnimations=this.animNumFrames=1;this.animIndex=0;this.randomizeAnimIndex=!1;this.animSpeed=1;this.animLoop=
!0;this.radialSpeedGraph2=this.radialSpeedGraph=this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null;this.blendType=2;this.model=null;this.enabled=!0;this.paused=!1;this.autoPlay=!0;this.layers=[0]}function fe(a){B.call(this,a);this.id="particlesystem";this.description="Updates and renders particle system in the scene.";
this.ComponentType=sd;this.DataType=vn;this.schema=yk;this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"};
this.on("beforeremove",this.onBeforeRemove,this);B.bind("update",this.onUpdate,this)}function kg(a,b){this._constructor=a;this._pool=[];this._count=0;this._resize(b)}function Vb(a,b){G.call(this,a,b);"undefined"===typeof Ammo||Hb||(Hb=new Ammo.btTransform,ra=new Ammo.btVector3,bf=new Ammo.btVector3,wi=new Ammo.btQuaternion,xi=new Ammo.btVector3(0,0,0));this.on("set_mass",this.onSetMass,this);this.on("set_linearDamping",this.onSetLinearDamping,this);this.on("set_angularDamping",this.onSetAngularDamping,
this);this.on("set_linearFactor",this.onSetLinearFactor,this);this.on("set_angularFactor",this.onSetAngularFactor,this);this.on("set_friction",this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_type",this.onSetType,this);this.on("set_group",this.onSetGroupOrMask,this);this.on("set_mask",this.onSetGroupOrMask,this);this.on("set_body",this.onSetBody,this);this._linearVelocity=new r(0,0,0);this._angularVelocity=new r(0,0,0)}function wn(){this.enabled=!0;this.mass=
1;this.angularDamping=this.linearDamping=0;this.linearFactor=new r(1,1,1);this.angularFactor=new r(1,1,1);this.friction=.5;this.restitution=0;this.type=ge;this.group=yi;this.mask=lg;this.body=null;this.simulationEnabled=!1}function zi(a,b,c){this.entity=a;this.point=b;this.normal=c}function zk(a,b,c){0===arguments.length?(this.b=this.a=null,this.localPointA=new r,this.localPointB=new r,this.pointA=new r,this.pointB=new r,this.normal=new r):(this.a=a,this.b=b,this.localPointA=c.localPoint,this.localPointB=
c.localPointOther,this.pointA=c.point,this.pointB=c.pointOther,this.normal=c.normal)}function Ak(a,b,c,d,e){0===arguments.length?(this.localPoint=new r,this.localPointOther=new r,this.point=new r,this.pointOther=new r,this.normal=new r):(this.localPoint=a,this.localPointOther=b,this.point=c,this.pointOther=d,this.normal=e)}function Bk(a,b){this.other=a;this.contacts=b}function td(a){B.call(this,a);this.id="rigidbody";this.description="Adds the entity to the scene's physical simulation.";this._stats=
a.stats.frame;this.ComponentType=Vb;this.DataType=wn;this.singleContactResultPool=this.contactResultPool=this.contactPointPool=null;this.schema=Ck;this.maxSubSteps=10;this.fixedTimeStep=1/60;this.gravity=new r(0,-9.81,0);this._dynamic=[];this._kinematic=[];this._triggers=[];this._compounds=[];this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",this.onRemove,this)}function vb(a,b){G.call(this,a,b);this._resolution=new M(640,320);this._referenceResolution=new M(640,320);this._scaleMode=
ud;this.scale=1;this._scaleBlend=.5;this._priority=0;this.cull=this._screenSpace=!1;this._screenMatrix=new C;a.app.graphicsDevice.on("resizecanvas",this._onResize,this)}function xn(){this.enabled=!0}function he(a){B.call(this,a);this.id="screen";this.ComponentType=vb;this.DataType=xn;this.schema=Dk;this.windowResolution=new M;this._drawOrderSyncQueue=new mh;this.app.graphicsDevice.on("resizecanvas",this._onResize,this);B.bind("update",this._onUpdate,this);this.on("beforeremove",this.onRemoveComponent,
this)}function vd(a){this.scriptType=a;this.index={}}function Va(a){H.call(this);var b=this.constructor;this.app=a.app;this.entity=a.entity;this._enabled="boolean"===typeof a.enabled?a.enabled:!0;this._enabledOld=this.enabled;this.__destroyed=!1;this.__attributes={};this.__attributesRaw=a.attributes||{};this.__scriptType=b;this.__executionOrder=-1}function wb(a,b){if(ib.legacy)return null;if(wb.reservedScripts[a])throw Error("script name: '"+a+"' is reserved, please change script name");var c=function(a){Va.call(this,
a)};c.prototype=Object.create(Va.prototype);c.prototype.constructor=c;c.extend=Va.extend;c.attributes=new vd(c);Ek(c,a,b);return c}function Ek(a,b,c){if(!a.legacy){if("function"!==typeof a)throw Error("script class: '"+a+"' must be a constructor function (i.e. class).");if(!(a.prototype instanceof Va))throw Error("script class: '"+Va.__getScriptName(a)+"' does not extend pc.ScriptType.");b=b||a.__name||Va.__getScriptName(a);if(wb.reservedScripts[b])throw Error("script name: '"+b+"' is reserved, please change script name");
a.__name=b;(c?c.scripts:Y.getApplication().scripts).add(a);hb._push(a)}}function Wb(a){this._sortBy=a.sortBy;this.items=[];this.length=0;this.loopIndex=-1;this._sortHandler=this._doSort.bind(this)}function Qa(a,b){G.call(this,a,b);this._scripts=[];this._updateList=new Wb({sortBy:"__executionOrder"});this._postUpdateList=new Wb({sortBy:"__executionOrder"});this._scriptsIndex={};this._destroyedScripts=[];this._destroyed=!1;this._scriptsData=null;this._enabled=this._oldState=!0;this._isLoopingThroughScripts=
this._beingEnabled=!1;this._executionOrder=-1;this.on("set_enabled",this._onSetEnabled,this)}function yn(){this.enabled=!0}function ie(a){B.call(this,a);this.id="script";this.ComponentType=Qa;this.DataType=yn;this._components=new Wb({sortBy:"_executionOrder"});this._enabledComponents=new Wb({sortBy:"_executionOrder"});this.preloading=!0;this.on("beforeremove",this._onBeforeRemove,this);B.bind("initialize",this._onInitialize,this);B.bind("postInitialize",this._onPostInitialize,this);B.bind("update",
this._onUpdate,this);B.bind("postUpdate",this._onPostUpdate,this)}function wd(a,b){G.call(this,a,b);this.on("set_scripts",this.onSetScripts,this)}function zn(){this.scripts=[];this.enabled=!0;this.instances={};this._instances={};this.runInTools=!1;this.attributes={};this.areScriptsLoaded=this.postInitialized=this.initialized=!1}function wc(a,b){H.call(this);if(!(a&&a instanceof ba))throw Error("Element was null or not an ElementComponent");if(b&&"x"!==b&&"y"!==b)throw Error("Unrecognized axis: "+
b);this._element=a;this._app=a.system.app;this._axis=b||null;this._enabled=!0;this._dragScale=new r;this._dragStartMousePosition=new r;this._dragStartHandlePosition=new r;this._deltaMousePosition=new r;this._deltaHandlePosition=new r;this._isDragging=!1;this._toggleLifecycleListeners("on")}function Rc(a,b){G.call(this,a,b);this._viewportReference=new tc(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize});this._contentReference=new tc(this,
"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize});this._scrollbarUpdateFlags={};this._scrollbarReferences={};this._scrollbarReferences[0]=new tc(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain});this._scrollbarReferences[1]=new tc(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,
"scrollbar#gain":this._onVerticalScrollbarGain});this._prevContentSizes={};this._prevContentSizes[0]=null;this._prevContentSizes[1]=null;this._scroll=new M;this._velocity=new r;this._dragStartPosition=new r;this._disabledContentInput=!1;this._disabledContentInputEntities=[];this._toggleLifecycleListeners("on",a);this._toggleElementListeners("on")}function An(){this.enabled=!0}function xd(a,b){G.call(this,a,b);this._app=a.app;this._handleReference=new tc(this,"handleEntity",{"element#gain":this._onHandleElementGain,
"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment});this._toggleLifecycleListeners("on")}function Bn(){this.enabled=!0}function je(a){B.call(this,a);this.id="scrollbar";this.ComponentType=xd;this.DataType=Bn;this.schema=Ai;this.on("beforeremove",this._onRemoveComponent,this)}function Da(a,b,c){H.call(this);c=c||{};this._component=a;this._assets=a.system.app.assets;
this._manager=a.system.manager;this._name=b||"Untitled";this._volume=void 0!==c.volume?O.clamp(Number(c.volume)||0,0,1):1;this._pitch=void 0!==c.pitch?Math.max(.01,Number(c.pitch)||0):1;this._loop=!(void 0===c.loop||!c.loop);this._duration=0<c.duration?c.duration:null;this._startTime=Math.max(0,Number(c.startTime)||0);this._overlap=!!c.overlap;this._autoPlay=!!c.autoPlay;this._lastNode=this._firstNode=null;this._asset=c.asset;this._asset instanceof X&&(this._asset=this._asset.id);this._onInstancePlayHandler=
this._onInstancePlay.bind(this);this._onInstancePauseHandler=this._onInstancePause.bind(this);this._onInstanceResumeHandler=this._onInstanceResume.bind(this);this._onInstanceStopHandler=this._onInstanceStop.bind(this);this._onInstanceEndHandler=this._onInstanceEnd.bind(this);this.instances=[]}function yd(a,b){G.call(this,a,b);this.on("set_slots",this.onSetSlots,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_refDistance",this.onSetRefDistance,
this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this);this.on("set_distanceModel",this.onSetDistanceModel,this);this.on("set_positional",this.onSetPositional,this)}function Cn(){this.enabled=!0;this.pitch=this.volume=1;this.positional=!0;this.refDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel="linear";this.slots={};this.playingBeforeDisable={}}function jb(a,b){H.call(this);this._component=a;this._frame=0;this._spriteAsset=
this._sprite=null;this.spriteAsset=b.spriteAsset;this.name=b.name;this.fps=b.fps||0;this.loop=b.loop||!1;this._paused=this._playing=!1;this._time=0}function Dn(){this.enabled=!0}function zd(a){B.call(this,a);this.id="sprite";this.ComponentType=ua;this.DataType=Dn;this.schema=Fk;this._default9SlicedMaterialTiledMode=this._default9SlicedMaterialSlicedMode=this._defaultMaterial=this._defaultTexture=null;B.bind("update",this.onUpdate,this);this.on("beforeremove",this.onBeforeRemove,this)}function Sc(a,
b){G.call(this,a,b);this._oldState=!0;this._size=new r;this.on("set_enabled",this._onSetEnabled,this)}function En(){this.enabled=!0}function Fn(a){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,_timeToCountFrames:0,_fpsAccum:0};this.drawCalls={forward:0,
depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0};this.misc={renderTargetCreationTime:0};this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0};this.vram=a._vram;this.shaders=a._shaderStats;Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}});Object.defineProperty(this,"scene",{get:function(){return Y._currentApplication.scene._stats}});Object.defineProperty(this,"lightmapper",{get:function(){return Y._currentApplication.lightmapper._stats}});
Object.defineProperty(this,"batcher",{get:function(){return Y._currentApplication.batcher._stats}})}function Gk(a,b){this.name=a;this.url=b}function Xb(a){this._app=a;this._list=[];this._index={};this._urlIndex={}}function Y(a,b){H.call(this);b=b||{};console.log("Powered by PlayCanvas 1.29.0 fb8f6a3");Y._applications[a.id]=this;Y._currentApplication=this;f.app=this;this._time=0;this.timeScale=1;this.maxDeltaTime=.1;this.frame=0;this.autoRender=!0;this.renderNextFrame=!1;this.useLegacyScriptAttributeCloning=
ib.legacy;this._librariesLoaded=!1;this._fillMode=mg;this._resolutionMode=Bi;this._allowResize=!0;this.context=this;b.graphicsDeviceOptions||(b.graphicsDeviceOptions={});b.graphicsDeviceOptions.xrCompatible=!0;this.graphicsDevice=new kb(a,b.graphicsDeviceOptions);this.stats=new Fn(this.graphicsDevice);this._soundManager=new Sb(b);this.loader=new ai(this);this._entityIndex={};this.scene=new ka;this.root=new S(this);this.root._enabledInHierarchy=!0;this._enableList=[];this._enableList.size=0;this.assets=
new kd(this.loader);b.assetPrefix&&(this.assets.prefix=b.assetPrefix);this.bundles=new oi(this.assets);this.enableBundles="undefined"!==typeof TextDecoder;this.scriptsOrder=b.scriptsOrder||[];this.scripts=new Ub(this);this.i18n=new Ha(this);this.scenes=new Xb(this);var c=this;this.defaultLayerWorld=new fa({name:"World",id:0});this.graphicsDevice.webgl2?(this.defaultLayerDepth=new fa({enabled:!1,name:"Depth",id:1,onEnable:function(){if(!this.renderTarget){var a=new L(c.graphicsDevice,{format:17,width:c.graphicsDevice.width,
height:c.graphicsDevice.height});a.name="rt-depth2";a.minFilter=0;a.magFilter=0;a.addressU=1;a.addressV=1;this.renderTarget=new oa({colorBuffer:null,depthBuffer:a,autoResolve:!1});c.graphicsDevice.scope.resolve("uDepthMap").setValue(a)}},onDisable:function(){this.renderTarget&&(this.renderTarget._depthBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPreRenderOpaque:function(a){var b=c.graphicsDevice.gl;this.srcFbo=b.getParameter(b.FRAMEBUFFER_BINDING);this.renderTarget&&this.renderTarget.width===
c.graphicsDevice.width&&this.renderTarget.height===c.graphicsDevice.height||(this.onDisable(),this.onEnable());this.oldClear=this.cameras[a].camera._clearOptions;this.cameras[a].camera._clearOptions=this.depthClearOptions},onPostRenderOpaque:function(a){this.renderTarget&&(this.cameras[a].camera._clearOptions=this.oldClear,a=c.graphicsDevice.gl,c.graphicsDevice.setRenderTarget(this.renderTarget),c.graphicsDevice.updateBegin(),a.bindFramebuffer(a.READ_FRAMEBUFFER,this.srcFbo),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,
this.renderTarget._glFrameBuffer),a.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,a.DEPTH_BUFFER_BIT,a.NEAREST))}}),this.defaultLayerDepth.depthClearOptions={flags:0}):(this.defaultLayerDepth=new fa({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function(){if(!this.renderTarget){var a=new L(c.graphicsDevice,{format:7,width:c.graphicsDevice.width,height:c.graphicsDevice.height});a.name="rt-depth1";a.minFilter=0;a.magFilter=
0;a.addressU=1;a.addressV=1;this.renderTarget=new oa(c.graphicsDevice,a,{depth:!0,stencil:c.graphicsDevice.supportsStencil});c.graphicsDevice.scope.resolve("uDepthMap").setValue(a)}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPostCull:function(a){var b=this.instances.visibleOpaque[a],d=b.list,k=0,l=c.scene.layers.layerList,h=c.scene.layers.subLayerEnabled,f=c.scene.layers.subLayerList,n=c.defaultLayerWorld.renderTarget;
a=this.cameras[a];for(var m,q,u,t,y=0;y<l.length;y++){m=l[y];if(m===this)break;if(m.renderTarget===n&&m.enabled&&h[y]&&(q=m.cameras.indexOf(a),!(0>q)))for(q=(u=f[y])?m.instances.visibleTransparent[q]:m.instances.visibleOpaque[q],u=q.length,q=q.list,m=0;m<u;m++)t=q[m],t.material&&t.material.depthWrite&&!t._noDepthDrawGl1&&(d[k]=t,k++)}b.length=k},onPreRenderOpaque:function(a){this.renderTarget&&this.renderTarget.width===c.graphicsDevice.width&&this.renderTarget.height===c.graphicsDevice.height||(this.onDisable(),
this.onEnable());this.oldClear=this.cameras[a].camera._clearOptions;this.cameras[a].camera._clearOptions=this.rgbaDepthClearOptions},onDrawCall:function(){c.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(a){this.renderTarget&&(this.cameras[a].camera._clearOptions=this.oldClear)}}),this.defaultLayerDepth.rgbaDepthClearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:3});this.defaultLayerSkybox=new fa({enabled:!1,name:"Skybox",id:2,opaqueSortMode:0});this.defaultLayerUi=
new fa({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1});this.defaultLayerImmediate=new fa({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0});this.defaultLayerComposition=new pa;this.defaultLayerComposition.pushOpaque(this.defaultLayerWorld);this.defaultLayerComposition.pushOpaque(this.defaultLayerDepth);this.defaultLayerComposition.pushOpaque(this.defaultLayerSkybox);this.defaultLayerComposition.pushTransparent(this.defaultLayerWorld);this.defaultLayerComposition.pushOpaque(this.defaultLayerImmediate);
this.defaultLayerComposition.pushTransparent(this.defaultLayerImmediate);this.defaultLayerComposition.pushTransparent(this.defaultLayerUi);this.scene.layers=this.defaultLayerComposition;this._immediateLayer=this.defaultLayerImmediate;this.scene.on("set:layers",function(a,b){a=b.layerList;for(var d=0;d<a.length;d++)switch(b=a[d],b.id){case 1:b.onEnable=c.defaultLayerDepth.onEnable;b.onDisable=c.defaultLayerDepth.onDisable;b.onPreRenderOpaque=c.defaultLayerDepth.onPreRenderOpaque;b.onPostRenderOpaque=
c.defaultLayerDepth.onPostRenderOpaque;b.depthClearOptions=c.defaultLayerDepth.depthClearOptions;b.rgbaDepthClearOptions=c.defaultLayerDepth.rgbaDepthClearOptions;b.shaderPass=c.defaultLayerDepth.shaderPass;b.onPostCull=c.defaultLayerDepth.onPostCull;b.onDrawCall=c.defaultLayerDepth.onDrawCall;break;case 4:b.passThrough=c.defaultLayerUi.passThrough;break;case 3:b.passThrough=c.defaultLayerImmediate.passThrough}});this.renderer=new Qf(this.graphicsDevice);this.renderer.scene=this.scene;this.lightmapper=
new wh(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets);this.once("prerender",this._firstBake,this);this.batcher=new Aa(this.graphicsDevice,this.root,this.scene);this.once("prerender",this._firstBatch,this);this.keyboard=b.keyboard||null;this.mouse=b.mouse||null;this.touch=b.touch||null;this.gamepads=b.gamepads||null;if(this.elementInput=b.elementInput||null)this.elementInput.app=this;this.vr=null;this.xr=new Ia(this);this.elementInput&&this.elementInput.attachSelectEvents();this._inTools=
!1;this._skyboxLast=0;this._scriptPrefix=b.scriptPrefix||"";this.enableBundles&&this.loader.addHandler("bundle",new Oh(this.assets));this.loader.addHandler("animation",new Ih);this.loader.addHandler("animclip",new Jh);this.loader.addHandler("animstategraph",new Lh);this.loader.addHandler("model",new $h(this.graphicsDevice,this.scene.defaultMaterial));this.loader.addHandler("material",new Zh(this));this.loader.addHandler("texture",new fg(this.graphicsDevice,this.assets,this.loader));this.loader.addHandler("text",
new ii);this.loader.addHandler("json",new Yh);this.loader.addHandler("audio",new Ue(this._soundManager));this.loader.addHandler("script",new hb(this));this.loader.addHandler("scene",new bi(this));this.loader.addHandler("cubemap",new Sh(this.graphicsDevice,this.assets,this.loader));this.loader.addHandler("html",new Xh);this.loader.addHandler("css",new Rh);this.loader.addHandler("shader",new di);this.loader.addHandler("hierarchy",new Wh(this));this.loader.addHandler("scenesettings",new ci(this));this.loader.addHandler("folder",
new Th);this.loader.addHandler("font",new Vh(this.loader));this.loader.addHandler("binary",new Mh);this.loader.addHandler("textureatlas",new ji(this.loader));this.loader.addHandler("sprite",new ei(this.assets,this.graphicsDevice));this.loader.addHandler("template",new hi(this));this.loader.addHandler("container",new Qh(this.graphicsDevice,this.scene.defaultMaterial));this.systems=new si;this.systems.add(new td(this));this.systems.add(new ke(this));this.systems.add(new Wd(this));this.systems.add(new Xd(this));
this.systems.add(new ee(this));this.systems.add(new le(this));this.systems.add(new de(this));ib.legacy?this.systems.add(new me(this)):this.systems.add(new ie(this));this.systems.add(new Zd(this,this._soundManager));this.systems.add(new Tc(this,this._soundManager));this.systems.add(new Yd(this,this._soundManager));this.systems.add(new fe(this));this.systems.add(new he(this));this.systems.add(new be(this));this.systems.add(new $d(this));this.systems.add(new ne(this));this.systems.add(new je(this));
this.systems.add(new zd(this));this.systems.add(new ce(this));this.systems.add(new oe(this));this.systems.add(new pe(this));this._visibilityChangeHandler=this.onVisibilityChange.bind(this);"undefined"!==typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==
document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)));this.meshInstanceArray=[];this.tick=Gn(this)}function da(){this.name="Untitled";this.id=Hn++;this._shader=null;this.variants={};this.parameters={};this.alphaTest=0;this.blend=this.alphaToCoverage=!1;this.blendSrc=1;this.blendEquation=
this.blendDst=0;this.separateAlphaBlend=!1;this.blendSrcAlpha=1;this.blendAlphaEquation=this.blendDstAlpha=0;this.cull=1;this.depthWrite=this.depthTest=!0;this.stencilBack=this.stencilFront=null;this.slopeDepthBias=this.depthBias=0;this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=!0;this.meshInstances=[];this._shaderVersion=0;this._scene=null;this._dirtyBlend=!1;this.dirty=!0}function Ib(){this._mapXForms=null}function ea(){da.call(this);this._assetReferences={};this._validator=null;this.shaderOptBuilder=
new Ib;this.reset()}function xb(a){this._device=a;this._cache={};this._generators={};this._precached=this._isClearingCache=!1;this._programsCollection=[];this._defaultStdMatOption={};this._defaultStdMatOptionMin={};var b=new ea;b.shaderOptBuilder.updateRef(this._defaultStdMatOption,a,{},b,null,[],0,null,null);b.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,a,{},b,null,[],3,null,null)}function Ci(){this.revision=this.globalId=0}function Hk(){Ik++;this.version=new Ci;this.version.globalId=
Ik}function ng(a){this.name=a;this.value=null;this.versionObject=new Hk}function og(a){this.name=a;this.variables={};this.namespaces={}}function Di(a,b,c,d){this.locationId=d;this.scopeId=a.scope.resolve(b);this.version=new Ci;2===c&&"[0]"===b.substr(b.length-3)&&(c=17);this.dataType=c;this.value=[null,null,null,null];this.array=[]}function Jk(a,b){var c=!0,d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,
a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,2,2,0,a.RGBA,b,null);b=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,b);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0);a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE&&(c=!1);a.bindTexture(a.TEXTURE_2D,null);a.deleteTexture(d);a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteFramebuffer(b);
return c}function pg(a,b,c){var d=b._colorBuffer;if(7==d.format){var e=new Uint8Array(d.width*d.height*4),g=a.gl;a.setFramebuffer(b._glFrameBuffer);g.readPixels(0,0,d.width,d.height,g.RGBA,g.UNSIGNED_BYTE,e);d._levels||(d._levels=[]);d._levels[0]||(d._levels[0]=[]);d._levels[0][c]=e}}function qg(a,b){return Math.atan2(a*b,Math.sqrt(a*a+b*b+1))}function Kk(a,b){var c=a.width;if(7!=a.format)console.error("ERROR: SH: cubemap must be RGBA8");else{if(a._levels[0]){if(!a._levels[0][0].length)if(a._levels[0][0]instanceof
HTMLImageElement){var d=Y.getApplication().graphicsDevice;var e=d.gl;var g=K;var k=g.createShaderFromCode(d,g.fullscreenQuadVS,g.fullscreenQuadPS,"fsQuadSimple"),l=d.scope.resolve("source");for(g=0;6>g;g++){var h=a._levels[0][g],f=new L(d,{cubemap:!1,type:"default",format:a.format,width:c,height:c,mipmaps:!1});f.name="prefiltered-cube";f._levels[0]=h;f.upload();h=new L(d,{cubemap:!1,type:"default",format:a.format,width:c,height:c,mipmaps:!1});h.name="prefiltered-cube";h=new oa(d,h,{depth:!1});l.setValue(f);
La(d,h,k);var n=new Uint8Array(c*c*4);e.bindFramebuffer(e.FRAMEBUFFER,h._glFrameBuffer);e.readPixels(0,0,f.width,f.height,e.RGBA,e.UNSIGNED_BYTE,n);a._levels[0][g]=n}}else{console.error("ERROR: SH: cubemap must be composed of arrays or images");return}k=[];for(e=0;e<c;e++)for(d=0;d<c;d++)k[e*c+d]=(new r(d/(c-1)*2-1,e/(c-1)*2-1,1)).normalize();l=new Float32Array(27);for(g=h=0;6>g;g++)for(e=0;e<c;e++)for(d=0;d<c;d++){f=e*c+d;n=d;var m=e;var q=c;var u=(2*(n+.5)/q-1)*(1-1/q);var t=(2*(m+.5)/q-1)*(1-1/
q);var y=1/q;var w=u-y;var v=t-y;u+=y;t+=y;w=qg(w,v)-qg(w,t)-qg(u,v)+qg(u,t);if(0===n&&0===m||n===q-1&&0===m||0===n&&m===q-1||n===q-1&&m===q-1)w/=3;else if(0===n||0===m||n===q-1||m===q-1)w*=.5;n=w;m=4*n/17;q=8*n/17;w=15*n/17;v=5*n/68;t=15*n/68;y=k[f];if(0==g){var x=y.z;var z=-y.y;var A=-y.x}else 1==g?(x=-y.z,z=-y.y,A=y.x):2==g?(x=y.x,z=y.z,A=y.y):3==g?(x=y.x,z=-y.z,A=-y.y):4==g?(x=y.x,z=-y.y,A=y.z):5==g&&(x=-y.x,z=-y.y,A=-y.z);b||(x=-x);u=a._levels[0][g][4*f+3]/255;for(y=0;3>y;y++){var F=a._levels[0][g][4*
f+y]/255;"rgbm"===a.type?(F*=8*u,F*=F):F=Math.pow(F,2.2);l[0+y]+=F*m;l[3+y]+=F*q*x;l[6+y]+=F*q*z;l[9+y]+=F*q*A;l[12+y]+=F*w*x*A;l[15+y]+=F*w*A*z;l[18+y]+=F*w*z*x;l[21+y]+=F*v*(3*A*A-1);l[24+y]+=F*t*(x*x-z*z);h+=n}}for(y=0;y<l.length;y++)l[y]*=4*Math.PI/h;return l}console.error("ERROR: SH: cubemap must be synced to CPU")}}function Ei(a){this.device=a;this.depthMap=this.shader=null;this.vertexBuffer=Lk(a);this.needsDepthBuffer=!1}function Lk(a){var b=new Ka(a,[{semantic:"POSITION",components:2,type:6}]);
a=new Za(a,b,4);b=new Db(a);b.element.POSITION.set(-1,-1);b.next();b.element.POSITION.set(1,-1);b.next();b.element.POSITION.set(-1,1);b.next();b.element.POSITION.set(1,1);b.end();return a}function Mk(a,b,c,d,e){var g=a.getRenderTarget();a.setRenderTarget(b);a.updateBegin();var k=null!==b?b.width:a.width,l=null!==b?b.height:a.height,h=0,f=0;e&&(h=e.x*k,f=e.y*l,k*=e.z,l*=e.w);e=a.vx;b=a.vy;var n=a.vw,m=a.vh;a.setViewport(h,f,k,l);var q=a.sx,u=a.sy,t=a.sw,y=a.sh;a.setScissor(h,f,k,l);k=a.getBlending();
l=a.getDepthTest();h=a.getDepthWrite();f=a.getCullMode();var w=a.writeRed,v=a.writeGreen,r=a.writeBlue,z=a.writeAlpha;a.setBlending(!1);a.setDepthTest(!1);a.setDepthWrite(!1);a.setCullMode(0);a.setColorWrite(!0,!0,!0,!0);a.setVertexBuffer(c,0);a.setShader(d);a.draw(In);a.setBlending(k);a.setDepthTest(l);a.setDepthWrite(h);a.setCullMode(f);a.setColorWrite(w,v,r,z);a.updateEnd();a.setRenderTarget(g);a.updateBegin();a.setViewport(e,b,n,m);a.setScissor(q,u,t,y)}function cf(a,b){b=b||3;this.device=a.device;
var c=this.device.gl;this._inputBuffer=a;3===b&&a.usage!==b&&(c.bindBuffer(c.ARRAY_BUFFER,a.bufferId),c.bufferData(c.ARRAY_BUFFER,a.storage,c.DYNAMIC_COPY));this._outputBuffer=new Za(a.device,a.format,a.numVertices,b,a.storage)}function Ad(){da.call(this)}function Uc(a,b,c){a instanceof kb&&(a=Y.getApplication());this.app=a;var d=this.device=a.graphicsDevice;this.library=d.getProgramLibrary();this.pickColor=new Float32Array(4);this.pickColor[3]=1;this.scene=null;this.drawCalls=[];this.layerComp=this.layer=
null;this.clearOptions={color:[1,1,1,1],depth:1,flags:3};var e=this;this._clearDepthOptions={depth:1,flags:2};this.clearDepthCommand=new Nf(0,0,function(){d.clear(e._clearDepthOptions)});this.resize(b,c);this._ignoreOpacityFor=null}function Jn(){var a={astc:10,dxt:2,etc2:0,etc1:0,pvr:8,atc:11,none:14},b={astc:10,dxt:3,etc2:1,etc1:16,pvr:9,atc:12,none:16},c={0:21,1:23,2:8,3:10,8:26,9:27,10:28,11:29,12:30,13:7,14:3,16:5},d="undefined"!==typeof performance,e=function(e,g,k,h,l){var f=d?performance.now():
0,p=new e.BasisFile(new Uint8Array(h));e=p.getImageWidth(0,0);h=p.getImageHeight(0,0);var m=p.getNumImages(),n=p.getNumLevels(0),q=!!p.getHasAlpha();if(!(e&&h&&m&&n))throw p.close(),p.delete(),Error("Invalid image dimensions url="+g+" width="+e+" height="+h+" images="+m+" levels="+n);k=q?b[k]:a[k];if(8===k||9===k)if(0!==(e&e-1)||e!==h)k=8===k?14:13;l&&l.unswizzleGGGR&&(k=13);if(!p.startTranscoding())throw p.close(),p.delete(),Error("Failed to start transcoding url="+g);q=[];for(var u=0;u<n;++u){var r=
p.getImageTranscodedSizeInBytes(0,u,k),F=new Uint8Array(r);if(!p.transcodeImage(F,0,u,k,1,0))throw p.close(),p.delete(),Error("Failed to transcode image url="+g);if(14===k||16===k){var Q=new Uint16Array(r/2);for(m=0;m<r/2;++m)Q[m]=F[2*m]+256*F[2*m+1];F=Q}q.push(F)}p.close();p.delete();if(l&&l.unswizzleGGGR)for(k=14,m=0;m<q.length;++m){l=m;p=q[m];for(n=0;n<p.length;n+=4)r=p[n+3],u=p[n+1],p[n+0]=r,r=2/255*r-1,u=2/255*u-1,p[n+2]=Math.max(0,Math.min(255,Math.floor(127.5*(Math.sqrt(1-Math.min(1,r*r+u*
u))+1)))),p[n+3]=255;n=new Uint16Array(p.length/4);for(u=0;u<p.length;u+=4)n[u/4]=(p[u+0]&248)<<8|(p[u+1]&252)<<3|p[u+2]>>3;q[l]=n}return{format:c[k],width:e+3&-4,height:h+3&-4,levels:q,cubemap:!1,mipmaps:!0,transcodeTime:d?performance.now()-f:0,url:g}},g=null,k=[],l=function(a,b,c,d){try{var k=e(g,a,b,c,d);k.levels=k.levels.map(function(a){return a.buffer});self.postMessage({url:a,data:k},k.levels)}catch(t){self.postMessage({url:a.toString(),err:t.toString()})}},h=function(a){var b=function(b,c){WebAssembly.instantiate(a,
b).then(function(a){c(a)});return{}};self.BASIS(a?{instantiateWasm:b}:null).then(function(a){g=a;g.initializeBasis();for(a=0;a<k.length;++a)l(k[a].url,k[a].format,k[a].data,k[a].options);k=[]})};self.onmessage=function(a){a=a.data;switch(a.type){case "init":h(a.module);break;case "transcode":g?l(a.url,a.format,a.data,a.options):k.push(a)}}}function Nk(){if(!Fi){var a=Y.getApplication().graphicsDevice;Fi=a.extCompressedTextureASTC?"astc":a.extCompressedTextureS3TC?"dxt":a.extCompressedTextureETC?"etc2":
a.extCompressedTextureETC1?"etc1":a.extCompressedTexturePVRTC?"pvr":a.extCompressedTextureATC?"atc":"none"}return Fi}function Kn(a){var b=a.data.url,c=a.data.err;a=a.data.data;var d=df[b];if(d){var e;if(c)for(e=0;e<d.length;++e)d[e](c);else{a.levels=3===a.format||5===a.format?a.levels.map(function(a){return new Uint16Array(a)}):a.levels.map(function(a){return new Uint8Array(a)});for(e=0;e<d.length;++e)d[e](null,a);delete df[b]}}else console.error("internal logical error encountered in basis transcoder")}
function Ok(a,b,c,d){df.hasOwnProperty(a)?df[a].push(c):(df[a]=[c],ef.postMessage({type:"transcode",url:a,format:Nk(),data:b,options:d},[b]))}function Gi(a,b,c){a=["/* basis.js */",a,"/* mappings */\nvar PIXELFORMAT_ETC1 = 21;\nvar PIXELFORMAT_ETC2_RGBA = 23;\nvar PIXELFORMAT_DXT1 = 8;\nvar PIXELFORMAT_DXT5 = 10;\nvar PIXELFORMAT_PVRTC_4BPP_RGB_1 = 26;\nvar PIXELFORMAT_PVRTC_4BPP_RGBA_1 = 27;\nvar PIXELFORMAT_ASTC_4x4 = 28;\nvar PIXELFORMAT_ATC_RGB = 29;\nvar PIXELFORMAT_ATC_RGBA = 30;\nvar PIXELFORMAT_R8_G8_B8_A8 = 7;\nvar PIXELFORMAT_R5_G6_B5 = 3;\nvar PIXELFORMAT_R4_G4_B4_A4 = 5;\n\n/* worker */",
"("+Jn.toString()+")()\n\n"].join("\n");a=new Blob([a],{type:"application/javascript"});a=URL.createObjectURL(a);ef=new Worker(a);ef.addEventListener("message",Kn);ef.postMessage({type:"init",module:b});c&&c();for(b=0;b<Hi.length;++b)c=Hi[b],Ok(c.url,c.data,c.callback,c.options)}function Pk(a,b,c,d){Ii&&console.warn("basis module is being downloaded more than once");Ii=!0;if(Ln){var e=null,g=null,k=function(){e&&g&&Gi(e,g,d)},l=function(){qa.get(b,{cache:!0,responseType:"arraybuffer",retry:!1},function(a,
b){b&&WebAssembly.compile(b).then(function(a){g=a;k()})})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(b)).then(function(a){g=a;k()}).catch(function(a){console.error(a);console.warn("compileStreaming() failed for "+b+", falling back to arraybuffer download...");l()}):l();qa.get(a,{cache:!0,responseType:"text",retry:!1},function(a,b){e=b;k()})}else qa.get(c,{cache:!0,responseType:"text",retry:!1},function(a,b){b&&Gi(b,null,d)})}function Qk(a){var b=((window.config?window.config.wasmModules:
window.PRELOAD_MODULES)||[]).find(function(a){return"BASIS"===a.moduleName});if(b){var c=window.ASSET_PREFIX?window.ASSET_PREFIX:"";Pk(c+b.glueUrl,c+b.wasmUrl,c+b.fallbackUrl,a)}}function Rk(){}function Ji(a,b){b?(this.key=b.keyCode,this.element=b.target,this.event=b):this.event=this.element=this.key=null}function Ki(a){rg.key=a.keyCode;rg.element=a.target;rg.event=a;return rg}function sg(a){return"string"===typeof a?a.toUpperCase().charCodeAt(0):a}function ab(a,b){H.call(this);b=b||{};this._element=
null;this._keyDownHandler=this._handleKeyDown.bind(this);this._keyUpHandler=this._handleKeyUp.bind(this);this._keyPressHandler=this._handleKeyPress.bind(this);this._keymap={};this._lastmap={};a&&this.attach(a);this.preventDefault=b.preventDefault||!1;this.stopPropagation=b.stopPropagation||!1}function Vc(a,b){var c={x:0,y:0};if(b){if(b instanceof Vc)throw Error("Expected MouseEvent");c=a._getTargetCoords(b)}else b={};if(c)this.x=c.x,this.y=c.y;else if(yb.isPointerLocked())this.y=this.x=0;else return;
this.wheelDelta=0;"wheel"===b.type&&(0<b.deltaY?this.wheelDelta=1:0>b.deltaY&&(this.wheelDelta=-1));yb.isPointerLocked()?(this.dx=b.movementX||b.webkitMovementX||b.mozMovementX||0,this.dy=b.movementY||b.webkitMovementY||b.mozMovementY||0):(this.dx=this.x-a._lastX,this.dy=this.y-a._lastY);this.button="mousedown"===b.type||"mouseup"===b.type?b.button:-1;this.buttons=a._buttons.slice(0);this.element=b.target;this.ctrlKey=b.ctrlKey||!1;this.altKey=b.altKey||!1;this.shiftKey=b.shiftKey||!1;this.metaKey=
b.metaKey||!1;this.event=b}function yb(a){H.call(this);this._lastY=this._lastX=0;this._buttons=[!1,!1,!1];this._lastbuttons=[!1,!1,!1];this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=this._handleWheel.bind(this);this._contextMenuHandler=function(a){a.preventDefault()};this._target=null;this._attached=!1;this.attach(a)}function bb(a,b){b=b||{};this._keyboard=b.keyboard||null;this._mouse=b.mouse||
null;this._gamepads=b.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};a&&this.attach(a)}function Mn(a,b,c){qe.sub2(b,a);tg.sub2(c[0],a);Li.sub2(c[1],a);Sk.sub2(c[2],a);ug.cross(Sk,qe);if(0<=tg.dot(ug)){if(0>-Li.dot(ug))return!1;a=tg;if(0>Tk.cross(qe,Li).dot(a))return!1}else{Mi.sub2(c[3],a);if(0>Mi.dot(ug))return!1;a=Mi;if(0>Tk.cross(qe,tg).dot(a))return!1}return 1E-8>qe.sub2(c[0],c[2]).lengthSq()||1E-8>qe.sub2(c[1],c[3]).lengthSq()?!1:!0}function Wc(a,b,c){this.event=
a;this.element=b;this.camera=c;this._stopPropagation=!1}function Xc(a,b,c,d,e,g,k){Wc.call(this,a,b,c);this.x=d;this.y=e;this.ctrlKey=a.ctrlKey||!1;this.altKey=a.altKey||!1;this.shiftKey=a.shiftKey||!1;this.metaKey=a.metaKey||!1;this.button=a.button;yb.isPointerLocked()?(this.dx=a.movementX||a.webkitMovementX||a.mozMovementX||0,this.dy=a.movementY||a.webkitMovementY||a.mozMovementY||0):(this.dx=d-g,this.dy=e-k);this.wheelDelta=0;"wheel"===a.type&&(0<a.deltaY?this.wheelDelta=1:0>a.deltaY&&(this.wheelDelta=
-1))}function xc(a,b,c,d,e,g){Wc.call(this,a,b,c);this.touches=a.touches;this.changedTouches=a.changedTouches;this.x=d;this.y=e;this.touch=g}function Yb(a,b,c,d){Wc.call(this,a,b,c);this.inputSource=d}function ff(a,b){this._app=null;this._attached=!1;this._target=null;this._enabled=!0;this._lastY=this._lastX=0;this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=this._handleWheel.bind(this);this._touchstartHandler=
this._handleTouchStart.bind(this);this._touchcancelHandler=this._touchendHandler=this._handleTouchEnd.bind(this);this._touchmoveHandler=this._handleTouchMove.bind(this);this._sortHandler=this._sortElements.bind(this);this._elements=[];this._pressedElement=this._hoveredElement=null;this._touchedElements={};this._touchesForWhichTouchLeaveHasFired={};this._selectedElements={};this._selectedPressedElements={};this._useMouse=!b||!1!==b.useMouse;this._useTouch=!b||!1!==b.useTouch;this._useXr=!b||!1!==b.useXr;
this._selectEventsAttached=!1;va.touch&&(this._clickedEntities={});this.attach(a)}function Ni(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=.25}function vg(a){var b=Oi(a);this.id=a.identifier;this.x=b.x;this.y=b.y;this.target=a.target;this.touch=a}function Bd(a,b){this.element=b.target;this.event=b;this.touches=[];this.changedTouches=[];if(b){var c=b.touches.length;for(a=0;a<c;a++)this.touches.push(new vg(b.touches[a]));
c=b.changedTouches.length;for(a=0;a<c;a++)this.changedTouches.push(new vg(b.changedTouches[a]))}}function re(a){H.call(this);this._element=null;this._startHandler=this._handleTouchStart.bind(this);this._endHandler=this._handleTouchEnd.bind(this);this._moveHandler=this._handleTouchMove.bind(this);this._cancelHandler=this._handleTouchCancel.bind(this);this.attach(a)}function Oi(a){for(var b=0,c=0,d=a.target;!(d instanceof HTMLElement);)d=d.parentNode;do b+=d.offsetLeft-d.scrollLeft,c+=d.offsetTop-d.scrollTop,
d=d.offsetParent;while(d);return{x:a.pageX-b,y:a.pageY-c}}function lb(a,b){H.call(this);this.type="bitmap";this.app=a;this.intensity=0;b=b||{};this.fontWeight=b.fontWeight||"normal";this.glyphSize=this.fontSize=parseInt(b.fontSize,10);this.fontName=b.fontName||"Arial";this.color=b.color||new J(1,1,1);this.padding=b.padding||0;a=4096<b.width?4096:b.width||512;var c=4096<b.height?4096:b.height||512;b=document.createElement("canvas");b.height=c;b.width=a;a=new L(this.app.graphicsDevice,{format:7,autoMipmap:!0});
a.name="font";a.setSource(b);a.minFilter=5;a.magFilter=1;a.addressU=1;a.addressV=1;this.textures=[a];this.chars="";this.data={}}function Uk(){}function wg(a,b,c){b=new L(b,{format:c,width:b.width,height:b.height});b.name="posteffect-pass";b.minFilter=0;b.magFilter=0;b.addressU=1;b.addressV=1;Ea[a]._colorBuffer=b}function Vk(a){a=a.match(Nn)||[];for(var b,c,d=[],e=0;e<a.length;e++)b=a[e].search(On),c=a[e].search(Pn),b=a[e].substr(b,c-b),"uColorBuffer"!==b&&d.push(b);return d}function Wk(a,b){this.app=
a;this.srcRenderTarget=b.srcRenderTarget;this.hdr=b.hdr;this.blending=b.blending;this.shader=b.shader;this.setup=b.setup;var c=this,d=a.graphicsDevice;this.layer=new fa({opaqueSortMode:0,transparentSortMode:0,passThrough:!0,name:b.name,onPostRender:function(){c.srcRenderTarget?(qb.x=c.srcRenderTarget.width,qb.y=c.srcRenderTarget.height,qb.z=1/c.srcRenderTarget.width,qb.w=1/c.srcRenderTarget.height):(qb.x=d.width,qb.y=d.height,qb.z=1/d.width,qb.w=1/d.height);gf[0]=qb.x;gf[1]=qb.y;gf[2]=qb.z;gf[3]=
qb.w;Xk.setValue(gf);if(this._postEffectCombined&&0>this._postEffectCombined)c.setup&&c.setup(d,c,qb,null,this.renderTarget);else{var b=this._postEffectCombinedSrc?this._postEffectCombinedSrc:c.srcRenderTarget?c.srcRenderTarget:Ea[this._backbufferRtId];1<b._samples&&b.resolve(!0,!1);var e=b._colorBuffer;e.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?1:0;Pi.setValue(e);c.setup&&c.setup(d,c,qb,b,this.renderTarget);(b=this._postEffectCombinedShader?
this._postEffectCombinedShader:this.shader)&&La(d,this.renderTarget,b,null,null,c.blending);if(!c.srcRenderTarget)for(b=a.scene.layers.layerList,e=0;e<b.length&&b[e]!==c.layer;e++)if(b[e].renderTarget===Ea[0]||b[e].renderTarget===Ea[1])b[e].renderTarget=null}}});this.layer._generateCameraHash();this.layer.isPostEffect=!0;this.layer.unmodifiedUvs=b.unmodifiedUvs;this.layer.postEffectBilinear=b.bilinear;this.layer.postEffect=this;this.layer.shader=b.shader;this.layer.renderTarget=b.destRenderTarget;
if(!Pi){Pi=d.scope.resolve("uColorBuffer");Xk=d.scope.resolve("uScreenSize");b=d.supportsMsaa?4:1;for(var e=0;2>e;e++)Ea[e]=new oa({depth:!0,stencil:d.supportsStencil,samples:b,autoResolve:!1}),Ea[e].name="backbuffer"+e;a.on("prerender",function(){var b=a.scene.layers.layerList,c,e=0,h=0;Qi=Ri=hf=!1;var f=7;if(a.scene.layers._dirty){var n=0;for(c=0;c<b.length;c++){var m=!1;var q;if((q=b[c].isPostEffect)&&!(q=0===n)&&(q=b[c].unmodifiedUvs&&b[c].shader)){a:{var u,t,y;var w=b;var v=Zb;var r=n,z=Vk(b[c].shader.definition.fshader);
if(0!==z.length)for(y=0;y<r;y++)for(t=0;t<z.length;t++){q=z[t];var A=Vk(w[v[y]].shader.definition.fshader);for(u=0;u<A.length;u++)if(A[u]===q){q=!0;break a}}q=!1}q=!q}q?(Zb[n]=c,n++,c===b.length-1&&(m=!0)):0<n&&(m=!0);if(m){if(1<n){q="post_";for(m=0;m<n;m++)A=b[Zb[m]],q+=A.name?A.name:A.id,m<n-1&&(q+="_");A=d.programLib._cache[q];if(!A){u="vec4 shaderOutput;\n";t="void main() {\n";y=[];for(m=0;m<n;m++){A=b[Zb[m]].shader.definition.fshader+"\n";A=A.replace(Qn,"//").replace(Rn,"//").replace(Sn,"//").replace(Tn,
"shaderOutput");0<m&&(A=A.replace(Un,"//").replace(Vn,"//").replace(Wn,"shaderOutput;//"));A=A.replace(Xn,"void main"+m);var F;z=A;v=y;var Q=z.length;var D=0,E=F=0;r="";for(w=0;w<Q;w++){var B=z.charAt(w);"{"===B?(0===F&&(D=w),F++):"}"===B&&(1===F&&(B=w,r+=z.substr(E,D-E+1),E=B),F--)}r+=z.substr(E,z.length-E+1);D=null;E=r.match(Yn)||[];for(w=0;w<E.length;w++)for(z=E[w].split(","),Q=0;Q<z.length;Q++)F=z[Q].replace(Zn,"").trim(),0<=v.indexOf(F)?(D||(D=[]),D.push(F)):v.push(F);r=r.match($n)||[];for(w=
0;w<r.length;w++)for(z=r[w].split(","),Q=0;Q<z.length;Q++)F=z[Q].replace(ao,"").trim(),F=v.indexOf(F),0<=F&&v.splice(F,1);if(w=D)for(v=0;v<w.length;v++)A=A.replace(new RegExp("\\b"+w[v]+"\\b","g"),w[v]+"NNNN"+m);u+=A;t+="main"+m+"();\n"}t+="gl_FragColor = shaderOutput;\n}\n";A=K.createShaderFromCode(d,K.fullscreenQuadVS,u+t,q)}for(m=0;m<n;m++)b[Zb[m]]._postEffectCombined=m===n-1?1:-1;b[Zb[n-1]]._postEffectCombinedShader=A;b[Zb[n-1]]._postEffectCombinedBilinear=b[Zb[0]].postEffectBilinear;b[Zb[n-1]]._postEffectCombinedSrc=
b[Zb[0]].postEffect.srcRenderTarget}Zb[0]=c;n=1}}}for(c=0;c<b.length;c++){if(b[c].isPostEffect&&(!b[c].postEffect.srcRenderTarget&&!b[c]._postEffectCombined||!b[c].postEffect._postEffectCombinedSrc&&0<=b[c]._postEffectCombined)){for(m=c-1;m>=e;m--)b[m].renderTarget||(b[m].renderTarget=Ea[h]);b[c]._backbufferRtId=h;e=c;hf=!0;1===h&&(Ri=!0);b[c].postEffect.hdr&&(f=d.webgl2&&d.textureFloatRenderable?18:d.extTextureHalfFloatLinear&&d.textureHalfFloatRenderable?12:7);b[c].postEffect.shader&&!b[c].renderTarget&&
(h=1-h)}else b[c].isPostEffect||b[c].renderTarget||!hf||(b[c].renderTarget=Ea[h]);b[c].isPostEffect&&!b[c].renderTarget&&(Qi=!0)}if(hf)if(!Ea[0].colorBuffer)wg(0,d,f);else if(Ea[0].width!==d.width||Ea[0].height!==d.height||Ea[0]._colorBuffer._format!==f)Ea[0].colorBuffer.destroy(),Ea[0].destroy(),wg(0,d,f);if(Ri)if(!Ea[1].colorBuffer)wg(1,d,f);else if(Ea[1].width!==d.width||Ea[1].height!==d.height||Ea[1]._colorBuffer._format!==f)Ea[1].colorBuffer.destroy(),Ea[1].destroy(),wg(1,d,f)},this);a.on("postrender",
function(){var b=a.graphicsDevice;if(hf&&!Qi){for(var c=a.scene.layers.layerList,d,e=c.length-1;0<=e&&(d=c[e].renderTarget,d!==Ea[0]&&d!==Ea[1]);e--);d&&(1<d._samples&&d.resolve(!0,!1),b.copyRenderTarget(d,null,!0,!1))}},this)}}function Si(a){this.name="UnsupportedBrowserError";this.message=a||""}function Ti(a){this.name="ContextCreationError";this.message=a||""}Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(a,b){if(null==this)throw TypeError('"this" is null or not defined');
var c=Object(this),d=c.length>>>0;if("function"!==typeof a)throw TypeError("predicate must be a function");for(var e=0;e<d;){var g=c[e];if(a.call(b,g,e,c))return g;e++}},configurable:!0,writable:!0});Math.log2=Math.log2||function(a){return Math.log(a)*Math.LOG2E};Math.sign||(Math.sign=function(a){return(0<a)-(0>a)||+a});"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(a,b){if(null==a)throw new TypeError("Cannot convert undefined or null to object");for(var c=
Object(a),d=1;d<arguments.length;d++){var e=arguments[d];if(null!=e)for(var g in e)Object.prototype.hasOwnProperty.call(e,g)&&(c[g]=e[g])}return c},writable:!0,configurable:!0});(function(){if("undefined"!==typeof navigator&&"undefined"!==typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var a=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockchange",!0,!1,null);document.dispatchEvent(a)},b=function(){var a=document.createEvent("CustomEvent");
a.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitpointerlockchange",a,!1);document.addEventListener("webkitpointerlocklost",a,!1);document.addEventListener("mozpointerlockchange",a,!1);document.addEventListener("mozpointerlocklost",a,!1);document.addEventListener("webkitpointerlockerror",b,!1);document.addEventListener("mozpointerlockerror",b,!1);Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:
Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this;navigator.pointer.lock(this,a,b)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=
null,navigator.pointer.unlock())})}})();(function(){if("undefined"!==typeof window){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a));c=window.setTimeout(function(){b(d+
e)},e);a=d+e;return c});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}})();String.prototype.endsWith||(String.prototype.endsWith=function(a,b){if(void 0===b||b>this.length)b=this.length;return this.substring(b-a.length,b)===a});String.prototype.includes||(String.prototype.includes=function(a,b){"number"!==typeof b&&(b=0);return b+a.length>this.length?!1:-1!==this.indexOf(a,b)});String.prototype.startsWith||(String.prototype.startsWith=function(a,b){return this.substr(!b||
0>b?0:+b,a.length)===a});var ym=function(){for(var a={},b="Array Object Function Date RegExp Float32Array".split(" "),c=0;c<b.length;c++)a["[object "+b[c]+"]"]=b[c].toLowerCase();return a}(),bo=function(){var a=null,b=null,c=null,d=null;return{display:function(e){a||(a=document.createElement("table"),b=document.createElement("tr"),c=document.createElement("td"),d=document.createElement("td"),a.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",a.style.top="0px",
a.style.left="0px",a.style.border="thin solid #cccccc",document.body.appendChild(a));a.innerHTML="";for(var g in e){var k=b.cloneNode(),l=c.cloneNode(),h=d.cloneNode();l.textContent=g;h.textContent=e[g];k.appendChild(l);k.appendChild(h);a.appendChild(k)}}}}();Object.assign(H.prototype,{_addCallback:function(a,b,c,d){a&&"string"===typeof a&&b&&(this._callbacks[a]||(this._callbacks[a]=[]),this._callbackActive[a]&&this._callbackActive[a]===this._callbacks[a]&&(this._callbackActive[a]=this._callbackActive[a].slice()),
this._callbacks[a].push({callback:b,scope:c||this,once:d||!1}))},on:function(a,b,c){this._addCallback(a,b,c,!1);return this},off:function(a,b,c){if(a)this._callbackActive[a]&&this._callbackActive[a]===this._callbacks[a]&&(this._callbackActive[a]=this._callbackActive[a].slice());else for(var d in this._callbackActive)this._callbacks[d]&&this._callbacks[d]===this._callbackActive[d]&&(this._callbackActive[d]=this._callbackActive[d].slice());if(a)if(b){a=this._callbacks[a];if(!a)return this;d=a.length;
for(var e=0;e<d;e++)a[e].callback===b&&(c&&a[e].scope!==c||(a[e--]=a[--d]));a.length=d}else this._callbacks[a]&&(this._callbacks[a]=[]);else this._callbacks={};return this},fire:function(a,b,c,d,e,g,k,l,h){if(!a||!this._callbacks[a])return this;if(this._callbackActive[a]){this._callbackActive[a]===this._callbacks[a]&&(this._callbackActive[a]=this._callbackActive[a].slice());var f=this._callbacks[a].slice()}else this._callbackActive[a]=this._callbacks[a];for(var n=0;(f||this._callbackActive[a])&&n<
(f||this._callbackActive[a]).length;n++){var m=(f||this._callbackActive[a])[n];m.callback.call(m.scope,b,c,d,e,g,k,l,h);m.once&&(m=this._callbacks[a].indexOf(m),-1!==m&&(this._callbackActive[a]===this._callbacks[a]&&(this._callbackActive[a]=this._callbackActive[a].slice()),this._callbacks[a].splice(m,1)))}f||(this._callbackActive[a]=null);return this},once:function(a,b,c){this._addCallback(a,b,c,!0);return this},hasEvent:function(a){return this._callbacks[a]&&0!==this._callbacks[a].length||!1}});
var jf={attach:function(a){var b=jf;a._addCallback=b._addCallback;a.on=b.on;a.off=b.off;a.fire=b.fire;a.once=b.once;a.hasEvent=b.hasEvent;a._callbacks={};a._callbackActive={};return a},_addCallback:H.prototype._addCallback,on:H.prototype.on,off:H.prototype.off,fire:H.prototype.fire,once:H.prototype.once,hasEvent:H.prototype.hasEvent},Yk={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})}},V={delimiter:"/",
join:function(){var a,b=arguments.length,c=arguments[0];for(a=0;a<b-1;++a){var d=arguments[a],e=arguments[a+1];if(!kh(d)||!kh(e))throw Error("undefined argument to pc.path.join");c=e[0]===V.delimiter?e:d&&e&&d[d.length-1]!==V.delimiter&&e[0]!==V.delimiter?c+(V.delimiter+e):c+e}return c},normalize:function(a){var b=a.startsWith(V.delimiter),c=a.endsWith(V.delimiter);a=a.split("/");for(var d=[],e=0;e<a.length;e++)""!==a[e]&&"."!==a[e]&&(".."===a[e]&&0<d.length?d=d.slice(0,d.length-2):(0<e&&d.push(V.delimiter),
d.push(a[e])));a=d.join("");b||a[0]!==V.delimiter||(a=a.slice(1));c&&a[a.length-1]!==V.delimiter&&(a+=V.delimiter);return a},split:function(a){a=a.split(V.delimiter);var b=a.slice(a.length-1)[0];return[a.slice(0,a.length-1).join(V.delimiter),b]},getBasename:function(a){return V.split(a)[1]},getDirectory:function(a){a=a.split(V.delimiter);return a.slice(0,a.length-1).join(V.delimiter)},getExtension:function(a){var b=a.split("?")[0].split(".").pop();return b!==a?"."+b:""},isRelativePath:function(a){return"/"!==
a.charAt(0)&&null===a.match(/:\/\//)},extractPath:function(a){var b="",c=a.split("/");if(1<c.length)if(V.isRelativePath(a))if("."===c[0])for(a=0;a<c.length-1;++a)b+=0===a?c[a]:"/"+c[a];else if(".."===c[0])for(a=0;a<c.length-1;++a)b+=0===a?c[a]:"/"+c[a];else for(b=".",a=0;a<c.length-1;++a)b+="/"+c[a];else for(a=0;a<c.length-1;++a)b+=0===a?c[a]:"/"+c[a];return b}},va={desktop:!1,mobile:!1,ios:!1,android:!1,windows:!1,xbox:!1,gamepads:!1,touch:!1,workers:!1,passiveEvents:!1};if("undefined"!==typeof navigator){var kf=
navigator.userAgent;/(windows|mac os|linux|cros)/i.test(kf)&&(va.desktop=!0);/xbox/i.test(kf)&&(va.xbox=!0);/(windows phone|iemobile|wpdesktop)/i.test(kf)?(va.desktop=!1,va.mobile=!0,va.windows=!0):/android/i.test(kf)?(va.desktop=!1,va.mobile=!0,va.android=!0):/ip([ao]d|hone)/i.test(kf)&&(va.desktop=!1,va.mobile=!0,va.ios=!0);"undefined"!==typeof window&&(va.touch="ontouchstart"in window||"maxTouchPoints"in navigator&&0<navigator.maxTouchPoints);va.gamepads="getGamepads"in navigator;va.workers="undefined"!==
typeof Worker;try{var Zk=Object.defineProperty({},"passive",{get:function(){va.passiveEvents=!0;return!1}});window.addEventListener("testpassive",null,Zk);window.removeEventListener("testpassive",null,Zk)}catch(a){}}var dc={ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(a){for(var b=1;b<arguments.length;b++)a=a.replace("{"+(b-1)+"}",arguments[b]);return a},toBool:function(a,
b){if("true"===a)return!0;if(b){if("false"===a)return!1;throw new TypeError("Not a boolean string");}return!1},getCodePoint:function(a,b){return(a=lh(a,b))&&a.code},getCodePoints:function(a){if("string"!==typeof a)throw new TypeError("Not a string");for(var b=0,c=[],d;d=lh(a,b);)c.push(d.code),b+=d.long?2:1;return c},getSymbols:function(a){if("string"!==typeof a)throw new TypeError("Not a string");for(var b=0,c=a.length,d=[],e=0,g;b<c;){g=e;var k=a,l=b+e;l===k.length-1?e=1:Fc(k[l],55296,56319)?(e=
k.substring(l,l+2),k=k.substring(l+2,l+4),e=Fc(k,127995,127999)||Fc(e,127462,127487)&&Fc(k,127462,127487)?4:Fc(k,65024,65039)?3:2):e=Fc(k[l+1],65024,65039)?2:1;e=g+e;g=a[b+e];Fc(g,8400,8447)&&(g=a[b+e++]);Fc(g,65024,65039)&&(g=a[b+e++]);g&&8205===g.charCodeAt(0)?e++:(g=a.substring(b,b+e),d.push(g),b+=e,e=0)}return d},fromCodePoint:function(){for(var a=[],b,c,d=0;d<arguments.length;++d)b=Number(arguments[d]),c=b-65536,b=65535<b?[(c>>10)+55296,c%1024+56320]:[b],a.push(String.fromCharCode.apply(null,
b));return a.join("")}},O={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(a,b,c){return a>=c?c:a<=b?b:a},intToBytes24:function(a){return[a>>16&255,a>>8&255,a&255]},intToBytes32:function(a){return[a>>24&255,a>>16&255,a>>8&255,a&255]},bytesToInt24:function(a,b,c){a.length&&(c=a[2],b=a[1],a=a[0]);return a<<16|b<<8|c},bytesToInt32:function(a,b,c,d){a.length&&(d=a[3],c=a[2],b=a[1],a=a[0]);return(a<<24|b<<16|c<<8|d)>>>32},lerp:function(a,b,c){return a+(b-a)*O.clamp(c,0,1)},lerpAngle:function(a,
b,c){180<b-a&&(b-=360);-180>b-a&&(b+=360);return pc.math.lerp(a,b,O.clamp(c,0,1))},powerOfTwo:function(a){return 0!==a&&!(a&a-1)},nextPowerOfTwo:function(a){a--;a|=a>>1;a|=a>>2;a|=a>>4;a|=a>>8;a|=a>>16;a++;return a},random:function(a,b){return Math.random()*(b-a)+a},smoothstep:function(a,b,c){if(c<=a)return 0;if(c>=b)return 1;c=(c-a)/(b-a);return c*c*(3-2*c)},smootherstep:function(a,b,c){if(c<=a)return 0;if(c>=b)return 1;c=(c-a)/(b-a);return c*c*c*(c*(6*c-15)+10)},roundUp:function(a,b){return 0===
b?a:Math.ceil(a/b)*b}};Object.assign(J.prototype,{clone:function(){return new J(this.r,this.g,this.b,this.a)},copy:function(a){this.r=a.r;this.g=a.g;this.b=a.b;this.a=a.a;return this},set:function(a,b,c,d){this.r=a;this.g=b;this.b=c;this.a=void 0===d?1:d;return this},lerp:function(a,b,c){this.r=a.r+c*(b.r-a.r);this.g=a.g+c*(b.g-a.g);this.b=a.b+c*(b.b-a.b);this.a=a.a+c*(b.a-a.a);return this},fromString:function(a){var b=parseInt(a.replace("#","0x"),16);7<a.length?a=O.intToBytes32(b):(a=O.intToBytes24(b),
a[3]=255);this.set(a[0]/255,a[1]/255,a[2]/255,a[3]/255);return this},toString:function(a){var b="#"+(16777216+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);!0===a&&(a=Math.round(255*this.a).toString(16),b=this.a<16/255?b+("0"+a):b+a);return b}});Object.assign(mh.prototype,{push:function(a,b){if(this._index[a])throw Error("Key already in index "+a);b=this._list.push(b)-1;this._index[a]=b},has:function(a){return void 0!==this._index[a]},get:function(a){a=
this._index[a];return void 0!==a?this._list[a]:null},remove:function(a){var b=this._index[a];if(void 0!==b){this._list.splice(b,1);delete this._index[a];for(a in this._index){var c=this._index[a];c>b&&(this._index[a]=c-1)}return!0}return!1},list:function(){return this._list},clear:function(){this._list.length=0;for(var a in this._index)delete this._index[a]}});Object.assign(Dj.prototype,{addItem:function(a){for(var b=a.tags._list,c=0;c<b.length;c++)this.add(b[c],a)},removeItem:function(a){for(var b=
a.tags._list,c=0;c<b.length;c++)this.remove(b[c],a)},add:function(a,b){this._index[a]&&-1!==this._index[a].list.indexOf(b)||(this._index[a]||(this._index[a]={list:[]},this._key&&(this._index[a].keys={})),this._index[a].list.push(b),this._key&&(this._index[a].keys[b[this._key]]=b))},remove:function(a,b){if(this._index[a]&&(!this._key||this._index[a].keys[b[this._key]])){var c=this._index[a].indexOf(b);-1!==c&&(this._index[a].list.splice(c,1),this._key&&delete this._index[a].keys[b[this._key]],0===
this._index[a].list.length&&delete this._index[a])}},find:function(a){var b=this,c={},d=[],e,g,k=function(a,c){return b._index[a].list.length-b._index[c].list.length};for(e=0;e<a.length;e++){var l=a[e];if(l instanceof Array){if(0===l.length)continue;if(1===l.length)l=l[0];else{var h=!1;for(g=0;g<l.length;g++)if(!this._index[l[g]]){h=!0;break}if(h)continue;l=l.slice(0).sort(k);var f=l.slice(1);1===f.length&&(f=f[0]);for(g=0;g<this._index[l[0]].list.length;g++)h=this._index[l[0]].list[g],(this._key?
!c[h[this._key]]:-1===d.indexOf(h))&&h.tags.has(f)&&(this._key&&(c[h[this._key]]=!0),d.push(h));continue}}if(l&&"string"===typeof l&&this._index[l])for(g=0;g<this._index[l].list.length;g++)h=this._index[l].list[g],this._key?c[h[this._key]]||(c[h[this._key]]=!0,d.push(h)):-1===d.indexOf(h)&&d.push(h)}return d}});Gc.prototype=Object.create(H.prototype);Gc.prototype.constructor=Gc;Object.assign(Gc.prototype,{add:function(){var a=!1,b=this._processArguments(arguments,!0);if(!b.length)return a;for(var c=
0;c<b.length;c++)this._index[b[c]]||(a=!0,this._index[b[c]]=!0,this._list.push(b[c]),this.fire("add",b[c],this._parent));a&&this.fire("change",this._parent);return a},remove:function(){var a=!1;if(!this._list.length)return a;var b=this._processArguments(arguments,!0);if(!b.length)return a;for(var c=0;c<b.length;c++)this._index[b[c]]&&(a=!0,delete this._index[b[c]],this._list.splice(this._list.indexOf(b[c]),1),this.fire("remove",b[c],this._parent));a&&this.fire("change",this._parent);return a},clear:function(){if(this._list.length){var a=
this._list.slice(0);this._list=[];this._index={};for(var b=0;b<a.length;b++)this.fire("remove",a[b],this._parent);this.fire("change",this._parent)}},has:function(){return this._list.length?this._has(this._processArguments(arguments)):!1},_has:function(a){if(!this._list.length||!a.length)return!1;for(var b=0;b<a.length;b++)if(1===a[b].length){if(this._index[a[b][0]])return!0}else{for(var c=!0,d=0;d<a[b].length;d++)if(!this._index[a[b][d]]){c=!1;break}if(c)return!0}return!1},list:function(){return this._list.slice(0)},
_processArguments:function(a,b){var c=[],d=[];if(!a||!a.length)return c;for(var e=0;e<a.length;e++)if(a[e]instanceof Array){b||(d=[]);for(var g=0;g<a[e].length;g++)"string"===typeof a[e][g]&&(b?c.push(a[e][g]):d.push(a[e][g]));!b&&d.length&&c.push(d)}else"string"===typeof a[e]&&(b?c.push(a[e]):c.push([a[e]]));return c}});Object.defineProperty(Gc.prototype,"size",{get:function(){return this._list.length}});var zb="undefined"!==typeof window&&window.performance&&window.performance.now&&window.performance.timing?
function(){return window.performance.now()}:Date.now;Object.assign(nh.prototype,{start:function(){this._isRunning=!0;this._a=zb()},stop:function(){this._isRunning=!1;this._b=zb()},getMilliseconds:function(){return this._b-this._a}});N.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",
BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"};N.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"};N.binaryExtensions=".model .wav .ogg .mp3 .mp4 .m4a .aac .dds .basis .glb".split(" ");N.retryDelay=100;Object.assign(N.prototype,{ContentType:N.ContentType,ResponseType:N.ResponseType,binaryExtensions:N.binaryExtensions,get:function(a,b,c){"function"===typeof b&&(c=b,b={});return this.request("GET",a,b,c)},post:function(a,b,
c,d){"function"===typeof c&&(d=c,c={});c.postdata=b;return this.request("POST",a,c,d)},put:function(a,b,c,d){"function"===typeof c&&(d=c,c={});c.postdata=b;return this.request("PUT",a,c,d)},del:function(a,b,c){"function"===typeof b&&(c=b,b={});return this.request("DELETE",a,b,c)},request:function(a,b,c,d){var e=!1;"function"===typeof c&&(d=c,c={});c.retry&&(c=Object.assign({retries:0,maxRetries:5},c));c.callback=d;null==c.async&&(c.async=!0);null==c.headers&&(c.headers={});if(null!=c.postdata)if(c.postdata instanceof
Document)var g=c.postdata;else if(c.postdata instanceof FormData)g=c.postdata;else if(c.postdata instanceof Object)switch(g=c.headers["Content-Type"],void 0===g&&(c.headers["Content-Type"]=N.ContentType.FORM_URLENCODED,g=c.headers["Content-Type"]),g){case N.ContentType.FORM_URLENCODED:g="";d=!0;for(k in c.postdata)c.postdata.hasOwnProperty(k)&&(d?d=!1:g+="&",g+=escape(k)+"="+escape(c.postdata[k]));break;default:case N.ContentType.JSON:null==g&&(c.headers["Content-Type"]=N.ContentType.JSON),g=JSON.stringify(c.postdata)}else g=
c.postdata;if(!1===c.cache){d=zb();var k=new Kf(b);k.query=k.query?k.query+"&ts="+d:"ts="+d;b=k.toString()}c.query&&(k=new Kf(b),d=Ec(k.getQuery(),c.query),k.setQuery(d),b=k.toString());var l=new XMLHttpRequest;l.open(a,b,c.async);l.withCredentials=void 0!==c.withCredentials?c.withCredentials:!1;l.responseType=c.responseType||this._guessResponseType(b);for(var h in c.headers)c.headers.hasOwnProperty(h)&&l.setRequestHeader(h,c.headers[h]);l.onreadystatechange=function(){this._onReadyStateChange(a,
b,c,l)}.bind(this);l.onerror=function(){this._onError(a,b,c,l);e=!0}.bind(this);try{l.send(g)}catch(p){e||c.error(l.status,l,p)}return l},_guessResponseType:function(a){a=new Kf(a);a=V.getExtension(a.path);return 0<=N.binaryExtensions.indexOf(a)?N.ResponseType.ARRAY_BUFFER:".xml"===a?N.ResponseType.DOCUMENT:N.ResponseType.TEXT},_isBinaryContentType:function(a){return 0<=[N.ContentType.MP4,N.ContentType.WAV,N.ContentType.OGG,N.ContentType.MP3,N.ContentType.BIN,N.ContentType.DDS,N.ContentType.BASIS,
N.ContentType.GLB].indexOf(a)?!0:!1},_onReadyStateChange:function(a,b,c,d){if(4===d.readyState)switch(d.status){case 0:"/"!=b[0]?this._onSuccess(a,b,c,d):this._onError(a,b,c,d);break;case 200:case 201:case 206:case 304:this._onSuccess(a,b,c,d);break;default:this._onError(a,b,c,d)}},_onSuccess:function(a,b,c,d){if(a=d.getResponseHeader("Content-Type")){var e=a.split(";");e=e[0].trim()}try{if(e===this.ContentType.JSON||b.split("?")[0].endsWith(".json"))var g=JSON.parse(d.responseText);else this._isBinaryContentType(e)?
g=d.response:(e&&console.warn("responseType: "+d.responseType+" being served with Content-Type: "+e),g=d.responseType===N.ResponseType.ARRAY_BUFFER?d.response:d.responseType===N.ResponseType.BLOB||d.responseType===N.ResponseType.JSON?d.response:d.responseType===N.ResponseType.DOCUMENT||e===this.ContentType.XML?d.responseXML:d.responseText);c.callback(null,g)}catch(k){c.callback(k)}},_onError:function(a,b,c,d){if(!c.retrying)if(c.retry&&c.retries<c.maxRetries){c.retries++;c.retrying=!0;var e=O.clamp(Math.pow(2,
c.retries)*N.retryDelay,0,c.maxRetryDelay||5E3);console.log(a+": "+b+" - Error "+d.status+". Retrying in "+e+" ms");setTimeout(function(){c.retrying=!1;this.request(a,b,c,c.callback)}.bind(this),e)}else c.callback(0===d.status?"Network error":d.status,null)}});var qa=new N;Object.assign(oh.prototype,{evaluate:function(a,b){(b||a<this._left||a>=this._right)&&this._reset(a);b=this._curve.type;5===b?a=this._p0:(a=0===this._recip?0:(a-this._left)*this._recip,a=0===b?pc.math.lerp(this._p0,this._p1,a):
1===b?pc.math.lerp(this._p0,this._p1,a*a*(3-2*a)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,a));return a},_reset:function(a){var b=this._curve.keys,c=b.length;if(c)if(a<b[0][0])this._left=-Infinity,this._right=b[0][0],this._recip=0,this._p0=this._p1=b[0][1],this._m0=this._m1=0;else if(a>=b[c-1][0])this._left=b[c-1][0],this._right=Infinity,this._recip=0,this._p0=this._p1=b[c-1][1],this._m0=this._m1=0;else{for(c=0;a>=b[c+1][0];)c++;this._left=b[c][0];this._right=b[c+1][0];a=1/(this._right-
this._left);this._recip=isFinite(a)?a:0;this._p0=b[c][1];this._p1=b[c+1][1];this._isHermite()&&this._calcTangents(b,c)}else this._left=-Infinity,this._right=Infinity,this._p0=this._p1=this._m0=this._m1=this._recip=0},_isHermite:function(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type},_calcTangents:function(a,b){var c=a[b],d=a[b+1];var e=0===b?[a[0][0]+(a[0][0]-a[1][0]),a[0][1]+(a[0][1]-a[1][1])]:a[b-1];a=b==a.length-2?[a[b+1][0]+(a[b+1][0]-a[b][0]),a[b+1][1]+(a[b+1][1]-
a[b][1])]:a[b+2];if(4===this._curve.type){b=2*(d[0]-c[0])/(d[0]-e[0]);var g=2*(d[0]-c[0])/(a[0]-c[0]);this._m0=this._curve.tension*(isFinite(b)?b:0)*(d[1]-e[1]);this._m1=this._curve.tension*(isFinite(g)?g:0)*(a[1]-c[1])}else g=(d[0]-c[0])/(c[0]-e[0]),b=(d[0]-c[0])/(a[0]-d[0]),e=c[1]+(e[1]-c[1])*(isFinite(g)?g:0),a=d[1]+(a[1]-d[1])*(isFinite(b)?b:0),b=2===this._curve.type?.5:this._curve.tension,this._m0=b*(d[1]-e),this._m1=b*(a-c[1])},_evaluateHermite:function(a,b,c,d,e){var g=e*e,k=e+e,l=1-e;l*=l;
return a*(1+k)*l+c*e*l+b*g*(3-k)+d*g*(e-1)}});Object.assign(Ya.prototype,{add:function(a,b){for(var c=this.keys,d=c.length,e=0;e<d&&!(c[e][0]>a);e++);a=[a,b];this.keys.splice(e,0,a);return a},get:function(a){return this.keys[a]},sort:function(){this.keys.sort(function(a,b){return a[0]-b[0]})},value:function(a){return this._eval.evaluate(a,!0)},closest:function(a){for(var b=this.keys,c=b.length,d=2,e=null,g=0;g<c;g++){var k=Math.abs(a-b[g][0]);if(d>=k)d=k,e=b[g];else break}return e},clone:function(){var a=
new Ya;a.keys=pc.extend(a.keys,this.keys);a.type=this.type;a.tension=this.tension;return a},quantize:function(a){a=Math.max(a,2);var b=new Float32Array(a),c=1/(a-1);b[0]=this._eval.evaluate(0,!0);for(var d=1;d<a;d++)b[d]=this._eval.evaluate(c*d);return b},quantizeClamped:function(a,b,c){a=this.quantize(a);for(var d=0;d<a.length;++d)a[d]=Math.min(c,Math.max(b,a[d]));return a}});Object.defineProperty(Ya.prototype,"length",{get:function(){return this.keys.length}});Object.assign(rb.prototype,{get:function(a){return this.curves[a]},
value:function(a,b){var c=this.curves.length;b=b||[];b.length=c;for(var d=0;d<c;d++)b[d]=this.curves[d].value(a);return b},clone:function(){var a=new rb;a.curves=[];for(var b=0;b<this.curves.length;b++)a.curves.push(this.curves[b].clone());a._type=this._type;return a},quantize:function(a){a=Math.max(a,2);for(var b=this.curves.length,c=new Float32Array(a*b),d=1/(a-1),e=0;e<b;e++)for(var g=new oh(this.curves[e]),k=0;k<a;k++)c[k*b+e]=g.evaluate(d*k);return c},quantizeClamped:function(a,b,c){a=this.quantize(a);
for(var d=0;d<a.length;++d)a[d]=Math.min(c,Math.max(b,a[d]));return a}});Object.defineProperty(rb.prototype,"length",{get:function(){return this.curves.length}});Object.defineProperty(rb.prototype,"type",{get:function(){return this._type},set:function(a){this._type=a;for(var b=0;b<this.curves.length;b++)this.curves[b].type=a}});Object.assign(Cb.prototype,{clone:function(){return(new Cb).copy(this)},copy:function(a){a=a.data;var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];
b[6]=a[6];b[7]=a[7];b[8]=a[8];return this},set:function(a){var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this},equals:function(a){var b=this.data;a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&1===a[4]&&0===a[5]&&0===a[6]&&0===a[7]&&1===a[8]},setIdentity:function(){var a=
this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return this},toString:function(){for(var a="[",b=0;9>b;b++)a+=this.data[b],a+=8!==b?", ":"";return a+"]"},transpose:function(){var a=this.data;var b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this}});Object.defineProperties(Cb,{ZERO:{value:(new Cb).set([0,0,0,0,0,0,0,0,0])},IDENTITY:{value:new Cb}});Object.assign(r.prototype,{add:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},add2:function(a,
b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;return this},clone:function(){return(new r).copy(this)},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},cross:function(a,b){var c=a.x,d=a.y;a=a.z;var e=b.x,g=b.y;b=b.z;this.x=d*b-g*a;this.y=a*e-b*c;this.z=c*g-e*d;return this},distance:function(a){var b=this.x-a.x,c=this.y-a.y;a=this.z-a.z;return Math.sqrt(b*b+c*c+a*a)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===
a.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},lerp:function(a,b,c){this.x=a.x+c*(b.x-a.x);this.y=a.y+c*(b.y-a.y);this.z=a.z+c*(b.z-a.z);return this},mul:function(a){this.x*=a.x;this.y*=a.y;this.z*=a.z;return this},mul2:function(a,b){this.x=a.x*b.x;this.y=a.y*b.y;this.z=a.z*b.z;return this},normalize:function(){var a=this.x*this.x+this.y*this.y+this.z*this.z;0<a&&(a=1/Math.sqrt(a),this.x*=a,
this.y*=a,this.z*=a);return this},project:function(a){var b=(this.x*a.x+this.y*a.y+this.z*a.z)/(a.x*a.x+a.y*a.y+a.z*a.z);this.x=a.x*b;this.y=a.y*b;this.z=a.z*b;return this},scale:function(a){this.x*=a;this.y*=a;this.z*=a;return this},set:function(a,b,c){this.x=a;this.y=b;this.z=c;return this},sub:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},sub2:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+"]"}});
Object.defineProperties(r,{ZERO:{value:new r(0,0,0)},ONE:{value:new r(1,1,1)},UP:{value:new r(0,1,0)},DOWN:{value:new r(0,-1,0)},RIGHT:{value:new r(1,0,0)},LEFT:{value:new r(-1,0,0)},FORWARD:{value:new r(0,0,-1)},BACK:{value:new r(0,0,1)}});Object.assign(U.prototype,{add:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;this.w+=a.w;return this},add2:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;this.w=a.w+b.w;return this},clone:function(){return(new U).copy(this)},copy:function(a){this.x=
a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z+this.w*a.w},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},lerp:function(a,b,c){this.x=a.x+c*(b.x-a.x);this.y=a.y+c*(b.y-a.y);this.z=a.z+c*(b.z-a.z);this.w=a.w+c*(b.w-a.w);return this},
mul:function(a){this.x*=a.x;this.y*=a.y;this.z*=a.z;this.w*=a.w;return this},mul2:function(a,b){this.x=a.x*b.x;this.y=a.y*b.y;this.z=a.z*b.z;this.w=a.w*b.w;return this},normalize:function(){var a=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;0<a&&(a=1/Math.sqrt(a),this.x*=a,this.y*=a,this.z*=a,this.w*=a);return this},scale:function(a){this.x*=a;this.y*=a;this.z*=a;this.w*=a;return this},set:function(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d;return this},sub:function(a){this.x-=a.x;this.y-=
a.y;this.z-=a.z;this.w-=a.w;return this},sub2:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;this.w=a.w-b.w;return this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}});Object.defineProperties(U,{ZERO:{value:new U(0,0,0,0)},ONE:{value:new U(1,1,1,1)}});Object.assign(C.prototype,{add2:function(a,b){a=a.data;b=b.data;var c=this.data;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];c[3]=a[3]+b[3];c[4]=a[4]+b[4];c[5]=a[5]+b[5];c[6]=a[6]+b[6];c[7]=a[7]+b[7];c[8]=
a[8]+b[8];c[9]=a[9]+b[9];c[10]=a[10]+b[10];c[11]=a[11]+b[11];c[12]=a[12]+b[12];c[13]=a[13]+b[13];c[14]=a[14]+b[14];c[15]=a[15]+b[15];return this},add:function(a){return this.add2(this,a)},clone:function(){return(new C).copy(this)},copy:function(a){a=a.data;var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return this},equals:function(a){var b=this.data;a=a.data;
return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]&&b[9]===a[9]&&b[10]===a[10]&&b[11]===a[11]&&b[12]===a[12]&&b[13]===a[13]&&b[14]===a[14]&&b[15]===a[15]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mul2:function(a,b){var c=a.data;var d=b.data,e=this.data;b=c[0];
a=c[1];var g=c[2];var k=c[3];var l=c[4];var h=c[5];var f=c[6];var n=c[7];var m=c[8];var q=c[9];var u=c[10];var t=c[11];var y=c[12];var r=c[13];var v=c[14];c=c[15];var x=d[0];var z=d[1];var A=d[2];var F=d[3];e[0]=b*x+l*z+m*A+y*F;e[1]=a*x+h*z+q*A+r*F;e[2]=g*x+f*z+u*A+v*F;e[3]=k*x+n*z+t*A+c*F;x=d[4];z=d[5];A=d[6];F=d[7];e[4]=b*x+l*z+m*A+y*F;e[5]=a*x+h*z+q*A+r*F;e[6]=g*x+f*z+u*A+v*F;e[7]=k*x+n*z+t*A+c*F;x=d[8];z=d[9];A=d[10];F=d[11];e[8]=b*x+l*z+m*A+y*F;e[9]=a*x+h*z+q*A+r*F;e[10]=g*x+f*z+u*A+v*F;e[11]=
k*x+n*z+t*A+c*F;x=d[12];z=d[13];A=d[14];F=d[15];e[12]=b*x+l*z+m*A+y*F;e[13]=a*x+h*z+q*A+r*F;e[14]=g*x+f*z+u*A+v*F;e[15]=k*x+n*z+t*A+c*F;return this},mul:function(a){return this.mul2(this,a)},transformPoint:function(a,b){var c=this.data;var d=a.x;var e=a.y;a=a.z;b=void 0===b?new r:b;b.x=d*c[0]+e*c[4]+a*c[8]+c[12];b.y=d*c[1]+e*c[5]+a*c[9]+c[13];b.z=d*c[2]+e*c[6]+a*c[10]+c[14];return b},transformVector:function(a,b){var c=this.data;var d=a.x;var e=a.y;a=a.z;b=void 0===b?new r:b;b.x=d*c[0]+e*c[4]+a*c[8];
b.y=d*c[1]+e*c[5]+a*c[9];b.z=d*c[2]+e*c[6]+a*c[10];return b},transformVec4:function(a,b){var c=this.data;var d=a.x;var e=a.y;var g=a.z;a=a.w;b=void 0===b?new U:b;b.x=d*c[0]+e*c[4]+g*c[8]+a*c[12];b.y=d*c[1]+e*c[5]+g*c[9]+a*c[13];b.z=d*c[2]+e*c[6]+g*c[10]+a*c[14];b.w=d*c[3]+e*c[7]+g*c[11]+a*c[15];return b},setLookAt:function(){var a=new r;var b=new r;var c=new r;return function(d,e,g){c.sub2(d,e).normalize();b.copy(g).normalize();a.cross(b,c).normalize();b.cross(c,a);e=this.data;e[0]=a.x;e[1]=a.y;e[2]=
a.z;e[3]=0;e[4]=b.x;e[5]=b.y;e[6]=b.z;e[7]=0;e[8]=c.x;e[9]=c.y;e[10]=c.z;e[11]=0;e[12]=d.x;e[13]=d.y;e[14]=d.z;e[15]=1;return this}}(),setFrustum:function(a,b,c,d,e,g){var k=2*e;var l=b-a;var h=d-c;var f=g-e;var n=this.data;n[0]=k/l;n[1]=0;n[2]=0;n[3]=0;n[4]=0;n[5]=k/h;n[6]=0;n[7]=0;n[8]=(b+a)/l;n[9]=(d+c)/h;n[10]=(-g-e)/f;n[11]=-1;n[12]=0;n[13]=0;n[14]=-k*g/f;n[15]=0;return this},setPerspective:function(a,b,c,d,e){e?(a=c*Math.tan(a*Math.PI/360),e=a/b):(e=c*Math.tan(a*Math.PI/360),a=e*b);return this.setFrustum(-a,
a,-e,e,c,d)},setOrtho:function(a,b,c,d,e,g){var k=this.data;k[0]=2/(b-a);k[1]=0;k[2]=0;k[3]=0;k[4]=0;k[5]=2/(d-c);k[6]=0;k[7]=0;k[8]=0;k[9]=0;k[10]=-2/(g-e);k[11]=0;k[12]=-(b+a)/(b-a);k[13]=-(d+c)/(d-c);k[14]=-(g+e)/(g-e);k[15]=1;return this},setFromAxisAngle:function(a,b){b*=pc.math.DEG_TO_RAD;var c=a.x;var d=a.y;a=a.z;var e=Math.cos(b);b=Math.sin(b);var g=1-e;var k=g*c;var l=g*d;var h=this.data;h[0]=k*c+e;h[1]=k*d+b*a;h[2]=k*a-b*d;h[3]=0;h[4]=k*d-b*a;h[5]=l*d+e;h[6]=l*a+b*c;h[7]=0;h[8]=k*a+b*d;
h[9]=l*a-c*b;h[10]=g*a*a+e;h[11]=0;h[12]=0;h[13]=0;h[14]=0;h[15]=1;return this},setTranslate:function(a,b,c){var d=this.data;d[0]=1;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=1;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=1;d[11]=0;d[12]=a;d[13]=b;d[14]=c;d[15]=1;return this},setScale:function(a,b,c){var d=this.data;d[0]=a;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=b;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=c;d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return this},invert:function(){var a=this.data;var b=a[0];var c=a[1];var d=a[2];var e=
a[3];var g=a[4];var k=a[5];var l=a[6];var h=a[7];var f=a[8];var n=a[9];var m=a[10];var q=a[11];var u=a[12];var t=a[13];var y=a[14];var r=a[15];var v=b*k-c*g;var x=b*l-d*g;var z=b*h-e*g;var A=c*l-d*k;var F=c*h-e*k;var Q=d*h-e*l;var D=f*t-n*u;var E=f*y-m*u;var B=f*r-q*u;var C=n*y-m*t;var H=n*r-q*t;var G=m*r-q*y;var I=v*G-x*H+z*C+A*B-F*E+Q*D;0===I?this.setIdentity():(I=1/I,a[0]=(k*G-l*H+h*C)*I,a[1]=(-c*G+d*H-e*C)*I,a[2]=(t*Q-y*F+r*A)*I,a[3]=(-n*Q+m*F-q*A)*I,a[4]=(-g*G+l*B-h*E)*I,a[5]=(b*G-d*B+e*E)*I,
a[6]=(-u*Q+y*z-r*x)*I,a[7]=(f*Q-m*z+q*x)*I,a[8]=(g*H-k*B+h*D)*I,a[9]=(-b*H+c*B-e*D)*I,a[10]=(u*F-t*z+r*v)*I,a[11]=(-f*F+n*z-q*v)*I,a[12]=(-g*C+k*E-l*D)*I,a[13]=(b*C-c*E+d*D)*I,a[14]=(-u*A+t*x-y*v)*I,a[15]=(f*A-n*x+m*v)*I);return this},set:function(a){var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return this},setIdentity:function(){var a=this.data;a[0]=1;a[1]=
0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},setTRS:function(a,b,c){var d=a.x;var e=a.y;a=a.z;var g=b.x;var k=b.y;var l=b.z;var h=b.w;b=c.x;var f=c.y;c=c.z;var n=g+g;var m=k+k;var q=l+l;var u=g*n;var t=g*m;g*=q;var y=k*m;k*=q;l*=q;n*=h;m*=h;h*=q;q=this.data;q[0]=(1-(y+l))*b;q[1]=(t+h)*b;q[2]=(g-m)*b;q[3]=0;q[4]=(t-h)*f;q[5]=(1-(u+l))*f;q[6]=(k+n)*f;q[7]=0;q[8]=(g+m)*c;q[9]=(k-n)*c;q[10]=(1-(u+y))*c;q[11]=0;q[12]=d;q[13]=e;q[14]=
a;q[15]=1;return this},transpose:function(){var a=this.data;var b=a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=a[3];a[3]=a[12];a[12]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];a[14]=b;return this},invertTo3x3:function(a){var b=this.data;a=a.data;var c=b[0],d=b[1],e=b[2],g=b[4],k=b[5],l=b[6],h=b[8],f=b[9],n=b[10];b=n*k-l*f;var m=-n*g+l*h;var q=f*g-k*h;var u=c*b+d*m+e*q;if(0===u)return this;u=1/u;a[0]=u*b;a[1]=u*(-n*d+e*f);a[2]=u*(l*d-e*k);a[3]=u*m;a[4]=u*(n*c-e*h);a[5]=
u*(-l*c+e*g);a[6]=u*q;a[7]=u*(-f*c+d*h);a[8]=u*(k*c-d*g);return this},getTranslation:function(a){a=void 0===a?new r:a;return a.set(this.data[12],this.data[13],this.data[14])},getX:function(a){a=void 0===a?new r:a;return a.set(this.data[0],this.data[1],this.data[2])},getY:function(a){a=void 0===a?new r:a;return a.set(this.data[4],this.data[5],this.data[6])},getZ:function(a){a=void 0===a?new r:a;return a.set(this.data[8],this.data[9],this.data[10])},getScale:function(){var a=new r;var b=new r;var c=
new r;return function(d){d=void 0===d?new r:d;this.getX(a);this.getY(b);this.getZ(c);d.set(a.length(),b.length(),c.length());return d}}(),setFromEulerAngles:function(a,b,c){a*=pc.math.DEG_TO_RAD;b*=pc.math.DEG_TO_RAD;c*=pc.math.DEG_TO_RAD;var d=Math.sin(-a);a=Math.cos(-a);var e=Math.sin(-b);b=Math.cos(-b);var g=Math.sin(-c);c=Math.cos(-c);var k=this.data;k[0]=b*c;k[1]=-b*g;k[2]=e;k[3]=0;k[4]=a*g+c*d*e;k[5]=a*c-d*e*g;k[6]=-b*d;k[7]=0;k[8]=d*g-a*c*e;k[9]=c*d+a*e*g;k[10]=a*b;k[11]=0;k[12]=0;k[13]=0;
k[14]=0;k[15]=1;return this},getEulerAngles:function(){var a=new r;return function(b){b=void 0===b?new r:b;this.getScale(a);var c=a.x;var d=a.y;var e=a.z;var g=this.data;var k=Math.asin(-g[2]/c);var l=.5*Math.PI;k<l?k>-l?(d=Math.atan2(g[6]/d,g[10]/e),c=Math.atan2(g[1]/c,g[0]/c)):(c=0,d=-Math.atan2(g[4]/d,g[5]/d)):(c=0,d=Math.atan2(g[4]/d,g[5]/d));return b.set(d,k,c).scale(pc.math.RAD_TO_DEG)}}(),toString:function(){var a;var b="[";for(a=0;16>a;a+=1)b+=this.data[a],b+=15!==a?", ":"";return b+"]"}});
Object.defineProperties(C,{ZERO:{value:(new C).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])},IDENTITY:{value:new C}});Object.assign(T.prototype,{clone:function(){return new T(this.x,this.y,this.z,this.w)},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},getAxisAngle:function(a){var b=2*Math.acos(this.w),c=Math.sin(b/2);if(0!==c){if(a.x=
this.x/c,a.y=this.y/c,a.z=this.z/c,0>a.x||0>a.y||0>a.z)a.x*=-1,a.y*=-1,a.z*=-1,b*=-1}else a.x=1,a.y=0,a.z=0;return b*O.RAD_TO_DEG},getEulerAngles:function(a){a=void 0===a?new r:a;var b=this.x;var c=this.y;var d=this.z;var e=this.w;var g=2*(e*c-b*d);if(-.99999>=g){var k=2*Math.atan2(b,e);g=-Math.PI/2;b=0}else.99999<=g?(k=2*Math.atan2(b,e),g=Math.PI/2,b=0):(k=Math.atan2(2*(e*b+c*d),1-2*(b*b+c*c)),g=Math.asin(g),b=Math.atan2(2*(e*d+b*c),1-2*(c*c+d*d)));return a.set(k,g,b).scale(O.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},
length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},mul:function(a){var b=this.x;var c=this.y;var d=this.z;var e=this.w;var g=a.x;var k=a.y;var l=a.z;a=a.w;this.x=e*g+b*a+c*l-d*k;this.y=e*k+c*a+d*g-b*l;this.z=e*l+d*a+b*k-c*g;this.w=e*a-b*g-c*k-d*l;return this},mul2:function(a,b){var c=a.x;var d=a.y;var e=a.z;a=a.w;var g=b.x;var k=b.y;var l=b.z;b=b.w;this.x=a*g+c*b+d*l-e*k;this.y=
a*k+d*b+e*g-c*l;this.z=a*l+e*b+c*k-d*g;this.w=a*b-c*g-d*k-e*l;return this},normalize:function(){var a=this.length();0===a?(this.x=this.y=this.z=0,this.w=1):(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a);return this},set:function(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d;return this},setFromAxisAngle:function(a,b){b*=.5*O.DEG_TO_RAD;var c=Math.sin(b);b=Math.cos(b);this.x=c*a.x;this.y=c*a.y;this.z=c*a.z;this.w=b;return this},setFromEulerAngles:function(a,b,c){var d=.5*O.DEG_TO_RAD;a*=d;b*=d;c*=
d;d=Math.sin(a);a=Math.cos(a);var e=Math.sin(b);b=Math.cos(b);var g=Math.sin(c);c=Math.cos(c);this.x=d*b*c-a*e*g;this.y=a*e*c+d*b*g;this.z=a*b*g-d*e*c;this.w=a*b*c+d*e*g;return this},setFromMat4:function(a){a=a.data;var b=a[0];var c=a[1];var d=a[2];var e=a[4];var g=a[5];var k=a[6];var l=a[8];var h=a[9];a=a[10];var f=b*b+c*c+d*d;if(0===f)return this;f=1/Math.sqrt(f);var n=e*e+g*g+k*k;if(0===n)return this;n=1/Math.sqrt(n);var m=l*l+h*h+a*a;if(0===m)return this;m=1/Math.sqrt(m);b*=f;c*=f;d*=f;e*=n;g*=
n;k*=n;l*=m;h*=m;a*=m;f=b+g+a;0<=f?(b=Math.sqrt(f+1),this.w=.5*b,b=.5/b,this.x=(k-h)*b,this.y=(l-d)*b,this.z=(c-e)*b):b>g?b>a?(b=Math.sqrt(b-(g+a)+1),this.x=.5*b,b=.5/b,this.w=(k-h)*b,this.y=(c+e)*b,this.z=(d+l)*b):(b=Math.sqrt(a-(b+g)+1),this.z=.5*b,b=.5/b,this.w=(c-e)*b,this.x=(l+d)*b,this.y=(h+k)*b):g>a?(b=Math.sqrt(g-(a+b)+1),this.y=.5*b,b=.5/b,this.w=(l-d)*b,this.z=(k+h)*b,this.x=(e+c)*b):(b=Math.sqrt(a-(b+g)+1),this.z=.5*b,b=.5/b,this.w=(c-e)*b,this.x=(l+d)*b,this.y=(h+k)*b);return this},slerp:function(a,
b,c){var d=a.x;var e=a.y;var g=a.z;a=a.w;var k=b.x;var l=b.y;var h=b.z;b=b.w;var f=a*b+d*k+e*l+g*h;0>f&&(b=-b,k=-k,l=-l,h=-h,f=-f);if(1<=Math.abs(f))return this.w=a,this.x=d,this.y=e,this.z=g,this;var n=Math.acos(f),m=Math.sqrt(1-f*f);if(.001>Math.abs(m))return this.w=.5*a+.5*b,this.x=.5*d+.5*k,this.y=.5*e+.5*l,this.z=.5*g+.5*h,this;f=Math.sin((1-c)*n)/m;c=Math.sin(c*n)/m;this.w=a*f+b*c;this.x=d*f+k*c;this.y=e*f+l*c;this.z=g*f+h*c;return this},transformVector:function(a,b){void 0===b&&(b=new r);var c=
a.x,d=a.y,e=a.z;a=this.x;var g=this.y,k=this.z,l=this.w,h=l*c+g*e-k*d,f=l*d+k*c-a*e,n=l*e+a*d-g*c;c=-a*c-g*d-k*e;b.x=h*l+c*-a+f*-k-n*-g;b.y=f*l+c*-g+n*-a-h*-k;b.z=n*l+c*-k+h*-g-f*-a;return b},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}});Object.defineProperties(T,{ZERO:{value:new T(0,0,0,0)},IDENTITY:{value:new T(0,0,0,1)}});Object.assign(M.prototype,{add:function(a){this.x+=a.x;this.y+=a.y;return this},add2:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;return this},
clone:function(){return(new M).copy(this)},copy:function(a){this.x=a.x;this.y=a.y;return this},distance:function(a){var b=this.x-a.x;a=this.y-a.y;return Math.sqrt(b*b+a*a)},dot:function(a){return this.x*a.x+this.y*a.y},equals:function(a){return this.x===a.x&&this.y===a.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},lerp:function(a,b,c){this.x=a.x+c*(b.x-a.x);this.y=a.y+c*(b.y-a.y);return this},mul:function(a){this.x*=a.x;
this.y*=a.y;return this},mul2:function(a,b){this.x=a.x*b.x;this.y=a.y*b.y;return this},normalize:function(){var a=this.x*this.x+this.y*this.y;0<a&&(a=1/Math.sqrt(a),this.x*=a,this.y*=a);return this},scale:function(a){this.x*=a;this.y*=a;return this},set:function(a,b){this.x=a;this.y=b;return this},sub:function(a){this.x-=a.x;this.y-=a.y;return this},sub2:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;return this},toString:function(){return"["+this.x+", "+this.y+"]"}});Object.defineProperties(M,{ZERO:{value:new M(0,
0)},ONE:{value:new M(1,1)},UP:{value:new M(0,1)},DOWN:{value:new M(0,-1)},RIGHT:{value:new M(1,0)},LEFT:{value:new M(-1,0)}});var gc=new r,Jb=new r,lf=new r,mf=new r,Cd=new r;Object.assign(ia.prototype,{add:function(a){var b=this.center,c=b.x,d=b.y,e=b.z,g=this.halfExtents,k=g.x,l=g.y,h=g.z,f=c-k;c+=k;k=d-l;d+=l;l=e-h;e+=h;h=a.center;var n=h.x,m=h.y;h=h.z;a=a.halfExtents;var q=a.x,u=a.y,t=a.z;a=n-q;n+=q;q=m-u;m+=u;u=h-t;h+=t;a<f&&(f=a);n>c&&(c=n);q<k&&(k=q);m>d&&(d=m);u<l&&(l=u);h>e&&(e=h);b.x=.5*
(f+c);b.y=.5*(k+d);b.z=.5*(l+e);g.x=.5*(c-f);g.y=.5*(d-k);g.z=.5*(e-l)},copy:function(a){this.center.copy(a.center);this.halfExtents.copy(a.halfExtents);this.type=a.type},clone:function(){return new ia(this.center.clone(),this.halfExtents.clone())},intersects:function(a){var b=this.getMax(),c=this.getMin(),d=a.getMax();a=a.getMin();return c.x<=d.x&&b.x>=a.x&&c.y<=d.y&&b.y>=a.y&&c.z<=d.z&&b.z>=a.z},_intersectsRay:function(a,b){var c=gc.copy(this.getMin()).sub(a.origin),d=Jb.copy(this.getMax()).sub(a.origin),
e=a.direction;0===e.x?(c.x=0>c.x?-Number.MAX_VALUE:Number.MAX_VALUE,d.x=0>d.x?-Number.MAX_VALUE:Number.MAX_VALUE):(c.x/=e.x,d.x/=e.x);0===e.y?(c.y=0>c.y?-Number.MAX_VALUE:Number.MAX_VALUE,d.y=0>d.y?-Number.MAX_VALUE:Number.MAX_VALUE):(c.y/=e.y,d.y/=e.y);0===e.z?(c.z=0>c.z?-Number.MAX_VALUE:Number.MAX_VALUE,d.z=0>d.z?-Number.MAX_VALUE:Number.MAX_VALUE):(c.z/=e.z,d.z/=e.z);e=lf.set(Math.min(c.x,d.x),Math.min(c.y,d.y),Math.min(c.z,d.z));c=mf.set(Math.max(c.x,d.x),Math.max(c.y,d.y),Math.max(c.z,d.z));
d=Math.max(Math.max(e.x,e.y),e.z);(c=Math.min(Math.min(c.x,c.y),c.z)>=d&&0<=d)&&b.copy(a.direction).scale(d).add(a.origin);return c},_fastIntersectsRay:function(a){var b=a.direction;gc.sub2(a.origin,this.center);mf.set(Math.abs(gc.x),Math.abs(gc.y),Math.abs(gc.z));lf.mul2(gc,b);if(mf.x>this.halfExtents.x&&0<=lf.x||mf.y>this.halfExtents.y&&0<=lf.y||mf.z>this.halfExtents.z&&0<=lf.z)return!1;Cd.set(Math.abs(b.x),Math.abs(b.y),Math.abs(b.z));Jb.cross(b,gc);Jb.set(Math.abs(Jb.x),Math.abs(Jb.y),Math.abs(Jb.z));
return Jb.x>this.halfExtents.y*Cd.z+this.halfExtents.z*Cd.y||Jb.y>this.halfExtents.x*Cd.z+this.halfExtents.z*Cd.x||Jb.z>this.halfExtents.x*Cd.y+this.halfExtents.y*Cd.x?!1:!0},intersectsRay:function(a,b){return b?this._intersectsRay(a,b):this._fastIntersectsRay(a)},setMinMax:function(a,b){this.center.add2(b,a).scale(.5);this.halfExtents.sub2(b,a).scale(.5)},getMin:function(){return this._min.copy(this.center).sub(this.halfExtents)},getMax:function(){return this._max.copy(this.center).add(this.halfExtents)},
containsPoint:function(a){var b=this.getMin(),c=this.getMax();return a.x<b.x||a.x>c.x||a.y<b.y||a.y>c.y||a.z<b.z||a.z>c.z?!1:!0},setFromTransformedAabb:function(a,b){var c=this.center,d=this.halfExtents,e=a.center;a=a.halfExtents;b=b.data;var g=b[0],k=b[4],l=b[8],h=b[1],f=b[5],n=b[9],m=b[2],q=b[6],u=b[10],t=Math.abs(g),y=Math.abs(k),r=Math.abs(l),v=Math.abs(h),x=Math.abs(f),z=Math.abs(n),A=Math.abs(m),F=Math.abs(q),Q=Math.abs(u);c.set(b[12]+g*e.x+k*e.y+l*e.z,b[13]+h*e.x+f*e.y+n*e.z,b[14]+m*e.x+q*
e.y+u*e.z);d.set(t*a.x+y*a.y+r*a.z,v*a.x+x*a.y+z*a.z,A*a.x+F*a.y+Q*a.z)},compute:function(a,b){b=void 0===b?a.length/3:b;if(0<b){for(var c=gc.set(a[0],a[1],a[2]),d=Jb.set(a[0],a[1],a[2]),e=1;e<b;e++){var g=a[3*e],k=a[3*e+1],l=a[3*e+2];g<c.x&&(c.x=g);k<c.y&&(c.y=k);l<c.z&&(c.z=l);g>d.x&&(d.x=g);k>d.y&&(d.y=k);l>d.z&&(d.z=l)}this.setMinMax(c,d)}},intersectsBoundingSphere:function(a){return this._distanceToBoundingSphereSq(a)<=a.radius*a.radius?!0:!1},_distanceToBoundingSphereSq:function(a){for(var b=
this.getMin(),c=this.getMax(),d=0,e=["x","y","z"],g=0;3>g;++g){var k=0,l=a.center[e[g]],h=b[e[g]],f=c[e[g]];l<h&&(h-=l,k+=h*h);l>f&&(h=l-f,k+=h*h);d+=k}return d},_expand:function(a,b){gc.add2(this.getMin(),a);Jb.add2(this.getMax(),b);this.setMinMax(gc,Jb)}});var Yc=new r,xg=new r,se=new r,$k=new r;Object.assign(Pd.prototype,{containsPoint:function(a){a=Yc.sub2(a,this.center).lengthSq();var b=this.radius;return a<b*b},compute:function(a){var b,c=a.length/3;for(b=0;b<c;b++)Yc.set(a[3*b],a[3*b+1],a[3*
b+2]),se.addSelf(Yc),0===b%100&&(se.scale(1/c),xg.add(se),se.set(0,0,0));se.scale(1/c);xg.add(se);this.center.copy(xg);var d=0;for(b=0;b<c;b++)Yc.set(a[3*b],a[3*b+1],a[3*b+2]),$k.sub2(Yc,this.center),d=Math.max($k.lengthSq(),d);this.radius=Math.sqrt(d)},intersectsRay:function(a,b){var c=Yc.copy(a.origin).sub(this.center),d=c.dot(xg.copy(a.direction).normalize());c=c.dot(c)-this.radius*this.radius;if(0<c&&0<d)return null;c=d*d-c;if(0>c)return!1;d=Math.abs(-d-Math.sqrt(c));b&&b.copy(a.direction).scale(d).add(a.origin);
return!0},intersectsBoundingSphere:function(a){Yc.sub2(a.center,this.center);a=a.radius+this.radius;return Yc.lengthSq()<=a*a?!0:!1}});var al=new C;Object.assign(ph.prototype,{update:function(a,b){al.mul2(a,b);a=al.data;this.planes[0][0]=a[3]-a[0];this.planes[0][1]=a[7]-a[4];this.planes[0][2]=a[11]-a[8];this.planes[0][3]=a[15]-a[12];b=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=b;this.planes[0][1]/=b;this.planes[0][2]/=
b;this.planes[0][3]/=b;this.planes[1][0]=a[3]+a[0];this.planes[1][1]=a[7]+a[4];this.planes[1][2]=a[11]+a[8];this.planes[1][3]=a[15]+a[12];b=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]);this.planes[1][0]/=b;this.planes[1][1]/=b;this.planes[1][2]/=b;this.planes[1][3]/=b;this.planes[2][0]=a[3]+a[1];this.planes[2][1]=a[7]+a[5];this.planes[2][2]=a[11]+a[9];this.planes[2][3]=a[15]+a[13];b=Math.sqrt(this.planes[2][0]*this.planes[2][0]+
this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]);this.planes[2][0]/=b;this.planes[2][1]/=b;this.planes[2][2]/=b;this.planes[2][3]/=b;this.planes[3][0]=a[3]-a[1];this.planes[3][1]=a[7]-a[5];this.planes[3][2]=a[11]-a[9];this.planes[3][3]=a[15]-a[13];b=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]);this.planes[3][0]/=b;this.planes[3][1]/=b;this.planes[3][2]/=b;this.planes[3][3]/=b;this.planes[4][0]=a[3]-a[2];
this.planes[4][1]=a[7]-a[6];this.planes[4][2]=a[11]-a[10];this.planes[4][3]=a[15]-a[14];b=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]);this.planes[4][0]/=b;this.planes[4][1]/=b;this.planes[4][2]/=b;this.planes[4][3]/=b;this.planes[5][0]=a[3]+a[2];this.planes[5][1]=a[7]+a[6];this.planes[5][2]=a[11]+a[10];this.planes[5][3]=a[15]+a[14];b=Math.sqrt(this.planes[5][0]*this.planes[5][0]+this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*
this.planes[5][2]);this.planes[5][0]/=b;this.planes[5][1]/=b;this.planes[5][2]/=b;this.planes[5][3]/=b},containsPoint:function(a){for(var b=0;6>b;b++)if(0>=this.planes[b][0]*a.x+this.planes[b][1]*a.y+this.planes[b][2]*a.z+this.planes[b][3])return!1;return!0},containsSphere:function(a){var b=0,c=a.radius;var d=a.center;a=d.x;var e=d.y,g=d.z,k=this.planes;for(d=0;6>d;d++){var l=k[d];l=l[0]*a+l[1]*e+l[2]*g+l[3];if(l<=-c)return 0;l>c&&b++}return 6===b?2:1}});Hc.prototype.set=function(a,b){this.origin.copy(a);
this.direction.copy(b);return this};var yg=new Hc,bl=new r,Ui=new Pd,Ej=new C;Object.assign(qh.prototype,{intersectsRay:function(a,b){this._modelTransform.transformPoint(a.origin,yg.origin);this._modelTransform.transformVector(a.direction,yg.direction);return b?(a=this._aabb._intersectsRay(yg,b),Ej.copy(this._modelTransform).invert().transformPoint(b,b),a):this._aabb._fastIntersectsRay(yg)},containsPoint:function(a){this._modelTransform.transformPoint(a,bl);return this._aabb.containsPoint(bl)},intersectsBoundingSphere:function(a){this._modelTransform.transformPoint(a.center,
Ui.center);Ui.radius=a.radius;return this._aabb.intersectsBoundingSphere(Ui)?!0:!1}});Object.defineProperty(qh.prototype,"worldTransform",{get:function(){return this._worldTransform},set:function(a){this._worldTransform.copy(a);this._modelTransform.copy(a).invert()}});var co=new r;Object.assign(rh.prototype,{intersectsLine:function(a,b,c){var d=-this.normal.dot(this.point),e=this.normal.dot(a)+d;d=this.normal.dot(b)+d;e/=e-d;(d=0<=e&&1>=e)&&c&&c.lerp(a,b,e);return d},intersectsRay:function(a,b){var c=
co.sub2(this.point,a.origin);c=this.normal.dot(c)/this.normal.dot(a.direction);var d=0<=c;d&&b&&b.copy(a.direction).scale(c).add(a.origin);return d}});var Mf=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],Lf=[1,1,2,2,4,4,4],Vi={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},cl=[Uint8Array,Uint16Array,Uint32Array];Object.assign(Za.prototype,{destroy:function(){var a=this.device,b=a.buffers.indexOf(this);-1!==b&&a.buffers.splice(b,
1);if(this.bufferId){b=a.gl;b.deleteBuffer(this.bufferId);a._vram.vb-=this.storage.byteLength;this.bufferId=null;a.boundBuffer=null;a.vertexBuffers.length=0;a.vbOffsets.length=0;a.attributesInvalidated=!0;for(var c in a.enabledAttributes)b.disableVertexAttribArray(Number(c));a.enabledAttributes={}}},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl;
this.bufferId||(this.bufferId=a.createBuffer());switch(this.usage){case 0:var b=a.STATIC_DRAW;break;case 1:b=a.DYNAMIC_DRAW;break;case 2:b=a.STREAM_DRAW;break;case 3:b=this.device.webgl2?a.DYNAMIC_COPY:a.STATIC_DRAW}a.bindBuffer(a.ARRAY_BUFFER,this.bufferId);a.bufferData(a.ARRAY_BUFFER,this.storage,b)},setData:function(a){if(a.byteLength!==this.numBytes)return console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+a.byteLength),!1;this.storage=a;this.unlock();return!0}});
Ka.init=function(a){this._defaultInstancingFormat=new Ka(a,[{semantic:"TEXCOORD2",components:4,type:6},{semantic:"TEXCOORD3",components:4,type:6},{semantic:"TEXCOORD4",components:4,type:6},{semantic:"TEXCOORD5",components:4,type:6}])};Object.defineProperty(Ka,"defaultInstancingFormat",{get:function(){return function(){return this._defaultInstancingFormat}}()});Object.assign(Ka.prototype,{_evaluateBatchingHash:function(){var a=[],b,c=this.elements.length;for(b=0;b<c;b++){var d=this.elements[b];var e=
d.name;e+=d.dataType;e+=d.numComponents;e+=d.normalize;a.push(e)}a.sort();return Ne(a.join())}});Oe.prototype.get=function(a){return this.array[this.index+a]};Oe.prototype.set=function(a,b,c,d){};Oe.prototype.setFromArray=function(a,b,c){};Oe.prototype.getToArray=function(a,b,c){};Object.assign(Db.prototype,{next:function(a){void 0===a&&(a=1);for(var b=0,c=this.accessors,d=this.accessors.length;b<d;){var e=c[b++];e.index+=a*e.stride}},end:function(){this.vertexBuffer.unlock()},writeData:function(a,
b,c){if(a=this.element[a]){c>this.vertexBuffer.numVertices&&(c=this.vertexBuffer.numVertices);var d,e=a.numComponents;if(this.vertexBuffer.getFormat().interleaved){var g=0;for(d=0;d<c;d++)a.setFromArray(g,b,d*e),g+=a.stride}else if(b.length>c*e)if(c*=e,ArrayBuffer.isView(b))b=b.subarray(0,c),a.array.set(b);else for(d=0;d<c;d++)a.array[d]=b[d];else a.array.set(b)}},readData:function(a,b){a=this.element[a];var c=0;if(a){c=this.vertexBuffer.numVertices;var d,e=a.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(b)&&
(b.length=0);var g=a.index=0;for(d=0;d<c;d++)a.getToArray(g,b,d*e),g+=a.stride}else if(ArrayBuffer.isView(b))b.set(a.array);else for(b.length=0,e*=c,d=0;d<e;d++)b[d]=a.array[d]}return c}});var hd=null,Lm={type:5,base:0,count:4,indexed:!1},Wi=function(a,b,c){return"\n#ifdef MAPFLOAT\n"+a+"\n#else\n"+K[b]+"\n#endif\n"},Xi=function(a,b,c){return"\n#ifdef MAPCOLOR\n"+a+"\n#else\n"+K[b]+"\n#endif\n"},Dd=function(a,b,c){return"\n#ifdef MAPTEXTURE\n"+a+"\n#else\n"+K[b]+"\n#endif\n"},Yi=function(a,b,c){return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+
a+"\n#else\n"+K[b]+"\n#endif\n"},zg=function(a,b,c){return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+a+"\n#else\n"+K[b]+"\n#endif\n"},Ed=function(a,b,c){return"\n#ifdef MAPVERTEX\n"+a+"\n#else\n"+K[b]+"\n#endif\n"},Zi=function(a,b,c){return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+a+"\n#else\n"+K[b]+"\n#endif\n"},Ag=function(a,b,c){return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+
a+"\n#else\n"+K[b]+"\n#endif\n"},hc=[],aa={gammaCode:function(a,b){b||(b=K);return 1===a||2===a?b.gamma2_2PS?b.gamma2_2PS:K.gamma2_2PS:3===a?"#define HDR\n"+(b.gamma2_2PS?b.gamma2_2PS:K.gamma2_2PS):b.gamma1_0PS?b.gamma1_0PS:K.gamma1_0PS},tonemapCode:function(a,b){b||(b=K);return 1===a?b.tonemappingFilmicPS?b.tonemappingFilmicPS:K.tonemappingFilmicPS:0===a?b.tonemappingLinearPS?b.tonemappingLinearPS:K.tonemappingLinearPS:2===a?b.tonemappingHejlPS?b.tonemappingHejlPS:K.tonemappingHejlPS:3===a?b.tonemappingAcesPS?
b.tonemappingAcesPS:K.tonemappingAcesPS:4===a?b.tonemappingAces2PS?b.tonemappingAces2PS:K.tonemappingAces2PS:b.tonemapingNonePS?b.tonemapingNonePS:K.tonemappingNonePS},fogCode:function(a,b){b||(b=K);return"linear"===a?b.fogLinearPS?b.fogLinearPS:K.fogLinearPS:"exp"===a?b.fogExpPS?b.fogExpPS:K.fogExpPS:"exp2"===a?b.fogExp2PS?b.fogExp2PS:K.fogExp2PS:b.fogNonePS?b.fogNonePS:K.fogNonePS},skinCode:function(a,b){b||(b=K);return a.supportsBoneTextures?b.skinTexVS:"#define BONE_LIMIT "+a.getBoneLimit()+"\n"+
b.skinConstVS},precisionCode:function(a){var b="precision "+a.precision+" float;\n";a.webgl2&&(b+="#ifdef GL2\nprecision "+a.precision+" sampler2DShadow;\n#endif\n");return b},versionCode:function(a){return a.webgl2?"#version 300 es\n":""},dummyFragmentCode:function(){return"void main(void) {gl_FragColor = vec4(0.0);}"},begin:function(){return"void main(void)\n{\n"},end:function(){return"}\n"},basic:{generateKey:function(a){var b="basic";a.fog&&(b+="_fog");a.alphaTest&&(b+="_atst");a.vertexColors&&
(b+="_vcol");a.diffuseMap&&(b+="_diff");return b+="_"+a.pass},createShaderDefinition:function(a,b){var c={vertex_position:"POSITION"};b.skin&&(c.vertex_boneWeights="BLENDWEIGHT",c.vertex_boneIndices="BLENDINDICES");b.vertexColors&&(c.vertex_color="COLOR");b.diffuseMap&&(c.vertex_texCoord0="TEXCOORD0");var d=K;var e=""+d.transformDeclVS;b.skin?(e+=aa.skinCode(a),e+=d.transformSkinnedVS):e+=d.transformVS;b.vertexColors&&(e+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n");b.diffuseMap&&(e+="attribute vec2 vertex_texCoord0;\nvarying vec2 vUv0;\n");
2===b.pass&&(e+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n");e+=aa.begin();e+="   gl_Position = getPosition();\n";2===b.pass&&(e+="\tvDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n");b.vertexColors&&(e+="\tvColor = vertex_color;\n");b.diffuseMap&&(e+="\tvUv0 = vertex_texCoord0;\n");var g=e+=aa.end();e=aa.precisionCode(a);e=b.vertexColors?
e+"varying vec4 vColor;\n":e+"uniform vec4 uColor;\n";b.diffuseMap&&(e+="varying vec2 vUv0;\nuniform sampler2D texture_diffuseMap;\n");b.fog&&(e+=aa.fogCode(b.fog));b.alphatest&&(e+=d.alphaTestPS);2===b.pass&&(e=e+"varying float vDepth;\n"+d.packDepthPS);e+=aa.begin();e=b.vertexColors?e+"\tgl_FragColor = vColor;\n":e+"\tgl_FragColor = uColor;\n";b.diffuseMap&&(e+="\tgl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n");b.alphatest&&(e+="   alphaTest(gl_FragColor.a);\n");18!==b.pass&&(2===b.pass?
e+="\tgl_FragColor = packFloat(vDepth);\n":b.fog&&(e+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n"));e+=aa.end();return{attributes:c,vshader:g,fshader:e}}},particle:{generateKey:function(a){var b="particle",c;for(c in a)a.hasOwnProperty(c)&&(b+=a[c]);return b},_animTex:function(a,b){a=""+(a.animTexLoop?b.particleAnimFrameLoopVS:b.particleAnimFrameClampVS);return a+=b.particleAnimTexVS},createShaderDefinition:function(a,b){var c=K,d="",e=aa.precisionCode(a)+"\n";a.webgl2&&(d+="#define GL2\n",
e+="#define GL2\n");d+="#define VERTEXSHADER\n";b.mesh&&(d+="#define USE_MESH\n");b.localSpace&&(d+="#define LOCAL_SPACE\n");b.animTex&&(d+="\nuniform vec2 animTexTilesParams;\n");b.animTex&&(d+="\nuniform vec4 animTexParams;\n");b.animTex&&(d+="\nuniform vec2 animTexIndexParams;\n");2==b.normal&&(d+="\nvarying mat3 ParticleMat;\n");1==b.normal&&(d+="\nvarying vec3 Normal;\n");b.soft&&(d+="\nvarying float vDepth;\n");a=b.customFace?c.particle_customFaceVS:c.particle_billboardVS;b.useCpu?(0<b.soft&&
(d+=c.screenDepthPS),d+=c.particle_cpuVS,b.localSpace&&(d+=c.particle_localShiftVS),b.animTex&&(d+=this._animTex(b,c)),b.alignToMotion&&(d+=c.particle_pointAlongVS),d+=b.mesh?c.particle_meshVS:a,1==b.normal&&(d+=c.particle_normalVS),2==b.normal&&(d+=c.particle_TBNVS),0<b.stretch&&(d+=c.particle_stretchVS),d+=c.particle_cpu_endVS):(d+=c.particle_initVS,d+=b.pack8?c.particleInputRgba8PS:c.particleInputFloatPS,0<b.soft&&(d+=c.screenDepthPS),d+=c.particleVS,b.localSpace&&(d+=c.particle_localShiftVS),
b.animTex&&(d+=this._animTex(b,c)),b.wrap&&(d+=c.particle_wrapVS),b.alignToMotion&&(d+=c.particle_pointAlongVS),d+=b.mesh?c.particle_meshVS:a,1==b.normal&&(d+=c.particle_normalVS),2==b.normal&&(d+=c.particle_TBNVS),0<b.stretch&&(d+=c.particle_stretchVS),d+=c.particle_endVS);0<b.soft&&(d+=c.particle_softVS);d+="}\n";0<b.normal&&(1==b.normal?e+="\nvarying vec3 Normal;\n":2==b.normal&&(e+="\nvarying mat3 ParticleMat;\n"),e+="\nuniform vec3 lightCube[6];\n");b.soft&&(e+="\nvarying float vDepth;\n");0===
b.normal&&"none"===b.fog&&(b.srgb=!1);e+=aa.gammaCode(b.gamma);e+=aa.tonemapCode(b.toneMap);e="linear"===b.fog?e+c.fogLinearPS:"exp"===b.fog?e+c.fogExpPS:"exp2"===b.fog?e+c.fogExp2PS:e+c.fogNonePS;2==b.normal&&(e+="\nuniform sampler2D normalMap;\n");0<b.soft&&(e+=c.screenDepthPS);e+=c.particlePS;0<b.soft&&(e+=c.particle_softPS);1==b.normal&&(e+="\nvec3 normal = Normal;\n");2==b.normal&&(e+=c.particle_normalMapPS);0<b.normal&&(e+=b.halflambert?c.particle_halflambertPS:c.particle_lambertPS);0<b.normal&&
(e+=c.particle_lightingPS);2==b.blend?e+=c.particle_blendNormalPS:1==b.blend?e+=c.particle_blendAddPS:5==b.blend&&(e+=c.particle_blendMultiplyPS);e+=c.particle_endPS;return{attributes:K.collectAttribs(d),vshader:d,fshader:e}}},skybox:{generateKey:function(a){return"skybox"+a.rgbm+" "+a.hdr+" "+a.fixSeams+a.toneMapping+a.gamma+a.useIntensity+a.mip},createShaderDefinition:function(a,b){var c=K;return{attributes:{aPosition:"POSITION"},vshader:c.skyboxVS,fshader:aa.precisionCode(a)+(b.mip?c.fixCubemapSeamsStretchPS:
c.fixCubemapSeamsNonePS)+(b.useIntensity?c.envMultiplyPS:c.envConstPS)+aa.gammaCode(b.gamma)+aa.tonemapCode(b.toneMapping)+c.rgbmPS+c.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,b.rgbm?"textureCubeRGBM":b.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,16,8,4,2][b.mip]+"")}}}};aa.standard={_oldChunkToNew:{aoTexPS:{n:"aoPS",f:Dd},aoVertPS:{n:"aoPS",f:Ed},diffuseConstPS:{n:"diffusePS",f:Xi},diffuseTexPS:{n:"diffusePS",f:Dd},diffuseTexConstPS:{n:"diffusePS",f:Yi},diffuseVertPS:{n:"diffusePS",
f:Ed},diffuseVertConstPS:{n:"diffusePS",f:Zi},emissiveConstPS:{n:"emissivePS",f:Xi},emissiveTexPS:{n:"emissivePS",f:Dd},emissiveTexConstPS:{n:"emissivePS",f:Yi},emissiveTexConstFloatPS:{n:"emissivePS",f:zg},emissiveVertPS:{n:"emissivePS",f:Ed},emissiveVertConstPS:{n:"emissivePS",f:Zi},emissiveVertConstFloatPS:{n:"emissivePS",f:Ag},glossConstPS:{n:"glossPS",f:Wi},glossTexPS:{n:"glossPS",f:Dd},glossTexConstPS:{n:"glossPS",f:zg},glossVertPS:{n:"glossPS",f:Ed},glossVertConstPS:{n:"glossPS",f:Ag},metalnessConstPS:{n:"metalnessPS",
f:Wi},metalnessTexPS:{n:"metalnessPS",f:Dd},metalnessTexConstPS:{n:"metalnessPS",f:zg},metalnessVertPS:{n:"metalnessPS",f:Ed},metalnessVertConstPS:{n:"metalnessPS",f:Ag},opacityConstPS:{n:"opacityPS",f:Wi},opacityTexPS:{n:"opacityPS",f:Dd},opacityTexConstPS:{n:"opacityPS",f:zg},opacityVertPS:{n:"opacityPS",f:Ed},opacityVertConstPS:{n:"opacityPS",f:Ag},specularConstPS:{n:"specularPS",f:Xi},specularTexPS:{n:"specularPS",f:Dd},specularTexConstPS:{n:"specularPS",f:Yi},specularVertPS:{n:"specularPS",f:Ed},
specularVertConstPS:{n:"specularPS",f:Zi},transformBatchSkinnedVS:{n:"transformVS",f:function(a,b,c){return"\n#ifdef DYNAMICBATCH\n"+a+"\n#else\n"+K[b]+"\n#endif\n"}},transformInstancedVS:{n:"transformVS",f:function(a,b,c){return"\n#ifdef INSTANCING\n"+a+"\n#else\n"+K[b]+"\n#endif\n"}},transformPixelSnapVS:{n:"transformVS",f:function(a,b,c){return"\n#ifdef PIXELSNAP\n"+a+"\n#else\n"+K[b]+"\n#endif\n"}},transformScreenSpaceVS:{n:"transformVS",f:function(a,b,c){return"\n#ifdef SCREENSPACE\n"+a+"\n#else\n"+
K[b]+"\n#endif\n"}},transformScreenSpaceBatchSkinned:{n:"transformVS",f:function(a,b,c){return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+a+"\n#else\n"+K[b]+"\n#endif\n"}},transformSkinned:{n:"transformVS",f:function(a,b,c){return"\n#ifdef SKIN\n"+a+"\n#else\n"+K[b]+"\n#endif\n"}},transformUv1:{n:"transformVS",f:function(a,b,c){return"\n#ifdef UV1LAYOUT\n"+a+"\n#else\n"+K[b]+"\n#endif\n"}}},optionsContext:{},optionsContextMin:{},
generateKey:function(a){var b=function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&"chunks"!==c&&"lights"!==c&&b.push(c);return b.sort()};if(a===this.optionsContextMin){this.propsMin||(this.propsMin=b(a));var c=this.propsMin}else a===this.optionsContext?(this.props||(this.props=b(a)),c=this.props):c=b(a);b="standard";var d;for(d=0;d<c.length;d++)a[c[d]]&&(b+=c[d]+a[c[d]]);if(a.chunks){c=[];for(var e in a.chunks)a.chunks.hasOwnProperty(e)&&c.push(e+a.chunks[e]);c.sort();b+=c}if(a.lights)for(d=0;d<
a.lights.length;d++)b+=a.lights[d].key;return Ne(b)},_correctChannel:function(a,b){if(0<hc[a]){if(hc[a]<b.length)return b.substring(0,hc[a]);if(hc[a]>b.length){var c=b.charAt(b.length-1);a=hc[a]-b.length;for(var d=0;d<a;d++)b+=c;return b}return b}},_setMapTransform:function(a,b,c,d){a[0]+="uniform vec4 texture_"+b+"MapTransform;\n";var e=c+100*d;a[3][e]||(a[1]+="varying vec2 vUV"+d+"_"+c+";\n",a[2]+="   vUV"+d+"_"+c+" = uv"+d+" * texture_"+b+"MapTransform.xy + texture_"+b+"MapTransform.zw;\n",a[3][e]=
!0);return a},_getUvSourceExpression:function(a,b,c){var d=c[a];b=c[b];var e=0===c.pass||1===c.pass;e&&1===c.nineSlicedMode?d="nineSlicedUv":e&&2===c.nineSlicedMode?d="nineSlicedUv, -1000.0":(d=0===d?"vUv"+b:"vUV"+b+"_"+d,c.heightMap&&"heightMapTransform"!==a&&(d+=" + dUvOffset"));return d},_addMapDef:function(a,b){var c="\n#undef "+a+"\n";b&&(c+=" #define "+a+"\n");return c},_addMapDefs:function(a,b,c,d){a=""+this._addMapDef("MAPFLOAT",a);a+=this._addMapDef("MAPCOLOR",b);a+=this._addMapDef("MAPVERTEX",
c);return a+=this._addMapDef("MAPTEXTURE",d)},_addMap:function(a,b,c,d,e){var g=a+"Map",k=g+"Uv",l=g+"Transform",h=g+"Channel",f=a+"VertexColorChannel",n=c[a+"Tint"],m=c[a+"VertexColor"];g=c[g];a=c[a+"Mode"];b=d[b];g&&(k=this._getUvSourceExpression(l,k,c),b=b.replace(/\$UV/g,k).replace(/\$CH/g,c[h]),void 0!==e&&(b=b.replace(/\$texture2DSAMPLE/g,0===e?"texture2DSRGB":1===e?"texture2DRGBM":"texture2D")));m&&(b=b.replace(/\$VC/g,c[f]));a&&(b=b.replace(/\$DETAILMODE/g,a));b=this._addMapDefs(1===n,3===
n,m,g)+b;return b.replace(/\$/g,"")},_nonPointShadowMapProjection:function(a,b,c){return!b._normalOffsetBias||b._isVsm?2===b._type?b._isPcf&&(a.webgl2||a.extStandardDerivatives)?"\t   getShadowCoordPerspZbuffer"+c:"\t   getShadowCoordPersp"+c:"\t   getShadowCoordOrtho"+c:2===b._type?b._isPcf&&(a.webgl2||a.extStandardDerivatives)?"\t   getShadowCoordPerspZbufferNormalOffset"+c:"\t   getShadowCoordPerspNormalOffset"+c:"\t   getShadowCoordOrthoNormalOffset"+c},_addVaryingIfNeeded:function(a,b,c){return 0<=
a.indexOf(c)?"varying "+b+" "+c+";\n":""},_vsAddTransformCode:function(a,b,c,d){return a+=c.transformVS},_vsAddBaseCode:function(a,b,c,d){a+=c.baseVS;if(1===d.nineSlicedMode||2===d.nineSlicedMode)a+=c.baseNineSlicedVS;return a},_fsAddBaseCode:function(a,b,c,d){a+=c.basePS;1===d.nineSlicedMode?a+=c.baseNineSlicedPS:2===d.nineSlicedMode&&(a+=c.baseNineSlicedTiledPS);return a},_fsAddStartCode:function(a,b,c,d){a+=c.startPS;1===d.nineSlicedMode?a+=c.startNineSlicedPS:2===d.nineSlicedMode&&(a+=c.startNineSlicedTiledPS);
return a},createShaderDefinition:function(a,b){var c=0<b.lights.length;b.dirLightMap&&(c=!0,b.useSpecular=!0);0===b.shadingModel?(b.fresnelModel=0,b.specularAntialias=!1,b.prefilteredCubemap=!1,b.dpAtlas=!1,b.ambientSH=!1):b.fresnelModel=0===b.fresnelModel?2:b.fresnelModel;var d=(b.cubeMap||b.prefilteredCubemap&&b.useSpecular)&&!b.sphereMap&&!b.dpAtlas,e=b.sphereMap||d||b.dpAtlas,g=b.useTexCubeLod;b.cubeMap&&(b.sphereMap=null);b.dpAtlas&&(b.prefilteredCubemap=null);b.useSpecular||(b.specularMap=b.glossMap=
null);var k=c||e||b.ambientSH||b.prefilteredCubemap||b.heightMap||b.enableGGXSpecular,l=3<=b.pass&&17>=b.pass;this.options=b;var h="",f="",n="",m=K,q={vertex_position:"POSITION"};if(b.chunks){var u={};for(A in m)if(m.hasOwnProperty(A))if(b.chunks[A]){var t=b.chunks[A];0<=t.indexOf("vertex_normal")&&(q.vertex_normal="NORMAL");0<=t.indexOf("vertex_tangent")&&(q.vertex_tangent="TANGENT");0<=t.indexOf("vertex_texCoord0")&&(q.vertex_texCoord0="TEXCOORD0");0<=t.indexOf("vertex_texCoord1")&&(q.vertex_texCoord1=
"TEXCOORD1");0<=t.indexOf("vertex_color")&&(q.vertex_color="COLOR");0<=t.indexOf("vertex_boneWeights")&&(q.vertex_boneWeights="BLENDWEIGHT");0<=t.indexOf("vertex_boneIndices")&&(q.vertex_boneIndices="BLENDINDICES");u[A]=t}else u[A]=m[A];for(A in b.chunks)(m=this._oldChunkToNew[A])&&(u[m.n]=m.f(b.chunks[A],m.n,A));m=u}h=this._vsAddBaseCode(h,a,m,b);u=-1;if(!b.noShadow&&!b.twoSidedLighting){for(t=0;t<b.lights.length;t++){var y=b.lights[t]._type;if(b.lights[t].castShadows&&0===y){h+="uniform mat4 light"+
t+"_shadowMatrixVS;\n";h+="uniform vec3 light"+t+"_shadowParamsVS;\n";h+="uniform vec3 light"+t+(0===y?"_directionVS":"_positionVS")+";\n";u=t;break}}0<=u&&(h+=m.shadowCoordVS)}f+="   vPositionW\t= getWorldPosition();\n";2===b.pass&&(h+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n",f+="\tvDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n");b.useInstancing&&
(q.instance_line1="TEXCOORD2",q.instance_line2="TEXCOORD3",q.instance_line3="TEXCOORD4",q.instance_line4="TEXCOORD5",h+=m.instancingVS);k&&(q.vertex_normal="NORMAL",f+="   vNormalW\t= dNormalW = getNormal();\n",b.sphereMap&&16>=a.fragmentUniformsCount&&(h+=m.viewNormalVS,f+="   vNormalV\t= getViewNormal();\n"),(b.heightMap||b.normalMap||b.enableGGXSpecular)&&b.hasTangents?(q.vertex_tangent="TANGENT",h+=m.tangentBinormalVS,f+="   vTangentW   = getTangent();\n   vBinormalW  = getBinormal();\n"):b.enableGGXSpecular&&
(h+=m.tangentBinormalVS,f+="   vObjectSpaceUpW  = getObjectSpaceUp();\n"),0<=u&&(y=b.lights[u]._type,f=(0===y?f+("   dLightDirNormW = light"+u+"_directionVS;\n"):f+("   getLightDirPoint(light"+u+"_positionVS);\n"))+this._nonPointShadowMapProjection(a,b.lights[u],"(light"+u+"_shadowMatrixVS, light"+u+"_shadowParamsVS);\n")));y=[];var r=[];for(A in hc){t=A+"Map";if(b[A+"VertexColor"]){var v=A+"VertexColorChannel";b[v]=this._correctChannel(A,b[v])}if(b[t]){v=t+"Channel";var x=t+"Transform";var z=t+"Uv";
b[z]=Math.min(b[z],1);b[v]=this._correctChannel(A,b[v]);z=b[z];y[z]=!0;r[z]=r[z]||b[t]&&!b[x]}}b.forceUv1&&(y[1]=!0);for(t=0;2>t;t++)y[t]&&(q["vertex_texCoord"+t]=pc["SEMANTIC_TEXCOORD"+t],h+=m["uv"+t+"VS"],f+="   vec2 uv"+t+" = getUv"+t+"();\n"),r[t]&&(f+="   vUv"+t+" = uv"+t+";\n");y=[h,n,f,[]];for(A in hc)t=A+"Map",b[t]&&(x=t+"Transform",b[x]&&(z=t+"Uv",this._setMapTransform(y,A,b[x],b[z])));h=y[0];n=y[1];f=y[2];b.vertexColors&&(q.vertex_color="COLOR",f+="   vVertexColor = vertex_color;\n");if(b.useMorphPosition||
b.useMorphNormal)h+="#define MORPHING\n",b.useMorphPosition?(q.morph_pos0="ATTR0",q.morph_pos1="ATTR1",q.morph_pos2="ATTR2",q.morph_pos3="ATTR3",h+="#define MORPHING_POS03\nattribute vec3 morph_pos0;\nattribute vec3 morph_pos1;\nattribute vec3 morph_pos2;\nattribute vec3 morph_pos3;\n"):b.useMorphNormal&&(q.morph_nrm0="ATTR0",q.morph_nrm1="ATTR1",q.morph_nrm2="ATTR2",q.morph_nrm3="ATTR3",h+="#define MORPHING_NRM03\nattribute vec3 morph_nrm0;\nattribute vec3 morph_nrm1;\nattribute vec3 morph_nrm2;\nattribute vec3 morph_nrm3;\n"),
b.useMorphNormal?(q.morph_nrm4="ATTR4",q.morph_nrm5="ATTR5",q.morph_nrm6="ATTR6",q.morph_nrm7="ATTR7",h+="#define MORPHING_NRM47\nattribute vec3 morph_nrm4;\nattribute vec3 morph_nrm5;\nattribute vec3 morph_nrm6;\nattribute vec3 morph_nrm7;\n"):(q.morph_pos4="ATTR4",q.morph_pos5="ATTR5",q.morph_pos6="ATTR6",q.morph_pos7="ATTR7",h+="#define MORPHING_POS47\nattribute vec3 morph_pos4;\nattribute vec3 morph_pos5;\nattribute vec3 morph_pos6;\nattribute vec3 morph_pos7;\n");b.skin?(q.vertex_boneWeights=
"BLENDWEIGHT",q.vertex_boneIndices="BLENDINDICES",h+=aa.skinCode(a,m),h+="#define SKIN\n"):b.useInstancing&&(h+="#define INSTANCING\n");b.screenSpace&&(h+="#define SCREENSPACE\n");b.pixelSnap&&(h+="#define PIXELSNAP\n");h=this._vsAddTransformCode(h,a,m,b);k&&(h+=m.normalVS);h=h+"\n"+m.startVS;var A=h=h+f+"}";t=n;n=""+this._addVaryingIfNeeded(h,"vec4","vMainShadowUv");n+=this._addVaryingIfNeeded(h,"vec4","vVertexColor");n+=this._addVaryingIfNeeded(h,"vec3","vPositionW");n+=this._addVaryingIfNeeded(h,
"vec3","vNormalV");n+=this._addVaryingIfNeeded(h,"vec3","vNormalW");n+=this._addVaryingIfNeeded(h,"vec3","vTangentW");n+=this._addVaryingIfNeeded(h,"vec3","vBinormalW");n+=this._addVaryingIfNeeded(h,"vec3","vObjectSpaceUpW");n+=this._addVaryingIfNeeded(h,"vec2","vUv0");n+=this._addVaryingIfNeeded(h,"vec2","vUv1");n+=t;A=n+A;h="";a.webgl2?(h=aa.versionCode(a),m.extensionVS&&(h+=m.extensionVS+"\n"),A=h+m.gles3VS+A):(m.extensionVS&&(h=m.extensionVS+"\n"),A=h+A);b.forceFragmentPrecision&&"highp"!=b.forceFragmentPrecision&&
"mediump"!==b.forceFragmentPrecision&&"lowp"!==b.forceFragmentPrecision&&(b.forceFragmentPrecision=null);b.forceFragmentPrecision&&("highp"===b.forceFragmentPrecision&&"highp"!==a.maxPrecision&&(b.forceFragmentPrecision="mediump"),"mediump"===b.forceFragmentPrecision&&"lowp"===a.maxPrecision&&(b.forceFragmentPrecision="lowp"));h="";a.webgl2&&(h+=aa.versionCode(a));a.extStandardDerivatives&&!a.webgl2&&(h+="#extension GL_OES_standard_derivatives : enable\n\n");m.extensionPS&&(h+=m.extensionPS+"\n");
a.webgl2&&(h+=m.gles3PS);h+=b.forceFragmentPrecision?"precision "+b.forceFragmentPrecision+" float;\n\n":aa.precisionCode(a);if(18===b.pass)return h=h+"uniform vec4 uColor;\n"+n,b.alphaTest&&(h=h+"float dAlpha;\n"+this._addMap("opacity","opacityPS",b,m),h+=m.alphaTestPS),h+=aa.begin(),b.alphaTest&&(h+="   getOpacity();\n   alphaTest(dAlpha);\n"),h=h+"\tgl_FragColor = uColor;\n"+aa.end(),{attributes:q,vshader:A,fshader:h};if(2===b.pass)return h=h+"varying float vDepth;\n"+n+m.packDepthPS,b.alphaTest&&
(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",b,m),h+=m.alphaTestPS),h+=aa.begin(),b.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),h+="\tgl_FragColor = packFloat(vDepth);\n",h+=aa.end(),{attributes:q,vshader:A,fshader:h};if(l)return d=b.pass-3,y=Math.floor(d/5),d-=5*y,a.extStandardDerivatives&&!a.webgl2&&(h+="uniform vec2 polygonOffset;\n"),3===d?h=a.textureFloatHighPrecision?h+"#define VSM_EXPONENT 15.0\n\n":h+"#define VSM_EXPONENT 5.54\n\n":2===d&&(h+="#define VSM_EXPONENT 5.54\n\n"),
0!==y&&(h+="uniform vec3 view_position;\n",h+="uniform float light_radius;\n"),h+=n,b.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",b,m),h+=m.alphaTestPS),0!==d||a.webgl2&&1!==y?1===d&&(h+="vec2 encodeFloatRG( float v ) {\n",h+="\tvec2 enc = vec2(1.0, 255.0) * v;\n",h+="\tenc = fract(enc);\n",h+="\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",h+="\treturn enc;\n",h+="}\n\n"):h+=m.packDepthPS,h+=aa.begin(),b.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),
h=1===y||(1===d||2===d||3===d)&&0!==y?h+"   float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":h+"   float depth = gl_FragCoord.z;\n",0!==d||a.webgl2&&1!==y?h=0===d||4===d?h+"   gl_FragColor = vec4(1.0);\n":1===d?h+"   gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":h+m.storeEVSMPS:(a.extStandardDerivatives&&!a.webgl2&&(h+="   float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",h+="   depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),
h+="   gl_FragColor = packFloat(depth);\n"),h+=aa.end(),{attributes:q,vshader:A,fshader:h};if(b.customFragmentShader)return a=h+b.customFragmentShader,{attributes:q,vshader:A,fshader:a,tag:1};h=this._fsAddBaseCode(h+n,a,m,b);b.detailModes&&(h+=m.detailModesPS);n=h;h="";0<b.clearCoat&&(h+="#define CLEARCOAT\n");r=0;x=[];v=z=!1;for(t=0;t<b.lights.length;t++)if(f=b.lights[t],y=f._type,h+="uniform vec3 light"+t+"_color;\n",0===y?h+="uniform vec3 light"+t+"_direction;\n":(h+="uniform vec3 light"+t+"_position;\n",
h+="uniform float light"+t+"_radius;\n",2===y&&(h+="uniform vec3 light"+t+"_direction;\n",h+="uniform float light"+t+"_innerConeAngle;\n",h+="uniform float light"+t+"_outerConeAngle;\n")),f.castShadows&&!b.noShadow&&(h+="uniform mat4 light"+t+"_shadowMatrix;\n",h=0!==y?h+("uniform vec4 light"+t+"_shadowParams;\n"):h+("uniform vec3 light"+t+"_shadowParams;\n"),h=1===y?h+("uniform samplerCube light"+t+"_shadowMap;\n"):f._isPcf&&a.webgl2?h+("uniform sampler2DShadow light"+t+"_shadowMap;\n"):h+("uniform sampler2D light"+
t+"_shadowMap;\n"),r++,x[f._shadowType]=!0,f._isVsm&&(z=!0),f._isPcf&&(a.webgl2||a.extStandardDerivatives)&&2===y&&(v=!0)),f._cookie)if(f._cookie._cubemap)1===y&&(h+="uniform samplerCube light"+t+"_cookie;\n",h+="uniform float light"+t+"_cookieIntensity;\n",!f.castShadows||b.noShadow)&&(h+="uniform mat4 light"+t+"_shadowMatrix;\n");else if(2===y){h+="uniform sampler2D light"+t+"_cookie;\n";h+="uniform float light"+t+"_cookieIntensity;\n";if(!f.castShadows||b.noShadow)h+="uniform mat4 light"+t+"_shadowMatrix;\n";
f._cookieTransform&&(h+="uniform vec4 light"+t+"_cookieMatrix;\n",h+="uniform vec2 light"+t+"_cookieOffset;\n")}h+="\n";l=!b.hasTangents&&a.extStandardDerivatives?m.TBNderivativePS:b.fastTbn?m.TBNfastPS:m.TBNPS;k&&(b.normalMap?(h+=b.packedNormal?m.normalXYPS:m.normalXYZPS,b.normalDetail&&(h+=this._addMap("normalDetail","normalDetailMapPS",b,m)),t=this._getUvSourceExpression("normalMapTransform","normalMapUv",b),h=b.normalizeNormalMap?h+m.normalMapPS.replace(/\$UV/g,t):h+m.normalMapFastPS.replace(/\$UV/g,
t),b.hasTangents||(l=l.replace(/\$UV/g,t)),h+=l):(h+=m.normalVertexPS,b.enableGGXSpecular&&(h+=m.TBNObjectSpacePS)));h+=aa.gammaCode(b.gamma,m);h+=aa.tonemapCode(b.toneMap,m);h+=aa.fogCode(b.fog,m);b.useRgbm&&(h+=m.rgbmPS);if(d||b.prefilteredCubemap)h+=b.fixSeams?m.fixCubemapSeamsStretchPS:m.fixCubemapSeamsNonePS;k&&(h+=0<b.cubeMapProjection?m.cubeMapProjectBoxPS:m.cubeMapProjectNonePS,h+=b.skyboxIntensity?m.envMultiplyPS:m.envConstPS);b.diffuseDetail&&(h+=this._addMap("diffuseDetail","diffuseDetailMapPS",
b,m));h+=this._addMap("diffuse","diffusePS",b,m);if(3!==b.blendType||b.alphaTest||b.alphaToCoverage)h+=this._addMap("opacity","opacityPS",b,m);h+=this._addMap("emissive","emissivePS",b,m,b.emissiveFormat);b.useSpecular&&(c||e)&&(h=b.specularAntialias&&b.normalMap?b.normalizeNormalMap&&k?h+m.specularAaToksvigPS:h+m.specularAaToksvigFastPS:h+m.specularAaNonePS,t=b.useMetalness?"metalness":"specular",h+=this._addMap(t,t+"PS",b,m),h+=this._addMap("gloss","glossPS",b,m),2===b.fresnelModel&&(h+=m.fresnelSchlickPS));
b.heightMap&&(b.normalMap||(t=this._getUvSourceExpression("heightMapTransform","heightMapUv",b),b.hasTangents||(l=l.replace(/\$UV/g,t)),h+=l),h+=this._addMap("height","parallaxPS",b,m));if(l=b.aoMap||b.aoVertexColor)h+=this._addMap("ao","aoPS",b,m),b.occludeSpecular&&(h=1===b.occludeSpecular?h+(b.occludeSpecularFloat?m.aoSpecOccSimplePS:m.aoSpecOccConstSimplePS):h+(b.occludeSpecularFloat?m.aoSpecOccPS:m.aoSpecOccConstPS));t=b.rgbmReflection?"decodeRGBM":b.hdrReflection?"":"gammaCorrectInput";b.sphereMap?
(t=16<a.fragmentUniformsCount?m.reflectionSpherePS:m.reflectionSphereLowPS,t=t.replace(/\$texture2DSAMPLE/g,b.rgbmReflection?"texture2DRGBM":b.hdrReflection?"texture2D":"texture2DSRGB"),h+=t):d?h=b.prefilteredCubemap?g?h+m.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,t):h+m.reflectionPrefilteredCubePS.replace(/\$DECODE/g,t):h+m.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,b.rgbmReflection?"textureCubeRGBM":b.hdrReflection?"textureCube":"textureCubeSRGB"):b.dpAtlas&&(h+=m.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,
b.rgbmReflection?"texture2DRGBM":b.hdrReflection?"texture2D":"texture2DSRGB"));if(d||b.sphereMap||b.dpAtlas)0<b.clearCoat&&(h+=m.reflectionCCPS),b.refraction&&(h+=m.refractionPS);0<r&&(x[0]&&(h+=m.shadowStandardPS),x[4]&&(h+=m.shadowStandardGL2PS),z&&(h+=m.shadowVSM_commonPS,x[1]&&(h+=m.shadowVSM8PS),x[2]&&(h+=a.extTextureHalfFloatLinear?m.shadowEVSMPS.replace(/\$/g,"16"):m.shadowEVSMnPS.replace(/\$/g,"16")),x[3]&&(h+=a.extTextureFloatLinear?m.shadowEVSMPS.replace(/\$/g,"32"):m.shadowEVSMnPS.replace(/\$/g,
"32"))),a.webgl2||a.extStandardDerivatives||(h+=m.biasConstPS),h+=m.shadowCoordPS+m.shadowCommonPS,v&&(h+=m.shadowCoordPerspZbufferPS),0<=u&&(x[0]&&(h+=m.shadowStandardVSPS),x[4]&&(h+=m.shadowStandardGL2VSPS),z&&(x[1]&&(h+=m.shadowVSMVSPS.replace(/\$VSM/g,"VSM8").replace(/\$/g,"8")),x[2]&&(h+=m.shadowVSMVSPS.replace(/\$VSM/g,"VSM16").replace(/\$/g,"16")),x[3]&&(h+=m.shadowVSMVSPS.replace(/\$VSM/g,"VSM32").replace(/\$/g,"32")))));b.enableGGXSpecular&&(h+="uniform float material_anisotropy;\n");c&&
(h+=m.lightDiffuseLambertPS);t=!1;b.useSpecular?(c&&(h+=0===b.shadingModel?m.lightSpecularPhongPS:b.enableGGXSpecular?m.lightSpecularAnisoGGXPS:m.lightSpecularBlinnPS),b.sphereMap||d||b.dpAtlas||0<b.fresnelModel?h=0<b.fresnelModel?b.conserveEnergy?h+m.combineDiffuseSpecularPS:h+m.combineDiffuseSpecularNoConservePS:h+m.combineDiffuseSpecularOldPS:b.diffuseMap?h+=m.combineDiffuseSpecularNoReflPS:(h+=m.combineDiffuseSpecularNoReflSeparateAmbientPS,t=!0)):h+=m.combineDiffusePS;0<b.clearCoat&&(h+=m.combineClearCoatPS);
y=!0;if(b.lightMap||b.lightVertexColor)h+=this._addMap("light",b.dirLightMap?"lightmapDirPS":"lightmapSinglePS",b,m,b.lightMapFormat),y=b.lightMapWithoutAmbient;y&&(f=b.rgbmAmbient?"decodeRGBM":b.hdrAmbient?"":"gammaCorrectInput",h=b.ambientSH?h+m.ambientSHPS:b.prefilteredCubemap?g?h+m.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,f):h+m.ambientPrefilteredCubePS.replace(/\$DECODE/g,f):h+m.ambientConstantPS);b.ambientTint&&!t&&(h+="uniform vec3 material_ambient;\n");b.alphaTest&&(h+=m.alphaTestPS);
b.msdf&&(h+=m.msdfPS);k&&(h+=m.viewDirPS,b.useSpecular&&(h+=b.enableGGXSpecular?m.reflDirAnisoPS:m.reflDirPS));v=z=x=r=g=!1;h=this._fsAddStartCode(h,a,m,b);k&&(h=b.twoSidedLighting?h+"   dVertexNormalW = gl_FrontFacing ? vNormalW : -vNormalW;\n":h+"   dVertexNormalW = vNormalW;\n",(b.heightMap||b.normalMap)&&b.hasTangents&&(b.twoSidedLighting?(h+="   dTangentW = gl_FrontFacing ? vTangentW : -vTangentW;\n",h+="   dBinormalW = gl_FrontFacing ? vBinormalW : -vBinormalW;\n"):(h+="   dTangentW = vTangentW;\n",
h+="   dBinormalW = vBinormalW;\n")));f=!1;3!==b.blendType||b.alphaTest||b.alphaToCoverage?b.heightMap&&b.opacityMap?f=!0:(h+="   getOpacity();\n",b.alphaTest&&(h+="   alphaTest(dAlpha);\n")):h+="   dAlpha = 1.0;\n";var F=!1;if(k){h+="   getViewDir();\n";if(b.heightMap||b.normalMap||b.enableGGXSpecular)h+="   getTBN();\n";b.heightMap&&(h+="   getParallax();\n");f&&(h+="   getOpacity();\n",b.alphaTest&&(h+="   alphaTest(dAlpha);\n"));h+="   getNormal();\n";b.useSpecular&&(b.enableGGXSpecular&&(h+=
"   getGlossiness();\n",F=!0),h+="   getReflDir();\n")}h+="   getAlbedo();\n";if(c&&b.useSpecular||e)h+="   getSpecularity();\n",F||(h+="   getGlossiness();\n"),0<b.fresnelModel&&(h+="   getFresnel();\n");y&&(h+="   addAmbient();\n");b.ambientTint&&!t&&(h+="   dDiffuseLight *= material_ambient;\n");l&&!b.occludeDirect&&(h+="\tapplyAO();\n");if(b.lightMap||b.lightVertexColor)h+="   addLightMap();\n";if(c||e){if(d||b.sphereMap||b.dpAtlas)0<b.clearCoat&&(h+="   addReflectionCC();\n"),h+="   addReflection();\n";
b.dirLightMap&&(h+="   addDirLightMap();\n");for(t=0;t<b.lights.length;t++){f=b.lights[t];y=f._type;e=!1;0===y?(h+="   dLightDirNormW = light"+t+"_direction;\n",h+="   dAtten = 1.0;\n"):(f._cookie&&(2!==y||f._cookie._cubemap?1===y&&f._cookie._cubemap&&(e=v=!0):e=v=!0),h+="   getLightDirPoint(light"+t+"_position);\n",g=!0,e&&(h=2===y?h+("   dAtten3 = getCookie2D"+(f._cookieFalloff?"":"Clip")+(f._cookieTransform?"Xform":"")+"(light"+t+"_cookie, light"+t+"_shadowMatrix, light"+t+"_cookieIntensity"+(f._cookieTransform?
", light"+t+"_cookieMatrix, light"+t+"_cookieOffset":"")+")."+f._cookieChannel+";\n"):h+("   dAtten3 = getCookieCube(light"+t+"_cookie, light"+t+"_shadowMatrix, light"+t+"_cookieIntensity)."+f._cookieChannel+";\n")),0===f._falloffMode?(h+="   dAtten = getFalloffLinear(light"+t+"_radius);\n",r=!0):(h+="   dAtten = getFalloffInvSquared(light"+t+"_radius);\n",x=!0),h+="   if (dAtten > 0.00001) {\n",2!==y||e&&!f._cookieFalloff||(h+="\t   dAtten *= getSpotEffect(light"+t+"_direction, light"+t+"_innerConeAngle, light"+
t+"_outerConeAngle);\n",z=!0));h+="\t   dAtten *= getLightDiffuse();\n";if(f.castShadows&&!b.noShadow){if(1===f._shadowType){k="VSM8";var Q="0.0"}else 2===f._shadowType?(k="VSM16",Q="5.54"):3===f._shadowType?(k="VSM32",Q=a.textureFloatHighPrecision?"15.0":"5.54"):k=4===f._shadowType?"PCF5x5":"PCF3x3";null!==k&&(1===y?(c="(light"+t+"_shadowMap, light"+t+"_shadowParams);\n",f._normalOffsetBias&&(h+="\t   normalOffsetPointShadow(light"+t+"_shadowParams);\n"),h+="\t   dAtten *= getShadowPoint"+k+c):(u===
t?k+="VS":(c="(light"+t+"_shadowMatrix, light"+t+"_shadowParams);\n",h+=this._nonPointShadowMapProjection(a,b.lights[t],c)),2===y&&(k="Spot"+k),h+="\t   dAtten *= getShadow"+k+"(light"+t+"_shadowMap, light"+t+"_shadowParams"+(f._isVsm?", "+Q:"")+");\n"))}h+="\t   dDiffuseLight += dAtten * light"+t+"_color"+(e?" * dAtten3":"")+";\n";0<b.clearCoat&&(h+="\t   ccSpecularLight += getLightSpecularCC() * dAtten * light"+t+"_color"+(e?" * dAtten3":"")+";\n");b.useSpecular&&(h+="\t   dAtten *= getLightSpecular();\n",
h+="\t   dSpecularLight += dAtten * light"+t+"_color"+(e?" * dAtten3":"")+";\n");0!==y&&(h+="   }\n");h+="\n"}(d||b.sphereMap||b.dpAtlas)&&b.refraction&&(h+="   addRefraction();\n")}h+="\n";l&&(b.occludeDirect&&(h+="\tapplyAO();\n"),b.occludeSpecular&&(h+="\toccludeSpecular();\n"));h+=m.endPS;h=2===b.blendType||6===b.blendType||b.alphaToCoverage?h+m.outputAlphaPS:4===b.blendType?h+m.outputAlphaPremulPS:h+m.outputAlphaOpaquePS;b.msdf&&(h+="   gl_FragColor = applyMsdf(gl_FragColor);\n");h+="\n";h+=
aa.end();g&&(h=m.lightDirPointPS+h);r&&(h=m.falloffLinearPS+h);x&&(h=m.falloffInvSquaredPS+h);z&&(h=m.spotPS+h);v&&(h=m.cookiePS+h);a="";h.includes("dReflection")&&(a+="vec4 dReflection;\n");h.includes("dTBN")&&(a+="mat3 dTBN;\n");h.includes("dAlbedo")&&(a+="vec3 dAlbedo;\n");h.includes("dEmission")&&(a+="vec3 dEmission;\n");h.includes("dNormalW")&&(a+="vec3 dNormalW;\n");h.includes("dVertexNormalW")&&(a+="vec3 dVertexNormalW;\n");h.includes("dTangentW")&&(a+="vec3 dTangentW;\n");h.includes("dBinormalW")&&
(a+="vec3 dBinormalW;\n");h.includes("dViewDirW")&&(a+="vec3 dViewDirW;\n");h.includes("dReflDirW")&&(a+="vec3 dReflDirW;\n");h.includes("dDiffuseLight")&&(a+="vec3 dDiffuseLight;\n");h.includes("dSpecularLight")&&(a+="vec3 dSpecularLight;\n");h.includes("dLightDirNormW")&&(a+="vec3 dLightDirNormW;\n");h.includes("dLightDirW")&&(a+="vec3 dLightDirW;\n");h.includes("dLightPosW")&&(a+="vec3 dLightPosW;\n");h.includes("dShadowCoord")&&(a+="vec3 dShadowCoord;\n");h.includes("dNormalMap")&&(a+="vec3 dNormalMap;\n");
h.includes("dSpecularity")&&(a+="vec3 dSpecularity;\n");h.includes("dUvOffset")&&(a+="vec2 dUvOffset;\n");h.includes("dGlossiness")&&(a+="float dGlossiness;\n");h.includes("dAlpha")&&(a+="float dAlpha;\n");h.includes("dAtten")&&(a+="float dAtten;\n");h.includes("dAtten3")&&(a+="vec3 dAtten3;\n");h.includes("dAo")&&(a+="float dAo;\n");h.includes("dMsdf")&&(a+="vec4 dMsdf;\n");h.includes("ccReflection")&&(a+="vec4 ccReflection;\n");h.includes("ccNormalW")&&(a+="vec3 ccNormalW;\n");h.includes("ccReflDirW")&&
(a+="vec3 ccReflDirW;\n");h.includes("ccSpecularLight")&&(a+="vec3 ccSpecularLight;\n");h.includes("ccSpecularity")&&(a+="vec3 ccSpecularity;\n");h.includes("ccGlossiness")&&(a+="float ccGlossiness=0.9;\n");a=h=n+a+h;return{attributes:q,vshader:A,fshader:a,tag:1}}};Object.assign(Qd.prototype,{destroy:function(){this.device.destroyShader(this)}});var K={alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n    if (a < alpha_ref) discard;\n}\n\n",ambientConstantPS:"\nvoid addAmbient() {\n    dDiffuseLight += light_globalAmbient;\n}\n",
ambientPrefilteredCubePS:"#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n\n",ambientPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n\n",
ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n    vec3 n = dNormalW;\n\n    vec3 color =\n                        ambientSH[0] +\n                        ambientSH[1] * n.x +\n                        ambientSH[2] * n.y +\n                        ambientSH[3] * n.z +\n                        ambientSH[4] * n.x * n.z +\n                        ambientSH[5] * n.z * n.y +\n                        ambientSH[6] * n.y * n.x +\n                        ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n                        ambientSH[8] * (n.x * n.x - n.y * n.y);\n\n    dDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n\n",
aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\n\nvoid applyAO() {\n    dAo = 1.0;\n\n    #ifdef MAPTEXTURE\n        dAo *= texture2D(texture_aoMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        dAo *= saturate(vVertexColor.$VC);\n    #endif\n\n    dDiffuseLight *= dAo;\n}\n\n",aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n",
aoSpecOccConstPS:"void occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n",aoSpecOccConstSimplePS:"void occludeSpecular() {\n    float specOcc = dAo;\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n",
aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    float specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n",bakeDirLmEndPS:"\n    vec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\n    if (bakeDir > 0.5) {\n        if (dAtten > 0.00001) {\n            dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n            dAtten = saturate(dAtten);\n            gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n            gl_FragColor.a = dirLm.w + dAtten;\n            gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n        } else {\n            gl_FragColor = dirLm;\n        }\n    } else {\n        gl_FragColor.rgb = dirLm.xyz;\n        gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n    }\n\n",
bakeLmEndPS:"\ngl_FragColor.rgb = dDiffuseLight;\ngl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\ngl_FragColor.rgb /= 8.0;\ngl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\ngl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\ngl_FragColor.rgb /= gl_FragColor.a;\n\n",basePS:"\nuniform vec3 view_position;\n\nuniform vec3 light_globalAmbient;\n\nfloat square(float x) {\n    return x*x;\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 x) {\n    return clamp(x, vec3(0.0), vec3(1.0));\n}\n\n",
baseVS:"\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n\n",baseNineSlicedPS:"#define NINESLICED\n\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n\nvec2 nineSlicedUv;\n",
baseNineSlicedVS:"#define NINESLICED\n\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n    return maxBias;\n}\n\n",
blurVSMPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\n\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\n#endif\n\nvoid main(void) {\n    vec3 moments = vec3(0.0);\n    vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n    for(int i=0; i<SAMPLES; i++) {\n        vec4 c = texture2D(source, uv + pixelOffset * float(i));\n\n        #ifdef PACKED\n        c.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n        #endif\n\n        #ifdef GAUSS\n        moments += c.xyz * weight[i];\n        #else\n        moments += c.xyz;\n        #endif\n    }\n\n    #ifndef GAUSS\n    moments /= float(SAMPLES);\n    #endif\n\n    #ifdef PACKED\n    gl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n    #else\n    gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n    #endif\n}\n\n",
combineClearCoatPS:"vec3 combineColorCC() {\n    return combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n    return dAlbedo * dDiffuseLight;\n}\n\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n\n",
combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n    return (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n\n",
cookiePS:"vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\n\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\n\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\n\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\n\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n    return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n\n",
cubeMapProjectBoxPS:"uniform vec3 envBoxMin, envBoxMax;\n\nvec3 cubeMapProject(vec3 nrdir) {\n    vec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n    vec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\n    vec3 rbminmax;\n    rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n    rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n    rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\n    float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\n    vec3 posonbox = vPositionW + nrdir * fa;\n    vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n    return posonbox - envBoxPos;\n}\n\n",
cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n    return dir;\n}\n\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n    return c1 * c2;\n}\n\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n    return c1 + c2;\n}\n\n// https://en.wikipedia.org/wiki/Blend_modes#Screen\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n    return 1.0 - (1.0 - c1)*(1.0 - c2);\n}\n\n// https://en.wikipedia.org/wiki/Blend_modes#Overlay\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n    return mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\n\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n    return min(c1, c2);\n}\n\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n    return max(c1, c2);\n}\n\n",
diffusePS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\n\nvoid getAlbedo() {\n    dAlbedo = vec3(1.0);\n\n    #ifdef MAPCOLOR\n        dAlbedo *= material_diffuse.rgb;\n    #endif\n\n    #ifdef MAPTEXTURE\n        dAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n    #endif\n\n    #ifdef MAPVERTEX\n        dAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n}\n\n",
diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\n\nvec3 addAlbedoDetail(vec3 albedo) {\n    #ifdef MAPTEXTURE\n        vec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n        return detailMode_$DETAILMODE(albedo, albedoDetail);\n    #else\n        return albedo;\n    #endif\n}\n\n",dilatePS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n    vec4 c = texture2D(source, vUv0);\n    c = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n    gl_FragColor = c;\n}\n\n",
dpAtlasQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\n\nvoid main(void) {\n    vec2 uv = vUv0;\n    uv = uv * 2.0 - vec2(1.0);\n    uv *= params.xy;\n    uv = uv * 0.5 + 0.5;\n    gl_FragColor = texture2D(source, uv);\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\n\nvec3 getEmission() {\n    vec3 emission = vec3(1.0);\n\n    #ifdef MAPFLOAT\n        emission *= material_emissiveIntensity;\n    #endif\n\n    #ifdef MAPCOLOR\n        emission *= material_emissive;\n    #endif\n\n    #ifdef MAPTEXTURE\n        emission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        emission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n\n    return emission;\n}\n\n",
endPS:"  #ifdef CLEARCOAT\n   gl_FragColor.rgb = combineColorCC();\n  #else\n   gl_FragColor.rgb = combineColor();\n  #endif \n   gl_FragColor.rgb += getEmission();\n   gl_FragColor.rgb = addFog(gl_FragColor.rgb);\n   #ifndef HDR\n    gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n    gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n   #endif\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n    return color;\n}\n\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n    return color * skyboxIntensity;\n}\n\n",
extensionPS:"",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffInvSquared(float lightRadius) {\n    float sqrDist = dot(dLightDirW, dLightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\n    return falloff;\n}\n\n",falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n    float d = length(dLightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n\n",
fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    return vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n    return vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    return vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    float scale = 1.0 - exp2(mipmapIndex) / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n    float scale = 1.0 - 1.0 / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    float scale = invRecMipSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\n",
fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n",
fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    fogFactor = gammaCorrectInput(fogFactor);\n    return mix(fog_color, color, fogFactor);\n}\n",fogNonePS:"vec3 addFog(vec3 color) {\n    return color;\n}\n\n\n",fresnelSchlickPS:"// Schlick's approximation\nuniform float material_fresnelFactor; // unused\nvoid getFresnel() {\n    float fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n    float fresnel2 = fresnel * fresnel;\n    fresnel *= fresnel2 * fresnel2;\n    fresnel *= dGlossiness * dGlossiness;\n    dSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n    #ifdef CLEARCOAT\n        fresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n        fresnel2 = fresnel * fresnel;\n        fresnel *= fresnel2 * fresnel2;\n        fresnel *= ccGlossiness * ccGlossiness;\n        ccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n    #endif\n}\n",
fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\n\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = vertex_position.xy*0.5+0.5;\n}\n\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return texture2D(tex, uv);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    return texture2D(tex, uv, bias);\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    return textureCube(tex, uvw);\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\n\nfloat gammaCorrectInput(float color) {\n    return color;\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return color;\n}\n",
gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n    return pow(color, vec3(2.2));\n}\n\nfloat gammaCorrectInput(float color) {\n    return pow(color, 2.2);\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    vec4 rgba = texture2D(tex, uv, bias);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n#ifdef HDR\n    return color;\n#else\n    color += vec3(0.0000001);\n    return pow(color, vec3(0.45));\n#endif\n}\n",
genParaboloidPS:"varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params; // x = mip\n\nvoid main(void) {\n\n    vec2 uv = vUv0;\n\n    float side = uv.x < 0.5? 1.0 : -1.0;\n    vec2 tc;\n    tc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n    tc.y = uv.y * 2.0 - 1.0;\n\n    // scale projection a bit to have a little overlap for filtering\n    const float scale = 1.1;\n    tc *= scale;\n\n    vec3 dir;\n    dir.y = (dot(tc, tc) - 1.0) * side; // from 1.0 center to 0.0 borders quadratically\n    dir.xz = tc * -2.0;\n\n    dir.x *= -side * params.y; // flip original cubemap x instead of doing it at runtime\n\n    dir = fixSeams(dir, params.x);\n\n    vec4 color = textureCube(source, dir, -100.0);\n    gl_FragColor = color;\n}\n",
gles3PS:"#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",
glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n\n#ifdef CLEARCOAT\nuniform float material_clearCoatGlossiness;\n#endif\n\nvoid getGlossiness() {\n    dGlossiness = 1.0;\n\n    #ifdef MAPFLOAT\n        dGlossiness *= material_shininess;\n    #endif\n\n    #ifdef MAPTEXTURE\n        dGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        dGlossiness *= saturate(vVertexColor.$VC);\n    #endif\n\n    dGlossiness += 0.0000001;\n\n    #ifdef CLEARCOAT\n        ccGlossiness = 1.0;\n        ccGlossiness *= material_clearCoatGlossiness;\n        ccGlossiness += 0.0000001;\n    #endif\n}\n\n",
instancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n\n",lightDiffuseLambertPS:"float getLightDiffuse() {\n    return max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n    dLightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(dLightDirW);\n    dLightPosW = lightPosW;\n}\n\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\n\nvoid addLightMap() {\n\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) {\n        dDiffuseLight += color;\n        return;\n    }\n\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n\n    float vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n    float flight = saturate(dot(dLightDirNormW, -dNormalW));\n    float nlight = (flight / max(vlight,0.01)) * 0.5;\n\n    dDiffuseLight += color * nlight * 2.0;\n}\n\nvoid addDirLightMap() {\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) return;\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n    dSpecularLight += vec3(getLightSpecular()) * color;\n}\n\n",
lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\n\nvoid addLightMap() {\n    vec3 lm = vec3(1.0);\n\n    #ifdef MAPTEXTURE\n        lm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        lm *= saturate(vVertexColor.$VC);\n    #endif\n    \n    dDiffuseLight += lm;\n}\n\n",lightmapSingleVertPS:"void addLightMap() {\n    dDiffuseLight += saturate(vVertexColor.$CH);\n}\n\n",lightSpecularAnisoGGXPS:"// Anisotropic GGX\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n    float PI = 3.141592653589793;\n    float roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n    float anisotropy = material_anisotropy * roughness;\n \n    float at = max((roughness + anisotropy), roughness / 4.0);\n    float ab = max((roughness - anisotropy), roughness / 4.0);\n\n    vec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\n    float NoH = dot(tNormalW, h);\n    float ToH = dot(dTBN[0], h);\n    float BoH = dot(dTBN[1], h);\n\n    float a2 = at * ab;\n    vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n    float v2 = dot(v, v);\n    float w2 = a2 / v2;\n    float D = a2 * w2 * w2 * (1.0 / PI);\n\n    float ToV = dot(dTBN[0], dViewDirW);\n    float BoV = dot(dTBN[1], dViewDirW);\n    float ToL = dot(dTBN[0], -dLightDirNormW);\n    float BoL = dot(dTBN[1], -dLightDirNormW);\n    float NoV = dot(tNormalW, dViewDirW);\n    float NoL = dot(tNormalW, -dLightDirNormW);\n\n    float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n    float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n    float G = 0.5 / (lambdaV + lambdaL);\n\n    return D * G;\n}\n\nfloat getLightSpecular() {\n    return calcLightSpecular(dGlossiness, dNormalW);\n}\n\nfloat getLightSpecularCC() {\n    return calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",
lightSpecularBlinnPS:"// Energy-conserving (hopefully) Blinn-Phong\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n    vec3 h = normalize( -dLightDirNormW + dViewDirW );\n    float nh = max( dot( h, tNormalW ), 0.0 );\n\n    float specPow = exp2(tGlossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n    specPow = antiAliasGlossiness(specPow);\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    specPow = max(specPow, 0.0001);\n\n    return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n\nfloat getLightSpecular() {\n    return calcLightSpecular(dGlossiness, dNormalW);\n}\n\nfloat getLightSpecularCC() {\n    return calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",
lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n    float specPow = tGlossiness;\n\n    specPow = antiAliasGlossiness(specPow);\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    return pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\n\nfloat getLightSpecular() {\n    return calcLightSpecular(dGlossiness, dReflDirW);\n}\n\nfloat getLightSpecularCC() {\n    return calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",
metalnessPS:"void processMetalness(float metalness) {\n    const float dielectricF0 = 0.04;\n    dSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n    dAlbedo *= 1.0 - metalness;\n}\n\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\n\n#ifdef CLEARCOAT\nuniform float material_clearCoatSpecularity;\n#endif\n\nvoid getSpecularity() {\n    float metalness = 1.0;\n\n    #ifdef MAPFLOAT\n        metalness *= material_metalness;\n    #endif\n\n    #ifdef MAPTEXTURE\n        metalness *= texture2D(texture_metalnessMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        metalness *= saturate(vVertexColor.$VC);\n    #endif\n\n    processMetalness(metalness);\n\n    #ifdef CLEARCOAT\n        ccSpecularity = vec3(1.0);\n        ccSpecularity *= material_clearCoatSpecularity;\n    #endif\n}\n\n",
msdfPS:"uniform sampler2D texture_msdfMap;\n\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n\n#ifdef GL2\n#define USE_FWIDTH\n#endif\n\nfloat median(float r, float g, float b) {\n    return max(min(r, g), min(max(r, g), b));\n}\n\nfloat map (float min, float max, float v) {\n    return (v - min) / (max - min);\n}\n\n\nuniform float font_sdfIntensity; // intensity is used to boost the value read from the SDF, 0 is no boost, 1.0 is max boost\nuniform float font_pxrange;      // the number of pixels between inside and outside the font in SDF\nuniform float font_textureWidth; // the width of the texture atlas\n\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\n\nvec4 applyMsdf(vec4 color) {\n    // sample the field\n    vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n    vec2 uvShdw = vUv0 - shadow_offset;\n    vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n    // get the signed distance value\n    float sigDist = median(tsample.r, tsample.g, tsample.b);\n    float sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\n    #ifdef USE_FWIDTH\n        // smoothing depends on size of texture on screen\n        vec2 w = fwidth(vUv0);\n        float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n    #else\n        float font_size = 16.0; // TODO fix this\n        // smoothing gets smaller as the font size gets bigger\n        // don't have fwidth we can approximate from font size, this doesn't account for scaling\n        // so a big font scaled down will be wrong...\n\n        float smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n    #endif\n    float mapMin = 0.05;\n    float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\n    // remap to a smaller range (used on smaller font sizes)\n    float sigDistInner = map(mapMin, mapMax, sigDist);\n    float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n    sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\n    float center = 0.5;\n    // calculate smoothing and use to generate opacity\n    float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n    float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n    float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\n    vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n    tcolor = mix(tcolor, color, inside);\n\n    vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n    tcolor = mix(scolor, tcolor, outline);\n    \n    return tcolor;\n}",
normalVS:"vec3 getNormal() {\n    #ifdef SKIN\n        dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    #elif defined(INSTANCING)\n        dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    #else\n        dNormalMatrix = matrix_normal;\n    #endif\n\n    vec3 tempNormal = vertex_normal;\n\n    #ifdef MORPHING\n        #ifdef MORPHING_NRM03\n            tempNormal += morph_weights_a[0] * morph_nrm0;\n            tempNormal += morph_weights_a[1] * morph_nrm1;\n            tempNormal += morph_weights_a[2] * morph_nrm2;\n            tempNormal += morph_weights_a[3] * morph_nrm3;\n        #endif\n        #ifdef MORPHING_NRM47\n            tempNormal += morph_weights_b[0] * morph_nrm4;\n            tempNormal += morph_weights_b[1] * morph_nrm5;\n            tempNormal += morph_weights_b[2] * morph_nrm6;\n            tempNormal += morph_weights_b[3] * morph_nrm7;\n        #endif\n    #endif\n\n    return normalize(dNormalMatrix * tempNormal);\n}\n\n",
normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\n\nvec3 blendNormals(vec3 n1, vec3 n2) {\n    // https://blog.selfshadow.com/publications/blending-in-detail/#detail-oriented\n    n1 += vec3(0, 0, 1);\n    n2 *= vec3(-1, -1, 1);\n    return normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\n\nvec3 addNormalDetail(vec3 normalMap) {\n    #ifdef MAPTEXTURE\n        vec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n        normalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n        return blendNormals(normalMap, normalDetailMap);\n    #else\n        return normalMap;\n    #endif\n}\n\n",
normalInstancedVS:"vec3 getNormal() {\n    dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n    dNormalMap = addNormalDetail(normalMap);\n    dNormalW = dTBN * dNormalMap;\n    #ifdef CLEARCOAT\n        ccNormalW = normalize(dVertexNormalW);\n    #endif\n}\n",
normalMapFastPS:"uniform sampler2D texture_normalMap;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = addNormalDetail(normalMap);\n    dNormalW = dTBN * dNormalMap;\n    #ifdef CLEARCOAT\n        ccNormalW = normalize(dVertexNormalW);\n    #endif\n}\n",normalSkinnedVS:"vec3 getNormal() {\n    dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n\n",
normalVertexPS:"void getNormal() {\n    dNormalW = normalize(dVertexNormalW);\n    #ifdef CLEARCOAT\n        ccNormalW = dNormalW;\n    #endif\n}\n\n",normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n    vec3 normal;\n    normal.xy = nmap.wy * 2.0 - 1.0;\n    normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n    return normal;\n}\n\n",normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n    return nmap.xyz * 2.0 - 1.0;\n}\n\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\n\nvoid getOpacity() {\n    dAlpha = 1.0;\n\n    #ifdef MAPFLOAT\n        dAlpha *= material_opacity;\n    #endif\n\n    #ifdef MAPTEXTURE\n        dAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        dAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n    #endif\n}\n\n",
outputAlphaPS:"gl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 encodeRGBM(vec4 color) { // modified RGBM\n    color.rgb = pow(color.rgb, vec3(0.5));\n    color.rgb *= 1.0 / 8.0;\n\n    color.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n    color.a = ceil(color.a * 255.0) / 255.0;\n\n    color.rgb /= color.a;\n    return color;\n}\n\nvoid main(void) {\n\n    vec2 st = vUv0 * 2.0 - 1.0;\n    float face = params.x;\n\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n\n    gl_FragColor = textureCube(source, vec);\n    if (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n\n",
outputTex2DPS:"varying vec2 vUv0;\n\nuniform sampler2D source;\n\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n\n",packDepthPS:"// Packing a float in GLSL with multiplication and mod\n// http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n\n\n",
packDepthMaskPS:"vec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res.x = 0.0;\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n\n",parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n    float parallaxScale = material_heightMapFactor;\n\n    float height = texture2D(texture_heightMap, $UV).$CH;\n    height = height * parallaxScale - parallaxScale*0.5;\n    vec3 viewDirT = dViewDirW * dTBN;\n\n    viewDirT.z += 0.42;\n    dUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n\n",
particlePS:"varying vec4 texCoordsAlphaLife;\n\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n\nuniform float softening;\nuniform float colorMult;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\n#endif\n\nvoid main(void) {\n    vec4 tex         = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n    vec4 ramp     = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n    ramp.rgb *= colorMult;\n\n    ramp.a += texCoordsAlphaLife.z;\n\n    vec3 rgb =     tex.rgb * ramp.rgb;\n    float a =         tex.a * ramp.a;\n",
particleVS:"\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a, b, c);\n}\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n   vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n   return pos;\n}\n\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n    vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n    return pos;\n}\n\nvec2 safeNormalize(vec2 v) {\n    float l = length(v);\n    return (l > 1e-06) ? v / l : v;\n}\n\nvoid main(void) {\n    vec3 meshLocalPos = particle_vertexData.xyz;\n    float id = floor(particle_vertexData.w);\n\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n    float uv = id / numParticlesPot;\n    readInput(uv);\n\n#ifdef LOCAL_SPACE\n    inVel = mat3(matrix_model) * inVel;\n#endif\n    vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n\n    float particleLifetime = lifetime;\n\n    if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n    vec2 quadXY = meshLocalPos.xy;\n    float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\n    vec3 paramDiv;\n    vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n\n#ifndef USE_MESH\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n    texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\n    vec3 particlePos = inPos;\n    vec3 particlePosMoved = vec3(0.0);\n\n    mat2 rotMatrix;\n",
particleAnimFrameClampVS:"\n    float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n\n",particleAnimFrameLoopVS:"\n    float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n\n",particleAnimTexVS:"\n    float animationIndex;\n\n    if (animTexIndexParams.y == 1.0) {\n        animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n    } else {\n        animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n    }\n\n    float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n    float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n    atlasX = fract(atlasX);\n\n    texCoordsAlphaLife.xy *= animTexTilesParams.xy;\n    texCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n\n",
particleInputFloatPS:"void readInput(float uv) {\n    vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\n    inPos = tex.xyz;\n    inVel = tex2.xyz;\n    inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n    inShow = tex.w >= 0.0;\n    inLife = tex2.w;\n}\n\n",particleInputRgba8PS:"//RG=X, BA=Y\n//RG=Z, BA=A\n//RGB=V, A=visMode\n//RGBA=life\n\n#define PI2 6.283185307179586\n\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\n\nuniform float maxVel;\n\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\n\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\n\nvoid readInput(float uv) {\n    vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n    vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n    vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\n    inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n    inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\n    inVel = tex2.xyz;\n    inVel = (inVel - vec3(0.5)) * maxVel;\n\n    inAngle = decodeFloatRG(tex1.ba) * PI2;\n    inShow = tex2.a > 0.5;\n\n    inLife = decodeFloatRGBA(tex3);\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n\n",
particleOutputFloatPS:"void writeOutput() {\n    if (gl_FragCoord.y<1.0) {\n        gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n    } else {\n        gl_FragColor = vec4(outVel, outLife);\n    }\n}\n\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\n\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\n\nvec4 encodeFloatRGBA( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n  return enc;\n}\n\nvoid writeOutput() {\n    //outPos = (outPos - outBoundsCenter) / outBoundsSize + vec3(0.5);\n\n    outPos = outPos * outBoundsMul + outBoundsAdd;\n    outAngle = fract(outAngle / PI2);\n\n    outVel = (outVel / maxVel) + vec3(0.5); // TODO: mul\n\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\n    if (gl_FragCoord.y < 1.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n    } else if (gl_FragCoord.y < 2.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n    } else if (gl_FragCoord.y < 3.0) {\n        gl_FragColor = vec4(outVel, visMode*0.5+0.5);\n    } else {\n        gl_FragColor = encodeFloatRGBA(outLife);\n    }\n}\n\n",
particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    vec3 pos = inBounds - vec3(0.5);\n\n    vec3 posAbs = abs(pos);\n    vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\n    vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\n    //pos = edge * mix(2.0 * pos, sign(pos), equal(maxPos, posAbs));\n    pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n    pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n    pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n\n#ifndef LOCAL_SPACE\n    return emitterPos + spawnBounds * pos;\n#else\n    return spawnBounds * pos;\n#endif\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity -= vec3(0, 0, initialVelocity);\n}\n\n",
particleUpdaterEndPS:"\n    writeOutput();\n}\n\n",particleUpdaterInitPS:"varying vec2 vUv0;\n\nuniform sampler2D particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform sampler2D internalTex3;\n\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\n\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\n\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\n\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\n\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",
particleUpdaterNoRespawnPS:"    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = -1.0;\n    }\n",particleUpdaterOnStopPS:"    visMode = outLife < 0.0? -1.0: visMode;\n\n",particleUpdaterRespawnPS:"    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = 1.0;\n    }\n    visMode = outLife < 0.0? 1.0: visMode;\n\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    float rnd4 = fract(rndFactor * 1000.0);\n    vec3 norm = normalize(inBounds.xyz - vec3(0.5));\n    float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n    return emitterPos + norm * r * spawnBoundsSphere;\n#else\n    return norm * r * spawnBoundsSphere;\n#endif\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n\n",
particleUpdaterStartPS:"float saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nvec3 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a.xyz, b.xyz, c);\n}\n\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n    vec4 p4 = fract(vec4(p) * HASHSCALE4);\n    p4 += dot(p4, p4.wzxy+19.19);\n    return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\n\n\nvoid main(void)\n{\n    if (gl_FragCoord.x > numParticles) discard;\n\n    readInput(vUv0.x);\n    visMode = inShow? 1.0 : -1.0;\n\n    vec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\n    float particleRate = rate + rateDiv * rndFactor.x;\n\n    outLife = inLife + delta;\n    float nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\n    vec3 localVelocityDiv;\n    vec3 velocityDiv;\n    vec3 paramDiv;\n    vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n    vec3 velocity =      tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n    vec3 params =        tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float rotSpeed = params.x;\n    float rotSpeedDiv = paramDiv.y;\n\n    vec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n    float radialSpeed = radialParams.x;\n    float radialSpeedDiv = radialParams.y;\n\n    bool respawn = inLife <= 0.0 || outLife >= lifetime;\n    inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n    inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n\n#ifndef LOCAL_SPACE\n    vec3 radialVel = inPos - emitterPos;\n#else\n    vec3 radialVel = inPos;\n#endif\n    radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n    radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\n    localVelocity +=    (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n    velocity +=         (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n    rotSpeed +=         (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\n    addInitialVelocity(localVelocity, rndFactor.xyz);\n\n#ifndef LOCAL_SPACE\n    outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n    outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\n    outPos = inPos + outVel * delta;\n    outAngle = inAngle + rotSpeed * delta;\n",
particle_billboardVS:"\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY);\n\n",particle_blendAddPS:"\n    rgb *= saturate(gammaCorrectInput(a));\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n\n",particle_blendMultiplyPS:"\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n\n",particle_blendNormalPS:"\n    if (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;     // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;     // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;     // XYZ = particle local pos, W = velocity.y\nattribute float particle_vertexData4;     // particle id\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;     // VDATA4TYPE depends on useMesh property. Start with X = velocity.z, Y = particle ID and for mesh particles proceeds with Z = mesh UV.x, W = mesh UV.y\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\n//uniform float graphSampleSize;\n//uniform float graphNumSamples;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform vec3 emitterPos;\n\nvarying vec4 texCoordsAlphaLife;\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n    return pos;\n}\n\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n    return pos;\n}\n\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 inPos = particlePos;\n    vec3 vertPos = particle_vertexData3.xyz;\n    vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\n    float id = floor(particle_vertexData4);\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n#ifdef LOCAL_SPACE\n    inVel = mat3(matrix_model) * inVel;\n#endif\n    vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n\n    vec2 quadXY = vertPos.xy;\n    \n#ifndef USE_MESH\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#else\n    texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#endif\n    mat2 rotMatrix;\n\n    float inAngle = particle_vertexData2.x;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData3.xyz;\n\n",
particle_cpu_endVS:"\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"    rgb = addFog(rgb);\n    rgb = toneMap(rgb);\n    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n",
particle_halflambertPS:"\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n\n\n",particle_initVS:"attribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n#ifdef USE_MESH\nattribute vec2 particle_uv;         // mesh UV\n#endif\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n\nvarying vec4 texCoordsAlphaLife;\n\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n\n",
particle_lambertPS:"\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n\n\n",particle_lightingPS:"\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\n\n    rgb *= light;\n\n\n",particle_localShiftVS:"    particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n\n",particle_meshVS:"\n    vec3 localPos = meshLocalPos;\n    localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\n    billboard(particlePos, quadXY);\n\n\n",
particle_normalVS:"\n    Normal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n    vec3 normalMap         = normalize( texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0 );\n    vec3 normal = ParticleMat * normalMap;\n\n\n\n\n",particle_pointAlongVS:"    inAngle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n\n",particle_softPS:"\n    float depth = getLinearScreenDepth();\n    float particleDepth = vDepth;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n",
particle_softVS:"\n    vDepth = getLinearDepth(localPos);\n",particle_stretchVS:"    vec3 moveDir = inVel * stretch;\n    vec3 posPrev = particlePos - moveDir;\n    posPrev += particlePosMoved;\n\n    vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\n    float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\n    particlePos = mix(particlePos, posPrev, interpolation);\n\n",particle_TBNVS:"\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0,        rotMatrix[1][0], rotMatrix[1][1], 0.0,        0.0, 0.0, 1.0);\n    ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n\n",
particle_wrapVS:"\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_model[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_model[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n\n\n",precisionTestPS:"void main(void) {\n    gl_FragColor = vec4(2147483648.0);\n}\n\n",precisionTest2PS:"uniform sampler2D source;\n\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n\nvoid main(void) {\n    float c = texture2D(source, vec2(0.0)).r;\n    float diff = abs(c - 2147483648.0) / 2147483648.0;\n    gl_FragColor = packFloat(diff);\n}\n\n",
prefilterCubemapPS:"varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat rnd(vec2 uv) {\n    return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\n\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) { // cos + lerped cone size (better than just lerped)\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = sqrt(1.0 - uv.x);\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\n\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return vecSpace * sampleDir;\n}\n\nmat3 matrixFromVector(vec3 n) { // frisvad\n    float a = 1.0 / (1.0 + n.z);\n    float b = -n.x * n.y * a;\n    vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n    vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3(b1, b2, n);\n}\n\nvec4 encodeRGBM(vec3 color) { // modified RGBM\n    vec4 encoded;\n    encoded.rgb = pow(color.rgb, vec3(0.5));\n    encoded.rgb *= 1.0 / 8.0;\n\n    encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n    encoded.a = ceil(encoded.a * 255.0) / 255.0;\n\n    encoded.rgb /= encoded.a;\n    return encoded;\n}\n\nvoid main(void) {\n\n    vec2 st = vUv0 * 2.0 - 1.0;\n\n    if (params.w==1.0 || params.w==3.0) {\n        st = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n    }\n\n    float face = params.x;\n\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n\n    mat3 vecSpace = matrixFromVector(normalize(vec));\n\n    vec3 color = vec3(0.0);\n    const int samples = $NUMSAMPLES;\n    vec3 vect;\n    for(int i=0; i<samples; i++) {\n        float sini = sin(float(i));\n        float cosi = cos(float(i));\n        float rand = rnd(vec2(sini, cosi));\n\n        vect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\n        color += $textureCube(source, vect).rgb;\n    }\n    color /= float(samples);\n\n    gl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n",
reflDirPS:"void getReflDir() {\n    dReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n    #ifdef CLEARCOAT\n        ccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n    #endif    \n}\n\n",reflDirAnisoPS:"void getReflDir() {\n    float roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n    float anisotropy = material_anisotropy * roughness;\n    vec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n    vec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n    vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n    vec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n    dReflDirW = reflect(-dViewDirW, bentNormal);\n    #ifdef CLEARCOAT\n        ccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n    #endif    \n}\n\n",
reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {    \n    ccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity); \n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n    lookupVec.x *= -1.0;\n    return $textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionDpAtlasPS:"uniform sampler2D texture_sphereMap;\n\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n\n    vec4 rect;\n    float sx = saturate(mip - 2.0);\n    rect.x = sx * 0.5;\n\n    float t = mip - rect.x * 6.0;\n    float i = 1.0 - rect.x;\n    rect.y = min(t * 0.5, 0.75) * i + rect.x;\n\n    float st = saturate(t);\n    rect.z = (1.0 - st * 0.5) * i;\n    rect.w = rect.z * 0.5;\n\n    float rcRectZ = 1.0 / rect.z;\n    float scaleFactor = 0.00390625 * rcRectZ; // 0.0078125 = (256 + 2) / 256 - 1, 0.00390625 same for 512\n    vec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n    uv = uv * (vec2(1.0) - scale) + scale * 0.5;\n\n    uv = uv * rect.zw + rect.xy;\n\n    return uv;\n}\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 reflDir = normalize(cubeMapProject(tReflDirW));\n\n    // Convert vector to DP coords\n    bool up = reflDir.y > 0.0;\n    float scale = 0.90909090909090909090909090909091;// 1.0 / 1.1;\n    vec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n    float reflDirVer = abs(reflDir.y) + 1.0;\n    reflDirWarp /= reflDirVer;\n    reflDirWarp *= scale;\n    reflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n    vec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n\n    float bias = saturate(1.0 - tGlossiness) * 5.0; // multiply by max mip level\n\n    float mip = floor(bias);\n    vec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\n    mip = min(mip + 1.0, 5.0);\n    vec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\n    tex1 = mix(tex1, tex2, fract(bias));\n    tex1 = processEnvironment(tex1);\n\n    return tex1;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionPrefilteredCubePS:"uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    // Unfortunately, WebGL doesn't allow us using textureCubeLod. Therefore bunch of nasty workarounds is required.\n    // We fix mip0 to 128x128, so code is rather static.\n    // Mips smaller than 4x4 aren't great even for diffuse. Don't forget that we don't have bilinear filtering between different faces.\n\n    float bias = saturate(1.0 - tGlossiness) * 5.0; // multiply by max mip level\n    int index1 = int(bias);\n    int index2 = int(min(bias + 1.0, 7.0));\n\n    vec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n\n    vec4 cubes[6];\n    cubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n    cubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n    cubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n    cubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n    cubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n    cubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n\n    // Also we don't have dynamic indexing in PS, so...\n    vec4 cube[2];\n    for(int i = 0; i < 6; i++) {\n        if (i == index1) {\n            cube[0] = cubes[i];\n        }\n        if (i == index2) {\n            cube[1] = cubes[i];\n        }\n    }\n\n    // another variant\n    /*if (index1==0){ cube[0]=cubes[0];\n    }else if (index1==1){ cube[0]=cubes[1];\n    }else if (index1==2){ cube[0]=cubes[2];\n    }else if (index1==3){ cube[0]=cubes[3];\n    }else if (index1==4){ cube[0]=cubes[4];\n    }else if (index1==5){ cube[0]=cubes[5];}\n\n    if (index2==0){ cube[1]=cubes[0];\n    }else if (index2==1){ cube[1]=cubes[1];\n    }else if (index2==2){ cube[1]=cubes[2];\n    }else if (index2==3){ cube[1]=cubes[3];\n    }else if (index2==4){ cube[1]=cubes[4];\n    }else if (index2==5){ cube[1]=cubes[5];}*/\n\n    vec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n    vec3 refl = processEnvironment($DECODE(cubeFinal).rgb);\n\n    return refl;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionPrefilteredCubeLodPS:"\n#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    float bias = saturate(1.0 - tGlossiness) * 5.0; // multiply by max mip level\n    vec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n\n    vec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n\n    return refl;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\n    return $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\n\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n    vec3 reflDirV = vNormalV;\n\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    return $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\n\nuniform float material_reflectivity;\nvoid addReflection() {   \n    dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\n\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n    float vn = dot(viewVec, Normal);\n    float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n    vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n    return refrVec;\n}\n\nvoid addRefraction() {\n\n    // use same reflection code with refraction vector\n    vec3 tmp = dReflDirW;\n    vec4 tmp2 = dReflection;\n    dReflection = vec4(0.0);\n    dReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\n    addReflection();\n\n    dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n    dReflDirW = tmp;\n    dReflection = tmp2;\n}\n\n",
rgbmPS:"vec3 decodeRGBM(vec4 rgbm) {\n    vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n    return color * color;\n}\n\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\n\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n    return decodeRGBM(textureCube(tex, uvw));\n}\n\n",screenDepthPS:"uniform sampler2D uDepthMap;\n\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params; // 1 / camera_far,      camera_far,     (1 - f / n) / 2,        (1 + f / n) / 2\n#endif\n\n#ifdef GL2\n    float linearizeDepth(float z) {\n        z = z * 2.0 - 1.0;\n        return 1.0 / (camera_params.z * z + camera_params.w);\n    }\n#else\n    #ifndef UNPACKFLOAT\n    #define UNPACKFLOAT\n    float unpackFloat(vec4 rgbaDepth) {\n        const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n        return dot(rgbaDepth, bitShift);\n    }\n    #endif\n#endif\n\n// Retrieves rendered linear camera depth by UV\nfloat getLinearScreenDepth(vec2 uv) {\n    #ifdef GL2\n        return linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n    #else\n        return unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n    #endif\n}\n\n#ifndef VERTEXSHADER\n// Retrieves rendered linear camera depth under the current pixel\nfloat getLinearScreenDepth() {\n    vec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n    return getLinearScreenDepth(uv);\n}\n#endif\n\n// Generates linear camera depth for the given world position\nfloat getLinearDepth(vec3 pos) {\n    return -(matrix_view * vec4(pos, 1.0)).z;\n}\n",
shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n    float distScale = length(dLightDirW);\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale; //0.02\n    vec3 dir = wPos - dLightPosW;\n    dLightDirW = dir;\n}\n\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    dShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\n\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xy /= projPos.w;\n    dShadowCoord.xy = projPos.xy;\n    dShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\n\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n\n",
shadowCoordVS:"void getLightDirPoint(vec3 lightPosW) {\n    vec3 lightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(lightDirW);\n    dLightPosW = lightPosW;\n}\n\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\n\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\n\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n\n",
shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xyz /= projPos.w;\n    dShadowCoord = projPos.xyz;\n    // depth bias is already applied on render\n}\n\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n\n",
shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec3 moments = texture2D(tex, texCoords).xyz;\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\n\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n\n",
shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    float pixelSize = 1.0 / resolution;\n    texCoords -= vec2(pixelSize);\n    vec3 s00 = texture2D(tex, texCoords).xyz;\n    vec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n    vec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n    vec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n    vec2 fr = fract(texCoords * resolution);\n    vec3 h0 = mix(s00, s10, fr.x);\n    vec3 h1 = mix(s01, s11, fr.x);\n    vec3 moments = mix(h0, h1, fr.y);\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\n\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n\n",
shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n#endif\n\n// ----- Direct/Spot Sampling -----\n\n#ifdef GL2\n    float _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        float z = dShadowCoord.z;\n        vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n        float shadowMapSizeInv = 1.0 / shadowParams.x;\n        vec2 base_uv = floor(uv + 0.5);\n        float s = (uv.x + 0.5 - base_uv.x);\n        float t = (uv.y + 0.5 - base_uv.y);\n        base_uv -= vec2(0.5);\n        base_uv *= shadowMapSizeInv;\n\n        float sum = 0.0;\n\n        float uw0 = (3.0 - 2.0 * s);\n        float uw1 = (1.0 + 2.0 * s);\n\n        float u0 = (2.0 - s) / uw0 - 1.0;\n        float u1 = s / uw1 + 1.0;\n\n        float vw0 = (3.0 - 2.0 * t);\n        float vw1 = (1.0 + 2.0 * t);\n\n        float v0 = (2.0 - t) / vw0 - 1.0;\n        float v1 = t / vw1 + 1.0;\n\n        u0 = u0 * shadowMapSizeInv + base_uv.x;\n        v0 = v0 * shadowMapSizeInv + base_uv.y;\n\n        u1 = u1 * shadowMapSizeInv + base_uv.x;\n        v1 = v1 * shadowMapSizeInv + base_uv.y;\n\n        sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n        sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n        sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n        sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\n        sum *= 1.0f / 16.0;\n        return sum;\n    }\n\n    float getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n\n    float getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#else\n    float _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n        mat3 shadowKernel;\n        vec3 shadowCoord = dShadowCoord;\n        vec3 shadowZ = vec3(shadowCoord.z);\n        shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n        shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n        shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\n        vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\n        shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n        shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n        vec4 shadowValues;\n        shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n        shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n        shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n        shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n        return dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n    }\n\n    float _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        vec3 shadowCoord = dShadowCoord;\n\n        float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n        float dx0 = -xoffset;\n        float dx1 = xoffset;\n\n        mat3 depthKernel;\n        depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n        depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n        depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n        depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n        depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n        depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n        depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n        depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n        depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\n        return _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n    }\n\n    float getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n\n    float getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#endif\n\n\n// ----- Point Sampling -----\n\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\n    vec3 tc = normalize(dir);\n    vec3 tcAbs = abs(tc);\n\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n\n    float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n\n    mat3 shadowKernel;\n    mat3 depthKernel;\n\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\n    vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\n    vec2 fractionalCoord = fract( uv * shadowParams.x );\n\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n    return _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n\n",
shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    // http://the-witness.net/news/2013/09/shadow-mapping-summary-part-1/\n\n    float z = dShadowCoord.z;\n    vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n    float shadowMapSizeInv = 1.0 / shadowParams.x;\n    vec2 base_uv = floor(uv + 0.5);\n    float s = (uv.x + 0.5 - base_uv.x);\n    float t = (uv.y + 0.5 - base_uv.y);\n    base_uv -= vec2(0.5);\n    base_uv *= shadowMapSizeInv;\n\n\n    float uw0 = (4.0 - 3.0 * s);\n    float uw1 = 7.0;\n    float uw2 = (1.0 + 3.0 * s);\n\n    float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n    float u1 = (3.0 + s) / uw1;\n    float u2 = s / uw2 + 2.0;\n\n    float vw0 = (4.0 - 3.0 * t);\n    float vw1 = 7.0;\n    float vw2 = (1.0 + 3.0 * t);\n\n    float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n    float v1 = (3.0 + t) / vw1;\n    float v2 = t / vw2 + 2.0;\n\n    float sum = 0.0;\n\n    u0 = u0 * shadowMapSizeInv + base_uv.x;\n    v0 = v0 * shadowMapSizeInv + base_uv.y;\n\n    u1 = u1 * shadowMapSizeInv + base_uv.x;\n    v1 = v1 * shadowMapSizeInv + base_uv.y;\n\n    u2 = u2 * shadowMapSizeInv + base_uv.x;\n    v2 = v2 * shadowMapSizeInv + base_uv.y;\n\n    sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n    sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n    sum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\n    sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n    sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n    sum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\n    sum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n    sum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n    sum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\n    sum *= 1.0f / 144.0;\n\n    sum = gammaCorrectInput(sum); // gives softer gradient\n    sum = saturate(sum);\n\n    return sum;\n}\n\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\n\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",
shadowStandardGL2VSPS:"float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001; // prevent going to dark after the far plane\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\n\n",shadowStandardVSPS:"#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\n\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n\n    return _getShadowPCF3x3(shadowMap, shadowParams);\n}\n\n",
shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * Z;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\n\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\n\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec4 c = texture2D(tex, texCoords);\n    vec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n    return calculateVSM8(moments, Z, vsmBias);\n}\n\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\n\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",
shadowVSMVSPS:"float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z += shadowParams.z;\n    dShadowCoord.xyz /= vMainShadowUv.w;\n    dShadowCoord.z = min(dShadowCoord.z, 1.0);\n\n    return $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n    return saturate((v - a) / (b - a));\n}\n\nfloat reduceLightBleeding(float pMax, float amount) {\n  // Remove the [0, amount] tail and linearly rescale (amount, 1].\n   return linstep(amount, 1.0, pMax);\n}\n\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n    // Compute variance\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, minVariance);\n\n    // Compute probabilistic upper bound\n    float d = mean - moments.x;\n    float pMax = variance / (variance + (d * d));\n\n    pMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\n    // One-tailed Chebyshev\n    return (mean <= moments.x ? 1.0 : pMax);\n}\n\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n    Z = 2.0 * Z - 1.0;\n    float warpedDepth = exp(exponent * Z);\n\n    moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * exponent * warpedDepth;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n\n",
skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i) {\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n\n    y = dy * (y + 0.5);\n\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n\n    mat4 bone = mat4(v1, v2, v3, v4);\n\n    return bone;\n}\n\n",
skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform mat4 matrix_pose[BONE_LIMIT];\n\nmat4 getBoneMatrix(const in float i)\n{\n    mat4 bone = matrix_pose[int(i)];\n\n    return bone;\n}\n\n",skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform highp sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\n\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n\n    y = dy * (y + 0.5);\n\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n\n    mat4 bone = mat4(v1, v2, v3, v4);\n\n    return bone;\n}\n\n",
skyboxPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    gl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n\n",skyboxVS:"attribute vec3 aPosition;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform mat4 matrix_projectionSkybox;\n\nvarying vec3 vViewDir;\n\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\n    // Force skybox to far Z, regardless of the clip planes on the camera\n    // Subtract a tiny fudge factor to ensure floating point errors don't\n    // still push pixels beyond far Z. See:\n    // http://www.opengl.org/discussion_boards/showthread.php/171867-skybox-problem\n\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n    vViewDir.x *= -1.0;\n}\n\n",
skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    vec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(vViewDir, $FIXCONST)).rgb);\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n\n",skyboxPrefilteredCubePS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvoid main(void) {\n    vec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n\n",
specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n\n#ifdef CLEARCOAT\nuniform float material_clearCoatSpecularity;\n#endif\n\nvoid getSpecularity() {\n    dSpecularity = vec3(1.0);\n\n    #ifdef MAPCOLOR\n        dSpecularity *= material_specular;\n    #endif\n\n    #ifdef MAPTEXTURE\n        dSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n    #endif\n\n    #ifdef MAPVERTEX\n        dSpecularity *= saturate(vVertexColor.$VC);\n    #endif\n\n    #ifdef CLEARCOAT\n        ccSpecularity = vec3(1.0);\n        ccSpecularity *= material_clearCoatSpecularity;\n    #endif\n}\n\n",
specularAaNonePS:"float antiAliasGlossiness(float power) {\n    return power;\n}\n\n",specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * mix(1.0, toksvig, material_bumpiness);\n}\n\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * toksvig;\n}\n\n",
spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(dLightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n\n",startPS:"\nvoid main(void) {\n    dDiffuseLight = vec3(0);\n    dSpecularLight = vec3(0);\n    dReflection = vec4(0);\n    dSpecularity = vec3(0);\n    #ifdef CLEARCOAT\n        ccSpecularLight = vec3(0);\n        ccReflection = vec4(0);\n        ccSpecularity = vec3(0);\n    #endif\n    ",
startVS:"\nvoid main(void) {\n    gl_Position = getPosition();\n",startNineSlicedPS:"    nineSlicedUv = vUv0;\n\n",startNineSlicedTiledPS:"\n    vec2 tileMask = step(vMask, vec2(0.99999));\n    vec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\n    clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n    nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\n",storeEVSMPS:"float exponent = VSM_EXPONENT;\n\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n\n",
tangentBinormalVS:"\nvec3 getTangent() {\n    return normalize(dNormalMatrix * vertex_tangent.xyz);\n}\n\nvec3 getBinormal() {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n\nvec3 getObjectSpaceUp() {\n    return normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n\n",TBNPS:"void getTBN() {\n    dTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n\n",TBNderivativePS:"// http://www.thetenthplanet.de/archives/1180\nvoid getTBN() {\n    vec2 uv = $UV;\n\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( vPositionW );\n    vec3 dp2 = dFdy( vPositionW );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, dVertexNormalW );\n    vec3 dp1perp = cross( dVertexNormalW, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n    // construct a scale-invariant frame\n    float invmax = 1.0 / sqrt( max( dot(T,T), dot(B,B) ) );\n    dTBN = mat3( T * invmax, B * invmax, dVertexNormalW );\n}\n\n",
TBNfastPS:"void getTBN() {\n    dTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n\n",TBNObjectSpacePS:"void getTBN() {\n\n    vec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n    vec3 T = cross(dVertexNormalW, B);\n\n    if (dot(B,B)==0.0) // deal with case when vObjectSpaceUpW dVertexNormalW are parallel\n    {\n        float major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\n        if (dVertexNormalW.x==major)\n        {\n            B=cross(dVertexNormalW, vec3(0,1,0));\n            T=cross(dVertexNormalW, B);\n        }\n        else if (dVertexNormalW.y==major)\n        {\n            B=cross(dVertexNormalW, vec3(0,0,1));\n            T=cross(dVertexNormalW, B);\n        }\n        else if (dVertexNormalW.z==major)\n        {\n            B=cross(dVertexNormalW, vec3(1,0,0));\n            T=cross(dVertexNormalW, B);\n        }\n    }\n\n    dTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n\n",
tonemappingAcesPS:"uniform float exposure;\n\nvec3 toneMap(vec3 color) {\n    float tA = 2.51;\n    float tB = 0.03;\n    float tC = 2.43;\n    float tD = 0.59;\n    float tE = 0.14;\n    vec3 x = color * exposure;\n    return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\n\n// ACES approximation by Stephen Hill\n\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst mat3 ACESInputMat = mat3(\n    0.59719, 0.35458, 0.04823,\n    0.07600, 0.90834, 0.01566,\n    0.02840, 0.13383, 0.83777\n);\n\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst mat3 ACESOutputMat = mat3(\n     1.60475, -0.53108, -0.07367,\n    -0.10208,  1.10813, -0.00605,\n    -0.00327, -0.07276,  1.07602\n);\n\nvec3 RRTAndODTFit(vec3 v) {\n    vec3 a = v * (v + 0.0245786) - 0.000090537;\n    vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n    return a / b;\n}\n\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    color = color * ACESInputMat;\n\n    // Apply RRT and ODT\n    color = RRTAndODTFit(color);\n    color = color * ACESOutputMat;\n\n    // Clamp to [0, 1]\n    color = clamp(color, 0.0, 1.0);\n\n    return color;\n}\n",
tonemappingFilmicPS:"const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\n\nuniform float exposure;\n\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\n\nvec3 toneMap(vec3 color) {\n    color = uncharted2Tonemap(color * exposure);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n    color = color * whiteScale;\n\n    return color;\n}\n\n",
tonemappingHejlPS:"uniform float exposure;\n\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n    const float Scl = 1.25;\n\n    vec3 h = max( vec3(0.0), color - vec3(0.004) );\n    return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n\n",tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n    return color * exposure;\n}\n\n",
tonemappingNonePS:"vec3 toneMap(vec3 color) {\n    return color;\n}\n\n",transformVS:"#ifdef PIXELSNAP\n    uniform vec4 uScreenSize;\n#endif\n\n#ifdef MORPHING\n    uniform vec4 morph_weights_a;\n    uniform vec4 morph_weights_b;\n#endif\n\nmat4 getModelMatrix() {\n    #ifdef DYNAMICBATCH\n        return getBoneMatrix(vertex_boneIndices);\n    #elif defined(SKIN)\n        return matrix_model * (getBoneMatrix(vertex_boneIndices.x) * vertex_boneWeights.x +\n               getBoneMatrix(vertex_boneIndices.y) * vertex_boneWeights.y +\n               getBoneMatrix(vertex_boneIndices.z) * vertex_boneWeights.z +\n               getBoneMatrix(vertex_boneIndices.w) * vertex_boneWeights.w);\n    #elif defined(INSTANCING)\n        return mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n    #else\n        return matrix_model;\n    #endif\n}\n\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec3 localPos = vertex_position;\n\n    #ifdef NINESLICED\n        // outer and inner vertices are at the same position, scale both\n        localPos.xz *= outerScale;\n\n        // offset inner vertices inside\n        // (original vertices must be in [-1;1] range)\n        vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n        vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n        localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\n        vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner\n\n        localPos.xz *= -0.5; // move from -1;1 to -0.5;0.5\n        localPos = localPos.xzy;\n    #endif\n\n    #ifdef MORPHING\n        #ifdef MORPHING_POS03\n            localPos.xyz += morph_weights_a[0] * morph_pos0;\n            localPos.xyz += morph_weights_a[1] * morph_pos1;\n            localPos.xyz += morph_weights_a[2] * morph_pos2;\n            localPos.xyz += morph_weights_a[3] * morph_pos3;\n        #endif\n        #ifdef MORPHING_POS47\n            localPos.xyz += morph_weights_b[0] * morph_pos4;\n            localPos.xyz += morph_weights_b[1] * morph_pos5;\n            localPos.xyz += morph_weights_b[2] * morph_pos6;\n            localPos.xyz += morph_weights_b[3] * morph_pos7;\n        #endif\n    #endif\n\n    vec4 posW = dModelMatrix * vec4(localPos, 1.0);\n    #ifdef SCREENSPACE\n        posW.zw = vec2(0.0, 1.0);\n    #endif\n    dPositionW = posW.xyz;\n\n    vec4 screenPos;\n    #ifdef UV1LAYOUT\n        screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n    #else\n        #ifdef SCREENSPACE\n            screenPos = posW;\n        #else\n            screenPos = matrix_viewProjection * posW;\n        #endif\n\n        #ifdef PIXELSNAP\n            // snap vertex to a pixel boundary\n            screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n            screenPos.xy *= uScreenSize.xy;\n            screenPos.xy = floor(screenPos.xy);\n            screenPos.xy *= uScreenSize.zw;\n            screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n        #endif\n    #endif\n\n    return screenPos;\n}\n\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n",
transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\n\n",uv0VS:"#ifdef NINESLICED\nvec2 getUv0() {\n    vec2 uv = vertex_position.xz;\n\n    // offset inner vertices inside\n    // (original vertices must be in [-1;1] range)\n    vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n    vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n    uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\n    uv = uv * -0.5 + 0.5;\n    uv = uv * atlasRect.zw + atlasRect.xy;\n\n    vMask = vertex_texCoord0.xy;\n\n    return uv;\n}\n#else\nvec2 getUv0() {\n    return vertex_texCoord0;\n}\n#endif\n\n",
uv1VS:"\nvec2 getUv1() {\n    return vertex_texCoord1;\n}\n",viewDirPS:"void getViewDir() {\n    dViewDirW = normalize(view_position - vPositionW);\n}\n\n",viewNormalVS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nvec3 getViewNormal() {\n    return mat3(matrix_view) * vNormalW;\n}\n"},eo={vertex_position:"POSITION",vertex_normal:"NORMAL",vertex_tangent:"TANGENT",vertex_texCoord0:"TEXCOORD0",vertex_texCoord1:"TEXCOORD1",vertex_texCoord2:"TEXCOORD2",vertex_texCoord3:"TEXCOORD3",
vertex_texCoord4:"TEXCOORD4",vertex_texCoord5:"TEXCOORD5",vertex_texCoord6:"TEXCOORD6",vertex_texCoord7:"TEXCOORD7",vertex_color:"COLOR",vertex_boneIndices:"BLENDINDICES",vertex_boneWeights:"BLENDWEIGHT"};K.collectAttribs=function(a){for(var b={},c=0,d=a.indexOf("attribute");0<=d&&!(0<d&&"/"===a[d-1]);){var e=a.indexOf(";",d),g=a.lastIndexOf(" ",e);e=a.substr(g+1,e-(g+1));g=eo[e];void 0!==g?b[e]=g:(b[e]="ATTR"+c,c++);d=a.indexOf("attribute",d+1)}return b};K.createShader=function(a,b,c,d){b=K[b];c=
aa.precisionCode(a)+"\n"+K[c];var e=this.collectAttribs(b);a.webgl2&&(b=aa.versionCode(a)+this.gles3VS+b,c=aa.versionCode(a)+this.gles3PS+c);return new Qd(a,{attributes:e,vshader:b,fshader:c,useTransformFeedback:d})};K.createShaderFromCode=function(a,b,c,d,e){var g=a.programLib._cache,k=g[d];if(void 0!==k)return k;c=aa.precisionCode(a)+"\n"+(c||aa.dummyFragmentCode());k=this.collectAttribs(b);a.webgl2&&(b=aa.versionCode(a)+this.gles3VS+b,c=aa.versionCode(a)+this.gles3PS+c);g[d]=new Qd(a,{attributes:k,
vshader:b,fshader:c,useTransformFeedback:e});return g[d]};Object.defineProperties(L.prototype,{minFilter:{get:function(){return this._minFilter},set:function(a){this._minFilter!==a&&(this._minFilter=a,this._parameterFlags|=1)}},magFilter:{get:function(){return this._magFilter},set:function(a){this._magFilter!==a&&(this._magFilter=a,this._parameterFlags|=2)}},addressU:{get:function(){return this._addressU},set:function(a){this._addressU!==a&&(this._addressU=a,this._parameterFlags|=4)}},addressV:{get:function(){return this._addressV},
set:function(a){this._addressV!==a&&(this._addressV=a,this._parameterFlags|=8)}},addressW:{get:function(){return this._addressW},set:function(a){this.device.webgl2&&this._volume&&a!==this._addressW&&(this._addressW=a,this._parameterFlags|=16)}},compareOnRead:{get:function(){return this._compareOnRead},set:function(a){this._compareOnRead!==a&&(this._compareOnRead=a,this._parameterFlags|=32)}},compareFunc:{get:function(){return this._compareFunc},set:function(a){this._compareFunc!==a&&(this._compareFunc=
a,this._parameterFlags|=64)}},anisotropy:{get:function(){return this._anisotropy},set:function(a){this._anisotropy!==a&&(this._anisotropy=a,this._parameterFlags|=128)}},autoMipmap:{get:function(){return this._mipmaps},set:function(a){this._mipmaps=a}},mipmaps:{get:function(){return this._mipmaps},set:function(a){this._mipmaps!==a&&(this._mipmaps=a,this._minFilterDirty=!0,a&&(this._needsMipmapsUpload=!0))}},width:{get:function(){return this._width}},height:{get:function(){return this._height}},depth:{get:function(){return this._depth}},
format:{get:function(){return this._format}},cubemap:{get:function(){return this._cubemap}},gpuSize:{get:function(){return L.calcGpuSize(this._width,this._height,this._depth,this._format,this.pot&&(this._mipmaps||2===this._minFilter||3===this._minFilter||4===this._minFilter||5===this._minFilter)&&!(this._compressed&&1===this._levels.length),this._cubemap)}},volume:{get:function(){return this._volume}},flipY:{get:function(){return this._flipY},set:function(a){this._flipY!==a&&(this._flipY=a,this._needsUpload=
!0)}},premultiplyAlpha:{get:function(){return this._premultiplyAlpha},set:function(a){this._premultiplyAlpha!==a&&(this._premultiplyAlpha=a,this._needsUpload=!0)}},pot:{get:function(){return pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height)}}});var Bg=null,Wa=null;Object.assign(L,{calcGpuSize:function(a,b,c,d,e,g){Bg||(Bg=[1,1,1,2,2,2,4,4,,,,8,8,16,16,4,4,4,4,4,4]);Wa||(Wa=[],Wa[21]=8,Wa[22]=8,Wa[24]=8,Wa[25]=8,Wa[26]=8,Wa[27]=8,Wa[8]=8,Wa[29]=8,Wa[23]=16,Wa[9]=16,Wa[10]=16,Wa[28]=
16,Wa[30]=16);for(var k=Bg.hasOwnProperty(d)?Bg[d]:0,f=Wa.hasOwnProperty(d)?Wa[d]:0,h=0;;){if(0<k)h+=a*b*c*k;else{var p=Math.floor((a+3)/4),n=Math.floor((b+3)/4),m=Math.floor((c+3)/4);if(24===d||25===d)p=Math.floor(p/2,1);h+=p*n*m*f}if(!e||1===a&&1===b&&1===c)break;a=Math.max(Math.floor(a/2),1);b=Math.max(Math.floor(b/2),1);c=Math.max(Math.floor(c/2),1)}return h*(g?6:1)}});Object.assign(L.prototype,{destroy:function(){this.device&&this.device.destroyTexture(this);this._levels=this.device=null},dirtyAll:function(){this._levelsUpdated=
this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0];this._needsUpload=!0;this._needsMipmapsUpload=this._mipmaps;this._mipmapsUploaded=!1;this._parameterFlags=255},lock:function(a){a=a||{level:0,face:0,mode:2};void 0===a.level&&(a.level=0);void 0===a.face&&(a.face=0);void 0===a.mode&&(a.mode=2);this._lockedLevel=a.level;if(null===this._levels[a.level])switch(this._format){case 0:case 1:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth);break;case 2:this._levels[a.level]=new Uint8Array(this._width*
this._height*this._depth*2);break;case 3:case 4:case 5:this._levels[a.level]=new Uint16Array(this._width*this._height*this._depth);break;case 6:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case 7:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case 8:this._levels[a.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case 9:case 10:this._levels[a.level]=new Uint8Array(Math.floor((this._width+
3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case 11:this._levels[a.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case 13:this._levels[a.level]=new Float32Array(this._width*this._height*this._depth*3);break;case 12:this._levels[a.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case 14:this._levels[a.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[a.level]},setSource:function(a,b){var c,d=!1;b=b||0;if(this._cubemap){if(a[0]){var e=
a[0].width||0;var g=a[0].height||0;for(c=0;6>c;c++){var k=a[c];if(!k||k.width!==e||k.height!==g||!("undefined"!==typeof HTMLImageElement&&k instanceof HTMLImageElement||"undefined"!==typeof HTMLCanvasElement&&k instanceof HTMLCanvasElement||"undefined"!==typeof HTMLVideoElement&&k instanceof HTMLVideoElement)){d=!0;break}}}else d=!0;if(!d)for(c=0;6>c;c++)this._levels[b][c]!==a[c]&&(this._levelsUpdated[b][c]=!0)}else"undefined"!==typeof HTMLImageElement&&a instanceof HTMLImageElement||"undefined"!==
typeof HTMLCanvasElement&&a instanceof HTMLCanvasElement||"undefined"!==typeof HTMLVideoElement&&a instanceof HTMLVideoElement||(d=!0),d||(a!==this._levels[b]&&(this._levelsUpdated[b]=!0),e=a.width,g=a.height);if(d)if(this._height=this._width=4,this._cubemap)for(c=0;6>c;c++)this._levels[b][c]=null,this._levelsUpdated[b][c]=!0;else this._levels[b]=null,this._levelsUpdated[b]=!0;else 0===b&&(this._width=e,this._height=g),this._levels[b]=a;this._invalid===d&&d||(this._invalid=d,this.upload())},getSource:function(a){return this._levels[a||
0]},unlock:function(){this.upload();this._lockedLevel=-1},upload:function(){this._needsUpload=!0;this._needsMipmapsUpload=this._mipmaps},getDds:function(){7!==this.format&&console.error("This format is not implemented yet");for(var a=128,b=0,c,d;this._levels[b];){if(this.cubemap)for(d=0;6>d;d++){if(!this._levels[b][d]){console.error("No level data for mip "+b+", face "+d);return}c=this._levels[b][d].length;if(!c){console.error("No byte array for mip "+b+", face "+d);return}a+=c}else{c=this._levels[b].length;
if(!c){console.error("No byte array for mip "+b);return}a+=c}a+=this._levels[b].length;b++}a=new ArrayBuffer(a);d=new Uint32Array(a,0,32);b=528391;1<this._levels.length&&(b|=131072);c=4096;1<this._levels.length&&(c|=4194304);if(1<this._levels.length||this.cubemap)c|=8;var e=this.cubemap?65024:0;d[0]=542327876;d[1]=124;d[2]=b;d[3]=this.height;d[4]=this.width;d[5]=this.width*this.height*4;d[6]=0;d[7]=this._levels.length;for(b=0;11>b;b++)d[8+b]=0;d[19]=32;d[20]=65;d[21]=0;d[22]=32;d[23]=16711680;d[24]=
65280;d[25]=255;d[26]=4278190080;d[27]=c;d[28]=e;d[29]=0;d[30]=0;d[31]=0;e=128;if(this.cubemap)for(d=0;6>d;d++)for(b=0;b<this._levels.length;b++){var g=this._levels[b][d];var k=new Uint8Array(a,e,g.length);for(c=0;c<g.length;c++)k[c]=g[c];e+=g.length}else for(b=0;b<this._levels.length;b++){g=this._levels[b];k=new Uint8Array(a,e,g.length);for(c=0;c<g.length;c++)k[c]=g[c];e+=g.length}return a}});Object.assign(Rb.prototype,{destroy:function(){var a=this.device,b=a.buffers.indexOf(this);-1!==b&&a.buffers.splice(b,
1);this.bufferId&&(this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null))},getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl;this.bufferId||(this.bufferId=a.createBuffer());switch(this.usage){case 0:var b=a.STATIC_DRAW;break;case 1:b=a.DYNAMIC_DRAW;break;case 2:b=a.STREAM_DRAW;
break;case 3:b=this.device.webgl2?a.DYNAMIC_COPY:a.STATIC_DRAW}a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.bufferId);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.storage,b)},setData:function(a){if(a.byteLength!==this.numBytes)return console.error("IndexBuffer: wrong initial data size: expected "+this.numBytes+", got "+a.byteLength),!1;this.storage=a;this.unlock();return!0},_lockTypedArray:function(){var a=this.lock();return 2===this.format?new Uint32Array(a):1===this.format?new Uint16Array(a):new Uint8Array(a)},
writeData:function(a,b){var c=this._lockTypedArray();if(a.length>b)if(ArrayBuffer.isView(a))a=a.subarray(0,b),c.set(a);else{var d;for(d=0;d<b;d++)c[d]=a[d]}else c.set(a);this.unlock()},readData:function(a){var b=this._lockTypedArray(),c=this.numIndices;if(ArrayBuffer.isView(a))a.set(b);else{a.length=0;var d;for(d=0;d<c;d++)a[d]=b[d]}return c}});var Nm=0;Object.assign(Ic.prototype,{initDefaults:function(){this.recreate=!1;this.indexCount=this.vertexCount=this.maxIndices=this.maxVertices=this.indicesUsage=
this.verticesUsage=0;this.indexStreamUpdated=this.vertexStreamsUpdated=!1;this.vertexStreamDictionary={};this.indices=null},_validateVertexCount:function(a,b){},_changeVertexCount:function(a,b){this.vertexCount?this._validateVertexCount(a,b):this.vertexCount=a}});Object.defineProperties(Ic,{DEFAULT_COMPONENTS_POSITION:{value:3},DEFAULT_COMPONENTS_NORMAL:{value:3},DEFAULT_COMPONENTS_UV:{value:2},DEFAULT_COMPONENTS_COLORS:{value:4}});Object.defineProperties(fb.prototype,{aabb:{get:function(){return this._aabb},
set:function(a){this._aabb=a}},refCount:{get:function(){return this._refCount}}});Object.assign(fb.prototype,{incReference:function(){this._refCount++},decReference:function(){this._refCount--},destroy:function(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);var a,b;for(a=0;a<this.indexBuffer.length;a++)(b=this.indexBuffer[a])&&b.destroy();this.indexBuffer.length=0;this._geometryData=null},_initBoneAabbs:function(a){this.boneAabb=[];this.boneUsed=[];var b=this.vertexBuffer.numVertices,
c,d,e=[],g=[],k=this.boneUsed,f=this.skin.boneNames.length,h,p,n;for(c=0;c<f;c++)e[c]=new r(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),g[c]=new r(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);var m=new Db(this.vertexBuffer),q=m.element.POSITION,u=m.element.BLENDWEIGHT,t=m.element.BLENDINDICES;for(c=0;c<b;c++){for(d=0;4>d;d++){var y=u.array[u.index+d];if(0<y){var w=t.array[t.index+d];k[w]=!0;var v=q.array[q.index];var x=q.array[q.index+1];var z=q.array[q.index+2];y=g[w];w=e[w];w.x>
v&&(w.x=v);w.y>x&&(w.y=x);w.z>z&&(w.z=z);y.x<v&&(y.x=v);y.y<x&&(y.y=x);y.z<z&&(y.z=z);if(a){v=h=v;x=p=x;var A=n=z;for(z=0;z<a.length;z++){var F=a[z];var Q=F.deltaPositions[3*c];var D=F.deltaPositions[3*c+1];F=F.deltaPositions[3*c+2];0>Q?v+=Q:h+=Q;0>D?x+=D:p+=D;0>F?A+=F:n+=F}w.x>v&&(w.x=v);w.y>x&&(w.y=x);w.z>A&&(w.z=A);y.x<h&&(y.x=h);y.y<p&&(y.y=p);y.z<n&&(y.z=n)}}}m.next()}for(c=0;c<f;c++)a=new ia,a.setMinMax(e[c],g[c]),this.boneAabb.push(a)},_initGeometryData:function(){this._geometryData||(this._geometryData=
new Ic,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),0<this.indexBuffer.length&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))},clear:function(a,b,c,d){this._initGeometryData();this._geometryData.initDefaults();this._geometryData.recreate=!0;this._geometryData.maxVertices=c||0;this._geometryData.maxIndices=
d||0;this._geometryData.verticesUsage=a?0:1;this._geometryData.indicesUsage=b?0:1},setVertexStream:function(a,b,c,d,e,g){this._initGeometryData();this._geometryData._changeVertexCount(d||b.length/c,a);this._geometryData.vertexStreamsUpdated=!0;this._geometryData.vertexStreamDictionary[a]=new Mm(b,c,e||6,g||!1)},getVertexStream:function(a,b){var c=0,d=!1;if(this._geometryData){var e=this._geometryData.vertexStreamDictionary[a];e&&(d=!0,c=this._geometryData.vertexCount,ArrayBuffer.isView(b)?b.set(e.data):
(b.length=0,b.push(e.data)))}d||this.vertexBuffer&&(c=(new Db(this.vertexBuffer)).readData(a,b));return c},setPositions:function(a,b,c){this.setVertexStream("POSITION",a,b||Ic.DEFAULT_COMPONENTS_POSITION,c,6,!1)},setNormals:function(a,b,c){this.setVertexStream("NORMAL",a,b||Ic.DEFAULT_COMPONENTS_NORMAL,c,6,!1)},setUvs:function(a,b,c,d){this.setVertexStream("TEXCOORD"+a,b,c||Ic.DEFAULT_COMPONENTS_UV,d,6,!1)},setColors:function(a,b,c){this.setVertexStream("COLOR",a,b||Ic.DEFAULT_COMPONENTS_COLORS,c,
6,!1)},setColors32:function(a,b){this.setVertexStream("COLOR",a,Ic.DEFAULT_COMPONENTS_COLORS,b,1,!0)},setIndices:function(a,b){this._initGeometryData();this._geometryData.indexStreamUpdated=!0;this._geometryData.indices=a;this._geometryData.indexCount=b||a.length},getPositions:function(a){return this.getVertexStream("POSITION",a)},getNormals:function(a){return this.getVertexStream("NORMAL",a)},getUvs:function(a,b){return this.getVertexStream("TEXCOORD"+a,b)},getColors:function(a){return this.getVertexStream("COLOR",
a)},getIndices:function(a){var b=0;if(this._geometryData&&this._geometryData.indices){var c=this._geometryData.indices;b=this._geometryData.indexCount;ArrayBuffer.isView(a)?a.set(c):(a.length=0,a.push(c))}else 0<this.indexBuffer.length&&this.indexBuffer[0]&&(b=this.indexBuffer[0].readData(a));return b},update:function(a,b){this._geometryData&&((b||void 0===b)&&(b=this._geometryData.vertexStreamDictionary.POSITION)&&3==b.componentCount&&this._aabb.compute(b.data,this._geometryData.vertexCount),b=this._geometryData.recreate,
this._geometryData.vertexCount>this._geometryData.maxVertices&&(b=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),b&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null),b=this._geometryData.recreate,this._geometryData.indexCount>this._geometryData.maxIndices&&(b=!0,this._geometryData.maxIndices=this._geometryData.indexCount),b&&0<this.indexBuffer.length&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&
this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=void 0===a?4:a,0<this.indexBuffer.length&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=
!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1)},_buildVertexFormat:function(a){var b=[],c;for(c in this._geometryData.vertexStreamDictionary){var d=this._geometryData.vertexStreamDictionary[c];b.push({semantic:c,components:d.componentCount,type:d.dataType,normalize:d.dataTypeNormalize})}return new Ka(this.device,b,a)},_updateVertexBuffer:function(){if(!this.vertexBuffer){var a=this._geometryData.maxVertices,b=this._buildVertexFormat(a);this.vertexBuffer=new Za(this.device,
b,a,this._geometryData.verticesUsage)}a=new Db(this.vertexBuffer);b=this._geometryData.vertexCount;for(var c in this._geometryData.vertexStreamDictionary)a.writeData(c,this._geometryData.vertexStreamDictionary[c].data,b),delete this._geometryData.vertexStreamDictionary[c];a.end()},_updateIndexBuffer:function(){if(0>=this.indexBuffer.length||!this.indexBuffer[0])this.indexBuffer[0]=new Rb(this.device,65535<this._geometryData.maxVertices?2:1,this._geometryData.maxIndices,this._geometryData.indicesUsage);
var a=this._geometryData.indices;a&&(this.indexBuffer[0].writeData(a,this._geometryData.indexCount),this._geometryData.indices=null)},generateWireframe:function(){var a=function(a){switch(a.format){case 0:return new Uint8Array(a.storage);case 1:return new Uint16Array(a.storage);case 2:return new Uint32Array(a.storage);default:return null}},b=[];if(0<this.indexBuffer.length&&this.indexBuffer[0]){var c=[[0,1],[1,2],[2,0]];for(var d=this.primitive[0].base,e=this.primitive[0].count,g=this.indexBuffer[0],
k=a(g),f={},h=d;h<d+e;h+=3)for(var p=0;3>p;p++){var n=k[h+c[p][0]],m=k[h+c[p][1]],q=n>m?m<<16|n:n<<16|m;void 0===f[q]&&(f[q]=0,b.push(n,m))}c=g.format}else{for(c=0;c<this.vertexBuffer.numVertices;c+=3)b.push(c,c+1,c+1,c+2,c+2,c);c=65535<b.length?2:1}c=new Rb(this.vertexBuffer.device,c,b.length);a(c).set(b);c.unlock();this.primitive[1]={type:1,base:0,count:b.length,indexed:!0};this.indexBuffer[1]=c}});var ic=new ia,Cg=new ia;Object.defineProperty(ma.prototype,"mesh",{get:function(){return this._mesh},
set:function(a){this._mesh&&this._mesh.decReference();(this._mesh=a)&&a.incReference()}});Object.defineProperty(ma.prototype,"aabb",{get:function(){var a;if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);if(this.skinInstance){this.mesh.boneAabb||this.mesh._initBoneAabbs(this._morphInstance?this._morphInstance.morph._targets:null);var b=this.mesh.boneUsed,c=this.node.getWorldTransform(),d=!0;for(a=0;a<this.mesh.boneAabb.length;a++)b[a]&&(Cg.setFromTransformedAabb(this.mesh.boneAabb[a],
this.skinInstance.matrices[a]),d?(d=!1,ic.center.copy(Cg.center),ic.halfExtents.copy(Cg.halfExtents)):ic.add(Cg));this._aabb.setFromTransformedAabb(ic,c)}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(ic.center.copy(this.mesh.aabb.center),ic.halfExtents.copy(this.mesh.aabb.halfExtents)):(ic.center.set(0,0,0),ic.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&ic._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),this._aabb.setFromTransformedAabb(ic,this.node.getWorldTransform()),
this._aabbVer=this.node._aabbVer);return this._aabb},set:function(a){this._aabb=a}});Object.defineProperty(ma.prototype,"material",{get:function(){return this._material},set:function(a){var b;for(b=0;b<this._shader.length;b++)this._shader[b]=null;if(this._material){var c=this._material.meshInstances;b=c.indexOf(this);-1!==b&&c.splice(b,1)}b=this._material;if(this._material=a)this._material.meshInstances.push(this),this.updateKey(),(b&&3!==b.blendType)!==(3!==this._material.blendType)&&(a=this._material._scene,
!a&&b&&b._scene&&(a=b._scene),a?a.layers._dirtyBlend=!0:this._material._dirtyBlend=!0)}});Object.defineProperty(ma.prototype,"layer",{get:function(){return this._layer},set:function(a){this._layer=a;this.updateKey()}});Object.defineProperty(ma.prototype,"calculateSortDistance",{get:function(){return this._calculateSortDistance},set:function(a){this._calculateSortDistance=a}});Object.defineProperty(ma.prototype,"receiveShadow",{get:function(){return this._receiveShadow},set:function(a){this._shaderDefs=
(this._receiveShadow=a)?this._shaderDefs&-2:this._shaderDefs|1;this._shader[0]=null;this._shader[1]=null}});Object.defineProperty(ma.prototype,"skinInstance",{get:function(){return this._skinInstance},set:function(a){this._shaderDefs=(this._skinInstance=a)?this._shaderDefs|2:this._shaderDefs&-3;for(a=0;a<this._shader.length;a++)this._shader[a]=null}});Object.defineProperty(ma.prototype,"morphInstance",{get:function(){return this._morphInstance},set:function(a){this._shaderDefs=(this._morphInstance=
a)&&a.morph.morphPositions?this._shaderDefs|1024:this._shaderDefs&-1025;this._shaderDefs=a&&a.morph.morphNormals?this._shaderDefs|2048:this._shaderDefs&-2049;for(a=0;a<this._shader.length;a++)this._shader[a]=null}});Object.defineProperty(ma.prototype,"screenSpace",{get:function(){return this._screenSpace},set:function(a){this._shaderDefs=(this._screenSpace=a)?this._shaderDefs|256:this._shaderDefs&-257;this._shader[0]=null}});Object.defineProperty(ma.prototype,"key",{get:function(){return this._key[0]},
set:function(a){this._key[0]=a}});Object.defineProperty(ma.prototype,"mask",{get:function(){return this._shaderDefs>>16},set:function(a){this._shaderDefs=this._shaderDefs&65535|a<<16;this._shader[0]=null;this._shader[1]=null}});Object.defineProperty(ma.prototype,"instancingCount",{get:function(){return this.instancingData?this.instancingData.count:0},set:function(a){this.instancingData&&(this.instancingData.count=a)}});Object.assign(ma.prototype,{syncAabb:function(){},updateKey:function(){var a=this.material;
this._key[0]=(this.layer&15)<<27|(3===(a.alphaToCoverage||a.alphaTest?2:a.blendType)?1:0)<<26|0|(a.id&33554431)<<0},setInstancing:function(a){a?(this.instancingData=new Om(a.numVertices),this.instancingData.offset=0,this.instancingData.vertexBuffer=a,this.cull=!1):(this.instancingData=null,this.cull=!0)},clearParameters:function(){this.parameters={}},getParameters:function(){return this.parameters},getParameter:function(a){return this.parameters[a]},setParameter:function(a,b,c){void 0===c&&(c=-524285);
if(void 0===b&&"object"===typeof a){b=a;if(b.length){for(a=0;a<b.length;a++)this.setParameter(b[a]);return}a=b.name;b=b.value}var d=this.parameters[a];d?(d.data=b,d.passFlags=c):this.parameters[a]={scopeId:null,data:b,passFlags:c}},deleteParameter:function(a){this.parameters[a]&&delete this.parameters[a]},setParameters:function(){for(var a in this.parameters){var b=this.parameters[a];b.scopeId.setValue(b.data)}}});Object.defineProperty(Nf.prototype,"key",{get:function(){return this._key[0]},set:function(a){this._key[0]=
a}});Object.defineProperties(qc,{RENDER_TARGET_COUNT:{value:8}});Object.assign(qc.prototype,{destroy:function(){this.morph&&(this.morph.destroy(),this.morph=null)},getWeight:function(a){return this._weights[a]},setWeight:function(a,b){this._weights[a]=b;this._dirty=!0},update:function(){var a=this.morph._targets,b=0,c;for(c=0;c<a.length;c++){var d=Math.abs(this.getWeight(c));if(1E-5<d){this._activeTargets.length<=b&&(this._activeTargets[b]={});var e=this._activeTargets[b++];e.absWeight=d;e.weight=
this.getWeight(c);e.target=a[c]}}this._activeTargets.length=b;c=this.morph.maxActiveTargets;this._activeTargets.length>c&&(this._activeTargets.sort(function(a,b){return a.absWeight<b.absWeight?1:b.absWeight<a.absWeight?-1:0}),this._activeTargets.length=c);a=qc.RENDER_TARGET_COUNT;for(c=0;c<a;c++)this._shaderMorphWeights[c]=0,this._activeVertexBuffers[c]=null;a=0;b=this.morph.morphPositions?4:0;for(c=0;c<this._activeTargets.length;c++)e=this._activeTargets[c].target,e._vertexBufferPositions&&(this._activeVertexBuffers[a]=
e._vertexBufferPositions,this._shaderMorphWeights[a]=this._activeTargets[c].weight,a++),e._vertexBufferNormals&&(this._activeVertexBuffers[b]=e._vertexBufferNormals,this._shaderMorphWeights[b]=this._activeTargets[c].weight,b++)}});var dl=new C;Object.assign(Rd.prototype,{updateMatrices:function(a){dl.copy(a.getWorldTransform()).invert();for(a=this.bones.length-1;0<=a;a--)this.matrices[a].mul2(dl,this.bones[a].getWorldTransform()),this.matrices[a].mul2(this.matrices[a],this.skin.inverseBindPose[a])},
updateMatrixPalette:function(){for(var a,b=this.matrixPalette,c,d=this.bones.length-1;0<=d;d--)a=this.matrices[d].data,c=16*d,b[c]=a[0],b[c+1]=a[1],b[c+2]=a[2],b[c+3]=a[3],b[c+4]=a[4],b[c+5]=a[5],b[c+6]=a[6],b[c+7]=a[7],b[c+8]=a[8],b[c+9]=a[9],b[c+10]=a[10],b[c+11]=a[11],b[c+12]=a[12],b[c+13]=a[13],b[c+14]=a[14],b[c+15]=a[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}});Object.assign(gb.prototype,{getGraph:function(){return this.graph},setGraph:function(a){this.graph=
a},getCameras:function(){return this.cameras},setCameras:function(a){this.cameras=a},getLights:function(){return this.lights},setLights:function(a){this.lights=a},getMaterials:function(){var a,b=[];for(a=0;a<this.meshInstances.length;a++){var c=this.meshInstances[a];-1===b.indexOf(c.material)&&b.push(c.material)}return b},clone:function(){var a,b,c=[],d=[],e=function(a){var b=a.clone();c.push(a);d.push(b);for(var g=0;g<a._children.length;g++)b.addChild(e(a._children[g]));return b},g=e(this.graph),
k=[],f=[],h=[];for(a=0;a<this.skinInstances.length;a++){var p=this.skinInstances[a].skin,n=new Rd(p),m=[];for(b=0;b<p.boneNames.length;b++){var q=g.findByName(p.boneNames[b]);m.push(q)}n.bones=m;f.push(n)}for(a=0;a<this.morphInstances.length;a++)b=new qc(this.morphInstances[a].morph),h.push(b);for(a=0;a<this.meshInstances.length;a++)b=this.meshInstances[a],p=c.indexOf(b.node),p=new ma(d[p],b.mesh,b.material),b.skinInstance&&(n=this.skinInstances.indexOf(b.skinInstance),p.skinInstance=f[n]),b.morphInstance&&
(b=this.morphInstances.indexOf(b.morphInstance),p.morphInstance=h[b]),k.push(p);a=new gb;a.graph=g;a.meshInstances=k;a.skinInstances=f;a.morphInstances=h;a.getGraph().syncHierarchy();return a},destroy:function(){for(var a=this.meshInstances,b,c,d=0;d<a.length;d++){b=a[d];if(c=b.mesh)b.mesh=null,1>c.refCount&&c.destroy();(c=b.skinInstance)&&(c=c.boneTexture)&&c.destroy();b.skinInstance=null;(c=b.morphInstance)&&c.destroy();b.morphInstance=null;b.material=null}},generateWireframe:function(){var a,b=
[];for(a=0;a<this.meshInstances.length;a++){var c=this.meshInstances[a].mesh;-1===b.indexOf(c)&&b.push(c)}for(a=0;a<b.length;++a)c=b[a],c.primitive[1]||c.generateWireframe()}});Ta.MODEL="model";Ta.ELEMENT="element";Ta.SPRITE="sprite";Object.assign(th.prototype,{updateMatrices:function(a){},updateMatrixPalette:function(){for(var a,b=this.matrixPalette,c,d=this.bones.length-1;0<=d;d--)a=this.bones[d].getWorldTransform().data,c=16*d,b[c]=a[0],b[c+1]=a[1],b[c+2]=a[2],b[c+3]=a[3],b[c+4]=a[4],b[c+5]=a[5],
b[c+6]=a[6],b[c+7]=a[7],b[c+8]=a[8],b[c+9]=a[9],b[c+10]=a[10],b[c+11]=a[11],b[c+12]=a[12],b[c+13]=a[13],b[c+14]=a[14],b[c+15]=a[15];this.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}});Aa.prototype.destroyManager=function(){this.scene=this.rootNode=this.device=null;this._batchGroups={};this._batchList=[];this._dirtyGroups=[]};Aa.prototype.addGroup=function(a,b,c,d,e){void 0===d&&(d=this._batchGroupCounter,this._batchGroupCounter++);if(!this._batchGroups[d])return this._batchGroups[d]=
a=new Ta(d,a,b,c,e)};Aa.prototype.removeGroup=function(a){if(this._batchGroups[a]){for(var b=[],c=0;c<this._batchList.length;c++)this._batchList[c].batchGroupId!==a?b.push(this._batchList[c]):this.destroy(this._batchList[c]);this._batchList=b;this._removeModelsFromBatchGroup(this.rootNode,a);delete this._batchGroups[a]}};Aa.prototype.markGroupDirty=function(a){0>this._dirtyGroups.indexOf(a)&&this._dirtyGroups.push(a)};Aa.prototype.getGroupByName=function(a){var b=this._batchGroups,c;for(c in b)if(b.hasOwnProperty(c)&&
b[c].name===a)return b[c];return null};Aa.prototype.getBatches=function(a){for(var b=[],c=this._batchList.length,d=0;d<c;d++){var e=this._batchList[d];e.batchGroupId===a&&b.push(e)}return b};Aa.prototype._removeModelsFromBatchGroup=function(a,b){if(a.enabled){a.model&&a.model.batchGroupId===b&&(a.model.batchGroupId=-1);a.element&&a.element.batchGroupId===b&&(a.element.batchGroupId=-1);a.sprite&&a.sprite.batchGroupId===b&&(a.sprite.batchGroupId=-1);for(var c=0;c<a._children.length;c++)this._removeModelsFromBatchGroup(a._children[c],
b)}};Aa.prototype.insert=function(a,b,c){var d=this._batchGroups[b];d&&0>d._obj[a].indexOf(c)&&(d._obj[a].push(c),this.markGroupDirty(b))};Aa.prototype.remove=function(a,b,c){var d=this._batchGroups[b];d&&(c=d._obj[a].indexOf(c),0<=c&&(d._obj[a].splice(c,1),this.markGroupDirty(b)))};Aa.prototype._extractModel=function(a,b,c,d){if(!a.model||!a.model.model)return b;if(a.model.isStatic){d=this.scene.drawCalls;var e=a.model.meshInstances;for(c=0;c<d.length;c++)d[c]._staticSource&&(0>e.indexOf(d[c]._staticSource)||
b.push(d[c]));for(c=0;c<e.length;c++)0<=d.indexOf(e[c])&&b.push(e[c])}else b=d[a.model.batchGroupId]=b.concat(a.model.meshInstances);a.model.removeModelFromLayers();return b};Aa.prototype._extractElement=function(a,b,c){if(a.element){var d=!1;a.element._text&&0<a.element._text._model.meshInstances.length?(b.push(a.element._text._model.meshInstances[0]),a.element.removeModelFromLayers(a.element._text._model),d=!0):a.element._image&&(b.push(a.element._image._renderable.meshInstance),a.element.removeModelFromLayers(a.element._image._renderable.model),
a.element._image._renderable.unmaskMeshInstance&&(b.push(a.element._image._renderable.unmaskMeshInstance),a.element._image._renderable.unmaskMeshInstance.stencilFront&&a.element._image._renderable.unmaskMeshInstance.stencilBack||(a.element._dirtifyMask(),a.element._onPrerender())),d=!0);d&&(c._ui=!0)}};Aa.prototype._collectAndRemoveModels=function(a,b){for(var c,d,e,g=0;g<b.length;g++)if(c=b[g],d=this._batchGroups[c]){(e=a[c])||(e=a[c]=[]);for(c=0;c<d._obj.model.length;c++)e=this._extractModel(d._obj.model[c],
e,d,a);for(c=0;c<d._obj.element.length;c++)this._extractElement(d._obj.element[c],e,d);for(var k=0;k<d._obj.sprite.length;k++)c=d._obj.sprite[k],c.sprite&&c.sprite._meshInstance&&(d.dynamic||0===c.sprite.sprite._renderMode)&&(e.push(c.sprite._meshInstance),c.sprite.removeModelFromLayers(),d._sprite=!0,c.sprite._batchGroup=d)}};Aa.prototype.generate=function(a){var b,c={};a||(a=Object.keys(this._batchGroups));var d=[];for(b=0;b<this._batchList.length;b++)0>a.indexOf(this._batchList[b].batchGroupId)?
d.push(this._batchList[b]):this.destroy(this._batchList[b]);this._batchList=d;this._collectAndRemoveModels(c,a);if(a===this._dirtyGroups)this._dirtyGroups.length=0;else{d=[];for(b=0;b<this._dirtyGroups.length;b++)0>a.indexOf(this._dirtyGroups[b])&&d.push(this._dirtyGroups[b]);this._dirtyGroups=d}var e,g;for(g in c)if(c.hasOwnProperty(g)&&(b=c[g],a=this._batchGroups[g])){var k=this.prepare(b,a.dynamic,a.maxAabbSize,a._ui||a._sprite);for(b=0;b<k.length;b++)if(e=this.create(k[b],a.dynamic,parseInt(g,
10)))for(d=0;d<a.layers.length;d++){var f=this.scene.layers.getLayerById(a.layers[d]);f&&f.addMeshInstances(e.model.meshInstances)}}};var Pf=new r,Gj=new r,Hj=new r;Aa.prototype.prepare=function(a,b,c,d){if(0===a.length)return[];void 0===c&&(c=Number.POSITIVE_INFINITY);c*=.5;var e=this.device.supportsBoneTextures?1024:this.device.boneLimit,g=this.device.extUintElement?4294967295:65535,k=new ia,f=new ia,h=null,p,n=[],m,q=0;d&&a.sort(function(a,b){return a.drawOrder-b.drawOrder});for(var u=a,t,r=d?
function(a){h?h.add(a.aabb):h=a.aabb.clone();t.push(a)}:function(a){t.push(a)};0<u.length;){n[q]=[u[0]];t=[];a=u[0].material;var w=u[0].layer;var v=u[0]._shaderDefs;var x=u[0].parameters;var z=u[0].stencilFront;var A=u[0]._staticLightList;var F=u[0].mesh.vertexBuffer.getNumVertices();var Q=u[0].drawOrder;k.copy(u[0].aabb);var D=uh(u[0]);var E=u[0].mesh.vertexBuffer.format.batchingHash;var B=u[0].mesh.primitive[0].indexed;h=null;for(m=1;m<u.length;m++){var C=u[m];if(b&&n[q].length>=e){t=t.concat(u.slice(m));
break}if(a!==C.material||w!==C.layer||E!==C.mesh.vertexBuffer.format.batchingHash||B!==C.mesh.primitive[0].indexed||v!==C._shaderDefs||F+C.mesh.vertexBuffer.getNumVertices()>g)r(C);else if(f.copy(k),f.add(C.aabb),f.halfExtents.x>c||f.halfExtents.y>c||f.halfExtents.z>c)r(C);else if(!z||(p=C.stencilFront)&&z.func==p.func&&z.zpass==p.zpass)if(D!=uh(C))r(C);else if(Pm(x,C.parameters)){var H=C._staticLightList;if(A&&H){if(!Qm(A,H)){r(C);continue}}else if(A||H){r(C);continue}d&&h&&h.intersects(C.aabb)&&
C.drawOrder!==Q?r(C):(k.add(C.aabb),F+=C.mesh.vertexBuffer.getNumVertices(),n[q].push(C))}else r(C);else r(C)}q++;u=t}return n};Aa.prototype.create=function(a,b,c){this._init||(this.transformVS="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n#define DYNAMICBATCH\n"+K.transformVS,this.skinTexVS=K.skinBatchTexVS,this.skinConstVS=K.skinBatchConstVS,this.vertexFormats={},this._init=!0);var d,e,g=null,k=null,f=0,h=0,p=null;for(d=0;d<a.length;d++)if(a[d].visible){var n=a[d].mesh;var m=n.vertexBuffer.numVertices;
f+=m;h+=n.primitive[0].indexed?n.primitive[0].count:6==n.primitive[0].type&&4===n.primitive[0].count?6:0;if(!g){k=a[d].material;g={};m=n.vertexBuffer.format.elements;for(e=0;e<m.length;e++){var q=m[e].name;g[q]={numComponents:m[e].numComponents,dataType:m[e].dataType,normalize:m[e].normalize,count:0}}b&&(g.BLENDINDICES={numComponents:1,dataType:6,normalize:!1,count:0})}}if(g){p=new sh(a,b,c);this._batchList.push(p);var u=0,t=0,y,w=new r;h=new (65535>=f?Uint16Array:Uint32Array)(h);for(q in g){var v=
g[q];v.typeArrayType=Mf[v.dataType];v.elementByteSize=Lf[v.dataType];v.buffer=new v.typeArrayType(f*v.numComponents)}for(d=0;d<a.length;d++)if(a[d].visible){n=a[d].mesh;m=n.vertexBuffer.numVertices;b||(y=a[d].node.getWorldTransform());for(q in g)if("BLENDINDICES"!==q){v=g[q];f=new v.typeArrayType(v.buffer.buffer,v.elementByteSize*v.count);var x=n.getVertexStream(q,f)*v.numComponents;v.count+=x;if(!b&&3<=v.numComponents&&("POSITION"==q||"NORMAL"==q||"TANGENT"==q))for(y.transformFunction="POSITION"==
q?C.prototype.transformPoint:C.prototype.transformVector,e=0;e<x;e+=v.numComponents)w.set(f[e],f[e+1],f[e+2]),y.transformFunction(w,w),f[e]=w.x,f[e+1]=w.y,f[e+2]=w.z}if(b)for(v=g.BLENDINDICES,e=0;e<m;e++)v.buffer[v.count++]=d;if(n.primitive[0].indexed)v=n.primitive[0].base,f=n.primitive[0].count,e=n.indexBuffer[0].getFormat(),n=new cl[e](n.indexBuffer[0].storage);else if(6==n.primitive[0].type&&4===n.primitive[0].count)v=0,f=6,n=[0,1,3,2,3,1];else continue;for(e=0;e<f;e++)h[e+t]=n[v+e]+u;t+=f;u+=
m}n=new fb(this.device);for(q in g)v=g[q],n.setVertexStream(q,v.buffer,v.numComponents,void 0,v.dataType,v.normalize);0<h.length&&n.setIndices(h);n.update(4,!1);b&&(k=k.clone(),k.chunks.transformVS=this.transformVS,k.chunks.skinTexVS=this.skinTexVS,k.chunks.skinConstVS=this.skinConstVS,k.update());a=new ma(this.rootNode,n,k);a.castShadow=p.origMeshInstances[0].castShadow;a.parameters=p.origMeshInstances[0].parameters;a.isStatic=p.origMeshInstances[0].isStatic;a.layer=p.origMeshInstances[0].layer;
a._staticLightList=p.origMeshInstances[0]._staticLightList;a._shaderDefs=p.origMeshInstances[0]._shaderDefs;a.cull=p.origMeshInstances[0].cull;(d=this._batchGroups[c])&&d._ui&&(a.cull=!1);if(b){b=[];for(d=0;d<p.origMeshInstances.length;d++)b.push(p.origMeshInstances[d].node);a.skinInstance=new th(this.device,b,this.rootNode)}a._updateAabb=!1;a.drawOrder=p.origMeshInstances[0].drawOrder;a.stencilFront=p.origMeshInstances[0].stencilFront;a.stencilBack=p.origMeshInstances[0].stencilBack;a.flipFaces=
0>uh(p.origMeshInstances[0]);p.meshInstance=a;this.update(p);b=new gb;b.meshInstances=[p.meshInstance];b.castShadows=p.origMeshInstances[0].castShadows;p.model=b}return p};Aa.prototype.update=function(a){a._aabb.copy(a.origMeshInstances[0].aabb);for(var b=1;b<a.origMeshInstances.length;b++)a._aabb.add(a.origMeshInstances[b].aabb);a.meshInstance.aabb=a._aabb;a._aabb._radiusVer=-1;a.meshInstance._aabbVer=0};Aa.prototype.updateAll=function(){0<this._dirtyGroups.length&&this.generate(this._dirtyGroups);
for(var a=0;a<this._batchList.length;a++)this._batchList[a].dynamic&&this.update(this._batchList[a])};Aa.prototype.clone=function(a,b){var c=new sh(b,a.dynamic,a.batchGroupId);this._batchList.push(c);for(var d=[],e=0;e<b.length;e++)d.push(b[e].node);c.meshInstance=new ma(a.meshInstance.node,a.meshInstance.mesh,a.meshInstance.material);c.meshInstance._updateAabb=!1;c.meshInstance.parameters=b[0].parameters;c.meshInstance.isStatic=b[0].isStatic;c.meshInstance.cull=b[0].cull;c.meshInstance.layer=b[0].layer;
c.meshInstance._staticLightList=b[0]._staticLightList;a.dynamic&&(c.meshInstance.skinInstance=new th(this.device,d,this.rootNode));c.meshInstance.castShadow=a.meshInstance.castShadow;c.meshInstance._shader=a.meshInstance._shader;b=new gb;b.meshInstances=[c.meshInstance];b.castShadows=a.origMeshInstances[0].castShadows;c.model=b;return c};Aa.prototype.destroy=function(a){a.refCounter=0;if(a.model){for(var b=this._batchGroups[a.batchGroupId].layers,c=0;c<b.length;c++){var d=this.scene.layers.getLayerById(b[c]);
d&&d.removeMeshInstances(a.model.meshInstances)}a.model.destroy()}};Aa.prototype.decrement=function(a){a.refCounter--;0===a.refCounter&&this.destroy(a)};var Dg=new r,nf=new r,$i=new r,Fd=new C;Object.assign(Pa.prototype,{clone:function(){var a=new Pa;a.projection=this._projection;a.nearClip=this._nearClip;a.farClip=this._farClip;a._shaderParams=this._shaderParams.slice();a.fov=this._fov;a.aspectRatio=this._aspect;a._aspectRatioMode=this._aspectRatioMode;a.renderTarget=this.renderTarget;a.setClearOptions(this.getClearOptions());
a.frustumCulling=this.frustumCulling;a.cullingMask=this.cullingMask;return a},worldToScreen:function(a,b,c,d){void 0===d&&(d=new r);if(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var e=this.getProjectionMatrix(),g=this.getViewMatrix();this._viewProjMat.mul2(e,g);this._viewProjMatDirty=!1}this._viewProjMat.transformPoint(a,d);e=this._viewProjMat.data;a=a.x*e[3]+a.y*e[7]+a.z*e[11]+1*e[15];d.x=.5*(d.x/a+1)*b;d.y=.5*(1-d.y/a)*c;return d},screenToWorld:function(a,b,c,d,e,g){void 0===
g&&(g=new r);if(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var k=this.getProjectionMatrix(),f=this.getViewMatrix();this._viewProjMat.mul2(k,f);this._viewProjMatDirty=!1}Fd.copy(this._viewProjMat).invert();0===this._projection?(nf.set(a/d*2-1,(e-b)/e*2-1,1),Fd.transformPoint(nf,$i),$i.scale(1/(nf.x*Fd.data[3]+nf.y*Fd.data[7]+nf.z*Fd.data[11]+Fd.data[15])),a=c/this._farClip,g.lerp(this._node.getPosition(),$i,a)):(Dg.set(a/d,(e-b)/e,c/(this._farClip-this._nearClip)),Dg.scale(2),
Dg.sub(r.ONE),Fd.transformPoint(Dg,g));return g},getClearOptions:function(){return this._clearOptions},_evaluateProjectionMatrix:function(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{var a=this._orthoHeight,b=a*this._aspect;this._projMat.setOrtho(-b,b,-a,a,this._nearClip,this._farClip);this._projMatSkybox.setPerspective(this._fov,this._aspect,this._nearClip,
this._farClip)}a=this._nearClip;b=this._farClip;this._shaderParams[0]=1/b;this._shaderParams[1]=b;this._shaderParams[2]=(1-b/a)/2;this._shaderParams[3]=(1+b/a)/2;this._projMatDirty=!1}},getProjectionMatrix:function(){this._evaluateProjectionMatrix();return this._projMat},getProjectionMatrixSkybox:function(){this._evaluateProjectionMatrix();return this._projMatSkybox},getViewMatrix:function(){if(this._viewMatDirty){var a=this._node.getWorldTransform();this._viewMat.copy(a).invert();this._viewMatDirty=
!1}return this._viewMat},getRect:function(){return this._rect},setClearOptions:function(a){this._clearOptions.color[0]=a.color[0];this._clearOptions.color[1]=a.color[1];this._clearOptions.color[2]=a.color[2];this._clearOptions.color[3]=a.color[3];this._clearOptions.depth=a.depth;this._clearOptions.stencil=a.stencil;this._clearOptions.flags=a.flags},setRect:function(a,b,c,d){this._rect.x=a;this._rect.y=b;this._rect.width=c;this._rect.height=d},setScissorRect:function(a,b,c,d){this._scissorRect.x=a;
this._scissorRect.y=b;this._scissorRect.width=c;this._scissorRect.height=d},requestDepthMap:function(){this._renderDepthRequests++},releaseDepthMap:function(){this._renderDepthRequests--}});Object.defineProperty(Pa.prototype,"aspectRatio",{get:function(){return this._aspect},set:function(a){this._aspect!==a&&(this._aspect=a,this._projMatDirty=!0)}});Object.defineProperty(Pa.prototype,"projection",{get:function(){return this._projection},set:function(a){this._projection!==a&&(this._projection=a,this._projMatDirty=
!0)}});Object.defineProperty(Pa.prototype,"nearClip",{get:function(){return this._nearClip},set:function(a){this._nearClip!==a&&(this._nearClip=a,this._projMatDirty=!0)}});Object.defineProperty(Pa.prototype,"farClip",{get:function(){return this._farClip},set:function(a){this._farClip!==a&&(this._farClip=a,this._projMatDirty=!0)}});Object.defineProperty(Pa.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!==a&&(this._fov=a,this._projMatDirty=!0)}});Object.defineProperty(Pa.prototype,
"horizontalFov",{get:function(){return this._horizontalFov},set:function(a){this._horizontalFov!==a&&(this._horizontalFov=a,this._projMatDirty=!0)}});Object.defineProperty(Pa.prototype,"orthoHeight",{get:function(){return this._orthoHeight},set:function(a){this._orthoHeight!==a&&(this._orthoHeight=a,this._projMatDirty=!0)}});Object.defineProperty(Pa.prototype,"clearColor",{get:function(){return this._clearOptions.color},set:function(a){this._clearOptions.color[0]=a[0];this._clearOptions.color[1]=
a[1];this._clearOptions.color[2]=a[2];this._clearOptions.color[3]=a[3]}});Object.defineProperty(Pa.prototype,"clearDepth",{get:function(){return this._clearOptions.depth},set:function(a){this._clearOptions.depth=a}});Object.defineProperty(Pa.prototype,"clearStencil",{get:function(){return this._clearOptions.stencil},set:function(a){this._clearOptions.stencil=a}});Object.defineProperty(Pa.prototype,"clearFlags",{get:function(){return this._clearOptions.flags},set:function(a){this._clearOptions.flags=
a}});var el=new C,aj=new r,fl=new T,bj=new T,gl=new r,hl=new r,fo=new C,go=new T;Z.prototype=Object.create(H.prototype);Z.prototype.constructor=Z;Object.defineProperty(Z.prototype,"right",{get:function(){this._right||(this._right=new r);return this.getWorldTransform().getX(this._right).normalize()}});Object.defineProperty(Z.prototype,"up",{get:function(){this._up||(this._up=new r);return this.getWorldTransform().getY(this._up).normalize()}});Object.defineProperty(Z.prototype,"forward",{get:function(){this._forward||
(this._forward=new r);return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}});Object.defineProperty(Z.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(a){this._enabled!==a&&(this._enabled=a,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,a))}});Object.defineProperty(Z.prototype,"parent",{get:function(){return this._parent}});Object.defineProperty(Z.prototype,"path",{get:function(){var a=this._parent;if(a){for(var b=
this.name;a&&a._parent;)b=a.name+"/"+b,a=a._parent;return b}return""}});Object.defineProperty(Z.prototype,"root",{get:function(){var a=this._parent;if(!a)return this;for(;a._parent;)a=a._parent;return a}});Object.defineProperty(Z.prototype,"children",{get:function(){return this._children}});Object.defineProperty(Z.prototype,"graphDepth",{get:function(){return this._graphDepth}});Object.assign(Z.prototype,{_notifyHierarchyStateChanged:function(a,b){a._onHierarchyStateChanged(b);a=a._children;for(var c=
0,d=a.length;c<d;c++)a[c]._enabled&&this._notifyHierarchyStateChanged(a[c],b)},_onHierarchyStateChanged:function(a){(this._enabledInHierarchy=a)&&!this._frozen&&this._unfreezeParentToRoot()},_cloneInternal:function(a){a.name=this.name;for(var b=this.tags._list,c=0;c<b.length;c++)a.tags.add(b[c]);a._labels=Object.assign({},this._labels);a.localPosition.copy(this.localPosition);a.localRotation.copy(this.localRotation);a.localScale.copy(this.localScale);a.localEulerAngles.copy(this.localEulerAngles);
a.position.copy(this.position);a.rotation.copy(this.rotation);a.eulerAngles.copy(this.eulerAngles);a.localTransform.copy(this.localTransform);a._dirtyLocal=this._dirtyLocal;a.worldTransform.copy(this.worldTransform);a._dirtyWorld=this._dirtyWorld;a._dirtyNormal=this._dirtyNormal;a._aabbVer=this._aabbVer+1;a._enabled=this._enabled;a.scaleCompensation=this.scaleCompensation;a._enabledInHierarchy=!1},clone:function(){var a=new Z;this._cloneInternal(a);return a},find:function(a,b){var c=[],d=this._children.length,
e;if(a instanceof Function)for((b=a(this))&&c.push(this),e=0;e<d;e++){var g=this._children[e].find(a);g.length&&(c=c.concat(g))}else for(this[a]&&(e=this[a]instanceof Function?this[a]():this[a],e===b&&c.push(this)),e=0;e<d;++e)g=this._children[e].find(a,b),g.length&&(c=c.concat(g));return c},findOne:function(a,b){var c,d=this._children.length,e;if(a instanceof Function){if(e=a(this))return this;for(c=0;c<d;c++)if(e=this._children[c].findOne(a))return e}else{if(this[a]&&(c=this[a]instanceof Function?
this[a]():this[a],c===b))return this;for(c=0;c<d;c++)if(e=this._children[c].findOne(a,b),null!==e)return e}return null},findByTag:function(){var a=this.tags._processArguments(arguments);return this._findByTag(a)},_findByTag:function(a){var b=[],c,d=this._children.length;for(c=0;c<d;c++){this._children[c].tags._has(a)&&b.push(this._children[c]);var e=this._children[c]._findByTag(a);e.length&&(b=b.concat(e))}return b},findByName:function(a){if(this.name===a)return this;for(var b=0;b<this._children.length;b++){var c=
this._children[b].findByName(a);if(null!==c)return c}return null},findByPath:function(a){a=a.split("/");for(var b=this,c=null,d=0,e=a.length;d<e&&b;d++){var g=a[d];c=null;b=b._children;for(var k=0,f=b.length;k<f;k++)if(b[k].name==g){c=b[k];break}b=c}return c},forEach:function(a,b){a.call(b,this);for(var c=this._children,d=0;d<c.length;d++)c[d].forEach(a,b)},isDescendantOf:function(a){for(var b=this._parent;b;){if(b===a)return!0;b=b._parent}return!1},isAncestorOf:function(a){return a.isDescendantOf(this)},
getEulerAngles:function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles},getLocalEulerAngles:function(){this.localRotation.getEulerAngles(this.localEulerAngles);return this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),
this._dirtyLocal=!1);return this.localTransform},getPosition:function(){this.getWorldTransform().getTranslation(this.position);return this.position},getRotation:function(){this.rotation.setFromMat4(this.getWorldTransform());return this.rotation},getScale:function(){this._scale||(this._scale=new r);return this.getWorldTransform().getScale(this._scale)},getWorldTransform:function(){if(!this._dirtyLocal&&!this._dirtyWorld)return this.worldTransform;this._parent&&this._parent.getWorldTransform();this._sync();
return this.worldTransform},reparent:function(a,b){var c=this._parent;c&&c.removeChild(this);a&&(0<=b?a.insertChild(this,b):a.addChild(this))},setLocalEulerAngles:function(a,b,c){a instanceof r?this.localRotation.setFromEulerAngles(a.x,a.y,a.z):this.localRotation.setFromEulerAngles(a,b,c);this._dirtyLocal||this._dirtifyLocal()},setLocalPosition:function(a,b,c){a instanceof r?this.localPosition.copy(a):this.localPosition.set(a,b,c);this._dirtyLocal||this._dirtifyLocal()},setLocalRotation:function(a,
b,c,d){a instanceof T?this.localRotation.copy(a):this.localRotation.set(a,b,c,d);this._dirtyLocal||this._dirtifyLocal()},setLocalScale:function(a,b,c){a instanceof r?this.localScale.copy(a):this.localScale.set(a,b,c);this._dirtyLocal||this._dirtifyLocal()},_dirtifyLocal:function(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())},_unfreezeParentToRoot:function(){for(var a=this._parent;a;)a._frozen=!1,a=a._parent},_dirtifyWorld:function(){this._dirtyWorld||this._unfreezeParentToRoot();
this._dirtifyWorldInternal()},_dirtifyWorldInternal:function(){if(!this._dirtyWorld){this._frozen=!1;this._dirtyWorld=!0;for(var a=0;a<this._children.length;a++)this._children[a]._dirtyWorld||this._children[a]._dirtifyWorldInternal()}this._dirtyNormal=!0;this._aabbVer++},setPosition:function(){var a=new r,b=new C;return function(c,d,e){c instanceof r?a.copy(c):a.set(c,d,e);null===this._parent?this.localPosition.copy(a):(b.copy(this._parent.getWorldTransform()).invert(),b.transformPoint(a,this.localPosition));
this._dirtyLocal||this._dirtifyLocal()}}(),setRotation:function(){var a=new T,b=new T;return function(c,d,e,g){c instanceof T?a.copy(c):a.set(c,d,e,g);null===this._parent?this.localRotation.copy(a):(c=this._parent.getRotation(),b.copy(c).invert(),this.localRotation.copy(b).mul(a));this._dirtyLocal||this._dirtifyLocal()}}(),setEulerAngles:function(){var a=new T;return function(b,c,d){b instanceof r?this.localRotation.setFromEulerAngles(b.x,b.y,b.z):this.localRotation.setFromEulerAngles(b,c,d);null!==
this._parent&&(b=this._parent.getRotation(),a.copy(b).invert(),this.localRotation.mul2(a,this.localRotation));this._dirtyLocal||this._dirtifyLocal()}}(),addChild:function(a){if(null!==a._parent)throw Error("GraphNode is already parented");this._children.push(a);this._onInsertChild(a)},addChildAndSaveTransform:function(a){var b=a.getPosition(),c=a.getRotation(),d=a._parent;d&&d.removeChild(a);a.setPosition(fo.copy(this.worldTransform).invert().transformPoint(b));a.setRotation(go.copy(this.getRotation()).invert().mul(c));
this._children.push(a);this._onInsertChild(a)},insertChild:function(a,b){if(null!==a._parent)throw Error("GraphNode is already parented");this._children.splice(b,0,a);this._onInsertChild(a)},_onInsertChild:function(a){a._parent=this;var b=a._enabled&&this.enabled;a._enabledInHierarchy!==b&&(a._enabledInHierarchy=b,a._notifyHierarchyStateChanged(a,b));a._updateGraphDepth();a._dirtifyWorld();this._frozen&&a._unfreezeParentToRoot();a.fire&&a.fire("insert",this);this.fire&&this.fire("childinsert",a)},
_updateGraphDepth:function(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var a=0,b=this._children.length;a<b;a++)this._children[a]._updateGraphDepth()},removeChild:function(a){var b,c=this._children.length;for(b=0;b<c;++b)if(this._children[b]===a){this._children.splice(b,1);a._parent=null;a.fire&&a.fire("remove",this);this.fire&&this.fire("childremove",a);break}},_sync:function(){this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),
this._dirtyLocal=!1);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var a=this._parent,b=this.localScale,c=a;if(c){for(;c&&c.scaleCompensation;)c=c._parent;if(c&&(c=c._parent)){var d=c.worldTransform.getScale();gl.mul2(d,this.localScale);b=gl}}bj.setFromMat4(a.worldTransform);fl.mul2(bj,this.localRotation);c=a.worldTransform;a.scaleCompensation&&(hl.mul2(d,a.getLocalScale()),el.setTRS(a.worldTransform.getTranslation(aj),bj,
hl),c=el);c.transformPoint(this.localPosition,aj);this.worldTransform.setTRS(aj,fl,b)}else this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}},syncHierarchy:function(){if(this._enabled&&!this._frozen){this._frozen=!0;(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var a=this._children,b=0,c=a.length;b<c;b++)a[b].syncHierarchy()}},lookAt:function(){var a=new C,b=new r,c=new r,d=new T;return function(e,g,k,f,h,p){if(e instanceof r)b.copy(e),g instanceof
r?c.copy(g):c.copy(r.UP);else{if(void 0===k)return;b.set(e,g,k);void 0!==f?c.set(f,h,p):c.copy(r.UP)}a.setLookAt(this.getPosition(),b,c);d.setFromMat4(a);this.setRotation(d)}}(),translate:function(){var a=new r;return function(b,c,d){b instanceof r?a.copy(b):a.set(b,c,d);a.add(this.getPosition());this.setPosition(a)}}(),translateLocal:function(){var a=new r;return function(b,c,d){b instanceof r?a.copy(b):a.set(b,c,d);this.localRotation.transformVector(a,a);this.localPosition.add(a);this._dirtyLocal||
this._dirtifyLocal()}}(),rotate:function(){var a=new T,b=new T;return function(c,d,e){c instanceof r?a.setFromEulerAngles(c.x,c.y,c.z):a.setFromEulerAngles(c,d,e);null===this._parent?this.localRotation.mul2(a,this.localRotation):(c=this.getRotation(),d=this._parent.getRotation(),b.copy(d).invert(),a.mul2(b,a),this.localRotation.mul2(a,c));this._dirtyLocal||this._dirtifyLocal()}}(),rotateLocal:function(){var a=new T;return function(b,c,d){b instanceof r?a.setFromEulerAngles(b.x,b.y,b.z):a.setFromEulerAngles(b,
c,d);this.localRotation.mul(a);this._dirtyLocal||this._dirtifyLocal()}}()});var cj,dj,Eg,Fg,ho=[null,function(a,b){return a.drawOrder-b.drawOrder},function(a,b){cj=a._key[0];dj=b._key[0];return cj===dj&&a.mesh&&b.mesh?b.mesh.id-a.mesh.id:dj-cj},function(a,b){return b.zdist-a.zdist},function(a,b){return a.zdist-b.zdist}],vh=0;Jj.prototype.clearVisibleLists=function(a){this.visibleOpaque[a]&&(this.visibleOpaque[a].length=0,this.visibleOpaque[a].list.length=0);this.visibleTransparent[a]&&(this.visibleTransparent[a].length=
0,this.visibleTransparent[a].list.length=0)};Object.defineProperty(fa.prototype,"enabled",{get:function(){return this._enabled},set:function(a){if(a!==this._enabled)if(this._enabled=a){if(this.incrementCounter(),this.onEnable)this.onEnable()}else if(this.decrementCounter(),this.onDisable)this.onDisable()}});Object.defineProperty(fa.prototype,"clearColor",{get:function(){return this._clearColor},set:function(a){this._clearColor.copy(a)}});fa.prototype._updateClearFlags=function(){var a=0;this._clearColorBuffer&&
(a|=1);this._clearDepthBuffer&&(a|=2);this._clearStencilBuffer&&(a|=4);this._clearOptions.flags=a};Object.defineProperty(fa.prototype,"clearColorBuffer",{get:function(){return this._clearColorBuffer},set:function(a){this._clearColorBuffer=a;this._updateClearFlags()}});Object.defineProperty(fa.prototype,"clearDepthBuffer",{get:function(){return this._clearDepthBuffer},set:function(a){this._clearDepthBuffer=a;this._updateClearFlags()}});Object.defineProperty(fa.prototype,"clearStencilBuffer",{get:function(){return this._clearStencilBuffer},
set:function(a){this._clearStencilBuffer=a;this._updateClearFlags()}});fa.prototype.incrementCounter=function(){if(0===this._refCounter&&(this._enabled=!0,this.onEnable))this.onEnable();this._refCounter++};fa.prototype.decrementCounter=function(){if(1===this._refCounter){if(this._enabled=!1,this.onDisable)this.onDisable()}else if(0===this._refCounter)return;this._refCounter--};fa.prototype.addMeshInstances=function(a,b){for(var c=this._shaderVersion,d,e,g,k=this.shadowCasters,f=0;f<a.length;f++)d=
a[f],g=d.material,e=3===g.blendType?this.opaqueMeshInstances:this.transparentMeshInstances,0>e.indexOf(d)&&e.push(d),!b&&d.castShadow&&0>k.indexOf(d)&&k.push(d),!this.passThrough&&0<=c&&g._shaderVersion!==c&&(g.updateShader!==da.prototype.updateShader&&(g.clearVariants(),g.shader=null),g._shaderVersion=c);this.passThrough||(this._dirty=!0)};fa.prototype.removeMeshInstances=function(a,b){var c,d,e=this.opaqueMeshInstances,g=this.transparentMeshInstances,k=this.shadowCasters;for(c=0;c<a.length;c++){var f=
a[c];var h=-1;var p=0;var n=e.length;for(d=0;d<n;d++){var m=e[d];if(m===f){h=d;p=1;break}if(m._staticSource===f)0>h&&(h=d),p++;else if(0<=h)break}0<=h&&e.splice(h,p);h=-1;p=0;n=g.length;for(d=0;d<n;d++){m=g[d];if(m===f){h=d;p=1;break}if(m._staticSource===f)0>h&&(h=d),p++;else if(0<=h)break}0<=h&&g.splice(h,p);b||(d=k.indexOf(f),0<=d&&k.splice(d,1))}this._dirty=!0};fa.prototype.clearMeshInstances=function(a){if(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!a&&0!==
this.shadowCasters.length)this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,a||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0)};fa.prototype.addLight=function(a){0<=this._lightComponents.indexOf(a)||(this._lightComponents.push(a),this._lights.push(a.light),this._dirtyLights=!0,this._generateLightHash())};fa.prototype.removeLight=function(a){var b=this._lightComponents.indexOf(a);0>b||(this._lightComponents.splice(b,1),b=this._lights.indexOf(a.light),this._lights.splice(b,
1),this._dirtyLights=!0,this._generateLightHash())};fa.prototype.clearLights=function(){this._lightComponents.length=0;this._lights.length=0;this._dirtyLights=!0};fa.prototype.addShadowCasters=function(a){for(var b,c=this.shadowCasters,d=0;d<a.length;d++)b=a[d],b.castShadow&&0>c.indexOf(b)&&c.push(b);this._dirtyLights=!0};fa.prototype.removeShadowCasters=function(a){for(var b,c=this.shadowCasters,d=0;d<a.length;d++)b=c.indexOf(a[d]),0<=b&&c.splice(b,1);this._dirtyLights=!0};fa.prototype._generateLightHash=
function(){if(0<this._lights.length){this._lights.sort(Sm);for(var a="",b="",c=0;c<this._lights.length;c++)this._lights[c].isStatic?b+=this._lights[c].key:a+=this._lights[c].key;this._lightHash=0===a.length?0:Ne(a);this._staticLightHash=0===b.length?0:Ne(b)}else this._staticLightHash=this._lightHash=0};fa.prototype._generateCameraHash=function(){if(1<this.cameras.length){this.cameras.sort(Rm);for(var a="",b=0;b<this.cameras.length;b++)a+=this.cameras[b].entity.getGuid();this._cameraHash=Ne(a)}else this._cameraHash=
0;this._dirtyCameras=!0};fa.prototype.addCamera=function(a){0<=this.cameras.indexOf(a)||(this.cameras.push(a),this._generateCameraHash())};fa.prototype.removeCamera=function(a){a=this.cameras.indexOf(a);0>a||(this.cameras.splice(a,1),this._generateCameraHash(),this.instances.clearVisibleLists(a))};fa.prototype.clearCameras=function(){this._cameraHash=this.cameras.length=0;this._dirtyCameras=!0};fa.prototype._sortCameras=function(){this._generateCameraHash()};fa.prototype._calculateSortDistances=function(a,
b,c,d){var e;for(e=0;e<b;e++){var g=a[e];if(!(g.command||2>=g.layer))if(g.calculateSortDistance)g.zdist=g.calculateSortDistance(g,c,d);else{var k=g.aabb.center;var f=k.x-c.x;var h=k.y-c.y;k=k.z-c.z;g.zdist=f*d.x+h*d.y+k*d.z}}};fa.prototype._sortVisible=function(a,b,c){var d=this.instances,e=a?this.transparentSortMode:this.opaqueSortMode;if(0!==e)if(a=a?d.visibleTransparent[c]:d.visibleOpaque[c],5===e)Eg=b.getPosition(),Fg=b.forward,this.customCalculateSortValues&&this.customCalculateSortValues(a.list,
a.length,Eg,Fg),a.list.length!==a.length&&(a.list.length=a.length),this.customSortCallback&&a.list.sort(this.customSortCallback);else{if(3===e||4===e)Eg=b.getPosition(),Fg=b.forward,this._calculateSortDistances(a.list,a.length,Eg,Fg);a.list.length!==a.length&&(a.list.length=a.length);a.list.sort(ho[e])}};for(var il=(new C).mul2((new C).setTranslate(.5,.5,.5),(new C).setScale(.5,.5,.5)),io={r:1,g:2,b:3,a:4},jl=[(new T).setFromEulerAngles(0,90,180),(new T).setFromEulerAngles(0,-90,180),(new T).setFromEulerAngles(90,
0,0),(new T).setFromEulerAngles(-90,0,0),(new T).setFromEulerAngles(0,180,180),(new T).setFromEulerAngles(0,0,180)],Nj=[{},{},{},{},{}],Gd=new Float32Array(2),of={x:1,y:1,z:0,w:0},Hd=new C,Gg=new C,kl=new C,Kb=new C,mb=new C,ll=new Cb,ml=new C,Ab,yc=new C,zc=new C,te=new C,ue=new C,ve=new r,we=new r,pf,qf,nl=new C,ol=new C,pl=new C,ql=new C,Hg=new r,rl=new r,sl=new r,tl=new r,jc={center:null,radius:0},ul,Ig=new ia,ej=[0,0],Jg,cb,fj,Kg,Pj={},xe,ye,Lg=null,la=[],vl=0;8>vl;vl++)la.push(new r);var sa=
[new r,new r,new r,new r,new r,new r,new r,new r];Object.assign(Qf.prototype,{sortCompare:function(a,b){if(a.layer===b.layer){if(a.drawOrder&&b.drawOrder)return a.drawOrder-b.drawOrder;if(a.zdist&&b.zdist)return b.zdist-a.zdist;if(a.zdist2&&b.zdist2)return a.zdist2-b.zdist2}return b._key[0]-a._key[0]},sortCompareMesh:function(a,b){if(a.layer===b.layer){if(a.drawOrder&&b.drawOrder)return a.drawOrder-b.drawOrder;if(a.zdist&&b.zdist)return b.zdist-a.zdist}xe=a._key[0];ye=b._key[0];return xe===ye&&a.mesh&&
b.mesh?b.mesh.id-a.mesh.id:ye-xe},depthSortCompare:function(a,b){xe=a._key[1];ye=b._key[1];return xe===ye&&a.mesh&&b.mesh?b.mesh.id-a.mesh.id:ye-xe},lightCompare:function(a,b){return a.key-b.key},_isVisible:function(a,b){if(!b.visible)return!1;if(b.isVisibleFunc)return b.isVisibleFunc(a);ul=b.aabb.center;b._aabb._radiusVer!==b._aabbVer&&(b._aabb._radius=b._aabb.halfExtents.length(),b._aabb._radiusVer=b._aabbVer);jc.radius=b._aabb._radius;jc.center=ul;return a.frustum.containsSphere(jc)},getShadowCamera:function(a,
b){var c=b._shadowCamera;if(null===c){c=b._shadowType;var d=2;var e=4===c||0===c&&a.webgl2;1===b._type&&(e=!1);e||(d|=1);e=new Pa;1<=c&&3>=c?(e.clearColor[0]=0,e.clearColor[1]=0,e.clearColor[2]=0,e.clearColor[3]=0):(e.clearColor[0]=1,e.clearColor[1]=1,e.clearColor[2]=1,e.clearColor[3]=1);e.clearDepth=1;e.clearFlags=d;e.clearStencil=null;e._node=new Z;c=b._shadowCamera=e;Oj(a,b)}else d=c.renderTarget,d.width===b._shadowResolution&&d.height===b._shadowResolution||Oj(a,b);return c},updateCameraFrustum:function(a){if(a.vrDisplay&&
a.vrDisplay.presenting){Ab=a.vrDisplay.combinedProj;var b=a._node.parent;b?mb.copy(b.getWorldTransform()).mul(a.vrDisplay.combinedViewInv).invert():mb.copy(a.vrDisplay.combinedView);Kb.copy(mb).invert();this.viewInvId.setValue(Kb.data);a.frustum.update(Ab,mb)}else if(a.xr&&a.xr.views.length){b=a.xr.views[0];a.frustum.update(b.projMat,b.viewOffMat);return}Ab=a.getProjectionMatrix();a.overrideCalculateProjection&&a.calculateProjection(Ab,0);if(a.overrideCalculateTransform)a.calculateTransform(Kb,0);
else{b=a._node.getPosition();var c=a._node.getRotation();Kb.setTRS(b,c,r.ONE);this.viewInvId.setValue(Kb.data)}mb.copy(Kb).invert();a.frustum.update(Ab,mb)},setCamera:function(a,b,c,d){var e=a.vrDisplay,g;if(e&&e.presenting){pf=e.leftProj;qf=e.rightProj;Ab=e.combinedProj;a.overrideCalculateProjection&&(a.calculateProjection(pf,1),a.calculateProjection(qf,2),a.calculateProjection(Ab,0));if(a.overrideCalculateTransform)a.calculateTransform(yc,1),a.calculateTransform(zc,2),a.calculateTransform(Kb,0),
te.copy(yc).invert(),ue.copy(zc).invert(),mb.copy(Kb).invert();else if(g=a._node.parent){var k=g.getWorldTransform();yc.mul2(k,e.leftViewInv);zc.mul2(k,e.rightViewInv);te.copy(yc).invert();ue.copy(zc).invert();mb.copy(g.getWorldTransform()).mul(e.combinedViewInv).invert()}else yc.copy(e.leftViewInv),zc.copy(e.rightViewInv),te.copy(e.leftView),ue.copy(e.rightView),mb.copy(e.combinedView);Rf(nl,te);Rf(ol,ue);pl.mul2(pf,te);ql.mul2(qf,ue);ve.x=yc.data[12];ve.y=yc.data[13];ve.z=yc.data[14];we.x=zc.data[12];
we.y=zc.data[13];we.z=zc.data[14];a.frustum.update(Ab,mb)}else if(a.xr&&a.xr.session){(g=a._node.parent)&&(k=g.getWorldTransform());e=a.xr.views;for(var f=0;f<e.length;f++){var h=e[f];g?(h.viewInvOffMat.mul2(k,h.viewInvMat),h.viewOffMat.copy(h.viewInvOffMat).invert()):(h.viewInvOffMat.copy(h.viewInvMat),h.viewOffMat.copy(h.viewMat));Rf(h.viewMat3,h.viewOffMat);h.projViewOffMat.mul2(h.projMat,h.viewOffMat);h.position[0]=h.viewInvOffMat.data[12];h.position[1]=h.viewInvOffMat.data[13];h.position[2]=
h.viewInvOffMat.data[14];a.frustum.update(h.projMat,h.viewOffMat)}}else Ab=a.getProjectionMatrix(),a.overrideCalculateProjection&&a.calculateProjection(Ab,0),this.projId.setValue(Ab.data),this.projSkyboxId.setValue(a.getProjectionMatrixSkybox().data),a.overrideCalculateTransform?a.calculateTransform(Kb,0):(g=a._node.getPosition(),k=a._node.getRotation(),Kb.setTRS(g,k,r.ONE)),this.viewInvId.setValue(Kb.data),mb.copy(Kb).invert(),this.viewId.setValue(mb.data),Rf(ll,mb),this.viewId3.setValue(ll.data),
ml.mul2(Ab,mb),this.viewProjId.setValue(ml.data),g=a._node.getPosition(),this.viewPos[0]=g.x,this.viewPos[1]=g.y,this.viewPos[2]=g.z,this.viewPosId.setValue(this.viewPos),a.frustum.update(Ab,mb);this.nearClipId.setValue(a._nearClip);this.farClipId.setValue(a._farClip);this.cameraParamsId.setValue(a._shaderParams);g=this.device;g.setRenderTarget(b);g.updateBegin();e=a.getRect();k=b?b.width:g.width;b=b?b.height:g.height;f=Math.floor(e.x*k);h=Math.floor(e.y*b);var p=Math.floor(e.width*k);e=Math.floor(e.height*
b);g.setViewport(f,h,p,e);g.setScissor(f,h,p,e);c&&g.clear(a._clearOptions);e=a._scissorRect;f=Math.floor(e.x*k);h=Math.floor(e.y*b);p=Math.floor(e.width*k);e=Math.floor(e.height*b);g.setScissor(f,h,p,e);d&&g.setScissor(1,1,k-2,b-2)},dispatchGlobalLights:function(a){var b;this.mainLight=-1;this.ambientColor[0]=a.ambientLight.r;this.ambientColor[1]=a.ambientLight.g;this.ambientColor[2]=a.ambientLight.b;if(a.gammaCorrection)for(b=0;3>b;b++)this.ambientColor[b]=Math.pow(this.ambientColor[b],2.2);this.ambientId.setValue(this.ambientColor);
this.exposureId.setValue(a.exposure);a.skyboxModel&&this.skyboxIntensityId.setValue(a.skyboxIntensity)},_resolveLight:function(a,b){var c="light"+b;this.lightColorId[b]=a.resolve(c+"_color");this.lightDir[b]=new Float32Array(3);this.lightDirId[b]=a.resolve(c+"_direction");this.lightShadowMapId[b]=a.resolve(c+"_shadowMap");this.lightShadowMatrixId[b]=a.resolve(c+"_shadowMatrix");this.lightShadowParamsId[b]=a.resolve(c+"_shadowParams");this.lightShadowMatrixVsId[b]=a.resolve(c+"_shadowMatrixVS");this.lightShadowParamsVsId[b]=
a.resolve(c+"_shadowParamsVS");this.lightDirVs[b]=new Float32Array(3);this.lightDirVsId[b]=a.resolve(c+"_directionVS");this.lightRadiusId[b]=a.resolve(c+"_radius");this.lightPos[b]=new Float32Array(3);this.lightPosId[b]=a.resolve(c+"_position");this.lightInAngleId[b]=a.resolve(c+"_innerConeAngle");this.lightOutAngleId[b]=a.resolve(c+"_outerConeAngle");this.lightPosVsId[b]=a.resolve(c+"_positionVS");this.lightCookieId[b]=a.resolve(c+"_cookie");this.lightCookieIntId[b]=a.resolve(c+"_cookieIntensity");
this.lightCookieMatrixId[b]=a.resolve(c+"_cookieMatrix");this.lightCookieOffsetId[b]=a.resolve(c+"_cookieOffset")},dispatchDirectLights:function(a,b,c){var d=a.length,e,g=0;this.mainLight=-1;var k=this.device.scope;for(e=0;e<d;e++)if(a[e].mask&c){var f=a[e];var h=f._node.getWorldTransform();this.lightColorId[g]||this._resolveLight(k,g);this.lightColorId[g].setValue(b.gammaCorrection?f._linearFinalColor:f._finalColor);h.getY(f._direction).scale(-1);f._direction.normalize();this.lightDir[g][0]=f._direction.x;
this.lightDir[g][1]=f._direction.y;this.lightDir[g][2]=f._direction.z;this.lightDirId[g].setValue(this.lightDir[g]);if(f.castShadows){var p=f._isPcf&&this.device.webgl2?f._shadowCamera.renderTarget.depthBuffer:f._shadowCamera.renderTarget.colorBuffer;f._isVsm?h=-2E-4:(h=f.shadowBias/f._shadowCamera._farClip*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(h*=-100));var n=f._isVsm?f.vsmBias/(f._shadowCamera._farClip/7):f._normalOffsetBias;this.lightShadowMapId[g].setValue(p);this.lightShadowMatrixId[g].setValue(f._shadowMatrix.data);
p=f._rendererParams;3!==p.length&&(p.length=3);p[0]=f._shadowResolution;p[1]=n;p[2]=h;this.lightShadowParamsId[g].setValue(p);0>this.mainLight&&(this.lightShadowMatrixVsId[g].setValue(f._shadowMatrix.data),this.lightShadowParamsVsId[g].setValue(p),f._direction.normalize(),this.lightDirVs[g][0]=f._direction.x,this.lightDirVs[g][1]=f._direction.y,this.lightDirVs[g][2]=f._direction.z,this.lightDirVsId[g].setValue(this.lightDirVs[g]),this.mainLight=e)}g++}return g},dispatchPointLight:function(a,b,c,d){var e=
c._node.getWorldTransform();this.lightColorId[d]||this._resolveLight(b,d);this.lightRadiusId[d].setValue(c.attenuationEnd);this.lightColorId[d].setValue(a.gammaCorrection?c._linearFinalColor:c._finalColor);e.getTranslation(c._position);this.lightPos[d][0]=c._position.x;this.lightPos[d][1]=c._position.y;this.lightPos[d][2]=c._position.z;this.lightPosId[d].setValue(this.lightPos[d]);c.castShadows&&(this.lightShadowMapId[d].setValue(c._shadowCamera.renderTarget.colorBuffer),a=c._rendererParams,4!==a.length&&
(a.length=4),a[0]=c._shadowResolution,a[1]=c._normalOffsetBias,a[2]=c.shadowBias,a[3]=1/c.attenuationEnd,this.lightShadowParamsId[d].setValue(a));c._cookie&&(this.lightCookieId[d].setValue(c._cookie),this.lightShadowMatrixId[d].setValue(e.data),this.lightCookieIntId[d].setValue(c.cookieIntensity))},dispatchSpotLight:function(a,b,c,d){var e=c._node.getWorldTransform();this.lightColorId[d]||this._resolveLight(b,d);this.lightInAngleId[d].setValue(c._innerConeAngleCos);this.lightOutAngleId[d].setValue(c._outerConeAngleCos);
this.lightRadiusId[d].setValue(c.attenuationEnd);this.lightColorId[d].setValue(a.gammaCorrection?c._linearFinalColor:c._finalColor);e.getTranslation(c._position);this.lightPos[d][0]=c._position.x;this.lightPos[d][1]=c._position.y;this.lightPos[d][2]=c._position.z;this.lightPosId[d].setValue(this.lightPos[d]);e.getY(c._direction).scale(-1);c._direction.normalize();this.lightDir[d][0]=c._direction.x;this.lightDir[d][1]=c._direction.y;this.lightDir[d][2]=c._direction.z;this.lightDirId[d].setValue(this.lightDir[d]);
c.castShadows&&(c._isVsm?a=-2E-4:(a=20*c.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(a*=-100)),b=c._isVsm?c.vsmBias/(c.attenuationEnd/7):c._normalOffsetBias,this.lightShadowMapId[d].setValue(c._isPcf&&this.device.webgl2?c._shadowCamera.renderTarget.depthBuffer:c._shadowCamera.renderTarget.colorBuffer),this.lightShadowMatrixId[d].setValue(c._shadowMatrix.data),e=c._rendererParams,4!==e.length&&(e.length=4),e[0]=c._shadowResolution,e[1]=b,e[2]=a,e[3]=1/c.attenuationEnd,this.lightShadowParamsId[d].setValue(e));
c._cookie&&(this.lightCookieId[d].setValue(c._cookie),c.castShadows||(a=this.getShadowCamera(this.device,c),b=a._node,b.setPosition(c._node.getPosition()),b.setRotation(c._node.getRotation()),b.rotateLocal(-90,0,0),a.projection=0,a.aspectRatio=1,a.fov=2*c._outerConeAngle,Hd.setTRS(b.getPosition(),b.getRotation(),r.ONE).invert(),Gg.mul2(a.getProjectionMatrix(),Hd),c._shadowMatrix.mul2(il,Gg)),this.lightShadowMatrixId[d].setValue(c._shadowMatrix.data),this.lightCookieIntId[d].setValue(c.cookieIntensity),
c._cookieTransform&&(c._cookieTransformUniform[0]=c._cookieTransform.x,c._cookieTransformUniform[1]=c._cookieTransform.y,c._cookieTransformUniform[2]=c._cookieTransform.z,c._cookieTransformUniform[3]=c._cookieTransform.w,this.lightCookieMatrixId[d].setValue(c._cookieTransformUniform),c._cookieOffsetUniform[0]=c._cookieOffset.x,c._cookieOffsetUniform[1]=c._cookieOffset.y,this.lightCookieOffsetId[d].setValue(c._cookieOffsetUniform)))},dispatchLocalLights:function(a,b,c,d,e){var g=a[1];a=a[2];var k=
g.length,f=a.length,h=d,p=this.device.scope;for(d=0;d<k;d++){var n=g[d];n.mask&c&&!n.isStatic&&(this.dispatchPointLight(b,p,n,h),h++)}g=0;if(e)for(n=e[g];n&&1===n._type;)this.dispatchPointLight(b,p,n,h),h++,g++,n=e[g];for(d=0;d<f;d++)n=a[d],n.mask&c&&!n.isStatic&&(this.dispatchSpotLight(b,p,n,h),h++);if(e)for(n=e[g];n&&2===n._type;)this.dispatchSpotLight(b,p,n,h),h++,g++,n=e[g]},cull:function(a,b,c){var d=0,e,g=b.length,k=a.cullingMask||4294967295;if(!a.frustumCulling){for(e=0;e<g;e++){var f=b[e];
if(f.visible||f.command)f.mask&&0===(f.mask&k)||(c[d]=f,d++,f.visibleThisFrame=!0)}return d}for(e=0;e<g;e++)if(f=b[e],f.command)c[d]=f,d++,f.visibleThisFrame=!0;else if(f.visible){var h=!0;f.mask&&0===(f.mask&k)||(f.cull&&(h=this._isVisible(a,f)),h&&(c[d]=f,d++,f.visibleThisFrame=!0))}return d},cullLights:function(a,b){var c;for(c=0;c<b.length;c++){var d=b[c];var e=d._type;d.castShadows&&d.enabled&&0!==d.shadowUpdateMode&&0!==e&&(d.getBoundingSphere(jc),a.frustum.containsSphere(jc)&&(d.visibleThisFrame=
!0))}},updateCpuSkinMatrices:function(a){var b=a.length;if(0!==b){var c,d;for(c=0;c<b;c++)if(d=a[c].skinInstance)d.updateMatrices(a[c].node),d._dirty=!0}},updateGpuSkinMatrices:function(a){var b,c,d=a.length;for(b=0;b<d;b++)a[b].visibleThisFrame&&(c=a[b].skinInstance)&&c._dirty&&(c.updateMatrixPalette(),c._dirty=!1)},updateMorphing:function(a){var b,c,d=a.length;for(b=0;b<d;b++)(c=a[b].morphInstance)&&c._dirty&&a[b].visibleThisFrame&&(c.update(),c._dirty=!1)},setBaseConstants:function(a,b){a.setCullMode(b.cull);
b.opacityMap&&(this.opacityMapId.setValue(b.opacityMap),this.alphaTestId.setValue(b.alphaTest))},setSkinning:function(a,b,c){b.skinInstance&&(this._skinDrawCalls++,a.supportsBoneTextures?(Jg=b.skinInstance.boneTexture,this.boneTextureId.setValue(Jg),ej[0]=Jg.width,ej[1]=Jg.height,this.boneTextureSizeId.setValue(ej)):this.poseMatrixId.setValue(b.skinInstance.matrixPalette))},drawInstance:function(a,b,c,d,e){if(cb=b.instancingData){if(0<cb.count&&(this._instancedDrawCalls++,this._removedByInstancing+=
cb.count,a.setVertexBuffer(cb.vertexBuffer,1,cb.offset),a.draw(c.primitive[d],cb.count),cb.vertexBuffer===Lg))return b.instancingData=null,cb.count-1}else fj=b.node.worldTransform,this.modelMatrixId.setValue(fj.data),e&&(Kg=b.node.normalMatrix,b.node._dirtyNormal&&(fj.invertTo3x3(Kg),Kg.transpose(),b.node._dirtyNormal=!1),this.normalMatrixId.setValue(Kg.data)),a.draw(c.primitive[d]);return 0},drawInstance2:function(a,b,c,d){if(cb=b.instancingData){if(0<cb.count&&(this._instancedDrawCalls++,this._removedByInstancing+=
cb.count,a.setVertexBuffer(cb.vertexBuffer,1,cb.offset),a.draw(c.primitive[d],cb.count),cb.vertexBuffer===Lg))return b.instancingData=null,cb.count-1}else a.draw(c.primitive[d]);return 0},renderShadows:function(a,b){var c=this.device,d,e;for(d=0;d<a.length;d++){var g=a[d];var k=g._type;if(g.castShadows&&g.enabled&&(g._shadowCamera||this.getShadowCamera(c,g),0!==g.shadowUpdateMode&&g.visibleThisFrame)){var f=this.getShadowCamera(c,g);var h=f._node;var p=0;var n=1;if(0===k){if(0>g._visibleLength[b])continue;
p=g._visibleCameraSettings[b];h.setPosition(p.x,p.y,p.z);f.orthoHeight=p.orthoHeight;f.farClip=p.farClip;p=b}else if(2===k){var m=h.getPosition();this.viewPos[0]=m.x;this.viewPos[1]=m.y;this.viewPos[2]=m.z;this.viewPosId.setValue(this.viewPos);this.shadowMapLightRadiusId.setValue(g.attenuationEnd)}else 1===k&&(m=h.getPosition(),this.viewPos[0]=m.x,this.viewPos[1]=m.y,this.viewPos[2]=m.z,this.viewPosId.setValue(this.viewPos),this.shadowMapLightRadiusId.setValue(g.attenuationEnd),n=6);1!==k&&(Hd.setTRS(h.getPosition(),
h.getRotation(),r.ONE).invert(),Gg.mul2(f.getProjectionMatrix(),Hd),g._shadowMatrix.mul2(il,Gg));c.webgl2?1===k?c.setDepthBias(!1):(c.setDepthBias(!0),c.setDepthBiasValues(-1E3*g.shadowBias,-1E3*g.shadowBias)):c.extStandardDerivatives&&(1===k?(this.polygonOffset[0]=0,this.polygonOffset[1]=0):(this.polygonOffset[0]=-1E3*g.shadowBias,this.polygonOffset[1]=-1E3*g.shadowBias),this.polygonOffsetId.setValue(this.polygonOffset));1===g.shadowUpdateMode&&(g.shadowUpdateMode=0);this._shadowMapUpdates+=n;c.setBlending(!1);
c.setDepthWrite(!0);c.setDepthTest(!0);g._isPcf&&c.webgl2&&1!==k?c.setColorWrite(!1,!1,!1,!1):c.setColorWrite(!0,!0,!0,!0);for(p?n=p+1:p=0;p<n;){1===k&&(h.setRotation(jl[p]),f.renderTarget=g._shadowCubeMap[p]);this.setCamera(f,f.renderTarget,!0,1!==k);m=g._visibleList[p];var q=g._visibleLength[p];var u=g._shadowType;var t=u+5*k;for(u=0;u<q;u++){var y=m[u];var w=y.mesh;var v=y.material;this.setBaseConstants(c,v);this.setSkinning(c,y,v);v.dirty&&(v.updateUniforms(),v.dirty=!1);if(v.chunks){var x=v.parameters;
for(e in x)v=x[e],v.passFlags&8&&(v.scopeId||(v.scopeId=c.scope.resolve(e)),v.scopeId.setValue(v.data));this.setCullMode(!0,!1,y);x=y.parameters;for(e in x)v=x[e],v.passFlags&8&&(v.scopeId||(v.scopeId=c.scope.resolve(e)),v.scopeId.setValue(v.data))}v=y._shader[3+t];if(!v){this.updateShader(y,y._shaderDefs,null,3+t);v=y._shader[3+t];x=y._key;var z=y.material,A=y.skinInstance?10:0,F=0;z.opacityMap&&(z=z.opacityMapChannel)&&(F=io[z]);x[1]=A+F}c.setShader(v);v=y.renderStyle;this.setVertexBuffers(c,w,
y.morphInstance);c.setIndexBuffer(w.indexBuffer[v]);u+=this.drawInstance(c,y,w,v);this._shadowDrawCalls++}p++;0===k&&(g._visibleLength[b]=-1)}if(g._isVsm&&(k=g._vsmBlurSize,1<k)){f=f.renderTarget;h=Mj(c,g._shadowResolution,g._shadowType,1);n=1===g._shadowType;p=g.vsmBlurMode;m=(n?this.blurPackedVsmShader:this.blurVsmShader)[p][k];if(!m){m=this.blurVsmWeights;v=u=k;25<v&&(v=25);x=(v-1)/6;t=.5*(v-1);y=Array(v);for(w=q=0;w<v;++w)A=w-t,y[w]=Math.exp(-(A*A)/(2*x*x)),q+=y[w];for(w=0;w<v;++w)y[w]/=q;m[u]=
y;m=K.fullscreenQuadVS;u="#define SAMPLES "+k+"\n";u=n?u+this.blurPackedVsmShaderCode[p]:u+this.blurVsmShaderCode[p];m=K.createShaderFromCode(this.device,m,u,"blurVsm"+p+k+n);n?this.blurPackedVsmShader[p][k]=m:this.blurVsmShader[p][k]=m}of.z=g._shadowResolution-2;of.w=of.z;this.sourceId.setValue(f.colorBuffer);Gd[0]=1/g._shadowResolution;Gd[1]=0;this.pixelOffsetId.setValue(Gd);1===p&&this.weightId.setValue(this.blurVsmWeights[k]);La(c,h,m,null,of);this.sourceId.setValue(h.colorBuffer);Gd[1]=Gd[0];
Gd[0]=0;this.pixelOffsetId.setValue(Gd);La(c,f,m,null,of)}}}c.webgl2?c.setDepthBias(!1):c.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))},updateShader:function(a,b,c,d,e){a.material._scene=this.scene;a.material.updateShader(this.device,this.scene,b,c,d,e);a._shader[d]=a.material.shader},setCullMode:function(a,b,c){var d=c.material,e=0;a&&(a=1,0<d.cull&&3>d.cull&&(c.flipFaces&&(a*=-1),b&&(a*=-1),b=c.node.worldTransform,b.getX(Hg),
b.getY(rl),b.getZ(sl),Hg.cross(Hg,rl),0>Hg.dot(sl)&&(a*=-1)),e=0>a?2===d.cull?1:2:d.cull);this.device.setCullMode(e)},setVertexBuffers:function(a,b,c){if(c){this.tempSemanticArray.length=0;for(var d,e=0;e<c._activeVertexBuffers.length;e++){var g="ATTR"+e;(d=c._activeVertexBuffers[e])?(d.format.elements[0].name=g,d.format.elements[0].scopeId=a.scope.resolve(g),a.setVertexBuffer(d,e+1)):(a.setVertexBuffer(null,e+1),this.tempSemanticArray.push(g))}this.tempSemanticArray.length&&a.disableVertexBufferElements(this.tempSemanticArray);
this.morphWeightsA.setValue(c._shaderMorphWeightsA);this.morphWeightsB.setValue(c._shaderMorphWeightsB)}a.setVertexBuffer(b.vertexBuffer,0)},renderForward:function(a,b,c,d,e,g,k,f){var h=this.device,l=this.scene,n=a.vrDisplay,m=1<<e;f=f?f._lightHash:0;var q,u=null,t,r=.5*h.width;for(q=0;q<c;q++){var w=b[q];if(!g||!w.mask||g&w.mask)if(w.command)w.command();else{var v=w.mesh;var x=w.material;var z=w._shaderDefs;var A=w.mask;this.setSkinning(h,w,x);x&&x===u&&z!==F&&(u=null);if(w.isStatic||Q)u=null;if(x!==
u){this._materialSwitches++;x.dirty&&(x.updateUniforms(),x.dirty=!1);if(!w._shader[e]||w._shaderDefs!==z||w._lightHash!==f){if(w.isStatic)this.updateShader(w,z,w._staticLightList,e,d);else{var F=e+"_"+z+"_"+f;w._shader[e]=x.variants[F];w._shader[e]||(this.updateShader(w,z,null,e,d),x.variants[F]=w._shader[e])}w._shaderDefs=z;w._lightHash=f}h.setShader(w._shader[e]);F=x.parameters;for(t in F){var Q=F[t];Q.passFlags&m&&(Q.scopeId||(Q.scopeId=h.scope.resolve(t)),Q.scopeId.setValue(Q.data))}if(!u||A!==
D){var D=this.dispatchDirectLights(d[0],l,A);this.dispatchLocalLights(d,l,A,D,w._staticLightList)}this.alphaTestId.setValue(x.alphaTest);h.setBlending(x.blend);x.blend&&(x.separateAlphaBlend?(h.setBlendFunctionSeparate(x.blendSrc,x.blendDst,x.blendSrcAlpha,x.blendDstAlpha),h.setBlendEquationSeparate(x.blendEquation,x.blendAlphaEquation)):(h.setBlendFunction(x.blendSrc,x.blendDst),h.setBlendEquation(x.blendEquation)));h.setColorWrite(x.redWrite,x.greenWrite,x.blueWrite,x.alphaWrite);h.setDepthWrite(x.depthWrite);
h.setDepthTest(x.depthTest);h.setAlphaToCoverage(x.alphaToCoverage);x.depthBias||x.slopeDepthBias?(h.setDepthBias(!0),h.setDepthBiasValues(x.depthBias,x.slopeDepthBias)):h.setDepthBias(!1)}this.setCullMode(a._cullFaces,a._flipFaces,w);D=w.stencilFront||x.stencilFront;F=w.stencilBack||x.stencilBack;D||F?(h.setStencilTest(!0),D===F?(h.setStencilFunc(D.func,D.ref,D.readMask),h.setStencilOperation(D.fail,D.zfail,D.zpass,D.writeMask)):(D?(h.setStencilFuncFront(D.func,D.ref,D.readMask),h.setStencilOperationFront(D.fail,
D.zfail,D.zpass,D.writeMask)):(h.setStencilFuncFront(7,0,255),h.setStencilOperationFront(0,0,0,255)),F?(h.setStencilFuncBack(F.func,F.ref,F.readMask),h.setStencilOperationBack(F.fail,F.zfail,F.zpass,F.writeMask)):(h.setStencilFuncBack(7,0,255),h.setStencilOperationBack(0,0,0,255)))):h.setStencilTest(!1);F=w.parameters;for(t in F)Q=F[t],Q.passFlags&m&&(Q.scopeId||(Q.scopeId=h.scope.resolve(t)),Q.scopeId.setValue(Q.data));this.setVertexBuffers(h,v,w.morphInstance);D=w.renderStyle;h.setIndexBuffer(v.indexBuffer[D]);
k&&k(w,q);if(n&&n.presenting)h.setViewport(0,0,r,h.height),this.projId.setValue(pf.data),this.projSkyboxId.setValue(pf.data),this.viewInvId.setValue(yc.data),this.viewId.setValue(te.data),this.viewId3.setValue(nl.data),this.viewProjId.setValue(pl.data),this.viewPos[0]=ve.x,this.viewPos[1]=ve.y,this.viewPos[2]=ve.z,this.viewPosId.setValue(this.viewPos),q+=this.drawInstance(h,w,v,D,!0),this._forwardDrawCalls++,h.setViewport(r,0,r,h.height),this.projId.setValue(qf.data),this.projSkyboxId.setValue(qf.data),
this.viewInvId.setValue(zc.data),this.viewId.setValue(ue.data),this.viewId3.setValue(ol.data),this.viewProjId.setValue(ql.data),this.viewPos[0]=we.x,this.viewPos[1]=we.y,this.viewPos[2]=we.z,this.viewPosId.setValue(this.viewPos),q+=this.drawInstance2(h,w,v,D),this._forwardDrawCalls++;else if(a.xr&&a.xr.session&&a.xr.views.length)for(u=a.xr.views,Q=0;Q<u.length;Q++){var E=u[Q];h.setViewport(E.viewport.x,E.viewport.y,E.viewport.z,E.viewport.w);this.projId.setValue(E.projMat.data);this.projSkyboxId.setValue(E.projMat.data);
this.viewId.setValue(E.viewOffMat.data);this.viewInvId.setValue(E.viewInvOffMat.data);this.viewId3.setValue(E.viewMat3.data);this.viewProjId.setValue(E.projViewOffMat.data);this.viewPosId.setValue(E.position);q=0===Q?q+this.drawInstance(h,w,v,D,!0):q+this.drawInstance2(h,w,v,D,!0);this._forwardDrawCalls++}else q+=this.drawInstance(h,w,v,D,!0),this._forwardDrawCalls++;if(q<c-1&&b[q+1].material===x)for(t in F)if(Q=x.parameters[t])Q.scopeId||(Q.scopeId=h.scope.resolve(t)),Q.scopeId.setValue(Q.data);
u=x;F=z;D=A;Q=w.isStatic}}h.updateEnd()},setupInstancing:function(a){a.enableAutoInstancing&&(Lg||(Lg=new Za(a,Ka.defaultInstancingFormat,a.autoInstancingMaxObjects,1)))},revertStaticMeshes:function(a){var b,c=a.length,d=[];for(b=0;b<c;b++){var e=a[b];if(e._staticSource){if(e._staticSource!==g){d.push(e._staticSource);var g=e._staticSource}}else d.push(e)}a.length=d.length;for(b=0;b<d.length;b++)a[b]=d[b]},prepareStaticMeshes:function(a,b){var c,d,e,g,k=this.device,f=a.length,h=[],p,n,m,q=new r,u=
new r,t=new ia,y=new C,w=[],v,x=[],z=[],A=[];for(c=0;c<f;c++){var F=a[c];if(F.isStatic){var Q=F.aabb;A.length=0;for(v=1;2>=v;v++)for(d=0;d<b.length;d++){var D=b[d];D._type===v&&D.enabled&&D.mask&F.mask&&D.isStatic&&(x[d]||(x[d]=new ia,D._node.getWorldTransform(),D.getBoundingSphere(jc),x[d].center.copy(jc.center),x[d].halfExtents.x=jc.radius,x[d].halfExtents.y=jc.radius,x[d].halfExtents.z=jc.radius),x[d].intersects(Q)&&A.push(d))}if(0===A.length)h.push(F);else{Q=F.mesh;v=Q.vertexBuffer;D=Q.indexBuffer[F.renderStyle];
var E=2===D.bytesPerIndex?new Uint16Array(D.lock()):new Uint32Array(D.lock());var B=Q.primitive[F.renderStyle].count/3;var H=Q.primitive[F.renderStyle].base;var G=v.format.elements;var O=v.format.size/4;Q=new Float32Array(v.storage);for(e=0;e<G.length;e++)"POSITION"===G[e].name&&(p=G[e].offset/4);w.length=B;for(e=0;e<B;e++)w[e]=0;G=!1;z.length=6*B;for(e=0;e<B;e++){var I=m=n=Number.MAX_VALUE;var K=-Number.MAX_VALUE;var W=-Number.MAX_VALUE;var M=-Number.MAX_VALUE;for(g=0;3>g;g++){d=E[3*e+g+H];d=d*O+
p;var J=Q[d];var R=Q[d+1];d=Q[d+2];J<n&&(n=J);R<m&&(m=R);d<I&&(I=d);J>K&&(K=J);R>W&&(W=R);d>M&&(M=d)}d=6*e;z[d]=n;z[d+1]=m;z[d+2]=I;z[d+3]=K;z[d+4]=W;z[d+5]=M}for(J=0;J<A.length;J++)for(d=A[J],y.copy(F.node.worldTransform).invert(),t.setFromTransformedAabb(x[d],y),R=t.getMin(),n=t.getMax(),g=1<<J,e=0;e<B;e++)d=6*e,z[d]<=n.x&&z[d+3]>=R.x&&z[d+1]<=n.y&&z[d+4]>=R.y&&z[d+2]<=n.z&&z[d+5]>=R.z&&(w[e]|=g,G=!0);if(G){G={};for(e=0;e<B;e++){d=3*e+H;var P=w[e];G[P]||(G[P]=[]);g=G[P];g.push(E[d]);g.push(E[d+
1]);g.push(E[d+2])}for(P in G){g=G[P];E=new Rb(k,D.format,g.length,D.usage);(2===E.bytesPerIndex?new Uint16Array(E.lock()):new Uint32Array(E.lock())).set(g);E.unlock();I=m=n=Number.MAX_VALUE;K=-Number.MAX_VALUE;W=-Number.MAX_VALUE;M=-Number.MAX_VALUE;for(e=0;e<g.length;e++)d=g[e],J=Q[d*O+p],R=Q[d*O+p+1],d=Q[d*O+p+2],J<n&&(n=J),R<m&&(m=R),d<I&&(I=d),J>K&&(K=J),R>W&&(W=R),d>M&&(M=d);q.set(n,m,I);u.set(K,W,M);e=new ia;e.setMinMax(q,u);B=new fb(k);B.vertexBuffer=v;B.indexBuffer[0]=E;B.primitive[0].type=
4;B.primitive[0].base=0;B.primitive[0].count=g.length;B.primitive[0].indexed=!0;B.aabb=e;E=new ma(F.node,B,F.material);E.isStatic=F.isStatic;E.visible=F.visible;E.layer=F.layer;E.castShadow=F.castShadow;E._receiveShadow=F._receiveShadow;E.cull=F.cull;E.pick=F.pick;E.mask=F.mask;E.parameters=F.parameters;E._shaderDefs=F._shaderDefs;E._staticSource=F;E._staticLightList=F._staticLightList?F._staticLightList:[];for(e=0;e<A.length;e++)g=1<<e,P&g&&(B=b[A[e]],0>E._staticLightList.indexOf(B)&&E._staticLightList.push(B));
E._staticLightList.sort(this.lightCompare);h.push(E)}}else h.push(F)}}else h.push(F)}a.length=h.length;for(c=0;c<h.length;c++)a[c]=h[c]},updateShaders:function(a){var b,c=[];for(b=0;b<a.length;b++){var d=a[b];void 0!==d.material&&-1===c.indexOf(d.material)&&c.push(d.material)}for(b=0;b<c.length;b++)a=c[b],a.updateShader!==da.prototype.updateShader&&(a.clearVariants(),a.shader=null)},updateLitShaders:function(a){for(var b=0;b<a.length;b++){var c=a[b];void 0!==c.material&&(c=c.material,c.updateShader===
da.prototype.updateShader||!1===c.useLighting||c.emitter&&!c.emitter.lighting||(c.clearVariants(),c.shader=null))}},beginFrame:function(a){var b=this.scene,c=a._meshInstances;a=a._lights;b.updateShaders?(this.updateShaders(c),b.updateShaders=!1,b.updateLitShaders=!1,b._shaderVersion++):b.updateLitShaders&&(this.updateLitShaders(c),b.updateLitShaders=!1,b._shaderVersion++);this.updateCpuSkinMatrices(c);var d=c.length;for(b=0;b<d;b++)c[b].visibleThisFrame=!1;d=a.length;for(b=0;b<d;b++)a[b].visibleThisFrame=
0===a[b]._type},beginLayers:function(a){var b=this.scene,c=a.layerList.length,d,e=this.scene._shaderVersion;for(d=0;d<c;d++)a.layerList[d]._postRenderCounter=0;for(d=0;d<c;d++){var g=a.layerList[d];g._shaderVersion=e;g._preRenderCalledForCameras=0;g._postRenderCalledForCameras=0;var k=a.subLayerList[d];g._postRenderCounter=k?g._postRenderCounter|2:g._postRenderCounter|1;g._postRenderCounterMax=g._postRenderCounter;for(k=0;k<g.cameras.length;k++)g.instances.visibleOpaque[k]||(g.instances.visibleOpaque[k]=
new Ij),g.instances.visibleTransparent[k]||(g.instances.visibleTransparent[k]=new Ij),g.instances.visibleOpaque[k].done=!1,g.instances.visibleTransparent[k].done=!1;g.cameras.length<g.instances.visibleOpaque.length&&g.instances.visibleOpaque.splice(g.cameras.length,1);g.cameras.length<g.instances.visibleTransparent.length&&g.instances.visibleTransparent.splice(g.cameras.length,1);g._needsStaticPrepare&&g._staticLightHash&&(g._staticPrepareDone&&(this.revertStaticMeshes(g.opaqueMeshInstances),this.revertStaticMeshes(g.transparentMeshInstances)),
this.prepareStaticMeshes(g.opaqueMeshInstances,g._lights),this.prepareStaticMeshes(g.transparentMeshInstances,g._lights),a._dirty=!0,b.updateShaders=!0,g._needsStaticPrepare=!1,g._staticPrepareDone=!0)}},cullLocalShadowmap:function(a,b){var c,d,e,g;var k=a._type;if(0!==k){a.visibleThisFrame=!0;var f=this.getShadowCamera(this.device,a);f.projection=0;f.nearClip=a.attenuationEnd/1E3;f.farClip=a.attenuationEnd;f.aspectRatio=1;if(2===k){f.fov=2*a._outerConeAngle;var h=1}else f.fov=90,h=6;var p=f._node;
var n=a._node;p.setPosition(n.getPosition());2===k&&(p.setRotation(n.getRotation()),p.rotateLocal(-90,0,0));for(c=0;c<h;c++){1===k&&(p.setRotation(jl[c]),f.renderTarget=a._shadowCubeMap[c]);this.updateCameraFrustum(f);(e=a._visibleList[c])||(e=a._visibleList[c]=[]);n=g=a._visibleLength[c]=0;for(d=b.length;n<d;n++){var m=b[n];var q=!0;m.cull&&(q=this._isVisible(f,m));q&&(e[g]=m,g++,m.visibleThisFrame=!0)}a._visibleLength[c]=g;e.length!==g&&(e.length=g);e.sort(this.depthSortCompare)}}},cullDirectionalShadowmap:function(a,
b,c,d){var e=this.device;a.visibleThisFrame=!0;e=this.getShadowCamera(e,a);var g=e._node;var k=a._node;g.setPosition(k.getPosition());g.setRotation(k.getRotation());g.rotateLocal(-90,0,0);var f=a.shadowDistance||c._farClip;var h=c._nearClip;var p=c._fov*Math.PI/180;var n=c._aspect;var m=c._projection;var q=0===m?Math.tan(p/2)*h:c._orthoHeight;var u=q*n;la[0].x=u;la[0].y=-q;la[0].z=-h;la[1].x=u;la[1].y=q;la[1].z=-h;la[2].x=-u;la[2].y=q;la[2].z=-h;la[3].x=-u;la[3].y=-q;la[3].z=-h;0===m&&(q=Math.tan(p/
2)*f,u=q*n);la[4].x=u;la[4].y=-q;la[4].z=-f;la[5].x=u;la[5].y=q;la[5].z=-f;la[6].x=-u;la[6].y=q;la[6].z=-f;la[7].x=-u;la[7].y=-q;la[7].z=-f;n=tl.sub2(la[0],la[6]).length();n=Math.max(n,tl.sub2(la[4],la[6]).length());Hd.copy(g.getWorldTransform()).invert();kl.copy(Hd).mul(c._node.getWorldTransform());for(p=0;8>p;p++)kl.transformPoint(la[p],la[p]);f=h=c=1E6;u=q=m=-1E6;for(p=0;8>p;p++){var t=la[p];t.x<f&&(f=t.x);t.x>u&&(u=t.x);t.y<h&&(h=t.y);t.y>q&&(q=t.y);t.z<c&&(c=t.z);t.z>m&&(m=t.z)}p=n/a._shadowResolution;
f=Math.floor((f-.5*(n-(u-f)))/p)*p;h=Math.floor((h-.5*(n-(q-h)))/p)*p;f=.5*(f+n+f);h=.5*(h+n+h);g.translateLocal(f,h,1E5);e.projection=1;e.nearClip=0;e.farClip=2E5;e.aspectRatio=1;e.orthoHeight=.5*n;this.updateCameraFrustum(e);q=!0;(m=a._visibleList[d])||(m=a._visibleList[d]=[]);p=n=a._visibleLength[d]=0;for(u=b.length;p<u;p++){var r=b[p];t=!0;r.cull&&(t=this._isVisible(e,r));t&&(m[n]=r,n++,r.visibleThisFrame=!0,t=r.aabb,q?(Ig.copy(t),q=!1):Ig.add(t))}a._visibleLength[d]=n;m.length!==n&&(m.length=
n);m.sort(this.depthSortCompare);b=Ig.getMin();p=Ig.getMax();sa[0].x=sa[1].x=sa[2].x=sa[3].x=b.x;sa[1].y=sa[3].y=sa[7].y=sa[5].y=b.y;sa[2].z=sa[3].z=sa[6].z=sa[7].z=b.z;sa[4].x=sa[5].x=sa[6].x=sa[7].x=p.x;sa[0].y=sa[2].y=sa[4].y=sa[6].y=p.y;sa[0].z=sa[1].z=sa[4].z=sa[5].z=p.z;p=9999999999;b=-9999999999;for(m=0;8>m;++m)Hd.transformPoint(sa[m],sa[m]),n=sa[m].z,n<p&&(p=n),n>b&&(b=n);m=b;p>c&&(c=p);g.setPosition(k.getPosition());g.translateLocal(f,h,m+.01);e.farClip=m-c;(k=a._visibleCameraSettings[d])||
(k=a._visibleCameraSettings[d]={});a=g.getPosition();k.x=a.x;k.y=a.y;k.z=a.z;k.orthoHeight=e.orthoHeight;k.farClip=e.farClip},gpuUpdate:function(a){this.updateGpuSkinMatrices(a);this.updateMorphing(a)},clearView:function(a,b,c){a=a.camera;var d=this.device;d.setRenderTarget(b);d.updateBegin();d.setColorWrite(!0,!0,!0,!0);d.setDepthWrite(!0);var e=a.getRect(),g=b?b.width:d.width,k=b?b.height:d.height;b=Math.floor(e.x*g);var f=Math.floor(e.y*k);g=Math.floor(e.width*g);e=Math.floor(e.height*k);d.setViewport(b,
f,g,e);d.setScissor(b,f,g,e);d.clear(c?c:a._clearOptions)},setSceneConstants:function(){var a,b=this.device,c=this.scene;this.dispatchGlobalLights(c);if("none"!==c.fog){this.fogColor[0]=c.fogColor.r;this.fogColor[1]=c.fogColor.g;this.fogColor[2]=c.fogColor.b;if(c.gammaCorrection)for(a=0;3>a;a++)this.fogColor[a]=Math.pow(this.fogColor[a],2.2);this.fogColorId.setValue(this.fogColor);"linear"===c.fog?(this.fogStartId.setValue(c.fogStart),this.fogEndId.setValue(c.fogEnd)):this.fogDensityId.setValue(c.fogDensity)}this._screenSize[0]=
b.width;this._screenSize[1]=b.height;this._screenSize[2]=1/b.width;this._screenSize[3]=1/b.height;this.screenSizeId.setValue(this._screenSize)},renderComposition:function(a){var b=this.device,c,d=a._renderedRt,e=a._renderedByCam,g=a._renderedLayer,k,f,h,p;this.scene.updateSkybox&&(this.scene._updateSkybox(b),this.scene.updateSkybox=!1);this.beginLayers(a);a._update()&2&&(this.scene.updateLitShaders=!0);this.beginFrame(a);this.setSceneConstants();var n=0;for(k=0;k<a.layerList.length;k++){var m=a.layerList[k];
if(m.enabled&&a.subLayerEnabled[k]){var q=a.subLayerList[k];var u=m.instances;var t=m.cameras;for(f=0;f<t.length;f++)if(c=t[f]){c.frameBegin(m.renderTarget);var r=q?m.transparentMeshInstances:m.opaqueMeshInstances;var w=p=!1;for(h=0;h<n;h++)if(e[h]===c&&(p=!0,g[h]===m)){w=!0;break}p||(this.updateCameraFrustum(c.camera),this._camerasRendered++);w||this.cullLights(c.camera,m._lights);p&&w||(e[n]=c,g[n]=m,n++);h=q?u.visibleTransparent[f]:u.visibleOpaque[f];if(!h.done){if(m.onPreCull)m.onPreCull(f);h.length=
this.cull(c.camera,r,h.list);h.done=!0;if(m.onPostCull)m.onPostCull(f)}c.frameEnd()}}}for(k=0;k<a._lights.length;k++)c=a._lights[k],c.visibleThisFrame&&0!==c._type&&c.castShadows&&c.enabled&&0!==c.shadowUpdateMode&&(m=a._lightShadowCasters[k],this.cullLocalShadowmap(c,m));q=-1;for(k=0;k<a._lights.length;k++)if(c=a._lights[k],0===c._type&&(q++,c.castShadows&&c.enabled&&0!==c.shadowUpdateMode))for(m=a._lightShadowCasters[k],t=a._globalLightCameras[q],f=0;f<t.length;f++)this.cullDirectionalShadowmap(c,
m,t[f].camera,a._globalLightCameraIds[q][f]);this.gpuUpdate(a._meshInstances);this.renderShadows(a._sortedLights[2]);this.renderShadows(a._sortedLights[1]);for(k=n=0;k<a._renderList.length;k++)if(m=a.layerList[a._renderList[k]],m.enabled&&a.subLayerEnabled[a._renderList[k]]){u=m.instances;q=a.subLayerList[a._renderList[k]];t=a._renderListCamera[k];(c=m.cameras[t])&&c.frameBegin(m.renderTarget);if(!q&&m.onPreRenderOpaque)m.onPreRenderOpaque(t);else if(q&&m.onPreRenderTransparent)m.onPreRenderTransparent(t);
if(!(m._preRenderCalledForCameras&1<<t)){if(m.onPreRender)m.onPreRender(t);m._preRenderCalledForCameras|=1<<t;m.overrideClear&&this.clearView(c,m.renderTarget,m._clearOptions)}if(c){f=m.renderTarget;g=!1;for(h=0;h<n;h++)if(d[h]===f&&e[h]===c){g=!0;break}g||(m.overrideClear||this.clearView(c,m.renderTarget),d[n]=f,e[n]=c,n++);this.renderShadows(m._sortedLights[0],t);m._sortVisible(q,c.node,t);h=q?u.visibleTransparent[t]:u.visibleOpaque[t];this.scene._activeCamera=c.camera;this.setCamera(c.camera,m.renderTarget);
this.renderForward(c.camera,h.list,h.length,m._sortedLights,m.shaderPass,m.cullingMask,m.onDrawCall,m);b.setColorWrite(!0,!0,!0,!0);b.setStencilTest(!1);b.setAlphaToCoverage(!1);b.setDepthBias(!1);c.frameEnd()}if(!q&&m.onPostRenderOpaque)m.onPostRenderOpaque(t);else if(q&&m.onPostRenderTransparent)m.onPostRenderTransparent(t);!m.onPostRender||m._postRenderCalledForCameras&1<<t||(m._postRenderCounter&=~(q?2:1),0===m._postRenderCounter&&(m.onPostRender(t),m._postRenderCalledForCameras|=1<<t,m._postRenderCounter=
m._postRenderCounterMax))}}});Jc.prototype=Object.create(da.prototype);Jc.prototype.constructor=Jc;Object.assign(Jc.prototype,{clone:function(){var a=new Jc;da.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.colorMap=this.colorMap;a.vertexColors=this.vertexColors;return a},updateUniforms:function(){this.clearParameters();this.colorUniform[0]=this.color.r;this.colorUniform[1]=this.color.g;this.colorUniform[2]=this.color.b;this.colorUniform[3]=this.color.a;this.setParameter("uColor",
this.colorUniform);this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},updateShader:function(a,b,c,d,e,g){b={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:this.colorMap,pass:e};this.shader=a.getProgramLibrary().getProgram("basic",b)}});var Mg=new Z;Sf.prototype.addLayer=function(a){0>this.layers.indexOf(a)&&this.layers.push(a)};Sf.prototype.getLayerIdx=function(a){return this.layerToBatch[a.id]};Sf.prototype.addLayerIdx=function(a,b){this.layerToBatch[b.id]=
a};Object.assign(Qj.prototype,{init:function(a,b,c,d){this.mesh||(this.mesh=new fb(a),this.mesh.primitive[0].type=1,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new Jc,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=2,this.material.update());for(this.layer=c;this.linesUsed+d>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=b;this.vb||(this.vb=new Za(a,b,2*this.numLinesAllocated,
1),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(Mg.worldTransform=C.IDENTITY,Mg._dirtyWorld=Mg._dirtyNormal=!1,this.meshInstance=new ma(Mg,this.mesh,this.material),this.meshInstance.cull=!1))},addLines:function(a,b){for(var c=!!b.length,d=2*this.linesUsed*this.vertexFormat.size,e,g=0;g<a.length;g++)this.vbRam.setFloat32(d,a[g].x,!0),d+=4,this.vbRam.setFloat32(d,a[g].y,!0),d+=4,this.vbRam.setFloat32(d,a[g].z,!0),d+=4,e=c?b[g]:b,this.vbRam.setUint8(d,255*
e.r),d+=1,this.vbRam.setUint8(d,255*e.g),d+=1,this.vbRam.setUint8(d,255*e.b),d+=1,this.vbRam.setUint8(d,255*e.a),d+=1;this.linesUsed+=a.length/2},finalize:function(a){0<this.linesUsed&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,a[0]=this.meshInstance,this.layer.addMeshInstances(a,!0),this.linesUsed=0)}});pa.prototype=Object.create(H.prototype);pa.prototype.constructor=pa;pa.prototype._sortLights=function(a){var b=a._lights;a._sortedLights[0].length=0;a._sortedLights[1].length=
0;for(var c=a._sortedLights[2].length=0;c<b.length;c++){var d=b[c];d.enabled&&a._sortedLights[d._type].push(d)}};pa.prototype._update=function(){var a,b,c=this.layerList.length,d=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(a=0;a<c;a++){var e=this.layerList[a];e._dirty&&(this._dirty=!0);e._dirtyLights&&(this._dirtyLights=!0);e._dirtyCameras&&(this._dirtyCameras=!0)}if(this._dirty){d|=1;for(a=this._meshInstances.length=0;a<c;a++)if(e=this.layerList[a],!e.passThrough){var g=e.opaqueMeshInstances;
for(b=0;b<g.length;b++){var k=g[b];0>this._meshInstances.indexOf(k)&&(this._meshInstances.push(k),k.material&&k.material._dirtyBlend&&(this._dirtyBlend=!0,k.material._dirtyBlend=!1))}g=e.transparentMeshInstances;for(b=0;b<g.length;b++)k=g[b],0>this._meshInstances.indexOf(k)&&(this._meshInstances.push(k),k.material&&k.material._dirtyBlend&&(this._dirtyBlend=!0,k.material._dirtyBlend=!1))}for(a=0;a<c;a++)this.layerList[a]._dirty=!1,this.layerList[a]._version++;this._dirty=!1}if(this._dirtyBlend){d|=
8;for(a=0;a<c;a++)if(e=this.layerList[a],!e.passThrough){g=e.opaqueMeshInstances;k=e.transparentMeshInstances;var f=[];var h=[];for(b=0;b<g.length;b++)g[b].material&&3!==g[b].material.blendType?h.push(g[b]):f.push(g[b]);for(b=0;b<k.length;b++)k[b].material&&3!==k[b].material.blendType?h.push(k[b]):f.push(k[b]);e.opaqueMeshInstances.length=f.length;for(b=0;b<f.length;b++)e.opaqueMeshInstances[b]=f[b];e.transparentMeshInstances.length=h.length;for(b=0;b<h.length;b++)e.transparentMeshInstances[b]=h[b]}this._dirtyBlend=
!1}if(this._dirtyLights){d|=2;this._lights.length=0;for(a=this._lightShadowCasters.length=0;a<c;a++)for(e=this.layerList[a],g=e._lights,b=0;b<g.length;b++)f=g[b],k=this._lights.indexOf(f),0>k&&(this._lights.push(f),k=this._lights.length-1),(f=this._lightShadowCasters[k])||(this._lightShadowCasters[k]=[]);this._sortLights(this);this._dirtyLights=!1;for(a=0;a<c;a++)e=this.layerList[a],this._sortLights(e),e._dirtyLights=!1}if(d)for(a=0;a<c;a++)for(e=this.layerList[a],g=e._lights,b=0;b<g.length;b++){f=
g[b];k=this._lights.indexOf(f);f=this._lightShadowCasters[k];h=e.shadowCasters;for(k=0;k<f.length;)0>this._meshInstances.indexOf(f[k])?(f[k]=f[f.length-1],--f.length):k++;for(k=0;k<h.length;k++)0>f.indexOf(h[k])&&f.push(h[k])}if(d&2||this._dirtyCameras)for(this._globalLightCameras.length=0,g=this._sortedLights[0],b=0;b<g.length;b++)for(f=g[b],this._globalLightCameras[b]=[],a=0;a<c;a++)if(e=this.layerList[a],!(0>e._sortedLights[0].indexOf(f)))for(k=0;k<e.cameras.length;k++)0<=this._globalLightCameras[b].indexOf(e.cameras[k])||
this._globalLightCameras[b].push(e.cameras[k]);if(this._dirtyCameras){d|=4;for(a=this.cameras.length=0;a<c;a++)for(e=this.layerList[a],b=0;b<e.cameras.length;b++)g=e.cameras[b],k=this.cameras.indexOf(g),0>k&&this.cameras.push(g);this._renderList.length=0;for(a=k=this._renderListCamera.length=0;a<c;a++)if(k)k--;else if(e=this.layerList[a],0!==e.cameras.length||e.isPostEffect)if(f=e._cameraHash,0===f)this._renderList.push(a),this._renderListCamera.push(0);else{g=1;for(b=a+1;b<c;b++)if(h=this.layerList[b]._cameraHash,
f!==h){g=b-a-1;break}else b===c-1&&(g=b-a);if(1===g)for(f=0;f<e.cameras.length;f++)this._renderList.push(a),this._renderListCamera.push(f);else{for(f=0;f<e.cameras.length;f++)for(b=0;b<=g;b++)this._renderList.push(a+b),this._renderListCamera.push(f);k=g}}this._dirtyCameras=!1;for(a=0;a<c;a++)this.layerList[a]._dirtyCameras=!1}if(d&2||d&4)for(b=this._globalLightCameraIds.length=0;b<this._globalLightCameras.length;b++){g=[];for(a=0;a<this._globalLightCameras[b].length;a++)k=this.cameras.indexOf(this._globalLightCameras[b][a]),
0>k||g.push(k);this._globalLightCameraIds.push(g)}return d};pa.prototype._isLayerAdded=function(a){return 0<=this.layerList.indexOf(a)?!0:!1};pa.prototype._isSublayerAdded=function(a,b){for(var c=0;c<this.layerList.length;c++)if(this.layerList[c]===a&&this.subLayerList[c]===b)return!0;return!1};pa.prototype.push=function(a){this._isLayerAdded(a)||(this.layerList.push(a),this.layerList.push(a),this._opaqueOrder[a.id]=this.subLayerList.push(!1)-1,this._transparentOrder[a.id]=this.subLayerList.push(!0)-
1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};pa.prototype.insert=function(a,b){if(!this._isLayerAdded(a)){this.layerList.splice(b,0,a,a);this.subLayerList.splice(b,0,!1,!0);var c=this.layerList.length;this._updateOpaqueOrder(b,c-1);this._updateTransparentOrder(b,c-1);this.subLayerEnabled.splice(b,0,!0,!0);this._dirtyCameras=this._dirtyLights=this._dirty=!0;this.fire("add",a)}};pa.prototype.remove=function(a){var b=
this.layerList.indexOf(a);delete this._opaqueOrder[b];for(delete this._transparentOrder[b];0<=b;)this.layerList.splice(b,1),this.subLayerList.splice(b,1),this.subLayerEnabled.splice(b,1),b=this.layerList.indexOf(a),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("remove",a);a=this.layerList.length;this._updateOpaqueOrder(0,a-1);this._updateTransparentOrder(0,a-1)};pa.prototype.pushOpaque=function(a){this._isSublayerAdded(a,!1)||(this.layerList.push(a),this._opaqueOrder[a.id]=this.subLayerList.push(!1)-
1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};pa.prototype.insertOpaque=function(a,b){this._isSublayerAdded(a,!1)||(this.layerList.splice(b,0,a),this.subLayerList.splice(b,0,!1),this._updateOpaqueOrder(b,this.subLayerList.length-1),this.subLayerEnabled.splice(b,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};pa.prototype.removeOpaque=function(a){for(var b=0,c=this.layerList.length;b<c;b++)if(this.layerList[b]===
a&&!this.subLayerList[b]){this.layerList.splice(b,1);this.subLayerList.splice(b,1);c--;this._updateOpaqueOrder(b,c-1);this.subLayerEnabled.splice(b,1);this._dirtyCameras=this._dirtyLights=this._dirty=!0;0>this.layerList.indexOf(a)&&this.fire("remove",a);break}};pa.prototype.pushTransparent=function(a){this._isSublayerAdded(a,!0)||(this.layerList.push(a),this._transparentOrder[a.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",
a))};pa.prototype.insertTransparent=function(a,b){this._isSublayerAdded(a,!0)||(this.layerList.splice(b,0,a),this.subLayerList.splice(b,0,!0),this._updateTransparentOrder(b,this.subLayerList.length-1),this.subLayerEnabled.splice(b,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};pa.prototype.removeTransparent=function(a){for(var b=0,c=this.layerList.length;b<c;b++)if(this.layerList[b]===a&&this.subLayerList[b]){this.layerList.splice(b,1);this.subLayerList.splice(b,1);
c--;this._updateTransparentOrder(b,c-1);this.subLayerEnabled.splice(b,1);this._dirtyCameras=this._dirtyLights=this._dirty=!0;0>this.layerList.indexOf(a)&&this.fire("remove",a);break}};pa.prototype._getSublayerIndex=function(a,b){var c=this.layerList.indexOf(a);return 0>c||this.subLayerList[c]!==b&&(c=this.layerList.indexOf(a,c+1),0>c||this.subLayerList[c]!==b)?-1:c};pa.prototype.getOpaqueIndex=function(a){return this._getSublayerIndex(a,!1)};pa.prototype.getTransparentIndex=function(a){return this._getSublayerIndex(a,
!0)};pa.prototype.getLayerById=function(a){for(var b=0;b<this.layerList.length;b++)if(this.layerList[b].id===a)return this.layerList[b];return null};pa.prototype.getLayerByName=function(a){for(var b=0;b<this.layerList.length;b++)if(this.layerList[b].name===a)return this.layerList[b];return null};pa.prototype._updateOpaqueOrder=function(a,b){for(;a<=b;a++)!1===this.subLayerList[a]&&(this._opaqueOrder[this.layerList[a].id]=a)};pa.prototype._updateTransparentOrder=function(a,b){for(;a<=b;a++)!0===this.subLayerList[a]&&
(this._transparentOrder[this.layerList[a].id]=a)};pa.prototype._sortLayersDescending=function(a,b,c){var d,e=-1,g=-1;var k=0;for(d=a.length;k<d;k++){var f=a[k];c.hasOwnProperty(f)&&(e=Math.max(e,c[f]))}k=0;for(d=b.length;k<d;k++)f=b[k],c.hasOwnProperty(f)&&(g=Math.max(g,c[f]));return-1===e&&-1!==g?1:-1===g&&-1!==e?-1:g-e};pa.prototype.sortTransparentLayers=function(a,b){return this._sortLayersDescending(a,b,this._transparentOrder)};pa.prototype.sortOpaqueLayers=function(a,b){return this._sortLayersDescending(a,
b,this._opaqueOrder)};var $b=[],Ac=[],Ga,Ra=new r,kc=new ia,rf=new ia,sf={},wl=["texture_lightMap","texture_dirLightMap"],gj=[];Object.assign(wh.prototype,{destroy:function(){this.assets=this.renderer=this.scene=this.root=this.device=null},calculateLightmapSize:function(a){var b=this.scene.lightmapSizeMultiplier||16,c=1,d=1,e=1,g=1;if(a.model.asset){var k=this.assets.get(a.model.asset).data;k.area&&(c=k.area.x,d=k.area.y,e=k.area.z,g=k.area.uv)}else a.model._area&&(k=a.model,k._area&&(c=k._area.x,
d=k._area.y,e=k._area.z,g=k._area.uv));k=a.model.lightmapSizeMultiplier||1;c*=k;d*=k;e*=k;Ra.copy(a.localScale);for(a=a._parent;a;)Ra.mul(a.localScale),a=a._parent;Ra.x=Math.abs(Ra.x);Ra.y=Math.abs(Ra.y);Ra.z=Math.abs(Ra.z);c=c*Ra.y*Ra.z+d*Ra.x*Ra.z+e*Ra.x*Ra.y;c=Math.sqrt(c/g);return Math.min(O.nextPowerOfTwo(c*b),this.scene.lightmapMaxResolution||2048)},bake:function(a,b){var c,d,e=this.device,g=this.scene,k=1;void 0===b&&(b=1);1===b&&(k=2);var f;b=[];var h=[];if(a){var p;for(c=Ac.length-1;0<=c;c--)for(d=
0;d<a.length;d++)if(Ac[c]===a[d]){for(p=0;p<$b[c].length;p++)$b[c][p].destroy();$b.splice(c,1);Ac.splice(c,1)}p=[];for(c=0;c<a.length;c++)Tf(a[c],p,h);a=p;Tf(this.root,null,null,b)}else{for(c=0;c<$b.length;c++)for(d=0;d<$b[c].length;d++)$b[c][d].destroy();$b=[];Ac=[];a=[];Tf(this.root,a,h,b)}if(0===a.length)e.fire("lightmapper:end",{timestamp:zb(),target:this});else{p=!1;g._needsStaticPrepare&&(g._needsStaticPrepare=!1,p=!0);var n=[[],[]],m={};d=new L(this.device,{width:4,height:4,format:7,type:"rgbm"});
d.name="lightmap";for(c=0;c<a.length;c++){var q=this.calculateLightmapSize(a[c]);for(f=0;f<k;f++){var u=new L(e,{width:q,height:q,format:7,mipmaps:!1,type:0===f?"rgbm":"default",minFilter:0,magFilter:0});u.name="lightmap";n[f].push(u)}if(!m[q]){var t=new L(e,{width:q,height:q,format:7,mipmaps:!1,type:"rgbm",minFilter:0,magFilter:0});t.name="lightmap";t=new oa(e,t,{depth:!1});m[q]=t}}var r=g.layers;r._update();q=[];t=[];var w=[],v=[],x=r._lights;for(c=0;c<x.length;c++)x[c].enabled&&(u=x[c].mask,0!==
(u&4)&&(t.push(u),w.push(x[c].shadowUpdateMode),x[c].mask=4294967295,x[c].shadowUpdateMode=0===x[c]._type?2:1,q.push(x[c]),x[c].isStatic=!1)),v.push(x[c].enabled),x[c].enabled=!1;var z=K,A="#define UV1LAYOUT\n"+z.transformVS,F=z.bakeLmEndPS;u=z.createShaderFromCode(e,z.fullscreenQuadVS,z.dilatePS,"lmDilate");var Q=e.scope.resolve("source"),D=e.scope.resolve("pixelOffset"),E=e.scope.resolve("bakeDir"),B=new Float32Array(2);r=r._meshInstances;for(c=0;c<r.length;c++)r[c].node&&r[c].node.getWorldTransform();
r=g.fog;var C=g.ambientLight.r,G=g.ambientLight.g,H=g.ambientLight.b;g.fog="none";g.ambientLight.set(0,0,0);Ga||(Ga=new Pa,Ga._node=new Z,Ga.clearColor[0]=0,Ga.clearColor[1]=0,Ga.clearColor[2]=0,Ga.clearColor[3]=0,Ga.clearDepth=1,Ga.clearFlags=1,Ga.clearStencil=null,Ga.frustumCulling=!1);var I,O=[];O.length=Ac.length;for(I=0;I<b.length;I++){var W=b[I].model.model.meshInstances;var M=[];for(c=0;c<W.length;c++)M.push(W[c]._shaderDefs),W[c]._shaderDefs&=-193;for(c=0;c<Ac.length;c++)if(Ac[c]===b[I]){O[c]=
M;break}}M=[];var P=[];for(I=0;I<b.length;I++)if(M[I]=b[I].model.castShadows,b[I].model.castShadows=b[I].model.castShadowsLightmap,b[I].model.castShadowsLightmap){var R=b[I].model.meshInstances;for(c=0;c<R.length;c++)R[c].visibleThisFrame=!0,P.push(R[c])}this.renderer.updateCpuSkinMatrices(P);this.renderer.gpuUpdate(P);var U=[],X=[];R=[[],[]];var V=[];V.length=a.length;for(f=0;f<k;f++)gj[f]||(c=new ea,c.chunks.transformVS=A,0===f?(c.chunks.endPS=F,c.ambient=new J(0,0,0),c.ambientTint=!0,c.lightMap=
d):(c.chunks.basePS=z.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",c.chunks.endPS=z.bakeDirLmEndPS),c.chunks.outputAlphaPS="\n",c.chunks.outputAlphaOpaquePS="\n",c.chunks.outputAlphaPremulPS="\n",c.cull=0,c.forceUv1=!0,c.update(),c.updateShader(e,g),c.name="lmMaterial"+f,gj[f]=c);for(I=0;I<a.length;I++){W=h[I];V[I]=0;if(0<W.length)for(kc.copy(W[0].aabb),c=0;c<W.length;c++)W[c].node.getWorldTransform(),kc.add(W[c].aabb);c=new ia;c.copy(kc);X.push(c);for(c=0;c<W.length;c++){var N=
W[c];N._shaderDefs&=-193;N.mask=4;N.deleteParameter("texture_lightMap");N.deleteParameter("texture_dirLightMap");N.setParameter("texture_lightMap",N.material.lightMap?N.material.lightMap:d);N.setParameter("texture_dirLightMap",d)}for(f=0;f<k;f++){var T=n[f][I];var Y=new oa(e,T,{depth:!1});R[f].push(Y)}}for(d=0;d<q.length;d++)q[d].enabled=!1;z=[[],[],[]];A=!1;for(c=0;c<q.length;c++){q[c].enabled=!0;F=!1;q[c]._cacheShadowMap=!0;0!==q[c]._type&&(q[c]._node.getWorldTransform(),q[c].getBoundingSphere(sf),
rf.center=sf.center,rf.halfExtents.x=sf.radius,rf.halfExtents.y=sf.radius,rf.halfExtents.z=sf.radius);if(2===q[c]._type){I=q[c];var S=this.renderer.getShadowCamera(e,I);S._node.setPosition(I._node.getPosition());S._node.setRotation(I._node.getRotation());S._node.rotateLocal(-90,0,0);S.projection=0;S.nearClip=I.attenuationEnd/1E3;S.farClip=I.attenuationEnd;S.aspectRatio=1;S.fov=2*I._outerConeAngle;this.renderer.updateCameraFrustum(S)}0<h.length&&this.renderer.updateShaders(h[0]);for(I=0;I<a.length;I++){W=
h[I];kc=X[I];if(0===q[c]._type)Ra.copy(kc.center),Ra.y+=kc.halfExtents.y,Ga._node.setPosition(Ra),Ga._node.setEulerAngles(-90,0,0),d=Math.max(kc.halfExtents.x,kc.halfExtents.z),Ga.projection=1,Ga.nearClip=0,Ga.farClip=2*kc.halfExtents.y,Ga.aspectRatio=1,Ga.orthoHeight=d;else if(!rf.intersects(kc))continue;if(2===q[c]._type){f=!1;for(d=0;d<W.length;d++)if(this.renderer._isVisible(S,W[d])){f=!0;break}if(!f)continue}0===q[c]._type?(z[0][0]=q[c],z[1].length=0,z[2].length=0,!F&&q[c].castShadows&&(this.renderer.cullDirectionalShadowmap(q[c],
P,Ga,0),this.renderer.renderShadows(z[0],0),F=!0)):(z[0].length=0,1===q[c]._type?(z[1][0]=q[c],z[2].length=0,!F&&q[c].castShadows&&(this.renderer.cullLocalShadowmap(q[c],P),this.renderer.renderShadows(z[1]),F=!0)):(z[1].length=0,z[2][0]=q[c],!F&&q[c].castShadows&&(this.renderer.cullLocalShadowmap(q[c],P),this.renderer.renderShadows(z[2]),F=!0)));for(d=0;d<W.length;d++)U[d]=W[d].material;for(f=0;f<k;f++){T=n[f][I];Y=R[f][I];N=m[T.width];var aa=N.colorBuffer;0===f?A=g.updateShaders:A&&(g.updateShaders=
!0);for(d=0;d<W.length;d++)W[d].material=gj[f];1<k&&this.renderer.updateShaders(W);this.renderer.setCamera(Ga,N,!0);1===f&&E.setValue(q[c].bakeDir?1:0);this.renderer._forwardTime=0;this.renderer._shadowMapTime=0;this.renderer.renderForward(Ga,W,W.length,z,1);n[f][I]=aa;R[f][I]=N;m[T.width]=Y;for(d=0;d<W.length;d++)N=W[d],N.setParameter(wl[f],aa),N._shaderDefs|=64}V[I]++;for(d=0;d<W.length;d++)W[d].material=U[d]}q[c].enabled=!1;q[c]._cacheShadowMap=!1;q[c]._isCachedShadowMap&&q[c]._destroyShadowMap()}for(I=
0;I<a.length;I++){W=h[I];S=[];for(f=0;f<k;f++){T=n[f][I];Y=R[f][I];N=m[T.width];aa=N.colorBuffer;B[0]=1/T.width;B[1]=1/T.height;D.setValue(B);for(c=0;4>c;c++)Q.setValue(T),La(e,N,u),Q.setValue(aa),La(e,Y,u);for(c=0;c<W.length;c++)N=W[c],N.mask=2,W[c].setParameter(wl[f],T),1===f&&(W[c]._shaderDefs|=128);S[f]=T;f===k-1&&Y.destroy()}$b.push(S);Ac.push(a[I])}for(var ba in m)m.hasOwnProperty(ba)&&(m[ba].colorBuffer.destroy(),m[ba].destroy());for(c=0;c<$b.length;c++)for(d=0;d<$b[c].length;d++)u=$b[c][d],
u.minFilter=1,u.magFilter=1;for(I=0;I<b.length;I++)b[I].model.castShadows=M[I];for(c=0;c<O.length;c++)if(O[c])for(W=Ac[c].model.model.meshInstances,d=0;d<W.length;d++)W[d]._shaderDefs|=O[c][d]&192;for(c=0;c<q.length;c++)q[c].mask=t[c],q[c].shadowUpdateMode=w[c];for(c=0;c<x.length;c++)x[c].enabled=v[c];g.fog=r;g.ambientLight.set(C,G,H);p&&(g._needsStaticPrepare=!0)}}});var Bc,xl=1,hj=new C,ij=new C,lc=new r,wa=new r,ac=new r,ze=new r,db=new r,ta=new r,Ae=new r,Be=new r,tf=new r,yl=new r,eb=new r,Ng=
new r,Id=new r;yh.prototype.calcSpawnPosition=function(a,b,c,d,e){var g=this._emitter,k=Math.random(),f=Math.random(),h=Math.random(),p=Math.random();g.useCpu&&(a[4*e+8*g.numParticlesPot]=k,a[4*e+1+8*g.numParticlesPot]=f,a[4*e+2+8*g.numParticlesPot]=h);wa.x=k-.5;wa.y=f-.5;wa.z=h-.5;0===g.emitterShape?(p=Math.max(Math.abs(wa.x),Math.max(Math.abs(wa.y),Math.abs(wa.z))),f=p+(.5-p)*c[1],h=p+(.5-p)*c[2],wa.x=(p+(.5-p)*c[0])*(p==Math.abs(wa.x)?Math.sign(wa.x):2*wa.x),wa.y=f*(p==Math.abs(wa.y)?Math.sign(wa.y):
2*wa.y),wa.z=h*(p==Math.abs(wa.z)?Math.sign(wa.z):2*wa.z),g.localSpace?lc.copy(b.transformPoint(wa)):lc.copy(d).add(b.transformPoint(wa))):(wa.normalize(),b=0===g.emitterRadius?0:g.emitterRadiusInner/g.emitterRadius,b=p*(1-b)+b,g.localSpace?lc.copy(wa.scale(b*g.emitterRadius)):lc.copy(d).add(wa.scale(b*g.emitterRadius)));d=-O.lerp(g.rate,g.rate2,k)*e;g.pack8?(p=(lc.x-g.worldBounds.center.x)/g.worldBoundsSize.x+.5,c=(lc.y-g.worldBounds.center.y)/g.worldBoundsSize.y+.5,b=(lc.z-g.worldBounds.center.z)/
g.worldBoundsSize.z+.5,k=O.lerp(g.startAngle*O.DEG_TO_RAD,g.startAngle2*O.DEG_TO_RAD,k),k=k%(2*Math.PI)/(2*Math.PI),p=Uf(p),a[4*e]=p[0],a[4*e+1]=p[1],c=Uf(c),a[4*e+2]=c[0],a[4*e+3]=c[1],b=Uf(b),a[4*e+4*g.numParticlesPot]=b[0],a[4*e+1+4*g.numParticlesPot]=b[1],k=Uf(k),a[4*e+2+4*g.numParticlesPot]=k[0],a[4*e+3+4*g.numParticlesPot]=k[1],a[4*e+3+8*g.numParticlesPot]=1,k=Math.max(g.lifetime,(g.numParticles-1)*Math.max(g.rate,g.rate2)),c=(d+k)/(k+(g.lifetime+1)),k=Sd(c),d=Sd(255*c),b=Sd(65025*c),c=Sd(160581375*
c),k-=d/255,d-=b/255,k=[k,d,b-c/255,c-c/255],a[4*e+12*g.numParticlesPot]=k[0],a[4*e+1+12*g.numParticlesPot]=k[1],a[4*e+2+12*g.numParticlesPot]=k[2],a[4*e+3+12*g.numParticlesPot]=k[3]):(a[4*e]=lc.x,a[4*e+1]=lc.y,a[4*e+2]=lc.z,a[4*e+3]=O.lerp(g.startAngle*O.DEG_TO_RAD,g.startAngle2*O.DEG_TO_RAD,k),a[4*e+3+4*g.numParticlesPot]=d)};yh.prototype.update=function(a,b,c,d,e,g,k,f){var h=this._emitter;if(h.meshInstance.node){var l=h.meshInstance.node.worldTransform;for(g=0;12>g;g++)hj.data[g]=l.data[g];ij.copy(hj);
ij.invert();Bc=h.meshInstance.node.localScale;xl=Math.max(Math.max(Bc.x,Bc.y),Bc.z)}g=null===h.meshInstance.node||h.localSpace?r.ZERO:h.meshInstance.node.getPosition();var n=h.camera?h.camera._node.getPosition():r.ZERO,m=h.useMesh?17:15,q=h.precision-1;for(l=0;l<h.numParticles;l++){var u=Math.floor(h.vbCPU[l*h.numParticleVerts*(h.useMesh?6:4)+3]),t=c[4*u+8*h.numParticlesPot];ac.x=t;ac.y=c[4*u+1+8*h.numParticlesPot];ac.z=c[4*u+2+8*h.numParticlesPot];var y=h.rate+(h.rate2-h.rate)*t,w=h.lifetime,v=c[4*
u+3+4*h.numParticlesPot]+k,x=Math.max(Math.min(v/w,1),0),z=0;var A=0;(0>=v-k||v>=w)&&this.calcSpawnPosition(c,d,e,g,u);var F=0<v&&v<w;if(F){A=x*q;var B=Math.floor(A);var D=Math.ceil(A);A%=1;var E=h.qRotSpeed[B];var C=h.qRotSpeed[D];var G=E+(C-E)*A;E=h.qRotSpeed2[B];C=h.qRotSpeed2[D];var H=E+(C-E)*A;E=h.qScale[B];C=h.qScale[D];z=E+(C-E)*A;E=h.qScale2[B];C=h.qScale2[D];var O=E+(C-E)*A;E=h.qAlpha[B];C=h.qAlpha[D];var I=E+(C-E)*A;E=h.qAlpha2[B];C=h.qAlpha2[D];var J=E+(C-E)*A;E=h.qRadialSpeed[B];C=h.qRadialSpeed[D];
var M=E+(C-E)*A;E=h.qRadialSpeed2[B];C=h.qRadialSpeed2[D];E+=(C-E)*A;M+=100*t%1*(E-M);ze.x=c[4*u];ze.y=c[4*u+1];ze.z=c[4*u+2];h.localSpace?tf.copy(ze):tf.copy(ze).sub(g);tf.normalize().scale(M);B*=3;D*=3;E=h.qLocalVelocity[B];C=h.qLocalVelocity[D];ta.x=E+(C-E)*A;E=h.qLocalVelocity[B+1];C=h.qLocalVelocity[D+1];ta.y=E+(C-E)*A;E=h.qLocalVelocity[B+2];C=h.qLocalVelocity[D+2];ta.z=E+(C-E)*A;E=h.qLocalVelocity2[B];C=h.qLocalVelocity2[D];Be.x=E+(C-E)*A;E=h.qLocalVelocity2[B+1];C=h.qLocalVelocity2[D+1];Be.y=
E+(C-E)*A;E=h.qLocalVelocity2[B+2];C=h.qLocalVelocity2[D+2];Be.z=E+(C-E)*A;E=h.qVelocity[B];C=h.qVelocity[D];db.x=E+(C-E)*A;E=h.qVelocity[B+1];C=h.qVelocity[D+1];db.y=E+(C-E)*A;E=h.qVelocity[B+2];C=h.qVelocity[D+2];db.z=E+(C-E)*A;E=h.qVelocity2[B];C=h.qVelocity2[D];Ae.x=E+(C-E)*A;E=h.qVelocity2[B+1];C=h.qVelocity2[D+1];Ae.y=E+(C-E)*A;E=h.qVelocity2[B+2];C=h.qVelocity2[D+2];Ae.z=E+(C-E)*A;ta.x+=(Be.x-ta.x)*ac.x;ta.y+=(Be.y-ta.y)*ac.y;ta.z+=(Be.z-ta.z)*ac.z;0<h.initialVelocity&&(1===h.emitterShape?
(wa.copy(ac).scale(2).sub(r.ONE).normalize(),ta.add(wa.scale(h.initialVelocity))):ta.add(r.FORWARD.scale(h.initialVelocity)));db.x+=(Ae.x-db.x)*ac.x;db.y+=(Ae.y-db.y)*ac.y;db.z+=(Ae.z-db.z)*ac.z;G+=(H-G)*ac.y;z=(z+1E4*t%1*(O-z))*xl;A=1E3*t%1*(J-I);h.meshInstance.node&&(h.localSpace?(ta.x/=Bc.x,ta.y/=Bc.y,ta.z/=Bc.z):hj.transformPoint(ta,ta));h.localSpace?(ij.transformPoint(db,db),ta.add(db).add(tf)):(ta.add(db.mul(Bc)),ta.add(tf.mul(Bc)));Ng.copy(ta);yl.copy(ze).add(ta.scale(k));eb.copy(yl);c[4*u]=
eb.x;c[4*u+1]=eb.y;c[4*u+2]=eb.z;c[4*u+3]+=G*k;h.wrap&&h.wrapBounds&&(h.localSpace||eb.sub(g),eb.x=xh(eb.x,h.wrapBounds.x)-.5*h.wrapBounds.x,eb.y=xh(eb.y,h.wrapBounds.y)-.5*h.wrapBounds.y,eb.z=xh(eb.z,h.wrapBounds.z)-.5*h.wrapBounds.z,h.localSpace||eb.add(g));0<h.sort&&(1===h.sort?(Id.copy(eb).sub(n),h.particleDistance[u]=-(Id.x*Id.x+Id.y*Id.y+Id.z*Id.z)):2===h.sort?h.particleDistance[u]=v:3===h.sort&&(h.particleDistance[u]=-v))}f?0>v&&(c[4*u+3+8*h.numParticlesPot]=-1):(v>=w&&(v-=Math.max(w,(h.numParticles-
1)*y),c[4*u+3+8*h.numParticlesPot]=h.loop?1:-1),0>v&&h.loop&&(c[4*u+3+8*h.numParticlesPot]=1));0>c[4*u+3+8*h.numParticlesPot]&&(F=!1);c[4*u+3+4*h.numParticlesPot]=v;for(G=0;G<h.numParticleVerts;G++)t=(l*h.numParticleVerts+G)*(h.useMesh?6:4),y=h.vbCPU[t],w=h.vbCPU[t+1],v=h.vbCPU[t+2],F||(y=w=v=0),B=l*h.numParticleVerts*m+G*m,a[B]=eb.x,a[B+1]=eb.y,a[B+2]=eb.z,a[B+3]=x,a[B+4]=h.alignToMotion?0:c[4*u+3],a[B+5]=z,a[B+6]=A,a[B+7]=Ng.x,a[B+8]=y,a[B+9]=w,a[B+10]=v,a[B+11]=Ng.y,a[B+12]=u,a[B+13]=Ng.z,a[B+
14]=h.vbCPU[t+3],h.useMesh&&(a[B+15]=h.vbCPU[t+4],a[B+16]=h.vbCPU[t+5])}if(0<h.sort&&h.camera){a=h.useMesh?6:4;c=h.particleDistance;for(l=0;l<h.numParticles;l++)b[l][0]=l,b[l][1]=c[Math.floor(h.vbCPU[l*h.numParticleVerts*a+3])];h.vbOld.set(h.vbCPU);b.sort(function(a,b){return a[1]-b[1]});for(l=0;l<h.numParticles;l++)for(c=b[l][0]*h.numParticleVerts*a,d=l*h.numParticleVerts*a,g=0;g<h.numParticleVerts*a;g++)h.vbCPU[d+g]=h.vbOld[c+g]}};var zl=new Cb,Al=new Cb,Bl=new Cb;Vf.prototype._setInputBounds=function(){this.inBoundsSizeUniform[0]=
this._emitter.prevWorldBoundsSize.x;this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y;this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z;this.constantInBoundsSize.setValue(this.inBoundsSizeUniform);this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x;this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y;this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z;this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)};Vf.prototype.randomize=
function(){this.frameRandomUniform[0]=Math.random();this.frameRandomUniform[1]=Math.random();this.frameRandomUniform[2]=Math.random()};Vf.prototype.update=function(a,b,c,d,e){var g=this._emitter;a.setBlending(!1);a.setColorWrite(!0,!0,!0,!0);a.setCullMode(0);a.setDepthTest(!1);a.setDepthWrite(!1);this.randomize();this.constantGraphSampleSize.setValue(1/g.precision);this.constantGraphNumSamples.setValue(g.precision);this.constantNumParticles.setValue(g.numParticles);this.constantNumParticlesPot.setValue(g.numParticlesPot);
this.constantInternalTex0.setValue(g.internalTex0);this.constantInternalTex1.setValue(g.internalTex1);this.constantInternalTex2.setValue(g.internalTex2);this.constantInternalTex3.setValue(g.internalTex3);var k=g.meshInstance.node,f=null===k?r.ONE:k.localScale;if(g.pack8){this.worldBoundsMulUniform[0]=g.worldBoundsMul.x;this.worldBoundsMulUniform[1]=g.worldBoundsMul.y;this.worldBoundsMulUniform[2]=g.worldBoundsMul.z;this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform);this.worldBoundsAddUniform[0]=
g.worldBoundsAdd.x;this.worldBoundsAddUniform[1]=g.worldBoundsAdd.y;this.worldBoundsAddUniform[2]=g.worldBoundsAdd.z;this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform);this._setInputBounds();var h=g.maxVel*Math.max(Math.max(f.x,f.y),f.z);h=Math.max(h,1);this.constantMaxVel.setValue(h)}h=null===k||g.localSpace?r.ZERO:k.getPosition();k=null===k?C.IDENTITY:k.getWorldTransform();0===g.emitterShape?(Rj(b,zl),this.constantSpawnBounds.setValue(zl.data),this.constantSpawnPosInnerRatio.setValue(c)):
(this.constantSpawnBoundsSphere.setValue(g.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===g.emitterRadius?0:g.emitterRadiusInner/g.emitterRadius));this.constantInitialVelocity.setValue(g.initialVelocity);Rj(k,Al);k.invertTo3x3(Bl);this.emitterPosUniform[0]=h.x;this.emitterPosUniform[1]=h.y;this.emitterPosUniform[2]=h.z;this.constantEmitterPos.setValue(this.emitterPosUniform);this.constantFrameRandom.setValue(this.frameRandomUniform);this.constantDelta.setValue(d);this.constantRate.setValue(g.rate);
this.constantRateDiv.setValue(g.rate2-g.rate);this.constantStartAngle.setValue(g.startAngle*O.DEG_TO_RAD);this.constantStartAngle2.setValue(g.startAngle2*O.DEG_TO_RAD);this.constantSeed.setValue(g.seed);this.constantLifetime.setValue(g.lifetime);this.emitterScaleUniform[0]=f.x;this.emitterScaleUniform[1]=f.y;this.emitterScaleUniform[2]=f.z;this.constantEmitterScale.setValue(this.emitterScaleUniform);this.constantEmitterMatrix.setValue(Al.data);this.constantEmitterMatrixInv.setValue(Bl.data);this.constantLocalVelocityDivMult.setValue(g.localVelocityUMax);
this.constantVelocityDivMult.setValue(g.velocityUMax);this.constantRotSpeedDivMult.setValue(g.rotSpeedUMax[0]);b=g.swapTex?g.particleTexOUT:g.particleTexIN;b=g.beenReset?g.particleTexStart:b;c=g.swapTex?g.particleTexIN:g.particleTexOUT;this.constantParticleTexIN.setValue(b);La(a,g.swapTex?g.rtParticleTexIN:g.rtParticleTexOUT,e?g.shaderParticleUpdateOnStop:g.loop?g.shaderParticleUpdateRespawn:g.shaderParticleUpdateNoRespawn);g.material.setParameter("particleTexOUT",b);g.material.setParameter("particleTexIN",
c);g.beenReset=!1;g.swapTex=!g.swapTex;a.setDepthTest(!0);a.setDepthWrite(!0);g.prevWorldBoundsSize.copy(g.worldBoundsSize);g.prevWorldBoundsCenter.copy(g.worldBounds.center);g.pack8&&this._setInputBounds()};var Cl=[[-1,-1],[1,-1],[1,1],[-1,1]],Lb=function(a,b,c,d,e,g,k){e||(e=14);var f=0;k&&7===e&&(f=1);a=new L(a,{width:b,height:c,format:e,cubemap:!1,mipmaps:!1,minFilter:f,magFilter:f,addressU:1,addressV:1});a.name="PSTexture";b=a.lock();if(7===e){e=new Uint8Array(d.length);for(c=0;c<d.length;c++)e[c]=
d[c]*g*255;d=e}b.set(d);a.unlock();return a},Dl=new Ya([0,0,1,0]),El=new Ya([0,1,1,1]),Fl=new rb([0,0,1,0],[0,0,1,0],[0,0,1,0]),jo=new rb([0,1,1,1],[0,1,1,1],[0,1,1,1]),Cc=2,Dc=new Float32Array(3),Jd=new C,Gl=new r,Og=new r,Pg=new r,Sj,Wf,Mb=function(a,b){this.graphicsDevice=a;this.precision=32;this._addTimeTime=0;if(!Mb.DEFAULT_PARAM_TEXTURE){var c=new Float32Array(1024),d,e;for(e=0;16>e;e++)for(d=0;16>d;d++){var g=d+1-8.5;var k=e+1-8.5;k=Math.max(Math.min(1-Math.max(Math.min(Math.sqrt(g*g+k*k)/
16,1),0)-.5,1),0);g=16*e+d;c[4*g]=1;c[4*g+1]=1;c[4*g+2]=1;c[4*g+3]=k}Mb.DEFAULT_PARAM_TEXTURE=Lb(a,16,16,c,7,1,!0);Mb.DEFAULT_PARAM_TEXTURE.minFilter=1;Mb.DEFAULT_PARAM_TEXTURE.magFilter=1}Sj=this;Wf=b;P("numParticles",1);this.numParticles>a.maxTextureSize&&(console.warn("WARNING: can't create more than "+a.maxTextureSize+" particles on this device."),this.numParticles=a.maxTextureSize);P("rate",1);P("rate2",this.rate);P("lifetime",50);P("emitterExtents",new r(0,0,0));P("emitterExtentsInner",new r(0,
0,0));P("emitterRadius",0);P("emitterRadiusInner",0);P("emitterShape",0);P("initialVelocity",1);P("wrap",!1);P("localSpace",!1);P("wrapBounds",null);P("colorMap",Mb.DEFAULT_PARAM_TEXTURE);P("normalMap",null);P("loop",!0);P("preWarm",!1);P("sort",0);P("mode",0);P("scene",null);P("lighting",!1);P("halfLambert",!1);P("intensity",1);P("stretch",0);P("alignToMotion",!1);P("depthSoftening",0);P("mesh",null);P("particleNormal",new r(0,1,0));P("orientation",0);P("depthWrite",!1);P("noFog",!1);P("blendType",
2);P("node",null);P("startAngle",0);P("startAngle2",this.startAngle);P("animTilesX",1);P("animTilesY",1);P("animStartFrame",0);P("animNumFrames",1);P("animNumAnimations",1);P("animIndex",0);P("randomizeAnimIndex",!1);P("animSpeed",1);P("animLoop",!0);this._gpuUpdater=new Vf(this,a);this._cpuUpdater=new yh(this);this.constantLightCube=a.scope.resolve("lightCube[0]");this.emitterPosUniform=new Float32Array(3);this.wrapBoundsUniform=new Float32Array(3);this.emitterScaleUniform=new Float32Array([1,1,
1]);P("colorGraph",jo);P("colorGraph2",this.colorGraph);P("scaleGraph",El);P("scaleGraph2",this.scaleGraph);P("alphaGraph",El);P("alphaGraph2",this.alphaGraph);P("localVelocityGraph",Fl);P("localVelocityGraph2",this.localVelocityGraph);P("velocityGraph",Fl);P("velocityGraph2",this.velocityGraph);P("rotationSpeedGraph",Dl);P("rotationSpeedGraph2",this.rotationSpeedGraph);P("radialSpeedGraph",Dl);P("radialSpeedGraph2",this.radialSpeedGraph);this.lightCube=new Float32Array(18);this.lightCubeDir=Array(6);
this.lightCubeDir[0]=new r(-1,0,0);this.lightCubeDir[1]=new r(1,0,0);this.lightCubeDir[2]=new r(0,-1,0);this.lightCubeDir[3]=new r(0,1,0);this.lightCubeDir[4]=new r(0,0,-1);this.lightCubeDir[5]=new r(0,0,1);this.animTilesParams=new Float32Array(2);this.animParams=new Float32Array(4);this.animIndexParams=new Float32Array(2);this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.colorParam=this.internalTex2=this.internalTex1=this.internalTex0=null;this.swapTex=!1;this.useMesh=!0;this.useCpu=
!1;this.pack8=!0;this.localBounds=new ia;this.worldBoundsNoTrail=new ia;this.worldBoundsTrail=[new ia,new ia];this.worldBounds=new ia;this.worldBoundsSize=new r;this.prevWorldBoundsSize=new r;this.prevWorldBoundsCenter=new r;this.prevEmitterExtents=this.emitterExtents;this.prevEmitterRadius=this.emitterRadius;this.worldBoundsMul=new r;this.worldBoundsAdd=new r;this.timeToSwitchBounds=0;this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null;this.numParticleIndices=
this.numParticleVerts=0;this.meshInstance=this.material=null;this.seed=Math.random();this.fixedTimeStep=1/60;this.maxSubSteps=10;this.simTimeTotal=this.simTime=0;this.beenReset=!1;this._layer=null;this.rebuild()};Object.assign(Mb.prototype,{onChangeCamera:function(){this.regenShader();this.resetMaterial()},calculateBoundsMad:function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x;this.worldBoundsMul.y=1/this.worldBoundsSize.y;this.worldBoundsMul.z=1/this.worldBoundsSize.z;this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).scale(-1);
this.worldBoundsAdd.x+=.5;this.worldBoundsAdd.y+=.5;this.worldBoundsAdd.z+=.5},calculateWorldBounds:function(){if(this.node){this.prevWorldBoundsSize.copy(this.worldBoundsSize);this.prevWorldBoundsCenter.copy(this.worldBounds.center);this.useCpu||(0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius!==this.prevEmitterRadius)&&this.calculateLocalBounds();var a=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,
a);this.worldBoundsTrail[0].add(this.worldBoundsNoTrail);this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var b=this.simTimeTotal;b>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=b+this.lifetime);this.worldBounds.copy(this.worldBoundsTrail[0]);this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2);this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,
a),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,a)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds));this.meshInstance._aabbVer=1-this.meshInstance._aabbVer;this.pack8&&this.calculateBoundsMad()}},resetWorldBounds:function(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?C.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),
this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.timeToSwitchBounds=this.simTimeTotal=0)},calculateLocalBounds:function(){var a=Number.MAX_VALUE,b=Number.MAX_VALUE,c=Number.MAX_VALUE,d=-Number.MAX_VALUE,e=-Number.MAX_VALUE,g=-Number.MAX_VALUE,k=0,f=0,h=this.lifetime/this.precision,p=[this.qVelocity,this.qVelocity2],n=[this.qLocalVelocity,
this.qLocalVelocity2],m=[0,0],q=[0,0],u=[0,0],t=[0,0],r=[0,0],w,v;for(w=0;w<this.precision+1;w++){var x=Math.min(w,this.precision-1);for(v=0;2>v;v++){var z=n[v][3*x]*h+m[v];var A=n[v][3*x+1]*h+q[v];var B=n[v][3*x+2]*h+u[v];a=Math.min(z,a);b=Math.min(A,b);c=Math.min(B,c);d=Math.max(z,d);e=Math.max(A,e);g=Math.max(B,g);m[v]=z;q[v]=A;u[v]=B}for(v=0;2>v;v++)r[v]+=h*Math.sqrt(p[v][3*x]*p[v][3*x]+p[v][3*x+1]*p[v][3*x+1]+p[v][3*x+2]*p[v][3*x+2]);t[0]+=this.qRadialSpeed[x]*h;t[1]+=this.qRadialSpeed2[x]*h;
k=Math.max(k,Math.max(Math.abs(t[0]),Math.abs(t[1])));f=Math.max(f,this.qScale[x])}0===this.emitterShape?(z=.5*this.emitterExtents.x,A=.5*this.emitterExtents.y,B=.5*this.emitterExtents.z):B=A=z=this.emitterRadius;h=Math.max(r[0],r[1]);Og.x=a-f-z-k-h;Og.y=b-f-A-k-h;Og.z=c-f-B-k-h;Pg.x=d+f+z+k+h;Pg.y=e+f+A+k+h;Pg.z=g+f+B+k+h;this.localBounds.setMinMax(Og,Pg)},rebuild:function(){var a,b=this.graphicsDevice;null===this.colorMap&&(this.colorMap=Mb.DEFAULT_PARAM_TEXTURE);this.spawnBounds=0===this.emitterShape?
this.emitterExtents:this.emitterRadius;this.useCpu=this.useCpu||0<this.sort||1>=b.maxVertexTextures||64>b.fragmentUniformsCount||b.forceCpuParticles||!b.extTextureFloat;this._destroyResources();this.pack8=(this.pack8||!b.textureFloatRenderable)&&!this.useCpu;Cc=this.useCpu||this.pack8?4:2;this.useMesh=!1;this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):
this.useMesh=!0);this.numParticlesPot=O.nextPowerOfTwo(this.numParticles);this.rebuildGraphs();this.calculateLocalBounds();this.resetWorldBounds();this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?C.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),
this.pack8&&this.calculateBoundsMad());this.vbToSort=Array(this.numParticles);for(a=0;a<this.numParticles;a++)this.vbToSort[a]=[0,0];this.particleDistance=new Float32Array(this.numParticles);this._gpuUpdater.randomize();this.particleTex=new Float32Array(this.numParticlesPot*Cc*4);var c=null===this.node||this.localSpace?r.ZERO:this.node.getPosition();0===this.emitterShape&&(null===this.node||this.localSpace?Jd.setTRS(r.ZERO,T.IDENTITY,this.spawnBounds):Jd.setTRS(r.ZERO,this.node.getRotation(),Gl.copy(this.spawnBounds).mul(this.node.localScale)),
Dc[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Dc[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Dc[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(a=0;a<this.numParticles;a++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Jd,Dc,c,a),this.useCpu&&(this.particleTex[4*a+3+8*this.numParticlesPot]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*Cc*4);for(a=0;a<this.particleTexStart.length;a++)this.particleTexStart[a]=
this.particleTex[a];this.useCpu||(this.pack8?(this.particleTexIN=Lb(b,this.numParticlesPot,Cc,this.particleTex,7,1,!1),this.particleTexOUT=Lb(b,this.numParticlesPot,Cc,this.particleTex,7,1,!1),this.particleTexStart=Lb(b,this.numParticlesPot,Cc,this.particleTexStart,7,1,!1)):(this.particleTexIN=Lb(b,this.numParticlesPot,Cc,this.particleTex),this.particleTexOUT=Lb(b,this.numParticlesPot,Cc,this.particleTex),this.particleTexStart=Lb(b,this.numParticlesPot,Cc,this.particleTexStart)),this.rtParticleTexIN=
new oa(b,this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=new oa(b,this.particleTexOUT,{depth:!1}),this.swapTex=!1);a=K;c=(this.localSpace?"#define LOCAL_SPACE\n":"")+a.particleUpdaterInitPS+(this.pack8?a.particleInputRgba8PS+a.particleOutputRgba8PS:a.particleInputFloatPS+a.particleOutputFloatPS)+(0===this.emitterShape?a.particleUpdaterAABBPS:a.particleUpdaterSpherePS)+a.particleUpdaterStartPS;var d=c+a.particleUpdaterNoRespawnPS+a.particleUpdaterEndPS,e=c+a.particleUpdaterOnStopPS+a.particleUpdaterEndPS,
g=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,c+a.particleUpdaterRespawnPS+a.particleUpdaterEndPS,"fsQuad0"+g);this.shaderParticleUpdateNoRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,d,"fsQuad1"+g);this.shaderParticleUpdateOnStop=a.createShaderFromCode(b,a.fullscreenQuadVS,e,"fsQuad2"+g);this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4;this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:
6;this._allocate(this.numParticles);b=new fb(b);b.vertexBuffer=this.vertexBuffer;b.indexBuffer[0]=this.indexBuffer;b.primitive[0].type=4;b.primitive[0].base=0;b.primitive[0].count=this.numParticles*this.numParticleIndices;b.primitive[0].indexed=!0;this.material=new da;this.material.name=this.node.name;this.material.cull=0;this.material.alphaWrite=!1;this.material.blend=!0;this.material.blendType=this.blendType;this.material.depthWrite=this.depthWrite;this.material.emitter=this;this.regenShader();
this.resetMaterial();a=this.meshInstance?this.meshInstance.visible:!0;this.meshInstance=new ma(this.node,b,this.material);this.meshInstance.pick=!1;this.meshInstance.updateKey();this.meshInstance.cull=!0;this.meshInstance._noDepthDrawGl1=!0;this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds);this.meshInstance._updateAabb=!1;this.meshInstance.visible=a;this._initializeTextures();this.resetTime();
this.addTime(0,!1);this.preWarm&&this.prewarm(this.lifetime)},_isAnimated:function(){return 1<=this.animNumFrames&&(1<this.animTilesX||1<this.animTilesY)&&(this.colorMap&&this.colorMap!==Mb.DEFAULT_PARAM_TEXTURE||this.normalMap)},rebuildGraphs:function(){var a=this.precision,b=this.graphicsDevice,c;this.qLocalVelocity=this.localVelocityGraph.quantize(a);this.qVelocity=this.velocityGraph.quantize(a);this.qColor=this.colorGraph.quantizeClamped(a,0,1);this.qRotSpeed=this.rotationSpeedGraph.quantize(a);
this.qScale=this.scaleGraph.quantize(a);this.qAlpha=this.alphaGraph.quantize(a);this.qRadialSpeed=this.radialSpeedGraph.quantize(a);this.qLocalVelocity2=this.localVelocityGraph2.quantize(a);this.qVelocity2=this.velocityGraph2.quantize(a);this.qColor2=this.colorGraph2.quantizeClamped(a,0,1);this.qRotSpeed2=this.rotationSpeedGraph2.quantize(a);this.qScale2=this.scaleGraph2.quantize(a);this.qAlpha2=this.alphaGraph2.quantize(a);this.qRadialSpeed2=this.radialSpeedGraph2.quantize(a);for(c=0;c<a;c++)this.qRotSpeed[c]*=
O.DEG_TO_RAD,this.qRotSpeed2[c]*=O.DEG_TO_RAD;this.localVelocityUMax=new Float32Array(3);this.velocityUMax=new Float32Array(3);this.colorUMax=new Float32Array(3);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.radialSpeedUMax=[0];this.qLocalVelocityDiv=jd(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax);this.qVelocityDiv=jd(this.qVelocity,this.qVelocity2,this.velocityUMax);this.qColorDiv=jd(this.qColor,this.qColor2,this.colorUMax);this.qRotSpeedDiv=jd(this.qRotSpeed,
this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=jd(this.qScale,this.qScale2,this.scaleUMax);this.qAlphaDiv=jd(this.qAlpha,this.qAlpha2,this.alphaUMax);this.qRadialSpeedDiv=jd(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax);if(this.pack8){var d=[0,0,0];id(this.qVelocity,d);var e=[0,0,0];id(this.qVelocity2,e);c=[0,0,0];id(this.qLocalVelocity,c);var g=[0,0,0];id(this.qLocalVelocity2,g);var k=[0];id(this.qRadialSpeed,k);var f=[0];id(this.qRadialSpeed2,f);var h=Math.max(d[0],e[0]);h=Math.max(h,
d[1]);h=Math.max(h,e[1]);h=Math.max(h,d[2]);h=Math.max(h,e[2]);d=Math.max(c[0],g[0]);d=Math.max(d,c[1]);d=Math.max(d,g[1]);d=Math.max(d,c[2]);d=Math.max(d,g[2]);this.maxVel=h+d+Math.max(k[0],f[0])}if(!this.useCpu){this.internalTex0=Lb(b,a,1,Tj(this.qLocalVelocity,this.qLocalVelocityDiv));this.internalTex1=Lb(b,a,1,Tj(this.qVelocity,this.qVelocityDiv));c=this.qRotSpeed;g=this.qScale;k=this.qScaleDiv;f=this.qRotSpeedDiv;h=this.qAlphaDiv;d=Array(4*c.length);for(e=0;e<c.length;e++)d[4*e]=c[e],d[4*e+1]=
g[e],d[4*e+2]=0,d[4*e+3]=(255*k[e]<<16|255*f[e]<<8|255*h[e])/16777216;this.internalTex2=Lb(b,a,1,d);c=this.qRadialSpeed;g=this.qRadialSpeedDiv;k=Array(4*c.length);for(f=0;f<c.length;f++)k[4*f]=c[f],k[4*f+1]=g[f],k[4*f+2]=0,k[4*f+3]=0;this.internalTex3=Lb(b,a,1,k)}c=this.qColor;g=this.qAlpha;k=Array(4*g.length);for(f=0;f<g.length;f++)k[4*f]=c[3*f],k[4*f+1]=c[3*f+1],k[4*f+2]=c[3*f+2],k[4*f+3]=g[f];this.colorParam=Lb(b,a,1,k,7,1,!0)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter("colorMap",
this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))},regenShader:function(){var a=this.graphicsDevice.getProgramLibrary(),b=null!==this.normalMap;this.normalOption=0;this.lighting&&(this.normalOption=b?2:1);this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!=this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());this.shader=a.getProgram("particle",{useCpu:this.emitter.useCpu,
normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),
animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!=this.emitter.orientation})};this.material.updateShader()},resetMaterial:function(){var a=this.material;a.setParameter("stretch",this.stretch);this._isAnimated()&&(a.setParameter("animTexTilesParams",this.animTilesParams),a.setParameter("animTexParams",this.animParams),a.setParameter("animTexIndexParams",this.animIndexParams));a.setParameter("colorMult",this.intensity);this.useCpu||(a.setParameter("internalTex0",this.internalTex0),
a.setParameter("internalTex1",this.internalTex1),a.setParameter("internalTex2",this.internalTex2),a.setParameter("internalTex3",this.internalTex3));a.setParameter("colorParam",this.colorParam);a.setParameter("numParticles",this.numParticles);a.setParameter("numParticlesPot",this.numParticlesPot);a.setParameter("lifetime",this.lifetime);a.setParameter("rate",this.rate);a.setParameter("rateDiv",this.rate2-this.rate);a.setParameter("seed",this.seed);a.setParameter("scaleDivMult",this.scaleUMax[0]);a.setParameter("alphaDivMult",
this.alphaUMax[0]);a.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]);a.setParameter("graphNumSamples",this.precision);a.setParameter("graphSampleSize",1/this.precision);a.setParameter("emitterScale",new Float32Array([1,1,1]));this.pack8&&(this._gpuUpdater._setInputBounds(),a.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),a.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),a.setParameter("maxVel",this.maxVel));this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=
this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,a.setParameter("wrapBounds",this.wrapBoundsUniform));this.colorMap&&a.setParameter("colorMap",this.colorMap);this.lighting&&this.normalMap&&a.setParameter("normalMap",this.normalMap);0<this.depthSoftening&&a.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100));0<this.stretch&&(a.cull=0);this._compParticleFaceParams()},_compParticleFaceParams:function(){if(0==this.orientation){var a=
new Float32Array([1,0,0]);var b=new Float32Array([0,0,1])}else{a=1==this.orientation?this.particleNormal.normalize():(null===this.node?C.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();var c=new r(1,0,0);1==Math.abs(c.dot(a))&&c.set(0,0,1);b=(new r).cross(a,c).normalize();c.cross(b,a).normalize();a=new Float32Array([c.x,c.y,c.z]);b=new Float32Array([b.x,b.y,b.z])}this.material.setParameter("faceTangent",a);this.material.setParameter("faceBinorm",b)},_allocate:function(a){var b=
a*this.numParticleVerts,c=a*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==b){if(this.useCpu)var d=[{semantic:"ATTR0",components:4,type:6},{semantic:"ATTR1",components:4,type:6},{semantic:"ATTR2",components:4,type:6},{semantic:"ATTR3",components:1,type:6},{semantic:"ATTR4",components:this.useMesh?4:2,type:6}];else d=[{semantic:"ATTR0",components:4,type:6}],this.useMesh&&d.push({semantic:"ATTR1",components:2,type:6});d=new Ka(this.graphicsDevice,d);this.vertexBuffer=
new Za(this.graphicsDevice,d,b,1);this.indexBuffer=new Rb(this.graphicsDevice,1,c);d=new Float32Array(this.vertexBuffer.lock());if(this.useMesh){var e=new Float32Array(this.mesh.vertexBuffer.lock());var g=e.length/this.mesh.vertexBuffer.numVertices;for(c=0;c<this.mesh.vertexBuffer.format.elements.length;c++)if("TEXCOORD0"===this.mesh.vertexBuffer.format.elements[c].name){var k=this.mesh.vertexBuffer.format.elements[c].offset/4;break}}for(c=0;c<b;c++){var f=Math.floor(c/this.numParticleVerts);if(this.useMesh){var h=
c%this.numParticleVerts;d[6*c]=e[h*g];d[6*c+1]=e[h*g+1];d[6*c+2]=e[h*g+2];d[6*c+3]=f;d[6*c+4]=e[h*g+k+0];d[6*c+5]=e[h*g+k+1]}else h=c%4,d[4*c]=Cl[h][0],d[4*c+1]=Cl[h][1],d[4*c+2]=0,d[4*c+3]=f}this.useCpu&&(this.vbCPU=new Float32Array(d),this.vbOld=new Float32Array(this.vbCPU.length));this.vertexBuffer.unlock();this.useMesh&&this.mesh.vertexBuffer.unlock();b=0;g=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(e=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(c=0;c<a;c++)if(this.useMesh)for(k=
0;k<this.numParticleIndices;k++)g[c*this.numParticleIndices+k]=e[k]+c*this.numParticleVerts;else k=4*c,g[b++]=k,g[b++]=k+1,g[b++]=k+2,g[b++]=k,g[b++]=k+2,g[b++]=k+3;this.indexBuffer.unlock();this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){this.beenReset=!0;this.seed=Math.random();this.material.setParameter("seed",this.seed);if(this.useCpu)for(var a=0;a<this.particleTexStart.length;a++)this.particleTex[a]=this.particleTexStart[a];else this._initializeTextures();this.resetWorldBounds();
this.resetTime();a=this.loop;this.loop=!0;this.addTime(0,!1);this.loop=a;this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(a){var b=Math.min(Math.floor(a/this.lifetime*this.precision),this.precision);a/=b;for(var c=0;c<b;c++)this.addTime(a,!1)},resetTime:function(){var a=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+1E3*a},finishFrame:function(){this.useCpu&&this.vertexBuffer.unlock()},addTime:function(a,b){var c=this.graphicsDevice;this.simTimeTotal+=
a;this.calculateWorldBounds();if(this._isAnimated()){var d=this.animTilesParams;d[0]=1/this.animTilesX;d[1]=1/this.animTilesY;d=this.animParams;d[0]=this.animStartFrame;d[1]=this.animNumFrames*this.animSpeed;d[2]=this.animNumFrames-1;d[3]=this.animNumAnimations-1;d=this.animIndexParams;d[0]=this.animIndex;d[1]=this.randomizeAnimIndex}this.scene&&this.camera!=this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera());0===this.emitterShape&&(Dc[0]=0!=this.emitterExtents.x?
this.emitterExtentsInner.x/this.emitterExtents.x:0,Dc[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Dc[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?Jd.setTRS(r.ZERO,T.IDENTITY,this.emitterExtents):Jd.setTRS(r.ZERO,this.meshInstance.node.getRotation(),Gl.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));d=null===this.meshInstance.node?r.ONE:this.meshInstance.node.localScale;this.emitterScaleUniform[0]=
d.x;this.emitterScaleUniform[1]=d.y;this.emitterScaleUniform[2]=d.z;this.material.setParameter("emitterScale",this.emitterScaleUniform);if(this.localSpace&&this.meshInstance.node){var e=this.meshInstance.node.getPosition();this.emitterPosUniform[0]=e.x;this.emitterPosUniform[1]=e.y;this.emitterPosUniform[2]=e.z;this.material.setParameter("emitterPos",this.emitterPosUniform)}this._compParticleFaceParams();this.useCpu?(c=new Float32Array(this.vertexBuffer.lock()),this._cpuUpdater.update(c,this.vbToSort,
this.particleTex,Jd,Dc,e,a,b)):this._gpuUpdater.update(c,Jd,Dc,a,b);if(!this.loop&&Date.now()>this.endTime){if(this.onFinished)this.onFinished();this.meshInstance.visible=!1}},_destroyResources:function(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null);this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null);this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null);this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),
this.rtParticleTexIN=null);this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null);this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null);this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null);this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null);this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null);this.colorParam&&(this.colorParam.destroy(),this.colorParam=null);this.vertexBuffer&&(this.vertexBuffer.destroy(),
this.vertexBuffer=void 0);this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0);this.material&&(this.material.destroy(),this.material=null)},destroy:function(){this.camera=null;this._destroyResources()}});ka.prototype=Object.create(H.prototype);ka.prototype.constructor=ka;ka.prototype.destroy=function(){this.root=null;this.defaultMaterial.destroy();this.defaultMaterial=null;this.off()};Object.defineProperty(ka.prototype,"fog",{get:function(){return this._fog},set:function(a){a!==
this._fog&&(this._fog=a,this.updateShaders=!0)}});Object.defineProperty(ka.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},set:function(a){a!==this._gammaCorrection&&(this._gammaCorrection=a,this.updateShaders=!0)}});Object.defineProperty(ka.prototype,"toneMapping",{get:function(){return this._toneMapping},set:function(a){a!==this._toneMapping&&(this._toneMapping=a,this.updateShaders=!0)}});Object.defineProperty(ka.prototype,"skybox",{get:function(){return this._skyboxCubeMap},
set:function(a){this._skyboxCubeMap=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(ka.prototype,"skyboxIntensity",{get:function(){return this._skyboxIntensity},set:function(a){this._skyboxIntensity=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(ka.prototype,"skyboxMip",{get:function(){return this._skyboxMip},set:function(a){this._skyboxMip=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(ka.prototype,"skyboxPrefiltered128",
{get:function(){return this._skyboxPrefiltered[0]},set:function(a){this._skyboxPrefiltered[0]!==a&&(this._skyboxPrefiltered[0]=a,this.updateShaders=!0)}});Object.defineProperty(ka.prototype,"skyboxPrefiltered64",{get:function(){return this._skyboxPrefiltered[1]},set:function(a){this._skyboxPrefiltered[1]!==a&&(this._skyboxPrefiltered[1]=a,this.updateShaders=!0)}});Object.defineProperty(ka.prototype,"skyboxPrefiltered32",{get:function(){return this._skyboxPrefiltered[2]},set:function(a){this._skyboxPrefiltered[2]!==
a&&(this._skyboxPrefiltered[2]=a,this.updateShaders=!0)}});Object.defineProperty(ka.prototype,"skyboxPrefiltered16",{get:function(){return this._skyboxPrefiltered[3]},set:function(a){this._skyboxPrefiltered[3]!==a&&(this._skyboxPrefiltered[3]=a,this.updateShaders=!0)}});Object.defineProperty(ka.prototype,"skyboxPrefiltered8",{get:function(){return this._skyboxPrefiltered[4]},set:function(a){this._skyboxPrefiltered[4]!==a&&(this._skyboxPrefiltered[4]=a,this.updateShaders=!0)}});Object.defineProperty(ka.prototype,
"skyboxPrefiltered4",{get:function(){return this._skyboxPrefiltered[5]},set:function(a){this._skyboxPrefiltered[5]!==a&&(this._skyboxPrefiltered[5]=a,this.updateShaders=!0)}});Object.defineProperty(ka.prototype,"drawCalls",{get:function(){var a=this.layers._meshInstances;a.length||(this.layers._update(),a=this.layers._meshInstances);return a},set:function(a){}});Object.defineProperty(ka.prototype,"layers",{get:function(){return this._layers},set:function(a){var b=this._layers;this._layers=a;this.fire("set:layers",
b,a)}});ka.prototype.applySettings=function(a){this._gravity.set(a.physics.gravity[0],a.physics.gravity[1],a.physics.gravity[2]);this.ambientLight.set(a.render.global_ambient[0],a.render.global_ambient[1],a.render.global_ambient[2]);this._fog=a.render.fog;this.fogColor.set(a.render.fog_color[0],a.render.fog_color[1],a.render.fog_color[2]);this.fogStart=a.render.fog_start;this.fogEnd=a.render.fog_end;this.fogDensity=a.render.fog_density;this._gammaCorrection=a.render.gamma_correction;this._toneMapping=
a.render.tonemapping;this.lightmapSizeMultiplier=a.render.lightmapSizeMultiplier;this.lightmapMaxResolution=a.render.lightmapMaxResolution;this.lightmapMode=a.render.lightmapMode;this.exposure=a.render.exposure;this._skyboxIntensity=void 0===a.render.skyboxIntensity?1:a.render.skyboxIntensity;this._skyboxMip=void 0===a.render.skyboxMip?0:a.render.skyboxMip;this._resetSkyboxModel();this.updateShaders=!0};ka.prototype._updateSkybox=function(a){if(this._skyboxCubeMap&&!this.skyboxModel){var b=new da,
c=this;b.updateShader=function(b,d,e,g,k){this.shader=a.getProgramLibrary().getProgram("skybox",{rgbm:"rgbm"===c._skyboxCubeMap.type,hdr:"rgbm"===c._skyboxCubeMap.type||14===c._skyboxCubeMap.format,useIntensity:1!==c.skyboxIntensity,mip:c._skyboxCubeMap.fixCubemapSeams?c.skyboxMip:0,fixSeams:c._skyboxCubeMap.fixCubemapSeams,gamma:1===k?c.gammaCorrection?3:0:c.gammaCorrection,toneMapping:1===k?0:c.toneMapping})};b.updateShader();var d;if(this._skyboxCubeMap.fixCubemapSeams&&c._skyboxMip){var e=this["skyboxPrefiltered"+
[null,"64","16","8","4"][c._skyboxMip]];e&&(d=e)}else d=this._skyboxCubeMap;b.setParameter("texture_cubeMap",d);b.cull=2;b.depthWrite=!1;if(e=this.layers.getLayerById(2)){var g=new Z,k=Xf(a);b=new ma(g,k,b);b.cull=!1;b._noDepthDrawGl1=!0;k=new gb;k.graph=g;k.meshInstances=[b];this.skyboxModel=k;e.addMeshInstances(k.meshInstances);this.skyLayer=e;this._firstUpdateSkybox&&(e.enabled=!0,this._firstUpdateSkybox=!1);this.fire("set:skybox",d)}}};ka.prototype._resetSkyboxModel=function(){this.skyboxModel&&
(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyboxModel.destroy());this.skyboxModel=null;this.updateSkybox=!0};ka.prototype.setSkybox=function(a){var b;a||(a=[null,null,null,null,null,null,null]);var c=!1;this._skyboxCubeMap!==a[0]&&(c=!0);if(!c)for(b=0;6>b&&!c;b++)this._skyboxPrefiltered[b]!==a[b+1]&&(c=!0);if(c){for(b=0;6>b;b++)this._skyboxPrefiltered[b]=a[b+1];this.skybox=a[0]}};ka.prototype.destroy=function(){this.skybox=null};ka.prototype.addModel=function(a){if(!this.containsModel(a)){var b=
this.layers.getLayerById(0);b&&(b.addMeshInstances(a.meshInstances),this._models.push(a))}};ka.prototype.addShadowCaster=function(a){var b=this.layers.getLayerById(0);b&&b.addShadowCasters(a.meshInstances)};ka.prototype.removeModel=function(a){var b=this._models.indexOf(a);if(-1!==b){var c=this.layers.getLayerById(0);c&&(c.removeMeshInstances(a.meshInstances),this._models.splice(b,1))}};ka.prototype.removeShadowCasters=function(a){var b=this.layers.getLayerById(0);b&&b.removeShadowCasters(a.meshInstances)};
ka.prototype.containsModel=function(a){return 0<=this._models.indexOf(a)};ka.prototype.getModels=function(a){return this._models};if(Kc()){var Nb=function(a,b,c){c=c||{};this.volume=void 0===c.volume?1:c.volume;this.loop=void 0===c.loop?!1:c.loop;this.pitch=void 0===c.pitch?1:c.pitch;this.sound=b;this.suspended=this.paused=!1;this.startOffset=this.startTime=0;this.manager=a;this.source=null;this.gain=a.context.createGain()};Object.assign(Nb.prototype,{play:function(){if(this.source)throw Error("Call stop() before calling play()");
this._createSource();if(this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended))this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.startOffset+=
this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){this.source||!this.paused?console.warn("Call pause() before unpausing."):(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off("volumechange",
this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setVolume:function(a){this.volume=a=O.clamp(a,0,1);this.gain&&(this.gain.gain.value=a*this.manager.volume)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate.value=a)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?
this.source.buffer.duration:0},_createSource:function(){var a=this.manager.context;this.sound.buffer&&(this.source=a.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(a.destination),this.loop||(this.source.onended=this.pause.bind(this)))}})}else Td()?(Nb=function(a,b,c){this.volume=c.volume||1;this.loop=c.loop||!1;this.sound=b;this.pitch=void 0!==c.pitch?c.pitch:1;this.suspended=this.paused=!1;this.manager=a;b.audio&&(this.source=b.audio.cloneNode(!1),
this.source.pause())},Object.assign(Nb.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play());this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this);if(this.manager.suspended)this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&
(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause();this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(a){this.volume=a=O.clamp(a,0,1);this.source&&(this.source.volume=a*this.manager.volume)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate=
a)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}})):Nb=function(){};Object.assign(Nb.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&
(this.suspended=!1,this.unpause())}});var $e="inverse";if(Kc()){var Sa=function(a,b,c){Nb.call(this,a,b,c);this.position=new r;this.velocity=new r;this.panner=a.context.createPanner()};Sa.prototype=Object.create(Nb.prototype);Sa.prototype.constructor=Sa;Object.assign(Sa.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.panner.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);
this.panner.setVelocity(a.x,a.y,a.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(a){this.panner.maxDistance=a},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(a){this.panner.refDistance=a},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(a){this.panner.rolloffFactor=a},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(a){this.panner.distanceModel=a},
_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(a.destination);this.loop||(this.source.onended=this.pause.bind(this))}})}else if(Td()){var jj=new r;Sa=function(a,b){Nb.call(this,a,b);this.position=new r;this.velocity=new r;this.maxDistance=1E4;this.rollOffFactor=this.minDistance=1;this.distanceModel=$e};Sa.prototype=Object.create(Nb.prototype);
Sa.prototype.constructor=Sa;Object.assign(Sa.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);if(this.source){var b=this.manager.listener.getPosition();a=this.minDistance;var c=this.maxDistance,d=this.rollOffFactor,e=this.distanceModel;jj=jj.sub2(b,this.position);b=jj.length();if(b<a)a=1;else if(b>c)a=0;else{var g=0;"linear"===e?g=1-d*(b-a)/(c-a):e===$e?g=a/(a+d*(b-a)):"exponential"===e&&(g=Math.pow(b/a,-d));a=O.clamp(g,0,1)}c=this.getVolume();
this.source.volume=c*a}},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(a){this.maxDistance=a},getMinDistance:function(){return this.minDistance},setMinDistance:function(a){this.minDistance=a},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(a){this.rollOffFactor=a},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(a){this.distanceModel=
a}})}else Sa=function(){};Object.assign(Fh.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},setOrientation:function(a){this.orientation.copy(a);this.listener&&this.listener.setOrientation(-a.data[8],-a.data[9],-a.data[10],a.data[4],a.data[5],a.data[6])},
getOrientation:function(){return this.orientation}});Sb.prototype=Object.create(H.prototype);Sb.prototype.constructor=Sb;Object.assign(Sb.prototype,{suspend:function(){this.suspended=!0;this.fire("suspend")},resume:function(){this.suspended=!1;this.fire("resume")},destroy:function(){window.removeEventListener("mousedown",this.resumeContext);window.removeEventListener("touchend",this.resumeContext);this.fire("destroy");this.context&&this.context.close&&(this.context.close(),this.context=null)},playSound:function(a,
b){b=b||{};var c=null;Nb&&(c=new Nb(this,a,b),c.play());return c},playSound3d:function(a,b,c){c=c||{};var d=null;Sa&&(d=new Sa(this,a,c),d.setPosition(b),c.volume&&d.setVolume(c.volume),c.loop&&d.setLoop(c.loop),c.maxDistance&&d.setMaxDistance(c.maxDistance),c.minDistance&&d.setMinDistance(c.minDistance),c.rollOffFactor&&d.setRollOffFactor(c.rollOffFactor),c.distanceModel&&d.setDistanceModel(c.distanceModel),d.play());return d}});Object.defineProperty(Sb.prototype,"volume",{get:function(){return this._volume},
set:function(a){this._volume=a=O.clamp(a,0,1);this.fire("volumechange",a)}});Fb.prototype.getDuration=function(){return this.duration};Fb.prototype.getName=function(){return this.name};Fb.prototype.getNode=function(a){return this._nodeDict[a]};Object.defineProperty(Fb.prototype,"nodes",{get:function(){return this._nodes}});Fb.prototype.getNodes=function(){return this._nodes};Fb.prototype.setDuration=function(a){this.duration=a};Fb.prototype.setName=function(a){this.name=a};Fb.prototype.addNode=function(a){this._nodes.push(a);
this._nodeDict[a._name]=a};Object.defineProperties(Pe.prototype,{morphPositions:{get:function(){return this._morphPositions}},morphNormals:{get:function(){return this._morphNormals}},maxActiveTargets:{get:function(){return this._morphPositions&&this._morphNormals?4:8}}});Object.assign(Pe.prototype,{destroy:function(){for(var a=0;a<this._targets.length;a++)this._targets[a].destroy();this._targets.length=0},getTarget:function(a){return this._targets[a]},_updateMorphFlags:function(){this._morphNormals=
this._morphPositions=!1;for(var a,b=0;b<this._targets.length;b++)a=this._targets[b],a.morphPositions&&(this._morphPositions=!0),a.morphNormals&&(this._morphNormals=!0)},_calculateAabb:function(){this.aabb=new ia(new r(0,0,0),new r(0,0,0));for(var a,b=0;b<this._targets.length;b++)a=this._targets[b],this.aabb._expand(a.aabb.getMin(),a.aabb.getMax())}});Object.defineProperties(Qe.prototype,{morphPositions:{get:function(){return!!this._vertexBufferPositions}},morphNormals:{get:function(){return!!this._vertexBufferNormals}}});
Object.assign(Qe.prototype,{_createVertexBuffer:function(a,b,c){return b?new Za(a,new Ka(a,[{semantic:"ATTR0",components:3,type:c||6}]),b.length/3,0,b):null},destroy:function(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null);this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null)}});Object.assign($f.prototype,{encode:function(a){return Tb.joinPath([Tb.joinPath(a[0]),a[1],Tb.joinPath(a[2])],"/")},decode:function(a){a=
Tb.splitPath(a,"/");return[Tb.splitPath(a[0]),a[1],Tb.splitPath(a[2])]}});S.prototype=Object.create(Z.prototype);S.prototype.constructor=S;S.prototype.addComponent=function(a,b){var c=this._app.systems[a];return!c||this.c[a]?null:c.addComponent(this,b)};S.prototype.removeComponent=function(a){var b=this._app.systems[a];b&&this.c[a]&&b.removeComponent(this)};S.prototype.findComponent=function(a){var b=this.findOne(function(b){return b.c&&b.c[a]});return b&&b.c[a]};S.prototype.findComponents=function(a){return this.find(function(b){return b.c&&
b.c[a]}).map(function(b){return b.c[a]})};S.prototype.getGuid=function(){this._guid||this.setGuid(Yk.create());return this._guid};S.prototype.setGuid=function(a){var b=this._app._entityIndex;this._guid&&delete b[this._guid];this._guid=a;b[this._guid]=this};S.prototype._notifyHierarchyStateChanged=function(a,b){var c=!1;a===this&&0===this._app._enableList.length&&(c=!0);a._beingEnabled=!0;a._onHierarchyStateChanged(b);a._onHierarchyStatePostChanged&&this._app._enableList.push(a);var d,e=a._children;
var g=0;for(d=e.length;g<d;g++)e[g]._enabled&&this._notifyHierarchyStateChanged(e[g],b);a._beingEnabled=!1;if(c){for(g=0;g<this._app._enableList.length;g++)this._app._enableList[g]._onHierarchyStatePostChanged();this._app._enableList.length=0}};S.prototype._onHierarchyStateChanged=function(a){Z.prototype._onHierarchyStateChanged.call(this,a);var b=this.c,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c];if(d.enabled)if(a)d.onEnable();else d.onDisable()}};S.prototype._onHierarchyStatePostChanged=function(){var a=
this.c,b;for(b in a)if(a.hasOwnProperty(b))a[b].onPostStateChange()};S.prototype.findByGuid=function(a){return this._guid===a?this:(a=this._app._entityIndex[a])&&(a===this||a.isDescendantOf(this))?a:null};S.prototype.destroy=function(){this._destroying=!0;for(a in this.c)this.c[a].enabled=!1;for(a in this.c)this.c[a].system.removeComponent(this);this._parent&&this._parent.removeChild(this);var a=this._children;for(var b=a.shift();b;)b instanceof S&&b.destroy(),b._parent=null,b=a.shift();this.fire("destroy",
this);this.off();this._guid&&delete this._app._entityIndex[this._guid];this._destroying=!1};S.prototype.clone=function(){var a={},b=this._cloneRecursively(a);a[this.getGuid()]=b;Yj(this,this,b,a);return b};S.prototype._cloneRecursively=function(a){var b=new S(this._app);Z.prototype._cloneInternal.call(this,b);for(var c in this.c)this.c[c].system.cloneComponent(this,b);for(c=0;c<this._children.length;c++){var d=this._children[c];if(d instanceof S){var e=d._cloneRecursively(a);b.addChild(e);a[d.getGuid()]=
e}}return b};Object.defineProperties(Re.prototype,{components:{get:function(){return this._components}},data:{get:function(){return this._data}}});Object.assign(Zj.prototype,{update:function(a,b){if(a<this._left||a>=this._right){var c=b.length;c?a<b[0]?(this._left=-Infinity,this._right=b[0],this._p0=this._p1=this._recip=this._len=0):a>=b[c-1]?(this._left=b[c-1],this._right=Infinity,this._recip=this._len=0,this._p0=this._p1=c-1):(c=this._findKey(a,b),this._left=b[c],this._right=b[c+1],this._len=this._right-
this._left,b=1/this._len,this._recip=isFinite(b)?b:0,this._p0=c,this._p1=c+1):(this._left=-Infinity,this._right=Infinity,this._p0=this._p1=this._recip=this._len=0)}this._t=0===this._recip?0:(a-this._left)*this._recip;this._hermite.valid=!1},_findKey:function(a,b){for(var c=0;a>=b[c+1];)c++;return c},eval:function(a,b,c){var d=c._data;c=c._components;var e=this._p0*c,g;if(0===b)for(g=0;g<c;++g)a[g]=d[e+g];else{var k=this._t,f=this._p1*c;switch(b){case 1:for(g=0;g<c;++g)a[g]=O.lerp(d[e+g],d[f+g],k);
break;case 2:b=this._hermite;b.valid||(g=k*k,e=k+k,f=1-k,f*=f,b.valid=!0,b.p0=(1+e)*f,b.m0=k*f,b.p1=g*(3-e),b.m1=g*(k-1));k=(3*this._p0+1)*c;e=(3*this._p0+2)*c;f=(3*this._p1+1)*c;var h=3*this._p1*c;for(g=0;g<c;++g)a[g]=b.p0*d[k+g]+b.m0*d[e+g]*this._len+b.p1*d[f+g]+b.m1*d[h+g]*this._len}}}});Object.defineProperties(ag.prototype,{paths:{get:function(){return this._paths}},input:{get:function(){return this._input}},output:{get:function(){return this._output}},interpolation:{get:function(){return this._interpolation}}});
Object.defineProperties(Ud.prototype,{name:{get:function(){return this._name}},duration:{get:function(){return this._duration}},inputs:{get:function(){return this._inputs}},outputs:{get:function(){return this._outputs}},curves:{get:function(){return this._curves}}});Object.assign(Ud.prototype,{eval:function(a,b){b._time=a;var c=this._inputs,d=this._outputs,e=this._curves,g=b._cache;b=b._results;var k;for(k=0;k<c.length;++k)g[k].update(a,c[k]._data);for(k=0;k<e.length;++k)a=e[k],g[a._input].eval(b[k],
a._interpolation,d[a._output])}});Object.defineProperties(Se.prototype,{name:{get:function(){return this._name},set:function(a){this._name=a}},track:{get:function(){return this._track}},snapshot:{get:function(){return this._snapshot}},time:{get:function(){return this._time},set:function(a){this._time=a}},speed:{get:function(){return this._speed},set:function(a){this._speed=a}},loop:{get:function(){return this._loop},set:function(a){this._loop=a}},blendWeight:{get:function(){return this._blendWeight},
set:function(a){this._blendWeight=a}},blendOrder:{get:function(){return this._blendOrder},set:function(a){this._blendOrder=a}}});Object.assign(Se.prototype,{_update:function(a){if(this._playing){var b=this._time,c=this._track.duration,d=this._speed,e=this._loop;b+=d*a;0<=d?b>c&&(e?b=b%c||0:(b=this._track.duration,this.pause())):0>b&&(e?b=c+(b%c||0):(b=0,this.pause()));this._time=b}this._time!=this._snapshot._time&&this._track.eval(this._time,this._snapshot)},play:function(){this._playing=!0;this._time=
0},stop:function(){this._playing=!1;this._time=0},pause:function(){this._playing=!1},resume:function(){this._playing=!0},reset:function(){this._time=0}});Object.defineProperties(rc.prototype,{func:{get:function(){return this._func}},type:{get:function(){return this._type}},components:{get:function(){return this._components}}});Tb.joinPath=function(a,b){b=b||".";return a.map(function(a){return a.replace(/\\/g,"\\\\").replace(new RegExp("\\"+b,"g"),"\\"+b)}).join(b)};Tb.splitPath=function(a,b){b=b||
".";for(var c=[],d="",e=0;e<a.length;){var g=a[e++];"\\"===g&&e<a.length?(g=a[e++],d="\\"===g||g===b?d+g:d+("\\"+g)):g===b?(c.push(d),d=""):d+=g}0<d.length&&c.push(d);return c};Object.assign(Tb.prototype,{resolve:function(a){return null},unresolve:function(a){},update:function(a){}});Object.assign(Te.prototype,{resolve:function(a){var b=this.propertyLocator.decode(a);a=this.nodes[b[0][0]];if(!a)return null;b=this.handlers[b[2][0]];if(!b)return null;b=b(a.node);if(!b)return null;0===a.count&&this.activeNodes.push(a.node);
a.count++;return b},unresolve:function(a){a=this.propertyLocator.decode(a);if("graph"===a[1]){var b=this.nodes[a[0][0]];b.count--;if(0===b.count){a=this.activeNodes;b=a.indexOf(b.node);var c=a.length;b<c-1&&(a[b]=a[c-1]);a.pop()}}},update:function(a){a=this.activeNodes;for(var b=0;b<a.length;++b)a[b]._dirtifyLocal()},_getParts:function(a){a=Tb.splitPath(a);return 2===a.length&&this.nodes.hasOwnProperty(a[0])&&this.handlers.hasOwnProperty(a[1])?a:null}});Object.defineProperties(Ba.prototype,{clips:{get:function(){return this._clips}}});
Ba._dot=function(a,b){for(var c=a.length,d=0,e=0;e<c;++e)d+=a[e]*b[e];return d};Ba._normalize=function(a){var b=Ba._dot(a,a);if(0<b){b=1/Math.sqrt(b);for(var c=a.length,d=0;d<c;++d)a[d]*=b}};Ba._set=function(a,b,c){var d=a.length;if("quaternion"===c){var e=Ba._dot(b,b);0<e&&(e=1/Math.sqrt(e));for(c=0;c<d;++c)a[c]=b[c]*e}else for(c=0;c<d;++c)a[c]=b[c]};Ba._blendVec=function(a,b,c){for(var d=1-c,e=a.length,g=0;g<e;++g)a[g]=a[g]*d+b[g]*c};Ba._blendQuat=function(a,b,c){var d=a.length,e=1-c;0>Ba._dot(a,
b)&&(c=-c);for(var g=0;g<d;++g)a[g]=a[g]*e+b[g]*c;Ba._normalize(a)};Ba._blend=function(a,b,c,d){"quaternion"===d?Ba._blendQuat(a,b,c):Ba._blendVec(a,b,c)};Ba._stableSort=function(a,b){for(var c=a.length,d=0;d<c-1;++d)for(var e=d+1;e<c;++e)if(b(a[e],a[d])){var g=a[d];a[d]=a[e];a[e]=g}};Object.assign(Ba.prototype,{addClip:function(a){for(var b=this._targets,c=a.track.curves,d=a.snapshot,e=[],g=[],k=0;k<c.length;++k)for(var f=c[k].paths,h=0;h<f.length;++h){var p=f[h],n=b[p];if(!n){var m=this._binder.resolve(p);
if(m){n={target:m,value:[],curves:0,blendCounter:0};for(m=0;m<n.target.components;++m)n.value.push(0);b[p]=n}}n&&(n.curves++,e.push(d._results[k]),g.push(n))}this._clips.push(a);this._inputs.push(e);this._outputs.push(g)},removeClip:function(a){for(var b=this._targets,c=this._clips,d=c[a].track.curves,e=0;e<d.length;++e)for(var g=d[e].paths,k=0;k<g.length;++k){var f=g[k],h=b[f];h&&(h.curves--,0===h.curves&&(this._binder.unresolve(f),delete b[f]))}c.splice(a,1);this._inputs.splice(a,1);this._outputs.splice(a,
1)},removeClips:function(){for(;0<this._clips.length;)this.removeClip(0)},findClip:function(a){for(var b=this._clips,c=0;c<b.length;++c){var d=b[c];if(d.name===a)return d}return null},update:function(a){var b=this._clips,c=b.map(function(a,b){return b});Ba._stableSort(c,function(a,c){return b[a].blendOrder<b[c].blendOrder});var d;for(d=0;d<b.length;++d){var e=c[d];var g=b[e];var k=this._inputs[e];e=this._outputs[e];var f=g.blendWeight;0<f&&g._update(a);if(1<=f)for(g=0;g<k.length;++g){var h=k[g];var p=
e[g];var n=p.value;Ba._set(n,h,p.target.type);p.blendCounter++}else if(0<f)for(g=0;g<k.length;++g)h=k[g],p=e[g],n=p.value,0===p.blendCounter?Ba._set(n,h,p.target.type):Ba._blend(n,h,f,p.target.type),p.blendCounter++}c=this._targets;for(var m in c)c.hasOwnProperty(m)&&(d=c[m],d.target.func(d.value),d.blendCounter=0);this._binder.update(a)}});Gh.prototype._validate=function(a){if(!a.header)throw Error('pc.I18n#addData: Missing "header" field');if(!a.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');
if(1!==a.header.version)throw Error('pc.I18n#addData: Invalid "header.version" field');if(!a.data)throw Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(a.data))throw Error('pc.I18n#addData: "data" field must be an array');for(var b=0,c=a.data.length;b<c;b++){var d=a.data[b];if(!d.info)throw Error('pc.I18n#addData: missing "data['+b+'].info" field');if(!d.info.locale)throw Error('pc.I18n#addData: missing "data['+b+'].info.locale" field');if("string"!==typeof d.info.locale)throw Error('pc.I18n#addData: "data['+
b+'].info.locale" must be a string');if(!d.messages)throw Error('pc.I18n#addData: missing "data['+b+'].messages" field');}};Gh.prototype.parse=function(a){return a.data};var uf={},Zc=function(a,b){for(var c=0,d=a.length;c<d;c++)uf[a[c]]=b},$c=function(a){var b=a.indexOf("-");return-1!==b?a.substring(0,b):a},bg="en-US",Qg={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"};Zc("ja ko th vi zh id".split(" "),function(a){return 0});
Zc(["fa","hi"],function(a){return 0<=a&&1>=a?0:1});Zc(["fr","pt"],function(a){return 0<=a&&2>a?0:1});Zc(["da"],function(a){return 1===a||!Number.isInteger(a)&&0<=a&&1>=a?0:1});Zc("de en it el es tr fi sv nb no ur".split(" "),function(a){return 1===a?0:1});Zc(["ru","uk"],function(a){if(Number.isInteger(a)){var b=a%10;a%=100;if(1===b&&11!==a)return 0;if(2<=b&&4>=b&&(12>a||14<a))return 1;if(0===b||5<=b&&9>=b||11<=a&&14>=a)return 2}return 3});Zc(["pl"],function(a){if(Number.isInteger(a)){if(1===a)return 0;
var b=a%10;a%=100;if(2<=b&&4>=b&&(12>a||14<a))return 1;if(0<=b&&1>=b||5<=b&&9>=b||12<=a&&14>=a)return 2}return 3});Zc(["ar"],function(a){if(0===a)return 0;if(1===a)return 1;if(2===a)return 2;if(Number.isInteger(a)){a%=100;if(3<=a&&10>=a)return 3;if(11<=a&&99>=a)return 4}return 5});var kj=uf[$c(bg)];Ha.prototype=Object.create(H.prototype);Ha.prototype.constructor=Ha;Ha.findAvailableLocale=function(a,b){if(b[a])return a;var c=Qg[a];if(c&&b[c])return c;a=$c(a);c=Qg[a];return b[c]?c:b[a]?a:bg};Ha.prototype.getText=
function(a,b){var c=a;if(!b){b=this._locale;var d=this._lang}var e=this._translations[b];e||(d||(d=$c(b)),b=this._findFallbackLocale(b,d),e=this._translations[b]);e&&e.hasOwnProperty(a)&&(c=e[a],Array.isArray(c)&&(c=c[0]),null===c||void 0===c)&&(c=a);return c};Ha.prototype.getPluralText=function(a,b,c){var d=a;if(c){var e=$c(c);var g=uf[e]||kj}else c=this._locale,e=this._lang,g=this._pluralFn;var k=this._translations[c];k||(c=this._findFallbackLocale(c,e),e=$c(c),g=uf[e]||kj,k=this._translations[c]);
k&&k[a]&&g&&(b=g(b),d=k[a][b],null===d||void 0===d)&&(d=a);return d};Ha.prototype.addData=function(a){try{var b=this._parser.parse(a)}catch(k){console.error(k);return}a=0;for(var c=b.length;a<c;a++){var d=b[a],e=d.info.locale;d=d.messages;if(!this._translations[e]){this._translations[e]={};var g=$c(e);this._availableLangs[g]||(this._availableLangs[g]=e)}Object.assign(this._translations[e],d);this.fire("data:add",e,d)}};Ha.prototype.removeData=function(a){var b;try{var c=this._parser.parse(a)}catch(h){console.error(h);
return}a=0;for(var d=c.length;a<d;a++){var e=c[a],g=e.info.locale,k=this._translations[g];if(k){e=e.messages;for(b in e)delete k[b];var f=!1;for(b in k){f=!0;break}f||(delete this._translations[g],delete this._availableLangs[$c(g)]);this.fire("data:remove",g,e)}}};Ha.prototype.destroy=function(){this._parser=this._assets=this._availableLangs=this._translations=null;this.off()};Object.defineProperty(Ha.prototype,"locale",{get:function(){return this._locale},set:function(a){if(this._locale!==a){var b=
$c(a);if("in"===b){b="id";var c=b,d=a.indexOf("-");a=-1!==d?c+a.substring(d):c;if(this._locale===a)return}c=this._locale;this._locale=a;this._lang=b;this._pluralFn=uf[this._lang]||kj;this.fire("set:locale",a,c)}}});Object.defineProperty(Ha.prototype,"assets",{get:function(){return this._assets},set:function(a){var b,c={};var d=0;for(b=a.length;d<b;d++){var e=a[d]instanceof X?a[d].id:a[d];c[e]=!0}for(d=this._assets.length;d--;)e=this._assets[d],c[e]||(this._app.assets.off("add:"+e,this._onAssetAdd,
this),(a=this._app.assets.get(e))&&this._onAssetRemove(a),this._assets.splice(d,1));for(e in c)if(e=parseInt(e,10),-1===this._assets.indexOf(e))if(this._assets.push(e),a=this._app.assets.get(e))this._onAssetAdd(a);else this._app.assets.once("add:"+e,this._onAssetAdd,this)}});Ha.prototype._findFallbackLocale=function(a,b){return(a=Qg[a])&&this._translations[a]||(a=Qg[b])&&this._translations[a]?a:(a=this._availableLangs[b])&&this._translations[a]?a:bg};Ha.prototype._onAssetAdd=function(a){a.on("load",
this._onAssetLoad,this);a.on("change",this._onAssetChange,this);a.on("remove",this._onAssetRemove,this);a.on("unload",this._onAssetUnload,this);a.resource&&this._onAssetLoad(a)};Ha.prototype._onAssetLoad=function(a){this.addData(a.resource)};Ha.prototype._onAssetChange=function(a){a.resource&&this.addData(a.resource)};Ha.prototype._onAssetRemove=function(a){a.off("load",this._onAssetLoad,this);a.off("change",this._onAssetChange,this);a.off("remove",this._onAssetRemove,this);a.off("unload",this._onAssetUnload,
this);a.resource&&this.removeData(a.resource);this._app.assets.once("add:"+a.id,this._onAssetAdd,this)};Ha.prototype._onAssetUnload=function(a){a.resource&&this.removeData(a.resource)};var Ce=/^\s*(?:(?:[a-z]+[a-z0-9\-\+\.]*:)?\/\/|data:|blob:)/i,lj=[],vf=function(a){var b="_"+a;lj.push(b);Object.defineProperty(Hh.prototype,a,{get:function(){return this[b]||null},set:function(a){if(!!this[b]!==!!a||this[b]&&a&&this[b].hash!==a.hash)this[b]=a?{url:a.url,filename:a.filename,size:a.size,hash:a.hash,
opt:a.opt||0}:null,this.asset.file&&(this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file),this.asset.reload())}})};vf("dxt");vf("pvr");vf("etc1");vf("etc2");vf("basis");Hh.prototype.clear=function(){for(var a=0;a<lj.length;a++)this[lj[a]]=null};var Um=-1,ko={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},Hl=["pvr","dxt","etc2","etc1","basis"];X.prototype=Object.create(H.prototype);
X.prototype.constructor=X;Object.assign(X.prototype,{getFileUrl:function(){var a=this.getPreferredFile();if(!a||!a.url)return null;var b=a.url;this.registry&&this.registry.prefix&&!Ce.test(b)&&(b=this.registry.prefix+b);if("script"!==this.type&&a.hash){var c=-1!==b.indexOf("?")?"&":"?";b+=c+"t="+a.hash}return b},getPreferredFile:function(){if(!this.file)return null;if("texture"===this.type||"textureatlas"===this.type||"bundle"===this.type)for(var a=this.registry._loader._app,b=a.graphicsDevice,c=
0,d=Hl.length;c<d;c++){var e=Hl[c];if(b[ko[e]]){if(this.file.variants[e])return this.file.variants[e];if(a.enableBundles){var g=a.bundles.listBundlesForAsset(this);if(g)for(var k=0,f=g.length;k<f;k++)if(g[k].file&&g[k].file.variants&&g[k].file.variants[e])return this.file}}}return this.file},getAbsoluteUrl:function(a){var b=V.getDirectory(this.file.url);return V.join(b,a)},getLocalizedAssetId:function(a){a=Ha.findAvailableLocale(a,this._i18n);return this._i18n[a]||null},addLocalizedAssetId:function(a,
b){this._i18n[a]=b;this.fire("add:localized",a,b)},removeLocalizedAssetId:function(a){var b=this._i18n[a];b&&(delete this._i18n[a],this.fire("remove:localized",a,b))},ready:function(a,b){b=b||this;if(this.resource)a.call(b,this);else this.once("load",function(c){a.call(b,c)})},reload:function(){this.loaded&&("cubemap"===this.type?this.registry._loader.patch(this,this.registry):(this.loaded=!1,this.registry.load(this)))},unload:function(){if(this.loaded||0!==this._resources.length){this.fire("unload",
this);this.registry.fire("unload:"+this.id,this);for(var a=0;a<this._resources.length;++a){var b=this._resources[a];b&&b.destroy&&b.destroy()}this.resources=[];this.loaded=!1;this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type)}}});Object.defineProperty(X.prototype,"id",{get:function(){return this._id},set:function(a){this._id=a}});Object.defineProperty(X.prototype,"file",{get:function(){return this._file},set:function(a){var b;if(!!a!==!!this._file||a&&this._file&&a.hash!==this._file)if(a){this._file||
(this._file={});this._file.url=a.url;this._file.filename=a.filename;this._file.hash=a.hash;this._file.size=a.size;this._file.variants=this.variants;if(a.hasOwnProperty("variants")&&(this.variants.clear(),a.variants))for(b in a.variants)a.variants[b]&&(this.variants[b]=a.variants[b]);this.fire("change",this,"file",this._file,this._file);this.reload()}else this._file=null,this.variants.clear();else if(a&&this._file&&a.hasOwnProperty("variants")&&(this.variants.clear(),a.variants))for(b in a.variants)a.variants[b]&&
(this.variants[b]=a.variants[b])}});Object.defineProperty(X.prototype,"data",{get:function(){return this._data},set:function(a){var b=this._data;this._data=a;a!==b&&(this.fire("change",this,"data",a,b),this.loaded&&this.registry._loader.patch(this,this.registry))}});Object.defineProperty(X.prototype,"resource",{get:function(){return this._resources[0]},set:function(a){var b=this._resources[0];this._resources[0]=a;this.fire("change",this,"resource",a,b)}});Object.defineProperty(X.prototype,"resources",
{get:function(){return this._resources},set:function(a){var b=this._resources;this._resources=a;this.fire("change",this,"resources",a,b)}});Object.defineProperty(X.prototype,"preload",{get:function(){return this._preload},set:function(a){a=!!a;this._preload!==a&&(this._preload=a)&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this)}});var lo=function(a){return a.substring(a.indexOf(":")+1,a.indexOf(";"))},Rg=function(a){switch(a){case "SCALAR":return 1;case "VEC2":return 2;case "VEC3":return 3;
case "VEC4":return 4;case "MAT2":return 4;case "MAT3":return 9;case "MAT4":return 16;default:return 3}},mo=function(a){switch(a){case 5120:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6;default:return 0}},no=function(a){switch(a){case 5120:return 1;case 5121:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:return 0}},mj=function(a){switch(a.componentType){case 5120:return Int8Array;
case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},De=function(a,b,c){if(a.hasOwnProperty("sparse")){var d=a.sparse.values.bufferView;var e=a.sparse.count}else d=a.bufferView,e=a.count;b=b[d];c=c[b.buffer];d=a.hasOwnProperty("byteOffset")?a.byteOffset:0;b=b.hasOwnProperty("byteOffset")?b.byteOffset:0;b=c.byteOffset+d+b;e*=Rg(a.type);return(a=mj(a))?new a(c.buffer,
b,e):null},Il=function(a,b,c){b=b[a.sparse.indices.bufferView];c=c[b.buffer];b=b.hasOwnProperty("byteOffset")?b.byteOffset:0;b=c.byteOffset+b;var d=a.sparse.count;switch(a.sparse.indices.componentType){case 5120:return new Int8Array(c.buffer,b,d);case 5121:return new Uint8Array(c.buffer,b,d);case 5122:return new Int16Array(c.buffer,b,d);case 5123:return new Uint16Array(c.buffer,b,d);case 5124:return new Int32Array(c.buffer,b,d);case 5125:return new Uint32Array(c.buffer,b,d);case 5126:return new Float32Array(c.buffer,
b,d);default:return null}},oo=function(a){if(!a.hasOwnProperty("mode"))return 4;switch(a.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6;default:return 4}},Jl=function(a,b,c,d,e){if(!e){e=new Uint16Array(d);for(var g=0;g<d;g++)e[g]=g}c=Uj(c,e);e=new Float32Array(c.length);e.set(c);b.push({semantic:"NORMAL",components:3,type:6});a.NORMAL={buffer:e.buffer,size:12,offset:0,stride:12,count:d}},Kl=function(a,b,c,d,e){var g="POSITION NORMAL TANGENT COLOR BLENDINDICES BLENDWEIGHT TEXCOORD0 TEXCOORD1".split(" ");
c.sort(function(a,b){a=g.indexOf(a.semantic);b=g.indexOf(b.semantic);return a<b?-1:b<a?1:0});a=new Za(a,new Ka(a,c),b,0);var k,f=!0;for(c=0;c<a.format.elements.length;++c){var h=a.format.elements[c];var p=e[h.name];var n=p.offset-d.offset;if(p.buffer!==d.buffer||p.stride!==h.stride||p.size!==h.size||n!==h.offset){f=!1;break}}c=a.lock();n=new Uint32Array(c);if(f)d=new Uint32Array(d.buffer,d.offset,b*a.format.size/4),n.set(d);else for(c=0;c<a.format.elements.length;++c){h=a.format.elements[c];f=h.stride/
4;p=e[h.name];d=new Uint32Array(p.buffer,p.offset,p.count*p.stride/4);var m=p.stride/4;var q=0,u=h.offset/4;for(h=0;h<b;++h){for(k=0;k<p.size/4;++k)n[u+k]=d[q+k];q+=m;u+=f}}a.unlock();return a},po=function(a,b,c,d,e,g,k){var f=[],h={};for(t in b)if(b.hasOwnProperty(t)){var p=d[b[t]],n=e[p.bufferView];if(k.hasOwnProperty(t)){var m=k[t].semantic;f.push({semantic:m,components:Rg(p.type),type:mo(p.componentType),normalize:p.normalized});var q=Rg(p.type)*no(p.componentType),u=g[n.buffer];h[m]={buffer:u.buffer,
size:q,offset:(p.hasOwnProperty("byteOffset")?p.byteOffset:0)+(n.hasOwnProperty("byteOffset")?n.byteOffset:0)+u.byteOffset,stride:n.hasOwnProperty("byteStride")?n.byteStride:q,count:p.count}}}k=h.POSITION;var t=k.count;h.hasOwnProperty("NORMAL")||(b=De(d[b.POSITION],e,g),Jl(h,f,b,t,c));return Kl(a,t,f,k,h)},qo=function(a,b,c,d,e,g,k){var f,h=b.num_points(),p=[],n={};c=c.attributes;for(var m in c)if(c.hasOwnProperty(m)&&g.hasOwnProperty(m)){var q=g[m].semantic;var u=d.GetAttributeByUniqueId(b,c[m]);
var t=h*u.num_components();switch(u.data_type()){case e.DT_UINT8:var r=f=1;var w=e._malloc(t*r);d.GetAttributeDataArrayForAllPoints(b,u,e.DT_UINT8,t*r,w);t=(new Uint8Array(e.HEAPU8.buffer,w,t)).slice();break;case e.DT_UINT16:f=3;r=2;w=e._malloc(t*r);d.GetAttributeDataArrayForAllPoints(b,u,e.DT_UINT16,t*r,w);t=(new Uint16Array(e.HEAPU16.buffer,w,t)).slice();break;default:f=6,r=4,w=e._malloc(t*r),d.GetAttributeDataArrayForAllPoints(b,u,e.DT_FLOAT32,t*r,w),t=(new Float32Array(e.HEAPF32.buffer,w,t)).slice()}e._free(w);
w=t;t=u.num_components();u=u.normalized();p.push({semantic:q,components:t,type:f,normalize:u});u=t*r;n[q]={values:w,buffer:w.buffer,size:u,offset:0,stride:u,count:h}}b=n.POSITION;d=b.count;n.hasOwnProperty("NORMAL")||Jl(n,p,b.values,d,k);return Kl(a,d,p,b,n)},Sg=new C,Ee=new r,ro=function(a,b,c,d,e,g){var k=[],f={POSITION:{semantic:"POSITION"},NORMAL:{semantic:"NORMAL"},TANGENT:{semantic:"TANGENT"},COLOR_0:{semantic:"COLOR"},JOINTS_0:{semantic:"BLENDINDICES"},WEIGHTS_0:{semantic:"BLENDWEIGHT"},TEXCOORD_0:{semantic:"TEXCOORD0"},
TEXCOORD_1:{semantic:"TEXCOORD1"}};b.primitives.forEach(function(h){var l=null,n=new fb(a),m=!0;if(h.hasOwnProperty("extensions")){var q=h.extensions;if(q.hasOwnProperty("KHR_draco_mesh_compression")){var u=window.DracoDecoderModule;if(u&&(q=q.KHR_draco_mesh_compression,q.hasOwnProperty("attributes"))){m=d[q.bufferView];var t=e[m.buffer];t=new Uint8Array(t.buffer,t.byteOffset+m.byteOffset,m.byteLength);m=new u.DecoderBuffer;m.Init(t,t.length);t=new u.Decoder;var y=t.GetEncodedGeometryType(m);switch(y){case u.POINT_CLOUD:var w=
0;var v=new u.PointCloud;var x=t.DecodeBufferToPointCloud(m,v);break;case u.TRIANGULAR_MESH:w=4,v=new u.Mesh,x=t.DecodeBufferToMesh(m,v)}if(!x||!x.ok()||0==v.ptr){g("Failed to decode draco compressed asset: "+(x?x.error_msg():"Mesh asset - invalid draco compressed geometry type: "+y));return}x=v.num_faces();if(y==u.TRIANGULAR_MESH){l=65535<v.num_points();y=3*x;var z=y*(l?4:2);x=u._malloc(z);l?(t.GetTrianglesUInt32Array(v,z,x),l=(new Uint32Array(u.HEAPU32.buffer,x,y)).slice()):(t.GetTrianglesUInt16Array(v,
z,x),l=(new Uint16Array(u.HEAPU16.buffer,x,y)).slice());u._free(x)}y=qo(a,v,q,t,u,f,l);u.destroy(v);u.destroy(t);u.destroy(m);m=!1}}}y||(l=h.hasOwnProperty("indices")?De(c[h.indices],d,e):null,y=po(a,h.attributes,l,c,d,e,f),w=oo(h));n.vertexBuffer=y;n.primitive[0].type=w;n.primitive[0].base=0;n.primitive[0].indexed=null!==l;null!==l?(w=new Rb(a,l instanceof Uint8Array?0:l instanceof Uint16Array?1:2,l.length,0,l),n.indexBuffer[0]=w,n.primitive[0].count=l.length):n.primitive[0].count=y.numVertices;
n.materialIndex=h.material;var A=c[h.attributes.POSITION];w=A.min;u=A.max;w=new ia(new r((u[0]+w[0])/2,(u[1]+w[1])/2,(u[2]+w[2])/2),new r((u[0]-w[0])/2,(u[1]-w[1])/2,(u[2]-w[2])/2));n.aabb=w;var B=function(a,b,c,d){c=new c(3*d);for(d=0;d<b.length;d++){var e=3*b[d];c[e]=a[3*d];c[e+1]=a[3*d+1];c[e+2]=a[3*d+2]}return c};if(m&&h.hasOwnProperty("targets")){var C=[],D;h.targets.forEach(function(g,k){var f={};g.hasOwnProperty("POSITION")&&(A=c[g.POSITION],D=mj(A),f.deltaPositions=De(A,d,e),f.deltaPositionsType=
Vi[D.name],A.sparse&&(f.deltaPositions=B(f.deltaPositions,Il(A,d,e),D,n.vertexBuffer.numVertices)),A.hasOwnProperty("min")&&A.hasOwnProperty("max")&&(f.aabb=new ia,f.aabb.setMinMax(new r(A.min),new r(A.max))));g.hasOwnProperty("NORMAL")&&(A=c[g.NORMAL],D=mj(A),f.deltaNormals=De(A,d,e),f.deltaNormalsType=Vi[D.name],A.sparse&&(f.deltaNormals=B(f.deltaNormals,Il(A,d,e),D,n.vertexBuffer.numVertices)));b.hasOwnProperty("extras")&&b.extras.hasOwnProperty("targetNames")?f.name=b.extras.targetNames[k]:f.name=
C.length.toString(10);C.push(new Qe(a,f))});n.morph=new Pe(C);if(b.hasOwnProperty("weights"))for(h=0;h<b.weights.length;++h)C[h].defaultWeight=b.weights[h]}k.push(n)});return k},so=function(a,b){var c=function(a,b,c){var d,e=a.texCoord;if(e)for(d=0;d<c.length;++d)b[c[d]+"MapUv"]=e;if(d=a.extensions)if(a=d.KHR_texture_transform){if(e=a.scale)for(d=0;d<c.length;++d)b[c[d]+"MapTiling"]=new M(e[0],e[1]);if(a=a.offset)for(d=0;d<c.length;++d)b[c[d]+"MapOffset"]=new M(a[0],a[1])}},d=new ea;d.occludeSpecular=
!0;d.diffuseTint=!0;d.diffuseVertexColor=!0;d.specularTint=!0;d.specularVertexColor=!0;a.hasOwnProperty("name")&&(d.name=a.name);if(a.hasOwnProperty("extensions")&&a.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){var e=a.extensions.KHR_materials_pbrSpecularGlossiness;if(e.hasOwnProperty("diffuseFactor")){var g=e.diffuseFactor;d.diffuse.set(Math.pow(g[0],1/2.2),Math.pow(g[1],1/2.2),Math.pow(g[2],1/2.2));d.opacity=null!=g[3]?g[3]:1}else d.diffuse.set(1,1,1),d.opacity=1;if(e.hasOwnProperty("diffuseTexture")){var k=
e.diffuseTexture;g=b[k.index];d.diffuseMap=g;d.diffuseMapChannel="rgb";d.opacityMap=g;d.opacityMapChannel="a";c(k,d,["diffuse","opacity"])}d.useMetalness=!1;e.hasOwnProperty("specularFactor")?(g=e.specularFactor,d.specular.set(Math.pow(g[0],1/2.2),Math.pow(g[1],1/2.2),Math.pow(g[2],1/2.2))):d.specular.set(1,1,1);e.hasOwnProperty("glossinessFactor")?d.shininess=100*e.glossinessFactor:d.shininess=100;e.hasOwnProperty("specularGlossinessTexture")&&(g=e.specularGlossinessTexture,d.specularMap=d.glossMap=
b[g.index],d.specularMapChannel="rgb",d.glossMapChannel="a",c(g,d,["gloss","metalness"]));d.chunks.specularPS="#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\n\t#ifdef MAPCOLOR\n\t\tdSpecularity *= material_specular;\n\t#endif\n\n\t#ifdef MAPTEXTURE\n\t\tvec3 srgb = texture2D(texture_specularMap, $UV).$CH;\n\t\tdSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));\n\t#endif\n\n\t#ifdef MAPVERTEX\n\t\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}"}else a.hasOwnProperty("pbrMetallicRoughness")&&
(e=a.pbrMetallicRoughness,e.hasOwnProperty("baseColorFactor")?(g=e.baseColorFactor,d.diffuse.set(Math.pow(g[0],1/2.2),Math.pow(g[1],1/2.2),Math.pow(g[2],1/2.2)),d.opacity=g[3]):(d.diffuse.set(1,1,1),d.opacity=1),e.hasOwnProperty("baseColorTexture")&&(k=e.baseColorTexture,g=b[k.index],d.diffuseMap=g,d.diffuseMapChannel="rgb",d.opacityMap=g,d.opacityMapChannel="a",c(k,d,["diffuse","opacity"])),d.useMetalness=!0,e.hasOwnProperty("metallicFactor")?d.metalness=e.metallicFactor:d.metalness=1,e.hasOwnProperty("roughnessFactor")?
d.shininess=100*e.roughnessFactor:d.shininess=100,e.hasOwnProperty("metallicRoughnessTexture")&&(g=e.metallicRoughnessTexture,d.metalnessMap=d.glossMap=b[g.index],d.metalnessMapChannel="b",d.glossMapChannel="g",c(g,d,["gloss","metalness"])),d.chunks.glossPS="#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\n#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n#endif\n\n#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n#endif\n\n\tdGlossiness = 1.0 - dGlossiness;\n\n\tdGlossiness += 0.0000001;\n}");
a.hasOwnProperty("normalTexture")&&(g=a.normalTexture,d.normalMap=b[g.index],c(g,d,["normal"]),g.hasOwnProperty("scale")&&(d.bumpiness=g.scale));a.hasOwnProperty("occlusionTexture")&&(g=a.occlusionTexture,d.aoMap=b[g.index],d.aoMapChannel="r",c(g,d,["ao"]));a.hasOwnProperty("emissiveFactor")?(g=a.emissiveFactor,d.emissive.set(Math.pow(g[0],1/2.2),Math.pow(g[1],1/2.2),Math.pow(g[2],1/2.2)),d.emissiveTint=!0):(d.emissive.set(0,0,0),d.emissiveTint=!1);a.hasOwnProperty("emissiveTexture")&&(g=a.emissiveTexture,
d.emissiveMap=b[g.index],c(g,d,["emissive"]));if(a.hasOwnProperty("alphaMode"))switch(a.alphaMode){case "MASK":d.blendType=3;a.hasOwnProperty("alphaCutoff")?d.alphaTest=a.alphaCutoff:d.alphaTest=.5;break;case "BLEND":d.blendType=2;break;default:case "OPAQUE":d.blendType=3}else d.blendType=3;a.hasOwnProperty("doubleSided")?(d.twoSidedLighting=a.doubleSided,d.cull=a.doubleSided?0:1):(d.twoSidedLighting=!1,d.cull=1);a.hasOwnProperty("extensions")&&a.extensions.hasOwnProperty("KHR_materials_unlit")&&
(d.useLighting=!1,d.emissive.copy(d.diffuse),d.emissiveTint=d.diffuseTint,d.emissiveMap=d.diffuseMap,d.emissiveMapUv=d.diffuseMapUv,d.emissiveMapTiling.copy(d.diffuseMapTiling),d.emissiveMapOffset.copy(d.diffuseMapOffset),d.emissiveMapChannel=d.diffuseMapChannel,d.emissiveVertexColor=d.diffuseVertexColor,d.emissiveVertexColorChannel=d.diffuseVertexColorChannel,d.diffuse.set(0,0,0),d.diffuseTint=!1,d.diffuseMap=null,d.diffuseVertexColor=!1);d.update();return d},to=function(a,b,c,d,e,g){var k=function(a){var b=
De(a,d,g);return new Re(Rg(a.type),new b.constructor(b))},f={STEP:pc.INTERPOLATION_STEP,LINEAR:pc.INTERPOLATION_LINEAR,CUBICSPLINE:pc.INTERPOLATION_CUBIC},h={},p=[],n={},m=[],q=[],u;for(u=0;u<a.samplers.length;++u){var t=a.samplers[u];h.hasOwnProperty(t.input)||(h[t.input]=p.length,p.push(k(c[t.input])));n.hasOwnProperty(t.output)||(n[t.output]=m.length,m.push(k(c[t.output])));var r=t.hasOwnProperty("interpolation")&&f.hasOwnProperty(t.interpolation)?f[t.interpolation]:pc.INTERPOLATION_LINEAR;q.push(new ag([],
h[t.input],n[t.output],r))}c=[];k=new pc.AnimPropertyLocator;f={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"};for(u=0;u<a.channels.length;++u)n=a.channels[u],h=n.target,n=q[n.sampler],n._paths.push(k.encode([[e[h.node].name],"graph",[f[h.path]]])),h.path.startsWith("rotation")&&n.interpolation!==pc.INTERPOLATION_CUBIC?c.push(n.output):h.path.startsWith("weights")&&(m[n.output]._components=m[n.output].data.length/p[n.input].data.length);c.sort();k=null;
for(u=0;u<c.length;++u)if(e=c[u],0===u||e!==k){k=m[e];if(4===k.components)for(k=k.data,f=k.length-4,h=0;h<f;h+=4)0>k[h+0]*k[h+4]+k[h+1]*k[h+5]+k[h+2]*k[h+6]+k[h+3]*k[h+7]&&(k[h+4]*=-1,k[h+5]*=-1,k[h+6]*=-1,k[h+7]*=-1);k=e}u=p.reduce(function(a,b){b=b._data;return Math.max(a,0===b.length?0:b[b.length-1])},0);return new Ud(a.hasOwnProperty("name")?a.name:"animation_"+b,u,p,m,q)},uo=function(a,b){var c=new Z;a.hasOwnProperty("name")?c.name=a.name:c.name="node_"+b;a.hasOwnProperty("matrix")&&(Sg.data.set(a.matrix),
Sg.getTranslation(Ee),c.setLocalPosition(Ee),Sg.getEulerAngles(Ee),c.setLocalEulerAngles(Ee),Sg.getScale(Ee),c.setLocalScale(Ee));a.hasOwnProperty("rotation")&&(b=a.rotation,c.setLocalRotation(b[0],b[1],b[2],b[3]));a.hasOwnProperty("translation")&&(b=a.translation,c.setLocalPosition(b[0],b[1],b[2]));a.hasOwnProperty("scale")&&(a=a.scale,c.setLocalScale(a[0],a[1],a[2]));return c},vo=function(a,b,c,d){return b.hasOwnProperty("skins")&&0!==b.skins.length?b.skins.map(function(e){var g=b.accessors,f=b.bufferViews,
l,h=e.joints,p=h.length,n=[];if(e.hasOwnProperty("inverseBindMatrices")){f=De(g[e.inverseBindMatrices],f,d);var m=[];for(g=0;g<p;g++){for(l=0;16>l;l++)m[l]=f[16*g+l];l=new C;l.set(m);n.push(l)}}else for(g=0;g<p;g++)l=new C,n.push(l);f=[];for(g=0;g<p;g++)f[g]=c[h[g]].name;e=e.skeleton;n=new Of(a,n,f);n.skeleton=c[e];n.bones=[];for(g=0;g<h.length;g++)n.bones[g]=c[h[g]];return n}):[]},wo=function(a,b,c,d){return b.hasOwnProperty("meshes")&&0!==b.meshes.length&&b.hasOwnProperty("accessors")&&0!==b.accessors.length&&
b.hasOwnProperty("bufferViews")&&0!==b.bufferViews.length?b.meshes.map(function(e){return ro(a,e,b.accessors,b.bufferViews,c,d)}):[]},xo=function(a,b){return a.hasOwnProperty("materials")&&0!==a.materials.length?a.materials.map(function(a){return so(a,b)}):[]},yo=function(a,b,c){return a.hasOwnProperty("animations")&&0!==a.animations.length?a.animations.map(function(d,e){return to(d,e,a.accessors,a.bufferViews,b,c)}):[]},zo=function(a){if(!a.hasOwnProperty("nodes")||0===a.nodes.length)return[];for(var b=
a.nodes.map(uo),c=0;c<a.nodes.length;++c){var d=a.nodes[c];if(d.hasOwnProperty("children"))for(var e=0;e<d.children.length;++e){var g=b[c],f=b[d.children[e]];f.parent||g.addChild(f)}}return b},Ll=function(a,b,c,d,e){var g=zo(b),f=yo(b,g,c),l=xo(b,b.textures?b.textures.map(function(a){return d[a.source].resource}):[]),h=wo(a,b,c,e);a=vo(a,b,g,c);e(null,{gltf:b,nodes:g,animations:f,textures:d,materials:l,meshes:h,skins:a})},Ao=function(a,b){var c={magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497},
d=function(a){switch(a){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return 1}},e=function(a){switch(a){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return 0}};b=b||c;a.minFilter=d(b.minFilter);a.magFilter=d(b.magFilter);a.addressU=e(b.wrapS);a.addressV=e(b.wrapT)},Bo=function(a,b,c,d,e,g){var f=[];if(b.hasOwnProperty("images")&&0!==b.images.length&&b.hasOwnProperty("textures")&&0!==b.textures.length){var l=
b.images.length;a=function(a,c){f[a]=c;if(0===--l){for(a=0;a<b.textures.length;++a)c=b.textures[a],Ao(f[c.source],(b.samplers||[])[c.sampler]);g(null,f)}};for(var h=0;h<b.images.length;++h){var p=b.images[h],n={};if(p.hasOwnProperty("uri"))if(/^data:.*,.*$/i.test(p.uri)){var m=p.uri;var q=lo(p.uri)}else m=V.join(d,p.uri),n.crossOrigin="anonymous";else if(p.hasOwnProperty("bufferView")&&p.hasOwnProperty("mimeType")){q=b.bufferViews[p.bufferView];m=q.hasOwnProperty("byteOffset")?q.byteOffset:0;var u=
c[q.buffer];q=new Uint8Array(u.buffer,u.byteOffset+m,q.byteLength);q=new Blob([q],{type:p.mimeType});m=URL.createObjectURL(q);q=p.mimeType}else{g("Invalid image found in gltf (neither uri or bufferView found). index="+h);break}p={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/vnd-ms.dds":"dds"};m={url:m};q&&(p=p[q])&&(m.filename="glb-texture-"+h+"."+p);n=new X("texture_"+h,"texture",m,{flipY:!1},n);n.on("load",a.bind(null,h));e.add(n);e.load(n)}}else g(null,f)},
Co=function(a,b,c,d){var e=[];if(null===a.buffers||0===a.buffers.length)d(null,e);else for(var g=a.buffers.length,f=function(a,b){e[b]=a;0===--g&&d(null,e)},l=function(a){return function(b,c){b?d(b):f(new Uint8Array(c),a)}},h=0;h<a.buffers.length;++h){var p=a.buffers[h];if(p.hasOwnProperty("uri"))if(/^data:.*,.*$/i.test(p.uri)){p=atob(p.uri.split(",")[1]);var n=new ArrayBuffer(p.length);n=new Uint8Array(n);for(var m=0;m<p.length;m++)n[m]=p.charCodeAt(m);f(n,h)}else qa.get(V.join(c,p.uri),{cache:!0,
responseType:"arraybuffer",retry:!1},l(h));else f(b,h)}},Ml=function(a,b){a=JSON.parse(function(a){if("undefined"!==typeof TextDecoder)return(new TextDecoder).decode(a);a=a.reduce(function(a,b){return a+=String.fromCharCode(b)},"");return decodeURIComponent(escape(a))}(a));a.asset&&a.asset.version&&2>Number.parseFloat(a.asset.version)?b("Invalid gltf version. Expected version 2.0 or above but found version '"+a.asset.version+"'."):b(null,a)},Nl=function(a,b,c){if(a&&a.toLowerCase().endsWith(".glb")){a=
new DataView(b);var d=a.getUint32(0,!0),e=a.getUint32(4,!0),g=a.getUint32(8,!0);if(1179937895!==d)c("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+d.toString(16));else if(2!==e)c("Invalid version number found in glb header. Expected 2, found "+e);else if(0>=g||g>b.byteLength)c("Invalid length found in glb header. Found "+g);else{d=[];for(e=12;e<g;){var f=a.getUint32(e,!0);if(e+f+8>b.byteLength)throw Error("Invalid chunk length found in glb. Found "+f);var l=a.getUint32(e+
4,!0),h=new Uint8Array(b,e+8,f);d.push({length:f,type:l,data:h});e+=f+8}1!==d.length&&2!==d.length?c("Invalid number of chunks found in glb file."):1313821514!==d[0].type?c("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+d[0].type.toString(16)):1<d.length&&5130562!==d[1].type?c("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+d[1].type.toString(16)):c(null,{gltfChunk:d[0].data,binaryChunk:2===d.length?d[1].data:null})}}else c(null,{gltfChunk:b,binaryChunk:null})};
Lc.parseAsync=function(a,b,c,d,e,g){Nl(a,c,function(a,c){a?g(a):Ml(c.gltfChunk,function(a,f){a?g(a):Co(f,c.binaryChunk,b,function(a,c){a?g(a):Bo(d,f,c,b,e,function(a,b){a?g(a):Ll(d,f,c,b,g)})})})})};Lc.parse=function(a,b,c){var d=null;Nl(a,b,function(a,b){a?console.error(a):Ml(b.gltfChunk,function(a,e){a?console.error(a):Ll(c,e,[b.binaryChunk],[],function(a,b){a?console.error(a):d=b})})});return d};Lc.createModel=function(a,b){var c=new gb,d,e=[];for(d=0;d<a.nodes.length;d++){var g=a.nodes[d];null===
g.parent&&e.push(g);var f=a.gltf.nodes[d];if(f.hasOwnProperty("mesh"))for(var l=a.meshes[f.mesh],h=0;h<l.length;h++){var p=c,n=l[h],m=a.skins,q=f,u=new ma(g,n,void 0===n.materialIndex?b:a.materials[n.materialIndex]);if(n.morph){var t=new qc(n.morph);if(n.weights)for(var r=0;r<n.weights.length;r++)t.setWeight(r,n.weights[r]);u.morphInstance=t;p.morphInstances.push(t)}q.hasOwnProperty("skin")&&(m=m[q.skin],n.skin=m,n=new Rd(m),n.bones=m.bones,u.skinInstance=n,p.skinInstances.push(n));p.meshInstances.push(u)}}if(1===
e.length)c.graph=e[0];else for(c.graph=new Z("SceneGroup"),d=0;d<e.length;++d)c.graph.addChild(e[d]);return c};Object.assign(Ih.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c={retry:this.retryRequests};a.load.startsWith("blob:")&&(".glb"===V.getExtension(a.original).toLowerCase()?c.responseType=N.ResponseType.ARRAY_BUFFER:c.responseType=N.ResponseType.JSON);qa.get(a.load,c,function(c,e){c?b("Error loading animation resource: "+a.original+" ["+c+"]"):b(null,e)})},
open:function(a,b){return".glb"===V.getExtension(a).toLowerCase()?(a=Lc.parse("filename.glb",b,null))?a.animations:null:this["_parseAnimationV"+b.animation.version](b)},_parseAnimationV3:function(a){a=a.animation;var b=new Fb;b.setName(a.name);b.duration=a.duration;for(var c=0;c<a.nodes.length;c++){var d=new Zf,e=a.nodes[c];d._name=e.name;for(var g=0;g<e.keys.length;g++){var f=e.keys[g],l=f.time,h=f.pos,p=f.rot;f=f.scale;h=new r(h[0],h[1],h[2]);p=(new T).setFromEulerAngles(p[0],p[1],p[2]);f=new r(f[0],
f[1],f[2]);l=new Yf(l,h,p,f);d._keys.push(l)}b.addNode(d)}return b},_parseAnimationV4:function(a){a=a.animation;var b=new Fb;b.setName(a.name);b.duration=a.duration;for(var c=0;c<a.nodes.length;c++){var d=new Zf,e=a.nodes[c];d._name=e.name;for(var g=e.defaults.p,f=e.defaults.r,l=e.defaults.s,h=0;h<e.keys.length;h++){var p=e.keys[h],n=p.t,m=g?g:p.p,q=f?f:p.r;p=l?l:p.s;m=new r(m[0],m[1],m[2]);q=(new T).setFromEulerAngles(q[0],q[1],q[2]);p=new r(p[0],p[1],p[2]);n=new Yf(n,m,q,p);d._keys.push(n)}b.addNode(d)}return b}});
Object.assign(Jh.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c={retry:this.retryRequests};a.load.startsWith("blob:")&&(c.responseType=N.ResponseType.JSON);qa.get(a.load,c,function(c,e){c?b("Error loading animation clip resource: "+a.original+" ["+c+"]"):b(null,e)})},open:function(a,b){a=b.name;var c=b.duration,d=b.inputs.map(function(a){return new Re(1,a)}),e=b.outputs.map(function(a){return new Re(a.components,a.data)});b=b.curves.map(function(a){return new ag([a.path],
a.inputIndex,a.outputIndex,a.interpolation)});return new Ud(a,c,d,e,b)}});Object.defineProperties(Kh.prototype,{parameters:{get:function(){return Object.assign({},this._parameters)}},layers:{get:function(){return this._layers}}});Object.assign(Lh.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c={retry:this.retryRequests};a.load.startsWith("blob:")&&(c.responseType=N.ResponseType.JSON);qa.get(a.load,c,function(c,e){c?b("Error loading animation state graph resource: "+
a.original+" ["+c+"]"):b(null,e)})},open:function(a,b){return new Kh(b)}});Object.defineProperty(cg.prototype,"duration",{get:function(){var a=0;this.buffer?a=this.buffer.duration:this.audio&&(a=this.audio.duration);return a||0}});var nj=function(){if("undefined"===typeof window)return!1;var a=window.navigator.userAgent,b=a.indexOf("MSIE ");return 0<b?parseInt(a.substring(b+5,a.indexOf(".",b)),10):0<a.indexOf("Trident/")?(b=a.indexOf("rv:"),parseInt(a.substring(b+3,a.indexOf(".",b)),10)):!1}();Object.assign(Ue.prototype,
{_isSupported:function(a){return{".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"}[V.getExtension(a)]?!0:!1},load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=function(a){b(null,new cg(a))},d=function(c){var d="Error loading audio url: "+a.original;c&&(d+=": "+(c.message||c));console.warn(d);b(d)};this._createSound?this._isSupported(a.original)?this._createSound(a.load,c,d):d("Audio format for "+
a.original+" not supported"):d(null)},open:function(a,b){return b}});Kc()?Ue.prototype._createSound=function(a,b,c){var d=this.manager;if(d.context){var e={retry:this.retryRequests};a.startsWith("blob:")&&(e.responseType=N.ResponseType.ARRAY_BUFFER);qa.get(a,e,function(a,e){a?c(a):d.context.decodeAudioData(e,b,c)})}else c("Audio manager has no audio context")}:Td()&&(Ue.prototype._createSound=function(a,b,c){var d=null;try{d=new Audio}catch(g){c("No support for Audio element");return}nj&&document.body.appendChild(d);
var e=function(){d.removeEventListener("canplaythrough",e);nj&&document.body.removeChild(d);b(d)};d.onerror=function(){d.onerror=null;nj&&document.body.removeChild(d);c()};d.addEventListener("canplaythrough",e);d.src=a});Object.assign(Mh.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});qa.get(a.load,{responseType:N.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(c,d){c?b("Error loading binary resource: "+a.original+" ["+c+"]"):b(null,d)})},open:function(a,b){return b},
patch:function(a,b){}});Ve.prototype.hasBlobUrl=function(a){return!!this._blobUrls[a]};Ve.prototype.getBlobUrl=function(a){return this._blobUrls[a]};Ve.prototype.destroy=function(){for(var a in this._blobUrls)URL.revokeObjectURL(this._blobUrls[a]);this._blobUrls=null};var ck,Nh=null;We.prototype._onMessage=function(a){var b=a.data.id;if(this._pendingRequests[b]){var c=this._pendingRequests[b];delete this._pendingRequests[b];if(a.data.error)c(a.data.error);else{b=a.data.arrayBuffer;for(var d=0,e=a.data.files.length;d<
e;d++){var g=a.data.files[d],f=new Blob([b.slice(g.start,g.start+g.size)]);g.url=URL.createObjectURL(f)}c(null,a.data.files)}}};We.prototype.untar=function(a,b){var c=this._requestId++;this._pendingRequests[c]=b;this._worker.postMessage({id:c,prefix:this._filenamePrefix,arrayBuffer:a},[a])};We.prototype.hasPendingRequests=function(){for(var a in this._pendingRequests)return!0;return!1};We.prototype.destroy=function(){this._worker&&(this._worker.terminate(),this._pendingRequests=this._worker=null)};
bk();Object.assign(Oh.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this;qa.get(a.load,{responseType:N.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(d,e){if(d)b("Error loading bundle resource "+a.original+": "+d);else try{c._untar(e,b)}catch(g){b("Error loading bundle resource "+a.original+": "+g)}})},_untar:function(a,b){var c=this;va.workers?(c._worker||(c._worker=new We(c._assets.prefix)),c._worker.untar(a,function(a,e){b(a,e);c._worker.hasPendingRequests()||
(c._worker.destroy(),c._worker=null)})):(a=(new ck(a)).untar(c._assets.prefix),b(null,a))},open:function(a,b){return new Ve(b)},patch:function(a,b){}});Object.assign(Ph.prototype,{destroy:function(){var a=this.registry,b=function(b){a.remove(b);b.unload()},c=function(a){a.forEach(function(a){b(a)})};this.animations&&(c(this.animations),this.animations=null);this.textures&&(c(this.textures),this.textures=null);this.materials&&(c(this.materials),this.materials=null);this.model&&(b(this.model),this.model=
null);this.assets=this.data=null}});Object.assign(Qh.prototype,{_getUrlWithoutParams:function(a){return 0<=a.indexOf("?")?a.split("?")[0]:a},load:function(a,b,c){"string"===typeof a&&(a={load:a,original:a});var d=this;qa.get(a.load,{responseType:N.ResponseType.ARRAY_BUFFER,retry:!1},function(e,g){b&&(e?b("Error loading model: "+a.original+" ["+e+"]"):Lc.parseAsync(d._getUrlWithoutParams(a.original),V.extractPath(a.load),g,d._device,c.registry,function(a,c){a?b(a):b(null,new Ph(c))}))})},open:function(a,
b,c){return b},patch:function(a,b){var c=function(c,d,e){c=new X(a.name+"/"+c+"/"+e,c,{url:""});c.resource=d;c.loaded=!0;b.add(c);return c},d=a.resource,e=d.data,g,f=c("model",Lc.createModel(e,this._defaultMaterial),0),l=[];for(g=0;g<e.materials.length;++g)l.push(c("material",e.materials[g],g));var h=[];for(g=0;g<e.animations.length;++g)h.push(c("animation",e.animations[g],g));d.data=null;d.model=f;d.materials=l;d.textures=e.textures;d.animations=h;d.registry=b}});Object.assign(Rh.prototype,{load:function(a,
b){"string"===typeof a&&(a={load:a,original:a});qa.get(a.load,{retry:this.retryRequests},function(c,d){c?b("Error loading css resource: "+a.original+" ["+c+"]"):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}});Object.assign(Sh.prototype,{load:function(a,b){},open:function(a,b){},patch:function(a,b){var c=this,d=!1;a.resources[0]||(a.resources[0]=new L(this._device,{format:7,cubemap:!0,mipmaps:!0,fixCubemapSeams:!!a._dds}),a.resources[0].name="cubemap",d=!0);if(!a.file)delete a._dds;
else if(a.file&&!a._dds){var e=a.getFileUrl();b._loader.load(e+"?t="+a.file.hash,"texture",function(d,e){d?(b.fire("error",d,a),b.fire("error:"+a.id,d,a),a.fire("error",d,a)):(b._loader.patch({resource:e,type:"texture",data:a.data},b),a._dds=e,c.patch(a,b))})}if((!a.file||!a._dds)&&a.resources[1])a.resources=[a.resources[0]],d=!0;else if(a._dds&&!a.resources[1]){a.resources=[a.resources[0]];a._dds.fixCubemapSeams=!0;a._dds.addressU=1;a._dds.addressV=1;d=0;this._device.useTexCubeLod&&(a.resources.push(a._dds),
d=1);for(;6>d;d++)e=new L(this._device,{cubemap:!0,fixCubemapSeams:!0,mipmaps:!0,format:a._dds.format,type:a._dds.type,width:Math.pow(2,7-d),height:Math.pow(2,7-d)}),e.name="cubemap-mip",e._levels[0]=a._dds._levels[d],e.upload(),a.resources.push(e);d=!0}e=a.resource;e.name!==a.name&&(e.name=a.name);if(a.data.hasOwnProperty("rgbm")){var g=a.data.rgbm?"rgbm":"default";e.type!==g&&(e.type=g)}e.fixCubemapSeams=!!a._dds;a.data.hasOwnProperty("minFilter")&&e.minFilter!==a.data.minFilter&&(e.minFilter=a.data.minFilter);
a.data.hasOwnProperty("magFilter")&&e.magFilter!==a.data.magFilter&&(e.magFilter=a.data.magFilter);a.data.hasOwnProperty("anisotropy")&&e.anisotropy!==a.data.anisotropy&&(e.anisotropy=a.data.anisotropy);1!==e.addressU&&(e.addressU=1);1!==e.addressV&&(e.addressV=1);this._patchTextureFaces(a,b);d&&(b.fire("load",a),b.fire("load:"+a.id,a),a.fire("load",a))},_patchTexture:function(){this.registry._loader._handlers.cubemap._patchTextureFaces(this,this.registry)},_patchTextureFaces:function(a,b){if(a.loadFaces||
!a.file){var c=a.resource,d=[],e=0,g=!1,f=this;a._levelsEvents||(a._levelsEvents=[null,null,null,null,null,null]);a.data.textures.forEach(function(k,h){var l=function(k){e++;d[h]=k&&k.resource.getSource()||null;var l=a._levelsEvents[h];if(l!==k){l&&l.off("load",f._patchTexture,a);if(k)k.on("load",f._patchTexture,a);a._levelsEvents[h]=k||null}d[h]!==c._levels[0][h]&&(g=!0);6===e&&g&&(c.setSource(d),b.fire("load",a),b.fire("load:"+a.id,a),a.fire("load",a))},n=function(a){a.ready(l);b.load(a)};if(null===
k)l(null);else{var m;parseInt(k,10)===k?(m=b.get(k))?(m.ready(l),b.load(m)):k?(b.once("load:"+k,l),b.once("add:"+k,n)):l(null):(m=new X(a.name+"_face_"+h,"texture",{url:k}),b.add(m),b.load(m),b.once("load:"+m.id,l),b.once("add:"+m.id,n))}})}}});Object.assign(Th.prototype,{load:function(a,b){b(null,null)},open:function(a,b){return b}});Object.defineProperty(dg.prototype,"data",{get:function(){return this._data},set:function(a){if(this._data=a)if(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),
this._data.info||(this._data.info={}),!this._data.version||2>this._data.version)if(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)for(var b in this._data.chars)this._data.chars[b].map=0}});Object.assign(Vh.prototype,{load:function(a,b,c){"string"===typeof a&&(a={load:a,original:a});var d=this;".json"===V.getExtension(a.original)?qa.get(a.load,{retry:this.retryRequests},function(c,g){var e=Uh(g);c?b("Error loading font resource: "+a.original+" ["+
c+"]"):d._loadTextures(a.load.replace(".json",".png"),e,function(a,c){if(a)return b(a);b(null,{data:e,textures:c})})}):(c&&c.data&&(c.data=Uh(c.data)),this._loadTextures(a.load,c&&c.data,b))},_loadTextures:function(a,b,c){var d=b.info.maps.length,e=0,g=null,f=Array(d),l=this._loader;b=function(b){var k=function(a,k){if(!g){if(a)return g=a,c(a);k.upload();f[b]=k;e++;e===d&&c(null,f)}};0===b?l.load(a,"texture",k):l.load(a.replace(".png",b+".png"),"texture",k)};for(var h=0;h<d;h++)b(h)},open:function(a,
b,c){return b.textures?new dg(b.textures,b.data):new dg(b,null)},patch:function(a,b){b=a.resource;!b.data&&a.data?b.data=a.data:!a.data&&b.data&&(a.data=b.data);a.data&&(a.data=Uh(a.data))}});sb.prototype=Object.create(H.prototype);sb.prototype.constructor=sb;sb.prototype.destroy=function(){var a=this;this._registry.off("load",this._onLoad);this._registry.off("error",this._onError);this._waitingAssets.forEach(function(b){a._registry.off("add:"+b,this._onAddAsset)});this.off("progress");this.off("load")};
sb.prototype.load=function(a,b){var c=this._assets.length;this._count=0;this._failed=[];this._callback=a;this._scope=b;this._registry.on("load",this._onLoad,this);this._registry.on("error",this._onError,this);for(a=0;a<c;a++)b=this._assets[a],b.loading||b.loaded||(this._registry.load(b),this._total++)};sb.prototype.ready=function(a,b){b=b||this;if(this._loaded)a.call(b,this._assets);else this.once("load",function(c){a.call(b,c)})};sb.prototype._loadingComplete=function(){this._loaded=!0;this._registry.off("load",
this._onLoad,this);this._registry.off("error",this._onError,this);this._failed&&this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",this._assets))};sb.prototype._onLoad=function(a){var b=this;0<=this._assets.indexOf(a)&&(this._count++,this.fire("progress",a));this._count===this._total&&setTimeout(function(){b._loadingComplete(b._failed)},0)};
sb.prototype._onError=function(a,b){var c=this;0<=this._assets.indexOf(b)&&(this._count++,this._failed.push(b));this._count===this._total&&setTimeout(function(){c._loadingComplete(c._failed)},0)};sb.prototype._onAddAsset=function(a){var b=this._waitingAssets.indexOf(a);0<=b&&this._waitingAssets.splice(b,1);this._assets.push(a);var c=this._assets.length;for(b=0;b<c;b++)a=this._assets[b],a.loading||a.loaded||this._registry.load(a)};sb.prototype._waitForAsset=function(a){this._waitingAssets.push(a);
this._registry.once("add:"+a,this._onAddAsset,this)};var mc={waitForTemplatesInScene:function(a,b,c){if(a.collapsedInstances){var d=mc._getAllCollapsedEntities(a);mc.waitForTemplateAssets(d,b,c,a)}else c(null,a)},waitForTemplateAssets:function(a,b,c,d){a=mc._extractTemplateIds(a);(new sb(a,b)).load(function(a){c(a,d)})},_getAllCollapsedEntities:function(a){var b={};a.collapsedInstances.forEach(function(a){Object.assign(b,a.instanceEntities)});return b},_extractTemplateIds:function(a){var b=[],c;for(c in a){var d=
a[c].template_id;d&&b.push(d)}return b},expandTemplateEntities:function(a,b){var c={},d;for(d in b){var e=b[d];c[d]=e.collapsed_entity?mc.expandEntity(a,e):e}return c},expandEntity:function(a,b){}};Object.assign(eg.prototype,{parse:function(a){var b={},c,d,e=null;a.collapsedInstances&&this._addCollapsedToEntities(this._app,a);for(c in a.entities)b[c]=this._createEntity(a.entities[c]),null===a.entities[c].parent&&(e=b[c]);for(c in a.entities){var g=a.entities[c].children.length;for(d=0;d<g;d++){var f=
a.entities[c].children[d];b[f]&&b[c].addChild(b[f])}}this._openComponentData(e,a.entities);return e},_createEntity:function(a){var b=new S,c=a.position,d=a.rotation,e=a.scale;b.name=a.name;b.setGuid(a.resource_id);b.setLocalPosition(c[0],c[1],c[2]);b.setLocalEulerAngles(d[0],d[1],d[2]);b.setLocalScale(e[0],e[1],e[2]);b._enabled=void 0!==a.enabled?a.enabled:!0;this._isTemplate||(b._enabledInHierarchy=b._enabled);b.template=a.template;if(a.tags)for(c=0;c<a.tags.length;c++)b.tags.add(a.tags[c]);a.labels&&
a.labels.forEach(function(a){b.addLabel(a)});return b},_openComponentData:function(a,b){var c=this._app.systems.list,d,e=c.length,g=b[a.getGuid()];for(d=0;d<e;d++){var f=c[d],l=g.components[f.id];l&&f.addComponent(a,l)}e=g.children.length;c=a._children;for(d=0;d<e;d++)c[d]=this._openComponentData(c[d],b);return a},_addCollapsedToEntities:function(a,b){b.collapsedInstances.forEach(function(c){c=mc.expandTemplateEntities(a,c.instanceEntities);Object.assign(b.entities,c)})}});Object.assign(Wh.prototype,
{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this._app.assets;qa.get(a.load,{retry:this.retryRequests},function(d,e){d?(e="Error while loading scene "+a.original,d.message?(e+=": "+d.message,d.stack&&(e+="\n"+d.stack)):e+=": "+d,b(e)):mc.waitForTemplatesInScene(e,c,b)})},open:function(a,b){this._app.systems.script.preloading=!0;a=(new eg(this._app,!1)).parse(b);this._app.systems.script.preloading=!1;return a}});Object.assign(Xh.prototype,{load:function(a,b){"string"===typeof a&&
(a={load:a,original:a});qa.get(a.load,{retry:this.retryRequests},function(c,d){c?b("Error loading html resource: "+a.original+" ["+c+"]"):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}});Object.assign(Yh.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c={retry:this.retryRequests};a.load.startsWith("blob:")&&(c.responseType=N.ResponseType.JSON);qa.get(a.load,c,function(c,e){c?b("Error loading JSON resource: "+a.original+" ["+c+"]"):b(null,e)})},open:function(a,
b){return b},patch:function(a,b){}});var Fe={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",
diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",
enableGGXSpecular:"boolean",anisotropy:"number",clearCoat:"number",clearCoatGlossiness:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",
glossMapOffset:"vec2",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapUv:"number",
normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",
cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",
prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"},Ge,He=[];for(Ge in Fe){var oj=Fe[Ge];"texture"===oj&&He.push(Ge)}var Tg=[];for(Ge in Fe)oj=Fe[Ge],"cubemap"===oj&&Tg.push(Ge);ec.prototype._bind=function(){if(this.id){if(this._onAssetLoad)this._registry.on("load:"+this.id,this._onLoad,this);if(this._onAssetAdd)this._registry.once("add:"+this.id,this._onAdd,this);if(this._onAssetRemove)this._registry.on("remove:"+
this.id,this._onRemove,this)}if(this.url){if(this._onAssetLoad)this._registry.on("load:url:"+this.url,this._onLoad,this);if(this._onAssetAdd)this._registry.once("add:url:"+this.url,this._onAdd,this);if(this._onAssetRemove)this._registry.on("remove:url:"+this.url,this._onRemove,this)}};ec.prototype._unbind=function(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+
this.id,this._onRemove,this));this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))};ec.prototype._onLoad=function(a){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,a)};ec.prototype._onAdd=function(a){this._onAssetAdd.call(this._scope,this.propertyName,this.parent,a)};ec.prototype._onRemove=function(a){this._onAssetRemove.call(this._scope,
this.propertyName,this.parent,a)};Object.defineProperty(ec.prototype,"id",{get:function(){return this._id},set:function(a){if(this.url)throw Error("Can't set id and url");this._unbind();this._id=a;this.asset=this._registry.get(this._id);this._bind()}});Object.defineProperty(ec.prototype,"url",{get:function(){return this._url},set:function(a){if(this.id)throw Error("Can't set id and url");this._unbind();this._url=a;this.asset=this._registry.getByUrl(this._url);this._bind()}});Xe.prototype.setInvalid=
function(a,b){this.valid=!1;this.removeInvalid&&delete b[a]};Xe.prototype.validate=function(a){var b,c="path"===a.mappingFormat,d;for(d in a)if(b=Fe[d])if(b.startsWith("enum"))b=b.split(":")[1],this.enumValidators[b]&&(this.enumValidators[b](a[d])||this.setInvalid(d,a));else if("number"===b)"number"!==typeof a[d]&&this.setInvalid(d,a);else if("boolean"===b)"boolean"!==typeof a[d]&&this.setInvalid(d,a);else if("string"===b)"string"!==typeof a[d]&&this.setInvalid(d,a);else if("vec2"===b)a[d]instanceof
Array&&2===a[d].length||this.setInvalid(d,a);else if("rgb"===b)a[d]instanceof Array&&3===a[d].length||this.setInvalid(d,a);else if("texture"===b)c?"string"===typeof a[d]||a[null===d]||a[d]instanceof L||this.setInvalid(d,a):"number"!==typeof a[d]&&null!==a[d]&&(a[d]instanceof L||this.setInvalid(d,a));else if("boundingbox"===b)a[d].center&&a[d].center instanceof Array&&3===a[d].center.length||this.setInvalid(d,a),a[d].halfExtents&&a[d].halfExtents instanceof Array&&3===a[d].halfExtents.length||this.setInvalid(d,
a);else if("cubemap"===b)"number"!==typeof a[d]&&null!==a[d]&&void 0!==a[d]&&(a[d]instanceof L&&a[d].cubemap||this.setInvalid(d,a));else if("chunks"===b){var e=Object.keys(a[d]);for(b=0;b<e.length;b++)"string"!==typeof a[d][e[b]]&&this.setInvalid(e[b],a[d])}else console.error("Unknown material type: "+b);else this.valid=!1;a.validated=!0;return this.valid};Xe.prototype._createEnumValidator=function(a){return function(b){return 0<=a.indexOf(b)}};Vd.prototype.parse=function(a){a=this.migrate(a);a=this._validate(a);
var b=new ea;this.initialize(b,a);return b};Vd.prototype.initialize=function(a,b){b.validated||(this._validator||(this._validator=new Xe),this._validator.validate(b));b.chunks&&a.chunks.copy(b.chunks);for(var c in b){var d=Fe[c],e=b[c];"vec2"===d?a[c]=new M(e[0],e[1]):"rgb"===d?a[c]=new J(e[0],e[1],e[2]):"texture"===d?e instanceof L?a[c]=e:a[c]instanceof L&&"number"===typeof e&&0<e||(a[c]=null):"cubemap"===d?e instanceof L?a[c]=e:a[c]instanceof L&&"number"===typeof e&&0<e||(a[c]=null):"boundingbox"===
d?(d=new r(e.center[0],e.center[1],e.center[2]),e=new r(e.halfExtents[0],e.halfExtents[1],e.halfExtents[2]),a[c]=new ia(d,e)):a[c]=b[c]}a.update()};Vd.prototype.migrate=function(a){void 0===a.shadingModel&&(a.shadingModel="blinn"===a.shader?1:0);a.shader&&delete a.shader;a.mapping_format&&(a.mappingFormat=a.mapping_format,delete a.mapping_format);var b,c=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor",
"emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(b=0;b<c.length;b++){var d=c[b][0],e=c[b][1];void 0!==a[d]&&void 0===a[e]&&(a[e]=a[d],delete a[d])}c=
["fresnelFactor","shadowSampleType"];for(b=0;b<c.length;b++)d=c[b],a.hasOwnProperty(d)&&delete a[d];return a};Vd.prototype._validate=function(a){this._validator||(this._validator=new Xe);this._validator.validate(a);return a};var Do={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};Object.assign(Zh.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,
original:a});qa.get(a.load,{retry:this.retryRequests},function(c,d){c?b&&b("Error loading material: "+a.original+" ["+c+"]"):b&&(d._engine=!0,b(null,d))})},open:function(a,b){a=this._parser.parse(b);b._engine&&(a._data=b,delete b._engine);return a},_createPlaceholders:function(){this._placeholderTextures={};var a={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]},b;for(b in a)if(a.hasOwnProperty(b)){this._placeholderTextures[b]=new L(this._device,{width:2,
height:2,format:7});this._placeholderTextures[b].name="placeholder";for(var c=this._placeholderTextures[b].lock(),d=0;4>d;d++)for(var e=0;4>e;e++)c[4*d+e]=a[b][e];this._placeholderTextures[b].unlock()}},patch:function(a,b){a.resource._data&&(a._data=a.resource._data,delete a.resource._data);a.data.name=a.name;a.resource.name=a.name;this._bindAndAssignAssets(a,b);a.off("unload",this._onAssetUnload,this);a.on("unload",this._onAssetUnload,this)},_onAssetUnload:function(a){delete a.data.parameters;delete a.data.chunks;
delete a.data.name},_assignTexture:function(a,b,c){b.data[a]=c;b.resource[a]=c},_assignPlaceholderTexture:function(a,b){this._placeholderTextures||this._createPlaceholders();b.resource[a]=this._placeholderTextures[Do[a]]},_onTextureLoad:function(a,b,c){this._assignTexture(a,b,c.resource);b.resource.update()},_onTextureAdd:function(a,b,c){this._assets.load(c)},_onTextureRemove:function(a,b,c){var d=b.resource;d[a]===c.resource&&(this._assignTexture(a,b,null),d.update())},_assignCubemap:function(a,
b,c){b.data[a]=c[0];7===c.length&&(b.data.prefilteredCubeMap128=c[1],b.data.prefilteredCubeMap64=c[2],b.data.prefilteredCubeMap32=c[3],b.data.prefilteredCubeMap16=c[4],b.data.prefilteredCubeMap8=c[5],b.data.prefilteredCubeMap4=c[6])},_onCubemapLoad:function(a,b,c){this._assignCubemap(a,b,c.resources);this._parser.initialize(b.resource,b.data)},_onCubemapAdd:function(a,b,c){0===b.data.shadingModel&&(b.loadFaces=!0);this._assets.load(c)},_onCubemapRemove:function(a,b,c){var d=b.resource;d[a]===c.resource&&
(this._assignCubemap(a,b,[null,null,null,null,null,null,null]),d.update())},_bindAndAssignAssets:function(a,b){var c=this._parser.migrate(a.data),d=a.resource,e="path"===c.mappingFormat,g;for(g=0;g<He.length;g++){var f=He[g];var l=d._assetReferences[f];!c[f]||c[f]instanceof L?l&&(e?l.url=null:l.id=null):(l||(l=new ec(f,a,b,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemove},this),d._assetReferences[f]=l),e?l.url=a.getAbsoluteUrl(c[f]):l.id=c[f],l.asset&&(l.asset.resource?
this._assignTexture(f,a,l.asset.resource):this._assignPlaceholderTexture(f,a),b.load(l.asset)))}for(g=0;g<Tg.length;g++)f=Tg[g],l=d._assetReferences[f],!c[f]||c[f]instanceof L||(l||(l=new ec(f,a,b,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemove},this),d._assetReferences[f]=l),e?l.url=c[f]:l.id=c[f],l.asset&&(l.asset.resource&&this._assignCubemap(f,a,l.asset.resources),b.load(l.asset)));this._parser.initialize(d,c)}});Object.assign(dk.prototype,{parse:function(a){return(a=
Lc.parse("filename.glb",a,this._device))?Lc.createModel(a,this._defaultMaterial):null}});Object.assign(ek.prototype,{addVertex:function(a,b,c){if(void 0!==this.indexMap[b])c=this.indexMap[b],this.indices.push(c);else{for(var d=0;4>d;d++)0!==c.blendWeight.data[4*b+d]&&(a.boneIndices[d]=this.getBoneRemap(c.blendIndices.data[4*a.index+d]));c=this.vertices.length;this.indices.push(c);this.vertices.push(a);this.indexMap[b]=c}},addPrimitive:function(a,b,c,d){var e,g,f=[],l=0,h=a.length;for(e=0;e<h;e++)for(var p=
a[e].index,n=0;4>n;n++)if(0<c.blendWeight.data[4*p+n]){var m=c.blendIndices.data[4*p+n],q=!0;for(g=0;g<l;g++)if(f[g]==m){q=!1;break}q&&(f[l]=m,g=this.getBoneRemap(m),l+=-1===g?1:0)}if(this.boneIndices.length+l>d)return!1;for(e=0;e<l;e++)this.boneIndices.push(f[e]);for(e=0;e<h;e++)this.addVertex(a[e],b[e],c);return!0},getBoneRemap:function(a){for(var b=0;b<this.boneIndices.length;b++)if(this.boneIndices[b]===a)return b;return-1}});var Eo={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,
trianglefan:6},Fo={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6};Object.assign(gk.prototype,{parse:function(a){var b=a.model;if(!b||1>=b.version)return null;b=this._parseNodes(a);var c=this._parseSkins(a,b),d=this._parseVertexBuffers(a),e=this._parseIndexBuffers(a,d),g=this._parseMorphs(a,b,d);d=this._parseMeshes(a,c.skins,g.morphs,d,e.buffer,e.data);a=this._parseMeshInstances(a,b,d,c.skins,c.instances,g.morphs,g.instances);d=new gb;d.graph=b[0];d.meshInstances=a;d.skinInstances=c.instances;
d.morphInstances=g.instances;d.getGraph().syncHierarchy();return d},_parseNodes:function(a){a=a.model;var b=[],c;for(c=0;c<a.nodes.length;c++){var d=a.nodes[c],e=new Z(d.name);e.setLocalPosition(d.position[0],d.position[1],d.position[2]);e.setLocalEulerAngles(d.rotation[0],d.rotation[1],d.rotation[2]);e.setLocalScale(d.scale[0],d.scale[1],d.scale[2]);e.scaleCompensation=!!d.scaleCompensation;b.push(e)}for(c=1;c<a.parents.length;c++)b[a.parents[c]].addChild(b[c]);return b},_parseSkins:function(a,b){a=
a.model;var c=[],d=[],e;if(!this._device.supportsBoneTextures&&0<a.skins.length){var g=this._device.getBoneLimit();fk(a,null,g)}for(g=0;g<a.skins.length;g++){var f=a.skins[g],l=[];for(e=0;e<f.inverseBindMatrices.length;e++){var h=f.inverseBindMatrices[e];l[e]=(new C).set(h)}f=new Of(this._device,l,f.boneNames);c.push(f);l=new Rd(f);h=[];for(e=0;e<f.boneNames.length;e++){var p=b[0].findByName(f.boneNames[e]);h.push(p)}l.bones=h;d.push(l)}return{skins:c,instances:d}},_getMorphVertexCount:function(a,
b,c){for(var d=0;d<a.meshes.length;d++){var e=a.meshes[d];if(e.morph===b)return c[e.vertices].numVertices}},_parseMorphs:function(a,b,c){a=a.model;b=[];var d=[],e,g;if(a.morphs){var f=function(a,b,c){c=new Float32Array(3*c);for(var d=0;d<b.length;d++){var e=3*b[d];c[e]=a[3*d];c[e+1]=a[3*d+1];c[e+2]=a[3*d+2]}return c};for(e=0;e<a.morphs.length;e++){var l=a.morphs[e].targets;var h=[];var p=this._getMorphVertexCount(a,e,c);for(g=0;g<l.length;g++){var n=l[g].aabb;var m=n.min;n=n.max;m=new ia(new r(.5*
(n[0]+m[0]),.5*(n[1]+m[1]),.5*(n[2]+m[2])),new r(.5*(n[0]-m[0]),.5*(n[1]-m[1]),.5*(n[2]-m[2])));n=l[g].indices;var q=l[g].deltaPositions,u=l[g].deltaNormals;n&&(q=f(q,n,p),u=f(u,n,p));m=new Qe(this._device,{deltaPositions:q,deltaNormals:u,name:l[g].name,aabb:m});h.push(m)}g=new Pe(h);b.push(g);g=new qc(g);d.push(g)}}return{morphs:b,instances:d}},_parseVertexBuffers:function(a){a=a.model;var b=[],c,d={position:"POSITION",normal:"NORMAL",tangent:"TANGENT",blendWeight:"BLENDWEIGHT",blendIndices:"BLENDINDICES",
color:"COLOR",texCoord0:"TEXCOORD0",texCoord1:"TEXCOORD1",texCoord2:"TEXCOORD2",texCoord3:"TEXCOORD3",texCoord4:"TEXCOORD4",texCoord5:"TEXCOORD5",texCoord6:"TEXCOORD6",texCoord7:"TEXCOORD7"},e,g;for(e=0;e<a.vertices.length;e++){var f=a.vertices[e],l=[];for(c in f){var h=f[c];l.push({semantic:d[c],components:h.components,type:Fo[h.type],normalize:"COLOR"===d[c]})}h=new Ka(this._device,l);l=f.position.data.length/f.position.components;var p=new Za(this._device,h,l),n=new Db(p);for(g=0;g<l;g++){for(c in f)switch(h=
f[c],h.components){case 1:n.element[d[c]].set(h.data[g]);break;case 2:n.element[d[c]].set(h.data[2*g],h.data[2*g+1]);break;case 3:n.element[d[c]].set(h.data[3*g],h.data[3*g+1],h.data[3*g+2]);break;case 4:n.element[d[c]].set(h.data[4*g],h.data[4*g+1],h.data[4*g+2],h.data[4*g+3])}n.next()}n.end();b.push(p)}return b},_parseIndexBuffers:function(a,b){var c=a.model,d=a=null,e,g=0;for(e=0;e<c.meshes.length;e++){var f=c.meshes[e];void 0!==f.indices&&(g+=f.indices.length)}for(e=c=0;e<b.length;e++)c=Math.max(c,
b[e].numVertices);0<g&&(65535<c&&this._device.extUintElement?(a=new Rb(this._device,2,g),d=new Uint32Array(a.lock())):(a=new Rb(this._device,1,g),d=new Uint16Array(a.lock())));return{buffer:a,data:d}},_parseMeshes:function(a,b,c,d,e,g){a=a.model;var f=[],l=0,h;for(h=0;h<a.meshes.length;h++){var p=a.meshes[h],n=p.aabb,m=n.min;n=n.max;m=new ia(new r(.5*(n[0]+m[0]),.5*(n[1]+m[1]),.5*(n[2]+m[2])),new r(.5*(n[0]-m[0]),.5*(n[1]-m[1]),.5*(n[2]-m[2])));n=void 0!==p.indices;var q=new fb(this._device);q.vertexBuffer=
d[p.vertices];q.indexBuffer[0]=n?e:null;q.primitive[0].type=Eo[p.type];q.primitive[0].base=n?p.base+l:p.base;q.primitive[0].count=p.count;q.primitive[0].indexed=n;q.skin=void 0!==p.skin?b[p.skin]:null;q.morph=void 0!==p.morph?c[p.morph]:null;q.aabb=m;n&&(g.set(p.indices,l),l+=p.indices.length);f.push(q)}null!==e&&e.unlock();return f},_parseMeshInstances:function(a,b,c,d,e,g,f){a=a.model;var k=[],h;for(h=0;h<a.meshInstances.length;h++){var p=a.meshInstances[h],n=c[p.mesh];p=new ma(b[p.node],n,this._defaultMaterial);
if(n.skin){var m=d.indexOf(n.skin);p.skinInstance=e[m]}n.morph&&(n=g.indexOf(n.morph),p.morphInstance=f[n]);k.push(p)}return k}});Object.assign($h.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c={retry:this.retryRequests};a.load.startsWith("blob:")&&(".glb"===V.getExtension(a.original).toLowerCase()?c.responseType=N.ResponseType.ARRAY_BUFFER:c.responseType=N.ResponseType.JSON);qa.get(a.load,c,function(c,e){b&&(c?b("Error loading model: "+a.original+" ["+c+"]"):b(null,
e))})},open:function(a,b){for(var c=0;c<this._parsers.length;c++){var d=this._parsers[c];if(d.decider(a,b))return d.parser.parse(b)}return null},patch:function(a,b){if(a.resource){var c=a.data,d=this;a.resource.meshInstances.forEach(function(e,g){if(c.mapping){var f=function(a){a.resource?e.material=a.resource:(a.once("load",f),b.load(a));a.once("remove",function(a){e.material===a.resource&&(e.material=d._defaultMaterial)})};if(c.mapping[g]){var l=c.mapping[g].material,h=c.mapping[g].path;if(void 0!==
l)if(l)if(g=b.get(l))f(g);else b.once("add:"+l,f);else e.material=d._defaultMaterial;else if(h)if(l=a.getAbsoluteUrl(c.mapping[g].path),g=b.getByUrl(l))f(g);else b.once("add:url:"+l,f)}else e.material=d._defaultMaterial}})}},addParser:function(a,b){this._parsers.push({parser:a,decider:b})}});Object.assign(ai.prototype,{addHandler:function(a,b){this._handlers[a]=b;b._loader=this},removeHandler:function(a){delete this._handlers[a]},getHandler:function(a){return this._handlers[a]},load:function(a,b,
c,d){var e=this._handlers[b];if(e){var g=a+b;if(void 0!==this._cache[g])c(null,this._cache[g]);else if(this._requests[g])this._requests[g].push(c);else{this._requests[g]=[c];var f=this,l=function(a,b){a?f._onFailure(g,a):e.load(b,function(a,c,h){if(f._requests[g])if(a)f._onFailure(g,a);else try{f._onSuccess(g,e.open(b.original,c,d),h)}catch(t){f._onFailure(g,t)}},d)},h=a.split("?")[0];this._app.enableBundles&&this._app.bundles.hasUrl(h)?this._app.bundles.canLoadUrl(h)?this._app.bundles.loadUrl(h,
function(a,b){l(a,{load:b,original:h})}):l("Bundle for "+a+" not loaded yet"):l(null,{load:a,original:d&&d.getPreferredFile().filename||a})}}else c("No handler for asset type: "+b)},_onSuccess:function(a,b,c){this._cache[a]=b;for(var d=0;d<this._requests[a].length;d++)this._requests[a][d](null,b,c);delete this._requests[a]},_onFailure:function(a,b){console.error(b);if(this._requests[a]){for(var c=0;c<this._requests[a].length;c++)this._requests[a][c](b);delete this._requests[a]}},open:function(a,b){var c=
this._handlers[a];return c?c.open(null,b):(console.warn("No resource handler found for: "+a),b)},patch:function(a,b){var c=this._handlers[a.type];c?c.patch&&c.patch(a,b):console.warn("No resource handler found for: "+a.type)},clearCache:function(a,b){delete this._cache[a+b]},getFromCache:function(a,b){if(this._cache[a+b])return this._cache[a+b]},enableRetry:function(){for(var a in this._handlers)this._handlers[a].retryRequests=!0},disableRetry:function(){for(var a in this._handlers)this._handlers[a].retryRequests=
!1},destroy:function(){this._handlers={};this._requests={};this._cache={}}});Object.assign(bi.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this._app.assets;qa.get(a.load,{retry:this.retryRequests},function(d,e){d?(e="Error while loading scene "+a.original,d.message?(e+=": "+d.message,d.stack&&(e+="\n"+d.stack)):e+=": "+d,b(e)):mc.waitForTemplatesInScene(e,c,b)})},open:function(a,b){this._app.systems.script.preloading=!0;a=(new eg(this._app,!1)).parse(b);var c=this._app.scene;
c.root=a;this._app.applySceneSettings(b.settings);this._app.systems.script.preloading=!1;return c},patch:function(a,b){}});Object.assign(ci.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});qa.get(a.load,{retry:this.retryRequests},function(c,d){c?(d="Error while loading scene settings "+a.original,c.message?(d+=": "+c.message,c.stack&&(d+="\n"+c.stack)):d+=": "+c,b(d)):b(null,d)})},open:function(a,b){return b.settings}});var pj=!1,Ol=!1,ib={app:null,create:function(a,b){if(pj){var c=
b(ib.app);c._pcScriptName=a;hb._push(c);this.fire("created",a,b)}},attribute:function(a,b,c,d){},createLoadingScreen:function(a){if(!Ol){Ol=!0;var b=Y.getApplication();a(b)}}};Object.defineProperty(ib,"legacy",{get:function(){return pj},set:function(a){pj=a}});jf.attach(ib);hb._types=[];hb._push=function(a){ib.legacy&&0<hb._types.length?console.assert("Script Ordering Error. Contact support@playcanvas.com"):hb._types.push(a)};Object.assign(hb.prototype,{load:function(a,b){"string"===typeof a&&(a=
{load:a,original:a});var c=this;ib.app=this._app;this._loadScript(a.load,function(a,e,g){if(a)b(a);else if(ib.legacy)a=null,hb._types.length&&(a=hb._types.pop()),a?this._scripts[e]=a:a=null,b(null,a,g);else{a={};for(var d=0;d<hb._types.length;d++)a[hb._types[d].name]=hb._types[d];hb._types.length=0;b(null,a,g);delete c._loader._cache[e+"script"]}}.bind(this))},open:function(a,b){return b},patch:function(a,b){},_loadScript:function(a,b){var c=document.head,d=document.createElement("script");this._cache[a]=
d;d.async=!1;d.addEventListener("error",function(a){b("Script: "+a.target.src+" failed to load")},!1);var e=!1;d.onload=d.onreadystatechange=function(){e||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(e=!0,b(null,a,d))};d.src=a;c.appendChild(d)}});Object.assign(di.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});qa.get(a.load,{retry:this.retryRequests},function(c,d){c?b("Error loading shader resource: "+a.original+" ["+c+"]"):b(null,d)})},open:function(a,
b){return b},patch:function(a,b){}});var Go=[0,0,1,0,0,1,0,0,1,0,0,1],Ho=[0,1,3,2,3,1];Ma.prototype=Object.create(H.prototype);Ma.prototype.constructor=Ma;Ma.prototype._createMeshes=function(){var a;var b=0;for(a=this._meshes.length;b<a;b++){var c=this._meshes[b];if(c){c.vertexBuffer.destroy();for(var d=0,e=c.indexBuffer.length;d<e;d++)c.indexBuffer[d].destroy()}}a=this._frameKeys.length;this._meshes=Array(a);c=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh;
for(b=0;b<a;b++)d=this._atlas.frames[this._frameKeys[b]],this._meshes[b]=d?c.call(this,d):null;this.fire("set:meshes")};Ma.prototype._createSimpleMesh=function(a){var b=a.rect,c=this._atlas.texture.width,d=this._atlas.texture.height,e=b.z/this._pixelsPerUnit,g=b.w/this._pixelsPerUnit,f=a.pivot.x;a=a.pivot.y;var l=b.x/c,h=b.y/d;c=(b.x+b.z)/c;b=(b.y+b.w)/d;return Eb(this._device,[-f*e,-a*g,0,(1-f)*e,-a*g,0,(1-f)*e,(1-a)*g,0,-f*e,(1-a)*g,0],{uvs:[l,h,c,h,c,b,l,b],normals:Go,indices:Ho})};Ma.prototype._create9SliceMesh=
function(){var a=M.ONE,b,c,d=[],e=[],g=[],f=[],l=0;for(b=0;3>=b;b++){var h=0===b||3===b?0:1;for(c=0;3>=c;c++){var p=-a.x+2*a.x*(1>=b?0:3)/3;var n=-(-a.y+2*a.y*(1>=c?0:3)/3);var m=0===c||3===c?0:1;d.push(-p,0,n);e.push(0,1,0);g.push(h,m);3>b&&3>c&&(f.push(l+3+1,l+1,l),f.push(l+3+1,l+3+2,l+1));l++}}return Eb(this._device,d,{normals:e,uvs:g,indices:f})};Ma.prototype._onSetFrames=function(a){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()};Ma.prototype._onFrameChanged=function(a,b){a=
this._frameKeys.indexOf(a);0>a||(b?0===this.renderMode&&(this._meshes[a]=this._createSimpleMesh(b)):this._meshes[a]=null,this.fire("set:meshes"))};Ma.prototype._onFrameRemoved=function(a){a=this._frameKeys.indexOf(a);0>a||(this._meshes[a]=null,this.fire("set:meshes"))};Ma.prototype.startUpdate=function(){this._updatingProperties=!0;this._meshesDirty=!1};Ma.prototype.endUpdate=function(){this._updatingProperties=!1;this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes();this._meshesDirty=
!1};Ma.prototype.destroy=function(){var a;var b=0;for(a=this._meshes.length;b<a;b++){var c=this._meshes[b];if(c){c.vertexBuffer.destroy();for(var d=0,e=c.indexBuffer.length;d<e;d++)c.indexBuffer[d].destroy()}}this._meshes.length=0};Object.defineProperty(Ma.prototype,"frameKeys",{get:function(){return this._frameKeys},set:function(a){this._frameKeys=a;this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes());this.fire("set:frameKeys",a)}});Object.defineProperty(Ma.prototype,
"atlas",{get:function(){return this._atlas},set:function(a){a!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),(this._atlas=a)&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:
this._createMeshes()),this.fire("set:atlas",a))}});Object.defineProperty(Ma.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(a){this._pixelsPerUnit!==a&&(this._pixelsPerUnit=a,this.fire("set:pixelsPerUnit",a),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}});Object.defineProperty(Ma.prototype,"renderMode",{get:function(){return this._renderMode},set:function(a){if(this._renderMode!==a){var b=
this._renderMode;this._renderMode=a;this.fire("set:renderMode",a);(0===b||0===a)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}});Object.defineProperty(Ma.prototype,"meshes",{get:function(){return this._meshes}});Object.assign(ei.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});".json"===V.getExtension(a.original)&&qa.get(a.load,{retry:this.retryRequests},function(a,d){a?b(a):b(null,d)})},open:function(a,b){var c=new Ma(this._device);
a&&(c.__data=b);return c},patch:function(a,b){var c=a.resource;c.__data&&(a.data.pixelsPerUnit=c.__data.pixelsPerUnit,a.data.renderMode=c.__data.renderMode,a.data.frameKeys=c.__data.frameKeys,c.__data.textureAtlasAsset&&((b=b.getByUrl(c.__data.textureAtlasAsset))?a.data.textureAtlasAsset=b.id:console.warn("Could not find textureatlas with url: "+c.__data.textureAtlasAsset)));c.startUpdate();c.renderMode=a.data.renderMode;c.pixelsPerUnit=a.data.pixelsPerUnit;c.frameKeys=a.data.frameKeys;this._updateAtlas(a);
c.endUpdate();a.off("change",this._onAssetChange,this);a.on("change",this._onAssetChange,this)},_updateAtlas:function(a){var b=a.resource;if(a.data.textureAtlasAsset){this._assets.off("load:"+a.data.textureAtlasAsset,fi,a);this._assets.on("load:"+a.data.textureAtlasAsset,fi,a);var c=this._assets.get(a.data.textureAtlasAsset);c&&c.resource?b.atlas=c.resource:c?this._assets.load(c):(this._assets.off("add:"+a.data.textureAtlasAsset,gi,a),this._assets.on("add:"+a.data.textureAtlasAsset,gi,a))}else b.atlas=
null},_onAssetChange:function(a,b,c,d){"data"===b&&c&&c.textureAtlasAsset&&d&&c.textureAtlasAsset!==d.textureAtlasAsset&&(this._assets.off("load:"+d.textureAtlasAsset,fi,a),this._assets.off("add:"+d.textureAtlasAsset,gi,a))}});Ye.prototype.instantiate=function(){this._templateRoot||this._parseTemplate();return this._templateRoot.clone()};Ye.prototype.getExpandedData=function(){this._expandedData.entities||(this._expandedData.entities=mc.expandTemplateEntities(this._app,this._data.entities));return this._expandedData};
Ye.prototype._parseTemplate=function(){this._templateRoot=(new eg(this._app,!0)).parse(this.getExpandedData())};Object.assign(hi.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this._app.assets;qa.get(a.load,function(d,e){d?b("Error requesting template: "+a.original):mc.waitForTemplateAssets(e.entities,c,b,e)})},open:function(a,b){return new Ye(this._app,b)}});Object.assign(ii.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});qa.get(a.load,
{retry:this.retryRequests},function(c,d){c?b("Error loading text resource: "+a.original+" ["+c+"]"):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}});fc.prototype=Object.create(H.prototype);fc.prototype.constructor=fc;fc.prototype.setFrame=function(a,b){var c=this._frames[a];c?(c.rect.copy(b.rect),c.pivot.copy(b.pivot),c.border.copy(b.border)):(c={rect:b.rect.clone(),pivot:b.pivot.clone(),border:b.border.clone()},this._frames[a]=c);this.fire("set:frame",a.toString(),c)};fc.prototype.removeFrame=
function(a){var b=this._frames[a];b&&(delete this._frames[a],this.fire("remove:frame",a.toString(),b))};fc.prototype.destroy=function(){this._texture&&this._texture.destroy()};Object.defineProperty(fc.prototype,"texture",{get:function(){return this._texture},set:function(a){this._texture=a;this.fire("set:texture",a)}});Object.defineProperty(fc.prototype,"frames",{get:function(){return this._frames},set:function(a){this._frames=a;this.fire("set:frames",a)}});var Ug={repeat:0,clamp:1,mirror:2},Vg={nearest:0,
linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Io=/^data\.frames\.(\d+)$/;Object.assign(ji.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this,d=this._loader.getHandler("texture");if(".json"===V.getExtension(a.original))qa.get(a.load,{retry:this.retryRequests},function(d,g){d?b(d):(d=a.original.replace(".json",".png"),c._loader.load(d,"texture",function(a,c){a?b(a):b(null,{data:g,texture:c})}))});else return d.load(a,
b)},open:function(a,b){var c=new fc;if(b.texture&&b.data)c.texture=b.texture,c.__data=b.data;else{a=this._loader.getHandler("texture").open(a,b);if(!a)return null;c.texture=a}return c},patch:function(a,b){a.resource.__data&&(void 0!==a.resource.__data.minfilter&&(a.data.minfilter=a.resource.__data.minfilter),void 0!==a.resource.__data.magfilter&&(a.data.magfilter=a.resource.__data.magfilter),void 0!==a.resource.__data.addressu&&(a.data.addressu=a.resource.__data.addressu),void 0!==a.resource.__data.addressv&&
(a.data.addressv=a.resource.__data.addressv),void 0!==a.resource.__data.mipmaps&&(a.data.mipmaps=a.resource.__data.mipmaps),void 0!==a.resource.__data.anisotropy&&(a.data.anisotropy=a.resource.__data.anisotropy),void 0!==a.resource.__data.rgbm&&(a.data.rgbm=!!a.resource.__data.rgbm),a.data.frames=a.resource.__data.frames,delete a.resource.__data);if(b=a.resource.texture)if(b.name=a.name,a.data.hasOwnProperty("minfilter")&&b.minFilter!==Vg[a.data.minfilter]&&(b.minFilter=Vg[a.data.minfilter]),a.data.hasOwnProperty("magfilter")&&
b.magFilter!==Vg[a.data.magfilter]&&(b.magFilter=Vg[a.data.magfilter]),a.data.hasOwnProperty("addressu")&&b.addressU!==Ug[a.data.addressu]&&(b.addressU=Ug[a.data.addressu]),a.data.hasOwnProperty("addressv")&&b.addressV!==Ug[a.data.addressv]&&(b.addressV=Ug[a.data.addressv]),a.data.hasOwnProperty("mipmaps")&&b.mipmaps!==a.data.mipmaps&&(b.mipmaps=a.data.mipmaps),a.data.hasOwnProperty("anisotropy")&&b.anisotropy!==a.data.anisotropy&&(b.anisotropy=a.data.anisotropy),a.data.hasOwnProperty("rgbm")){var c=
a.data.rgbm?"rgbm":"default";b.type!==c&&(b.type=c)}a.resource.texture=b;b={};for(var d in a.data.frames)c=a.data.frames[d],b[d]={rect:new U(c.rect),pivot:new M(c.pivot),border:new U(c.border)};a.resource.frames=b;a.off("change",this._onAssetChange,this);a.on("change",this._onAssetChange,this)},_onAssetChange:function(a,b,c){if("data"===b||"data.frames"===b){var d={};for(e in c.frames)b=c.frames[e],d[e]={rect:new U(b.rect),pivot:new M(b.pivot),border:new U(b.border)};a.resource.frames=d}else if(b=
b.match(Io)){var e=b[1];c?(a.resource.frames[e]?(b=a.resource.frames[e],b.rect.set(c.rect[0],c.rect[1],c.rect[2],c.rect[3]),b.pivot.set(c.pivot[0],c.pivot[1]),b.border.set(c.border[0],c.border[1],c.border[2],c.border[3])):a.resource.frames[e]={rect:new U(c.rect),pivot:new M(c.pivot),border:new U(c.border)},a.resource.fire("set:frame",e,a.resource.frames[e])):a.resource.frames[e]&&(delete a.resource.frames[e],a.resource.fire("remove:frame",e))}}});Object.assign(ki.prototype,{load:function(a,b,c){pc.http.get(a.load,
{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},function(d,e){if(d)b(d,e);else{if(d="pvr"===pc.basisTargetFormat()&&c&&c.file&&c.file.variants&&c.file.variants.basis&&0!==(c.file.variants.basis.opt&8))c.file.variants.basis.opt&=-9;pc.basisTranscode(a.load,e,b,{unswizzleGGGR:d})}})},open:function(a,b,c){a=new L(c,{name:a,addressU:b.cubemap?1:0,addressV:b.cubemap?1:0,width:b.width,height:b.height,format:b.format,cubemap:b.cubemap,levels:b.levels});a.upload();return a}});Object.assign(li.prototype,
{load:function(a,b,c){if(c&&c.options&&c.options.hasOwnProperty("crossOrigin"))var d=c.options.crossOrigin;else Ce.test(a.load)&&(d=this.crossOrigin);this._loadImage(a.load,a.original,d,b)},open:function(a,b,c){var d=V.getExtension(a).toLowerCase();a=new L(c,{name:a,width:b.width,height:b.height,format:".jpg"===d||".jpeg"===d?6:7});a.setSource(b);return a},_loadImage:function(a,b,c,d){var e=new Image;c&&(e.crossOrigin=c);var g=0,f,l=this.retryRequests;e.onload=function(){d(null,e)};e.onerror=function(){if(!f)if(l&&
5>=++g){var c=100*Math.pow(2,g);console.log("Error loading Texture from: '"+b+"' - Retrying in "+c+"ms...");var k=0<=a.indexOf("?")?"&":"?";f=setTimeout(function(){e.src=a+k+"retry="+Date.now();f=null},c)}else d("Error loading Texture from: '"+b+"'")};e.src=a}});var qj=[1481919403,3140563232,169478669],Pl={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25};Object.assign(mi.prototype,{load:function(a,b,c){qa.get(a.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},
b)},open:function(a,b,c){b=this.parse(b);if(!b)return null;a=new L(c,{name:a,addressU:b.cubemap?1:0,addressV:b.cubemap?1:0,width:b.width,height:b.height,format:b.format,cubemap:b.cubemap,levels:b.levels});a.upload();return a},parse:function(a){var b=new Uint32Array(a,0,16);if(qj[0]!==b[0]||qj[1]!==b[1]||qj[2]!==b[2])return null;var c=b[6],d=b[7],e=b[9],g=b[10],f=b[12],l=b[13],h=b[14];if(1<b[11]||1<f||0!==c||!Pl[d])return null;b=64+b[15];c=[];f=!1;for(var p=0;p<(h||1);p++){var n=(new Uint32Array(a.slice(b,
b+4)))[0];b+=4;n/=l||1;1<l&&(f=!0,c.push([]));for(var m=0;m<l;m++){var q=new Uint8Array(a,b,n);1<l?c[p].push(q):c.push(q);b+=n}b+=3-(b+3)%4}return{format:Pl[d],width:e,height:g,levels:c,cubemap:f}}});Object.assign(ni.prototype,{load:function(a,b,c){qa.get(a.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},b)},open:function(a,b,c){var d=new Uint32Array(b,0,32),e=d[4],g=d[3],f=Math.max(d[7],1),l=d[21],h=d[22],p=65024===d[28],n=!1,m=!1,q=!1,u=!1,t=!1,r=null;if(4===d[20])if(827611204===
l)r=8,n=!0;else if(894720068===l)r=10,n=!0;else if(116===l)r=14,m=!0;else if(826496069===l)r=21,q=n=!0;else if(825438800===l||825504336===l)r=825438800===l?24:25,u=n=!0;else{if(825439312===l||825504848===l)r=825439312===l?26:27,t=n=!0}else 32===h&&(r=7);if(!r)return a=new L(c,{width:4,height:4,format:6}),a.name="dds-legacy-empty",a;a=new L(c,{name:a,addressU:p?1:0,addressV:p?1:0,width:e,height:g,format:r,cubemap:p});c=128;d=p?6:1;l=827611204===l?8:16;for(h=0;h<d;h++){r=e;for(var w=g,v=0;v<f;v++){if(n)if(q)var x=
Math.floor((r+3)/4)*Math.floor((w+3)/4)*8;else if(u)x=Math.max(r,16)*Math.max(w,8)/4;else if(t)x=Math.max(r,8)*Math.max(w,8)/2;else{x=Math.floor((r+4-1)/4);var z=Math.floor((w+4-1)/4);x*=z;x*=l}else x=r*w*4;z=m?new Float32Array(b,c,x):new Uint8Array(b,c,x);p?(a._levels[v]||(a._levels[v]=[]),a._levels[v][h]=z):a._levels[v]=z;c+=m?4*x:x;r=Math.max(.5*r,1);w=Math.max(.5*w,1)}}a.upload();return a}});var Ql={repeat:0,clamp:1,mirror:2},Rl={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,
linear_mip_linear:5},Jo={"default":"default",rgbm:"rgbm",rgbe:"rgbe",swizzleGGGR:"swizzleGGGR"};Object.assign(hk.prototype,{load:function(a,b,c){throw Error("not implemented");},open:function(a,b,c){throw Error("not implemented");}});var Ko=function(a){var b=Math.log2(Math.max(a._width,a._height))+1,c=function(a){return a instanceof HTMLCanvasElement||a instanceof HTMLImageElement||a instanceof HTMLVideoElement};if(!(7!==a._format&&14!==a._format||a._volume||a._compressed||1===a._levels.length||a._levels.length===
b||c(a._cubemap?a._levels[0][0]:a._levels[0]))){c=function(a,b,c){var d=Math.max(1,a>>1),e=Math.max(1,b>>1),g=new c.constructor(d*e*4),f=Math.floor(a/d);b=Math.floor(b/e);for(var h=f*b,k=0;k<e;++k)for(var l=0;l<d;++l)for(var n=0;4>n;++n){for(var p=0,r=0;r<b;++r)for(var B=0;B<f;++B)p+=c[4*(l*f+B+(k*b+r)*a)+n];g[4*(l+k*d)+n]=p/h}return g};for(var d=a._levels.length;d<b;++d){var e=Math.max(1,a._width>>d-1),g=Math.max(1,a._height>>d-1);if(a._cubemap){for(var f=[],l=0;6>l;++l)f.push(c(e,g,a._levels[d-
1][l]));a._levels.push(f)}else a._levels.push(c(e,g,a._levels[d-1]))}a._levelsUpdated=a._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}};Object.defineProperties(fg.prototype,{crossOrigin:{get:function(){return this.imgParser.crossOrigin},set:function(a){this.imgParser.crossOrigin=a}},retryRequests:{get:function(){return this.imgParser.retryRequests},set:function(a){this.imgParser.retryRequests=a;for(var b in this.parsers)this.parsers.hasOwnProperty(b)&&(this.parsers[b].retryRequests=a)}}});Object.assign(fg.prototype,
{_getUrlWithoutParams:function(a){return 0<=a.indexOf("?")?a.split("?")[0]:a},_getParser:function(a){a=V.getExtension(this._getUrlWithoutParams(a)).toLowerCase().replace(".","");return this.parsers[a]||this.imgParser},load:function(a,b,c){"string"===typeof a&&(a={load:a,original:a});this._getParser(a.original).load(a,b,c)},open:function(a,b,c){if(a)return a=this._getParser(a).open(a,b,this._device),null===a?a=new L(this._device,{width:4,height:4,format:6}):Ko(a),a},patch:function(a,b){if(b=a.resource){a.name&&
0<a.name.length&&(b.name=a.name);var c=a.data;c.hasOwnProperty("minfilter")&&(b.minFilter=Rl[c.minfilter]);c.hasOwnProperty("magfilter")&&(b.magFilter=Rl[c.magfilter]);b.cubemap||(c.hasOwnProperty("addressu")&&(b.addressU=Ql[c.addressu]),c.hasOwnProperty("addressv")&&(b.addressV=Ql[c.addressv]));c.hasOwnProperty("mipmaps")&&(b.mipmaps=c.mipmaps);c.hasOwnProperty("anisotropy")&&(b.anisotropy=c.anisotropy);c.hasOwnProperty("flipY")&&(b.flipY=!!c.flipY);c.hasOwnProperty("type")?b.type=Jo[c.type]:c.hasOwnProperty("rgbm")&&
c.rgbm?b.type="rgbm":a.file&&a.getPreferredFile&&(a=a.getPreferredFile())&&a.opt&&0!==(a.opt&8)&&(b.type="swizzleGGGR")}}});kd.prototype=Object.create(H.prototype);kd.prototype.constructor=kd;Object.assign(kd.prototype,{list:function(a){a=a||{};return this._assets.filter(function(b){var c=!0;void 0!==a.preload&&(c=b.preload===a.preload);return c})},add:function(a){var b=this._assets.push(a)-1;this._cache[a.id]=b;this._names[a.name]||(this._names[a.name]=[]);this._names[a.name].push(b);if(a.file){var c=
a.file.url;this._urls[c]=b}a.registry=this;this._tags.addItem(a);a.tags.on("add",this._onTagAdd,this);a.tags.on("remove",this._onTagRemove,this);this.fire("add",a);this.fire("add:"+a.id,a);c&&this.fire("add:url:"+c,a);a.preload&&this.load(a)},remove:function(a){var b=this._cache[a.id],c=a.file?a.file.url:null;if(void 0!==b){this._assets.splice(b,1);delete this._cache[a.id];this._names={};this._urls=[];b=0;for(var d=this._assets.length;b<d;b++){var e=this._assets[b];this._cache[e.id]=b;this._names[e.name]||
(this._names[e.name]=[]);this._names[e.name].push(b);e.file&&(this._urls[e.file.url]=b)}this._tags.removeItem(a);a.tags.off("add",this._onTagAdd,this);a.tags.off("remove",this._onTagRemove,this);a.fire("remove",a);this.fire("remove",a);this.fire("remove:"+a.id,a);c&&this.fire("remove:url:"+c,a);return!0}return!1},get:function(a){return this._assets[this._cache[a]]},getByUrl:function(a){return this._assets[this._urls[a]]},load:function(a){if(!a.loading){var b=this;if(a.loaded)"cubemap"===a.type&&b._loader.patch(a,
this);else{var c=a.getPreferredFile(),d=!!c,e=function(d){d instanceof Array?a.resources=d:a.resource=d;b._loader.patch(a,b);b.fire("load",a);b.fire("load:"+a.id,a);c&&c.url&&b.fire("load:url:"+c.url,a);a.fire("load",a)},g=function(){var c=a.getFileUrl();a.loading=!0;b._loader.load(c,a.type,function(c,d,g){a.loaded=!0;a.loading=!1;c?(b.fire("error",c,a),b.fire("error:"+a.id,c,a),a.fire("error",c,a)):(ib.legacy||"script"!==a.type||(c=b._loader.getHandler("script"),c._cache[a.id]&&c._cache[a.id].parentNode===
document.head&&document.head.removeChild(c._cache[a.id]),c._cache[a.id]=g),e(d))},a)},f=function(){var c=b._loader.open(a.type,a.data);a.loaded=!0;e(c)};if(c&&"cubemap"===a.type){d=!1;var l=a.getFileUrl();this._loader.load(l,"texture",function(c,d){c?(b.fire("error",c,a),b.fire("error:"+a.id,c,a),a.fire("error",c,a)):(b._loader.patch({resource:d,type:"texture",data:a.data},b),a._dds=d,f())})}c?d&&(this.fire("load:start",a),this.fire("load:"+a.id+":start",a),g()):f()}}},loadFromUrl:function(a,b,c){this.loadFromUrlAndFilename(a,
null,b,c)},loadFromUrlAndFilename:function(a,b,c,d){var e=this,g=V.getBasename(b||a);b={filename:b||g,url:a};a=e.getByUrl(a);a||(a=new X(g,c,b),e.add(a));g=function(a){a.once("load",function(a){d(null,a)});a.once("error",function(a){d(a)});e.load(a)};a.resource?d(null,a):"model"===c?e._loadModel(a,g):g(a)},_loadModel:function(a,b){var c=this,d=a.getFileUrl(),e=V.getExtension(d);if(".json"===e||".glb"===e){var g=V.getDirectory(d);d=V.getBasename(d);e=V.join(g,d.replace(e,".mapping.json"));this._loader.load(e,
"json",function(d,e){d?(a.data={mapping:[]},b(a)):c._loadMaterials(a,e,function(c,d){a.data=e;b(a)})})}else b(a)},_loadMaterials:function(a,b,c){for(var d=this,e=[],g=0,f=function(a,b){d._loadTextures(b,function(a,d){e.push(b);e.length===g&&c(null,e)})},l=0;l<b.mapping.length;l++){var h=b.mapping[l].path;h&&(g++,d.loadFromUrl(a.getAbsoluteUrl(h),"material",f))}0===g&&c(null,e)},_loadTextures:function(a,b){var c=[],d=0,e=a.data;if("path"!==e.mappingFormat)b(null,c);else{for(var g=function(a,e){a&&
console.error(a);c.push(e);c.length===d&&b(null,c)},f=0;f<He.length;f++){var l=e[He[f]];l&&"string"===typeof l&&(d++,this.loadFromUrl(a.getAbsoluteUrl(l),"texture",g))}0===d&&b(null,c)}},findAll:function(a,b){var c=this;return(a=this._names[a])?(a=a.map(function(a){return c._assets[a]}),b?a.filter(function(a){return a.type===b}):a):[]},_onTagAdd:function(a,b){this._tags.add(a,b)},_onTagRemove:function(a,b){this._tags.remove(a,b)},findByTag:function(){return this._tags.find(arguments)},filter:function(a){for(var b=
[],c=0,d=this._assets.length;c<d;c++)a(this._assets[c])&&b.push(this._assets[c]);return b},find:function(a,b){return(a=this.findAll(a,b))?a[0]:null}});Object.assign(oi.prototype,{_onAssetAdded:function(a){if("bundle"===a.type){this._bundleAssets[a.id]=a;this._registerBundleEventListeners(a.id);for(var b=0,c=a.data.assets.length;b<c;b++)this._indexAssetInBundle(a.data.assets[b],a)}else this._assetsInBundles[a.id]&&this._indexAssetFileUrls(a)},_registerBundleEventListeners:function(a){this._assets.on("load:"+
a,this._onBundleLoaded,this);this._assets.on("error:"+a,this._onBundleError,this)},_unregisterBundleEventListeners:function(a){this._assets.off("load:"+a,this._onBundleLoaded,this);this._assets.off("error:"+a,this._onBundleError,this)},_indexAssetInBundle:function(a,b){if(this._assetsInBundles[a]){var c=this._assetsInBundles[a];-1===c.indexOf(b)&&c.push(b)}else this._assetsInBundles[a]=[b];(a=this._assets.get(a))&&this._indexAssetFileUrls(a)},_indexAssetFileUrls:function(a){var b=this._getAssetFileUrls(a);
if(b)for(var c=0,d=b.length;c<d;c++)this._urlsInBundles[b[c]]=this._assetsInBundles[a.id]},_getAssetFileUrls:function(a){var b=a.getFileUrl();if(!b)return null;b=this._normalizeUrl(b);var c=[b];if("font"===a.type){a=a.data.info.maps.length;for(var d=1;d<a;d++)c.push(b.replace(".png",d+".png"))}return c},_normalizeUrl:function(a){return a&&a.split("?")[0]},_onAssetRemoved:function(a){if("bundle"===a.type){delete this._bundleAssets[a.id];this._unregisterBundleEventListeners(a.id);var b;for(b in this._assetsInBundles){var c=
this._assetsInBundles[b];var d=c.indexOf(a);if(-1!==d&&(c.splice(d,1),!c.length)){delete this._assetsInBundles[b];for(var e in this._urlsInBundles)this._urlsInBundles[e]===c&&delete this._urlsInBundles[e]}}this._onBundleError("Bundle "+a.id+" was removed",a)}else if(this._assetsInBundles[a.id])for(delete this._assetsInBundles[a.id],a=this._getAssetFileUrls(a),d=0,b=a.length;d<b;d++)delete this._urlsInBundles[a[d]]},_onBundleLoaded:function(a){a.resource?requestAnimationFrame(function(){if(this._fileRequests)for(var b in this._fileRequests){var c=
this._urlsInBundles[b];if(c&&-1!==c.indexOf(a)){c=decodeURIComponent(b);var d=null;a.resource.hasBlobUrl(c)||(d="Bundle "+a.id+" does not contain URL "+b);for(var e=this._fileRequests[b],g=0,f=e.length;g<f;g++)if(d)e[g](d);else e[g](null,a.resource.getBlobUrl(c));delete this._fileRequests[b]}}}.bind(this)):this._onBundleError("Bundle "+a.id+" failed to load",a)},_onBundleError:function(a,b){for(var c in this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(c)){b=this._fileRequests[c];for(var d=
0,e=b.length;d<e;d++)b[d](a);delete this._fileRequests[c]}},_findLoadedOrLoadingBundleForUrl:function(a){a=this._urlsInBundles[a];if(!a)return null;var b=a.length,c;for(c=0;c<b;c++)if(a[c].loaded&&a[c].resource)return a[c];for(c=0;c<b;c++)if(a[c].loading)return a[c];return null},listBundlesForAsset:function(a){return this._assetsInBundles[a.id]||null},list:function(){var a=[],b;for(b in this._bundleAssets)a.push(this._bundleAssets[b]);return a},hasUrl:function(a){return!!this._urlsInBundles[a]},canLoadUrl:function(a){return!!this._findLoadedOrLoadingBundleForUrl(a)},
loadUrl:function(a,b){var c=this._findLoadedOrLoadingBundleForUrl(a);if(c)if(c.loaded){var d=decodeURIComponent(a);c.resource.hasBlobUrl(d)?b(null,c.resource.getBlobUrl(d)):b("Bundle "+c.id+" does not contain URL "+a)}else this._fileRequests.hasOwnProperty(a)?this._fileRequests[a].push(b):this._fileRequests[a]=[b];else b("URL "+a+" not found in any bundles")},destroy:function(){this._assets.off("add",this._onAssetAdded,this);this._assets.off("remove",this._onAssetRemoved,this);for(var a in this._bundleAssets)this._unregisterBundleEventListeners(a);
this._fileRequests=this._urlsInBundles=this._assetsInBundles=this._bundleAssets=this._assets=null}});Ub.prototype=Object.create(H.prototype);Ub.prototype.constructor=Ub;Ub.prototype.destroy=function(){this.app=null;this.off()};Ub.prototype.add=function(a){var b=this,c=a.__name;if(this._scripts.hasOwnProperty(c))return setTimeout(function(){if(a.prototype.swap){var d=b._list.indexOf(b._scripts[c]);b._list[d]=a;b._scripts[c]=a;b.fire("swap",c,a);b.fire("swap:"+c,a)}else console.warn("script registry already has '"+
c+"' script, define 'swap' method for new script type to enable code hot swapping")}),!1;this._scripts[c]=a;this._list.push(a);this.fire("add",c,a);this.fire("add:"+c,a);setTimeout(function(){if(b._scripts.hasOwnProperty(c)&&b.app&&b.app.systems&&b.app.systems.script){var a=b.app.systems.script._components,e=[],g=[];for(a.loopIndex=0;a.loopIndex<a.length;a.loopIndex++){var f=a.items[a.loopIndex];if(f._scriptsIndex[c]&&f._scriptsIndex[c].awaiting){if(f._scriptsData&&f._scriptsData[c])var l=f._scriptsData[c].attributes;
(f=f.create(c,{preloading:!0,ind:f._scriptsIndex[c].ind,attributes:l}))&&e.push(f)}}for(a=0;a<e.length;a++)e[a].__initializeAttributes();for(a=0;a<e.length;a++)e[a].enabled&&(e[a]._initialized=!0,g.push(e[a]),e[a].initialize&&e[a].initialize());for(a=0;a<g.length;a++)g[a].enabled&&!g[a]._postInitialized&&(g[a]._postInitialized=!0,g[a].postInitialize&&g[a].postInitialize())}});return!0};Ub.prototype.remove=function(a){var b=a;"string"!==typeof a?a=b.__name:b=this.get(a);if(this.get(a)!==b)return!1;
delete this._scripts[a];var c=this._list.indexOf(b);this._list.splice(c,1);this.fire("remove",a,b);this.fire("remove:"+a,b);return!0};Ub.prototype.get=function(a){return this._scripts[a]||null};Ub.prototype.has=function(a){return"string"===typeof a?this._scripts.hasOwnProperty(a):a?this._scripts[a.__name]===a:!1};Ub.prototype.list=function(){return this._list};var mg="KEEP_ASPECT",Bi="FIXED";ld.prototype=Object.create(H.prototype);ld.prototype.constructor=ld;Object.assign(ld.prototype,{destroy:function(){window.removeEventListener("vrdisplaypresentchange",
self._presentChange);this._camera&&(this._camera.vrDisplay=null);this._camera=null},poll:function(){if(this.display){this.display.getFrameData(this._frameData);this.leftProj.data=this._frameData.leftProjectionMatrix;this.rightProj.data=this._frameData.rightProjectionMatrix;var a=this.display.stageParameters;a?(this.sitToStandInv.set(a.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),
this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));var b=this.leftProj.data[3]+this.leftProj.data[0],c=this.leftProj.data[11]+this.leftProj.data[8],d=1/Math.sqrt(b*b+c*c);a=-Math.atan2(c*d,b*d);b=this.rightProj.data[3]+this.rightProj.data[0];c=this.rightProj.data[11]+this.rightProj.data[8];d=1/Math.sqrt(b*b+c*c);a=Math.max(a,-Math.atan2(c*d,b*d));this.combinedFov=a*=2;this.combinedAspect=
b=this.rightProj.data[5]/this.rightProj.data[0];c=this.combinedView;c.copy(this.leftView);c.invert();this.leftViewInv.copy(c);d=this.combinedPos;d.x=this.leftPos.x=c.data[12];d.y=this.leftPos.y=c.data[13];d.z=this.leftPos.z=c.data[14];c.copy(this.rightView);c.invert();this.rightViewInv.copy(c);var e=d.x-c.data[12],g=d.y-c.data[13],f=d.z-c.data[14];e=Math.sqrt(e*e+g*g+f*f);this.rightPos.x=c.data[12];this.rightPos.y=c.data[13];this.rightPos.z=c.data[14];d.x+=c.data[12];d.y+=c.data[13];d.z+=c.data[14];
d.x*=.5;d.y*=.5;d.z*=.5;e=.5*e*Math.sin(Math.PI-(.5*Math.PI+.5*a));g=c.data[9];f=c.data[10];c.data[12]=d.x+c.data[8]*e;c.data[13]=d.y+g*e;c.data[14]=d.z+f*e;this.combinedViewInv.copy(c);c.invert();this.combinedProj.setPerspective(a*O.RAD_TO_DEG,b,this.display.depthNear+e,this.display.depthFar+e,!0)}},requestPresent:function(a){this.display?this.presenting?a&&a(Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then(function(){a&&a()},function(b){a&&
a(b)}):a&&a(Error("No VrDisplay to requestPresent"))},exitPresent:function(a){this.display||a&&a(Error("No VrDisplay to exitPresent"));this.presenting?this.display.exitPresent().then(function(){a&&a()},function(){a&&a(Error("exitPresent failed"))}):a&&a(Error("VrDisplay not presenting"))},requestAnimationFrame:function(a){this.display&&this.display.requestAnimationFrame(a)},submitFrame:function(){this.display&&this.display.submitFrame()},reset:function(){this.display&&this.display.resetPose()},setClipPlanes:function(a,
b){this.display&&(this.display.depthNear=a,this.display.depthFar=b)},getFrameData:function(){if(this.display)return this._frameData}});Object.defineProperty(ld.prototype,"capabilities",{get:function(){return this.display?this.display.capabilities:{}}});Mc.prototype=Object.create(H.prototype);Mc.prototype.constructor=Mc;Mc.isSupported="undefined"!==typeof navigator?!!navigator.getVRDisplays:!1;Object.assign(Mc.prototype,{_attach:function(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect);
window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},_detach:function(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect);window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},destroy:function(){this._detach()},poll:function(){var a=this.displays.length;if(a)for(var b=0;b<a;b++)this.displays[b]._camera&&this.displays[b].poll()},_getDisplays:function(a){navigator.getVRDisplays?navigator.getVRDisplays().then(function(b){a&&a(null,b)}):
a&&a(Error("WebVR not supported"))},_addDisplay:function(a){this._index[a.displayId]||(a=new ld(this._app,a),this._index[a.id]=a,this.displays.push(a),this.display||(this.display=a),this.fire("displayconnect",a))},_onDisplayConnect:function(a){a.detail&&a.detail.display?this._addDisplay(a.detail.display):this._addDisplay(a.display)},_onDisplayDisconnect:function(a){if(a=this._index[a.detail&&a.detail.display?a.detail.display.displayId:a.display.displayId]){a.destroy();delete this._index[a.id];var b=
this.displays.indexOf(a);this.displays.splice(b,1);this.display===a&&(this.display=this.displays.length?this.displays[0]:null);this.fire("displaydisconnect",a)}}});var Sl=[],Tl=[];sc.prototype=Object.create(H.prototype);sc.prototype.constructor=sc;sc.prototype.remove=function(){if(this._xrHitTestSource){var a=this.manager.hitTest.sources,b=a.indexOf(this);-1!==b&&a.splice(b,1);this.onStop()}};sc.prototype.onStop=function(){this._xrHitTestSource.cancel();this._xrHitTestSource=null;this.fire("remove");
this.manager.hitTest.fire("remove",this)};sc.prototype.update=function(a){if(this._transient){a=a.getHitTestResultsForTransientInput(this._xrHitTestSource);for(var b=0;b<a.length;b++){var c=a[b],d;c.inputSource&&(d=this.manager.input._getByInputSource(c.inputSource));this.updateHitResults(c.results,d)}}else this.updateHitResults(a.getHitTestResults(this._xrHitTestSource))};sc.prototype.updateHitResults=function(a,b){for(var c=0;c<a.length;c++){var d=a[c].getPose(this.manager._referenceSpace),e=Sl.pop();
e||(e=new r);e.copy(d.transform.position);var g=Tl.pop();g||(g=new T);g.copy(d.transform.orientation);this.fire("result",e,g,b);this.manager.hitTest.fire("result",this,e,g,b);Sl.push(e);Tl.push(g)}};Gb.prototype=Object.create(H.prototype);Gb.prototype.constructor=Gb;Gb.prototype._onSessionStart=function(){"immersive-ar"===this.manager.type&&(this._session=this.manager.session)};Gb.prototype._onSessionEnd=function(){if(this._session){this._session=null;for(var a=0;a<this.sources.length;a++)this.sources[a].onStop();
this.sources=[]}};Gb.prototype.isAvailable=function(a,b){var c;this._supported||(c=Error("XR HitTest is not supported"));this._session||(c=Error("XR Session is not started (1)"));"immersive-ar"!==this.manager.type&&(c=Error("XR HitTest is available only for AR"));return c?(a&&a(c),b&&b.fire("error",c),!1):!0};Gb.prototype.start=function(a){var b=this;a=a||{};if(this.isAvailable(a.callback,this)){a.profile||a.spaceType||(a.spaceType="viewer");var c,d=a.offsetRay;d&&(c=new XRRay(new DOMPoint(d.origin.x,
d.origin.y,d.origin.z),new DOMPoint(d.direction.x,d.direction.y,d.direction.z)));var e=a.callback;a.spaceType?this._session.requestReferenceSpace(a.spaceType).then(function(d){b._session?b._session.requestHitTestSource({space:d,entityTypes:a.entityTypes||void 0,offsetRay:c}).then(function(a){b._onHitTestSource(a,!1,e)}).catch(function(a){e&&e(a);b.fire("error",a)}):(d=Error("XR Session is not started (2)"),e&&e(d),b.fire("error",d))}).catch(function(a){e&&e(a);b.fire("error",a)}):this._session.requestHitTestSourceForTransientInput({profile:a.profile,
entityTypes:a.entityTypes||void 0,offsetRay:c}).then(function(a){b._onHitTestSource(a,!0,e)}).catch(function(a){e&&e(a);b.fire("error",a)})}};Gb.prototype._onHitTestSource=function(a,b,c){this._session?(a=new sc(this.manager,a,b),this.sources.push(a),c&&c(null,a),this.fire("add",a)):(a.cancel(),a=Error("XR Session is not started (3)"),c&&c(a),this.fire("error",a))};Gb.prototype.update=function(a){for(var b=0;b<this.sources.length;b++)this.sources[b].update(a)};Object.defineProperty(Gb.prototype,"supported",
{get:function(){return this._supported}});var Ul=new T,Ym=0;na.prototype=Object.create(H.prototype);na.prototype.constructor=na;na.prototype.update=function(a){var b=a.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);b&&(this._xrInputSource.gripSpace&&(a=a.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace))&&(this._grip||(this._grip=!0,this._localTransform=new C,this._worldTransform=new C,this._localPosition=new r,this._localRotation=new T),this._dirtyLocal=
!0,this._localPosition.copy(a.transform.position),this._localRotation.copy(a.transform.orientation)),this._dirtyRay=!0,this._rayLocal.origin.copy(b.transform.position),this._rayLocal.direction.set(0,0,-1),Ul.copy(b.transform.orientation),Ul.transformVector(this._rayLocal.direction,this._rayLocal.direction))};na.prototype._updateTransforms=function(){if(this._dirtyLocal){var a=!0;this._dirtyLocal=!1;this._localTransform.setTRS(this._localPosition,this._localRotation,r.ONE)}var b=this._manager.camera.parent;
if(b){if(a=a||b._dirtyLocal||b._dirtyWorld)a=this._manager.camera.parent.getWorldTransform(),this._worldTransform.mul2(a,this._localTransform)}else this._worldTransform.copy(this._localTransform)};na.prototype._updateRayTransforms=function(){var a=this._dirtyRay;this._dirtyRay=!1;var b=this._manager.camera.parent;if(b){if(a=a||b._dirtyLocal||b._dirtyWorld)a=this._manager.camera.parent.getWorldTransform(),a.getTranslation(this._position),this._rotation.setFromMat4(a),this._rotation.transformVector(this._rayLocal.origin,
this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else a&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))};na.prototype.getPosition=function(){if(!this._position)return null;this._updateTransforms();this._worldTransform.getTranslation(this._position);return this._position};na.prototype.getLocalPosition=function(){return this._localPosition};na.prototype.getRotation=function(){if(!this._rotation)return null;
this._updateTransforms();this._rotation.setFromMat4(this._worldTransform);return this._rotation};na.prototype.getLocalRotation=function(){return this._localRotation};na.prototype.getOrigin=function(){this._updateRayTransforms();return this._ray.origin};na.prototype.getDirection=function(){this._updateRayTransforms();return this._ray.direction};na.prototype.hitTestStart=function(a){var b=this;a=a||{};a.profile=this._xrInputSource.profiles[0];var c=a.callback;a.callback=function(a,e){if(e)b.onHitTestSourceAdd(e);
c&&c(a,e)};this._manager.hitTest.start(a)};na.prototype.onHitTestSourceAdd=function(a){this._hitTestSources.push(a);this.fire("hittest:add",a);a.on("result",function(b,c,d){d===this&&this.fire("hittest:result",a,b,c)},this);a.once("remove",function(){this.onHitTestSourceRemove(a);this.fire("hittest:remove",a)},this)};na.prototype.onHitTestSourceRemove=function(a){a=this._hitTestSources.indexOf(a);-1!==a&&this._hitTestSources.splice(a,1)};Object.defineProperty(na.prototype,"id",{get:function(){return this._id}});
Object.defineProperty(na.prototype,"inputSource",{get:function(){return this._xrInputSource}});Object.defineProperty(na.prototype,"targetRayMode",{get:function(){return this._xrInputSource.targetRayMode}});Object.defineProperty(na.prototype,"handedness",{get:function(){return this._xrInputSource.handedness}});Object.defineProperty(na.prototype,"profiles",{get:function(){return this._xrInputSource.profiles}});Object.defineProperty(na.prototype,"grip",{get:function(){return this._grip}});Object.defineProperty(na.prototype,
"gamepad",{get:function(){return this._xrInputSource.gamepad||null}});Object.defineProperty(na.prototype,"selecting",{get:function(){return this._selecting}});Object.defineProperty(na.prototype,"elementInput",{get:function(){return this._elementInput},set:function(a){this._elementInput!==a&&(this._elementInput=a,this._elementInput||(this._elementEntity=null))}});Object.defineProperty(na.prototype,"elementEntity",{get:function(){return this._elementEntity}});Object.defineProperty(na.prototype,"hitTestSources",
{get:function(){return this._hitTestSources}});tb.prototype=Object.create(H.prototype);tb.prototype.constructor=tb;tb.prototype._onSessionStart=function(){this._session=this.manager.session;this._session.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt);var a=this;this._session.addEventListener("select",function(b){var c=a._getByInputSource(b.inputSource);c.update(b.frame);c.fire("select",b);a.fire("select",c,b)});this._session.addEventListener("selectstart",function(b){var c=a._getByInputSource(b.inputSource);
c.update(b.frame);c._selecting=!0;c.fire("selectstart",b);a.fire("selectstart",c,b)});this._session.addEventListener("selectend",function(b){var c=a._getByInputSource(b.inputSource);c.update(b.frame);c._selecting=!1;c.fire("selectend",b);a.fire("selectend",c,b)});for(var b=this._session.inputSources,c=0;c<b.length;c++)this._addInputSource(b[c])};tb.prototype._onSessionEnd=function(){for(var a=this._inputSources.length;a--;){var b=this._inputSources[a];this._inputSources.splice(a,1);b.fire("remove");
this.fire("remove",b)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt);this._session=null};tb.prototype._onInputSourcesChange=function(a){var b;for(b=0;b<a.removed.length;b++)this._removeInputSource(a.removed[b]);for(b=0;b<a.added.length;b++)this._addInputSource(a.added[b])};tb.prototype._getByInputSource=function(a){for(var b=0;b<this._inputSources.length;b++)if(this._inputSources[b].inputSource===a)return this._inputSources[b];return null};tb.prototype._addInputSource=
function(a){this._getByInputSource(a)||(a=new na(this.manager,a),this._inputSources.push(a),this.fire("add",a))};tb.prototype._removeInputSource=function(a){for(var b=0;b<this._inputSources.length;b++)if(this._inputSources[b].inputSource===a){a=this._inputSources[b];this._inputSources.splice(b,1);for(b=a.hitTestSources.length;b--;)a.hitTestSources[b].remove();a.fire("remove");this.fire("remove",a);break}};tb.prototype.update=function(a){for(var b=0;b<this._inputSources.length;b++)this._inputSources[b].update(a)};
Object.defineProperty(tb.prototype,"inputSources",{get:function(){return this._inputSources}});var Ie=new r,Vl=new r,rj=new C,Wl=new C;$a.prototype=Object.create(H.prototype);$a.prototype.constructor=$a;$a.prototype._onSessionStart=function(){this._manager.session.requestLightProbe&&(this._supported=!0)};$a.prototype._onSessionEnd=function(){this._lightProbeRequested=this._available=this._supported=!1;this._lightProbe=null};$a.prototype.start=function(){var a;this._manager.session||(a=Error("XR session is not running"));
a||"immersive-ar"===this._manager.type||(a=Error("XR session type is not AR"));a||this._supported||(a=Error("light-estimation is not supported"));if(!a&&this._lightProbe||this._lightProbeRequested)a=Error("light estimation is already requested");if(a)this.fire("error",a);else{var b=this;this._lightProbeRequested=!0;this._manager.session.requestLightProbe().then(function(a){var c=b._lightProbeRequested;b._lightProbeRequested=!1;b._manager.active?c&&(b._lightProbe=a):b.fire("error",Error("XR session is not active"))}).catch(function(a){b._lightProbeRequested=
!1;b.fire("error",a)})}};$a.prototype.end=function(){this._lightProbeRequested=!1;this._lightProbe=null;this._available=!1};$a.prototype.update=function(a){if(this._lightProbe&&(a=a.getLightEstimate(this._lightProbe))){this._available||(this._available=!0,this.fire("available"));var b=a.primaryLightIntensity;this._intensity=Math.max(1,Math.max(b.x,Math.max(b.y,b.z)));Ie.copy(b).scale(1/this._intensity);this._color.set(Ie.x,Ie.y,Ie.z);Ie.set(0,0,0);Vl.copy(a.primaryLightDirection);rj.setLookAt(Vl,
Ie,r.UP);Wl.setFromAxisAngle(r.RIGHT,90);rj.mul(Wl);this._rotation.setFromMat4(rj);this._sphericalHarmonics.set(a.sphericalHarmonicsCoefficients)}};Object.defineProperty($a.prototype,"supported",{get:function(){return this._supported}});Object.defineProperty($a.prototype,"available",{get:function(){return!!this._available}});Object.defineProperty($a.prototype,"intensity",{get:function(){return this._available?this._intensity:null}});Object.defineProperty($a.prototype,"color",{get:function(){return this._available?
this._color:null}});Object.defineProperty($a.prototype,"rotation",{get:function(){return this._available?this._rotation:null}});Object.defineProperty($a.prototype,"sphericalHarmonics",{get:function(){return this._available?this._sphericalHarmonics:null}});Ia.prototype=Object.create(H.prototype);Ia.prototype.constructor=Ia;Ia.prototype.start=function(a,b,c,d){if(this._available[b])if(this._session)d&&d(Error("XR session is already started"));else{var e=this;this._camera=a;this._camera.camera.xr=this;
this._type=b;this._spaceType=c;this._setClipPlanes(a.nearClip,a.farClip);a=[];"immersive-ar"===b&&a.push("light-estimation");navigator.xr.requestSession(b,{requiredFeatures:[c],optionalFeatures:a}).then(function(a){e._onSessionStart(a,c,d)}).catch(function(a){e._camera.camera.xr=null;e._camera=null;e._type=null;e._spaceType=null;d&&d(a);e.fire("error",a)})}else d&&d(Error("XR is not available"))};Ia.prototype.end=function(a){if(this._session){if(a)this.once("end",a);this._session.end()}else a&&a(Error("XR Session is not initialized"))};
Ia.prototype.isAvailable=function(a){return this._available[a]};Ia.prototype._deviceAvailabilityCheck=function(){for(var a in this._available)this._sessionSupportCheck(a)};Ia.prototype._sessionSupportCheck=function(a){var b=this;navigator.xr.isSessionSupported(a).then(function(c){b._available[a]!==c&&(b._available[a]=c,b.fire("available",a,c),b.fire("available:"+a,c))}).catch(function(a){b.fire("error",a)})};Ia.prototype._onSessionStart=function(a,b,c){var d=this,e=!1;this._session=a;var g=function(){d.fire("visibility:change",
a.visibilityState)},f=function(){d._setClipPlanes(d._camera.nearClip,d._camera.farClip)},l=function(){d._session=null;d._referenceSpace=null;d.views=[];d._width=0;d._height=0;d._type=null;d._spaceType=null;d._camera&&(d._camera.off("set_nearClip",f),d._camera.off("set_farClip",f),d._camera.camera.xr=null,d._camera=null);a.removeEventListener("end",l);a.removeEventListener("visibilitychange",g);e||d.fire("end");d.app.tick()};a.addEventListener("end",l);a.addEventListener("visibilitychange",g);this._camera.on("set_nearClip",
f);this._camera.on("set_farClip",f);this._baseLayer=new XRWebGLLayer(a,this.app.graphicsDevice.gl);a.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar});a.requestReferenceSpace(b).then(function(a){d._referenceSpace=a;d.app.tick();c&&c(null);d.fire("start")}).catch(function(b){e=!0;a.end();c&&c(b);d.fire("error",b)})};Ia.prototype._setClipPlanes=function(a,b){if(this._depthNear!==a||this._depthFar!==b)this._depthNear=a,this._depthFar=b,this._session&&this._session.updateRenderState({depthNear:this._depthNear,
depthFar:this._depthFar})};Ia.prototype.update=function(a){if(this._session){var b,c=a.session.renderState.baseLayer.framebufferWidth;var d=a.session.renderState.baseLayer.framebufferHeight;if(this._width!==c||this._height!==d)this._width=c,this._height=d,this.app.graphicsDevice.setResolution(c,d);var e=(c=a.getViewerPose(this._referenceSpace))?c.views.length:0;if(e>this.views.length)for(d=0;d<=e-this.views.length;d++)(b=this.viewsPool.pop())||(b={viewport:new U,projMat:new C,viewMat:new C,viewOffMat:new C,
viewInvMat:new C,viewInvOffMat:new C,projViewOffMat:new C,viewMat3:new Cb,position:new Float32Array(3),rotation:new T}),this.views.push(b);else if(e<=this.views.length)for(d=0;d<this.views.length-e;d++)this.viewsPool.push(this.views.pop());if(c){d=c.transform.position;b=c.transform.orientation;this._localPosition.set(d.x,d.y,d.z);this._localRotation.set(b.x,b.y,b.z,b.w);var g=a.session.renderState.baseLayer;for(d=0;d<c.views.length;d++){e=c.views[d];b=this.views[d];var f=g.getViewport(e);b.viewport.x=
f.x;b.viewport.y=f.y;b.viewport.z=f.width;b.viewport.w=f.height;b.projMat.set(e.projectionMatrix);b.viewMat.set(e.transform.inverse.matrix);b.viewInvMat.set(e.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition);this._camera.camera._node.setLocalRotation(this._localRotation);this.input.update(a);"immersive-ar"===this._type&&(this.hitTest.supported&&this.hitTest.update(a),this.lightEstimation.supported&&this.lightEstimation.update(a));this.fire("update")}};Object.defineProperty(Ia.prototype,
"supported",{get:function(){return this._supported}});Object.defineProperty(Ia.prototype,"active",{get:function(){return!!this._session}});Object.defineProperty(Ia.prototype,"type",{get:function(){return this._type}});Object.defineProperty(Ia.prototype,"spaceType",{get:function(){return this._spaceType}});Object.defineProperty(Ia.prototype,"session",{get:function(){return this._session}});Object.defineProperty(Ia.prototype,"visibilityState",{get:function(){return this._session?this._session.visibilityState:
null}});Object.defineProperty(Ia.prototype,"camera",{get:function(){return this._camera?this._camera.entity:null}});G.prototype=Object.create(H.prototype);G.prototype.constructor=G;G._buildAccessors=function(a,b){b.forEach(function(b){var c="object"===typeof b?b.name:b;Object.defineProperty(a,c,{get:function(){return this.data[c]},set:function(a){var b=this.data,d=b[c];b[c]=a;this.fire("set",c,d,a)},configurable:!0})});a._accessorsBuilt=!0};Object.assign(G.prototype,{buildAccessors:function(a){G._buildAccessors(this,
a)},onSetEnabled:function(a,b,c){if(b!==c&&this.entity.enabled)if(c)this.onEnable();else this.onDisable()},onEnable:function(){},onDisable:function(){},onPostStateChange:function(){}});Object.defineProperty(G.prototype,"data",{get:function(){var a=this.system.store[this.entity.getGuid()];return a?a.data:null}});B.prototype=Object.create(H.prototype);B.prototype.constructor=B;Object.assign(B,{_helper:function(a,b){for(var c=0,d=a.length;c<d;c++)a[c].f.call(a[c].s,b)},initialize:function(a){this._helper(this._init,
a)},postInitialize:function(a){this._helper(this._postInit,a);this.fire("postinitialize",a)},update:function(a,b){this._helper(b?this._toolsUpdate:this._update,a)},animationUpdate:function(a,b){this._helper(this._animationUpdate,a)},fixedUpdate:function(a,b){this._helper(this._fixedUpdate,a)},postUpdate:function(a,b){this._helper(this._postUpdate,a)},_init:[],_postInit:[],_toolsUpdate:[],_update:[],_animationUpdate:[],_fixedUpdate:[],_postUpdate:[],bind:function(a,b,c){switch(a){case "initialize":this._init.push({f:b,
s:c});break;case "postInitialize":this._postInit.push({f:b,s:c});break;case "update":this._update.push({f:b,s:c});break;case "animationUpdate":this._animationUpdate.push({f:b,s:c});break;case "postUpdate":this._postUpdate.push({f:b,s:c});break;case "fixedUpdate":this._fixedUpdate.push({f:b,s:c});break;case "toolsUpdate":this._toolsUpdate.push({f:b,s:c});break;default:console.error("Component System does not support event",a)}},_erase:function(a,b,c){for(var d=0;d<a.length;d++)a[d].f===b&&a[d].s===
c&&a.splice(d--,1)},unbind:function(a,b,c){switch(a){case "initialize":this._erase(this._init,b,c);break;case "postInitialize":this._erase(this._postInit,b,c);break;case "update":this._erase(this._update,b,c);break;case "animationUpdate":this._erase(this._animationUpdate,b,c);break;case "postUpdate":this._erase(this._postUpdate,b,c);break;case "fixedUpdate":this._erase(this._fixedUpdate,b,c);break;case "toolsUpdate":this._erase(this._toolsUpdate,b,c);break;default:console.error("Component System does not support event",
a)}}});Object.assign(B.prototype,{addComponent:function(a,b){var c=new this.ComponentType(this,a),d=new this.DataType;b=b||{};this.store[a.getGuid()]={entity:a,data:d};a[this.id]=c;a.c[this.id]=c;this.initializeComponentData(c,b,[]);this.fire("add",a,c);return c},removeComponent:function(a){var b=this.store[a.getGuid()];this.fire("beforeremove",a,a.c[this.id]);delete this.store[a.getGuid()];delete a[this.id];delete a.c[this.id];this.fire("remove",a,b.data)},cloneComponent:function(a,b){a=this.store[a.getGuid()];
return this.addComponent(b,a.data)},initializeComponentData:function(a,b,c){b=b||{};for(var d,e,g,f=0,l=c.length;f<l;f++)d=c[f],"object"===typeof d?(e=d.name,d=d.type):(e=d,d=void 0),g=b[e],void 0!==g?(void 0!==d&&(g=Zm(g,d)),a[e]=g):a[e]=a.data[e];if(a.enabled&&a.entity.enabled)a.onEnable()},getPropertiesOfType:function(a){var b=[];(this.schema||[]).forEach(function(c){c&&"object"===typeof c&&c.type===a&&b.push(c)});return b},destroy:function(){this.off()}});jf.attach(B);B.destroy=function(){B.off("initialize");
B.off("postInitialize");B.off("toolsUpdate");B.off("update");B.off("animationUpdate");B.off("fixedUpdate");B.off("postUpdate")};Object.assign(ik.prototype,{getTarget:function(){return this._targetNode},setTarget:function(a){this._targetNode=a}});Na.prototype.addTime=function(a){if(null!==this._animation){var b=this._animation._nodes;var c=this._animation.duration;if(this._time!==c||this.looping){this._time+=a;if(this._time>c)for(this._time=this.looping?0:c,c=0;c<b.length;c++){var d=b[c];var e=d._name;
this._currKeyIndices[e]=0}else if(0>this._time)for(this._time=this.looping?c:0,c=0;c<b.length;c++)d=b[c],e=d._name,this._currKeyIndices[e]=d._keys.length-2;a=0<=a?1:-1;for(c=0;c<b.length;c++){d=b[c];e=d._name;d=d._keys;var g=this._interpolatedKeyDict[e];if(void 0!==g){var f=!1;if(1!==d.length)for(var l=this._currKeyIndices[e];l<d.length-1&&0<=l;l+=a){var h=d[l];var p=d[l+1];if(h.time<=this._time&&p.time>=this._time){f=(this._time-h.time)/(p.time-h.time);g._pos.lerp(h.position,p.position,f);g._quat.slerp(h.rotation,
p.rotation,f);g._scale.lerp(h.scale,p.scale,f);g._written=!0;this._currKeyIndices[e]=l;f=!0;break}}if(1===d.length||!f&&0===this._time&&this.looping)g._pos.copy(d[0].position),g._quat.copy(d[0].rotation),g._scale.copy(d[0].scale),g._written=!0}}}}};Na.prototype.blend=function(a,b,c){for(var d=this._interpolatedKeys.length,e=0;e<d;e++){var g=a._interpolatedKeys[e],f=b._interpolatedKeys[e],l=this._interpolatedKeys[e];g._written&&f._written?(l._quat.slerp(g._quat,b._interpolatedKeys[e]._quat,c),l._pos.lerp(g._pos,
b._interpolatedKeys[e]._pos,c),l._scale.lerp(g._scale,f._scale,c),l._written=!0):g._written?(l._quat.copy(g._quat),l._pos.copy(g._pos),l._scale.copy(g._scale),l._written=!0):f._written&&(l._quat.copy(f._quat),l._pos.copy(f._pos),l._scale.copy(f._scale),l._written=!0)}};Object.defineProperty(Na.prototype,"animation",{get:function(){return this._animation},set:function(a){this._animation=a;this.currentTime=0}});Na.prototype.getAnimation=function(){return this._animation};Object.defineProperty(Na.prototype,
"currentTime",{get:function(){return this._time},set:function(a){this._time=a;a=this._interpolatedKeys.length;for(var b=0;b<a;b++)this._currKeyIndices[this._interpolatedKeys[b]._name]=0;this.addTime(0);this.updateGraph()}});Na.prototype.getCurrentTime=function(){return this._time};Na.prototype.setCurrentTime=function(a){this.currentTime=a};Object.defineProperty(Na.prototype,"numNodes",{get:function(){return this._interpolatedKeys.length}});Na.prototype.getNumNodes=function(){return this._interpolatedKeys.length};
Na.prototype.setAnimation=function(a){this.animation=a};Na.prototype.setGraph=function(a){var b;if(this.graph=a)for(b=0;b<this._interpolatedKeys.length;b++){var c=a.findByName(this._interpolatedKeys[b]._name);this._interpolatedKeys[b].setTarget(c)}else for(b=0;b<this._interpolatedKeys.length;b++)this._interpolatedKeys[b].setTarget(null)};Na.prototype.updateGraph=function(){if(this.graph)for(var a=0;a<this._interpolatedKeys.length;a++){var b=this._interpolatedKeys[a];if(b._written){var c=b.getTarget();
c.localPosition.copy(b._pos);c.localRotation.copy(b._quat);c.localScale.copy(b._scale);c._dirtyLocal||c._dirtifyLocal();b._written=!1}}};Na.prototype.setLooping=function(a){this.looping=a};Na.prototype.getLooping=function(){return this.looping};Nc.prototype=Object.create(G.prototype);Nc.prototype.constructor=Nc;Object.assign(Nc.prototype,{play:function(a,b){if(this.enabled&&this.entity.enabled){var c=this.data;if(c.animations[a]){b=b||0;c.prevAnim=c.currAnim;c.currAnim=a;if(c.model){c.skeleton||c.animEvaluator||
this._createAnimationController();a=c.animations[c.prevAnim];var d=c.animations[c.currAnim];c.blending=0<b&&c.prevAnim;c.blending&&(c.blend=0,c.blendSpeed=1/b);c.skeleton&&(c.blending?(c.fromSkel.animation=a,c.fromSkel.addTime(c.skeleton._time),c.toSkel.animation=d):c.skeleton.animation=d);if(c.animEvaluator){b=c.animEvaluator;if(c.blending)for(;1<b.clips.length;)b.removeClip(0);else c.animEvaluator.removeClips();b=new Se(c.animations[c.currAnim],0,1,!0,c.loop);b.name=c.currAnim;b.blendWeight=c.blending?
0:1;b.reset();c.animEvaluator.addClip(b)}}c.playing=!0}}},getAnimation:function(a){return this.data.animations[a]},setModel:function(a){var b=this.data;a!==b.model&&(this._resetAnimationController(),b.model=a,b.animations&&b.currAnim&&b.animations[b.currAnim]&&this.play(b.currAnim))},_resetAnimationController:function(){var a=this.data;a.skeleton=null;a.fromSkel=null;a.toSkel=null;a.animEvaluator=null},_createAnimationController:function(){var a=this.data,b=a.model,c=a.animations,d=!1,e=!1,g;for(g in c)c.hasOwnProperty(g)&&
(c[g].constructor===Ud?e=!0:d=!0);b=b.getGraph();d?(a.fromSkel=new Na(b),a.toSkel=new Na(b),a.skeleton=new Na(b),a.skeleton.looping=a.loop,a.skeleton.setGraph(b)):e&&(a.animEvaluator=new Ba(new Te(b)))},loadAnimationAssets:function(a){if(a&&a.length){var b=this,c=this.system.app.assets,d,e=a.length,g=function(a){if(1<a.resources.length)for(var c=0;c<a.resources.length;c++)b.animations[a.resources[c].name]=a.resources[c],b.animationsIndex[a.id]=a.resources[c].name;else b.animations[a.name]=a.resource,
b.animationsIndex[a.id]=a.name;b.animations=b.animations},f=function(a){a.off("change",b.onAssetChanged,b);a.on("change",b.onAssetChanged,b);a.off("remove",b.onAssetRemoved,b);a.on("remove",b.onAssetRemoved,b);a.resource?g(a):(a.once("load",g,b),b.enabled&&b.entity.enabled&&c.load(a))};for(d=0;d<e;d++){var l=c.get(a[d]);if(l)f(l);else c.on("add:"+a[d],f)}}},onAssetChanged:function(a,b,c,d){if("resource"===b||"resources"===b)if(c){if(1<c.length){if(d&&1<d.length)for(b=0;b<d.length;b++)delete this.animations[d[b].name];
else delete this.animations[a.name];d=!1;for(b=0;b<c.length;b++)this.animations[c[b].name]=c[b],!d&&this.data.currAnim===c[b].name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(d=!0,this.play(c[b].name,0))}else{if(d&&1<d.length)for(b=0;b<d.length;b++)delete this.animations[d[b].name];this.animations[a.name]=c[0]||c;d=!1;this.data.currAnim===a.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(d=!0,this.play(a.name,0))}d||(this._stopCurrentAnimation(),this.onSetAnimations());
this.animationsIndex[a.id]=a.name}else{if(1<d.length)for(b=0;b<d.length;b++)delete this.animations[d[b].name];else delete this.animations[a.name];delete this.animationsIndex[a.id]}},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);if(this.animations){if(1<a.resources.length)for(var b=0;b<a.resources.length;b++)delete this.animations[a.resources[b].name],this.data.currAnim===a.resources[b].name&&this._stopCurrentAnimation();else delete this.animations[a.name],this.data.currAnim===
a.name&&this._stopCurrentAnimation();delete this.animationsIndex[a.id]}},_stopCurrentAnimation:function(){var a=this.data;a.currAnim=null;a.playing=!1;a.skeleton&&(a.skeleton.currentTime=0,a.skeleton.animation=null);a.animEvaluator&&a.animEvaluator.removeClips()},onSetAnimations:function(a,b,c){a=this.data;(b=this.entity.model)&&(b=b.model)&&b!==a.model&&this.setModel(b);if(!a.currAnim&&a.activate&&a.enabled&&this.entity.enabled)for(var d in a.animations){this.play(d,0);break}},onSetAssets:function(a,
b,c){if(b&&b.length)for(a=0;a<b.length;a++)if(b[a]){var d=this.system.app.assets.get(b[a]);if(d){d.off("change",this.onAssetChanged,this);d.off("remove",this.onAssetRemoved,this);var e=this.animationsIndex[d.id];this.data.currAnim===e&&this._stopCurrentAnimation();delete this.animations[e];delete this.animationsIndex[d.id]}}b=c.map(function(a){return a instanceof X?a.id:a});this.loadAnimationAssets(b)},onSetLoop:function(a,b,c){a=this.data;a.skeleton&&(a.skeleton.looping=a.loop);if(a.animEvaluator)for(b=
0;b<a.animEvaluator.clips.length;++b)a.animEvaluator.clips[b].loop=a.loop},onSetCurrentTime:function(a,b,c){a=this.data;a.skeleton&&(b=a.skeleton,b.currentTime=c,b.addTime(0),b.updateGraph());if(a.animEvaluator)for(a=a.animEvaluator,b=0;b<a.clips.length;++b)a.clips[b].time=c},onEnable:function(){G.prototype.onEnable.call(this);var a=this.data,b=a.assets,c=this.system.app.assets;if(b)for(var d=0,e=b.length;d<e;d++){var g=b[d];g instanceof X||(g=c.get(g));g&&!g.resource&&c.load(g)}if(a.activate&&!a.currAnim)for(var f in a.animations){this.play(f,
0);break}},onBeforeRemove:function(){for(var a=0;a<this.assets.length;a++){var b=this.system.app.assets.get(this.assets[a]);b&&(b.off("change",this.onAssetChanged,this),b.off("remove",this.onAssetRemoved,this))}a=this.data;delete a.animation;delete a.skeleton;delete a.fromSkel;delete a.toSkel;delete a.animEvaluator}});Object.defineProperties(Nc.prototype,{currentTime:{get:function(){return this.data.skeleton._time},set:function(a){var b=this.data;if(b.skeleton){var c=b.skeleton;c.currentTime=a;c.addTime(0);
c.updateGraph()}if(b.animEvaluator)for(b=b.animEvaluator,c=0;c<b.clips.length;++c)b.clips[c].time=a}},duration:{get:function(){return this.data.animations[this.data.currAnim].duration}}});var jk="enabled assets speed loop activate animations skeleton model prevAnim currAnim fromSkel toSkel blending blendTimeRemaining playing".split(" ");Wd.prototype=Object.create(B.prototype);Wd.prototype.constructor=Wd;G._buildAccessors(Nc.prototype,jk);Object.assign(Wd.prototype,{initializeComponentData:function(a,
b,c){c=["activate","enabled","loop","speed","assets"];B.prototype.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){var c;this.addComponent(b,{});b.animation.assets=a.animation.assets.slice();b.animation.data.speed=a.animation.speed;b.animation.data.loop=a.animation.loop;b.animation.data.activate=a.animation.activate;b.animation.data.enabled=a.animation.enabled;var d={},e=a.animation.animations;for(c in e)e.hasOwnProperty(c)&&(d[c]=e[c]);b.animation.animations=d;d={};a=a.animation.animationsIndex;
for(c in a)a.hasOwnProperty(c)&&(d[c]=a[c]);b.animation.animationsIndex=d},onBeforeRemove:function(a,b){b.onBeforeRemove()},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c],e=d.data;if(e.enabled&&d.entity.enabled){e.blending&&(e.blend+=a*e.blendSpeed,1<=e.blend&&(e.blend=1));e.playing&&(d=e.skeleton,null!==d&&null!==e.model&&(e.blending?d.blend(e.fromSkel,e.toSkel,e.blend):(d.addTime(a*e.speed),0<e.speed&&d._time===d._animation.duration&&!e.loop?e.playing=!1:0>
e.speed&&0===d._time&&!e.loop&&(e.playing=!1)),e.blending&&1===e.blend&&(d.animation=e.toSkel._animation),d.updateGraph()));if(d=e.animEvaluator){for(var g=0;g<d.clips.length;++g){var f=d.clips[g];f.speed=e.speed;e.playing?f.resume():f.pause()}e.blending&&(d.clips[1].blendWeight=e.blend);d.update(a)}e.blending&&1===e.blend&&(e.blending=!1)}}}});Ze.prototype=Object.create(Te.prototype);Ze.prototype.constructor=Ze;Object.assign(Ze.prototype,{resolve:function(a){var b=this.propertyLocator.decode(a);
a=b[0];var c=b[1];b=b[2];var d=this._getEntityFromHierarchy(a);if(!d)return null;switch(c){case "entity":a=d;break;case "graph":a=this.nodes[a[0]].node;break;default:if(a=d.findComponent(c),!a)return null}return this._createAnimTargetForProperty(a,b)},update:function(a){if(a=this.activeNodes)for(var b=0;b<a.length;++b)a[b]._dirtifyLocal()},_getEntityFromHierarchy:function(a){if(!this.animComponent.entity.name===a[0])return null;var b=this.animComponent.entity;return 1===a.length?b:b._parent.findByPath(a.join("/"))},
_floatSetter:function(a,b){return function(c){this._setProperty(a,b,c[0])}.bind(this)},_booleanSetter:function(a,b){return function(c){this._setProperty(a,b,!!c[0])}.bind(this)},_colorSetter:function(a,b){var c=["r","g","b","a"];return function(d){for(var e=0;e<d.length;e++)this._setProperty(a,b.concat(c[e]),d[e])}.bind(this)},_vecSetter:function(a,b){var c=["x","y","z","w"];return function(d){for(var e=0;e<d.length;e++)this._setProperty(a,b.concat(c[e]),d[e])}.bind(this)},_getProperty:function(a,
b){return 1===b.length?a[b[0]]:a[b[0]][b[1]]},_setProperty:function(a,b,c){if(1===b.length)a[b[0]]=c;else{var d=a[b[0]];d[b[1]]=c;a[b[0]]=d}},_getEntityProperty:function(a){for(var b="localScale localPosition localRotation localEulerAngles position rotation eulerAngles".split(" "),c,d=0;d<b.length;d++)-1!==a.indexOf(b[d])&&(c=b[d]);return c},_createAnimTargetForProperty:function(a,b){if(this.handlers&&"weights"===b[0])return this.handlers.weights(a);var c=this._getProperty(a,b);if("undefined"===typeof c)return null;
if("number"===typeof c){var d=this._floatSetter(a,b);var e="vector";var g=1}else if("boolean"===typeof c)d=this._booleanSetter(a,b),e="vector",g=1;else if("object"===typeof c)switch(c.constructor){case M:d=this._vecSetter(a,b);e="vector";g=2;break;case r:d=this._vecSetter(a,b);e="vector";g=3;break;case U:d=this._vecSetter(a,b);e="vector";g=4;break;case J:d=this._colorSetter(a,b);e="vector";g=4;break;case T:d=this._vecSetter(a,b);e="quaternion";g=4;break;default:return null}var f=this._getEntityProperty(b);
return f?new rc(function(b){d(b);b="set"+f.substring(0,1).toUpperCase()+f.substring(1);a[b](this._getProperty(a,[f]))}.bind(this),e,g):-1!==b.indexOf("material")?new rc(function(b){d(b);a.material.update()},e,g):new rc(d,e,g)}});Object.assign(gg.prototype,{play:function(a){this._controller.play(a)},pause:function(){this._controller.pause()},reset:function(){this._controller.reset()},update:function(a){this._controller.update(a)},assignAnimation:function(a,b){this._controller.assignAnimation(a,b);
this._component.activate&&this._component.playable&&(this._component.playing=!0)},removeNodeAnimations:function(a){this._controller.removeNodeAnimations(a)}});Object.defineProperties(gg.prototype,{name:{get:function(){return this._name}},playing:{get:function(){return this._controller.playing},set:function(a){this._controller.playing=a}},playable:{get:function(){return this._controller.playable}},activeState:{get:function(){return this._controller.activeStateName}},previousState:{get:function(){return this._controller.previousStateName}},
activeStateProgress:{get:function(){return this._controller.activeStateProgress}},transitioning:{get:function(){return this._controller.transitioning}},transitionProgress:{get:function(){return this.transitioning?this._controller.transitionProgress:null}},states:{get:function(){return this._controller.states}}});Object.defineProperties(kk.prototype,{name:{get:function(){return this._name}},animations:{get:function(){return this._animations}},speed:{get:function(){return this._speed}},playable:{get:function(){return 0<
this.animations.length||"START"===this.name||"END"===this.name}},looping:{get:function(){if(0<this.animations.length){var a=this._controller.animEvaluator.findClip(this.name+"."+this.animations[0].animTrack.name);if(a)return a.loop}return!1}},totalWeight:{get:function(){var a=0,b;for(b=0;b<this.animations.length;b++)a+=this.animations[b].weight;return a}},timelineDuration:{get:function(){var a=0,b;for(b=0;b<this.animations.length;b++){var c=this.animations[b];c.animTrack.duration>a&&(a=c.animTrack.duration>
a)}return a}}});Object.defineProperties(pi.prototype,{from:{get:function(){return this._from}},to:{get:function(){return this._to}},time:{get:function(){return this._time}},priority:{get:function(){return this._priority}},conditions:{get:function(){return this._conditions}},exitTime:{get:function(){return this._exitTime}},transitionOffset:{get:function(){return this._transitionOffset}},interruptionSource:{get:function(){return this._interruptionSource}},hasExitTime:{get:function(){return!!this.exitTime}},
hasConditionsMet:{get:function(){var a=!0,b;for(b=0;b<this.conditions.length;b++){var c=this.conditions[b],d=this._controller.findParameter(c.parameterName);switch(c.predicate){case "GREATER_THAN":a=a&&d.value>c.value;break;case "LESS_THAN":a=a&&d.value<c.value;break;case "GREATER_THAN_EQUAL_TO":a=a&&d.value>=c.value;break;case "LESS_THAN_EQUAL_TO":a=a&&d.value<=c.value;break;case "EQUAL_TO":a=a&&d.value===c.value;break;case "NOT_EQUAL_TO":a=a&&d.value!==c.value}if(!a)break}return a}}});Object.defineProperties(hg.prototype,
{animEvaluator:{get:function(){return this._animEvaluator}},activeState:{get:function(){return this._findState(this._activeStateName)},set:function(a){this._activeStateName=a}},activeStateName:{get:function(){return this._activeStateName}},previousState:{get:function(){return this._findState(this._previousStateName)},set:function(a){this._previousStateName=a}},previousStateName:{get:function(){return this._previousStateName}},playable:{get:function(){var a=!0,b;for(b=0;b<this._stateNames.length;b++)this._states[this._stateNames[b]].playable||
(a=!1);return a}},activeStateProgress:{get:function(){return this._getActiveStateProgressForTime(this._timeInState)}},transitioning:{get:function(){return this._isTransitioning}},transitionProgress:{get:function(){return this._currTransitionTime/this._totalTransitionTime}},states:{get:function(){return this._stateNames}}});Object.assign(hg.prototype,{_findState:function(a){return this._states[a]},_getActiveStateProgressForTime:function(a){if("START"===this.activeStateName||"END"===this.activeStateName)return 1;
var b=this._animEvaluator.findClip(this.activeState.animations[0].name);return b?a/b.track.duration:null},_findTransitionsFromState:function(a){var b=this._findTransitionsFromStateCache[a];b||(b=this._transitions.filter(function(b){return b.from===a}),b.sort(function(a,b){return a.priority<b.priority}),this._findTransitionsFromStateCache[a]=b);return b},_findTransitionsBetweenStates:function(a,b){var c=this._findTransitionsBetweenStatesCache[a+"->"+b];c||(c=this._transitions.filter(function(c){return c.from===
a&&c.to===b}),c.sort(function(a,b){return a.priority<b.priority}),this._findTransitionsBetweenStatesCache[a+"->"+b]=c);return c},_findTransition:function(a,b){var c=[];if(a&&b)c.concat(this._findTransitionsBetweenStates(this._activeStateName));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case "PREV_STATE":c=c.concat(this._findTransitionsFromState(this._previousStateName));break;case "NEXT_STATE":c=c.concat(this._findTransitionsFromState(this._activeStateName));break;case "PREV_STATE_NEXT_STATE":c=
c.concat(this._findTransitionsFromState(this._previousStateName));c=c.concat(this._findTransitionsFromState(this._activeStateName));break;case "NEXT_STATE_PREV_STATE":c=c.concat(this._findTransitionsFromState(this._activeStateName)),c=c.concat(this._findTransitionsFromState(this._previousStateName))}else c=c.concat(this._findTransitionsFromState(this._activeStateName));c=c.filter(function(a){if(a.to===this.activeStateName)return!1;if(a.hasExitTime){var b=this._getActiveStateProgressForTime(this._timeInStateBefore),
c=this._getActiveStateProgressForTime(this._timeInState);1>a.exitTime&&this.activeState.looping&&(b-=Math.floor(b),c-=Math.floor(c));if(!(a.exitTime>b&&a.exitTime<=c))return null}return a.hasConditionsMet}.bind(this));return 0<c.length?c[0]:null},_updateStateFromTransition:function(a){var b,c;this.previousState=a.from;this.activeState=a.to;for(b=0;b<a.conditions.length;b++){var d=this.findParameter(a.conditions[b].parameterName);"TRIGGER"===d.type&&(d.value=!1)}if(this.previousState){this._isTransitioning||
(this._transitionPreviousStates=[]);this._transitionPreviousStates.push({name:this._previousStateName,weight:1});var e=this._currTransitionTime/this._totalTransitionTime;for(b=0;b<this._transitionPreviousStates.length;b++){this._transitionPreviousStates[b].weight=b!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[b].weight*(1-e):e;var g=this._findState(this._transitionPreviousStates[b].name);for(c=0;c<g.animations.length;c++){var f=g.animations[c];d=this._animEvaluator.findClip(f.name+
".previous."+b);d||(d=this._animEvaluator.findClip(f.name),d.name=f.name+".previous."+b);d.pause()}}}0<a.time&&(this._isTransitioning=!0,this._totalTransitionTime=a.time,this._currTransitionTime=0,this._transitionInterruptionSource=a.interruptionSource);c=a.transitionOffset&&0<a.transitionOffset&&1>a.transitionOffset;g=this.activeState;for(b=0;b<g.animations.length;b++)d=this._animEvaluator.findClip(g.animations[b].name),d||(d=new Se(g.animations[b].animTrack,0,g.speed,!0,!0),d.name=g.animations[b].name,
this._animEvaluator.addClip(d)),d.blendWeight=0<a.time?0:1/g.totalWeight,d.reset(),c&&(d.time=g.timelineDuration*a.transitionOffset),d.play();d=b=0;c&&(d=b=a=g.timelineDuration*a.transitionOffset);this._timeInState=b;this._timeInStateBefore=d},_transitionToState:function(a){if(a!==this._activeStateName&&this._findState(a)){var b=this._findTransition(this._activeStateName,a);b||(this._animEvaluator.removeClips(),b=new pi(this,null,a,0,0));this._updateStateFromTransition(b)}},assignAnimation:function(a,
b){var c=this._findState(a);c&&(a={name:a+"."+b.name,animTrack:b,weight:1},0<c.animations.length&&(c.animations=[],this.reset()),c.animations.push(a),!this._playing&&this._activate&&this.playable&&this.play())},removeNodeAnimations:function(a){if(a=this._findState(a))a.animations=[]},play:function(a){a&&this._transitionToState(a);this._playing=!0},pause:function(){this._playing=!1},reset:function(){this._previousStateName=null;this._activeStateName="START";this._playing=!1;this._totalTransitionTime=
this._currTransitionTime=1;this._isTransitioning=!1;this._timeInStateBefore=this._timeInState=0;this._animEvaluator.removeClips()},update:function(a){if(this._playing){var b,c;this._timeInStateBefore=this._timeInState;this._timeInState+=a;(b=this._findTransition(this._activeStateName))&&this._updateStateFromTransition(b);if(this._isTransitioning){if(this._currTransitionTime<this._totalTransitionTime){var d=this._currTransitionTime/this._totalTransitionTime;for(b=0;b<this._transitionPreviousStates.length;b++){var e=
this._findState(this._transitionPreviousStates[b].name);var g=this._transitionPreviousStates[b].weight;for(c=0;c<e.animations.length;c++){var f=e.animations[c];this._animEvaluator.findClip(f.name+".previous."+b).blendWeight=(1-d)*f.weight/e.totalWeight*g}}e=this.activeState;for(b=0;b<e.animations.length;b++)f=e.animations[b],this._animEvaluator.findClip(f.name).blendWeight=d*f.weight/e.totalWeight}else{this._isTransitioning=!1;c=this.activeState.animations.length;e=this._animEvaluator.clips.length;
for(b=0;b<e-c;b++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[];e=this.activeState;for(b=0;b<e.animations.length;b++)f=e.animations[b],this._animEvaluator.findClip(f.name).blendWeight=f.weight/e.totalWeight}this._currTransitionTime+=a}this._animEvaluator.update(a)}},findParameter:function(a){return this._parameters[a]}});Oc.prototype=Object.create(G.prototype);Oc.prototype.constructor=Oc;Object.assign(Oc.prototype,{loadStateGraph:function(a){function b(a,b,d,g){var f=new Ze(this,
c);f=new Ba(f);b=new hg(f,b,d,e.parameters,e.activate);e.layers.push(new gg(a,b,this));e.layerIndices[a]=g}this.data.stateGraph=a;var c,d=this.entity.model;d&&(d=d.model)&&(c=d.getGraph());var e=this.data;e.parameters=a.parameters;for(d=0;d<a.layers.length;d++){var g=a.layers[d];b.bind(this)(g.name,g.states,g.transitions,d)}},removeStateGraph:function(){this.data.stateGraph=null;this.data.layers=[];this.data.layerIndices={};this.data.parameters={};this.data.playing=!1},reset:function(){this.data.parameters=
Object.assign({},this.data.stateGraph.parameters);for(var a=0;a<this.data.layers.length;a++){var b=this.data.layers[a].playing;this.data.layers[a].reset();this.data.layers[a].playing=b}},findAnimationLayer:function(a){return this.data.layers[this.data.layerIndices[a]]||null},assignAnimation:function(a,b,c){this.data.stateGraph&&(c=this.findAnimationLayer(c||"DEFAULT_LAYER"))&&c.assignAnimation(a,b)},removeNodeAnimations:function(a,b){(b=this.findAnimationLayer(b||"DEFAULT_LAYER"))&&b.removeNodeAnimations(a)},
getParameterValue:function(a,b){if((a=this.data.parameters[a])&&a.type===b)return a.value},setParameterValue:function(a,b,c){(a=this.data.parameters[a])&&a.type===b&&(a.value=c)},getFloat:function(a){return this.getParameterValue(a,"FLOAT")},setFloat:function(a,b){this.setParameterValue(a,"FLOAT",b)},getInteger:function(a){return this.getParameterValue(a,"INTEGER")},setInteger:function(a,b){"number"===typeof b&&0===b%1&&this.setParameterValue(a,"INTEGER",b)},getBoolean:function(a){return this.getParameterValue(a,
"BOOLEAN")},setBoolean:function(a,b){this.setParameterValue(a,"BOOLEAN",!!b)},getTrigger:function(a){return this.getParameterValue(a,"TRIGGER")},setTrigger:function(a){this.setParameterValue(a,"TRIGGER",!0)},resetTrigger:function(a){this.setParameterValue(a,"TRIGGER",!1)}});Object.defineProperties(Oc.prototype,{stateGraphAsset:{get:function(){return this.data.stateGraphAsset},set:function(a){if(a instanceof X){var b=a.id;var c=this.system.app.assets.get(b);c||(this.system.app.assets.add(a),c=this.system.app.assets.get(b))}else b=
a,c=this.system.app.assets.get(b);c&&this.data.stateGraphAsset!==b&&(c.resource?(this.data.stateGraph=c.resource,this.loadStateGraph(this.data.stateGraph)):(c.on("load",function(a){this.data.stateGraph=a.resource;this.loadStateGraph(this.data.stateGraph)}.bind(this)),this.system.app.assets.load(c)),this.data.stateGraphAsset=b)}},playable:{get:function(){for(var a=0;a<this.data.layers.length;a++)if(!this.data.layers[a].playable)return!1;return!0}},baseLayer:{get:function(){return 0<this.data.layers.length?
this.data.layers[0]:null}}});var lk=["enabled","speed","activate","playing"];Xd.prototype=Object.create(B.prototype);Xd.prototype.constructor=Xd;G._buildAccessors(Oc.prototype,lk);Object.assign(Xd.prototype,{initializeComponentData:function(a,b,c){c=["activate","enabled","speed","playing"];B.prototype.initializeComponentData.call(this,a,b,c)},onAnimationUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c],e=d.data;if(e.enabled&&d.entity.enabled&&e.playing)for(d=0;d<
e.layers.length;d++)e.layers[d].update(a*e.speed)}}});md.prototype=Object.create(G.prototype);md.prototype.constructor=md;Object.assign(md.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var a=this.system.current.getPosition();this.system.manager.listener.setPosition(a)}},onEnable:function(){this.setCurrentListener()},onDisable:function(){this.system.current===this.entity&&(this.system.current=null)}});var mk=
["enabled"];Yd.prototype=Object.create(B.prototype);Yd.prototype.constructor=Yd;G._buildAccessors(md.prototype,mk);Object.assign(Yd.prototype,{initializeComponentData:function(a,b,c){c=["enabled"];B.prototype.initializeComponentData.call(this,a,b,c)},onUpdate:function(a){this.current&&(a=this.current.getPosition(),this.manager.listener.setPosition(a),a=this.current.getWorldTransform(),this.manager.listener.setOrientation(a))}});nd.prototype=Object.create(G.prototype);nd.prototype.constructor=nd;Object.assign(nd.prototype,
{play:function(a){if(this.enabled&&this.entity.enabled){this.channel&&this.stop();var b=this.data;if(b.sources[a]){if(b["3d"]){var c=this.entity.getPosition();c=this.system.manager.playSound3d(b.sources[a],c,b)}else c=this.system.manager.playSound(b.sources[a],b);b.currentSource=a;b.channel=c}}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=null)},onSetAssets:function(a,
b,c){a=[];var d,e=c.length;if(b&&b.length)for(d=0;d<b.length;d++)if(b[d]){var g=this.system.app.assets.get(b[d]);g&&(g.off("change",this.onAssetChanged,this),g.off("remove",this.onAssetRemoved,this),this.currentSource===g.name&&this.stop())}if(e)for(d=0;d<e;d++)0>b.indexOf(c[d])&&(c[d]instanceof X?a.push(c[d].id):a.push(c[d]));!this.system._inTools&&a.length&&this.loadAudioSourceAssets(a)},onAssetChanged:function(a,b,c,d){"resource"===b&&this.data.sources&&(this.data.sources[a.name]=c,this.data.currentSource===
a.name&&this.channel&&(this.channel.paused?(this.play(a.name),this.pause()):this.play(a.name)))},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);this.data.sources[a.name]&&(delete this.data.sources[a.name],this.data.currentSource===a.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(a,b,c){b!=c&&this.channel&&this.channel.setLoop(c)},onSetVolume:function(a,b,c){b!=c&&this.channel&&this.channel.setVolume(c)},onSetPitch:function(a,b,c){b!=c&&this.channel&&this.channel.setPitch(c)},
onSetMaxDistance:function(a,b,c){b!=c&&this.channel instanceof Sa&&this.channel.setMaxDistance(c)},onSetMinDistance:function(a,b,c){b!=c&&this.channel instanceof Sa&&this.channel.setMinDistance(c)},onSetRollOffFactor:function(a,b,c){b!=c&&this.channel instanceof Sa&&this.channel.setRollOffFactor(c)},onSetDistanceModel:function(a,b,c){b!==c&&this.channel instanceof Sa&&this.channel.setDistanceModel(c)},onSet3d:function(a,b,c){b!==c&&this.system.initialized&&this.currentSource&&(b=a=!1,this.channel&&
(a=this.channel.paused,b=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=a,this.channel.suspended=b))},onEnable:function(){var a=this.data.assets;if(a)for(var b=this.system.app.assets,c=0,d=a.length;c<d;c++){var e=a[c];e instanceof X||(e=b.get(e));e&&!e.resource&&b.load(e)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){this.pause()},loadAudioSourceAssets:function(a){var b=this,
c=a.map(function(a){return this.system.app.assets.get(a)},this),d={},e=null,g=c.length,f=function(a){g--},l=function(){this.data.sources=d;this.data.currentSource=e;if(this.enabled&&this.activate&&e)this.onEnable()}.bind(this);c.forEach(function(c,k){c?(e=e||c.name,c.off("change",this.onAssetChanged,this),c.on("change",this.onAssetChanged,this),c.off("remove",this.onAssetRemoved,this),c.on("remove",this.onAssetRemoved,this),c.off("error",f,this),c.on("error",f,this),c.ready(function(a){d[a.name]=
a.resource;g--;0===g&&l()}),!c.resource&&b.enabled&&b.entity.enabled&&this.system.app.assets.load(c)):(g--,0===g&&l(),this.system.app.assets.on("add:"+a[k],function(a){a.ready(function(a){b.data.sources[a.name]=a.resource});a.resource||b.system.app.assets.load(a)}))},this)}});var nk="enabled assets volume pitch loop activate 3d minDistance maxDistance rollOffFactor distanceModel sources currentSource channel".split(" ");Zd.prototype=Object.create(B.prototype);Zd.prototype.constructor=Zd;G._buildAccessors(nd.prototype,
nk);Object.assign(Zd.prototype,{initializeComponentData:function(a,b,c){c="activate volume pitch loop 3d minDistance maxDistance rollOffFactor distanceModel enabled assets".split(" ");B.prototype.initializeComponentData.call(this,a,b,c);a.paused=!(a.enabled&&a.activate)},onInitialize:function(a){a.audiosource&&a.enabled&&a.audiosource.enabled&&a.audiosource.activate&&a.audiosource.play(a.audiosource.currentSource);a=a._children;var b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof S)this.onInitialize(a[b]);
this.initialized=!0},onUpdate:function(a){a=this.store;for(var b in a)if(a.hasOwnProperty(b)){var c=a[b],d=c.entity;c=c.data;c.enabled&&d.enabled&&c.channel instanceof Sa&&(d=d.getPosition(),c.channel.setPosition(d))}},onRemove:function(a,b){b.channel&&(b.channel.stop(),b.channel=null)},setVolume:function(a){this.manager.setVolume(a)}});Object.assign(tc.prototype,{_configureEventListeners:function(a,b){a=this._parseEventListenerConfig(a,"external",this._parentComponent);b=this._parseEventListenerConfig(b,
"internal",this);this._eventListenerConfigs=a.concat(b);this._listenerStatusFlags={};this._gainListeners={};this._loseListeners={}},_parseEventListenerConfig:function(a,b,c){return Object.keys(a).map(function(d,e){var g=d.split("#"),f=g[0],l=g[1],h=a[d];if(2!==g.length||"string"!==typeof f||0===f.length||"string"!==typeof l||0===l.length)throw Error("Invalid event listener description: `"+d+"`");if("function"!==typeof h)throw Error("Invalid or missing callback for event listener `"+d+"`");return{id:b+
"_"+e+"_"+d,sourceName:f,eventName:l,callback:h,scope:c}},this)},_toggleLifecycleListeners:function(a){this._parentComponent[a]("set_"+this._entityPropertyName,this._onSetEntity,this);this._parentComponent.system[a]("beforeremove",this._onParentComponentRemove,this);B[a]("postinitialize",this._onPostInitialize,this);this._app[a]("tools:sceneloaded",this._onSceneLoaded,this);for(var b=[],c=0;c<this._eventListenerConfigs.length;++c){var d=this._eventListenerConfigs[c],e=this._app.systems[d.sourceName];
e&&(-1===b.indexOf(e)&&b.push(e),e&&"gain"===d.eventName&&(this._gainListeners[d.sourceName]=d),e&&"lose"===d.eventName&&(this._loseListeners[d.sourceName]=d))}for(c=0;c<b.length;++c)b[c][a]("add",this._onComponentAdd,this),b[c][a]("beforeremove",this._onComponentRemove,this)},_onSetEntity:function(a,b,c){c instanceof S?this._updateEntityReference():null!==c&&void 0!==c&&"string"!==typeof c?console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof c+"'"):b!==c&&
this._updateEntityReference()},_onPostInitialize:function(){this._updateEntityReference()},onParentComponentEnable:function(){this._entity||this._updateEntityReference()},_onSceneLoaded:function(){this._updateEntityReference()},_updateEntityReference:function(){var a=this._parentComponent.data[this._entityPropertyName];if(a instanceof S){var b=a;a=b.getGuid();this._parentComponent.data[this._entityPropertyName]=a}else b=this._parentComponent.system.app.root,b=this._parentComponent.entity.isDescendantOf(b)&&
a?b.findByGuid(a):null;this._entity!==b&&(this._entity&&this._onBeforeEntityChange(),(this._entity=b)&&this._onAfterEntityChange())},_onBeforeEntityChange:function(){this._toggleEntityListeners("off");this._callAllGainOrLoseListeners(this._loseListeners)},_onAfterEntityChange:function(){this._toggleEntityListeners("on");this._callAllGainOrLoseListeners(this._gainListeners)},_onComponentAdd:function(a,b){b=b.system.id;a===this._entity&&(this._callGainOrLoseListener(b,this._gainListeners),this._toggleComponentListeners("on",
b))},_onComponentRemove:function(a,b){b=b.system.id;a===this._entity&&(this._callGainOrLoseListener(b,this._loseListeners),this._toggleComponentListeners("off",b,!0))},_callAllGainOrLoseListeners:function(a){for(var b in this._entity.c)this._callGainOrLoseListener(b,a)},_callGainOrLoseListener:function(a,b){this._entity.c.hasOwnProperty(a)&&b[a]&&(a=b[a],a.callback.call(a.scope))},_toggleEntityListeners:function(a,b){if(this._entity)for(var c=0;c<this._eventListenerConfigs.length;++c)this._safeToggleListener(a,
this._eventListenerConfigs[c],b)},_toggleComponentListeners:function(a,b,c){for(var d=0;d<this._eventListenerConfigs.length;++d){var e=this._eventListenerConfigs[d];e.sourceName===b&&this._safeToggleListener(a,e,c)}},_safeToggleListener:function(a,b,c){var d="on"===a;if(!d||!this._listenerStatusFlags[b.id])if(c=this._getEventSource(b.sourceName,c))c[a](b.eventName,b.callback,b.scope),this._listenerStatusFlags[b.id]=d},_getEventSource:function(a,b){if("entity"===a)return this._entity;var c=this._entity[a];
if(c)return c;b||console.warn("Entity has no component with name "+a);return null},_onEntityDestroy:function(a){this._entity===a&&(this._toggleEntityListeners("off",!0),this._entity=null)},_onParentComponentRemove:function(a,b){b===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))},hasComponent:function(a){return this._entity&&this._entity.c?!!this._entity.c[a]:!1}});Object.defineProperty(tc.prototype,"entity",{get:function(){return this._entity}});
var ig=0,Fa={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},wf={};wf[Fa.DEFAULT]="_defaultTint";wf[Fa.HOVER]="hoverTint";wf[Fa.PRESSED]="pressedTint";wf[Fa.INACTIVE]="inactiveTint";var xf={};xf[Fa.DEFAULT]="_defaultSpriteAsset";xf[Fa.HOVER]="hoverSpriteAsset";xf[Fa.PRESSED]="pressedSpriteAsset";xf[Fa.INACTIVE]="inactiveSpriteAsset";var yf={};yf[Fa.DEFAULT]="_defaultSpriteFrame";yf[Fa.HOVER]="hoverSpriteFrame";yf[Fa.PRESSED]="pressedSpriteFrame";yf[Fa.INACTIVE]="inactiveSpriteFrame";
od.prototype=Object.create(G.prototype);od.prototype.constructor=od;Object.assign(od.prototype,{_toggleLifecycleListeners:function(a,b){this[a]("set_active",this._onSetActive,this);this[a]("set_transitionMode",this._onSetTransitionMode,this);this[a]("set_hoverTint",this._onSetTransitionValue,this);this[a]("set_pressedTint",this._onSetTransitionValue,this);this[a]("set_inactiveTint",this._onSetTransitionValue,this);this[a]("set_hoverSpriteAsset",this._onSetTransitionValue,this);this[a]("set_hoverSpriteFrame",
this._onSetTransitionValue,this);this[a]("set_pressedSpriteAsset",this._onSetTransitionValue,this);this[a]("set_pressedSpriteFrame",this._onSetTransitionValue,this);this[a]("set_inactiveSpriteAsset",this._onSetTransitionValue,this);this[a]("set_inactiveSpriteFrame",this._onSetTransitionValue,this);b.app.systems.element[a]("add",this._onElementComponentAdd,this);b.app.systems.element[a]("beforeremove",this._onElementComponentRemove,this)},_onSetActive:function(a,b,c){b!==c&&this._updateVisualState()},
_onSetTransitionMode:function(a,b,c){b!==c&&(this._cancelTween(),this._resetToDefaultVisualState(b),this._forceReapplyVisualState())},_onSetTransitionValue:function(a,b,c){b!==c&&this._forceReapplyVisualState()},_onElementComponentRemove:function(a){this.entity===a&&this._toggleHitElementListeners("off")},_onElementComponentAdd:function(a){this.entity===a&&this._toggleHitElementListeners("on")},_onImageElementLose:function(){this._cancelTween();this._resetToDefaultVisualState(this.transitionMode)},
_onImageElementGain:function(){this._storeDefaultVisualState();this._forceReapplyVisualState()},_toggleHitElementListeners:function(a){if(this.entity.element){var b="on"===a;b&&this._hasHitElementListeners||(this.entity.element[a]("mouseenter",this._onMouseEnter,this),this.entity.element[a]("mouseleave",this._onMouseLeave,this),this.entity.element[a]("mousedown",this._onMouseDown,this),this.entity.element[a]("mouseup",this._onMouseUp,this),this.entity.element[a]("touchstart",this._onTouchStart,this),
this.entity.element[a]("touchend",this._onTouchEnd,this),this.entity.element[a]("touchleave",this._onTouchLeave,this),this.entity.element[a]("touchcancel",this._onTouchCancel,this),this.entity.element[a]("selectstart",this._onSelectStart,this),this.entity.element[a]("selectend",this._onSelectEnd,this),this.entity.element[a]("selectenter",this._onSelectEnter,this),this.entity.element[a]("selectleave",this._onSelectLeave,this),this.entity.element[a]("click",this._onClick,this),this._hasHitElementListeners=
b)}},_storeDefaultVisualState:function(){this._imageReference.hasComponent("element")&&(this._storeDefaultColor(this._imageReference.entity.element.color),this._storeDefaultOpacity(this._imageReference.entity.element.opacity),this._storeDefaultSpriteAsset(this._imageReference.entity.element.spriteAsset),this._storeDefaultSpriteFrame(this._imageReference.entity.element.spriteFrame))},_storeDefaultColor:function(a){this._defaultTint.r=a.r;this._defaultTint.g=a.g;this._defaultTint.b=a.b},_storeDefaultOpacity:function(a){this._defaultTint.a=
a},_storeDefaultSpriteAsset:function(a){this._defaultSpriteAsset=a},_storeDefaultSpriteFrame:function(a){this._defaultSpriteFrame=a},_onSetColor:function(a){this._isApplyingTint||(this._storeDefaultColor(a),this._forceReapplyVisualState())},_onSetOpacity:function(a){this._isApplyingTint||(this._storeDefaultOpacity(a),this._forceReapplyVisualState())},_onSetSpriteAsset:function(a){this._isApplyingSprite||(this._storeDefaultSpriteAsset(a),this._forceReapplyVisualState())},_onSetSpriteFrame:function(a){this._isApplyingSprite||
(this._storeDefaultSpriteFrame(a),this._forceReapplyVisualState())},_onMouseEnter:function(a){this._isHovering=!0;this._updateVisualState();this._fireIfActive("mouseenter",a)},_onMouseLeave:function(a){this._isPressed=this._isHovering=!1;this._updateVisualState();this._fireIfActive("mouseleave",a)},_onMouseDown:function(a){this._isPressed=!0;this._updateVisualState();this._fireIfActive("mousedown",a)},_onMouseUp:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("mouseup",
a)},_onTouchStart:function(a){this._isPressed=!0;this._updateVisualState();this._fireIfActive("touchstart",a)},_onTouchEnd:function(a){a.event.preventDefault();this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchend",a)},_onTouchLeave:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchleave",a)},_onTouchCancel:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchcancel",a)},_onSelectStart:function(a){this._isPressed=!0;
this._updateVisualState();this._fireIfActive("selectstart",a)},_onSelectEnd:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("selectend",a)},_onSelectEnter:function(a){this._hoveringCounter++;1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState());this._fireIfActive("selectenter",a)},_onSelectLeave:function(a){this._hoveringCounter--;0===this._hoveringCounter&&(this._isPressed=this._isHovering=!1,this._updateVisualState());this._fireIfActive("selectleave",
a)},_onClick:function(a){this._fireIfActive("click",a)},_fireIfActive:function(a,b){this.data.active&&this.fire(a,b)},_updateVisualState:function(a){var b=this._visualState,c=this._determineVisualState();if((b!==c||a)&&this.enabled)switch(this._visualState=c,b===Fa.HOVER&&this._fireIfActive("hoverend"),b===Fa.PRESSED&&this._fireIfActive("pressedend"),c===Fa.HOVER&&this._fireIfActive("hoverstart"),c===Fa.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case ig:this._applyTint(this[wf[this._visualState]]);
break;case 1:this._applySprite(this[xf[this._visualState]],this[yf[this._visualState]])}},_forceReapplyVisualState:function(){this._updateVisualState(!0)},_resetToDefaultVisualState:function(a){if(this._imageReference.hasComponent("element"))switch(a){case ig:this._cancelTween();this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}},_determineVisualState:function(){if(this.active){if(this._isPressed)return Fa.PRESSED;if(this._isHovering)return Fa.HOVER}else return Fa.INACTIVE;
return Fa.DEFAULT},_applySprite:function(a,b){b=b||0;this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset=a,this._imageReference.entity.element.spriteFrame=b,this._isApplyingSprite=!1)},_applyTint:function(a){this._cancelTween();0===this.fadeDuration?this._applyTintImmediately(a):this._applyTintWithTween(a)},_applyTintImmediately:function(a){this._imageReference.hasComponent("element")&&a&&(this._isApplyingTint=!0,this._imageReference.entity.element.color=
new J(a.r,a.g,a.b),this._imageReference.entity.element.opacity=a.a,this._isApplyingTint=!1)},_applyTintWithTween:function(a){if(this._imageReference.hasComponent("element")&&a){var b=this._imageReference.entity.element.color,c=this._imageReference.entity.element.opacity;this._tweenInfo={startTime:zb(),from:new J(b.r,b.g,b.b,c),to:a.clone(),lerpColor:new J}}},_updateTintTween:function(){var a=zb()-this._tweenInfo.startTime;a=0===this.fadeDuration?1:a/this.fadeDuration;a=O.clamp(a,0,1);if(1E-5<Math.abs(a-
1)){var b=this._tweenInfo.lerpColor;b.lerp(this._tweenInfo.from,this._tweenInfo.to,a);this._applyTintImmediately(new J(b.r,b.g,b.b,b.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()},_cancelTween:function(){delete this._tweenInfo},onUpdate:function(){this._tweenInfo&&this._updateTintTween()},onEnable:function(){this._isHovering=!1;this._hoveringCounter=0;this._isPressed=!1;this._imageReference.onParentComponentEnable();this._toggleHitElementListeners("on");this._forceReapplyVisualState()},
onDisable:function(){this._toggleHitElementListeners("off");this._resetToDefaultVisualState(this.transitionMode)},onRemove:function(){this._toggleLifecycleListeners("off",this.system);this.onDisable()}});var qi=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame",
"inactiveSpriteAsset","inactiveSpriteFrame"];$d.prototype=Object.create(B.prototype);$d.prototype.constructor=$d;G._buildAccessors(od.prototype,qi);Object.assign($d.prototype,{initializeComponentData:function(a,b,c){B.prototype.initializeComponentData.call(this,a,b,qi)},onUpdate:function(a){a=this.store;for(var b in a){var c=a[b].entity,d=c.button;if(d.enabled&&c.enabled)d.onUpdate()}},_onRemoveComponent:function(a,b){b.onRemove()}});var Ob=function(a,b){G.call(this,a,b);this.on("set_aspectRatioMode",
this.onSetAspectRatioMode,this);this.on("set_aspectRatio",this.onSetAspectRatio,this);this.on("set_camera",this.onSetCamera,this);this.on("set_clearColor",this.onSetClearColor,this);this.on("set_fov",this.onSetFov,this);this.on("set_orthoHeight",this.onSetOrthoHeight,this);this.on("set_nearClip",this.onSetNearClip,this);this.on("set_farClip",this.onSetFarClip,this);this.on("set_projection",this.onSetProjection,this);this.on("set_priority",this.onSetPriority,this);this.on("set_clearColorBuffer",this.updateClearFlags,
this);this.on("set_clearDepthBuffer",this.updateClearFlags,this);this.on("set_clearStencilBuffer",this.updateClearFlags,this);this.on("set_renderTarget",this.onSetRenderTarget,this);this.on("set_rect",this.onSetRect,this);this.on("set_scissorRect",this.onSetScissorRect,this);this.on("set_horizontalFov",this.onSetHorizontalFov,this);this.on("set_frustumCulling",this.onSetFrustumCulling,this);this.on("set_calculateTransform",this.onSetCalculateTransform,this);this.on("set_calculateProjection",this.onSetCalculateProjection,
this);this.on("set_cullFaces",this.onSetCullFaces,this);this.on("set_flipFaces",this.onSetFlipFaces,this);this.on("set_layers",this.onSetLayers,this)};Ob.prototype=Object.create(G.prototype);Ob.prototype.constructor=Ob;Object.defineProperty(Ob.prototype,"projectionMatrix",{get:function(){return this.data.camera.getProjectionMatrix()}});Object.defineProperty(Ob.prototype,"viewMatrix",{get:function(){return this.data.camera.getViewMatrix()}});Object.defineProperty(Ob.prototype,"frustum",{get:function(){return this.data.camera.frustum}});
Object.defineProperty(Ob.prototype,"vrDisplay",{get:function(){return this.data.camera.vrDisplay},set:function(a){if(this.data.camera.vrDisplay=a)a._camera=this.data.camera}});Object.defineProperty(Ob.prototype,"node",{get:function(){return this.data.camera._node}});Object.assign(Ob.prototype,{screenToWorld:function(a,b,c,d){var e=this.system.app.graphicsDevice;return this.data.camera.screenToWorld(a,b,c,e.clientRect.width,e.clientRect.height,d)},onPrerender:function(){this.data.camera._viewMatDirty=
!0;this.data.camera._viewProjMatDirty=!0},worldToScreen:function(a,b){var c=this.system.app.graphicsDevice;return this.data.camera.worldToScreen(a,c.clientRect.width,c.clientRect.height,b)},onSetAspectRatioMode:function(a,b,c){this.data.camera.aspectRatioMode=c},onSetAspectRatio:function(a,b,c){this.data.camera.aspectRatio=c},onSetCamera:function(a,b,c){b&&(b._node=null);c._node=this.entity},onSetClearColor:function(a,b,c){a=this.data.camera.clearColor;a[0]=c.r;a[1]=c.g;a[2]=c.b;a[3]=c.a},onSetFov:function(a,
b,c){this.data.camera.fov=c},onSetOrthoHeight:function(a,b,c){this.data.camera.orthoHeight=c},onSetNearClip:function(a,b,c){this.data.camera.nearClip=c},onSetFarClip:function(a,b,c){this.data.camera.farClip=c},onSetHorizontalFov:function(a,b,c){this.data.camera.horizontalFov=c},onSetFrustumCulling:function(a,b,c){this.data.camera.frustumCulling=c},onSetCalculateTransform:function(a,b,c){this._calculateTransform=c;this.camera.overrideCalculateTransform=!!c},onSetCalculateProjection:function(a,b,c){this._calculateProjection=
c;this.camera._projMatDirty=!0;this.camera.overrideCalculateProjection=!!c},onSetCullFaces:function(a,b,c){this.camera._cullFaces=c},onSetFlipFaces:function(a,b,c){this.camera._flipFaces=c},onSetProjection:function(a,b,c){this.data.camera.projection=c},onSetPriority:function(a,b,c){for(b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a._sortCameras()},onSetLayers:function(a,b,c){var d;for(a=0;a<b.length;a++)(d=this.system.app.scene.layers.getLayerById(b[a]))&&
d.removeCamera(this);if(this.enabled&&this.entity.enabled)for(a=0;a<c.length;a++)(d=this.system.app.scene.layers.getLayerById(c[a]))&&d.addCamera(this)},addCameraToLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.addCamera(this)},removeCameraFromLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.removeCamera(this)},onLayersChanged:function(a,b){this.addCameraToLayers();
a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||a.addCamera(this)},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||a.removeCamera(this)},updateClearFlags:function(){var a=0;this.clearColorBuffer&&(a|=1);this.clearDepthBuffer&&(a|=2);this.clearStencilBuffer&&(a|=4);this.data.camera.clearFlags=a},onSetRenderTarget:function(a,b,c){this.data.camera.renderTarget=
c},onSetRect:function(a,b,c){this.data.camera.setRect(c.x,c.y,c.z,c.w)},onSetScissorRect:function(a,b,c){this.data.camera.setScissorRect(c.x,c.y,c.z,c.w)},onEnable:function(){this.system.addCamera(this);this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addCameraToLayers();this.postEffects.enable()},
onDisable:function(){this.postEffects.disable();this.removeCameraFromLayers();this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.system.removeCamera(this)},onRemove:function(){this.onDisable();this.off()},calculateAspectRatio:function(a){a=a?a:this.system.app.graphicsDevice;var b=this.rect;return a.width*b.z/(a.height*
b.w)},frameBegin:function(a){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(a));this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1},enterVr:function(a,b){a instanceof Function&&!b&&(b=a,a=null);if(this.system.app.vr)if(a||(a=this.system.app.vr.display),a){var c=this;a.capabilities.canPresent?a.requestPresent(function(d){d||(c.vrDisplay=a,c.vrDisplay.once("beforepresentchange",function(a){a.presenting||(c.vrDisplay=null)}));b(d)}):(c.vrDisplay=a,b())}else b("No pc.VrDisplay to present");
else b("VrManager not created. Enable VR in project settings.")},exitVr:function(a){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var b=this.vrDisplay;this.vrDisplay=null;b.exitPresent(a)}else this.vrDisplay=null,a();else a("Not presenting VR")},startXr:function(a,b,c){this.system.app.xr.start(this,a,b,c)},endXr:function(a){this.camera.xr?this.camera.xr.end(a):a&&a(Error("Camera is not in XR"))}});var Je;Object.assign(jg.prototype,{_createOffscreenTarget:function(a,b){var c=this.camera.rect,
d=Math.floor(c.z*this.app.graphicsDevice.width*this.renderTargetScale);c=Math.floor(c.w*this.app.graphicsDevice.height*this.renderTargetScale);var e=this.app.graphicsDevice,g=b?e.getHdrFormat():7;b=this.app.graphicsDevice.supportsStencil;var f=a?e.samples:1;d=new L(e,{format:g,width:d,height:c});d.name="posteffect #"+this.effects.length;d.minFilter=0;d.magFilter=0;d.addressU=1;d.addressV=1;return new oa(this.app.graphicsDevice,d,{depth:a,stencil:b,samples:f})},_resizeOffscreenTarget:function(a){var b=
this.camera.rect,c=Math.floor(b.z*this.app.graphicsDevice.width*this.renderTargetScale);b=Math.floor(b.w*this.app.graphicsDevice.height*this.renderTargetScale);var d=this.app.graphicsDevice,e=a.colorBuffer.format;a._colorBuffer.destroy();c=new L(d,{format:e,width:c,height:b});c.name="posteffect";c.minFilter=0;c.magFilter=0;c.addressU=1;c.addressV=1;a._colorBuffer=c;a.destroy()},_destroyOffscreenTarget:function(a){a._colorBuffer&&a._colorBuffer.destroy();a._depthBuffer&&a._depthBuffer.destroy();a.destroy()},
setRenderTargetScale:function(a){this.renderTargetScale=a;this.resizeRenderTargets()},addEffect:function(a){var b=this.effects,c={effect:a,inputTarget:this._createOffscreenTarget(0===this.effects.length,a.hdr),outputTarget:null};if(!this.layer){this.layer=new fa({opaqueSortMode:0,transparentSortMode:0,passThrough:!0,name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:!1,onPostRender:function(){for(var a=0;a<this._commandList.length;a++)this._commandList[a]()}});var d=this.app.scene.layers.layerList,
e=0,g,f=d.length-1;for(g=f;0<=g;g--)if(4===d[g].id){f=g-1;this._origOverrideClear=d[g].overrideClear;this._origClearColorBuffer=d[g].clearColorBuffer;this._origDepthColorBuffer=d[g].clearDepthBuffer;this._origStencilColorBuffer=d[g].clearStencilBuffer;d[g].overrideClear=!0;d[g].clearColorBuffer=!1;d[g].clearDepthBuffer=this.camera.clearDepthBuffer;d[g].clearStencilBuffer=this.camera.clearStencilBuffer;break}this._sourceLayers=[];for(g=0;g<this.camera.layers.length;g++){d=this.camera.layers[g];var l=
this.app.scene.layers.getLayerById(d),h=this.app.scene.layers.layerList.indexOf(l);h<=f&&(1!=d&&(l.renderTarget=c.inputTarget,this._sourceLayers.push(l)),h>e&&(e=h))}this.app.scene.layers.insertOpaque(this.layer,e+1);this._sourceTarget=c.inputTarget;this.layer._commandList=[];this.layer.isPostEffect=!0}b.push(c);e=b.length;1<e&&(b[e-2].outputTarget=c.inputTarget);this._newPostEffect=a;a.needsDepthBuffer&&this._requestDepthMap();this.enable();this._newPostEffect=void 0},removeEffect:function(a){var b,
c=-1;var d=0;for(b=this.effects.length;d<b;d++)if(this.effects[d].effect===a){c=d;break}if(0<=c){if(0<c)this.effects[c-1].outputTarget=c+1<this.effects.length?this.effects[c+1].inputTarget:null;else if(1<this.effects.length)for(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),d=0;d<this._sourceLayers.length;d++)this._sourceLayers[d].renderTarget=
this.effects[1].inputTarget;this._destroyOffscreenTarget(this.effects[c].inputTarget);this.effects.splice(c,1)}this.enabled&&a.needsDepthBuffer&&this._releaseDepthMap();0===this.effects.length&&this.disable()},_requestDepthMaps:function(){for(var a=0,b=this.effects.length;a<b;a++){var c=this.effects[a].effect;this._newPostEffect!==c&&c.needsDepthBuffer&&this._requestDepthMap()}},_releaseDepthMaps:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].effect.needsDepthBuffer&&this._releaseDepthMap()},
_requestDepthMap:function(){Je||(Je=this.app.scene.layers.getLayerById(1));Je&&Je.incrementCounter()},_releaseDepthMap:function(){Je&&Je.decrementCounter()},destroy:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].inputTarget.destroy();this.effects.length=0;this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var a=this;this._requestDepthMaps();this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this);this.command=function(){if(a.enabled){var b=
null,c=a.effects.length;if(c){a.layer.renderTarget=a.effects[0].inputTarget;for(var d=0;d<c;d++){var e=a.effects[d];d===c-1&&(b=a.camera.rect);e.effect.render(e.inputTarget,e.outputTarget,b)}}}};this.layer._commandList.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1;this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this);this._releaseDepthMaps();this._destroyOffscreenTarget(this._sourceTarget);var a=this.layer._commandList.indexOf(this.command);0<=a&&this.layer._commandList.splice(a,
1);var b=this.app.scene.layers.layerList,c=b.length-1;for(a=0;a<=b.length;a++)if(4===b[a].id){c=a-1;b[a].overrideClear=this._origOverrideClear;b[a].clearColorBuffer=this._origClearColorBuffer;b[a].clearDepthBuffer=this._origDepthColorBuffer;b[a].clearStencilBuffer=this._origStencilColorBuffer;break}for(a=c;0<=a;a--)0<=b[a].cameras.indexOf(this.camera)&&(b[a].renderTarget=void 0);this.app.scene.layers.removeOpaque(this.layer);this.layer=null}},_onCanvasResized:function(a,b){a=this.camera.rect;b=this.app.graphicsDevice;
this.camera.camera.aspectRatio=b.width*a.z/(b.height*a.w);this.resizeTimeout||(100<zb()-this.resizeLast?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))},resizeRenderTargets:function(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null);this.resizeLast=zb();var a=this.camera.rect,b=Math.floor(a.z*this.app.graphicsDevice.width*this.renderTargetScale);a=Math.floor(a.w*this.app.graphicsDevice.height*this.renderTargetScale);for(var c=
this.effects,d=0,e=c.length;d<e;d++){var g=c[d];g.inputTarget.width===b&&g.inputTarget.height===a||this._resizeOffscreenTarget(g.inputTarget)}},onCameraRectChanged:function(a,b,c){this.enabled&&this.resizeRenderTargets()}});var Xl="enabled clearColorBuffer clearColor clearDepthBuffer clearStencilBuffer frustumCulling projection fov orthoHeight nearClip farClip priority rect scissorRect camera aspectRatio aspectRatioMode horizontalFov model renderTarget calculateTransform calculateProjection cullFaces flipFaces layers".split(" "),
le=function(a){B.call(this,a);this.id="camera";this.description="Renders the scene from the location of the Entity.";this.ComponentType=Ob;this.DataType=en;this.schema=Xl;this.cameras=[];this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",this.onRemove,this);this.app.on("prerender",this.onPrerender,this);B.bind("update",this.onUpdate,this)};le.prototype=Object.create(B.prototype);le.prototype.constructor=le;G._buildAccessors(Ob.prototype,Xl);Object.assign(le.prototype,{initializeComponentData:function(a,
b,c){c="postEffects enabled model camera aspectRatio aspectRatioMode horizontalFov renderTarget clearColor fov orthoHeight nearClip farClip projection priority clearColorBuffer clearDepthBuffer clearStencilBuffer frustumCulling rect scissorRect calculateTransform calculateProjection cullFaces flipFaces layers".split(" ");for(var d={},e=0,g=c.length;e<g;e++){var f=c[e];d[f]=b[f]}d.layers&&"array"===za(d.layers)&&(d.layers=d.layers.slice(0));d.clearColor&&"array"===za(d.clearColor)&&(b=d.clearColor,
d.clearColor=new J(b[0],b[1],b[2],b[3]));d.rect&&"array"===za(d.rect)&&(b=d.rect,d.rect=new U(b[0],b[1],b[2],b[3]));d.scissorRect&&"array"===za(d.scissorRect)&&(b=d.scissorRect,d.scissorRect=new U(b[0],b[1],b[2],b[3]));d.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),d.enabled=d.activate);d.camera=new Pa;d._node=a.entity;d.camera._component=a;d.camera.calculateTransform=function(b,c){return a._calculateTransform?a._calculateTransform(b,c):null};
d.camera.calculateProjection=function(b,c){return a._calculateProjection?a._calculateProjection(b,c):null};d.postEffects=new jg(this.app,a);B.prototype.initializeComponentData.call(this,a,d,c)},onBeforeRemove:function(a,b){this.removeCamera(b);b.onRemove()},onRemove:function(a,b){b.camera=null},onUpdate:function(a){a=this.store;if(this.app.vr)for(var b in a){var c=a[b];var d=c.data;var e=d.camera;var g=e.vrDisplay;d.enabled&&c.entity.enabled&&g&&(g.setClipPlanes(e._nearClip,e._farClip),e._node&&(e._node.localTransform.copy(g.combinedViewInv),
e._node._dirtyLocal=!1,e._node._dirtifyWorld()))}},onPrerender:function(){for(var a=0,b=this.cameras.length;a<b;a++)this.cameras[a].onPrerender()},addCamera:function(a){this.cameras.push(a);this.sortCamerasByPriority()},removeCamera:function(a){a=this.cameras.indexOf(a);0<=a&&(this.cameras.splice(a,1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort(function(a,b){return a.priority-b.priority})}});var Kd=function(a,b){G.call(this,a,b);this._compoundParent=null;this.entity.on("insert",
this._onInsert,this);this.on("set_type",this.onSetType,this);this.on("set_halfExtents",this.onSetHalfExtents,this);this.on("set_radius",this.onSetRadius,this);this.on("set_height",this.onSetHeight,this);this.on("set_axis",this.onSetAxis,this);this.on("set_asset",this.onSetAsset,this);this.on("set_model",this.onSetModel,this)};Kd.prototype=Object.create(G.prototype);Kd.prototype.constructor=Kd;Object.assign(Kd.prototype,{onSetType:function(a,b,c){b!==c&&this.system.changeType(this,b,c)},onSetHalfExtents:function(a,
b,c){a=this.data.type;this.data.initialized&&"box"===a&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(a,b,c){a=this.data.type;!this.data.initialized||"sphere"!==a&&"capsule"!==a&&"cylinder"!==a&&"cone"!==a||this.system.recreatePhysicalShapes(this)},onSetHeight:function(a,b,c){a=this.data.type;!this.data.initialized||"capsule"!==a&&"cylinder"!==a&&"cone"!==a||this.system.recreatePhysicalShapes(this)},onSetAxis:function(a,b,c){a=this.data.type;!this.data.initialized||"capsule"!==a&&
"cylinder"!==a&&"cone"!==a||this.system.recreatePhysicalShapes(this)},onSetAsset:function(a,b,c){a=this.system.app.assets;b&&(b=a.get(b))&&b.off("remove",this.onAssetRemoved,this);c&&(c instanceof X&&(this.data.asset=c.id),b=a.get(this.data.asset))&&(b.off("remove",this.onAssetRemoved,this),b.on("remove",this.onAssetRemoved,this));this.data.initialized&&"mesh"===this.data.type&&(c||(this.data.model=null),this.system.recreatePhysicalShapes(this))},onSetModel:function(a,b,c){this.data.initialized&&
"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);this.data.asset===a.id&&(this.asset=null)},_getCompoundChildShapeIndex:function(a){for(var b=this.data.shape,c=b.getNumChildShapes(),d=0;d<c;d++)if(b.getChildShape(d).ptr===a.ptr)return d;return null},_onInsert:function(a){if("undefined"!==typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody)for(a=
this.entity.parent;a;){if(a.collision&&"compound"===a.collision.type){0===a.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(a.collision):this.system.recreatePhysicalShapes(this);break}a=a.parent}},_updateCompound:function(){var a=this.entity;if(a._dirtyWorld){for(var b=a._dirtyLocal,c=a;c&&!b&&(!c.collision||c.collision!==this._compoundParent);)c._dirtyLocal&&(b=!0),c=c.parent;b&&(a.forEach(this.system.implementations.compound._updateEachDescendantTransform,a),(a=this._compoundParent.entity.rigidbody)&&
a.activate())}},onEnable:function(){if("mesh"===this.data.type&&this.data.asset&&this.data.initialized){var a=this.system.app.assets.get(this.data.asset);if(a&&(!a.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}this.entity.rigidbody?this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation():this._compoundParent&&this!==this._compoundParent?0===this._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(this._compoundParent):(a=this.system._getNodeTransform(this.entity,
this._compoundParent.entity),this._compoundParent.shape.addChildShape(a,this.data.shape),Ammo.destroy(a),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.enable()},onDisable:function(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&
this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()},onBeforeRemove:function(){this.entity.off("insert",this._onInsert,this)}});var ge="static",yi=2,lg=65533,uc,af,ae;Object.assign(ri.prototype,{initialize:function(a){var b=this.entity;if((a=a.shape)&&"undefined"!==typeof Ammo){b.trigger&&b.trigger.destroy();var c=b.getPosition(),d=b.getRotation();uc.setValue(c.x,c.y,c.z);af.setValue(d.x,d.y,d.z,d.w);ae.setOrigin(uc);ae.setRotation(af);a=this.app.systems.rigidbody.createBody(1,
a,ae);a.setRestitution(0);a.setFriction(0);a.setDamping(0,0);uc.setValue(0,0,0);a.setLinearFactor(uc);a.setAngularFactor(uc);a.setCollisionFlags(a.getCollisionFlags()|4);a.entity=b;this.body=a;this.component.enabled&&b.enabled&&this.enable()}},destroy:function(){var a=this.body;a&&(this.disable(),this.app.systems.rigidbody.destroyBody(a))},_getEntityTransform:function(a){var b=this.entity.getPosition(),c=this.entity.getRotation();uc.setValue(b.x,b.y,b.z);af.setValue(c.x,c.y,c.z,c.w);a.setOrigin(uc);
a.setRotation(af)},updateTransform:function(){this._getEntityTransform(ae);var a=this.body;a.setWorldTransform(ae);a.activate()},enable:function(){var a=this.body;if(a){var b=this.app.systems;b.rigidbody.addBody(a,16,lg^16);b.rigidbody._triggers.push(this);a.forceActivationState(1);this.updateTransform()}},disable:function(){var a=this.body;if(a){var b=this.app.systems,c=b.rigidbody._triggers.indexOf(this);-1<c&&b.rigidbody._triggers.splice(c,1);b.rigidbody.removeBody(a);a.forceActivationState(5)}}});
var Wg=new C,Lo=new r,Mo=new T,Yl="enabled type halfExtents radius axis height asset shape model".split(" "),nc=function(a){this.system=a};Object.assign(nc.prototype,{beforeInitialize:function(a,b){b.shape=null;b.model=new gb;b.model.graph=new Z},afterInitialize:function(a,b){this.recreatePhysicalShapes(a);a.data.initialized=!0},reset:function(a,b){this.beforeInitialize(a,b);this.afterInitialize(a,b)},recreatePhysicalShapes:function(a){var b=a.entity,c=a.data;if("undefined"!==typeof Ammo){b.trigger&&
(b.trigger.destroy(),delete b.trigger);c.shape&&(a._compoundParent&&(this.system._removeCompoundChild(a._compoundParent,c.shape),a._compoundParent.entity.rigidbody&&a._compoundParent.entity.rigidbody.activate()),Ammo.destroy(c.shape),c.shape=null);c.shape=this.createPhysicalShape(a.entity,c);var d=!a._compoundParent;if("compound"===c.type&&(!a._compoundParent||a===a._compoundParent))a._compoundParent=a,b.forEach(this._addEachDescendant,a);else if("compound"!==c.type&&(a._compoundParent&&a===a._compoundParent&&
b.forEach(this.system.implementations.compound._updateEachDescendant,a),!a.rigidbody)){a._compoundParent=null;for(var e=b.parent;e;){if(e.collision&&"compound"===e.collision.type){a._compoundParent=e.collision;break}e=e.parent}}a._compoundParent&&a!==a._compoundParent&&(d&&0===a._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(a._compoundParent):(this.system.updateCompoundChildTransform(b),a._compoundParent.entity.rigidbody&&a._compoundParent.entity.rigidbody.activate()));
b.rigidbody?(b.rigidbody.disableSimulation(),b.rigidbody.createBody(),b.enabled&&b.rigidbody.enabled&&b.rigidbody.enableSimulation()):a._compoundParent||(b.trigger?b.trigger.initialize(c):b.trigger=new ri(this.system.app,a,c))}},createPhysicalShape:function(a,b){},updateTransform:function(a,b,c,d){a.entity.trigger&&a.entity.trigger.updateTransform()},beforeRemove:function(a,b){b.data.shape&&(b._compoundParent&&!b._compoundParent.entity._destroying&&(this.system._removeCompoundChild(b._compoundParent,
b.data.shape),b._compoundParent.entity.rigidbody&&b._compoundParent.entity.rigidbody.activate()),b._compoundParent=null,Ammo.destroy(b.data.shape),b.data.shape=null)},remove:function(a,b){var c=this.system.app;a.rigidbody&&a.rigidbody.body&&(c.systems.rigidbody.removeBody(a.rigidbody.body),a.rigidbody.disableSimulation());a.trigger&&(a.trigger.destroy(),delete a.trigger);c.scene.containsModel(b.model)&&(c.root.removeChild(b.model.graph),c.scene.removeModel(b.model))},clone:function(a,b){a=this.system.store[a.getGuid()];
return this.system.addComponent(b,{enabled:a.data.enabled,type:a.data.type,halfExtents:[a.data.halfExtents.x,a.data.halfExtents.y,a.data.halfExtents.z],radius:a.data.radius,axis:a.data.axis,height:a.data.height,asset:a.data.asset,model:a.data.model})}});var zf=function(a){this.system=a};zf.prototype=Object.create(nc.prototype);zf.prototype.constructor=zf;Object.assign(zf.prototype,{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return a=b.halfExtents,a=new Ammo.btVector3(a?a.x:.5,
a?a.y:.5,a?a.z:.5),b=new Ammo.btBoxShape(a),Ammo.destroy(a),b}});var Af=function(a){this.system=a};Af.prototype=Object.create(nc.prototype);Af.prototype.constructor=Af;Object.assign(Af.prototype,{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return new Ammo.btSphereShape(b.radius)}});var Bf=function(a){this.system=a};Bf.prototype=Object.create(nc.prototype);Bf.prototype.constructor=Bf;Object.assign(Bf.prototype,{createPhysicalShape:function(a,b){a=null;var c=void 0!==b.axis?b.axis:
1,d=b.radius||.5;b=Math.max((b.height||2)-2*d,0);if("undefined"!==typeof Ammo)switch(c){case 0:a=new Ammo.btCapsuleShapeX(d,b);break;case 1:a=new Ammo.btCapsuleShape(d,b);break;case 2:a=new Ammo.btCapsuleShapeZ(d,b)}return a}});var Cf=function(a){this.system=a};Cf.prototype=Object.create(nc.prototype);Cf.prototype.constructor=Cf;Object.assign(Cf.prototype,{createPhysicalShape:function(a,b){var c=a=null,d=void 0!==b.axis?b.axis:1,e=void 0!==b.radius?b.radius:.5;b=void 0!==b.height?b.height:1;if("undefined"!==
typeof Ammo)switch(d){case 0:a=new Ammo.btVector3(.5*b,e,e);c=new Ammo.btCylinderShapeX(a);break;case 1:a=new Ammo.btVector3(e,.5*b,e);c=new Ammo.btCylinderShape(a);break;case 2:a=new Ammo.btVector3(e,e,.5*b),c=new Ammo.btCylinderShapeZ(a)}a&&Ammo.destroy(a);return c}});var Df=function(a){this.system=a};Df.prototype=Object.create(nc.prototype);Df.prototype.constructor=Df;Object.assign(Df.prototype,{createPhysicalShape:function(a,b){a=null;var c=void 0!==b.axis?b.axis:1,d=void 0!==b.radius?b.radius:
.5;b=void 0!==b.height?b.height:1;if("undefined"!==typeof Ammo)switch(c){case 0:a=new Ammo.btConeShapeX(d,b);break;case 1:a=new Ammo.btConeShape(d,b);break;case 2:a=new Ammo.btConeShapeZ(d,b)}return a}});var Ef=function(a){this.system=a};Ef.prototype=Object.create(nc.prototype);Ef.prototype.constructor=Ef;Object.assign(Ef.prototype,{beforeInitialize:function(a,b){},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo&&b.model){var c=b.model;b=new Ammo.btCompoundShape;var d,e;for(d=0;d<c.meshInstances.length;d++){var g=
c.meshInstances[d],f=g.mesh;if(this.system._triMeshCache[f.id])var l=this.system._triMeshCache[f.id];else{l=f.indexBuffer[0];var h=f.vertexBuffer,p=h.getFormat(),n=p.size/4,m;for(e=0;e<p.elements.length;e++){var q=p.elements[e];"POSITION"===q.name&&(m=new Float32Array(h.lock(),q.offset))}h=new Uint16Array(l.lock());p=f.primitive[0].count/3;q=new Ammo.btVector3;var u=new Ammo.btVector3,r=new Ammo.btVector3,y=f.primitive[0].base;l=new Ammo.btTriangleMesh;this.system._triMeshCache[f.id]=l;for(e=0;e<
p;e++){f=h[y+3*e]*n;var w=h[y+3*e+1]*n;var v=h[y+3*e+2]*n;q.setValue(m[f],m[f+1],m[f+2]);u.setValue(m[w],m[w+1],m[w+2]);r.setValue(m[v],m[v+1],m[v+2]);l.addTriangle(q,u,r,!0)}Ammo.destroy(q);Ammo.destroy(u);Ammo.destroy(r)}e=new Ammo.btBvhTriangleMeshShape(l,!0);n=this.system._getNodeScaling(g.node);e.setLocalScaling(n);Ammo.destroy(n);g=this.system._getNodeTransform(g.node);b.addChildShape(g,e);Ammo.destroy(g)}a=a.getWorldTransform().getScale();a=new Ammo.btVector3(a.x,a.y,a.z);b.setLocalScaling(a);
Ammo.destroy(a);return b}},recreatePhysicalShapes:function(a){null!==a.data.asset&&a.enabled&&a.entity.enabled?this.loadModelAsset(a):this.doRecreatePhysicalShape(a)},loadModelAsset:function(a){var b=this,c=a.data.asset,d=a.data,e=this.system.app.assets,g=e.get(c);if(g)g.ready(function(c){d.model=c.resource;b.doRecreatePhysicalShape(a)}),e.load(g);else e.once("add:"+c,function(c){c.ready(function(c){d.model=c.resource;b.doRecreatePhysicalShape(a)});e.load(c)})},doRecreatePhysicalShape:function(a){var b=
a.entity,c=a.data;c.model?(this.destroyShape(c),c.shape=this.createPhysicalShape(b,c),b.rigidbody?(b.rigidbody.disableSimulation(),b.rigidbody.createBody(),b.enabled&&b.rigidbody.enabled&&b.rigidbody.enableSimulation()):b.trigger?b.trigger.initialize(c):b.trigger=new ri(this.system.app,a,c)):(this.beforeRemove(b,a),this.remove(b,c))},updateTransform:function(a,b,c,d){if(a.shape){var e=a.entity.getWorldTransform().getScale(),g=a.shape.getLocalScaling();e.x===g.x()&&e.y===g.y()&&e.z===g.z()||this.doRecreatePhysicalShape(a)}nc.prototype.updateTransform.call(this,
a,b,c,d)},destroyShape:function(a){if(a.shape){for(var b=a.shape.getNumChildShapes(),c=0;c<b;c++){var d=a.shape.getChildShape(c);Ammo.destroy(d)}Ammo.destroy(a.shape);a.shape=null}},remove:function(a,b){this.destroyShape(b);nc.prototype.remove.call(this,a,b)}});var Ff=function(a){this.system=a};Ff.prototype=Object.create(nc.prototype);Ff.prototype.constructor=Ff;Object.assign(Ff.prototype,{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return new Ammo.btCompoundShape},_addEachDescendant:function(a){a.collision&&
!a.rigidbody&&(a.collision._compoundParent=this,a!==this.entity&&a.collision.system.recreatePhysicalShapes(a.collision))},_updateEachDescendant:function(a){a.collision&&a.collision._compoundParent===this&&(a.collision._compoundParent=null,a===this.entity||a.rigidbody||a.collision.system.recreatePhysicalShapes(a.collision))},_updateEachDescendantTransform:function(a){a.collision&&a.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(a)}});
var ke=function(a){B.call(this,a);this.id="collision";this.description="Specifies a collision volume.";this.ComponentType=Kd;this.DataType=fn;this.schema=Yl;this.implementations={};this._triMeshCache={};this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",this.onRemove,this)};ke.prototype=Object.create(B.prototype);ke.prototype.constructor=ke;G._buildAccessors(Kd.prototype,Yl);Object.assign(ke.prototype,{initializeComponentData:function(a,b,c){c="type halfExtents radius axis height shape model asset enabled".split(" ");
for(var d={},e=0,g=c.length;e<g;e++){var f=c[e];d[f]=b[f]}b.hasOwnProperty("asset")?(b=c.indexOf("model"),-1!==b&&c.splice(b,1)):b.hasOwnProperty("model")&&(b=c.indexOf("asset"),-1!==b&&c.splice(b,1));d.type||(d.type=a.data.type);a.data.type=d.type;d.halfExtents&&"array"===za(d.halfExtents)&&(d.halfExtents=new r(d.halfExtents[0],d.halfExtents[1],d.halfExtents[2]));b=this._createImplementation(d.type);b.beforeInitialize(a,d);B.prototype.initializeComponentData.call(this.system,a,d,c);b.afterInitialize(a,
d)},_createImplementation:function(a){if(void 0===this.implementations[a]){switch(a){case "box":var b=new zf(this);break;case "sphere":b=new Af(this);break;case "capsule":b=new Bf(this);break;case "cylinder":b=new Cf(this);break;case "cone":b=new Df(this);break;case "mesh":b=new Ef(this);break;case "compound":b=new Ff(this)}this.implementations[a]=b}return this.implementations[a]},_getImplementation:function(a){return this.implementations[a.collision.data.type]},cloneComponent:function(a,b){return this._getImplementation(a).clone(a,
b)},onBeforeRemove:function(a,b){this.implementations[b.data.type].beforeRemove(a,b);b.onBeforeRemove()},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},updateCompoundChildTransform:function(a){this._removeCompoundChild(a.collision._compoundParent,a.collision.data.shape);if(a.enabled&&a.collision.enabled){var b=this._getNodeTransform(a,a.collision._compoundParent.entity);a.collision._compoundParent.shape.addChildShape(b,a.collision.data.shape);Ammo.destroy(b)}},_removeCompoundChild:function(a,
b){a.shape.removeChildShape?a.shape.removeChildShape(b):(b=a._getCompoundChildShapeIndex(b),null!==b&&a.shape.removeChildShapeByIndex(b))},onTransformChanged:function(a,b,c,d){this.implementations[a.data.type].updateTransform(a,b,c,d)},changeType:function(a,b,c){this.implementations[b].beforeRemove(a.entity,a);this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).reset(a,a.data)},recreatePhysicalShapes:function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)},
_calculateNodeRelativeTransform:function(a,b){a===b?(a=a.getWorldTransform().getScale(),Wg.setScale(a.x,a.y,a.z)):(this._calculateNodeRelativeTransform(a.parent,b),Wg.mul(a.getLocalTransform()))},_getNodeScaling:function(a){a=a.getWorldTransform().getScale();return new Ammo.btVector3(a.x,a.y,a.z)},_getNodeTransform:function(a,b){b?(this._calculateNodeRelativeTransform(a,b),b=Lo,a=Mo,Wg.getTranslation(b),a.setFromMat4(Wg)):(b=a.getPosition(),a=a.getRotation());var c=new Ammo.btTransform;c.setIdentity();
var d=c.getOrigin();d.setValue(b.x,b.y,b.z);b=new Ammo.btQuaternion;b.setValue(a.x,a.y,a.z,a.w);c.setRotation(b);Ammo.destroy(b);Ammo.destroy(d);return c},destroy:function(){for(var a in this._triMeshCache)Ammo.destroy(this._triMeshCache[a]);this._triMeshCache=null;B.prototype.destroy.call(this)}});Object.assign(si.prototype,{add:function(a){var b=a.id;if(this[b])throw Error("ComponentSystem name '"+b+"' already registered or not allowed");this[b]=a;this.list.push(a)},remove:function(a){a=a.id;if(!this[a])throw Error("No ComponentSystem named '"+
a+"' registered");delete this[a];a=this.list.indexOf(this[a]);-1!==a&&this.list.splice(a,1)}});var sk="group";pd.prototype.clone=function(){return new pd({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})};ob.prototype.destroy=function(){this.setMaterial(null);this._element.removeModelFromLayers(this.model);this.model.destroy();this._element=this._entity=this.meshInstance=this.mesh=this.node=this.model=null};ob.prototype.setMesh=
function(a){this.meshInstance&&(this.mesh=a,this.meshInstance.mesh=a,this.meshInstance.visible=!!a,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=a),this.forceUpdateAabb())};ob.prototype.setMask=function(a){if(this.meshInstance){if(a){this.unmaskMeshInstance=new ma(this.node,this.mesh,this.meshInstance.material);this.unmaskMeshInstance.name="Unmask: "+this._entity.name;this.unmaskMeshInstance.castShadow=!1;this.unmaskMeshInstance.receiveShadow=!1;this.unmaskMeshInstance.pick=!1;this.model.meshInstances.push(this.unmaskMeshInstance);
for(var b in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(b,this.meshInstance.parameters[b].data)}else a=this.model.meshInstances.indexOf(this.unmaskMeshInstance),0<=a&&this.model.meshInstances.splice(a,1),this.unmaskMeshInstance=null;this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}};ob.prototype.setMaterial=function(a){this.meshInstance&&(this.meshInstance.material=a,this.unmaskMeshInstance&&
(this.unmaskMeshInstance.material=a))};ob.prototype.setParameter=function(a,b){this.meshInstance&&(this.meshInstance.setParameter(a,b),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(a,b))};ob.prototype.deleteParameter=function(a){this.meshInstance&&(this.meshInstance.deleteParameter(a),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(a))};ob.prototype.setUnmaskDrawOrder=function(){if(this.meshInstance){var a=function(b){var c;b=b.children;var e=b.length;if(e){for(var g=
0;g<e;g++)b[g].element&&(c=b[g]);return c?(b=a(c))?b:c:null}return null};if(this.unmaskMeshInstance){var b=a(this._entity);this.unmaskMeshInstance.drawOrder=b&&b.element?b.element.drawOrder+b.element.getMaskOffset():this.meshInstance.drawOrder+this._element.getMaskOffset()}}};ob.prototype.setDrawOrder=function(a){this.meshInstance&&(this.meshInstance.drawOrder=a)};ob.prototype.setCull=function(a){if(this.meshInstance){var b=this._element,c=null;a&&b._isScreenCulled()&&(c=function(a){return b.isVisibleForCamera(a)});
this.meshInstance.cull=a;this.meshInstance.isVisibleFunc=c;this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=a,this.unmaskMeshInstance.isVisibleFunc=c)}};ob.prototype.setScreenSpace=function(a){this.meshInstance&&(this.meshInstance.screenSpace=a,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=a))};ob.prototype.setLayer=function(a){this.meshInstance&&(this.meshInstance.layer=a,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=a))};ob.prototype.forceUpdateAabb=function(a){this.meshInstance&&
(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))};ob.prototype.setAabbFunc=function(a){this.meshInstance&&(this.meshInstance._updateAabbFunc=a,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=a))};Object.assign(Ua.prototype,{destroy:function(){this.materialAsset=this.spriteAsset=this.textureAsset=null;this._renderable.setMesh(this._defaultMesh);this._renderable.destroy();this._defaultMesh=null;this._element.off("resize",this._onParentResizeOrPivotChange,
this);this._element.off("set:pivot",this._onParentResizeOrPivotChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("screen:set:resolution",this._onResolutionChange,this)},_onResolutionChange:function(a){},_onParentResizeOrPivotChange:function(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)},_onScreenSpaceChange:function(a){this._updateMaterial(a)},
_onScreenChange:function(a,b){a?this._updateMaterial(a.screen.screenSpace):this._updateMaterial(!1)},_onDrawOrderChange:function(a){this._renderable.setDrawOrder(a);if(this.mask&&this._element.screen)this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)},_hasUserMaterial:function(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)},_use9Slicing:function(){return this.sprite&&(1===this.sprite.renderMode||
2===this.sprite.renderMode)},_updateMaterial:function(a){var b=!!this._mask,c=!(!this.sprite||1!==this.sprite.renderMode),d=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(a,b,c,d));this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(a),this._renderable.setLayer(a?0:15))},_createMesh:function(){var a=this._element,b=a.calculatedWidth;a=a.calculatedHeight;
var c=this._rect,d=new ArrayBuffer(128),e=new Float32Array(d);e[5]=1;e[6]=c.x;e[7]=c.y;e[8]=b;e[13]=1;e[14]=c.x+c.z;e[15]=c.y;e[16]=b;e[17]=a;e[21]=1;e[22]=c.x+c.z;e[23]=c.y+c.w;e[25]=a;e[29]=1;e[30]=c.x;e[31]=c.y+c.w;c=this._system.app.graphicsDevice;e=new Ka(c,[{semantic:"POSITION",components:3,type:6},{semantic:"NORMAL",components:3,type:6},{semantic:"TEXCOORD0",components:2,type:6}]);d=new Za(c,e,4,0,d);c=new fb(c);c.vertexBuffer=d;c.primitive[0].type=6;c.primitive[0].base=0;c.primitive[0].count=
4;c.primitive[0].indexed=!1;c.aabb.setMinMax(r.ZERO,new r(b,a,0));this._updateMesh(c);return c},_updateMesh:function(a){var b=this._element,c=b.calculatedWidth,d=b.calculatedHeight,e=b._isScreenSpace();this._updateMaterial(e);this._renderable&&this._renderable.forceUpdateAabb();if(!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){var g=a.vertexBuffer,f=new Float32Array(g.lock());e=b.pivot.x;b=b.pivot.y;f[0]=-(e*c);f[1]=-(b*d);f[8]=c-e*c;f[9]=-(b*d);f[16]=c-e*c;f[17]=d-b*d;f[24]=
-(e*c);f[25]=d-b*d;var l=1,h=1,p=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var n=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];n&&(p=n.rect,l=this._sprite.atlas.texture.width,h=this._sprite.atlas.texture.height)}f[6]=p.x/l;f[7]=p.y/h;f[14]=(p.x+p.z)/l;f[15]=p.y/h;f[22]=(p.x+p.z)/l;f[23]=(p.y+p.w)/h;f[30]=p.x/l;f[31]=(p.y+p.w)/h;g.unlock();g=new r(-(e*c),-(b*d),0);c=new r(c-e*c,d-b*d,0);a.aabb.setMinMax(g,c);this._renderable&&
(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else a=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],e=2/a.rect.z,g=2/a.rect.w,this._innerOffset.set(a.border.x*e,a.border.y*g,a.border.z*e,a.border.w*g),e=this.sprite.atlas.texture,this._atlasRect.set(a.rect.x/e.width,a.rect.y/e.height,a.rect.z/e.width,a.rect.w/e.height),g=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,e=a.rect.z/
g,a=a.rect.w/g,this._outerScale.set(Math.max(c,this._innerOffset.x*e),Math.max(d,this._innerOffset.y*a)),g=a,this._outerScale.x/=e,this._outerScale.y/=a,e*=O.clamp(c/(this._innerOffset.x*e),1E-4,1),g*=O.clamp(d/(this._innerOffset.y*a),1E-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),
this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(e,g,1),this._renderable.node.setLocalPosition((.5-
b.pivot.x)*c,(.5-b.pivot.y)*d,0));this._meshDirty=!1},_updateSprite:function(){var a=!1,b=null;this._sprite&&this._sprite.atlas&&(b=this._sprite.meshes[this.spriteFrame],a=1===this._sprite.renderMode||2===this._sprite.renderMode);if(this.mesh=a?b:this._defaultMesh)this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh)},_updateAabb:function(a){a.center.set(0,0,0);a.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001);a.setFromTransformedAabb(a,this._renderable.node.getWorldTransform());
return a},_toggleMask:function(){this._element._dirtifyMask();var a=this._element._isScreenSpace();this._updateMaterial(a);this._renderable.setMask(!!this._mask)},_onMaterialLoad:function(a){this.material=a.resource},_onMaterialAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onMaterialAdded,this);this._materialAsset===a.id&&this._bindMaterialAsset(a)},_bindMaterialAsset:function(a){this._entity.enabled&&(a.on("load",this._onMaterialLoad,this),a.on("change",this._onMaterialChange,this),
a.on("remove",this._onMaterialRemove,this),a.resource?this._onMaterialLoad(a):this._system.app.assets.load(a))},_unbindMaterialAsset:function(a){a.off("load",this._onMaterialLoad,this);a.off("change",this._onMaterialChange,this);a.off("remove",this._onMaterialRemove,this)},_onMaterialChange:function(){},_onMaterialRemove:function(){},_onTextureAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onTextureAdded,this);this._textureAsset===a.id&&this._bindTextureAsset(a)},_bindTextureAsset:function(a){this._entity.enabled&&
(a.on("load",this._onTextureLoad,this),a.on("change",this._onTextureChange,this),a.on("remove",this._onTextureRemove,this),a.resource?this._onTextureLoad(a):this._system.app.assets.load(a))},_unbindTextureAsset:function(a){a.off("load",this._onTextureLoad,this);a.off("change",this._onTextureChange,this);a.off("remove",this._onTextureRemove,this)},_onTextureLoad:function(a){this.texture=a.resource},_onTextureChange:function(a){},_onTextureRemove:function(a){},_onSpriteAssetAdded:function(a){this._system.app.assets.off("add:"+
a.id,this._onSpriteAssetAdded,this);this._spriteAsset===a.id&&this._bindSpriteAsset(a)},_bindSpriteAsset:function(a){this._entity.enabled&&(a.on("load",this._onSpriteAssetLoad,this),a.on("change",this._onSpriteAssetChange,this),a.on("remove",this._onSpriteAssetRemove,this),a.resource?this._onSpriteAssetLoad(a):this._system.app.assets.load(a))},_unbindSpriteAsset:function(a){a.off("load",this._onSpriteAssetLoad,this);a.off("change",this._onSpriteAssetChange,this);a.off("remove",this._onSpriteAssetRemove,
this);a.data.textureAtlasAsset&&this._system.app.assets.off("load:"+a.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(a){if(a&&a.resource)if(a.resource.atlas)this.sprite=a.resource;else{if(a=a.data.textureAtlasAsset){var b=this._system.app.assets;b.off("load:"+a,this._onTextureAtlasLoad,this);b.once("load:"+a,this._onTextureAtlasLoad,this)}}else this.sprite=null},_onSpriteAssetChange:function(a){this._onSpriteAssetLoad(a)},_onSpriteAssetRemove:function(a){},_bindSprite:function(a){a.on("set:meshes",
this._onSpriteMeshesChange,this);a.on("set:pixelsPerUnit",this._onSpritePpuChange,this);a.on("set:atlas",this._onAtlasTextureChange,this);if(a.atlas)a.atlas.on("set:texture",this._onAtlasTextureChange,this)},_unbindSprite:function(a){a.off("set:meshes",this._onSpriteMeshesChange,this);a.off("set:pixelsPerUnit",this._onSpritePpuChange,this);a.off("set:atlas",this._onAtlasTextureChange,this);a.atlas&&a.atlas.off("set:texture",this._onAtlasTextureChange,this)},_onSpriteMeshesChange:function(){this._sprite&&
(this._spriteFrame=O.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1));this._updateSprite()},_onSpritePpuChange:function(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()},_onAtlasTextureChange:function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),
this._renderable.deleteParameter("texture_opacityMap"))},_onTextureAtlasLoad:function(a){a=this._spriteAsset;a instanceof X?this._onSpriteAssetLoad(a):this._onSpriteAssetLoad(this._system.app.assets.get(a))},onEnable:function(){var a;this._materialAsset&&(a=this._system.app.assets.get(this._materialAsset))&&a.resource!==this._material&&this._bindMaterialAsset(a);this._textureAsset&&(a=this._system.app.assets.get(this._textureAsset))&&a.resource!==this._texture&&this._bindTextureAsset(a);this._spriteAsset&&
(a=this._system.app.assets.get(this._spriteAsset))&&a.resource!==this._sprite&&this._bindSpriteAsset(a);this._element.addModelToLayers(this._renderable.model)},onDisable:function(){this._element.removeModelFromLayers(this._renderable.model)},_setStencil:function(a){this._renderable.meshInstance.stencilFront=a;this._renderable.meshInstance.stencilBack=a;a=0;this._element.maskedBy&&(a=this._element.maskedBy.element._image._maskRef);this._renderable.unmaskMeshInstance&&(a=new pd({ref:a+1,func:2,zpass:5}),
this._renderable.unmaskMeshInstance.stencilFront=a,this._renderable.unmaskMeshInstance.stencilBack=a)}});Object.defineProperty(Ua.prototype,"color",{get:function(){return this._color},set:function(a){var b=a.r,c=a.g;a=a.b;if(this._color.r!==b||this._color.g!==c||this._color.b!==a)this._color.r=b,this._color.g=c,this._color.b=a,this._colorUniform[0]=b,this._colorUniform[1]=c,this._colorUniform[2]=a,this._renderable.setParameter("material_emissive",this._colorUniform),this._element&&this._element.fire("set:color",
this._color)}});Object.defineProperty(Ua.prototype,"opacity",{get:function(){return this._color.a},set:function(a){a!==this._color.a&&(this._color.a=a,this._renderable.setParameter("material_opacity",a),this._element&&this._element.fire("set:opacity",a))}});Object.defineProperty(Ua.prototype,"rect",{get:function(){return this._rect},set:function(a){if(a instanceof U){var b=a.x;var c=a.y;var d=a.z;a=a.w}else b=a[0],c=a[1],d=a[2],a=a[3];if(b!==this._rect.x||c!==this._rect.y||d!==this._rect.z||a!==this._rect.w)this._rect.set(b,
c,d,a),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh))}});Object.defineProperty(Ua.prototype,"material",{get:function(){return this._material},set:function(a){this._material!==a&&(a||(a=this._element._isScreenSpace(),a=this.mask?a?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:a?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial),this._material=a)&&(this._renderable.setMaterial(a),
this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}});Object.defineProperty(Ua.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(a){var b=this._system.app.assets,
c=a;a instanceof X&&(c=a.id);this._materialAsset!==c&&(this._materialAsset&&(b.off("add:"+this._materialAsset,this._onMaterialAdded,this),a=b.get(this._materialAsset))&&(a.off("load",this._onMaterialLoad,this),a.off("change",this._onMaterialChange,this),a.off("remove",this._onMaterialRemove,this)),(this._materialAsset=c)?(c=b.get(this._materialAsset))?this._bindMaterialAsset(c):(this.material=null,b.on("add:"+this._materialAsset,this._onMaterialAdded,this)):this.material=null)}});Object.defineProperty(Ua.prototype,
"texture",{get:function(){return this._texture},set:function(a){if(this._texture!==a){if(this._textureAsset){var b=this._system.app.assets.get(this._textureAsset);b&&b.resource!==a&&(this.textureAsset=null)}(this._texture=a)?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,
this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}});Object.defineProperty(Ua.prototype,"textureAsset",{get:function(){return this._textureAsset},set:function(a){var b=this._system.app.assets,c=a;a instanceof X&&(c=a.id);this._textureAsset!==c&&(this._textureAsset&&(b.off("add:"+this._textureAsset,this._onTextureAdded,
this),a=b.get(this._textureAsset))&&(a.off("load",this._onTextureLoad,this),a.off("change",this._onTextureChange,this),a.off("remove",this._onTextureRemove,this)),(this._textureAsset=c)?(c=b.get(this._textureAsset))?this._bindTextureAsset(c):(this.texture=null,b.on("add:"+this._textureAsset,this._onTextureAdded,this)):this.texture=null)}});Object.defineProperty(Ua.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(a){var b=this._system.app.assets,c=a;a instanceof X&&(c=
a.id);this._spriteAsset!==c&&(this._spriteAsset&&(b.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this),(a=b.get(this._spriteAsset))&&this._unbindSpriteAsset(a)),(this._spriteAsset=c)?(a=b.get(this._spriteAsset))?this._bindSpriteAsset(a):(this.sprite=null,b.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null,this._element&&this._element.fire("set:spriteAsset",c))}});Object.defineProperty(Ua.prototype,"sprite",{get:function(){return this._sprite},set:function(a){if(this._sprite!==
a){this._sprite&&this._unbindSprite(this._sprite);if(this._spriteAsset){var b=this._system.app.assets.get(this._spriteAsset);b&&b.resource!==a&&(this.spriteAsset=null)}if(this._sprite=a)this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null);this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),
this._renderable.deleteParameter("texture_opacityMap"));this._sprite&&(this._spriteFrame=O.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1));this._updateSprite()}}});Object.defineProperty(Ua.prototype,"spriteFrame",{get:function(){return this._spriteFrame},set:function(a){var b=this._spriteFrame;this._spriteFrame=this._sprite?O.clamp(a,0,this._sprite.frameKeys.length-1):a;this._spriteFrame!==b&&(this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",a))}});Object.defineProperty(Ua.prototype,
"mesh",{get:function(){return this._renderable.mesh},set:function(a){this._renderable.setMesh(a);this._defaultMesh===a?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}});Object.defineProperty(Ua.prototype,"mask",{get:function(){return this._mask},set:function(a){this._mask!==a&&(this._mask=a,this._toggleMask())}});Object.defineProperty(Ua.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(a){this._pixelsPerUnit!==a&&(this._pixelsPerUnit=
a,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}});Object.defineProperty(Ua.prototype,"aabb",{get:function(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}});ya.prototype=Object.create(H.prototype);ya.prototype.constructor=ya;ya.prototype._bindDefaultAsset=function(){var a=this._app.assets.get(this._defaultAsset);if(a)this._onDefaultAssetAdd(a);else this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,
this)};ya.prototype._unbindDefaultAsset=function(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var a=this._app.assets.get(this._defaultAsset);a&&(a.off("add:localized",this._onLocaleAdd,this),a.off("remove:localized",this._onLocaleRemove,this),a.off("remove",this._onDefaultAssetRemove,this))}};ya.prototype._onDefaultAssetAdd=function(a){this._defaultAsset===a.id&&(a.on("add:localized",this._onLocaleAdd,this),a.on("remove:localized",this._onLocaleRemove,
this),a.once("remove",this._onDefaultAssetRemove,this))};ya.prototype._onDefaultAssetRemove=function(a){this._defaultAsset===a.id&&(a.off("add:localized",this._onLocaleAdd,this),a.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))};ya.prototype._bindLocalizedAsset=function(){if(this._autoLoad){var a=this._app.assets.get(this._localizedAsset);a&&(a.on("load",this._onLocalizedAssetLoad,this),a.on("change",this._onLocalizedAssetChange,
this),a.on("remove",this._onLocalizedAssetRemove,this),a.resource?this._onLocalizedAssetLoad(a):this._app.assets.load(a))}};ya.prototype._unbindLocalizedAsset=function(){var a=this._app.assets.get(this._localizedAsset);a&&(a.off("load",this._onLocalizedAssetLoad,this),a.off("change",this._onLocalizedAssetChange,this),a.off("remove",this._onLocalizedAssetRemove,this))};ya.prototype._onLocalizedAssetAdd=function(a){this._localizedAsset===a.id&&this._bindLocalizedAsset()};ya.prototype._onLocalizedAssetLoad=
function(a){this.fire("load",a)};ya.prototype._onLocalizedAssetChange=function(a,b,c,d){this.fire("change",a,b,c,d)};ya.prototype._onLocalizedAssetRemove=function(a){this._localizedAsset===a.id&&(this.localizedAsset=this._defaultAsset);this.fire("remove",a)};ya.prototype._onLocaleAdd=function(a,b){this._app.i18n.locale===a&&this._onSetLocale(a)};ya.prototype._onLocaleRemove=function(a,b){this._app.i18n.locale===a&&this._onSetLocale(a)};ya.prototype._onSetLocale=function(a){if(this._defaultAsset){var b=
this._app.assets.get(this._defaultAsset);this.localizedAsset=!b||this._disableLocalization?this._defaultAsset:(a=b.getLocalizedAssetId(a))?a:this._defaultAsset}else this.localizedAsset=null};ya.prototype.destroy=function(){this.defaultAsset=null;this._app.i18n.off("set:locale",this._onSetLocale,this);this.off()};Object.defineProperty(ya.prototype,"defaultAsset",{get:function(){return this._defaultAsset},set:function(a){a=a instanceof X?a.id:a;this._defaultAsset!==a&&(this._defaultAsset&&this._unbindDefaultAsset(),
(this._defaultAsset=a)&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}});Object.defineProperty(ya.prototype,"localizedAsset",{get:function(){return this._localizedAsset},set:function(a){a=a instanceof X?a.id:a;if(this._localizedAsset!==a&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=a))if(this._app.assets.get(this._localizedAsset))this._bindLocalizedAsset();
else this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)}});Object.defineProperty(ya.prototype,"autoLoad",{get:function(){return this._autoLoad},set:function(a){this._autoLoad!==a&&(this._autoLoad=a)&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset())}});Object.defineProperty(ya.prototype,"disableLocalization",{get:function(){return this._disableLocalization},set:function(a){this._disableLocalization!==a&&(this._disableLocalization=a,this._onSetLocale(this._app.i18n.locale))}});
Object.assign(ok.prototype,{EOF_TOKEN:0,ERROR_TOKEN:1,TEXT_TOKEN:2,OPEN_BRACKET_TOKEN:3,CLOSE_BRACKET_TOKEN:4,EQUALS_TOKEN:5,STRING_TOKEN:6,IDENTIFIER_TOKEN:7,WHITESPACE_TOKEN:8,WHITESPACE_CHARS:" \t\n\r\v\f",IDENTIFIER_REGEX:/[A-Z|a-z|0-9|_|-|/]/,read:function(){for(var a=this._read();a===this.WHITESPACE_TOKEN;)a=this._read();a!==this.EOF_TOKEN&&a!==this.ERROR_TOKEN&&(this._last=this._index);return a},buf:function(){return this._buf},last:function(){return this._last},error:function(){return this._error},
debugPrint:function(){for(var a="EOF ERROR TEXT OPEN_BRACKET CLOSE_BRACKET EQUALS STRING IDENTIFIER WHITESPACE".split(" "),b=this.read(),c="";;){c+=(0<c.length?"\n":"")+a[b]+" '"+this.buf().join("")+"'";if(b===this.EOF_TOKEN||b===this.ERROR_TOKEN)break;b=this.read()}return c},_read:function(){this._buf=[];return this._eof()?this.EOF_TOKEN:"text"===this._mode?this._text():this._tag()},_text:function(){for(;;)switch(this._cur){case null:return 0<this._buf.length?this.TEXT_TOKEN:this.EOF_TOKEN;case "[":return this._mode=
"tag",0<this._buf.length?this.TEXT_TOKEN:this._tag();case "\\":this._next();switch(this._cur){case "[":this._store();break;default:this._output("\\")}break;default:this._store()}},_tag:function(){for(;;)switch(this._cur){case null:return this._error="unexpected end of input reading tag",this.ERROR_TOKEN;case "[":return this._store(),this.OPEN_BRACKET_TOKEN;case "]":return this._store(),this._mode="text",this.CLOSE_BRACKET_TOKEN;case "=":return this._store(),this.EQUALS_TOKEN;case " ":case "\t":case "\n":case "\r":case "\v":case "\f":return this._whitespace();
case '"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",this.ERROR_TOKEN)}},_whitespace:function(){for(this._store();-1!==this.WHITESPACE_CHARS.indexOf(this._cur);)this._store();return this.WHITESPACE_TOKEN},_string:function(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",this.ERROR_TOKEN;case '"':return this._next(),this.STRING_TOKEN;default:this._store()}},
_identifier:function(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return this.IDENTIFIER_TOKEN},_isIdentifierSymbol:function(a){return 1===a.length&&null!==a.match(this.IDENTIFIER_REGEX)},_eof:function(){return null===this._cur},_next:function(){this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null);return this._cur},_store:function(){this._buf.push(this._cur);return this._next()},_output:function(a){this._buf.push(a)}});
var qk=function(a){this._scanner=new ok(a);this._error=null};Object.assign(qk.prototype,{parse:function(a,b){for(;;)switch(this._scanner.read()){case this._scanner.EOF_TOKEN:return!0;case this._scanner.ERROR_TOKEN:return!1;case this._scanner.TEXT_TOKEN:Array.prototype.push.apply(a,this._scanner.buf());break;case this._scanner.OPEN_BRACKET_TOKEN:if(!this._parseTag(a,b))return!1;break;default:return!1}},error:function(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||
this._error)+")"},_parseTag:function(a,b){var c=this._scanner.read();if(c!==this._scanner.IDENTIFIER_TOKEN)return this._error="expected identifier",!1;c=this._scanner.buf().join("");if("/"===c[0]){for(var d=b.length-1;0<=d;--d)if(c==="/"+b[d].name&&null===b[d].end)return b[d].end=a.length,c=this._scanner.read(),c!==this._scanner.CLOSE_BRACKET_TOKEN?(this._error="expected close bracket",!1):!0;this._error="failed to find matching tag";return!1}a={name:c,value:null,attributes:{},start:a.length,end:null};
c=this._scanner.read();if(c===this._scanner.EQUALS_TOKEN){c=this._scanner.read();if(c!==this._scanner.STRING_TOKEN)return this._error="expected string",!1;a.value=this._scanner.buf().join("");c=this._scanner.read()}for(;;){switch(c){case this._scanner.CLOSE_BRACKET_TOKEN:return b.push(a),!0;case this._scanner.IDENTIFIER_TOKEN:d=this._scanner.buf().join("");c=this._scanner.read();if(c!==this._scanner.EQUALS_TOKEN)return this._error="expected equals",!1;c=this._scanner.read();if(c!==this._scanner.STRING_TOKEN)return this._error=
"expected string",!1;c=this._scanner.buf().join("");a.attributes[d]=c;break;default:return this._error="expected close bracket or identifier",!1}c=this._scanner.read()}}});rk.evaluate=function(a){return jn(a)};var Zl=/^[\r\n]$/,No=/^[ \t]$/,Oo=/^[ \t\-]$/;Object.assign(ha.prototype,{destroy:function(){this._setMaterial(null);this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null);this._fontAsset.destroy();this.font=null;this._element.off("resize",this._onParentResize,
this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("set:pivot",this._onPivotChange,this);this._system.app.i18n.off("set:locale",this._onLocaleSet,this);this._system.app.i18n.off("data:add",this._onLocalizationData,this);this._system.app.i18n.off("data:remove",this._onLocalizationData,this)},_onParentResize:function(a,b){this._noResize||
this._font&&this._updateText()},_onScreenChange:function(a){a?this._updateMaterial(a.screen.screenSpace):this._updateMaterial(!1)},_onScreenSpaceChange:function(a){this._updateMaterial(a)},_onDrawOrderChange:function(a){this._drawOrder=a;if(this._model){var b;var c=0;for(b=this._model.meshInstances.length;c<b;c++)this._model.meshInstances[c].drawOrder=a}},_onPivotChange:function(a){this._font&&this._updateText()},_onLocaleSet:function(a){this._i18nKey&&(this.fontAsset&&(a=this._system.app.assets.get(this.fontAsset),
a&&a.resource&&a.resource===this._font||(this.font=null)),this._resetLocalizedText())},_onLocalizationData:function(a,b){this._i18nKey&&b[this._i18nKey]&&this._resetLocalizedText()},_resetLocalizedText:function(){this._setText(this._system.app.i18n.getText(this._i18nKey))},_setText:function(a){if(this.unicodeConverter){var b=this._system.getUnicodeConverter();b?a=b(a):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==a&&(this._font&&
this._updateText(a),this._text=a)},_updateText:function(a){var b;void 0===a&&(a=this._text);this._symbols=dc.getSymbols(a);0===this._symbols.length&&(this._symbols=[" "]);if(this._enableMarkup){a=rk.evaluate(this._symbols);this._symbols=a.symbols;var c=a.tags}this._rtlReorder?(a=this._system.app.systems.element.getRtlReorder())?(a=a(this._symbols),this._rtl=a.rtl,this._symbols=a.mapping.map(function(a){return this._symbols[a]},this),c&&(c=a.mapping.map(function(a){return c[a]}))):console.warn("Element created with rtlReorder option but no rtlReorder function registered"):
this._rtl=!1;if(c){var d={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)];this._symbolColors=[];a=d[this._color.toString(!1).toLowerCase()]=0;for(b=this._symbols.length;a<b;++a){var e=c[a],g=0;e&&e.color&&e.color.value&&(e=e.color.value,7===e.length&&"#"===e[0]&&(e=e.substring(1).toLowerCase(),d.hasOwnProperty(e)?g=d[e]:/^([0-9a-f]{2}){3}$/.test(e)&&(g=this._colorPalette.length/3,d[e]=g,this._colorPalette.push(parseInt(e.substring(0,
2),16)),this._colorPalette.push(parseInt(e.substring(2,4),16)),this._colorPalette.push(parseInt(e.substring(4,6),16)))));this._symbolColors.push(g)}}else this._colorPalette=[],this._symbolColors=null;d=this._calculateCharsPerTexture();g=!1;var f=this._element;e=f._isScreenSpace();var l=f._isScreenCulled(),h=function(a){return f.isVisibleForCamera(a)};a=0;for(b=this._meshInfo.length;a<b;a++){var p=d[a]||0,n=this._meshInfo[a];if(n.count!==p)if(g||(f.removeModelFromLayers(this._model),g=!0),n.count=
p,n.positions.length=n.normals.length=12*p,n.indices.length=6*p,n.uvs.length=8*p,n.colors.length=16*p,n.meshInstance&&(this._removeMeshInstance(n.meshInstance),n.meshInstance.material=null),0===p)n.meshInstance=null;else{for(var m=0;m<p;m++)n.indices[6*m]=4*m,n.indices[6*m+1]=4*m+1,n.indices[6*m+2]=4*m+3,n.indices[6*m+3]=4*m+2,n.indices[6*m+4]=4*m+3,n.indices[6*m+5]=4*m+1,n.normals[12*m]=0,n.normals[12*m+1]=0,n.normals[12*m+2]=-1,n.normals[12*m+3]=0,n.normals[12*m+4]=0,n.normals[12*m+5]=-1,n.normals[12*
m+6]=0,n.normals[12*m+7]=0,n.normals[12*m+8]=-1,n.normals[12*m+9]=0,n.normals[12*m+10]=0,n.normals[12*m+11]=-1;p=Eb(this._system.app.graphicsDevice,n.positions,{uvs:n.uvs,normals:n.normals,colors:n.colors,indices:n.indices});p=new ma(this._node,p,this._material);p.name="Text Element: "+this._entity.name;p.castShadow=!1;p.receiveShadow=!1;p.cull=!e;p.screenSpace=e;p.drawOrder=this._drawOrder;l&&(p.cull=!0,p.isVisibleFunc=h);this._setTextureParams(p,this._font.textures[a]);this._symbolColors?(this._colorUniform[0]=
1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b);p.setParameter("material_emissive",this._colorUniform);p.setParameter("material_opacity",this._color.a);p.setParameter("font_sdfIntensity",this._font.intensity);p.setParameter("font_pxrange",this._getPxRange(this._font));p.setParameter("font_textureWidth",this._font.data.info.maps[a].width);this._outlineColorUniform[0]=this._outlineColor.r;
this._outlineColorUniform[1]=this._outlineColor.g;this._outlineColorUniform[2]=this._outlineColor.b;this._outlineColorUniform[3]=this._outlineColor.a;p.setParameter("outline_color",this._outlineColorUniform);p.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness);this._shadowColorUniform[0]=this._shadowColor.r;this._shadowColorUniform[1]=this._shadowColor.g;this._shadowColorUniform[2]=this._shadowColor.b;this._shadowColorUniform[3]=this._shadowColor.a;p.setParameter("shadow_color",
this._shadowColorUniform);m=this._font.data.info.maps[a].width/this._font.data.info.maps[a].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x;this._shadowOffsetUniform[1]=m*this._shadowOffsetScale*this._shadowOffset.y;p.setParameter("shadow_offset",this._shadowOffsetUniform);n.meshInstance=p;this._model.meshInstances.push(p)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy);g&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model);
this._updateMeshes();this._rangeStart=0;this._rangeEnd=this._symbols.length;this._updateRenderRange()},_removeMeshInstance:function(a){var b,c=a.mesh;if(c&&(c.vertexBuffer&&c.vertexBuffer.destroy(),c.indexBuffer)){var d=0;for(b=c.indexBuffer.length;d<b;d++)c.indexBuffer[d].destroy()}a=this._model.meshInstances.indexOf(a);-1!==a&&this._model.meshInstances.splice(a,1)},_setMaterial:function(a){var b;this._material=a;if(this._model){var c=0;for(b=this._model.meshInstances.length;c<b;c++)this._model.meshInstances[c].material=
a}},_updateMaterial:function(a){var b=this._element,c=b._isScreenCulled(),d=function(a){return b.isVisibleForCamera(a)};this._material=this._system.getTextElementMaterial(a,this._font&&"msdf"===this._font.type);if(this._model)for(var e=0,g=this._model.meshInstances.length;e<g;e++){var f=this._model.meshInstances[e];f.cull=!a;f.material=this._material;f.screenSpace=a;c?(f.cull=!0,f.isVisibleFunc=d):f.isVisibleFunc=null}},_updateMeshes:function(){function a(a,b,d){c._lineWidths.push(Math.abs(d));a=
a.slice(r>b?b+1:r,r>b?r+1:b);if(v)for(d=a.length;d--&&0<v;)Zl.test(a[d])&&(a.splice(d,1),v--);c._lineContents.push(a.join(""));l=0;h-=c._scaledLineHeight;m++;q=v=w=y=0;r=b}var b=this._font.data,c=this,d=Math.min(this._minFontSize,this._maxFontSize),e=this._maxFontSize,g=this._shouldAutoFit();g&&(this._fontSize=this._maxFontSize);var f=this._symbols.length,l=0,h=0,p=0,n=0,m=1,q=0,u=0,r=0,y=0,w=0,v=0,x=1E-4<=Math.abs(this._element.anchor.x-this._element.anchor.z),z=this._element.calculatedWidth;if(this.autoWidth&&
!x||!this._wrapLines)z=Number.POSITIVE_INFINITY;var A=0;x=0;for(var B=1,C,D,E,G=!0;G;){G=!1;this._scaledLineHeight=g?this._lineHeight*this._fontSize/(this._maxFontSize||1E-4):this._lineHeight;this.height=this.width=0;this._lineWidths=[];this._lineContents=[];n=p=h=l=0;m=1;v=w=y=r=u=q=0;B=this._fontSize/32;A=this._fontMinY*B;x=this._fontMaxY*B;for(E=0;E<this._meshInfo.length;E++)this._meshInfo[E].quad=0,this._meshInfo[E].lines={};var H=255,M=255,J=255;for(E=0;E<f;E++){C=this._symbols[E];var I=0,P=
0,K=0,N=1;D=b.chars[C];if(!D)if(b.chars[" "])D=b.chars[" "];else for(var L in b.chars){D=b.chars[L];break}if(D){var R=0;0<w&&(K=this._font.data.kerning)&&(K=K[dc.getCodePoint(this._symbols[E-1])||0])&&(R=K[dc.getCodePoint(this._symbols[E])||0]||0);K=D.scale||1;var S=(D.width+D.height)/2;N=B*S/K;K=(D.xadvance+R)*B;I=(D.xoffset-R)*B;P=D.yoffset*B}else console.error("Couldn't substitute missing character: '"+C+"'");if(S=Zl.test(C)){if(v++,0>this._maxLines||m<this._maxLines)a(this._symbols,E,n),u=E+1,
r=E+1}else{var T=No.test(C);R=this._meshInfo[D&&D.map||0];var U=l+this._spacing*K;if(U>z&&0<w&&!T&&(0>this._maxLines||m<this._maxLines))if(0===y)u=E,a(this._symbols,E,n);else{D=Math.max(E-u,0);if(1>=this._meshInfo.length)R.lines[m-1]-=D,R.quad-=D;else for(R=E,C=u;C<R;C++)K=b.chars[this._symbols[C]],K=this._meshInfo[K&&K.map||0],--K.lines[m-1],--K.quad;E-=D+1;a(this._symbols,u,q);continue}D=R.quad;R.lines[m-1]=D;var V=l-I,X=V+N;P=h-P;var Y=P+N;this._rtl&&(N=N-I-this._spacing*K-I,V-=N,X-=N);R.positions[12*
D]=V;R.positions[12*D+1]=P;R.positions[12*D+2]=p;R.positions[12*D+3]=X;R.positions[12*D+4]=P;R.positions[12*D+5]=p;R.positions[12*D+6]=X;R.positions[12*D+7]=Y;R.positions[12*D+8]=p;R.positions[12*D+9]=V;R.positions[12*D+10]=Y;R.positions[12*D+11]=p;this.width=Math.max(this.width,U);if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(N=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1E-4)),N=O.clamp(N,d,e),N!==this._element.fontSize)){this._fontSize=
N;G=!0;break}this.height=Math.max(this.height,x-(h+A));if(this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(N=O.clamp(this._fontSize-1,d,e),N!==this._element.fontSize)){this._fontSize=N;G=!0;break}l+=this._spacing*K;T||S||(n=l);Oo.test(C)&&(y++,q=n,u=E+1);w++;C=this._getUv(C);R.uvs[8*D]=C[0];R.uvs[8*D+1]=C[1];R.uvs[8*D+2]=C[2];R.uvs[8*D+3]=C[1];R.uvs[8*D+4]=C[2];R.uvs[8*D+5]=C[3];R.uvs[8*D+6]=C[0];R.uvs[8*D+7]=C[3];this._symbolColors&&(J=3*this._symbolColors[E],H=this._colorPalette[J],
M=this._colorPalette[J+1],J=this._colorPalette[J+2]);R.colors[16*D]=H;R.colors[16*D+1]=M;R.colors[16*D+2]=J;R.colors[16*D+3]=255;R.colors[16*D+4]=H;R.colors[16*D+5]=M;R.colors[16*D+6]=J;R.colors[16*D+7]=255;R.colors[16*D+8]=H;R.colors[16*D+9]=M;R.colors[16*D+10]=J;R.colors[16*D+11]=255;R.colors[16*D+12]=H;R.colors[16*D+13]=M;R.colors[16*D+14]=J;R.colors[16*D+15]=255;R.quad++}}G||r<f&&a(this._symbols,f,l)}this._noResize=!0;this.autoWidth=this._autoWidth;this.autoHeight=this._autoHeight;this._noResize=
!1;b=this._element.pivot.x;d=this._element.pivot.y;e=this._alignment.x;g=this._alignment.y;for(E=0;E<this._meshInfo.length;E++)if(0!==this._meshInfo[E].count){L=0;for(var Z in this._meshInfo[E].lines){f=this._meshInfo[E].lines[Z];z=this._lineWidths[parseInt(Z,10)];z=-b*this._element.calculatedWidth+e*(this._element.calculatedWidth-z)*(this._rtl?-1:1);p=(1-d)*this._element.calculatedHeight-x-(1-g)*(this._element.calculatedHeight-this.height);for(D=L;D<=f;D++)this._meshInfo[E].positions[12*D]+=z,this._meshInfo[E].positions[12*
D+3]+=z,this._meshInfo[E].positions[12*D+6]+=z,this._meshInfo[E].positions[12*D+9]+=z,this._meshInfo[E].positions[12*D+1]+=p,this._meshInfo[E].positions[12*D+4]+=p,this._meshInfo[E].positions[12*D+7]+=p,this._meshInfo[E].positions[12*D+10]+=p;if(this._rtl)for(D=L;D<=f;D++){L=12*D;for(p=0;4>p;++p)this._meshInfo[E].positions[L+3*p]=this._element.calculatedWidth-this._meshInfo[E].positions[L+3*p]+2*z;p=this._meshInfo[E].positions[L+3];n=this._meshInfo[E].positions[L+6];this._meshInfo[E].positions[L+
3]=this._meshInfo[E].positions[L+0];this._meshInfo[E].positions[L+6]=this._meshInfo[E].positions[L+9];this._meshInfo[E].positions[L+0]=p;this._meshInfo[E].positions[L+9]=n}L=f+1}f=4*this._meshInfo[E].count;z=4*this._meshInfo[E].quad;D=new Db(this._meshInfo[E].meshInstance.mesh.vertexBuffer);for(L=0;L<f;L++)L>=z?(D.element.POSITION.set(0,0,0),D.element.TEXCOORD0.set(0,0),D.element.COLOR.set(0,0,0,0)):(D.element.POSITION.set(this._meshInfo[E].positions[3*L],this._meshInfo[E].positions[3*L+1],this._meshInfo[E].positions[3*
L+2]),D.element.TEXCOORD0.set(this._meshInfo[E].uvs[2*L],this._meshInfo[E].uvs[2*L+1]),D.element.COLOR.set(this._meshInfo[E].colors[4*L],this._meshInfo[E].colors[4*L+1],this._meshInfo[E].colors[4*L+2],this._meshInfo[E].colors[4*L+3])),D.next();D.end();this._meshInfo[E].meshInstance.mesh.aabb.compute(this._meshInfo[E].positions);this._meshInfo[E].meshInstance._aabbVer=-1}this._aabbDirty=!0},_onFontRender:function(){this.font=this._font},_onFontLoad:function(a){this.font!==a.resource&&(this.font=a.resource)},
_onFontChange:function(a,b,c,d){if("data"===b)for(this._font.data=c,a=this._font.data.info.maps.length,b=0;b<a;b++)this._meshInfo[b]&&(c=this._meshInfo[b].meshInstance)&&(c.setParameter("font_sdfIntensity",this._font.intensity),c.setParameter("font_pxrange",this._getPxRange(this._font)),c.setParameter("font_textureWidth",this._font.data.info.maps[b].width))},_onFontRemove:function(a){},_setTextureParams:function(a,b){this._font&&("msdf"===this._font.type?(a.deleteParameter("texture_emissiveMap"),
a.deleteParameter("texture_opacityMap"),a.setParameter("texture_msdfMap",b)):"bitmap"===this._font.type&&(a.deleteParameter("texture_msdfMap"),a.setParameter("texture_emissiveMap",b),a.setParameter("texture_opacityMap",b)))},_getPxRange:function(a){a=Object.keys(this._font.data.chars);for(var b=0;b<a.length;b++){var c=this._font.data.chars[a[b]];if(c.range)return(c.scale||1)*c.range}return 2},_getUv:function(a){var b=this._font.data;if(!b.chars[a])return b.chars[" "]?this._getUv(" "):[0,0,0,0];var c=
b.chars[a].map,d=b.info.maps[c].width;c=b.info.maps[c].height;var e=b.chars[a].x,g=b.chars[a].y,f=1-b.chars[a].height/c;return[e/d,f-g/c,(e+b.chars[a].width)/d,f-(g-b.chars[a].height)/c]},onEnable:function(){this._fontAsset.autoLoad=!0;this._model&&this._element.addModelToLayers(this._model)},onDisable:function(){this._fontAsset.autoLoad=!1;this._model&&this._element.removeModelFromLayers(this._model)},_setStencil:function(a){if(this._model)for(var b=this._model.meshInstances,c=0;c<b.length;c++)b[c].stencilFront=
a,b[c].stencilBack=a},_shouldAutoFitWidth:function(){return this._autoFitWidth&&!this._autoWidth},_shouldAutoFitHeight:function(){return this._autoFitHeight&&!this._autoHeight},_shouldAutoFit:function(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight},_calculateCharsPerTexture:function(a){var b={};void 0===a&&(a=this._symbols.length);var c;for(c=0;c<a;c++){var d=this._symbols[c];d=this._font.data.chars[d];d||(d=this._font.data.chars[" "])||(d=this._font.data.chars[Object.keys(this._font.data.chars)[0]]);
d=d.map;b[d]?b[d]++:b[d]=1}return b},_updateRenderRange:function(){var a=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),b=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd),c;var d=0;for(c=this._meshInfo.length;d<c;d++){var e=a[d]||0,g=b[d]||0,f=this._meshInfo[d].meshInstance;f&&(f=f.mesh)&&(f.primitive[0].base=6*e,f.primitive[0].count=6*(g-e))}}});Object.defineProperty(ha.prototype,"text",{get:function(){return this._text},set:function(a){this._i18nKey=null;
this._setText(a&&a.toString()||"")}});Object.defineProperty(ha.prototype,"key",{get:function(){return this._i18nKey},set:function(a){a=null!==a?a.toString():null;this._i18nKey!==a&&((this._i18nKey=a)?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}});Object.defineProperty(ha.prototype,"color",{get:function(){return this._color},set:function(a){var b=a.r,c=a.g;a=a.b;if(this._color.r!==b||this._color.g!==c||this._color.b!==a)if(this._color.r=
b,this._color.g=c,this._color.b=a,this._symbolColors)this._font&&this._updateText();else for(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("material_emissive",this._colorUniform)}});Object.defineProperty(ha.prototype,"opacity",{get:function(){return this._color.a},set:function(a){if(this._color.a!==a&&(this._color.a=a,this._model))for(var b=0,c=this._model.meshInstances.length;b<
c;b++)this._model.meshInstances[b].setParameter("material_opacity",a)}});Object.defineProperty(ha.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(a){var b=this._lineHeight;this._scaledLineHeight=this._lineHeight=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(ha.prototype,"wrapLines",{get:function(){return this._wrapLines},set:function(a){var b=this._wrapLines;this._wrapLines=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(ha.prototype,
"lines",{get:function(){return this._lineContents}});Object.defineProperty(ha.prototype,"spacing",{get:function(){return this._spacing},set:function(a){var b=this._spacing;this._spacing=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(ha.prototype,"fontSize",{get:function(){return this._fontSize},set:function(a){var b=this._fontSize;this._originalFontSize=this._fontSize=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(ha.prototype,"fontAsset",{get:function(){return this._fontAsset.localizedAsset},
set:function(a){this._fontAsset.defaultAsset=a}});Object.defineProperty(ha.prototype,"font",{get:function(){return this._font},set:function(a){if(this._font){var b=this._font.type;this._font.off&&this._font.off("render",this._onFontRender,this)}this._font=a;this._fontMaxY=this._fontMinY=0;if(a){var c=this._font.data,d;for(d in c.chars){var e=c.chars[d];e.bounds&&(this._fontMinY=Math.min(this._fontMinY,e.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,e.bounds[3]))}if(this._font.on)this._font.on("render",
this._onFontRender,this);this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null);a.type!==b&&(a=this._element._isScreenSpace(),this._updateMaterial(a));a=0;for(b=this._font.textures.length;a<b;a++)if(this._meshInfo[a]){if(c=this._meshInfo[a].meshInstance)c.setParameter("font_sdfIntensity",this._font.intensity),c.setParameter("font_pxrange",this._getPxRange(this._font)),c.setParameter("font_textureWidth",
this._font.data.info.maps[a].width),this._setTextureParams(c,this._font.textures[a])}else this._meshInfo[a]=new kn;b=!1;for(a=this._font.textures.length;a<this._meshInfo.length;a++)this._meshInfo[a].meshInstance&&(b||(this._element.removeModelFromLayers(this._model),b=!0),this._removeMeshInstance(this._meshInfo[a].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length);this._updateText()}}});Object.defineProperty(ha.prototype,"alignment",
{get:function(){return this._alignment},set:function(a){a instanceof M?this._alignment.set(a.x,a.y):this._alignment.set(a[0],a[1]);this._font&&this._updateText()}});Object.defineProperty(ha.prototype,"autoWidth",{get:function(){return this._autoWidth},set:function(a){var b=this._autoWidth;(this._autoWidth=a)&&1E-4>Math.abs(this._element.anchor.x-this._element.anchor.z)&&(this._element.width=this.width);b!==a&&(a=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,a!==this._fontSize&&(this._fontSize=
a,this._font&&this._updateText()))}});Object.defineProperty(ha.prototype,"autoHeight",{get:function(){return this._autoHeight},set:function(a){var b=this._autoHeight;(this._autoHeight=a)&&1E-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height);b!==a&&(a=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,a!==this._fontSize&&(this._fontSize=a,this._font&&this._updateText()))}});Object.defineProperty(ha.prototype,"rtlReorder",{get:function(){return this._rtlReorder},
set:function(a){this._rtlReorder!==a&&(this._rtlReorder=a,this._font&&this._updateText())}});Object.defineProperty(ha.prototype,"unicodeConverter",{get:function(){return this._unicodeConverter},set:function(a){this._unicodeConverter!==a&&(this._unicodeConverter=a,this._setText(this._text))}});Object.defineProperty(ha.prototype,"aabb",{get:function(){if(this._aabbDirty){for(var a=!1,b=0;b<this._meshInfo.length;b++)this._meshInfo[b].meshInstance&&(a?this._aabb.add(this._meshInfo[b].meshInstance.aabb):
(this._aabb.copy(this._meshInfo[b].meshInstance.aabb),a=!0));this._aabbDirty=!1}return this._aabb}});Object.defineProperty(ha.prototype,"outlineColor",{get:function(){return this._outlineColor},set:function(a){var b=a instanceof J?a.r:a[0],c=a instanceof J?a.g:a[1],d=a instanceof J?a.b:a[2];a=a instanceof J?a.a:a[3];if(this._outlineColor.r!==b||this._outlineColor.g!==c||this._outlineColor.b!==d||this._outlineColor.a!==a)if(this._outlineColor.r=b,this._outlineColor.g=c,this._outlineColor.b=d,this._outlineColor.a=
a,this._model)for(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("outline_color",this._outlineColorUniform)}});Object.defineProperty(ha.prototype,"outlineThickness",{get:function(){return this._outlineThickness},set:function(a){var b=this._outlineThickness;this._outlineThickness=
a;if(b!==a&&this._font&&this._model)for(a=0,b=this._model.meshInstances.length;a<b;a++)this._model.meshInstances[a].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}});Object.defineProperty(ha.prototype,"shadowColor",{get:function(){return this._shadowColor},set:function(a){var b=a instanceof J?a.r:a[0],c=a instanceof J?a.g:a[1],d=a instanceof J?a.b:a[2];a=a instanceof J?a.a:a[3];if(this._shadowColor.r!==b||this._shadowColor.g!==c||this._shadowColor.b!==d||this._shadowColor.a!==
a)if(this._shadowColor.r=b,this._shadowColor.g=c,this._shadowColor.b=d,this._shadowColor.a=a,this._model)for(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("shadow_color",this._shadowColorUniform)}});Object.defineProperty(ha.prototype,"shadowOffset",{get:function(){return this._shadowOffset},
set:function(a){var b=a instanceof M?a.x:a[0];a=a instanceof M?a.y:a[1];if(this._shadowOffset.x!==b||this._shadowOffset.y!==a)if(this._shadowOffset.set(b,a),this._font&&this._model)for(b=0,a=this._model.meshInstances.length;b<a;b++){var c=this._font.data.info.maps[b].width/this._font.data.info.maps[b].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x;this._shadowOffsetUniform[1]=c*this._shadowOffsetScale*this._shadowOffset.y;this._model.meshInstances[b].setParameter("shadow_offset",
this._shadowOffsetUniform)}}});Object.defineProperty(ha.prototype,"minFontSize",{get:function(){return this._minFontSize},set:function(a){this._minFontSize!==a&&(this._minFontSize=a,this.font&&this._shouldAutoFit()&&this._updateText())}});Object.defineProperty(ha.prototype,"maxFontSize",{get:function(){return this._maxFontSize},set:function(a){this._maxFontSize!==a&&(this._maxFontSize=a,this.font&&this._shouldAutoFit()&&this._updateText())}});Object.defineProperty(ha.prototype,"autoFitWidth",{get:function(){return this._autoFitWidth},
set:function(a){this._autoFitWidth!==a&&(this._autoFitWidth=a,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}});Object.defineProperty(ha.prototype,"autoFitHeight",{get:function(){return this._autoFitHeight},set:function(a){this._autoFitHeight!==a&&(this._autoFitHeight=a,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}});Object.defineProperty(ha.prototype,"maxLines",{get:function(){return this._maxLines},
set:function(a){this._maxLines===a||null===a&&-1===this._maxLines||(this._maxLines=null===a?-1:a,this.font&&this._wrapLines&&this._updateText())}});Object.defineProperty(ha.prototype,"enableMarkup",{get:function(){return this._enableMarkup},set:function(a){a=!!a;this._enableMarkup!==a&&(this._enableMarkup=a,this.font&&this._updateText())}});Object.defineProperty(ha.prototype,"symbols",{get:function(){return this._symbols}});Object.defineProperty(ha.prototype,"symbolColors",{get:function(){return null===
this._symbolColors?null:this._symbolColors.map(function(a){return this._colorPalette.slice(3*a,3*a+3)},this)}});Object.defineProperty(ha.prototype,"rtl",{get:function(){return this._rtl}});Object.defineProperty(ha.prototype,"rangeStart",{get:function(){return this._rangeStart},set:function(a){a=Math.max(0,Math.min(a,this._symbols.length));a!==this._rangeStart&&(this._rangeStart=a,this._updateRenderRange())}});Object.defineProperty(ha.prototype,"rangeEnd",{get:function(){return this._rangeEnd},set:function(a){a=
Math.max(this._rangeStart,Math.min(a,this._symbols.length));a!==this._rangeEnd&&(this._rangeEnd=a,this._updateRenderRange())}});var oc=new r,Ld=new r,Pb=new C,Xg=new C,Yg=new C,Ke=new C;ba.prototype=Object.create(G.prototype);ba.prototype.constructor=ba;Object.assign(ba.prototype,{_patch:function(){this.entity._sync=this._sync;this.entity.setPosition=this._setPosition;this.entity.setLocalPosition=this._setLocalPosition},_unpatch:function(){this.entity._sync=S.prototype._sync;this.entity.setPosition=
S.prototype.setPosition;this.entity.setLocalPosition=S.prototype.setLocalPosition},_setPosition:function(){var a=new r,b=new C;return function(c,d,e){if(!this.element.screen)return S.prototype.setPosition.call(this,c,d,e);c instanceof r?a.copy(c):a.set(c,d,e);this.getWorldTransform();b.copy(this.element._screenToWorld).invert();b.transformPoint(a,this.localPosition);this._dirtyLocal||this._dirtifyLocal()}}(),_setLocalPosition:function(a,b,c){a instanceof r?this.localPosition.copy(a):this.localPosition.set(a,
b,c);a=this.element;b=this.localPosition;c=a._pivot;a._margin.x=b.x-a._calculatedWidth*c.x;a._margin.z=a._localAnchor.z-a._localAnchor.x-a._calculatedWidth-a._margin.x;a._margin.y=b.y-a._calculatedHeight*c.y;a._margin.w=a._localAnchor.w-a._localAnchor.y-a._calculatedHeight-a._margin.y;this._dirtyLocal||this._dirtifyLocal()},_sync:function(){var a=this.element,b=a.screen;if(b){if(a._anchorDirty){var c=0,d=1;if(this._parent&&this._parent.element){var e=this._parent.element.calculatedWidth;var g=this._parent.element.calculatedHeight;
c=this._parent.element.pivot.x;d=this._parent.element.pivot.y}else g=b.screen.resolution,e=g.x/b.screen.scale,g=g.y/b.screen.scale;a._anchorTransform.setTranslate(e*(a.anchor.x-c),-(g*(d-a.anchor.y)),0);a._anchorDirty=!1;a._calculateLocalAnchors()}a._sizeDirty&&a._calculateSize(!1,!1)}this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),e=this.localPosition,c=a._pivot,a._margin.x=e.x-a._calculatedWidth*c.x,a._margin.z=a._localAnchor.z-a._localAnchor.x-
a._calculatedWidth-a._margin.x,a._margin.y=e.y-a._calculatedHeight*c.y,a._margin.w=a._localAnchor.w-a._localAnchor.y-a._calculatedHeight-a._margin.y,this._dirtyLocal=!1);if(!b)return this._dirtyWorld&&(a._cornersDirty=!0,a._canvasCornersDirty=!0,a._worldCornersDirty=!0),S.prototype._sync.call(this);this._dirtyWorld&&(null===this._parent?this.worldTransform.copy(this.localTransform):(this._parent.element?a._screenToWorld.mul2(this._parent.element._modelTransform,a._anchorTransform):a._screenToWorld.copy(a._anchorTransform),
a._modelTransform.mul2(a._screenToWorld,this.localTransform),b?(a._screenToWorld.mul2(b.screen._screenMatrix,a._screenToWorld),b.screen.screenSpace||a._screenToWorld.mul2(b.worldTransform,a._screenToWorld),this.worldTransform.mul2(a._screenToWorld,this.localTransform),e=a._parentWorldTransform,e.setIdentity(),(c=this._parent)&&c.element&&c!==b&&(Pb.setTRS(r.ZERO,c.getLocalRotation(),c.getLocalScale()),e.mul2(c.element._parentWorldTransform,Pb)),oc.set(0,0,this.localPosition.z),Ld.set(a._absLeft+a._pivot.x*
a.calculatedWidth,a._absBottom+a._pivot.y*a.calculatedHeight,0),Pb.setTranslate(-Ld.x,-Ld.y,-Ld.z),Xg.setTRS(oc,this.getLocalRotation(),this.getLocalScale()),Yg.setTranslate(Ld.x,Ld.y,Ld.z),a._screenTransform.mul2(a._parentWorldTransform,Yg).mul(Xg).mul(Pb),a._cornersDirty=!0,a._canvasCornersDirty=!0,a._worldCornersDirty=!0):this.worldTransform.copy(a._modelTransform)),this._dirtyWorld=!1)},_onInsert:function(a){a=this._parseUpToScreen();this.entity._dirtifyWorld();this._updateScreen(a.screen);this._dirtifyMask()},
_dirtifyMask:function(){for(var a=this.entity;a;){var b=a.parent;if((null===b||b.screen)&&a.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var c=this.system._prerender.indexOf(this.entity);0<=c&&this.system._prerender.splice(c,1);0>this.system._prerender.indexOf(a)&&this.system._prerender.push(a)}a=b}},_onPrerender:function(){for(var a=0;a<this.system._prerender.length;a++){var b=this.system._prerender[a];
b.element&&b.element.syncMask(1)}this.system._prerender.length=0},_bindScreen:function(a){a.on("set:resolution",this._onScreenResize,this);a.on("set:referenceresolution",this._onScreenResize,this);a.on("set:scaleblend",this._onScreenResize,this);a.on("set:screenspace",this._onScreenSpaceChange,this);a.on("remove",this._onScreenRemove,this)},_unbindScreen:function(a){a.off("set:resolution",this._onScreenResize,this);a.off("set:referenceresolution",this._onScreenResize,this);a.off("set:scaleblend",
this._onScreenResize,this);a.off("set:screenspace",this._onScreenSpaceChange,this);a.off("remove",this._onScreenRemove,this)},_updateScreen:function(a){this.screen&&this.screen!==a&&this._unbindScreen(this.screen.screen);var b=this.screen;(this.screen=a)&&this._bindScreen(this.screen.screen);this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("set:screen",this.screen,b);this._anchorDirty=!0;b=this.entity.children;for(var c=0,d=b.length;c<d;c++)b[c].element&&b[c].element._updateScreen(a);
this.screen&&this.screen.screen.syncDrawOrder()},syncMask:function(a){var b=this._parseUpToScreen();this._updateMask(b.mask,a)},_setMaskedBy:function(a){var b=this._image||this._text;if(a){var c=new pd({ref:a.element._image._maskRef,func:2});b&&b._setStencil&&b._setStencil(c);this._maskedBy=a}else b&&b._setStencil&&b._setStencil(null),this._maskedBy=null},_updateMask:function(a,b){var c;a?(this._setMaskedBy(a),this.mask&&(a=new pd({ref:a.element._image._maskRef,func:2,zpass:3}),this._image._setStencil(a),
this._image._maskRef=b,b++,a=this.entity)):(this._setMaskedBy(null),this.mask&&(a=new pd({ref:b,func:7,zpass:2}),this._image._setStencil(a),this._image._maskRef=b,b++,a=this.entity));var d=this.entity.children;var e=0;for(c=d.length;e<c;e++)d[e].element&&d[e].element._updateMask(a,b)},_parseUpToScreen:function(){for(var a={screen:null,mask:null},b=this.entity._parent;b&&!b.screen;)b.element&&b.element.mask&&!a.mask&&(a.mask=b),b=b.parent;b&&b.screen&&(a.screen=b);return a},_onScreenResize:function(a){this._worldCornersDirty=
this._cornersDirty=this._anchorDirty=!0;this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("screen:set:resolution",a)},_onScreenSpaceChange:function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)},_onScreenRemove:function(){this.screen&&!this.screen._destroying&&this._updateScreen(null)},_calculateLocalAnchors:function(){var a=1E3,b=1E3,c=this.entity._parent;c&&c.element?(a=c.element.calculatedWidth,b=c.element.calculatedHeight):this.screen&&(b=this.screen.screen.resolution,
c=this.screen.screen.scale,a=b.x/c,b=b.y/c);this._localAnchor.set(this._anchor.x*a,this._anchor.y*b,this._anchor.z*a,this._anchor.w*b)},getOffsetPosition:function(a,b){var c=this.entity.getLocalPosition().clone();c.x+=a;c.y+=b;this._screenToWorld.transformPoint(c,c);return c},onLayersChanged:function(a,b){this.addModelToLayers(this._image?this._image._model:this._text._model);a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",
this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||(this._image?a.addMeshInstances(this._image._model.meshInstances):this._text&&a.addMeshInstances(this._text._model.meshInstances))},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||(this._image?a.removeMeshInstances(this._image._model.meshInstances):this._text&&a.removeMeshInstances(this._text._model.meshInstances))},onEnable:function(){if(this._image)this._image.onEnable();if(this._text)this._text.onEnable();
if(this._group)this._group.onEnable();this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this);this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));0<=this._batchGroupId&&this.system.app.batcher.insert(Ta.ELEMENT,this.batchGroupId,this.entity);this.fire("enableelement")},onDisable:function(){this.system.app.scene.off("set:layers",
this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));if(this._image)this._image.onDisable();if(this._text)this._text.onDisable();if(this._group)this._group.onDisable();this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this);0<=this._batchGroupId&&this.system.app.batcher.remove(Ta.ELEMENT,this.batchGroupId,this.entity);this.fire("disableelement")},
onRemove:function(){this.entity.off("insert",this._onInsert,this);this._unpatch();this._image&&this._image.destroy();this._text&&this._text.destroy();this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this);this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder());this.off()},_calculateSize:function(a,b){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var c=this._absRight-this._absLeft,d=this._absTop-
this._absBottom;a?this._setWidth(c):this._setCalculatedWidth(c,!1);b?this._setHeight(d):this._setCalculatedHeight(d,!1);a=this.entity.getLocalPosition();a.x=this._margin.x+this._calculatedWidth*this._pivot.x;a.y=this._margin.y+this._calculatedHeight*this._pivot.y;this.entity.setLocalPosition(a);this._sizeDirty=!1}},_setWidth:function(a){this._width=a;this._setCalculatedWidth(a,!1);this.fire("set:width",this._width)},_setHeight:function(a){this._height=a;this._setCalculatedHeight(a,!1);this.fire("set:height",
this._height)},_setCalculatedWidth:function(a,b){1E-4>=Math.abs(a-this._calculatedWidth)||(this._calculatedWidth=a,this.entity._dirtifyLocal(),b&&(a=this.entity.getLocalPosition(),this._margin.x=a.x-this._calculatedWidth*this._pivot.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x),this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight))},_setCalculatedHeight:function(a,
b){1E-4>=Math.abs(a-this._calculatedHeight)||(this._calculatedHeight=a,this.entity._dirtifyLocal(),b&&(a=this.entity.getLocalPosition(),this._margin.y=a.y-this._calculatedHeight*this._pivot.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y),this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight))},_flagChildrenAsDirty:function(){var a,b=this.entity._children;var c=
0;for(a=b.length;c<a;c++)b[c].element&&(b[c].element._anchorDirty=!0,b[c].element._sizeDirty=!0)},addModelToLayers:function(a){var b;this._addedModels.push(a);for(var c=0;c<this.layers.length;c++)(b=this.system.app.scene.layers.getLayerById(this.layers[c]))&&b.addMeshInstances(a.meshInstances)},removeModelFromLayers:function(a){var b=this._addedModels.indexOf(a);0<=b&&this._addedModels.splice(b,1);for(var c=0;c<this.layers.length;c++)(b=this.system.app.scene.layers.getLayerById(this.layers[c]))&&
b.removeMeshInstances(a.meshInstances)},getMaskOffset:function(){var a=this.system.app.frame;this._offsetReadAt!==a&&(this._maskOffset=.5,this._offsetReadAt=a);a=this._maskOffset;this._maskOffset-=.001;return a},isVisibleForCamera:function(a){if(this.maskedBy){a=this.maskedBy.element.screenCorners;var b=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x));var c=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x));var d=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y));a=Math.max(Math.max(a[0].y,
a[1].y),Math.max(a[2].y,a[3].y))}else{b=this.system.app.graphicsDevice.width;var e=this.system.app.graphicsDevice.height;c=a._rect.width*b;d=a._rect.height*e;b*=a._rect.x;c=b+c;a=(1-a._rect.y)*e;d=a-d}e=this.screenCorners;var g=Math.min(Math.min(e[0].x,e[1].x),Math.min(e[2].x,e[3].x)),f=Math.min(Math.min(e[0].y,e[1].y),Math.min(e[2].y,e[3].y)),l=Math.max(Math.max(e[0].y,e[1].y),Math.max(e[2].y,e[3].y));return Math.max(Math.max(e[0].x,e[1].x),Math.max(e[2].x,e[3].x))<b||g>c||f>a||l<d?!1:!0},_isScreenSpace:function(){return this.screen&&
this.screen.screen?this.screen.screen.screenSpace:!1},_isScreenCulled:function(){return this.screen&&this.screen.screen?this.screen.screen.cull:!1}});Object.defineProperty(ba.prototype,"type",{get:function(){return this._type},set:function(a){a!==this._type&&(this._type=a,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),"image"===a?this._image=new Ua(this):"text"===a&&(this._text=new ha(this)))}});Object.defineProperty(ba.prototype,"layers",
{get:function(){return this._layers},set:function(a){var b,c,d;if(this._addedModels.length)for(b=0;b<this._layers.length;b++)if(d=this.system.app.scene.layers.getLayerById(this._layers[b]))for(c=0;c<this._addedModels.length;c++)d.removeMeshInstances(this._addedModels[c].meshInstances);this._layers=a;if(this.enabled&&this.entity.enabled&&this._addedModels.length)for(b=0;b<this._layers.length;b++)if(d=this.system.app.scene.layers.getLayerById(this._layers[b]))for(c=0;c<this._addedModels.length;c++)d.addMeshInstances(this._addedModels[c].meshInstances)}});
Object.defineProperty(ba.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(a){var b=0;this.screen&&(b=this.screen.screen.priority);16777215<a&&(a=16777215);this._drawOrder=(b<<24)+a;this.fire("set:draworder",this._drawOrder)}});Object.defineProperty(ba.prototype,"_absLeft",{get:function(){return this._localAnchor.x+this._margin.x}});Object.defineProperty(ba.prototype,"_absRight",{get:function(){return this._localAnchor.z-this._margin.z}});Object.defineProperty(ba.prototype,
"_absTop",{get:function(){return this._localAnchor.w-this._margin.w}});Object.defineProperty(ba.prototype,"_absBottom",{get:function(){return this._localAnchor.y+this._margin.y}});Object.defineProperty(ba.prototype,"margin",{get:function(){return this._margin},set:function(a){this._margin.copy(a);this._calculateSize(!0,!0);this.fire("set:margin",this._margin)}});Object.defineProperty(ba.prototype,"left",{get:function(){return this._margin.x},set:function(a){this._margin.x=a;var b=this.entity.getLocalPosition();
this._setWidth(this._absRight-(this._localAnchor.x+a));b.x=a+this._calculatedWidth*this._pivot.x;this.entity.setLocalPosition(b)}});Object.defineProperty(ba.prototype,"right",{get:function(){return this._margin.z},set:function(a){this._margin.z=a;var b=this.entity.getLocalPosition();this._setWidth(this._localAnchor.z-a-this._absLeft);b.x=this._localAnchor.z-this._localAnchor.x-a-this._calculatedWidth*(1-this._pivot.x);this.entity.setLocalPosition(b)}});Object.defineProperty(ba.prototype,"top",{get:function(){return this._margin.w},
set:function(a){this._margin.w=a;var b=this.entity.getLocalPosition();this._setHeight(this._localAnchor.w-a-this._absBottom);b.y=this._localAnchor.w-this._localAnchor.y-a-this._calculatedHeight*(1-this._pivot.y);this.entity.setLocalPosition(b)}});Object.defineProperty(ba.prototype,"bottom",{get:function(){return this._margin.y},set:function(a){this._margin.y=a;var b=this.entity.getLocalPosition();this._setHeight(this._absTop-(this._localAnchor.y+a));b.y=a+this._calculatedHeight*this._pivot.y;this.entity.setLocalPosition(b)}});
Object.defineProperty(ba.prototype,"width",{get:function(){return this._width},set:function(a){this._width=a;this._hasSplitAnchorsX||this._setCalculatedWidth(a,!0);this.fire("set:width",this._width)}});Object.defineProperty(ba.prototype,"height",{get:function(){return this._height},set:function(a){this._height=a;this._hasSplitAnchorsY||this._setCalculatedHeight(a,!0);this.fire("set:height",this._height)}});Object.defineProperty(ba.prototype,"calculatedWidth",{get:function(){return this._calculatedWidth},
set:function(a){this._setCalculatedWidth(a,!0)}});Object.defineProperty(ba.prototype,"calculatedHeight",{get:function(){return this._calculatedHeight},set:function(a){this._setCalculatedHeight(a,!0)}});Object.defineProperty(ba.prototype,"pivot",{get:function(){return this._pivot},set:function(a){var b=this._pivot.x,c=this._pivot.y;a instanceof M?this._pivot.set(a.x,a.y):this._pivot.set(a[0],a[1]);a=this._margin.x+this._margin.z;b=this._pivot.x-b;this._margin.x+=a*b;this._margin.z-=a*b;b=this._margin.y+
this._margin.w;c=this._pivot.y-c;this._margin.y+=b*c;this._margin.w-=b*c;this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0;this._calculateSize(!1,!1);this._flagChildrenAsDirty();this.fire("set:pivot",this._pivot)}});Object.defineProperty(ba.prototype,"anchor",{get:function(){return this._anchor},set:function(a){a instanceof U?this._anchor.set(a.x,a.y,a.z,a.w):this._anchor.set(a[0],a[1],a[2],a[3]);this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):
this._calculateLocalAnchors();this._anchorDirty=!0;this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:anchor",this._anchor)}});Object.defineProperty(ba.prototype,"_hasSplitAnchorsX",{get:function(){return.001<Math.abs(this._anchor.x-this._anchor.z)}});Object.defineProperty(ba.prototype,"_hasSplitAnchorsY",{get:function(){return.001<Math.abs(this._anchor.y-this._anchor.w)}});Object.defineProperty(ba.prototype,"aabb",{get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:
null}});Object.defineProperty(ba.prototype,"screenCorners",{get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var a=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0);this._screenCorners[1].set(this._absRight,this._absBottom,0);this._screenCorners[2].set(this._absRight,this._absTop,0);this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var b=this.screen.screen.screenSpace,
c=0;4>c;c++)this._screenTransform.transformPoint(this._screenCorners[c],this._screenCorners[c]),b&&this._screenCorners[c].scale(this.screen.screen.scale),a&&this._screenCorners[c].add(a);this._cornersDirty=!1;this._worldCornersDirty=this._canvasCornersDirty=!0;return this._screenCorners}});Object.defineProperty(ba.prototype,"canvasCorners",{get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var a=this.system.app.graphicsDevice,
b=this.screenCorners,c=a.canvas.clientWidth/a.width,d=a.canvas.clientHeight/a.height,e=0;4>e;e++)this._canvasCorners[e].set(b[e].x*c,(a.height-b[e].y)*d);this._canvasCornersDirty=!1;return this._canvasCorners}});Object.defineProperty(ba.prototype,"worldCorners",{get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var a=this.screenCorners;if(!this.screen.screen.screenSpace){Pb.copy(this.screen.screen._screenMatrix);Pb.data[13]=-Pb.data[13];Pb.mul2(this.screen.getWorldTransform(),
Pb);for(var b=0;4>b;b++)Pb.transformPoint(a[b],this._worldCorners[b])}}else a=this.entity.getLocalPosition(),Pb.setTranslate(-a.x,-a.y,-a.z),Xg.setTRS(r.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),Yg.setTranslate(a.x,a.y,a.z),Ke.copy(this.entity.parent.getWorldTransform()),Ke.mul(Yg).mul(Xg).mul(Pb),oc.set(a.x-this.pivot.x*this.calculatedWidth,a.y-this.pivot.y*this.calculatedHeight,a.z),Ke.transformPoint(oc,this._worldCorners[0]),oc.set(a.x+(1-this.pivot.x)*this.calculatedWidth,
a.y-this.pivot.y*this.calculatedHeight,a.z),Ke.transformPoint(oc,this._worldCorners[1]),oc.set(a.x+(1-this.pivot.x)*this.calculatedWidth,a.y+(1-this.pivot.y)*this.calculatedHeight,a.z),Ke.transformPoint(oc,this._worldCorners[2]),oc.set(a.x-this.pivot.x*this.calculatedWidth,a.y+(1-this.pivot.y)*this.calculatedHeight,a.z),Ke.transformPoint(oc,this._worldCorners[3]);this._worldCornersDirty=!1;return this._worldCorners}});Object.defineProperty(ba.prototype,"textWidth",{get:function(){return this._text?
this._text.width:0}});Object.defineProperty(ba.prototype,"textHeight",{get:function(){return this._text?this._text.height:0}});Object.defineProperty(ba.prototype,"useInput",{get:function(){return this._useInput},set:function(a){this._useInput!==a&&(this._useInput=a,this.system.app.elementInput&&(a?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this)),this.fire("set:useInput",a))}});Object.defineProperty(ba.prototype,"batchGroupId",
{get:function(){return this._batchGroupId},set:function(a){this._batchGroupId!==a&&(this.entity.enabled&&0<=this._batchGroupId&&this.system.app.batcher.remove(Ta.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&0<=a&&this.system.app.batcher.insert(Ta.ELEMENT,a,this.entity),0>a&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),
this._batchGroupId=a)}});Object.defineProperty(ba.prototype,"maskedBy",{get:function(){return this._maskedBy}});var ca=function(a){Object.defineProperty(ba.prototype,a,{get:function(){return this._text?this._text[a]:this._image?this._image[a]:null},set:function(b){this._text?this._text[a]=b:this._image&&(this._image[a]=b)}})};ca("fontSize");ca("minFontSize");ca("maxFontSize");ca("maxLines");ca("autoFitWidth");ca("autoFitHeight");ca("color");ca("font");ca("fontAsset");ca("spacing");ca("lineHeight");
ca("wrapLines");ca("lines");ca("alignment");ca("autoWidth");ca("autoHeight");ca("rtlReorder");ca("unicodeConverter");ca("text");ca("key");ca("texture");ca("textureAsset");ca("material");ca("materialAsset");ca("sprite");ca("spriteAsset");ca("spriteFrame");ca("pixelsPerUnit");ca("opacity");ca("rect");ca("mask");ca("outlineColor");ca("outlineThickness");ca("shadowColor");ca("shadowOffset");ca("enableMarkup");ca("rangeStart");ca("rangeEnd");var tk=["enabled"];be.prototype=Object.create(B.prototype);be.prototype.constructor=
be;G._buildAccessors(ba.prototype,tk);Object.assign(be.prototype,{destroy:function(){this._defaultTexture.destroy()},initializeComponentData:function(a,b,c){a._beingInitialized=!0;void 0!==b.anchor&&(b.anchor instanceof U?a.anchor.copy(b.anchor):a.anchor.set(b.anchor[0],b.anchor[1],b.anchor[2],b.anchor[3]));void 0!==b.pivot&&(b.pivot instanceof M?a.pivot.copy(b.pivot):a.pivot.set(b.pivot[0],b.pivot[1]));var d=.001<Math.abs(a.anchor.x-a.anchor.z),e=.001<Math.abs(a.anchor.y-a.anchor.w),g=!1;void 0!==
b.margin&&(b.margin instanceof U?a.margin.copy(b.margin):a._margin.set(b.margin[0],b.margin[1],b.margin[2],b.margin[3]),g=!0);void 0!==b.left&&(a._margin.x=b.left,g=!0);void 0!==b.bottom&&(a._margin.y=b.bottom,g=!0);void 0!==b.right&&(a._margin.z=b.right,g=!0);void 0!==b.top&&(a._margin.w=b.top,g=!0);g&&(a.margin=a._margin);g=!1;void 0===b.width||d?d&&(g=!0):a.width=b.width;void 0===b.height||e?e&&(g=!0):a.height=b.height;g&&(a.anchor=a.anchor);void 0!==b.enabled&&(a.enabled=b.enabled);void 0!==b.useInput&&
(a.useInput=b.useInput);a.batchGroupId=void 0===b.batchGroupId||null===b.batchGroupId?-1:b.batchGroupId;b.layers&&"array"===za(b.layers)&&(a.layers=b.layers.slice(0));a.type=b.type;"image"===a.type?(void 0!==b.rect&&(a.rect=b.rect),void 0!==b.color&&(d=b.color,d instanceof J||(d=new J(b.color[0],b.color[1],b.color[2])),a.color=d),void 0!==b.opacity&&(a.opacity=b.opacity),void 0!==b.textureAsset&&(a.textureAsset=b.textureAsset),b.texture&&(a.texture=b.texture),void 0!==b.spriteAsset&&(a.spriteAsset=
b.spriteAsset),b.sprite&&(a.sprite=b.sprite),void 0!==b.spriteFrame&&(a.spriteFrame=b.spriteFrame),void 0!==b.pixelsPerUnit&&null!==b.pixelsPerUnit&&(a.pixelsPerUnit=b.pixelsPerUnit),void 0!==b.materialAsset&&(a.materialAsset=b.materialAsset),b.material&&(a.material=b.material),void 0!==b.mask&&(a.mask=b.mask)):"text"===a.type&&(void 0!==b.autoWidth&&(a.autoWidth=b.autoWidth),void 0!==b.autoHeight&&(a.autoHeight=b.autoHeight),void 0!==b.rtlReorder&&(a.rtlReorder=b.rtlReorder),void 0!==b.unicodeConverter&&
(a.unicodeConverter=b.unicodeConverter),null!==b.text&&void 0!==b.text?a.text=b.text:null!==b.key&&void 0!==b.key&&(a.key=b.key),void 0!==b.color&&(d=b.color,d instanceof J||(d=new J(d[0],d[1],d[2])),a.color=d),void 0!==b.opacity&&(a.opacity=b.opacity),void 0!==b.spacing&&(a.spacing=b.spacing),void 0!==b.fontSize&&(a.fontSize=b.fontSize,b.lineHeight||(a.lineHeight=b.fontSize)),void 0!==b.lineHeight&&(a.lineHeight=b.lineHeight),void 0!==b.maxLines&&(a.maxLines=b.maxLines),void 0!==b.wrapLines&&(a.wrapLines=
b.wrapLines),void 0!==b.minFontSize&&(a.minFontSize=b.minFontSize),void 0!==b.maxFontSize&&(a.maxFontSize=b.maxFontSize),b.autoFitWidth&&(a.autoFitWidth=b.autoFitWidth),b.autoFitHeight&&(a.autoFitHeight=b.autoFitHeight),void 0!==b.fontAsset&&(a.fontAsset=b.fontAsset),void 0!==b.font&&(a.font=b.font),void 0!==b.alignment&&(a.alignment=b.alignment),void 0!==b.outlineColor&&(a.outlineColor=b.outlineColor),void 0!==b.outlineThickness&&(a.outlineThickness=b.outlineThickness),void 0!==b.shadowColor&&(a.shadowColor=
b.shadowColor),void 0!==b.shadowOffset&&(a.shadowOffset=b.shadowOffset),void 0!==b.enableMarkup&&(a.enableMarkup=b.enableMarkup));d=a._parseUpToScreen();d.screen&&a._updateScreen(d.screen);B.prototype.initializeComponentData.call(this,a,b,c);a._beingInitialized=!1;"image"===a.type&&a._image._meshDirty&&a._image._updateMesh(a._image.mesh)},onRemoveComponent:function(a,b){b.onRemove()},cloneComponent:function(a,b){a=a.element;var c={enabled:a.enabled,width:a.width,height:a.height,anchor:a.anchor.clone(),
pivot:a.pivot.clone(),margin:a.margin.clone(),alignment:a.alignment&&a.alignment.clone()||a.alignment,autoWidth:a.autoWidth,autoHeight:a.autoHeight,type:a.type,rect:a.rect&&a.rect.clone()||a.rect,rtlReorder:a.rtlReorder,unicodeConverter:a.unicodeConverter,materialAsset:a.materialAsset,material:a.material,color:a.color&&a.color.clone()||a.color,opacity:a.opacity,textureAsset:a.textureAsset,texture:a.texture,spriteAsset:a.spriteAsset,sprite:a.sprite,spriteFrame:a.spriteFrame,pixelsPerUnit:a.pixelsPerUnit,
spacing:a.spacing,lineHeight:a.lineHeight,wrapLines:a.wrapLines,layers:a.layers,fontSize:a.fontSize,minFontSize:a.minFontSize,maxFontSize:a.maxFontSize,autoFitWidth:a.autoFitWidth,autoFitHeight:a.autoFitHeight,maxLines:a.maxLines,fontAsset:a.fontAsset,font:a.font,useInput:a.useInput,batchGroupId:a.batchGroupId,mask:a.mask,outlineColor:a.outlineColor&&a.outlineColor.clone()||a.outlineColor,outlineThickness:a.outlineThickness,shadowColor:a.shadowColor&&a.shadowColor.clone()||a.shadowColor,shadowOffset:a.shadowOffset&&
a.shadowOffset.clone()||a.shadowOffset,enableMarkup:a.enableMarkup};void 0!==a.key&&null!==a.key?c.key=a.key:c.text=a.text;return this.addComponent(b,c)},getTextElementMaterial:function(a,b){if(a){if(b)return this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new ea,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=
!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=4,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),
this.defaultScreenSpaceTextMaterial;this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new ea,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=
this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=4,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=
!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update());return this.defaultScreenSpaceBitmapTextMaterial}if(b)return this.defaultTextMaterial||(this.defaultTextMaterial=new ea,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,
this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=4,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial;this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new ea,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=
!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=4,this.defaultBitmapTextMaterial.depthWrite=
!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update());return this.defaultBitmapTextMaterial},_createBaseImageMaterial:function(){var a=new ea;a.diffuse.set(0,0,0);a.emissive.set(.5,.5,.5);a.emissiveMap=this._defaultTexture;a.emissiveTint=!0;a.opacityMap=this._defaultTexture;a.opacityMapChannel="a";a.opacityTint=!0;a.opacity=0;a.useLighting=!1;a.useGammaTonemap=!1;a.useFog=!1;a.useSkybox=!1;a.blendType=4;a.depthWrite=!1;return a},getImageElementMaterial:function(a,
b,c,d){if(a){if(b){if(c)return this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=
!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial;if(d)return this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),
this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=
!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial;this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=
!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial));return this.defaultScreenSpaceImageMaskMaterial}if(c)return this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name=
"defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial;if(d)return this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name=
"defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial;this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",
this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial));return this.defaultScreenSpaceImageMaterial}if(b){if(c)return this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=
1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial;if(d)return this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name=
"defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial;this.defaultImageMaskMaterial||
(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial));return this.defaultImageMaskMaterial}if(c)return this.defaultImage9SlicedMaterial||
(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial;if(d)return this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",
this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial;this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial));return this.defaultImageMaterial},registerUnicodeConverter:function(a){this._unicodeConverter=
a},registerRtlReorder:function(a){this._rtlReorder=a},getUnicodeConverter:function(){return this._unicodeConverter},getRtlReorder:function(){return this._rtlReorder}});qd.prototype=Object.create(G.prototype);qd.prototype.constructor=qd;rd("minWidth");rd("minHeight");rd("maxWidth");rd("maxHeight");rd("fitWidthProportion");rd("fitHeightProportion");rd("excludeFromLayout");var $l=["enabled"],oe=function(a){B.call(this,a);this.id="layoutchild";this.ComponentType=qd;this.DataType=mn;this.schema=$l};oe.prototype=
Object.create(B.prototype);oe.prototype.constructor=oe;G._buildAccessors(qd.prototype,$l);Object.assign(oe.prototype,{initializeComponentData:function(a,b,c){void 0!==b.enabled&&(a.enabled=b.enabled);void 0!==b.minWidth&&(a.minWidth=b.minWidth);void 0!==b.minHeight&&(a.minHeight=b.minHeight);void 0!==b.maxWidth&&(a.maxWidth=b.maxWidth);void 0!==b.maxHeight&&(a.maxHeight=b.maxHeight);void 0!==b.fitWidthProportion&&(a.fitWidthProportion=b.fitWidthProportion);void 0!==b.fitHeightProportion&&(a.fitHeightProportion=
b.fitHeightProportion);void 0!==b.excludeFromLayout&&(a.excludeFromLayout=b.excludeFromLayout);B.prototype.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){a=a.layoutchild;return this.addComponent(b,{enabled:a.enabled,minWidth:a.minWidth,minHeight:a.minHeight,maxWidth:a.maxWidth,maxHeight:a.maxHeight,fitWidthProportion:a.fitWidthProportion,fitHeightProportion:a.fitHeightProportion,excludeFromLayout:a.excludeFromLayout})}});var ui=0,vk={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",
minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},on={0:1,1:0},nn={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},pb={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},
ub=new M,sj={};sj[0]=uk(0);sj[1]=uk(1);Object.assign(ti.prototype,{calculateLayout:function(a,b){var c=sj[b.orientation];if(c)return c(a,b);throw Error("Unrecognized orientation value: "+b.orientation);}});Pc.prototype=Object.create(G.prototype);Pc.prototype.constructor=Pc;Object.assign(Pc.prototype,{_isSelfOrChild:function(a){return a===this.entity||-1!==this.entity.children.indexOf(a)},_listenForReflowEvents:function(a,b){a.element&&(a.element[b]("enableelement",this._scheduleReflow,this),a.element[b]("disableelement",
this._scheduleReflow,this),a.element[b]("resize",this._scheduleReflow,this),a.element[b]("set:pivot",this._scheduleReflow,this));a.layoutchild&&(a.layoutchild[b]("set_enabled",this._scheduleReflow,this),a.layoutchild[b]("resize",this._scheduleReflow,this))},_onElementOrLayoutComponentAdd:function(a){this._isSelfOrChild(a)&&(this._listenForReflowEvents(a,"on"),this._scheduleReflow())},_onElementOrLayoutComponentRemove:function(a){this._isSelfOrChild(a)&&(this._listenForReflowEvents(a,"off"),this._scheduleReflow())},
_onChildInsert:function(a){this._listenForReflowEvents(a,"on");this._scheduleReflow()},_onChildRemove:function(a){this._listenForReflowEvents(a,"off");this._scheduleReflow()},_scheduleReflow:function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)},reflow:function(){var a=this.entity.element,b=this.entity.children.filter(qn).map(pn);a&&0!==b.length&&(a={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,
padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new M(Math.max(a.calculatedWidth,0),Math.max(a.calculatedHeight,0))},this._isPerformingReflow=!0,b=this._layoutCalculator.calculateLayout(b,a),this._isPerformingReflow=!1,this.fire("reflow",b))},onEnable:function(){this._scheduleReflow()},onRemove:function(){this.entity.off("childinsert",this._onChildInsert,this);this.entity.off("childremove",this._onChildRemove,
this);this._listenForReflowEvents(this.entity,"off");this.entity.children.forEach(function(a){this._listenForReflowEvents(a,"off")}.bind(this));this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this);this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,
this)}});vc("orientation");vc("reverseX");vc("reverseY");vc("alignment");vc("padding");vc("spacing");vc("widthFitting");vc("heightFitting");vc("wrap");var wk=["enabled"];ce.prototype=Object.create(B.prototype);ce.prototype.constructor=ce;G._buildAccessors(Pc.prototype,wk);Object.assign(ce.prototype,{initializeComponentData:function(a,b,c){void 0!==b.enabled&&(a.enabled=b.enabled);void 0!==b.orientation&&(a.orientation=b.orientation);void 0!==b.reverseX&&(a.reverseX=b.reverseX);void 0!==b.reverseY&&
(a.reverseY=b.reverseY);void 0!==b.alignment&&(b.alignment instanceof M?a.alignment.copy(b.alignment):a.alignment.set(b.alignment[0],b.alignment[1]),a.alignment=a.alignment);void 0!==b.padding&&(b.padding instanceof U?a.padding.copy(b.padding):a.padding.set(b.padding[0],b.padding[1],b.padding[2],b.padding[3]),a.padding=a.padding);void 0!==b.spacing&&(b.spacing instanceof M?a.spacing.copy(b.spacing):a.spacing.set(b.spacing[0],b.spacing[1]),a.spacing=a.spacing);void 0!==b.widthFitting&&(a.widthFitting=
b.widthFitting);void 0!==b.heightFitting&&(a.heightFitting=b.heightFitting);void 0!==b.wrap&&(a.wrap=b.wrap);B.prototype.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){a=a.layoutgroup;return this.addComponent(b,{enabled:a.enabled,orientation:a.orientation,reverseX:a.reverseX,reverseY:a.reverseY,alignment:a.alignment,padding:a.padding,spacing:a.spacing,widthFitting:a.widthFitting,heightFitting:a.heightFitting,wrap:a.wrap})},scheduleReflow:function(a){-1===this._reflowQueue.indexOf(a)&&
this._reflowQueue.push(a)},_onPostUpdate:function(){this._processReflowQueue()},_processReflowQueue:function(){if(0!==this._reflowQueue.length)for(var a=0;0<this._reflowQueue.length;){var b=this._reflowQueue.slice();this._reflowQueue.length=0;b.sort(function(a,b){return a.entity.graphDepth-b.entity.graphDepth});for(var c=0;c<b.length;++c)b[c].reflow();if(100<=++a){console.warn("Max reflow iterations limit reached, bailing.");break}}},_onRemoveComponent:function(a,b){b.onRemove()}});var Zg=new r,$g=
new r,tj=new r,uj={r:0,g:1,b:2,a:3},Oa=function(){this._type=0;this._color=new J(.8,.8,.8);this._intensity=1;this.enabled=this._castShadows=!1;this.mask=1;this.isStatic=!1;this.key=0;this.bakeDir=!0;this.attenuationEnd=this.attenuationStart=10;this._shadowType=this._falloffMode=0;this._vsmBlurSize=11;this.vsmBlurMode=1;this.vsmBias=.0025;this._cookie=null;this.cookieIntensity=1;this._cookieFalloff=!0;this._cookieChannel="rgb";this._cookieTransform=null;this._cookieTransformUniform=new Float32Array(4);
this._cookieOffset=null;this._cookieOffsetUniform=new Float32Array(2);this._cookieOffsetSet=this._cookieTransformSet=!1;this._innerConeAngle=40;this._outerConeAngle=45;this._finalColor=new Float32Array([.8,.8,.8]);var a=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([a,a,a]);this._position=new r(0,0,0);this._direction=new r(0,0,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180);this._shadowCamera=
null;this._shadowMatrix=new C;this.shadowDistance=40;this._shadowResolution=1024;this.shadowBias=-5E-4;this._normalOffsetBias=0;this.shadowUpdateMode=2;this._node=this._scene=null;this._rendererParams=[];this._isVsm=!1;this._isPcf=!0;this._isCachedShadowMap=this._cacheShadowMap=!1;this._visibleLength=[0];this._visibleList=[[]];this._visibleCameraSettings=[]};Object.assign(Oa.prototype,{destroy:function(){this._destroyShadowMap()},clone:function(){var a=new Oa;a.type=this._type;a.setColor(this._color);
a.intensity=this._intensity;a.castShadows=this.castShadows;a.enabled=this.enabled;a.attenuationStart=this.attenuationStart;a.attenuationEnd=this.attenuationEnd;a.falloffMode=this._falloffMode;a.shadowType=this._shadowType;a.vsmBlurSize=this._vsmBlurSize;a.vsmBlurMode=this.vsmBlurMode;a.vsmBias=this.vsmBias;a.shadowUpdateMode=this.shadowUpdateMode;a.mask=this.mask;a.innerConeAngle=this._innerConeAngle;a.outerConeAngle=this._outerConeAngle;a.shadowBias=this.shadowBias;a.normalOffsetBias=this._normalOffsetBias;
a.shadowResolution=this._shadowResolution;a.shadowDistance=this.shadowDistance;return a},getColor:function(){return this._color},getBoundingSphere:function(a){if(2===this._type){var b=this.attenuationEnd,c=this._outerConeAngle,d=Math.cos(c*O.DEG_TO_RAD),e=this._node;Zg.copy(e.up);Zg.scale(.5*-b*d);Zg.add(e.getPosition());a.center=Zg;$g.copy(e.up);$g.scale(-b);tj.copy(e.right);tj.scale(Math.sin(c*O.DEG_TO_RAD)*b);$g.add(tj);a.radius=.5*$g.length()}else 1===this._type&&(a.center=this._node.getPosition(),
a.radius=this.attenuationEnd)},getBoundingBox:function(a){if(2===this._type){var b=this.attenuationEnd,c=this._node,d=Math.abs(Math.sin(this._outerConeAngle*O.DEG_TO_RAD)*b);a.center.set(0,.5*-b,0);a.halfExtents.set(d,.5*b,d);a.setFromTransformedAabb(a,c.getWorldTransform())}else 1===this._type&&(a.center.copy(this._node.getPosition()),a.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))},_updateFinalColor:function(){var a=this._color,b=a.r,c=a.g;a=a.b;var d=this._intensity,
e=this._finalColor,g=this._linearFinalColor;e[0]=b*d;e[1]=c*d;e[2]=a*d;1<=d?(g[0]=Math.pow(b,2.2)*d,g[1]=Math.pow(c,2.2)*d,g[2]=Math.pow(a,2.2)*d):(g[0]=Math.pow(e[0],2.2),g[1]=Math.pow(e[1],2.2),g[2]=Math.pow(e[2],2.2))},setColor:function(){if(1===arguments.length){var a=arguments[0].r;var b=arguments[0].g;var c=arguments[0].b}else 3===arguments.length&&(a=arguments[0],b=arguments[1],c=arguments[2]);this._color.set(a,b,c);this._updateFinalColor()},_destroyShadowMap:function(){if(this._shadowCamera){if(!this._isCachedShadowMap){var a=
this._shadowCamera.renderTarget,b;if(a)if(a.length)for(b=0;b<a.length;b++)a[b].colorBuffer&&a[b].colorBuffer.destroy(),a[b].destroy();else a.colorBuffer&&a.colorBuffer.destroy(),a.depthBuffer&&a.depthBuffer.destroy(),a.destroy()}this._shadowCubeMap=this._shadowCamera=this._shadowCamera.renderTarget=null;0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)}},updateShadow:function(){2!==this.shadowUpdateMode&&(this.shadowUpdateMode=1)},updateKey:function(){var a=this._type<<29|(this._castShadows?1:
0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|uj[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12;3===this._cookieChannel.length&&(a|=uj[this._cookieChannel.charAt(1)]<<16,a|=uj[this._cookieChannel.charAt(2)]<<14);a!==this.key&&null!==this._scene&&(this._scene.layers._dirtyLights=!0);this.key=a}});Object.defineProperty(Oa.prototype,"type",{get:function(){return this._type},set:function(a){this._type!==
a&&(this._type=a,this._destroyShadowMap(),this.updateKey(),a=this._shadowType,this._shadowType=null,this.shadowType=a)}});Object.defineProperty(Oa.prototype,"shadowType",{get:function(){return this._shadowType},set:function(a){if(this._shadowType!==a){var b=Y.getApplication().graphicsDevice;1===this._type&&(a=0);4!==a||b.webgl2||(a=0);3!==a||b.textureFloatRenderable||(a=2);2!==a||b.textureHalfFloatRenderable||(a=1);this._isVsm=1<=a&&3>=a;this._isPcf=4===a||0===a;this._shadowType=a;this._destroyShadowMap();
this.updateKey()}}});Object.defineProperty(Oa.prototype,"castShadows",{get:function(){return this._castShadows&&4!==this.mask&&0!==this.mask},set:function(a){this._castShadows!==a&&(this._castShadows=a,this.updateKey())}});Object.defineProperty(Oa.prototype,"shadowResolution",{get:function(){return this._shadowResolution},set:function(a){if(this._shadowResolution!==a){var b=Y.getApplication().graphicsDevice;this._shadowResolution=a=1===this._type?Math.min(a,b.maxCubeMapSize):Math.min(a,b.maxTextureSize)}}});
Object.defineProperty(Oa.prototype,"vsmBlurSize",{get:function(){return this._vsmBlurSize},set:function(a){this._vsmBlurSize!==a&&(0===a%2&&a++,this._vsmBlurSize=a)}});Object.defineProperty(Oa.prototype,"normalOffsetBias",{get:function(){return this._normalOffsetBias},set:function(a){this._normalOffsetBias!==a&&((!this._normalOffsetBias&&a||this._normalOffsetBias&&!a)&&this.updateKey(),this._normalOffsetBias=a)}});Object.defineProperty(Oa.prototype,"falloffMode",{get:function(){return this._falloffMode},
set:function(a){this._falloffMode!==a&&(this._falloffMode=a,this.updateKey())}});Object.defineProperty(Oa.prototype,"innerConeAngle",{get:function(){return this._innerConeAngle},set:function(a){this._innerConeAngle!==a&&(this._innerConeAngle=a,this._innerConeAngleCos=Math.cos(a*Math.PI/180))}});Object.defineProperty(Oa.prototype,"outerConeAngle",{get:function(){return this._outerConeAngle},set:function(a){this._outerConeAngle!==a&&(this._outerConeAngle=a,this._outerConeAngleCos=Math.cos(a*Math.PI/
180))}});Object.defineProperty(Oa.prototype,"intensity",{get:function(){return this._intensity},set:function(a){this._intensity!==a&&(this._intensity=a,this._updateFinalColor())}});Object.defineProperty(Oa.prototype,"cookie",{get:function(){return this._cookie},set:function(a){this._cookie!==a&&(this._cookie=a,this.updateKey())}});Object.defineProperty(Oa.prototype,"cookieFalloff",{get:function(){return this._cookieFalloff},set:function(a){this._cookieFalloff!==a&&(this._cookieFalloff=a,this.updateKey())}});
Object.defineProperty(Oa.prototype,"cookieChannel",{get:function(){return this._cookieChannel},set:function(a){if(this._cookieChannel!==a){if(3>a.length)for(var b=a.charAt(a.length-1),c=3-a.length,d=0;d<c;d++)a+=b;this._cookieChannel=a;this.updateKey()}}});Object.defineProperty(Oa.prototype,"cookieTransform",{get:function(){return this._cookieTransform},set:function(a){this._cookieTransform!==a&&(this._cookieTransform=a,this._cookieTransformSet=!!a,a&&!this._cookieOffset&&(this.cookieOffset=new M,
this._cookieOffsetSet=!1),this.updateKey())}});Object.defineProperty(Oa.prototype,"cookieOffset",{get:function(){return this._cookieOffset},set:function(a){this._cookieOffset!==a&&((this._cookieTransformSet||a)&&!a&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=a,this._cookieOffsetSet=!!a,a&&!this._cookieTransform&&(this.cookieTransform=new U(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}});Qc.prototype=Object.create(G.prototype);Qc.prototype.constructor=Qc;var ah=[],
am=[],ja=function(a,b,c,d){var e=Qc.prototype;ah.push(a);am.push(b);Object.defineProperty(e,a,{get:function(){return this.data[a]},set:function(b){var e=this.data,g=e[a];if(d||g!==b)e[a]=b,c&&c.call(this,b,g)},configurable:!0})};(function(){ja("enabled",!0,function(a,b){this.onSetEnabled(null,b,a)});ja("light",null);ja("type","directional",function(a,b){this.system.changeType(this,b,a);this.refreshProperties()});ja("color",new J(1,1,1),function(a,b){this.light.setColor(a)},!0);ja("intensity",1,function(a,
b){this.light.intensity=a});ja("castShadows",!1,function(a,b){this.light.castShadows=a});ja("shadowDistance",40,function(a,b){this.light.shadowDistance=a});ja("shadowResolution",1024,function(a,b){this.light.shadowResolution=a});ja("shadowBias",.05,function(a,b){this.light.shadowBias=-.01*a});ja("normalOffsetBias",0,function(a,b){this.light.normalOffsetBias=a});ja("range",10,function(a,b){this.light.attenuationEnd=a});ja("innerConeAngle",40,function(a,b){this.light.innerConeAngle=a});ja("outerConeAngle",
45,function(a,b){this.light.outerConeAngle=a});ja("falloffMode",0,function(a,b){this.light.falloffMode=a});ja("shadowType",0,function(a,b){this.light.shadowType=a});ja("vsmBlurSize",11,function(a,b){this.light.vsmBlurSize=a});ja("vsmBlurMode",1,function(a,b){this.light.vsmBlurMode=a});ja("vsmBias",.0025,function(a,b){this.light.vsmBias=a});ja("cookieAsset",null,function(a,b){if(!this._cookieAssetId||!(a instanceof X&&a.id===this._cookieAssetId||a===this._cookieAssetId))if(this.onCookieAssetRemove(),
this._cookieAssetId=null,a instanceof X)this._cookieAssetId=this.data.cookieAsset=a.id,this.onCookieAssetAdd(a);else if("number"===typeof a)if(this._cookieAssetId=a,a=this.system.app.assets.get(a))this.onCookieAssetAdd(a);else this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this)});ja("cookie",null,function(a,b){this.light.cookie=a});ja("cookieIntensity",1,function(a,b){this.light.cookieIntensity=a});ja("cookieFalloff",!0,function(a,b){this.light.cookieFalloff=
a});ja("cookieChannel","rgb",function(a,b){this.light.cookieChannel=a});ja("cookieAngle",0,function(a,b){if(0!==a||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new U);var c=b=1;this.cookieScale&&(b=this.cookieScale.x,c=this.cookieScale.y);var d=Math.cos(a*O.DEG_TO_RAD);a=Math.sin(a*O.DEG_TO_RAD);this._cookieMatrix.set(d/b,-a/b,a/c,d/c);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null});ja("cookieScale",null,function(a,b){if(null!==a||0!==this.cookieAngle){this._cookieMatrix||
(this._cookieMatrix=new U);b=a.x;a=a.y;var c=Math.cos(this.cookieAngle*O.DEG_TO_RAD),d=Math.sin(this.cookieAngle*O.DEG_TO_RAD);this._cookieMatrix.set(c/b,-d/b,d/a,c/a);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0);ja("cookieOffset",null,function(a,b){this.light.cookieOffset=a},!0);ja("shadowUpdateMode",2,function(a,b){this.light.shadowUpdateMode=a});ja("mask",1,function(a,b){this.light.mask=a});ja("affectDynamic",!0,function(a,b){this.light.mask=a?this.light.mask|
1:this.light.mask&-2});ja("affectLightmapped",!1,function(a,b){a?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))});ja("bake",!1,function(a,b){a?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2))});ja("bakeDir",!0,function(a,b){this.light.bakeDir=a});ja("isStatic",!1,function(a,b){this.light.isStatic=a});ja("layers",[0],function(a,b){var c,d;for(c=0;c<b.length;c++)(d=
this.system.app.scene.layers.getLayerById(b[c]))&&d.removeLight(this);for(c=0;c<a.length;c++)(d=this.system.app.scene.layers.getLayerById(a[c]))&&this.enabled&&this.entity.enabled&&d.addLight(this)})})();Object.assign(Qc.prototype,{addLightToLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.addLight(this)},removeLightFromLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&
a.removeLight(this)},onLayersChanged:function(a,b){this.enabled&&this.entity.enabled&&this.addLightToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||this.enabled&&this.entity.enabled&&a.addLight(this)},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||a.removeLight(this)},refreshProperties:function(){for(var a,b=0;b<ah.length;b++)a=
ah[b],this[a]=this[a];if(this.enabled&&this.entity.enabled)this.onEnable()},updateShadow:function(){this.light.updateShadow()},onCookieAssetSet:function(){var a=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(a=this._cookieAsset.loadFaces=!0);this._cookieAsset.resource&&!a||this.system.app.assets.load(this._cookieAsset);if(this._cookieAsset.resource)this.onCookieAssetLoad()},onCookieAssetAdd:function(a){if(this._cookieAssetId===a.id){this._cookieAsset=a;if(this.light.enabled)this.onCookieAssetSet();
this._cookieAsset.on("load",this.onCookieAssetLoad,this);this._cookieAsset.on("remove",this.onCookieAssetRemove,this)}},onCookieAssetLoad:function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},onCookieAssetRemove:function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",
this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},onEnable:function(){this.light.enabled=!0;this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addLightToLayers();if(this._cookieAsset&&!this.cookie)this.onCookieAssetSet()},onDisable:function(){this.light.enabled=
!1;this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.removeLightFromLayers()},onRemove:function(){this.light.destroy();this.cookieAsset=null}});var vi=ah,tn=am,bm={directional:0,point:1,spot:2};de.prototype=Object.create(B.prototype);de.prototype.constructor=de;Object.assign(de.prototype,{initializeComponentData:function(a,
b){for(var c=vi,d={},e=0,g=c.length;e<g;e++){var f=c[e];d[f]=b[f]}d.type||(d.type=a.data.type);a.data.type=d.type;d.layers&&"array"===za(d.layers)&&(d.layers=d.layers.slice(0));d.color&&"array"===za(d.color)&&(d.color=new J(d.color[0],d.color[1],d.color[2]));d.cookieOffset&&d.cookieOffset instanceof Array&&(d.cookieOffset=new M(d.cookieOffset[0],d.cookieOffset[1]));d.cookieScale&&d.cookieScale instanceof Array&&(d.cookieScale=new M(d.cookieScale[0],d.cookieScale[1]));d.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),
d.enabled=d.enable);b=new Oa;b.type=bm[d.type];b._node=a.entity;b._scene=this.app.scene;a.data.light=b;B.prototype.initializeComponentData.call(this,a,d,c)},_onRemoveComponent:function(a,b){b.onRemove()},cloneComponent:function(a,b){a=a.light;for(var c=[],d,e=vi,g=0;g<e.length;g++)d=e[g],"light"!==d&&(c[d]=a[d]&&a[d].clone?a[d].clone():a[d]);this.addComponent(b,c)},changeType:function(a,b,c){b!==c&&(a.light.type=bm[c])}});Ca.prototype=Object.create(G.prototype);Ca.prototype.constructor=Ca;Object.assign(Ca.prototype,
{setVisible:function(a){console.warn("WARNING: setVisible: Function is deprecated. Set enabled property instead.");this.enabled=a},addModelToLayers:function(){for(var a,b=this.system.app.scene.layers,c=0;c<this._layers.length;c++)(a=b.getLayerById(this._layers[c]))&&a.addMeshInstances(this.meshInstances)},removeModelFromLayers:function(){for(var a,b=this.system.app.scene.layers,c=0;c<this._layers.length;c++)(a=b.getLayerById(this._layers[c]))&&a.removeMeshInstances(this.meshInstances)},onRemoveChild:function(){this._model&&
this.removeModelFromLayers()},onInsertChild:function(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()},onRemove:function(){"asset"===this.type?this.asset=null:this.model=null;this.materialAsset=null;this._unsetMaterialEvents();this.entity.off("remove",this.onRemoveChild,this);this.entity.off("insert",this.onInsertChild,this)},onLayersChanged:function(a,b){this.addModelToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,
this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||a.addMeshInstances(this.meshInstances)},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||a.removeMeshInstances(this.meshInstances)},_setMaterialEvent:function(a,b,c,d){b=b+":"+c;this.system.app.assets.on(b,d,this);this._materialEvents||(this._materialEvents=[]);this._materialEvents[a]||(this._materialEvents[a]={});this._materialEvents[a][b]={id:c,handler:d}},_unsetMaterialEvents:function(){var a=
this.system.app.assets,b=this._materialEvents;if(b){for(var c=0,d=b.length;c<d;c++)if(b[c]){var e=b[c],g;for(g in e)a.off(g,e[g].handler,this)}this._materialEvents=null}},_getAssetByIdOrPath:function(a){var b=null;isNaN(parseInt(a,10))?this.asset&&(a=this._getMaterialAssetUrl(a))&&(b=this.system.app.assets.getByUrl(a)):b=this.system.app.assets.get(a);return b},_getMaterialAssetUrl:function(a){if(!this.asset)return null;var b=this.system.app.assets.get(this.asset);return b?b.getAbsoluteUrl(a):null},
_loadAndSetMeshInstanceMaterial:function(a,b,c){var d=this.system.app.assets;a&&(a.resource?(b.material=a.resource,this._setMaterialEvent(c,"remove",a.id,function(){b.material=this.system.defaultMaterial})):(this._setMaterialEvent(c,"load",a.id,function(d){b.material=d.resource;this._setMaterialEvent(c,"remove",a.id,function(){b.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&d.load(a)))},onEnable:function(){var a=this.system.app,b=a.scene;b.on("set:layers",this.onLayersChanged,
this);b.layers&&(b.layers.on("add",this.onLayerAdded,this),b.layers.on("remove",this.onLayerRemoved,this));b="asset"===this._type;var c;this._model?this.addModelToLayers():b&&this._asset&&(c=a.assets.get(this._asset))&&c.resource!==this._model&&this._bindModelAsset(c);this._materialAsset&&(c=a.assets.get(this._materialAsset))&&c.resource!==this._material&&this._bindMaterialAsset(c);if(b&&this._mapping)for(var d in this._mapping)this._mapping[d]&&(c=this._getAssetByIdOrPath(this._mapping[d]))&&!c.resource&&
a.assets.load(c);0<=this._batchGroupId&&a.batcher.insert(Ta.MODEL,this.batchGroupId,this.entity)},onDisable:function(){var a=this.system.app,b=a.scene;b.off("set:layers",this.onLayersChanged,this);b.layers&&(b.layers.off("add",this.onLayerAdded,this),b.layers.off("remove",this.onLayerRemoved,this));0<=this._batchGroupId&&a.batcher.remove(Ta.MODEL,this.batchGroupId,this.entity);this._model&&this.removeModelFromLayers()},hide:function(){if(this._model){var a,b=this._model.meshInstances;var c=0;for(a=
b.length;c<a;c++)b[c].visible=!1}},show:function(){if(this._model){var a,b=this._model.meshInstances;var c=0;for(a=b.length;c<a;c++)b[c].visible=!0}},_bindMaterialAsset:function(a){a.on("load",this._onMaterialAssetLoad,this);a.on("unload",this._onMaterialAssetUnload,this);a.on("remove",this._onMaterialAssetRemove,this);a.on("change",this._onMaterialAssetChange,this);a.resource?this._onMaterialAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindMaterialAsset:function(a){a.off("load",
this._onMaterialAssetLoad,this);a.off("unload",this._onMaterialAssetUnload,this);a.off("remove",this._onMaterialAssetRemove,this);a.off("change",this._onMaterialAssetChange,this)},_onMaterialAssetAdd:function(a){this.system.app.assets.off("add:"+a.id,this._onMaterialAssetAdd,this);this._materialAsset===a.id&&this._bindMaterialAsset(a)},_onMaterialAssetLoad:function(a){this._setMaterial(a.resource)},_onMaterialAssetUnload:function(a){this._setMaterial(this.system.defaultMaterial)},_onMaterialAssetRemove:function(a){this._onMaterialAssetUnload(a)},
_onMaterialAssetChange:function(a){},_bindModelAsset:function(a){this._unbindModelAsset(a);a.on("load",this._onModelAssetLoad,this);a.on("unload",this._onModelAssetUnload,this);a.on("change",this._onModelAssetChange,this);a.on("remove",this._onModelAssetRemove,this);a.resource?this._onModelAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindModelAsset:function(a){a.off("load",this._onModelAssetLoad,this);a.off("unload",this._onModelAssetUnload,this);a.off("change",
this._onModelAssetChange,this);a.off("remove",this._onModelAssetRemove,this)},_onModelAssetAdded:function(a){this.system.app.assets.off("add:"+a.id,this._onModelAssetAdd,this);a.id===this._asset&&this._bindModelAsset(a)},_onModelAssetLoad:function(a){this.model=a.resource.clone();this._clonedModel=!0},_onModelAssetUnload:function(a){this.model=null},_onModelAssetChange:function(a,b,c,d){"data"===b&&(this.mapping=this._mapping)},_onModelAssetRemove:function(a){this.model=null},_setMaterial:function(a){if(this._material!==
a){this._material=a;var b=this._model;if(b&&"asset"!==this._type){b=b.meshInstances;for(var c=0,d=b.length;c<d;c++)b[c].material=a}}}});Object.defineProperty(Ca.prototype,"meshInstances",{get:function(){return this._model?this._model.meshInstances:null},set:function(a){this._model&&(this._model.meshInstances=a)}});Object.defineProperty(Ca.prototype,"type",{get:function(){return this._type},set:function(a){if(this._type!==a)if(this._area=null,this._type=a,"asset"===a)null!==this._asset?this._bindModelAsset(this._asset):
this.model=null;else{var b=this.system,c=b.app.graphicsDevice;switch(a){case "box":b.box||(b.box=Xf(c,{halfExtents:new r(.5,.5,.5)}));a=b.box;this._area={x:2,y:2,z:2,uv:2/3};break;case "capsule":b.capsule||(b.capsule=Bh(c,{radius:.5,height:2}));a=b.capsule;this._area={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case "cone":b.cone||(b.cone=Ch(c,{baseRadius:.5,peakRadius:0,height:1}));a=b.cone;this._area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case "cylinder":b.cylinder||(b.cylinder=Ah(c,
{radius:.5,height:1}));a=b.cylinder;this._area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case "plane":b.plane||(b.plane=Eh(c,{halfExtents:new M(.5,.5),widthSegments:1,lengthSegments:1}));a=b.plane;this._area={x:0,y:1,z:0,uv:1};break;case "sphere":b.sphere||(b.sphere=Dh(c,{radius:.5}));a=b.sphere;this._area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw Error("Invalid model type: "+a);}c=new Z;var d=new gb;d.graph=c;d.meshInstances=[new ma(c,a,this._material)];b._inTools&&d.generateWireframe();
this.model=d;this._asset=null}}});Object.defineProperty(Ca.prototype,"asset",{get:function(){return this._asset},set:function(a){var b=this.system.app.assets,c=a;a instanceof X&&(c=a.id);this._asset!==c&&(this._asset&&(b.off("add:"+this._asset,this._onModelAssetAdded,this),(a=b.get(this._asset))&&this._unbindModelAsset(a)),(this._asset=c)?(c=b.get(this._asset))?this._bindModelAsset(c):(this.model=null,b.on("add:"+this._asset,this._onModelAssetAdded,this)):this.model=null)}});Object.defineProperty(Ca.prototype,
"model",{get:function(){return this._model},set:function(a){if(!(this._model===a||a&&a._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=a)){this._model._immutable=!0;var b=this._model.meshInstances;for(a=0;a<b.length;a++)b[a].castShadow=this._castShadows,b[a].receiveShadow=this._receiveShadows,b[a].isStatic=this._isStatic;
this.lightmapped=this._lightmapped;this.entity.addChild(this._model.graph);this.enabled&&this.entity.enabled&&this.addModelToLayers();this._model._entity=this.entity;this.entity.animation&&this.entity.animation.setModel(this._model);"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}});Object.defineProperty(Ca.prototype,"lightmapped",{get:function(){return this._lightmapped},set:function(a){if(a!==this._lightmapped&&(this._lightmapped=a,this._model)){var b=this._model.meshInstances;
if(a)for(a=0;a<b.length;a++){var c=b[a];var d=c.mask;c.mask=(d|2)&-6}else for(a=0;a<b.length;a++)c=b[a],c.deleteParameter("texture_lightMap"),c.deleteParameter("texture_dirLightMap"),c._shaderDefs&=-65,d=c.mask,c.mask=(d|1)&-7}}});Object.defineProperty(Ca.prototype,"castShadows",{get:function(){return this._castShadows},set:function(a){if(this._castShadows!==a){var b,c,d=this._model;if(d){var e=this.layers,g=this.system.app.scene;if(this._castShadows&&!a)for(c=0;c<e.length;c++)(b=this.system.app.scene.layers.getLayerById(this.layers[c]))&&
b.removeShadowCasters(d.meshInstances);b=d.meshInstances;for(c=0;c<b.length;c++)b[c].castShadow=a;if(!this._castShadows&&a)for(c=0;c<e.length;c++)(b=g.layers.getLayerById(e[c]))&&b.addShadowCasters(d.meshInstances)}this._castShadows=a}}});Object.defineProperty(Ca.prototype,"receiveShadows",{get:function(){return this._receiveShadows},set:function(a){if(this._receiveShadows!==a&&(this._receiveShadows=a,this._model))for(var b=this._model.meshInstances,c=0,d=b.length;c<d;c++)b[c].receiveShadow=a}});
Object.defineProperty(Ca.prototype,"castShadowsLightmap",{get:function(){return this._castShadowsLightmap},set:function(a){this._castShadowsLightmap=a}});Object.defineProperty(Ca.prototype,"lightmapSizeMultiplier",{get:function(){return this._lightmapSizeMultiplier},set:function(a){this._lightmapSizeMultiplier=a}});Object.defineProperty(Ca.prototype,"isStatic",{get:function(){return this._isStatic},set:function(a){if(this._isStatic!==a){this._isStatic=a;var b;if(this._model){var c=this._model.meshInstances;
for(b=0;b<c.length;b++){var d=c[b];d.isStatic=a}}}}});Object.defineProperty(Ca.prototype,"layers",{get:function(){return this._layers},set:function(a){var b,c,d=this.system.app.scene.layers;if(this.meshInstances)for(b=0;b<this._layers.length;b++)(c=d.getLayerById(this._layers[b]))&&c.removeMeshInstances(this.meshInstances);for(b=this._layers.length=0;b<a.length;b++)this._layers[b]=a[b];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(b=0;b<this._layers.length;b++)(c=d.getLayerById(this._layers[b]))&&
c.addMeshInstances(this.meshInstances)}});Object.defineProperty(Ca.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(a){if(this._batchGroupId!==a){var b=this.system.app.batcher;this.entity.enabled&&0<=this._batchGroupId&&b.remove(Ta.MODEL,this.batchGroupId,this.entity);this.entity.enabled&&0<=a&&b.insert(Ta.MODEL,a,this.entity);0>a&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&this.addModelToLayers();this._batchGroupId=a}}});Object.defineProperty(Ca.prototype,
"materialAsset",{get:function(){return this._materialAsset},set:function(a){var b=a;a instanceof X&&(b=a.id);a=this.system.app.assets;if(b!==this._materialAsset){if(this._materialAsset){a.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var c=a.get(this._materialAsset);c&&this._unbindMaterialAsset(c)}(this._materialAsset=b)?(b=a.get(this._materialAsset))?this._bindMaterialAsset(b):(this._setMaterial(this.system.defaultMaterial),a.on("add:"+this._materialAsset,this._onMaterialAssetAdd,
this)):this._setMaterial(this.system.defaultMaterial)}}});Object.defineProperty(Ca.prototype,"material",{get:function(){return this._material},set:function(a){this._material!==a&&(this.materialAsset=null,this._setMaterial(a))}});Object.defineProperty(Ca.prototype,"mapping",{get:function(){return this._mapping},set:function(a){if("asset"===this._type&&(this._unsetMaterialEvents(),a||(a={}),this._mapping=a,this._model)){var b=this._model.meshInstances,c=this.asset?this.system.app.assets.get(this.asset):
null;c=c?c.data.mapping:null;for(var d=null,e=0,g=b.length;e<g;e++)if(void 0!==a[e])a[e]?(d=this.system.app.assets.get(a[e]),this._loadAndSetMeshInstanceMaterial(d,b[e],e)):b[e].material=this.system.defaultMaterial;else if(c)if(c[e]&&(c[e].material||c[e].path)){if(void 0!==c[e].material)d=this.system.app.assets.get(c[e].material);else if(void 0!==c[e].path){var f=this._getMaterialAssetUrl(c[e].path);f&&(d=this.system.app.assets.getByUrl(f))}this._loadAndSetMeshInstanceMaterial(d,b[e],e)}else b[e].material=
this.system.defaultMaterial}}});var xk=["enabled"];ee.prototype=Object.create(B.prototype);ee.prototype.constructor=ee;G._buildAccessors(Ca.prototype,xk);Object.assign(ee.prototype,{initializeComponentData:function(a,b,c){c="material materialAsset asset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier type mapping layers isStatic batchGroupId".split(" ");if(null===b.batchGroupId||void 0===b.batchGroupId)b.batchGroupId=-1;b.layers&&b.layers.length&&(b.layers=b.layers.slice(0));
for(var d=0;d<c.length;d++)b.hasOwnProperty(c[d])&&(a[c[d]]=b[c[d]]);B.prototype.initializeComponentData.call(this,a,b,["enabled"])},cloneComponent:function(a,b){var c={type:a.model.type,asset:a.model.asset,castShadows:a.model.castShadows,receiveShadows:a.model.receiveShadows,castShadowsLightmap:a.model.castShadowsLightmap,lightmapped:a.model.lightmapped,lightmapSizeMultiplier:a.model.lightmapSizeMultiplier,isStatic:a.model.isStatic,enabled:a.model.enabled,layers:a.model.layers,batchGroupId:a.model.batchGroupId,
mapping:Ec({},a.model.mapping)},d=a.model.materialAsset;d instanceof X||null==d||(d=this.app.assets.get(d));var e=a.model.material;e&&e!==this.defaultMaterial&&d&&e!==d.resource||(c.materialAsset=d);b=this.addComponent(b,c);a.model.model&&"asset"===a.model.type&&!a.model.asset&&(b.model=a.model.model.clone(),b._clonedModel=!0);c.materialAsset||(b.material=e);if(a.model.model)for(a=a.model.model.meshInstances,c=b.model.meshInstances,e=0;e<a.length;e++)c[e].mask=a[e].mask,c[e].material=a[e].material,
c[e].layer=a[e].layer,c[e].receiveShadow=a[e].receiveShadow},onRemove:function(a,b){b.onRemove()}});var Po="emitterExtents emitterRadius emitterExtentsInner emitterRadiusInner loop initialVelocity animSpeed normalMap particleNormal".split(" "),Qo="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite noFog sort stretch alignToMotion preWarm emitterShape animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animLoop colorMap localSpace orientation".split(" "),
Ro="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2".split(" "),bh=["colorMapAsset","normalMapAsset","meshAsset"],Le,sd=function(a,b){G.call(this,a,b);this.on("set_colorMapAsset",this.onSetColorMapAsset,this);this.on("set_normalMapAsset",this.onSetNormalMapAsset,this);this.on("set_meshAsset",this.onSetMeshAsset,this);this.on("set_mesh",
this.onSetMesh,this);this.on("set_loop",this.onSetLoop,this);this.on("set_blendType",this.onSetBlendType,this);this.on("set_depthSoftening",this.onSetDepthSoftening,this);this.on("set_layers",this.onSetLayers,this);Po.forEach(function(a){this.on("set_"+a,this.onSetSimpleProperty,this)}.bind(this));Qo.forEach(function(a){this.on("set_"+a,this.onSetComplexProperty,this)}.bind(this));Ro.forEach(function(a){this.on("set_"+a,this.onSetGraphProperty,this)}.bind(this));this._requestedDepth=!1};sd.prototype=
Object.create(G.prototype);sd.prototype.constructor=sd;Object.assign(sd.prototype,{addModelToLayers:function(){if(this.data.model)for(var a,b=0;b<this.layers.length;b++)if(a=this.system.app.scene.layers.getLayerById(this.layers[b]))a.addMeshInstances(this.data.model.meshInstances),this.emitter._layer=a},removeModelFromLayers:function(a){if(this.data.model)for(var b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.removeMeshInstances(this.data.model.meshInstances)},
onSetLayers:function(a,b,c){if(this.data.model){var d;for(a=0;a<b.length;a++)(d=this.system.app.scene.layers.getLayerById(b[a]))&&d.removeMeshInstances(this.data.model.meshInstances);if(this.enabled&&this.entity.enabled)for(a=0;a<c.length;a++)(d=this.system.app.scene.layers.getLayerById(c[a]))&&d.addMeshInstances(this.data.model.meshInstances)}},onLayersChanged:function(a,b){this.addModelToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,
this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){this.data.model&&(0>this.layers.indexOf(a.id)||a.addMeshInstances(this.data.model.meshInstances))},onLayerRemoved:function(a){this.data.model&&(0>this.layers.indexOf(a.id)||a.removeMeshInstances(this.data.model.meshInstances))},_bindColorMapAsset:function(a){a.on("load",this._onColorMapAssetLoad,this);a.on("unload",this._onColorMapAssetUnload,this);a.on("remove",this._onColorMapAssetRemove,this);a.on("change",this._onColorMapAssetChange,
this);a.resource?this._onColorMapAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindColorMapAsset:function(a){a.off("load",this._onColorMapAssetLoad,this);a.off("unload",this._onColorMapAssetUnload,this);a.off("remove",this._onColorMapAssetRemove,this);a.off("change",this._onColorMapAssetChange,this)},_onColorMapAssetLoad:function(a){this.colorMap=a.resource},_onColorMapAssetUnload:function(a){this.colorMap=null},_onColorMapAssetRemove:function(a){this._onColorMapAssetUnload(a)},
_onColorMapAssetChange:function(a){},onSetColorMapAsset:function(a,b,c){var d=this;a=this.system.app.assets;b&&(b=a.get(b))&&this._unbindColorMapAsset(b);if(c)if(c instanceof X&&(c=this.data.colorMapAsset=c.id),b=a.get(c))d._bindColorMapAsset(b);else a.once("add:"+c,function(a){d._bindColorMapAsset(a)});else this.colorMap=null},_bindNormalMapAsset:function(a){a.on("load",this._onNormalMapAssetLoad,this);a.on("unload",this._onNormalMapAssetUnload,this);a.on("remove",this._onNormalMapAssetRemove,this);
a.on("change",this._onNormalMapAssetChange,this);a.resource?this._onNormalMapAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindNormalMapAsset:function(a){a.off("load",this._onNormalMapAssetLoad,this);a.off("unload",this._onNormalMapAssetUnload,this);a.off("remove",this._onNormalMapAssetRemove,this);a.off("change",this._onNormalMapAssetChange,this)},_onNormalMapAssetLoad:function(a){this.normalMap=a.resource},_onNormalMapAssetUnload:function(a){this.normalMap=null},
_onNormalMapAssetRemove:function(a){this._onNormalMapAssetUnload(a)},_onNormalMapAssetChange:function(a){},onSetNormalMapAsset:function(a,b,c){var d=this;a=this.system.app.assets;b&&(b=a.get(b))&&this._unbindNormalMapAsset(b);if(c)if(c instanceof X&&(c=this.data.normalMapAsset=c.id),b=a.get(c))d._bindNormalMapAsset(b);else a.once("add:"+c,function(a){d._bindNormalMapAsset(a)});else this.normalMap=null},_bindMeshAsset:function(a){a.on("load",this._onMeshAssetLoad,this);a.on("unload",this._onMeshAssetUnload,
this);a.on("remove",this._onMeshAssetRemove,this);a.on("change",this._onMeshAssetChange,this);a.resource?this._onMeshAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindMeshAsset:function(a){a.off("load",this._onMeshAssetLoad,this);a.off("unload",this._onMeshAssetUnload,this);a.off("remove",this._onMeshAssetRemove,this);a.off("change",this._onMeshAssetChange,this)},_onMeshAssetLoad:function(a){this._onMeshChanged(a.resource)},_onMeshAssetUnload:function(a){this.mesh=
null},_onMeshAssetRemove:function(a){this._onMeshAssetUnload(a)},_onMeshAssetChange:function(a){},onSetMeshAsset:function(a,b,c){a=this.system.app.assets;b&&(b=a.get(b))&&this._unbindMeshAsset(b);if(c){if(c instanceof X&&(c=this.data.meshAsset=c.id),b=a.get(c))this._bindMeshAsset(b),b.resource?this._onMeshChanged(b.resource):a.load(b)}else this._onMeshChanged(null)},onSetMesh:function(a,b,c){!c||c instanceof X||"number"===typeof c?this.meshAsset=c:this._onMeshChanged(c)},_onMeshChanged:function(a){!a||
a instanceof fb||(a=a.meshInstances[0]?a.meshInstances[0].mesh:null);this.data.mesh=a;this.emitter&&(this.emitter.mesh=a,this.emitter.resetMaterial(),this.rebuild())},onSetLoop:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetTime())},onSetBlendType:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.material.blendType=c,this.emitter.resetMaterial(),this.rebuild())},_requestDepth:function(){this._requestedDepth||(Le||(Le=this.system.app.scene.layers.getLayerById(1)),Le&&
(Le.incrementCounter(),this._requestedDepth=!0))},_releaseDepth:function(){this._requestedDepth&&Le&&(Le.decrementCounter(),this._requestedDepth=!1)},onSetDepthSoftening:function(a,b,c){b!==c&&(c?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[a]=c),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))},onSetSimpleProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetMaterial())},
onSetComplexProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetMaterial(),this.rebuild(),this.reset())},onSetGraphProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){for(var a=this.data,b=0,c=bh.length;b<c;b++){var d=a[bh[b]];if(d){if(!(d instanceof X))if(0<=parseInt(d,10))d=this.system.app.assets.get(d);else continue;d&&!d.resource&&this.system.app.assets.load(d)}}this.emitter||(b=a.mesh,
b instanceof fb||(b=null),this.emitter=new Mb(this.system.app.graphicsDevice,{numParticles:a.numParticles,emitterExtents:a.emitterExtents,emitterExtentsInner:a.emitterExtentsInner,emitterRadius:a.emitterRadius,emitterRadiusInner:a.emitterRadiusInner,emitterShape:a.emitterShape,initialVelocity:a.initialVelocity,wrap:a.wrap,localSpace:a.localSpace,wrapBounds:a.wrapBounds,lifetime:a.lifetime,rate:a.rate,rate2:a.rate2,orientation:a.orientation,particleNormal:a.particleNormal,animTilesX:a.animTilesX,animTilesY:a.animTilesY,
animStartFrame:a.animStartFrame,animNumFrames:a.animNumFrames,animNumAnimations:a.animNumAnimations,animIndex:a.animIndex,randomizeAnimIndex:a.randomizeAnimIndex,animSpeed:a.animSpeed,animLoop:a.animLoop,startAngle:a.startAngle,startAngle2:a.startAngle2,scaleGraph:a.scaleGraph,scaleGraph2:a.scaleGraph2,colorGraph:a.colorGraph,colorGraph2:a.colorGraph2,alphaGraph:a.alphaGraph,alphaGraph2:a.alphaGraph2,localVelocityGraph:a.localVelocityGraph,localVelocityGraph2:a.localVelocityGraph2,velocityGraph:a.velocityGraph,
velocityGraph2:a.velocityGraph2,rotationSpeedGraph:a.rotationSpeedGraph,rotationSpeedGraph2:a.rotationSpeedGraph2,radialSpeedGraph:a.radialSpeedGraph,radialSpeedGraph2:a.radialSpeedGraph2,colorMap:a.colorMap,normalMap:a.normalMap,loop:a.loop,preWarm:a.preWarm,sort:a.sort,stretch:a.stretch,alignToMotion:a.alignToMotion,lighting:a.lighting,halfLambert:a.halfLambert,intensity:a.intensity,depthSoftening:a.depthSoftening,scene:this.system.app.scene,mesh:b,depthWrite:a.depthWrite,noFog:a.noFog,node:this.entity,
blendType:a.blendType}),this.emitter.meshInstance.node=this.entity,this.psys=new gb,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],a.model=this.psys,this.emitter.psys=this.psys,a.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1));a.model&&this.emitter.colorMap&&this.addModelToLayers();this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,
this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&a.depthSoftening&&this._requestDepth()},onDisable:function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth());this.emitter&&
(this.emitter.camera=null)},onBeforeRemove:function(){this.enabled&&(this.enabled=!1);var a=this.data;a.model&&(this.entity.removeChild(a.model.getGraph()),a.model.destroy(),a.model=null);this.emitter&&(this.emitter.destroy(),this.emitter=null);for(var b=0;b<bh.length;b++){var c=bh[b];a[c]&&(this[c]=null)}this.off()},reset:function(){this.emitter&&this.emitter.reset()},stop:function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},pause:function(){this.data.paused=
!0},unpause:function(){this.data.paused=!1},play:function(){this.data.paused=!1;this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())},isPlaying:function(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime},rebuild:function(){var a=this.enabled;this.enabled=!1;this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]);
this.enabled=a}});var yk="enabled autoPlay numParticles lifetime rate rate2 startAngle startAngle2 loop preWarm lighting halfLambert intensity depthWrite noFog depthSoftening sort blendType stretch alignToMotion emitterShape emitterExtents emitterExtentsInner emitterRadius emitterRadiusInner initialVelocity wrap wrapBounds localSpace colorMapAsset normalMapAsset mesh meshAsset orientation particleNormal localVelocityGraph localVelocityGraph2 velocityGraph velocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2 scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 colorMap normalMap animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animSpeed animLoop layers".split(" ");
fe.prototype=Object.create(B.prototype);fe.prototype.constructor=fe;G._buildAccessors(sd.prototype,yk);Object.assign(fe.prototype,{initializeComponentData:function(a,b,c){var d={};c=[];var e=this.propertyTypes;if(b.mesh instanceof X||"number"===typeof b.mesh)b.meshAsset=b.mesh,delete b.mesh;for(var g in b){b.hasOwnProperty(g)&&(c.push(g),d[g]=b[g]);if("vec3"===e[g])"array"===za(d[g])&&(d[g]=new r(d[g][0],d[g][1],d[g][2]));else if("curve"===e[g]){if(!(d[g]instanceof Ya)){var f=d[g].type;d[g]=new Ya(d[g].keys);
d[g].type=f}}else"curveset"!==e[g]||d[g]instanceof rb||(f=d[g].type,d[g]=new rb(d[g].keys),d[g].type=f);d.layers&&"array"===za(d.layers)&&(d.layers=d.layers.slice(0))}B.prototype.initializeComponentData.call(this,a,d,c)},cloneComponent:function(a,b){a=a.particlesystem.data;for(var c=this.schema,d={},e=0,g=c.length;e<g;e++){var f=c[e],l=a[f];l instanceof r||l instanceof Ya||l instanceof rb?(l=l.clone(),d[f]=l):"layers"===f?d.layers=a.layers.slice(0):null!==l&&void 0!==l&&(d[f]=l)}return this.addComponent(b,
d)},onUpdate:function(a){var b=this.store,c,d=this.app.stats.particles,e;for(e in b)if(b.hasOwnProperty(e)){var g=b[e];var f=g.entity;var l=g.data;if(l.enabled&&f.enabled){var h=l.model.emitter;if(h.meshInstance.visible){if(h.lighting){var p=l.layers;for(f=0;f<p.length;f++)if(g=this.app.scene.layers.getLayerById(p[f])){g._lightCube||(g._lightCube=new Float32Array(18));var n=g._lightCube;for(f=0;6>f;f++)n[3*f]=this.app.scene.ambientLight.r,n[3*f+1]=this.app.scene.ambientLight.g,n[3*f+2]=this.app.scene.ambientLight.b;
var m=g._sortedLights[0];for(c=0;c<m.length;c++)for(g=0;6>g;g++){var q=Math.max(h.lightCubeDir[g].dot(m[c]._direction),0)*m[c]._intensity;n[3*g]+=m[c]._color.r*q;n[3*g+1]+=m[c]._color.g*q;n[3*g+2]+=m[c]._color.b*q}}h.constantLightCube.setValue(n)}if(!l.paused){h.simTime+=a;if(h.simTime>h.fixedTimeStep){var u=Math.floor(h.simTime/h.fixedTimeStep);h.simTime-=u*h.fixedTimeStep}if(u){u=Math.min(u,h.maxSubSteps);for(f=0;f<u;f++)h.addTime(h.fixedTimeStep,!1);d._updatesPerFrame+=u;d._frameTime+=h._addTimeTime;
h._addTimeTime=0}h.finishFrame()}}}}},onBeforeRemove:function(a,b){b.onBeforeRemove()}});Object.assign(kg.prototype,{_resize:function(a){if(a>this._pool.length)for(var b=this._pool.length;b<a;b++)this._pool[b]=new this._constructor},allocate:function(){this._count>=this._pool.length&&this._resize(2*this._pool.length);return this._pool[this._count++]},freeAll:function(){this._count=0}});var Hb,ra,bf,wi,xi;Vb.prototype=Object.create(G.prototype);Vb.prototype.constructor=Vb;Object.defineProperty(Vb.prototype,
"linearVelocity",{get:function(){var a=this.body;a&&"dynamic"===this.type&&(a=a.getLinearVelocity(),this._linearVelocity.set(a.x(),a.y(),a.z()));return this._linearVelocity},set:function(a){var b=this.body;b&&"dynamic"===this.type&&(b.activate(),ra.setValue(a.x,a.y,a.z),b.setLinearVelocity(ra),this._linearVelocity.copy(a))}});Object.defineProperty(Vb.prototype,"angularVelocity",{get:function(){var a=this.body;a&&"dynamic"===this.type&&(a=a.getAngularVelocity(),this._angularVelocity.set(a.x(),a.y(),
a.z()));return this._angularVelocity},set:function(a){var b=this.body;b&&"dynamic"===this.type&&(b.activate(),ra.setValue(a.x,a.y,a.z),b.setAngularVelocity(ra),this._angularVelocity.copy(a))}});Object.assign(Vb.prototype,{createBody:function(){var a=this.entity;if(a.collision){var b=a.collision.shape;a.trigger&&(a.trigger.destroy(),delete a.trigger)}if(b){if(this.body)this.system.onRemove(this.entity,this);var c="dynamic"===this.type?this.mass:0;this._getEntityTransform(Hb);b=this.system.createBody(c,
b,Hb);b.setRestitution(this.restitution);b.setFriction(this.friction);b.setDamping(this.linearDamping,this.angularDamping);"dynamic"===this.type?(c=this.linearFactor,ra.setValue(c.x,c.y,c.z),b.setLinearFactor(ra),c=this.angularFactor,ra.setValue(c.x,c.y,c.z),b.setAngularFactor(ra)):"kinematic"===this.type&&(b.setCollisionFlags(b.getCollisionFlags()|2),b.setActivationState(4));b.entity=a;a.rigidbody.body=b;this.enabled&&this.entity.enabled&&this.enableSimulation()}},isActive:function(){var a=this.body;
return a?a.isActive():!1},activate:function(){var a=this.body;a&&a.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var a=this.body;if(a){this.system.addBody(a,this.group,this.mask);switch(this.type){case "dynamic":this.system._dynamic.push(this);a.forceActivationState(1);this.syncEntityToBody();break;case "kinematic":this.system._kinematic.push(this);a.forceActivationState(4);break;case ge:a.forceActivationState(1),this.syncEntityToBody()}"compound"===
this.entity.collision.type&&this.system._compounds.push(this.entity.collision);a.activate();this.data.simulationEnabled=!0}}},disableSimulation:function(){var a=this.body;if(a&&this.data.simulationEnabled){var b=this.system._compounds.indexOf(this.entity.collision);-1<b&&this.system._compounds.splice(b,1);b=this.system._dynamic.indexOf(this);-1<b&&this.system._dynamic.splice(b,1);b=this.system._kinematic.indexOf(this);-1<b&&this.system._kinematic.splice(b,1);this.system.removeBody(a);a.forceActivationState(5);
this.data.simulationEnabled=!1}},applyForce:function(){switch(arguments.length){case 1:var a=arguments[0].x;var b=arguments[0].y;var c=arguments[0].z;break;case 2:a=arguments[0].x;b=arguments[0].y;c=arguments[0].z;var d=arguments[1].x;var e=arguments[1].y;var g=arguments[1].z;break;case 3:a=arguments[0];b=arguments[1];c=arguments[2];break;case 6:a=arguments[0],b=arguments[1],c=arguments[2],d=arguments[3],e=arguments[4],g=arguments[5]}var f=this.body;f&&(f.activate(),ra.setValue(a,b,c),void 0!==d?
(bf.setValue(d,e,g),f.applyForce(ra,bf)):f.applyForce(ra,xi))},applyTorque:function(){switch(arguments.length){case 1:var a=arguments[0].x;var b=arguments[0].y;var c=arguments[0].z;break;case 3:a=arguments[0];b=arguments[1];c=arguments[2];break;default:return}var d=this.body;d&&(d.activate(),ra.setValue(a,b,c),d.applyTorque(ra))},applyImpulse:function(){switch(arguments.length){case 1:var a=arguments[0].x;var b=arguments[0].y;var c=arguments[0].z;break;case 2:a=arguments[0].x;b=arguments[0].y;c=arguments[0].z;
var d=arguments[1].x;var e=arguments[1].y;var g=arguments[1].z;break;case 3:a=arguments[0];b=arguments[1];c=arguments[2];break;case 6:a=arguments[0];b=arguments[1];c=arguments[2];d=arguments[3];e=arguments[4];g=arguments[5];break;default:return}var f=this.body;f&&(f.activate(),ra.setValue(a,b,c),void 0!==d?(bf.setValue(d,e,g),f.applyImpulse(ra,bf)):f.applyImpulse(ra,xi))},applyTorqueImpulse:function(){switch(arguments.length){case 1:var a=arguments[0].x;var b=arguments[0].y;var c=arguments[0].z;break;
case 3:a=arguments[0];b=arguments[1];c=arguments[2];break;default:return}var d=this.body;d&&(d.activate(),ra.setValue(a,b,c),d.applyTorqueImpulse(ra))},isStatic:function(){return this.type===ge},isStaticOrKinematic:function(){return this.type===ge||"kinematic"===this.type},isKinematic:function(){return"kinematic"===this.type},_getEntityTransform:function(a){var b=this.entity.getPosition(),c=this.entity.getRotation();ra.setValue(b.x,b.y,b.z);wi.setValue(c.x,c.y,c.z,c.w);a.setOrigin(ra);a.setRotation(wi)},
syncEntityToBody:function(){var a=this.data.body;if(a){this._getEntityTransform(Hb);a.setWorldTransform(Hb);if("kinematic"===this.type){var b=a.getMotionState();b&&b.setWorldTransform(Hb)}a.activate()}},_updateDynamic:function(){var a=this.data.body;if(a.isActive()&&(a=a.getMotionState())){a.getWorldTransform(Hb);a=Hb.getOrigin();var b=Hb.getRotation();this.entity.setPosition(a.x(),a.y(),a.z());this.entity.setRotation(b.x(),b.y(),b.z(),b.w())}},_updateKinematic:function(){var a=this.data.body.getMotionState();
a&&(this._getEntityTransform(Hb),a.setWorldTransform(Hb))},teleport:function(){3>arguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof T?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2]));this.syncEntityToBody()},onEnable:function(){this.body||this.createBody();
this.enableSimulation()},onDisable:function(){this.disableSimulation()},onSetMass:function(a,b,c){(a=this.data.body)&&"dynamic"===this.type&&((b=this.enabled&&this.entity.enabled)&&this.disableSimulation(),a.getCollisionShape().calculateLocalInertia(c,ra),a.setMassProps(c,ra),a.updateInertiaTensor(),b&&this.enableSimulation())},onSetLinearDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(c,this.data.angularDamping)},onSetAngularDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(this.data.linearDamping,
c)},onSetLinearFactor:function(a,b,c){(a=this.data.body)&&"dynamic"===this.type&&(ra.setValue(c.x,c.y,c.z),a.setLinearFactor(ra))},onSetAngularFactor:function(a,b,c){(a=this.data.body)&&"dynamic"===this.type&&(ra.setValue(c.x,c.y,c.z),a.setAngularFactor(ra))},onSetFriction:function(a,b,c){(a=this.data.body)&&a.setFriction(c)},onSetRestitution:function(a,b,c){(a=this.data.body)&&a.setRestitution(c)},onSetType:function(a,b,c){c!==b&&(this.disableSimulation(),"dynamic"===c?(this.data.group=1,this.data.mask=
65535):"kinematic"===c?(this.data.group=4,this.data.mask=65535):(this.data.group=yi,this.data.mask=lg),this.createBody())},onSetGroupOrMask:function(a,b,c){c!==b&&this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(a,b,c){this.body&&this.data.simulationEnabled&&this.body.activate()}});var Md,Nd,ad={},Gf={},Ck="enabled type mass linearDamping angularDamping linearFactor angularFactor friction restitution group mask body".split(" ");td.prototype=
Object.create(B.prototype);td.prototype.constructor=td;G._buildAccessors(Vb.prototype,Ck);Object.assign(td.prototype,{onLibraryLoaded:function(){if("undefined"!==typeof Ammo){this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,
this.solver,this.collisionConfiguration);if(this.dynamicsWorld.setInternalTickCallback){var a=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(a)}Md=new Ammo.btVector3;Nd=new Ammo.btVector3;this.contactPointPool=new kg(Ak,1);this.contactResultPool=new kg(Bk,1);this.singleContactResultPool=new kg(zk,1);B.bind("update",this.onUpdate,this)}else B.unbind("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){c="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" ");
for(var d={},e=0,g=c.length;e<g;e++){var f=c[e];d[f]=b[f]}b.bodyType&&(d.type=b.bodyType);d.linearFactor&&"array"===za(d.linearFactor)&&(d.linearFactor=new r(d.linearFactor[0],d.linearFactor[1],d.linearFactor[2]));d.angularFactor&&"array"===za(d.angularFactor)&&(d.angularFactor=new r(d.angularFactor[0],d.angularFactor[1],d.angularFactor[2]));B.prototype.initializeComponentData.call(this,a,d,c)},cloneComponent:function(a,b){this.addComponent(b,{enabled:a.rigidbody.enabled,mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,
angularDamping:a.rigidbody.angularDamping,linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,type:a.rigidbody.type,group:a.rigidbody.group,mask:a.rigidbody.mask})},onBeforeRemove:function(a,b){b.enabled&&(b.enabled=!1)},onRemove:function(a,b){if(a=b.body)this.removeBody(a),this.destroyBody(a),
b.body=null},addBody:function(a,b,c){void 0!==b&&void 0!==c?this.dynamicsWorld.addRigidBody(a,b,c):this.dynamicsWorld.addRigidBody(a)},removeBody:function(a){this.dynamicsWorld.removeRigidBody(a)},createBody:function(a,b,c){var d=new Ammo.btVector3(0,0,0);0!==a&&b.calculateLocalInertia(a,d);c=new Ammo.btDefaultMotionState(c);a=new Ammo.btRigidBodyConstructionInfo(a,c,b,d);b=new Ammo.btRigidBody(a);Ammo.destroy(a);Ammo.destroy(d);return b},destroyBody:function(a){var b=a.getMotionState();b&&Ammo.destroy(b);
Ammo.destroy(a)},raycastFirst:function(a,b){var c=null;Md.setValue(a.x,a.y,a.z);Nd.setValue(b.x,b.y,b.z);var d=new Ammo.ClosestRayResultCallback(Md,Nd);this.dynamicsWorld.rayTest(Md,Nd,d);if(d.hasHit()){var e=d.get_m_collisionObject();if(e=Ammo.castObject(e,Ammo.btRigidBody)){c=d.get_m_hitPointWorld();var g=d.get_m_hitNormalWorld();c=new zi(e.entity,new r(c.x(),c.y(),c.z()),new r(g.x(),g.y(),g.z()));if(2<arguments.length)(0,arguments[2])(c)}}Ammo.destroy(d);return c},raycastAll:function(a,b){var c=
[];Md.setValue(a.x,a.y,a.z);Nd.setValue(b.x,b.y,b.z);a=new Ammo.AllHitsRayResultCallback(Md,Nd);this.dynamicsWorld.rayTest(Md,Nd,a);if(a.hasHit()){b=a.get_m_collisionObjects();for(var d=a.get_m_hitPointWorld(),e=a.get_m_hitNormalWorld(),g=b.size(),f=0;f<g;f++){var l=Ammo.castObject(b.at(f),Ammo.btRigidBody);if(l){var h=d.at(f),p=e.at(f);l=new zi(l.entity,new r(h.x(),h.y(),h.z()),new r(p.x(),p.y(),p.z()));c.push(l)}}}Ammo.destroy(a);return c},_storeCollision:function(a,b){var c=!1,d=a.getGuid();ad[d]=
ad[d]||{others:[],entity:a};0>ad[d].others.indexOf(b)&&(ad[d].others.push(b),c=!0);Gf[d]=Gf[d]||{others:[],entity:a};Gf[d].others.push(b);return c},_createContactPointFromAmmo:function(a){var b=a.get_m_localPointA(),c=a.get_m_localPointB(),d=a.getPositionWorldOnA(),e=a.getPositionWorldOnB();a=a.get_m_normalWorldOnB();var g=this.contactPointPool.allocate();g.localPoint.set(b.x(),b.y(),b.z());g.localPointOther.set(c.x(),c.y(),c.z());g.point.set(d.x(),d.y(),d.z());g.pointOther.set(e.x(),e.y(),e.z());
g.normal.set(a.x(),a.y(),a.z());return g},_createReverseContactPointFromAmmo:function(a){var b=a.get_m_localPointA(),c=a.get_m_localPointB(),d=a.getPositionWorldOnA(),e=a.getPositionWorldOnB();a=a.get_m_normalWorldOnB();var g=this.contactPointPool.allocate();g.localPointOther.set(b.x(),b.y(),b.z());g.localPoint.set(c.x(),c.y(),c.z());g.pointOther.set(d.x(),d.y(),d.z());g.point.set(e.x(),e.y(),e.z());g.normal.set(a.x(),a.y(),a.z());return g},_createSingleContactResult:function(a,b,c){var d=this.singleContactResultPool.allocate();
d.a=a;d.b=b;d.localPointA=c.localPoint;d.localPointB=c.localPointOther;d.pointA=c.point;d.pointB=c.pointOther;d.normal=c.normal;return d},_createContactResult:function(a,b){var c=this.contactResultPool.allocate();c.other=a;c.contacts=b;return c},_cleanOldCollisions:function(){for(var a in ad)if(ad.hasOwnProperty(a)){var b=Gf[a],c=ad[a],d=c.entity,e=d.collision,g=d.rigidbody;c=c.others;for(var f=c.length;f--;){var l=c[f];if(!b||0>b.others.indexOf(l))c.splice(f,1),d.trigger?(e&&e.fire("triggerleave",
l),l.rigidbody&&l.rigidbody.fire("triggerleave",d)):l.trigger||(g&&g.fire("collisionend",l),e&&e.fire("collisionend",l))}0===c.length&&delete ad[a]}},_hasContactEvent:function(a){var b=a.collision;return b&&(b.hasEvent("collisionstart")||b.hasEvent("collisionend")||b.hasEvent("contact"))?!0:(a=a.rigidbody)&&(a.hasEvent("collisionstart")||a.hasEvent("collisionend")||a.hasEvent("contact"))},_checkForCollisions:function(a,b){a=Ammo.wrapPointer(a,Ammo.btDynamicsWorld).getDispatcher();b=a.getNumManifolds();
Gf={};for(var c=0;c<b;c++){var d=a.getManifoldByIndexInternal(c),e=d.getBody0(),g=d.getBody1(),f=Ammo.castObject(e,Ammo.btRigidBody),l=Ammo.castObject(g,Ammo.btRigidBody);g=f.entity;e=l.entity;if(g&&e){var h=f.getCollisionFlags(),p=l.getCollisionFlags(),n=d.getNumContacts(),m=[],q=[];if(0<n)if(h&4||p&4){l=g.collision&&(g.collision.hasEvent("triggerenter")||g.collision.hasEvent("triggerleave"));f=e.collision&&(e.collision.hasEvent("triggerenter")||e.collision.hasEvent("triggerleave"));d=g.rigidbody&&
(g.rigidbody.hasEvent("triggerenter")||g.rigidbody.hasEvent("triggerleave"));q=e.rigidbody&&(e.rigidbody.hasEvent("triggerenter")||e.rigidbody.hasEvent("triggerleave"));if(l){var u=this._storeCollision(g,e);!u||p&4||g.collision.fire("triggerenter",e)}f&&(u=this._storeCollision(e,g),!u||h&4||e.collision.fire("triggerenter",g));d&&(u||(u=this._storeCollision(e,g)),u&&g.rigidbody.fire("triggerenter",e));q&&(u||(u=this._storeCollision(g,e)),u&&e.rigidbody.fire("triggerenter",g))}else if(l=this._hasContactEvent(g),
f=this._hasContactEvent(e),(h=this.hasEvent("contact"))||l||f){for(p=0;p<n;p++){var r=d.getContactPoint(p),y=this._createContactPointFromAmmo(r);if(l||f)r=this._createReverseContactPointFromAmmo(r),m.push(y),q.push(r);h&&(y=this._createSingleContactResult(g,e,y),this.fire("contact",y))}l&&(d=this._createContactResult(e,m),u=this._storeCollision(g,e),g.collision&&(g.collision.fire("contact",d),u&&g.collision.fire("collisionstart",d)),g.rigidbody&&(g.rigidbody.fire("contact",d),u&&g.rigidbody.fire("collisionstart",
d)));f&&(d=this._createContactResult(g,q),u=this._storeCollision(e,g),e.collision&&(e.collision.fire("contact",d),u&&e.collision.fire("collisionstart",d)),e.rigidbody&&(e.rigidbody.fire("contact",d),u&&e.rigidbody.fire("collisionstart",d)))}}}this._cleanOldCollisions();this.contactPointPool.freeAll();this.contactResultPool.freeAll();this.singleContactResultPool.freeAll()},onUpdate:function(a){var b;var c=this.dynamicsWorld.getGravity();if(c.x()!==this.gravity.x||c.y()!==this.gravity.y||c.z()!==this.gravity.z)c.setValue(this.gravity.x,
this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(c);var d=this._triggers;c=0;for(b=d.length;c<b;c++)d[c].updateTransform();d=this._compounds;c=0;for(b=d.length;c<b;c++)d[c]._updateCompound();d=this._kinematic;c=0;for(b=d.length;c<b;c++)d[c]._updateKinematic();this.dynamicsWorld.stepSimulation(a,this.maxSubSteps,this.fixedTimeStep);d=this._dynamic;c=0;for(b=d.length;c<b;c++)d[c]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),
a)},destroy:function(){"undefined"!==typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.collisionConfiguration=this.dispatcher=this.overlappingPairCache=this.solver=this.dynamicsWorld=null)}});var ud="none";vb.prototype=Object.create(G.prototype);vb.prototype.constructor=vb;var cm=new C;Object.assign(vb.prototype,{syncDrawOrder:function(){this.system.queueDrawOrderSync(this.entity.getGuid(),
this._processDrawOrderSync,this)},_recurseDrawOrderSync:function(a,b){if(!(a instanceof S))return b;if(a.element){var c=a.element.drawOrder;a.element.drawOrder=b++;0<=a.element._batchGroupId&&c!=a.element.drawOrder&&this.system.app.batcher.markGroupDirty(a.element._batchGroupId)}a=a.children;for(c=0;c<a.length;c++)b=this._recurseDrawOrderSync(a[c],b);return b},_processDrawOrderSync:function(){this._recurseDrawOrderSync(this.entity,1);this.fire("syncdraworder")},_calcProjectionMatrix:function(){var a=
this._resolution.x/this.scale,b=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,a,-b,0,1,-1);this._screenSpace||(cm.setScale(.5*a,.5*b,1),this._screenMatrix.mul2(cm,this._screenMatrix))},_updateScale:function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},_calcScale:function(a,b){return Math.pow(2,Math.log2(a.x/b.x)*(1-this._scaleBlend)+Math.log2(a.y/b.y)*this._scaleBlend)},_onResize:function(a,b){this._screenSpace&&(this._resolution.set(a,b),this.resolution=
this._resolution)},onRemove:function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this);this.fire("remove");this.off()}});Object.defineProperty(vb.prototype,"resolution",{set:function(a){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(a.x,a.y);this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:resolution",this._resolution)},
get:function(){return this._resolution}});Object.defineProperty(vb.prototype,"referenceResolution",{set:function(a){this._referenceResolution.set(a.x,a.y);this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:referenceresolution",this._resolution)},get:function(){return this._scaleMode===ud?this._resolution:this._referenceResolution}});Object.defineProperty(vb.prototype,"screenSpace",{set:function(a){(this._screenSpace=a)&&this._resolution.set(this.system.app.graphicsDevice.width,
this.system.app.graphicsDevice.height);this.resolution=this._resolution;this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:screenspace",this._screenSpace)},get:function(){return this._screenSpace}});Object.defineProperty(vb.prototype,"scaleMode",{set:function(a){a!==ud&&"blend"!==a&&(a=ud);this._screenSpace||a===ud||(a=ud);this._scaleMode=a;this.resolution=this._resolution;this.fire("set:scalemode",this._scaleMode)},get:function(){return this._scaleMode}});Object.defineProperty(vb.prototype,
"scaleBlend",{set:function(a){this._scaleBlend=a;this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:scaleblend",this._scaleBlend)},get:function(){return this._scaleBlend}});Object.defineProperty(vb.prototype,"priority",{get:function(){return this._priority},set:function(a){255<a&&(a=255);this._priority=a}});var Dk=["enabled"];he.prototype=Object.create(B.prototype);he.prototype.constructor=he;G._buildAccessors(vb.prototype,Dk);Object.assign(he.prototype,
{initializeComponentData:function(a,b,c){void 0!==b.priority&&(a.priority=b.priority);void 0!==b.screenSpace&&(a.screenSpace=b.screenSpace);a.cull=a.screenSpace;void 0!==b.scaleMode&&(a.scaleMode=b.scaleMode);void 0!==b.scaleBlend&&(a.scaleBlend=b.scaleBlend);void 0!==b.resolution&&(b.resolution instanceof M?a._resolution.copy(b.resolution):a._resolution.set(b.resolution[0],b.resolution[1]),a.resolution=a._resolution);void 0!==b.referenceResolution&&(b.referenceResolution instanceof M?a._referenceResolution.copy(b.referenceResolution):
a._referenceResolution.set(b.referenceResolution[0],b.referenceResolution[1]),a.referenceResolution=a._referenceResolution);a.syncDrawOrder();B.prototype.initializeComponentData.call(this,a,b,c)},destroy:function(){this.off();this.app.graphicsDevice.off("resizecanvas",this._onResize,this)},_onUpdate:function(a){var b=this.store,c;for(c in b)b[c].entity.screen.update&&b[c].entity.screen.update(a)},_onResize:function(a,b){this.windowResolution.x=a;this.windowResolution.y=b},cloneComponent:function(a,
b){a=a.screen;return this.addComponent(b,{enabled:a.enabled,screenSpace:a.screenSpace,scaleMode:a.scaleMode,resolution:a.resolution.clone(),referenceResolution:a.referenceResolution.clone()})},onRemoveComponent:function(a,b){b.onRemove()},processDrawOrderSyncQueue:function(){for(var a=this._drawOrderSyncQueue.list(),b=0;b<a.length;b++){var c=a[b];c.callback.call(c.scope)}this._drawOrderSyncQueue.clear()},queueDrawOrderSync:function(a,b,c){if(!this._drawOrderSyncQueue.list().length)this.app.once("prerender",
this.processDrawOrderSyncQueue,this);this._drawOrderSyncQueue.has(a)||this._drawOrderSyncQueue.push(a,{callback:b,scope:c})}});var So=["x","y","z","w"],dm=function(a,b,c,d){switch(b.type){case "boolean":return!!c;case "number":if("number"===typeof c)break;else{if("string"===typeof c)return c=parseInt(c,10),isNaN(c)?null:c;if("boolean"===typeof c)return 0+c}return null;case "json":if("object"===typeof c)break;try{return JSON.parse(c)}catch(e){return null}case "asset":if(c instanceof X)break;else{if("number"===
typeof c)return a.assets.get(c)||null;if("string"===typeof c)return a.assets.get(parseInt(c,10))||null}return null;case "entity":if(c instanceof Z)break;else if("string"===typeof c)return a.getEntityFromIndex(c);return null;case "rgb":case "rgba":if(c instanceof J)return d instanceof J?(d.copy(c),d):c.clone();if(c instanceof Array&&3<=c.length&&4>=c.length){for(a=0;a<c.length;a++)if("number"!==typeof c[a])return null;d||(d=new J);d.r=c[0];d.g=c[1];d.b=c[2];d.a=3===c.length?1:c[3];return d}return"string"===
typeof c&&/#([0-9abcdef]{2}){3,4}/i.test(c)?(d||(d=new J),d.fromString(c),d):null;case "vec2":case "vec3":case "vec4":b=parseInt(b.type.slice(3),10);if(c instanceof pc["Vec"+b])return d instanceof pc["Vec"+b]?(d.copy(c),d):c.clone();if(c instanceof Array&&c.length===b){for(a=0;a<c.length;a++)if("number"!==typeof c[a])return null;d||(d=new pc["Vec"+b]);for(a=0;a<b;a++)d[So[a]]=c[a];return d}return null;case "curve":if(c)return c instanceof Ya||c instanceof rb?d=c.clone():(d=new (c.keys[0]instanceof
Array?rb:Ya)(c.keys),d.type=c.type),d}return c};vd.prototype.add=function(a,b){this.index[a]||wb.reservedAttributes[a]||(this.index[a]=b,Object.defineProperty(this.scriptType.prototype,a,{get:function(){return this.__attributes[a]},set:function(c){var d=this.__attributes[a];if(b.array){if(this.__attributes[a]=[],c){var e;var g=0;for(e=c.length;g<e;g++)this.__attributes[a].push(dm(this.app,b,c[g],d?d[g]:null))}}else this.__attributes[a]=dm(this.app,b,c,d);this.fire("attr",a,this.__attributes[a],d);
this.fire("attr:"+a,this.__attributes[a],d)}}))};vd.prototype.remove=function(a){if(!this.index[a])return!1;delete this.index[a];delete this.scriptType.prototype[a];return!0};vd.prototype.has=function(a){return!!this.index[a]};vd.prototype.get=function(a){return this.index[a]||null};var To=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^\(\s\/]*)\s*/;Va.prototype=Object.create(H.prototype);Va.prototype.constructor=Va;Va.__name=null;Va.__getScriptName=function(a){if("function"===typeof a)return"name"in Function.prototype?
a.name:a===Function||a===Function.prototype.constructor?"Function":(a=(""+a).match(To))?a[1]:void 0};Object.defineProperty(Va,"scriptName",{get:function(){return this.__name}});Object.defineProperty(Va,"attributes",{get:function(){this.hasOwnProperty("__attributes")||(this.__attributes=new vd(this));return this.__attributes}});Va.prototype.__initializeAttributes=function(a){if(a||this.__attributesRaw){for(var b in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(b)?
this[b]=this.__attributesRaw[b]:this.__attributes.hasOwnProperty(b)||(this.__scriptType.attributes.index[b].hasOwnProperty("default")?this[b]=this.__scriptType.attributes.index[b].default:this[b]=null);this.__attributesRaw=null}};Va.extend=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.prototype[b]=a[b])};Object.defineProperty(Va.prototype,"enabled",{get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function(a){this._enabled=!!a;this.enabled!==
this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,Qa.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,Qa.scriptMethods.postInitialize)))}});
wb.reservedScripts="system entity create destroy swap move scripts _scripts _scriptsIndex _scriptsData enabled _oldState onEnable onDisable onPostStateChange _onSetEnabled _checkState _onBeforeRemove _onInitializeAttributes _onInitialize _onPostInitialize _onUpdate _onPostUpdate _callbacks has get on off fire once hasEvent".split(" ");var em={},bd;for(bd=0;bd<wb.reservedScripts.length;bd++)em[wb.reservedScripts[bd]]=1;wb.reservedScripts=em;wb.reservedAttributes="app entity enabled _enabled _enabledOld _destroyed __attributes __attributesRaw __scriptType __executionOrder _callbacks has get on off fire once hasEvent".split(" ");
var fm={};for(bd=0;bd<wb.reservedAttributes.length;bd++)fm[wb.reservedAttributes[bd]]=1;wb.reservedAttributes=fm;Wb.prototype._binarySearch=function(a){var b=0,c=this.items.length-1;a=a[this._sortBy];for(var d,e;b<=c;)d=Math.floor((b+c)/2),e=this.items[d][this._sortBy],e<=a?b=d+1:e>a&&(c=d-1);return b};Wb.prototype._doSort=function(a,b){var c=this._sortBy;return a[c]-b[c]};Wb.prototype.insert=function(a){var b=this._binarySearch(a);this.items.splice(b,0,a);this.length++;this.loopIndex>=b&&this.loopIndex++};
Wb.prototype.append=function(a){this.items.push(a);this.length++};Wb.prototype.remove=function(a){a=this.items.indexOf(a);0>a||(this.items.splice(a,1),this.length--,this.loopIndex>=a&&this.loopIndex--)};Wb.prototype.sort=function(){var a=0<=this.loopIndex?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler);null!==a&&(this.loopIndex=this.items.indexOf(a))};Qa.prototype=Object.create(G.prototype);Qa.prototype.constructor=Qa;Qa.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",
update:"update",postUpdate:"postUpdate",swap:"swap"};Object.assign(Qa.prototype,{onEnable:function(){this._beingEnabled=!0;this._checkState();if(!this.entity._beingEnabled)this.onPostStateChange();this._beingEnabled=!1},onDisable:function(){this._checkState()},onPostStateChange:function(){for(var a,b=this._beginLooping(),c=0,d=this.scripts.length;c<d;c++)a=this.scripts[c],a._initialized&&!a._postInitialized&&a.enabled&&(a._postInitialized=!0,a.postInitialize&&this._scriptMethod(a,Qa.scriptMethods.postInitialize));
this._endLooping(b)},_beginLooping:function(){var a=this._isLoopingThroughScripts;this._isLoopingThroughScripts=!0;return a},_endLooping:function(a){(this._isLoopingThroughScripts=a)||this._removeDestroyedScripts()},_onSetEnabled:function(a,b,c){this._beingEnabled=!0;this._checkState();this._beingEnabled=!1},_checkState:function(){var a=this.enabled&&this.entity.enabled;if(a!==this._oldState){this._oldState=a;this.fire(a?"enable":"disable");this.fire("state",a);a?this.system._addComponentToEnabled(this):
this.system._removeComponentFromEnabled(this);a=this._beginLooping();for(var b,c=0,d=this.scripts.length;c<d;c++)b=this.scripts[c],b.enabled=b._enabled;this._endLooping(a)}},_onBeforeRemove:function(){this.fire("remove");for(var a=this._beginLooping(),b=0;b<this.scripts.length;b++){var c=this.scripts[b];c&&this.destroy(c.__scriptType.__name)}this._endLooping(a)},_removeDestroyedScripts:function(){var a=this._destroyedScripts.length;if(a){var b;for(b=0;b<a;b++)this._removeScriptInstance(this._destroyedScripts[b]);
this._destroyedScripts.length=0;this._resetExecutionOrder(0,this._scripts.length)}},_onInitializeAttributes:function(){for(var a=0,b=this.scripts.length;a<b;a++)this.scripts[a].__initializeAttributes()},_scriptMethod:function(a,b,c){a[b](c)},_onInitialize:function(){for(var a,b=this._scripts,c=this._beginLooping(),d=0,e=b.length;d<e;d++)a=b[d],!a._initialized&&a.enabled&&(a._initialized=!0,a.initialize&&this._scriptMethod(a,Qa.scriptMethods.initialize));this._endLooping(c)},_onPostInitialize:function(){this.onPostStateChange()},
_onUpdate:function(a){var b=this._updateList;if(b.length){var c=this._beginLooping();for(b.loopIndex=0;b.loopIndex<b.length;b.loopIndex++){var d=b.items[b.loopIndex];d.enabled&&this._scriptMethod(d,Qa.scriptMethods.update,a)}this._endLooping(c)}},_onPostUpdate:function(a){var b=this._postUpdateList;if(b.length){var c=this._beginLooping();for(b.loopIndex=0;b.loopIndex<b.length;b.loopIndex++){var d=b.items[b.loopIndex];d.enabled&&this._scriptMethod(d,Qa.scriptMethods.postUpdate,a)}this._endLooping(c)}},
_insertScriptInstance:function(a,b,c){-1===b?(this._scripts.push(a),a.__executionOrder=c,a.update&&this._updateList.append(a),a.postUpdate&&this._postUpdateList.append(a)):(this._scripts.splice(b,0,a),a.__executionOrder=b,this._resetExecutionOrder(b+1,c+1),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a))},_removeScriptInstance:function(a){var b=this._scripts.indexOf(a);if(-1===b)return b;this._scripts.splice(b,1);a.update&&this._updateList.remove(a);a.postUpdate&&
this._postUpdateList.remove(a);return b},_resetExecutionOrder:function(a,b){for(;a<b;a++)this._scripts[a].__executionOrder=a},has:function(a){if("string"===typeof a)return!!this._scriptsIndex[a];if(!a)return!1;var b=this._scriptsIndex[a.__name];return(b&&b.instance)instanceof a},get:function(a){if("string"===typeof a)return(a=this._scriptsIndex[a])?a.instance:null;if(!a)return null;var b=this._scriptsIndex[a.__name];b=b&&b.instance;return b instanceof a?b:null},create:function(a,b){var c=this;b=b||
{};var d=a,e=a;"string"===typeof d?d=this.system.app.scripts.get(d):d&&(e=d.__name);if(d){if(!this._scriptsIndex[e]||!this._scriptsIndex[e].instance){a=new d({app:this.system.app,entity:this.entity,enabled:b.hasOwnProperty("enabled")?b.enabled:!0,attributes:b.attributes});d=this._scripts.length;var g=-1;"number"===typeof b.ind&&-1!==b.ind&&d>b.ind&&(g=b.ind);this._insertScriptInstance(a,g,d);this._scriptsIndex[e]={instance:a,onSwap:function(){c.swap(e)}};this[e]=a;b.preloading||a.__initializeAttributes();
this.fire("create",e,a);this.fire("create:"+e,a);this.system.app.scripts.on("swap:"+e,this._scriptsIndex[e].onSwap);b.preloading||(a.enabled&&!a._initialized&&(a._initialized=!0,a.initialize&&this._scriptMethod(a,Qa.scriptMethods.initialize)),a.enabled&&!a._postInitialized&&(a._postInitialized=!0,a.postInitialize&&this._scriptMethod(a,Qa.scriptMethods.postInitialize)));return a}console.warn("script '"+e+"' is already added to entity '"+this.entity.name+"'")}else this._scriptsIndex[e]={awaiting:!0,
ind:this._scripts.length},console.warn("script '"+e+"' is not found, awaiting it to be added to registry");return null},destroy:function(a){var b=a;"string"===typeof a?this.system.app.scripts.get(a):a&&(b=a.__name);a=this._scriptsIndex[b];delete this._scriptsIndex[b];if(!a)return!1;var c=a.instance;if(c&&!c._destroyed)if(c.enabled=!1,c._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(c);else{var d=this._removeScriptInstance(c);0<=d&&this._resetExecutionOrder(d,this._scripts.length)}this.system.app.scripts.off("swap:"+
b,a.onSwap);delete this[b];this.fire("destroy",b,c||null);this.fire("destroy:"+b,c||null);c&&c.fire("destroy");return!0},swap:function(a){var b=a;"string"===typeof a?a=this.system.app.scripts.get(a):a&&(b=a.__name);var c=this._scriptsIndex[b];if(!c||!c.instance)return!1;c=c.instance;var d=this._scripts.indexOf(c);a=new a({app:this.system.app,entity:this.entity,enabled:c.enabled,attributes:c.__attributes});if(!a.swap)return!1;a.__initializeAttributes();this._scripts[d]=a;this._scriptsIndex[b].instance=
a;this[b]=a;a.__executionOrder=d;c.update&&this._updateList.remove(c);c.postUpdate&&this._postUpdateList.remove(c);a.update&&this._updateList.insert(a);a.postUpdate&&this._postUpdateList.insert(a);this._scriptMethod(a,Qa.scriptMethods.swap,c);this.fire("swap",b,a);this.fire("swap:"+b,a);return!0},resolveDuplicatedEntityReferenceProperties:function(a,b){var c=this.entity.script,d;for(d in a._scriptsIndex){var e=this.system.app.scripts.get(d);if(e){var g=a._scriptsIndex[d];if(g&&g.instance){var f=c[d].__attributesRaw,
l=c[d].__attributes;if(f||l){g=g.instance.__attributes;for(var h in g)if(g[h]){var p=e.attributes.get(h);if(p&&"entity"===p.type)if(p.array){var n=g[h];if(p=n.length){n=n.slice();for(var m=0;m<p;m++){var q=n[m]instanceof S?n[m].getGuid():n[m];b[q]&&(n[m]=f?b[q].getGuid():b[q])}f?f[h]=n:l[h]=n}}else{p=g[h];if(p instanceof S)p=p.getGuid();else if("string"!==typeof p)continue;b[p]&&(f?f[h]=b[p].getGuid():l[h]=b[p])}}}}}}},move:function(a,b){var c=this._scripts.length;if(b>=c||0>b)return!1;var d=a,e=
a;"string"!==typeof e?e=a.__name:d=null;a=this._scriptsIndex[e];if(!a||!a.instance)return!1;a=a.instance;if(d&&!(a instanceof d))return!1;d=this._scripts.indexOf(a);if(-1===d||d===b)return!1;this._scripts.splice(b,0,this._scripts.splice(d,1)[0]);this._resetExecutionOrder(0,c);this._updateList.sort();this._postUpdateList.sort();this.fire("move",e,a,b,d);this.fire("move:"+e,a,b,d);return!0}});Object.defineProperty(Qa.prototype,"enabled",{get:function(){return this._enabled},set:function(a){var b=this._enabled;
this._enabled=a;this.fire("set","enabled",b,a)}});Object.defineProperty(Qa.prototype,"scripts",{get:function(){return this._scripts},set:function(a){this._scriptsData=a;for(var b in a)if(a.hasOwnProperty(b)){var c=this._scriptsIndex[b];if(c){if("boolean"===typeof a[b].enabled&&(c.enabled=!!a[b].enabled),"object"===typeof a[b].attributes)for(var d in a[b].attributes)if(!wb.reservedAttributes[d]){if(!c.__attributes.hasOwnProperty(d)){var e=this.system.app.scripts.get(b);e&&e.attributes.add(d,{})}c[d]=
a[b].attributes[d]}}else console.log(this.order)}}});var ch=0;ie.prototype=Object.create(B.prototype);ie.prototype.constructor=ie;Object.assign(ie.prototype,{initializeComponentData:function(a,b){a._executionOrder=ch++;this._components.append(a);ch>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder();a.enabled=b.hasOwnProperty("enabled")?!!b.enabled:!0;a.enabled&&a.entity.enabled&&this._enabledComponents.append(a);if(b.hasOwnProperty("order")&&b.hasOwnProperty("scripts")){a._scriptsData=b.scripts;
for(var c=0;c<b.order.length;c++)a.create(b.order[c],{enabled:b.scripts[b.order[c]].enabled,attributes:b.scripts[b.order[c]].attributes,preloading:this.preloading})}},cloneComponent:function(a,b){var c,d,e=[],g={};for(c=0;c<a.script._scripts.length;c++){var f=a.script._scripts[c],l=f.__scriptType.__name;e.push(l);var h={};for(d in f.__attributes)h[d]=f.__attributes[d];g[l]={enabled:f._enabled,attributes:h}}for(d in a.script._scriptsIndex)d.awaiting&&e.splice(d.ind,0,d);return this.addComponent(b,
{enabled:a.script.enabled,order:e,scripts:g})},_resetExecutionOrder:function(){for(var a=ch=0,b=this._components.length;a<b;a++)this._components.items[a]._executionOrder=ch++},_callComponentMethod:function(a,b,c){for(a.loopIndex=0;a.loopIndex<a.length;a.loopIndex++)a.items[a.loopIndex][b](c)},_onInitialize:function(){this.preloading=!1;this._callComponentMethod(this._components,"_onInitializeAttributes");this._callComponentMethod(this._enabledComponents,"_onInitialize")},_onPostInitialize:function(){this._callComponentMethod(this._enabledComponents,
"_onPostInitialize")},_onUpdate:function(a){this._callComponentMethod(this._enabledComponents,"_onUpdate",a)},_onPostUpdate:function(a){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",a)},_addComponentToEnabled:function(a){this._enabledComponents.insert(a)},_removeComponentFromEnabled:function(a){this._enabledComponents.remove(a)},_onBeforeRemove:function(a,b){0<=this._components.items.indexOf(b)&&b._onBeforeRemove();this._removeComponentFromEnabled(b);this._components.remove(b)}});
wd.prototype=Object.create(G.prototype);wd.prototype.constructor=wd;Object.assign(wd.prototype,{send:function(a,b){console.warn("DEPRECATED: ScriptLegacyComponent.send() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var c=gd(arguments).slice(2),d=this.entity.script.instances,e;if(d&&d[a]&&(e=d[a].instance[b]))return e.apply(d[a].instance,c)},onEnable:function(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?
this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},onDisable:function(){this.system._disableScriptComponent(this)},onSetScripts:function(a,b,c){this.system._inTools&&!this.runInTools||this._updateScriptAttributes(b,c)||(this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1,a=c.map(function(a){return a.url}),this._loadFromCache(a)||
this._loadScripts(a))},_updateScriptAttributes:function(a,b){var c=!0;if(a.length!==b.length)c=!1;else{var d,e=b.length;for(d=0;d<e;d++)if(a[d].url!==b[d].url){c=!1;break}}if(c)for(var g in this.instances)this.instances.hasOwnProperty(g)&&this.system._updateAccessors(this.entity,this.instances[g]);return c},_loadFromCache:function(a){var b,c=[],d=this.system.app._scriptPrefix||"",e=/^http(s)?:\/\//i;var g=0;for(b=a.length;g<b;g++){var f=a[g];e.test(f)||(f=V.join(d,f));f=this.system.app.loader.getFromCache(f,
"script");if(!f)return!1;c.push(f)}g=0;for(b=c.length;g<b;g++)d=c[g],!0!==d&&d&&this.entity.script&&!this.entity.script.instances[d._pcScriptName]&&(e=new d(this.entity),this.system._preRegisterInstance(this.entity,a[g],d._pcScriptName,e));this.data&&(this.data.areScriptsLoaded=!0);this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity));return!0},_loadScripts:function(a){var b=a.length,c=this.system.app._scriptPrefix||"";a.forEach(function(a){var d=
null,g=null;a.toLowerCase().startsWith("http://")||a.toLowerCase().startsWith("https://")?d=g=a:(g=a,d=V.join(c,a));this.system.app.loader.load(d,"script",function(a,c){b--;a?console.error(a):c&&this.entity.script&&!this.entity.script.instances[c._pcScriptName]&&(a=new c(this.entity),this.system._preRegisterInstance(this.entity,g,c._pcScriptName,a));0===b&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))}});
var gm=["enabled","scripts","instances","runInTools"],me=function(a){B.call(this,a);this.id="script";this.description="Allows the Entity to run JavaScript fragments to implement custom behavior.";this.ComponentType=wd;this.DataType=zn;this.schema=gm;this.preloading=!1;this.instancesWithUpdate=[];this.instancesWithFixedUpdate=[];this.instancesWithPostUpdate=[];this.instancesWithToolsUpdate=[];this.on("beforeremove",this.onBeforeRemove,this);B.bind("initialize",this.onInitialize,this);B.bind("postInitialize",
this.onPostInitialize,this);B.bind("update",this.onUpdate,this);B.bind("fixedUpdate",this.onFixedUpdate,this);B.bind("postUpdate",this.onPostUpdate,this);B.bind("toolsUpdate",this.onToolsUpdate,this)};me.prototype=Object.create(B.prototype);me.prototype.constructor=me;G._buildAccessors(wd.prototype,gm);Object.assign(me.prototype,{initializeComponentData:function(a,b,c){c=["runInTools","enabled","scripts"];b.scripts&&b.scripts.length&&b.scripts.forEach(function(a){if(a.attributes&&"array"===za(a.attributes)){for(var b=
{},c=0;c<a.attributes.length;c++)b[a.attributes[c].name]=a.attributes[c];a.attributes=b}});B.prototype.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){var c=this.store[a.getGuid()];a={runInTools:c.data.runInTools,scripts:[],enabled:c.data.enabled};c=c.data.scripts;for(var d=0,e=c.length;d<e;d++){var g=c[d].attributes;g&&delete c[d].attributes;a.scripts.push(Ec({},c[d]));g&&(a.scripts[d].attributes=this._cloneAttributes(g),c[d].attributes=g)}return this.addComponent(b,a)},onBeforeRemove:function(a,
b){b.enabled&&this._disableScriptComponent(b);this._destroyScriptComponent(b)},onInitialize:function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);a=a._children;var b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof S)this.onInitialize(a[b])}},onPostInitialize:function(a){if(a.enabled){a.script&&a.script.enabled&&this._postInitializeScriptComponent(a.script);a=a._children;var b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof S)this.onPostInitialize(a[b])}},
_callInstancesMethod:function(a,b){a=a.data.instances;for(var c in a)if(a.hasOwnProperty(c)){var d=a[c].instance;if(d[b])d[b]()}},_initializeScriptComponent:function(a){this._callInstancesMethod(a,"initialize");a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)},_enableScriptComponent:function(a){this._callInstancesMethod(a,"onEnable")},_disableScriptComponent:function(a){this._callInstancesMethod(a,"onDisable")},_destroyScriptComponent:function(a){var b=a.data.instances,
c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c].instance;d.destroy&&d.destroy();if(d.update){var e=this.instancesWithUpdate.indexOf(d);0<=e&&this.instancesWithUpdate.splice(e,1)}d.fixedUpdate&&(e=this.instancesWithFixedUpdate.indexOf(d),0<=e&&this.instancesWithFixedUpdate.splice(e,1));d.postUpdate&&(e=this.instancesWithPostUpdate.indexOf(d),0<=e&&this.instancesWithPostUpdate.splice(e,1));d.toolsUpdate&&(e=this.instancesWithToolsUpdate.indexOf(d),0<=e&&this.instancesWithToolsUpdate.splice(e,1));a.instances[c].instance===
a[c]&&delete a[c];delete a.instances[c]}},_postInitializeScriptComponent:function(a){this._callInstancesMethod(a,"postInitialize");a.data.postInitialized=!0},_updateInstances:function(a,b,c){for(var d,e=0,g=b.length;e<g;e++)if((d=b[e])&&d.entity&&d.entity.enabled&&d.entity.script.enabled)d[a](c)},onUpdate:function(a){this._updateInstances("update",this.instancesWithUpdate,a)},onFixedUpdate:function(a){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,a)},onPostUpdate:function(a){this._updateInstances("postUpdate",
this.instancesWithPostUpdate,a)},onToolsUpdate:function(a){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,a)},broadcast:function(a,b){console.warn("DEPRECATED: ScriptLegacyComponentSystem.broadcast() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var c=gd(arguments).slice(2),d,e,g=this.store;for(d in g)if(g.hasOwnProperty(d)){var f=g[d].data;f.instances[a]&&(e=f.instances[a].instance[b])&&e.apply(f.instances[a].instance,
c)}},_preRegisterInstance:function(a,b,c,d){if(a.script){a.script.data._instances=a.script.data._instances||{};if(a.script.data._instances[c])throw Error("Script name collision '"+c+"'. Scripts from '"+b+"' and '"+a.script.data._instances[c].url+"' {"+a.getGuid()+"}");a.script.data._instances[c]={url:b,name:c,instance:d}}},_registerInstances:function(a){var b;if(a.script&&a.script.data._instances){a.script.instances=a.script.data._instances;for(b in a.script.instances){var c=a.script.instances[b];
var d=c.instance;jf.attach(d);d.update&&this.instancesWithUpdate.push(d);d.fixedUpdate&&this.instancesWithFixedUpdate.push(d);d.postUpdate&&this.instancesWithPostUpdate.push(d);d.toolsUpdate&&this.instancesWithToolsUpdate.push(d);a.script.scripts&&this._createAccessors(a,c);if(a.script[b])throw Error("Script with name '"+b+"' is already attached to Script Component");a.script[b]=d}delete a.script.data._instances}a=a._children;d=a.length;for(c=0;c<d;c++)a[c]instanceof S&&this._registerInstances(a[c])},
_cloneAttributes:function(a){var b={},c;for(c in a)if(a.hasOwnProperty(c))if("entity"!==a[c].type)b[c]=Ec({},a[c]);else{var d=a[c].value;delete a[c].value;b[c]=Ec({},a[c]);b[c].value=d;a[c].value=d}return b},_createAccessors:function(a,b){var c,d=a.script.scripts.length,e=b.url;for(c=0;c<d;c++){var g=a.script.scripts[c];if(g.url===e){c=g.attributes;if(g.name&&c){for(var f in c)c.hasOwnProperty(f)&&this._createAccessor(c[f],b);a.script.data.attributes[g.name]=this._cloneAttributes(c)}break}}},_createAccessor:function(a,
b){var c=this;a={name:a.name,value:a.value,type:a.type};c._convertAttributeValue(a);Object.defineProperty(b.instance,a.name,{get:function(){return a.value},set:function(d){var e=a.value;a.value=d;c._convertAttributeValue(a);b.instance.fire("set",a.name,e,a.value)},configurable:!0})},_updateAccessors:function(a,b){var c,d=a.script.scripts.length,e,g=b.url;for(c=0;c<d;c++){var f=a.script;var l=f.scripts[c];if(l.url===g){a=l.name;l=l.attributes;if(a){if(l)for(e in l)l.hasOwnProperty(e)&&this._createAccessor(l[e],
b);if(c=f.data.attributes[a])for(e in c)if(d=c[e],!(e in l))delete b.instance[d.name];else if(l[e].value!==d.value&&b.instance.onAttributeChanged)b.instance.onAttributeChanged(d.name,d.value,l[e].value);l?f.data.attributes[a]=this._cloneAttributes(l):delete f.data.attributes[a]}break}}},_convertAttributeValue:function(a){if("rgb"===a.type||"rgba"===a.type)"array"===za(a.value)&&(a.value=3===a.value.length?new J(a.value[0],a.value[1],a.value[2]):new J(a.value[0],a.value[1],a.value[2],a.value[3]));
else if("vec2"===a.type)"array"===za(a.value)&&(a.value=new M(a.value[0],a.value[1]));else if("vec3"===a.type||"vector"===a.type)"array"===za(a.value)&&(a.value=new r(a.value[0],a.value[1],a.value[2]));else if("vec4"===a.type)"array"===za(a.value)&&(a.value=new U(a.value[0],a.value[1],a.value[2],a.value[3]));else if("entity"===a.type)null!==a.value&&"string"===typeof a.value&&(a.value=this.app.root.findByGuid(a.value));else if("curve"===a.type||"colorcurve"===a.type)a.value=new (a.value.keys[0]instanceof
Array?rb:Ya)(a.value.keys),a.value.type=a.value.type}});var cd=new M,hm=new r,Hf=new r,dh=new r,im=new r,vj=new r,Uo=new T,Vo={x:"y",y:"x"};wc.prototype=Object.create(H.prototype);wc.prototype.constructor=wc;Object.assign(wc.prototype,{_toggleLifecycleListeners:function(a){this._element[a]("mousedown",this._onMouseDownOrTouchStart,this);this._element[a]("touchstart",this._onMouseDownOrTouchStart,this)},_toggleDragListeners:function(a){var b="on"===a,c=b?"addEventListener":"removeEventListener";this._hasDragListeners&&
b||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[a]("mousemove",this._onMove,this),window[c]("mouseup",this._handleMouseUpOrTouchEnd,!1)),va.touch&&(this._app.touch[a]("touchmove",this._onMove,this),window[c]("touchend",this._handleMouseUpOrTouchEnd,!1),window[c]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=b)},_onMouseDownOrTouchStart:function(a){this._element&&!this._isDragging&&this.enabled&&
(this._dragCamera=a.camera,this._calculateDragScale(),a=this._screenToLocal(a))&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(a),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))},_onMouseUpOrTouchEnd:function(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))},_screenToLocal:function(a){this._determineInputPosition(a);this._chooseRayOriginAndDirection();im.copy(this._element.entity.getPosition());
vj.copy(this._element.entity.forward).scale(-1);a=vj.dot(dh);return 0<Math.abs(a)?(a=im.sub(Hf).dot(vj)/a,a=Hf.add(dh.scale(a)),Uo.copy(this._element.entity.getRotation()).invert().transformVector(a,a),a.mul(this._dragScale),a):null},_determineInputPosition:function(a){var b=this._app.graphicsDevice.maxPixelRatio;"undefined"!==typeof a.x&&"undefined"!==typeof a.y?(cd.x=a.x*b,cd.y=a.y*b):a.changedTouches?(cd.x=a.changedTouches[0].x*b,cd.y=a.changedTouches[0].y*b):console.warn("Could not determine position from input event")},
_chooseRayOriginAndDirection:function(){this._element.screen&&this._element.screen.screen.screenSpace?(Hf.set(cd.x,-cd.y,0),dh.set(0,0,-1)):(hm.copy(this._dragCamera.screenToWorld(cd.x,cd.y,1)),Hf.copy(this._dragCamera.entity.getPosition()),dh.copy(hm).sub(Hf).normalize())},_calculateDragScale:function(){var a=this._element.entity.parent,b=this._element.screen&&this._element.screen.screen,c=b&&b.screenSpace;b=c?b.scale:1;var d=this._dragScale;for(d.set(b,b,b);a&&(d.mul(a.getLocalScale()),a=a.parent,
!c||!a.screen););d.x=1/d.x;d.y=1/d.y;d.z=1/d.z},_onMove:function(a){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled&&(a=this._screenToLocal(a),this._dragStartMousePosition&&a)){this._deltaMousePosition.copy(a).sub(this._dragStartMousePosition);this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition);if(this._axis){a=this._element.entity.getLocalPosition();var b=Vo[this._axis];this._deltaHandlePosition[b]=a[b]}this._element.entity.setLocalPosition(this._deltaHandlePosition);
this.fire("drag:move",this._deltaHandlePosition)}},destroy:function(){this._toggleLifecycleListeners("off");this._toggleDragListeners("off")}});Object.defineProperty(wc.prototype,"enabled",{get:function(){return this._enabled},set:function(a){this._enabled=a}});Object.defineProperty(wc.prototype,"isDragging",{get:function(){return this._isDragging}});var wj=new M;Rc.prototype=Object.create(G.prototype);Rc.prototype.constructor=Rc;Object.assign(Rc.prototype,{_toggleLifecycleListeners:function(a,b){this[a]("set_horizontal",
this._onSetHorizontalScrollingEnabled,this);this[a]("set_vertical",this._onSetVerticalScrollingEnabled,this);b.app.systems.element[a]("add",this._onElementComponentAdd,this);b.app.systems.element[a]("beforeremove",this._onElementComponentRemove,this)},_toggleElementListeners:function(a){!this.entity.element||"on"===a&&this._hasElementListeners||(this.entity.element[a]("resize",this._onSetContentOrViewportSize,this),this._hasElementListeners="on"===a)},_onElementComponentAdd:function(a){this.entity===
a&&this._toggleElementListeners("on")},_onElementComponentRemove:function(a){this.entity===a&&this._toggleElementListeners("off")},_onViewportElementGain:function(){this._syncAll()},_onContentElementGain:function(){this._destroyDragHelper();this._contentDragHelper=new wc(this._contentReference.entity.element);this._contentDragHelper.on("drag:start",this._onContentDragStart,this);this._contentDragHelper.on("drag:end",this._onContentDragEnd,this);this._contentDragHelper.on("drag:move",this._onContentDragMove,
this);this._prevContentSizes[0]=null;this._prevContentSizes[1]=null;this._syncAll()},_onContentElementLose:function(){this._destroyDragHelper()},_onContentDragStart:function(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())},_onContentDragEnd:function(){this._prevContentDragPosition=null;this._enableContentInput()},_onContentDragMove:function(a){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&
(this._wasDragged=!0,this._setScrollFromContentPosition(a),this._setVelocityFromContentPositionDelta(a),!this._disabledContentInput)){var b=a.y-this._dragStartPosition.y;(Math.abs(a.x-this._dragStartPosition.x)>this.dragThreshold||Math.abs(b)>this.dragThreshold)&&this._disableContentInput()}},_onSetContentOrViewportSize:function(){this._syncAll()},_onSetHorizontalScrollbarValue:function(a){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(a,null)},_onSetVerticalScrollbarValue:function(a){!this._scrollbarUpdateFlags[1]&&
this.enabled&&this.entity.enabled&&this._onSetScroll(null,a)},_onSetHorizontalScrollingEnabled:function(){this._syncScrollbarEnabledState(0)},_onSetVerticalScrollingEnabled:function(){this._syncScrollbarEnabledState(1)},_onHorizontalScrollbarGain:function(){this._syncScrollbarEnabledState(0);this._syncScrollbarPosition(0)},_onVerticalScrollbarGain:function(){this._syncScrollbarEnabledState(1);this._syncScrollbarPosition(1)},_onSetScroll:function(a,b,c){!1!==c&&this._velocity.set(0,0,0);a=0|this._updateAxis(a,
"x",0);(a|=this._updateAxis(b,"y",1))&&this.fire("set:scroll",this._scroll)},_updateAxis:function(a,b,c){var d=null!==a&&1E-5<Math.abs(a-this._scroll[b]);if(d||this._isDragging()||0===a)this._scroll[b]=this._determineNewScrollValue(a,b,c),this._syncContentPosition(c),this._syncScrollbarPosition(c);return d},_determineNewScrollValue:function(a,b,c){if(!this._getScrollingEnabled(c))return this._scroll[b];switch(this.scrollMode){case 0:return O.clamp(a,0,this._getMaxScrollValue(c));case 1:return this._setVelocityFromOvershoot(a,
b,c),a;case 2:return a;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),a}},_syncAll:function(){this._syncContentPosition(0);this._syncContentPosition(1);this._syncScrollbarPosition(0);this._syncScrollbarPosition(1);this._syncScrollbarEnabledState(0);this._syncScrollbarEnabledState(1)},_syncContentPosition:function(a){var b=this._getAxis(a),c=this._getSign(a),d=this._contentReference.entity;if(d){var e=this._prevContentSizes[a],g=this._getContentSize(a);if(null!==e&&1E-4<Math.abs(e-
g)){e=this._getMaxOffset(a,e);var f=this._getMaxOffset(a,g);this._scroll[b]=0===f?1:O.clamp(this._scroll[b]*e/f,0,1)}e=this._scroll[b]*this._getMaxOffset(a);f=d.getLocalPosition();f[b]=e*c;d.setLocalPosition(f);this._prevContentSizes[a]=g}},_syncScrollbarPosition:function(a){var b=this._getAxis(a),c=this._scrollbarReferences[a].entity;c&&c.scrollbar&&(this._scrollbarUpdateFlags[a]=!0,c.scrollbar.value=this._scroll[b],c.scrollbar.handleSize=this._getScrollbarHandleSize(b,a),this._scrollbarUpdateFlags[a]=
!1)},_syncScrollbarEnabledState:function(a){var b=this._scrollbarReferences[a].entity;if(b){var c=this._getScrollingEnabled(a),d=this._getScrollbarVisibility(a);switch(d){case 0:b.enabled=c;break;case 1:b.enabled=c&&this._contentIsLargerThanViewport(a);break;default:console.warn("Unhandled scrollbar visibility:"+d),b.enabled=c}}},_contentIsLargerThanViewport:function(a){return this._getContentSize(a)>this._getViewportSize(a)},_contentPositionToScrollValue:function(a){var b=this._getMaxOffset(0),c=
this._getMaxOffset(1);wj.x=0===b?0:a.x/b;wj.y=0===c?0:a.y/-c;return wj},_getMaxOffset:function(a,b){b=void 0===b?this._getContentSize(a):b;var c=this._getViewportSize(a);return b<c?-this._getViewportSize(a):c-b},_getMaxScrollValue:function(a){return this._contentIsLargerThanViewport(a)?1:0},_getScrollbarHandleSize:function(a,b){var c=this._getViewportSize(b),d=this._getContentSize(b);if(.001>Math.abs(d))return 1;c=Math.min(c/d,1);a=this._toOvershoot(this._scroll[a],b);return 0===a?c:c/(1+Math.abs(a))},
_getViewportSize:function(a){return this._getSize(a,this._viewportReference)},_getContentSize:function(a){return this._getSize(a,this._contentReference)},_getSize:function(a,b){return b.entity&&b.entity.element?b.entity.element[this._getCalculatedDimension(a)]:0},_getScrollingEnabled:function(a){if(0===a)return this.horizontal;if(1===a)return this.vertical;console.warn("Unrecognized orientation: "+a)},_getScrollbarVisibility:function(a){if(0===a)return this.horizontalScrollbarVisibility;if(1===a)return this.verticalScrollbarVisibility;
console.warn("Unrecognized orientation: "+a)},_getSign:function(a){return 0===a?1:-1},_getAxis:function(a){return 0===a?"x":"y"},_getCalculatedDimension:function(a){return 0===a?"calculatedWidth":"calculatedHeight"},_destroyDragHelper:function(){this._contentDragHelper&&this._contentDragHelper.destroy()},onUpdate:function(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))},_updateVelocity:function(){if(!this._isDragging()&&
(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction,1E-4<Math.abs(this._velocity.x)||1E-4<Math.abs(this._velocity.y))){var a=this._contentReference.entity.getLocalPosition();a.x+=this._velocity.x;a.y+=this._velocity.y;this._contentReference.entity.setLocalPosition(a);this._setScrollFromContentPosition(a)}},
_hasOvershoot:function(a,b){return.001<Math.abs(this._toOvershoot(this.scroll[a],b))},_toOvershoot:function(a,b){b=this._getMaxScrollValue(b);return 0>a?a:a>b?a-b:0},_setVelocityFromOvershoot:function(a,b,c){a=this._toOvershoot(a,c)*this._getMaxOffset(c)*this._getSign(c);0<Math.abs(a)&&(this._velocity[b]=-a/(50*this.bounceAmount+1))},_setVelocityFromContentPositionDelta:function(a){this._prevContentDragPosition?(this._velocity.sub2(a,this._prevContentDragPosition),this._prevContentDragPosition.copy(a)):
(this._velocity.set(0,0,0),this._prevContentDragPosition=a.clone())},_setScrollFromContentPosition:function(a){a=this._contentPositionToScrollValue(a);this._isDragging()&&(a=this._applyScrollValueTension(a));this._onSetScroll(a.x,a.y,!1)},_applyScrollValueTension:function(a){var b=this._getMaxScrollValue(0);var c=this._toOvershoot(a.x,0);0<c?a.x=b+1*Math.log10(1+c):0>c&&(a.x=-1*Math.log10(1-c));b=this._getMaxScrollValue(1);c=this._toOvershoot(a.y,1);0<c?a.y=b+1*Math.log10(1+c):0>c&&(a.y=-1*Math.log10(1-
c));return a},_isDragging:function(){return this._contentDragHelper&&this._contentDragHelper.isDragging},_setScrollbarComponentsEnabled:function(a){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=a);this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=a)},_setContentDraggingEnabled:function(a){this._contentDragHelper&&(this._contentDragHelper.enabled=a)},_enableContentInput:function(){for(;this._disabledContentInputEntities.length;){var a=
this._disabledContentInputEntities.pop();a.element&&(a.element.useInput=!0)}this._disabledContentInput=!1},_disableContentInput:function(){var a=this,b=function(c){c.element&&c.element.useInput&&(a._disabledContentInputEntities.push(c),c.element.useInput=!1);c=c.children;var d;var e=0;for(d=c.length;e<d;e++)b(c[e])},c=this._contentReference.entity;if(c){c=c.children;var d,e=c.length;for(d=0;d<e;d++)b(c[d])}this._disabledContentInput=!0},onEnable:function(){this._viewportReference.onParentComponentEnable();
this._contentReference.onParentComponentEnable();this._scrollbarReferences[0].onParentComponentEnable();this._scrollbarReferences[1].onParentComponentEnable();this._setScrollbarComponentsEnabled(!0);this._setContentDraggingEnabled(!0);this._syncAll()},onDisable:function(){this._setScrollbarComponentsEnabled(!1);this._setContentDraggingEnabled(!1)},onRemove:function(){this._toggleLifecycleListeners("off",this.system);this._toggleElementListeners("off");this._destroyDragHelper()}});Object.defineProperty(Rc.prototype,
"scroll",{get:function(){return this._scroll},set:function(a){this._onSetScroll(a.x,a.y)}});var xj=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",
type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],ne=function(a){B.call(this,a);this.id="scrollview";this.ComponentType=Rc;this.DataType=An;this.schema=xj;this.on("beforeremove",this._onRemoveComponent,this);B.bind("update",this.onUpdate,this)};ne.prototype=Object.create(B.prototype);ne.prototype.constructor=ne;G._buildAccessors(Rc.prototype,xj);Object.assign(ne.prototype,{initializeComponentData:function(a,b,c){void 0===b.dragThreshold&&
(b.dragThreshold=10);B.prototype.initializeComponentData.call(this,a,b,xj)},onUpdate:function(a){a=this.store;for(var b in a){var c=a[b].entity,d=c.scrollview;if(d.enabled&&c.enabled)d.onUpdate()}},_onRemoveComponent:function(a,b){b.onRemove()}});xd.prototype=Object.create(G.prototype);xd.prototype.constructor=xd;Object.assign(xd.prototype,{_toggleLifecycleListeners:function(a){this[a]("set_value",this._onSetValue,this);this[a]("set_handleSize",this._onSetHandleSize,this);this[a]("set_orientation",
this._onSetOrientation,this)},_onHandleElementGain:function(){this._destroyDragHelper();this._handleDragHelper=new wc(this._handleReference.entity.element,this._getAxis());this._handleDragHelper.on("drag:move",this._onHandleDrag,this);this._updateHandlePositionAndSize()},_onHandleElementLose:function(){this._destroyDragHelper()},_onHandleDrag:function(a){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(a[this._getAxis()]))},_onSetValue:function(a,
b,c){1E-5<Math.abs(c-b)&&(this.data.value=O.clamp(c,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))},_onSetHandleSize:function(a,b,c){1E-5<Math.abs(c-b)&&(this.data.handleSize=O.clamp(c,0,1),this._updateHandlePositionAndSize())},_onSetHandleAlignment:function(){this._updateHandlePositionAndSize()},_onSetOrientation:function(a,b,c){c!==b&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)},_updateHandlePositionAndSize:function(){var a=
this._handleReference.entity,b=a&&a.element;a&&(a=a.getLocalPosition(),a[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(a));b&&(b[this._getDimension()]=this._getHandleLength())},_handlePositionToScrollValue:function(a){return a*this._getSign()/this._getUsableTrackLength()},_scrollValueToHandlePosition:function(a){return a*this._getSign()*this._getUsableTrackLength()},_getUsableTrackLength:function(){return Math.max(this._getTrackLength()-this._getHandleLength(),
.001)},_getTrackLength:function(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0},_getHandleLength:function(){return this._getTrackLength()*this.handleSize},_getHandlePosition:function(){return this._scrollValueToHandlePosition(this.value)},_getSign:function(){return 0===this.orientation?1:-1},_getAxis:function(){return 0===this.orientation?"x":"y"},_getDimension:function(){return 0===this.orientation?"width":"height"},_getOppositeDimension:function(){return 0===
this.orientation?"height":"width"},_destroyDragHelper:function(){this._handleDragHelper&&this._handleDragHelper.destroy()},_setHandleDraggingEnabled:function(a){this._handleDragHelper&&(this._handleDragHelper.enabled=a)},onEnable:function(){this._handleReference.onParentComponentEnable();this._setHandleDraggingEnabled(!0)},onDisable:function(){this._setHandleDraggingEnabled(!1)},onRemove:function(){this._destroyDragHelper();this._toggleLifecycleListeners("off")}});var Ai=[{name:"enabled",type:"boolean"},
{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];je.prototype=Object.create(B.prototype);je.prototype.constructor=je;G._buildAccessors(xd.prototype,Ai);Object.assign(je.prototype,{initializeComponentData:function(a,b,c){B.prototype.initializeComponentData.call(this,a,b,Ai)},_onRemoveComponent:function(a,b){b.onRemove()}});Kc()?(f.SoundInstance=function(a,b,c){H.call(this);c=c||{};this._volume=void 0!==c.volume?O.clamp(Number(c.volume)||
0,0,1):1;this._pitch=void 0!==c.pitch?Math.max(.01,Number(c.pitch)||0):1;this._loop=!(void 0===c.loop||!c.loop);this._sound=b;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._startTime=Math.max(0,Number(c.startTime)||0);this._duration=Math.max(0,Number(c.duration)||0);this._startedAt=0;this._startOffset=null;this._currentOffset=this._currentTime=0;this._playWhenLoaded=!0;this._manager=a;this._lastNode=this._firstNode=this._connectorNode=this._inputNode=null;
this._initializeNodes();this._onPlayCallback=c.onPlay;this._onPauseCallback=c.onPause;this._onResumeCallback=c.onResume;this._onStopCallback=c.onStop;this._onEndCallback=c.onEnd;this._endedHandler=this._onEnded.bind(this);this.source=null},f.SoundInstance.prototype=Object.create(H.prototype),f.SoundInstance.prototype.constructor=f.SoundInstance,Object.assign(f.SoundInstance.prototype,{_initializeNodes:function(){this._connectorNode=this._inputNode=this.gain=this._manager.context.createGain();this._connectorNode.connect(this._manager.context.destination)},
play:function(){2!==this._state&&this.stop();this.source||this._createSource();var a=this._startOffset%this.duration||0;a=(this._startTime+a)%this._sound.duration||0;this._startOffset=null;this._duration?this.source.start(0,a,this._duration):this.source.start(0,a);this._startedAt=this._manager.context.currentTime;this._currentTime=0;this._currentOffset=a;this._state=0;this._playWhenLoaded=!1;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._manager.on("volumechange",this._onManagerVolumeChange,
this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this._onPlay();return!0},pause:function(){if(0!==this._state||!this.source)return!1;this._updateCurrentTime();this._state=1;this._suspendEndEvent=!0;this.source.stop(0);this.source=null;this._playWhenLoaded=!1;this._startOffset=null;this._suspendInstanceEvents||
this._onPause();return!0},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();var a=this.currentTime;null!==this._startOffset&&(a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0,this._startOffset=null);this._duration?this.source.start(0,a,this._duration):this.source.start(0,a);this._state=0;this._startedAt=this._manager.context.currentTime;this._currentOffset=a;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._playWhenLoaded=
!1;this._suspendInstanceEvents||this._onResume();return!0},stop:function(){if(2===this._state||!this.source)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",this._onManagerDestroy,this);this._currentOffset=this._currentTime=this._startedAt=0;this._startOffset=null;this._playWhenLoaded=!1;this._suspendEndEvent=!0;0===this._state&&this.source.stop(0);
this.source=null;this._state=2;this._suspendInstanceEvents||this._onStop();return!0},setExternalNodes:function(a,b){if(a){b||(b=a);var c=this._manager.context.destination;this._firstNode!==a&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(c),this._firstNode=a,this._connectorNode.connect(a));this._lastNode!==b&&(this._lastNode&&this._lastNode.disconnect(c),this._lastNode=b,this._lastNode.connect(c))}else console.error("The firstNode must be a valid Audio Node")},
clearExternalNodes:function(){var a=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null);this._lastNode&&(this._lastNode.disconnect(a),this._lastNode=null);this._connectorNode.connect(a)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;var a=this._manager.context;this._sound.buffer&&(this.source=a.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),
this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0)));return this.source},_updateCurrentTime:function(){this._currentTime=((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset)%this.duration||0},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=
null)}}),Object.defineProperty(f.SoundInstance.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=a=O.clamp(a,0,1);this.gain&&(this.gain.gain.value=a*this._manager.volume)}}),Object.defineProperty(f.SoundInstance.prototype,"pitch",{get:function(){return this._pitch},set:function(a){this._currentOffset=this.currentTime;this._startedAt=this._manager.context.currentTime;this._pitch=Math.max(Number(a)||0,.01);this.source&&(this.source.playbackRate.value=this._pitch)}}),
Object.defineProperty(f.SoundInstance.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(f.SoundInstance.prototype,"sound",{get:function(){return this._sound},set:function(a){this._sound=a;2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(f.SoundInstance.prototype,"currentTime",{get:function(){if(null!==this._startOffset)return this._startOffset;if(1===this._state)return this._currentTime;
if(2===this._state||!this.source)return 0;this._updateCurrentTime();return this._currentTime},set:function(a){if(!(0>a))if(0===this._state){this.stop();var b=this._suspendInstanceEvents;this._suspendInstanceEvents=!0;this._startOffset=a;this.play();this._suspendInstanceEvents=b}else this._currentTime=this._startOffset=a}})):Td()?(f.SoundInstance=function(a,b,c){H.call(this);c=c||{};this._volume=void 0!==c.volume?O.clamp(Number(c.volume)||0,0,1):1;this._pitch=void 0!==c.pitch?Math.max(.01,Number(c.pitch)||
0):1;this._loop=!(void 0===c.loop||!c.loop);this._sound=b;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._playWhenLoaded=!0;this._startTime=Math.max(0,Number(c.startTime)||0);this._duration=Math.max(0,Number(c.duration)||0);this._startOffset=null;this._isReady=!1;this._manager=a;this._loadedMetadataHandler=this._onLoadedMetadata.bind(this);this._timeUpdateHandler=this._onTimeUpdate.bind(this);this._endedHandler=this._onEnded.bind(this);this._onPlayCallback=
c.onPlay;this._onPauseCallback=c.onPause;this._onResumeCallback=c.onResume;this._onStopCallback=c.onStop;this._onEndCallback=c.onEnd;this.source=null;this._createSource()},f.SoundInstance.prototype=Object.create(H.prototype),f.SoundInstance.prototype.constructor=f.SoundInstance,Object.assign(f.SoundInstance.prototype,{play:function(){2!==this._state&&this.stop();if(!this.source&&!this._createSource())return!1;this.volume=this._volume;this.pitch=this._pitch;this.loop=this._loop;this.source.play();
this._state=0;this._playWhenLoaded=!1;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this._onPlay();return!0},pause:function(){if(!this.source||0!==this._state)return!1;this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;
this._state=1;this._startOffset=null;this._suspendInstanceEvents||this._onPause();return!0},resume:function(){if(!this.source||1!==this._state)return!1;this._state=0;this._playWhenLoaded=!1;this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume());return!0},stop:function(){if(!this.source||2===this._state)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,
this);this._manager.off("destroy",this._onManagerDestroy,this);this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=2;this._startOffset=null;this._suspendInstanceEvents||this._onStop();return!0},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler);this._isReady=!0;var a=this._startOffset%this.duration||0;a=(this._startTime+
a)%this._sound.duration||0;this._startOffset=null;this.source.currentTime=a},_createSource:function(){this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler);return this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||
0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(f.SoundInstance.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=a=O.clamp(a,0,1);this.source&&(this.source.volume=a*this._manager.volume)}}),Object.defineProperty(f.SoundInstance.prototype,
"pitch",{get:function(){return this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,.01);this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(f.SoundInstance.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(f.SoundInstance.prototype,"sound",{get:function(){return this._sound},set:function(a){this.stop();this._sound=a}}),Object.defineProperty(f.SoundInstance.prototype,
"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(a){0>a||(this._startOffset=a,this.source&&this._isReady&&(this.source.currentTime=(this._startTime+(a%this.duration||0))%this._sound.duration||0,this._startOffset=null))}})):f.SoundInstance=function(){};Object.assign(f.SoundInstance.prototype,{_onPlay:function(){this.fire("play");this._onPlayCallback&&this._onPlayCallback(this)},_onPause:function(){this.fire("pause");
this._onPauseCallback&&this._onPauseCallback(this)},_onResume:function(){this.fire("resume");this._onResumeCallback&&this._onResumeCallback(this)},_onStop:function(){this.fire("stop");this._onStopCallback&&this._onStopCallback(this)},_onEnded:function(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())},_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){0!==this._state||this._suspended||
(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}});Object.defineProperty(f.SoundInstance.prototype,"startTime",{get:function(){return this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);a=0===this._state;this.stop();a&&this.play()}});Object.defineProperty(f.SoundInstance.prototype,"duration",{get:function(){return this._sound?this._duration?this._duration%this._sound.duration||0:this._sound.duration:0},set:function(a){this._duration=
Math.max(0,Number(a)||0);a=0===this._state;this.stop();a&&this.play()}});Object.defineProperty(f.SoundInstance.prototype,"isPlaying",{get:function(){return 0===this._state}});Object.defineProperty(f.SoundInstance.prototype,"isPaused",{get:function(){return 1===this._state}});Object.defineProperty(f.SoundInstance.prototype,"isStopped",{get:function(){return 2===this._state}});Object.defineProperty(f.SoundInstance.prototype,"isSuspended",{get:function(){return this._suspended}});if(Kc())f.SoundInstance3d=
function(a,b,c){f.SoundInstance.call(this,a,b,c);c=c||{};this._position=new r;c.position&&(this.position=c.position);this._velocity=new r;c.velocity&&(this.velocity=c.velocity);this.maxDistance=void 0!==c.maxDistance?Number(c.maxDistance):1E4;this.refDistance=void 0!==c.refDistance?Number(c.refDistance):1;this.rollOffFactor=void 0!==c.rollOffFactor?Number(c.rollOffFactor):1;this.distanceModel=void 0!==c.distanceModel?c.distanceModel:"linear"},f.SoundInstance3d.prototype=Object.create(f.SoundInstance.prototype),
f.SoundInstance3d.prototype.constructor=f.SoundInstance3d,Object.assign(f.SoundInstance3d.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain();this.panner=this._manager.context.createPanner();this.panner.connect(this.gain);this._inputNode=this.panner;this._connectorNode=this.gain;this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(f.SoundInstance3d.prototype,"position",{get:function(){return this._position},set:function(a){this._position.copy(a);
this.panner.setPosition(a.x,a.y,a.z)}}),Object.defineProperty(f.SoundInstance3d.prototype,"velocity",{get:function(){return this._velocity},set:function(a){this._velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)}}),Object.defineProperty(f.SoundInstance3d.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(a){this.panner.maxDistance=a}}),Object.defineProperty(f.SoundInstance3d.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(a){this.panner.refDistance=
a}}),Object.defineProperty(f.SoundInstance3d.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(a){this.panner.rolloffFactor=a}}),Object.defineProperty(f.SoundInstance3d.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(a){this.panner.distanceModel=a}});else if(Td()){var yj=new r;f.SoundInstance3d=function(a,b,c){f.SoundInstance.call(this,a,b,c);c=c||{};this._position=new r;c.position&&(this.position=c.position);this._velocity=
new r;c.velocity&&(this.velocity=c.velocity);this._maxDistance=void 0!==c.maxDistance?Number(c.maxDistance):1E4;this._refDistance=void 0!==c.refDistance?Number(c.refDistance):1;this._rollOffFactor=void 0!==c.rollOffFactor?Number(c.rollOffFactor):1;this._distanceModel=void 0!==c.distanceModel?c.distanceModel:"linear"};f.SoundInstance3d.prototype=Object.create(f.SoundInstance.prototype);f.SoundInstance3d.prototype.constructor=f.SoundInstance3d;Object.defineProperty(f.SoundInstance3d.prototype,"position",
{get:function(){return this._position},set:function(a){this._position.copy(a);if(this.source){var b=this._manager.listener.getPosition();a=this.refDistance;var c=this.maxDistance,d=this.rollOffFactor,e=this.distanceModel;yj=yj.sub2(b,this._position);b=yj.length();if(b<a)a=1;else if(b>c)a=0;else{var g=0;"linear"===e?g=1-d*(b-a)/(c-a):e===$e?g=a/(a+d*(b-a)):"exponential"===e&&(g=Math.pow(b/a,-d));a=O.clamp(g,0,1)}this.source.volume=this.volume*a*this._manager.volume}}});Object.defineProperty(f.SoundInstance3d.prototype,
"velocity",{get:function(){return this._velocity},set:function(a){this._velocity.copy(a)}});Object.defineProperty(f.SoundInstance3d.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(a){this._maxDistance=a}});Object.defineProperty(f.SoundInstance3d.prototype,"refDistance",{get:function(){return this._refDistance},set:function(a){this._refDistance=a}});Object.defineProperty(f.SoundInstance3d.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(a){this._rollOffFactor=
a}});Object.defineProperty(f.SoundInstance3d.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(a){this._distanceModel=a}})}else f.SoundInstance3d=function(){};var Xa={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new r,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};Da.prototype=Object.create(H.prototype);Da.prototype.constructor=Da;Object.assign(Da.prototype,{play:function(){this.overlap||
this.stop();if(this.isLoaded||this._hasAsset()){var a=this._createInstance();this.instances.push(a);if(this.isLoaded)a.play();else{var b=function(b){var c=a._playWhenLoaded;a.sound=b;c&&a.play()};this.off("load",b);this.once("load",b);this.load()}return a}},pause:function(){for(var a=!1,b=this.instances,c=0,d=b.length;c<d;c++)b[c].pause()&&(a=!0);return a},resume:function(){for(var a=!1,b=this.instances,c=0,d=b.length;c<d;c++)b[c].resume()&&(a=!0);return a},stop:function(){for(var a=!1,b=this.instances,
c=b.length;c--;)b[c].stop(),a=!0;b.length=0;return a},load:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);a?(a.off("remove",this._onAssetRemoved,this),a.on("remove",this._onAssetRemoved,this),a.resource?this.fire("load",a.resource):(a.off("load",this._onAssetLoad,this),a.once("load",this._onAssetLoad,this),this._assets.load(a))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this))}},setExternalNodes:function(a,
b){if(a){if(b||(b=a),this._firstNode=a,this._lastNode=b,!this._overlap)for(var c=this.instances,d=0,e=c.length;d<e;d++)c[d].setExternalNodes(a,b)}else console.error("The firstNode must have a valid AudioNode")},clearExternalNodes:function(){this._lastNode=this._firstNode=null;if(!this._overlap)for(var a=this.instances,b=0,c=a.length;b<c;b++)a[b].clearExternalNodes()},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return null!=this._asset},_createInstance:function(){var a=
this._component;var b=null;if(this._hasAsset()){var c=this._assets.get(this._asset);c&&(b=c.resource)}Xa.volume=this._volume*a.volume;Xa.pitch=this._pitch*a.pitch;Xa.loop=this._loop;Xa.startTime=this._startTime;Xa.duration=this._duration;Xa.onPlay=this._onInstancePlayHandler;Xa.onPause=this._onInstancePauseHandler;Xa.onResume=this._onInstanceResumeHandler;Xa.onStop=this._onInstanceStopHandler;Xa.onEnd=this._onInstanceEndHandler;a.positional?(Xa.position.copy(a.entity.getPosition()),Xa.maxDistance=
a.maxDistance,Xa.refDistance=a.refDistance,Xa.rollOffFactor=a.rollOffFactor,Xa.distanceModel=a.distanceModel,a=new f.SoundInstance3d(this._manager,b,Xa)):a=new f.SoundInstance(this._manager,b,Xa);this._firstNode&&a.setExternalNodes(this._firstNode,this._lastNode);return a},_onInstancePlay:function(a){this.fire("play",a);this._component.fire("play",this,a)},_onInstancePause:function(a){this.fire("pause",a);this._component.fire("pause",this,a)},_onInstanceResume:function(a){this.fire("resume",a);this._component.fire("resume",
this,a)},_onInstanceStop:function(a){var b=this.instances.indexOf(a);-1!==b&&this.instances.splice(b,1);this.fire("stop",a);this._component.fire("stop",this,a)},_onInstanceEnd:function(a){var b=this.instances.indexOf(a);-1!==b&&this.instances.splice(b,1);this.fire("end",a);this._component.fire("end",this,a)},_onAssetAdd:function(a){this.load()},_onAssetLoad:function(a){this.load()},_onAssetRemoved:function(a){a.off("remove",this._onAssetRemoved,this);this._assets.off("add:"+a.id,this._onAssetAdd,
this);this.stop()},updatePosition:function(a){for(var b=this.instances,c=0,d=b.length;c<d;c++)b[c].position=a}});Object.defineProperty(Da.prototype,"name",{get:function(){return this._name},set:function(a){this._name=a}});Object.defineProperty(Da.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=O.clamp(Number(a)||0,0,1);if(!this._overlap){a=this.instances;for(var b=0,c=a.length;b<c;b++)a[b].volume=this._volume*this._component.volume}}});Object.defineProperty(Da.prototype,
"pitch",{get:function(){return this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,.01);if(!this._overlap){a=this.instances;for(var b=0,c=a.length;b<c;b++)a[b].pitch=this.pitch*this._component.pitch}}});Object.defineProperty(Da.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;a=this.instances;for(var b=0,c=a.length;b<c;b++)a[b].loop=this._loop}});Object.defineProperty(Da.prototype,"autoPlay",{get:function(){return this._autoPlay},set:function(a){this._autoPlay=
!!a}});Object.defineProperty(Da.prototype,"overlap",{get:function(){return this._overlap},set:function(a){this._overlap=!!a}});Object.defineProperty(Da.prototype,"startTime",{get:function(){return this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);if(!this._overlap){a=this.instances;for(var b=0,c=a.length;b<c;b++)a[b].startTime=this._startTime}}});Object.defineProperty(Da.prototype,"duration",{get:function(){var a=0;this._hasAsset()&&(a=this._assets.get(this._asset),a=a.resource?
a.resource.duration:0);return null!=this._duration?this._duration%(a||1):a},set:function(a){this._duration=Math.max(0,Number(a)||0)||null;if(!this._overlap){a=this.instances;for(var b=0,c=a.length;b<c;b++)a[b].duration=this._duration}}});Object.defineProperty(Da.prototype,"asset",{get:function(){return this._asset},set:function(a){var b=this._asset;b&&(this._assets.off("add:"+b,this._onAssetAdd,this),(b=this._assets.get(b))&&b.off("remove",this._onAssetRemoved,this));this._asset=a;this._asset instanceof
X&&(this._asset=this._asset.id);this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}});Object.defineProperty(Da.prototype,"isLoaded",{get:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);if(a)return!!a.resource}return!1}});Object.defineProperty(Da.prototype,"isPlaying",{get:function(){for(var a=this.instances,b=0,c=a.length;b<c;b++)if(a[b].isPlaying)return!0;return!1}});Object.defineProperty(Da.prototype,"isPaused",{get:function(){var a=this.instances,
b=a.length;if(0===b)return!1;for(var c=0;c<b;c++)if(!a[c].isPaused)return!1;return!0}});Object.defineProperty(Da.prototype,"isStopped",{get:function(){for(var a=this.instances,b=0,c=a.length;b<c;b++)if(!a[b].isStopped)return!1;return!0}});yd.prototype=Object.create(G.prototype);yd.prototype.constructor=yd;Object.assign(yd.prototype,{onSetSlots:function(a,b,c){var d;if(b)for(d in b)b[d].stop();a={};for(d in c)c[d]instanceof Da?a[c[d].name]=c[d]:c[d].name&&(a[c[d].name]=new Da(this,c[d].name,c[d]));
this.data.slots=a;if(this.enabled&&this.entity.enabled)this.onEnable()},onSetVolume:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap)for(var e=b.instances,g=0,f=e.length;g<f;g++)e[g].volume=b.volume*c},onSetPitch:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap)for(var e=b.instances,g=0,f=e.length;g<f;g++)e[g].pitch=b.pitch*c},onSetRefDistance:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap){b=b.instances;for(var e=0,g=b.length;e<g;e++)b[e].refDistance=
c}},onSetMaxDistance:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap){b=b.instances;for(var e=0,g=b.length;e<g;e++)b[e].maxDistance=c}},onSetRollOffFactor:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap){b=b.instances;for(var e=0,g=b.length;e<g;e++)b[e].rollOffFactor=c}},onSetDistanceModel:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap){b=b.instances;for(var e=0,g=b.length;e<g;e++)b[e].distanceModel=c}},onSetPositional:function(a,
b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap){c=b.instances;for(var e=0,g=c.length;e<g;e++){var f=c[e].isPlaying||c[e].isSuspended,l=c[e].currentTime;f&&c[e].stop();c[e]=b._createInstance();f&&(c[e].play(),c[e].currentTime=l)}}},onEnable:function(){if(!this.system._inTools){var a=this.data.slots,b=this.data.playingBeforeDisable,c;for(c in a){var d=a[c];d.autoPlay&&d.isStopped?d.play():b[c]?d.resume():d.isLoaded||d.load()}}},onDisable:function(){var a=this.data.slots,b={},c;for(c in a)!a[c].overlap&&
a[c].isPlaying&&(a[c].pause(),b[c]=!0);this.data.playingBeforeDisable=b},onRemove:function(){this.off()},addSlot:function(a,b){var c=this.data.slots;if(c[a])return null;b=new Da(this,a,b);c[a]=b;b.autoPlay&&this.enabled&&this.entity.enabled&&b.play();return b},removeSlot:function(a){var b=this.data.slots;b[a]&&(b[a].stop(),delete b[a])},slot:function(a){return this.data.slots[a]},play:function(a){return this.enabled&&this.entity.enabled?(a=this.slots[a])?a.play():null:null},pause:function(a){var b=
this.data.slots;if(a)(a=b[a])&&a.pause();else for(var c in b)b[c].pause()},resume:function(a){var b=this.data.slots;if(a)(a=b[a])&&a.isPaused&&a.resume();else for(var c in b)b[c].resume()},stop:function(a){var b=this.data.slots;if(a)(a=b[a])&&a.stop();else for(var c in b)b[c].stop()}});var jm="enabled volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots".split(" "),Tc=function(a,b){B.call(this,a);this.id="sound";this.description="Allows an Entity to play sounds";this.ComponentType=
yd;this.DataType=Cn;this.schema=jm;this.manager=b;B.bind("update",this.onUpdate,this);this.on("beforeremove",this.onBeforeRemove,this)};Tc.prototype=Object.create(B.prototype);Tc.prototype.constructor=Tc;G._buildAccessors(yd.prototype,jm);Object.assign(Tc.prototype,{initializeComponentData:function(a,b,c){c="volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots enabled".split(" ");B.prototype.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){var c;
a=a.sound.data;var d={};for(c in a)a.hasOwnProperty(c)&&(d[c]=a[c]);d.slots={};for(c in a.slots){var e=a.slots[c];d.slots[c]=e instanceof Da?{name:e.name,volume:e.volume,pitch:e.pitch,loop:e.loop,duration:e.duration,startTime:e.startTime,overlap:e.overlap,autoPlay:e.autoPlay,asset:e.asset}:e}d.playingBeforeDisable={};return this.addComponent(b,d)},onUpdate:function(a){a=this.store;for(var b in a)if(a.hasOwnProperty(b)){var c=a[b],d=c.entity;c=c.data;if(c.enabled&&d.enabled&&c.positional){d=d.getPosition();
c=c.slots;for(var e in c)c[e].updatePosition(d)}}},onBeforeRemove:function(a,b){a=b.slots;for(var c in a)a[c].overlap||a[c].stop();b.onRemove()}});Object.defineProperty(Tc.prototype,"volume",{get:function(){return this.manager.volume},set:function(a){this.manager.volume=a}});Object.defineProperty(Tc.prototype,"context",{get:function(){return Kc()?this.manager.context:(console.warn("WARNING: Audio context is not supported on this browser"),null)}});jb.prototype=Object.create(H.prototype);jb.prototype.constructor=
jb;Object.assign(jb.prototype,{_onSpriteAssetAdded:function(a){this._component.system.app.assets.off("add:"+a.id,this._onSpriteAssetAdded,this);this._spriteAsset===a.id&&this._bindSpriteAsset(a)},_bindSpriteAsset:function(a){a.on("load",this._onSpriteAssetLoad,this);a.on("remove",this._onSpriteAssetRemove,this);a.resource?this._onSpriteAssetLoad(a):this._component.system.app.assets.load(a)},_unbindSpriteAsset:function(a){a.off("load",this._onSpriteAssetLoad,this);a.off("remove",this._onSpriteAssetRemove,
this);a.resource&&a.resource.atlas&&this._component.system.app.assets.off("load:"+a.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(a){if(a.resource)if(a.resource.atlas)this.sprite=a.resource;else{a=a.data.textureAtlasAsset;var b=this._component.system.app.assets;b.off("load:"+a,this._onTextureAtlasLoad,this);b.once("load:"+a,this._onTextureAtlasLoad,this)}else this.sprite=null},_onTextureAtlasLoad:function(a){a=this._spriteAsset;a instanceof X?this._onSpriteAssetLoad(a):
this._onSpriteAssetLoad(this._component.system.app.assets.get(a))},_onSpriteAssetRemove:function(a){this.sprite=null},_onSpriteMeshesChange:function(){this._component.currentClip===this&&this._component._showFrame(this.frame)},_onSpritePpuChanged:function(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame)},_update:function(a){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var b=this._time+a*this._component.speed*(0>this.fps?-1:1),
c=this.duration;a=b>c||0>b;this._setTime(b);b=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/c):0;b!==this._frame&&this._setFrame(b);a&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._paused=this._playing=!1,this.fire("end"),this._component.fire("end",this)))}},_setTime:function(a){this._time=a;a=this.duration;0>this._time?this._time=this.loop?this._time%a+a:0:this._time>a&&(this._time=this.loop?this._time%a:a)},_setFrame:function(a){this._frame=this._sprite?
O.clamp(a,0,this._sprite.frameKeys.length-1):a;this._component.currentClip===this&&this._component._showFrame(this._frame)},_destroy:function(){this._sprite&&(this.sprite=null);this._spriteAsset&&(this.spriteAsset=null)},play:function(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))},pause:function(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))},resume:function(){this._paused&&
(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))},stop:function(){this._playing&&(this._paused=this._playing=!1,this.frame=this._time=0,this.fire("stop"),this._component.fire("stop",this))}});Object.defineProperty(jb.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(a){var b=this._component.system.app.assets,c=a;a instanceof X&&(c=a.id);this._spriteAsset!==c&&(this._spriteAsset&&(a=b.get(this._spriteAsset))&&this._unbindSpriteAsset(a),(this._spriteAsset=
c)?(c=b.get(this._spriteAsset))?this._bindSpriteAsset(c):(this.sprite=null,b.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null)}});Object.defineProperty(jb.prototype,"sprite",{get:function(){return this._sprite},set:function(a){this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",
this._onSpriteMeshesChange,this));if(this._sprite=a)if(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas)this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this);if(this._component.currentClip===this){var b;if(a&&a.atlas){if(a.atlas.texture){if(b=this._component._meshInstance)b.setParameter("texture_emissiveMap",a.atlas.texture),
b.setParameter("texture_opacityMap",a.atlas.texture);this._component.enabled&&this._component.entity.enabled&&this._component._showModel()}this.time&&this.fps?this.time=this.time:this.frame=this.frame}else{if(b=this._component._meshInstance)b.deleteParameter("texture_emissiveMap"),b.deleteParameter("texture_opacityMap");this._component._hideModel()}}}});Object.defineProperty(jb.prototype,"frame",{get:function(){return this._frame},set:function(a){this._setFrame(a);this._setTime(this._frame/(this.fps||
Number.MIN_VALUE))}});Object.defineProperty(jb.prototype,"isPlaying",{get:function(){return this._playing}});Object.defineProperty(jb.prototype,"isPaused",{get:function(){return this._paused}});Object.defineProperty(jb.prototype,"duration",{get:function(){return this._sprite?this._sprite.frameKeys.length/Math.abs(this.fps||Number.MIN_VALUE):0}});Object.defineProperty(jb.prototype,"time",{get:function(){return this._time},set:function(a){this._setTime(a);this.frame=this._sprite?Math.min(this._sprite.frameKeys.length-
1,Math.floor(this._time*Math.abs(this.fps))):0}});var ua=function(a,b){G.call(this,a,b);this._type="simple";this._material=a.defaultMaterial;this._color=new J(1,1,1,1);this._colorUniform=new Float32Array(3);this._speed=1;this._flipY=this._flipX=!1;this._height=this._width=1;this._drawOrder=0;this._layers=[0];this._outerScale=new M(1,1);this._outerScaleUniform=new Float32Array(2);this._innerOffset=new U;this._innerOffsetUniform=new Float32Array(4);this._atlasRect=new U;this._atlasRectUniform=new Float32Array(4);
this._batchGroupId=-1;this._batchGroup=null;this._node=new Z;this._model=new gb;this._model.graph=this._node;this._meshInstance=null;b.addChild(this._model.graph);this._model._entity=b;this._updateAabbFunc=this._updateAabb.bind(this);this._addedModel=!1;this._autoPlayClip=null;this._clips={};this._currentClip=this._defaultClip=new jb(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null})};ua.prototype=Object.create(G.prototype);ua.prototype.constructor=ua;Object.assign(ua.prototype,{onEnable:function(){var a=
this.system.app,b=a.scene;b.on("set:layers",this._onLayersChanged,this);b.layers&&(b.layers.on("add",this._onLayerAdded,this),b.layers.on("remove",this._onLayerRemoved,this));this._showModel();this._autoPlayClip&&this._tryAutoPlay();0<=this._batchGroupId&&a.batcher.insert(Ta.SPRITE,this._batchGroupId,this.entity)},onDisable:function(){var a=this.system.app,b=a.scene;b.off("set:layers",this._onLayersChanged,this);b.layers&&(b.layers.off("add",this._onLayerAdded,this),b.layers.off("remove",this._onLayerRemoved,
this));this.stop();this._hideModel();0<=this._batchGroupId&&a.batcher.remove(Ta.SPRITE,this._batchGroupId,this.entity)},onDestroy:function(){this._currentClip=null;this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(var a in this._clips)this._clips[a]._destroy();this._clips=null;this._hideModel();this._model=null;this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null);this._meshInstance&&(this._meshInstance.material=null,this._meshInstance=
this._meshInstance.mesh=null)},_showModel:function(){if(!this._addedModel&&this._meshInstance){var a,b=[this._meshInstance];var c=0;for(a=this._layers.length;c<a;c++){var d=this.system.app.scene.layers.getLayerById(this._layers[c]);d&&d.addMeshInstances(b)}this._addedModel=!0}},_hideModel:function(){if(this._addedModel&&this._meshInstance){var a,b=[this._meshInstance];var c=0;for(a=this._layers.length;c<a;c++){var d=this.system.app.scene.layers.getLayerById(this._layers[c]);d&&d.removeMeshInstances(b)}this._addedModel=
!1}},_showFrame:function(a){if(this.sprite){var b=this.sprite.meshes[a];if(b){var c=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial;this._meshInstance||(this._meshInstance=new ma(this._node,b,this._material),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=
this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform),this._meshInstance.setParameter("material_opacity",this._color.a),this.enabled&&this.entity.enabled&&this._showModel());this._meshInstance.material!==c&&(this._meshInstance.material=c);this._meshInstance.mesh!==b&&(this._meshInstance.mesh=b,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1);this.sprite.atlas&&this.sprite.atlas.texture?
(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap"));!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode?this._meshInstance._updateAabbFunc=null:(this._meshInstance._updateAabbFunc=this._updateAabbFunc,(a=this.sprite.atlas.frames[this.sprite.frameKeys[a]])?
(b=2/a.rect.z,c=2/a.rect.w,this._innerOffset.set(a.border.x*b,a.border.y*c,a.border.z*b,a.border.w*c),b=this.sprite.atlas.texture,this._atlasRect.set(a.rect.x/b.width,a.rect.y/b.height,a.rect.z/b.width,a.rect.w/b.height)):this._innerOffset.set(0,0,0,0),this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),
this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform));this._updateTransform()}else this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1)}},_updateTransform:function(){var a=this.flipX?-1:1,b=this.flipY?-1:1,c=0,d=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){var e=
1,g=1;if(this.sprite.atlas){var f=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];f&&(e=f.rect.z,g=f.rect.w,c=(.5-f.pivot.x)*this._width,d=(.5-f.pivot.y)*this._height)}e/=this.sprite.pixelsPerUnit;g/=this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*e),Math.max(this._height,this._innerOffset.y*g));b*=g;this._outerScale.x/=e;this._outerScale.y/=g;a=a*e*O.clamp(this._width/(this._innerOffset.x*e),1E-4,1);b*=O.clamp(this._height/(this._innerOffset.y*
g),1E-4,1);this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform,4294967295))}this._node.setLocalScale(a,b,1);this._node.setLocalPosition(c,d,0)},_updateAabb:function(a){a.center.set(0,0,0);a.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001);a.setFromTransformedAabb(a,this._node.getWorldTransform());return a},_tryAutoPlay:function(){if(this._autoPlayClip&&
"animated"===this.type){var a=this._clips[this._autoPlayClip];!a||a.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(a.name)}},_onLayersChanged:function(a,b){a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this);this.enabled&&this.entity.enabled&&this._showModel()},_onLayerAdded:function(a){0>this.layers.indexOf(a.id)||this._addedModel&&this.enabled&&
this.entity.enabled&&this._meshInstance&&a.addMeshInstances([this._meshInstance])},_onLayerRemoved:function(a){this._meshInstance&&(0>this.layers.indexOf(a.id)||a.removeMeshInstances([this._meshInstance]))},removeModelFromLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.removeMeshInstances([this._meshInstance])},addClip:function(a){var b=new jb(this,{name:a.name,fps:a.fps,loop:a.loop,spriteAsset:a.spriteAsset});this._clips[a.name]=
b;b.name&&b.name===this._autoPlayClip&&this._tryAutoPlay();return b},removeClip:function(a){delete this._clips[a]},clip:function(a){return this._clips[a]},play:function(a){a=this._clips[a];var b=this._currentClip;b&&b!==a&&(b._playing=!1);if(this._currentClip=a)this._currentClip=a,this._currentClip.play();return a},pause:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()},resume:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&
this._currentClip.resume()},stop:function(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}});Object.defineProperty(ua.prototype,"type",{get:function(){return this._type},set:function(a){this._type!==a&&(this._type=a,"simple"===this._type?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):"animated"===this._type&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),
this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}});Object.defineProperty(ua.prototype,"frame",{get:function(){return this._currentClip.frame},set:function(a){this._currentClip.frame=a}});Object.defineProperty(ua.prototype,"spriteAsset",{get:function(){return this._defaultClip._spriteAsset},set:function(a){this._defaultClip.spriteAsset=a}});Object.defineProperty(ua.prototype,"sprite",{get:function(){return this._currentClip.sprite},
set:function(a){this._currentClip.sprite=a}});Object.defineProperty(ua.prototype,"material",{get:function(){return this._material},set:function(a){this._material=a;this._meshInstance&&(this._meshInstance.material=a)}});Object.defineProperty(ua.prototype,"color",{get:function(){return this._color},set:function(a){this._color.r=a.r;this._color.g=a.g;this._color.b=a.b;this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",
this._colorUniform))}});Object.defineProperty(ua.prototype,"opacity",{get:function(){return this._color.a},set:function(a){this._color.a=a;this._meshInstance&&this._meshInstance.setParameter("material_opacity",a)}});Object.defineProperty(ua.prototype,"clips",{get:function(){return this._clips},set:function(a){var b,c;if(a){for(b in this._clips){var d=!1;for(c in a)if(a[c].name===b){d=!0;this._clips[b].fps=a[c].fps;this._clips[b].loop=a[c].loop;a[c].hasOwnProperty("sprite")?this._clips[b].sprite=a[c].sprite:
a[c].hasOwnProperty("spriteAsset")&&(this._clips[b].spriteAsset=a[c].spriteAsset);break}d||this.removeClip(b)}for(c in a)this._clips[a[c].name]||this.addClip(a[c]);this._autoPlayClip&&this._tryAutoPlay();this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(b in this._clips)this.removeClip(b)}});Object.defineProperty(ua.prototype,"currentClip",{get:function(){return this._currentClip}});Object.defineProperty(ua.prototype,"speed",{get:function(){return this._speed},set:function(a){this._speed=
a}});Object.defineProperty(ua.prototype,"flipX",{get:function(){return this._flipX},set:function(a){this._flipX!==a&&(this._flipX=a,this._updateTransform())}});Object.defineProperty(ua.prototype,"flipY",{get:function(){return this._flipY},set:function(a){this._flipY!==a&&(this._flipY=a,this._updateTransform())}});Object.defineProperty(ua.prototype,"width",{get:function(){return this._width},set:function(a){a!==this._width&&(this._width=a,this._outerScale.x=this._width,!this.sprite||2!==this.sprite.renderMode&&
1!==this.sprite.renderMode||this._updateTransform())}});Object.defineProperty(ua.prototype,"height",{get:function(){return this._height},set:function(a){a!==this._height&&(this._height=a,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}});Object.defineProperty(ua.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(a){if(this._batchGroupId!==a){var b=this._batchGroupId;this._batchGroupId=a;this.entity.enabled&&
0<=b&&this.system.app.batcher.remove(Ta.SPRITE,b,this.entity);this.entity.enabled&&0<=a?this.system.app.batcher.insert(Ta.SPRITE,a,this.entity):0<=b&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}});Object.defineProperty(ua.prototype,"autoPlayClip",{get:function(){return this._autoPlayClip},set:function(a){this._autoPlayClip=a instanceof jb?a.name:a;this._tryAutoPlay()}});Object.defineProperty(ua.prototype,"drawOrder",{get:function(){return this._drawOrder},
set:function(a){this._drawOrder=a;this._meshInstance&&(this._meshInstance.drawOrder=a)}});Object.defineProperty(ua.prototype,"layers",{get:function(){return this._layers},set:function(a){this._addedModel&&this._hideModel();this._layers=a;this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}});Object.defineProperty(ua.prototype,"aabb",{get:function(){return this._meshInstance?this._meshInstance.aabb:null}});var Fk=["enabled"];zd.prototype=Object.create(B.prototype);zd.prototype.constructor=
zd;G._buildAccessors(ua.prototype,Fk);Object.defineProperties(zd.prototype,{defaultMaterial:{get:function(){if(!this._defaultMaterial){var a=new L(this.app.graphicsDevice,{width:1,height:1,format:7}),b=new Uint8Array(a.lock());b[0]=b[1]=b[2]=b[3]=255;a.name="sprite";a.unlock();b=new ea;b.diffuse.set(0,0,0);b.emissive.set(.5,.5,.5);b.emissiveMap=a;b.emissiveMapTint=!0;b.opacityMap=a;b.opacityMapChannel="a";b.opacityTint=!0;b.opacity=0;b.useLighting=!1;b.useGammaTonemap=!1;b.useFog=!1;b.useSkybox=!1;
b.blendType=4;b.depthWrite=!1;b.pixelSnap=!1;b.cull=0;b.update();this._defaultTexture=a;this._defaultMaterial=b}return this._defaultMaterial},set:function(a){this._defaultMaterial=a}},default9SlicedMaterialSlicedMode:{get:function(){if(!this._default9SlicedMaterialSlicedMode){var a=this.defaultMaterial.clone();a.nineSlicedMode=1;a.update();this._default9SlicedMaterialSlicedMode=a}return this._default9SlicedMaterialSlicedMode},set:function(a){this._default9SlicedMaterialSlicedMode=a}},default9SlicedMaterialTiledMode:{get:function(){if(!this._default9SlicedMaterialTiledMode){var a=
this.defaultMaterial.clone();a.nineSlicedMode=2;a.update();this._default9SlicedMaterialTiledMode=a}return this._default9SlicedMaterialTiledMode},set:function(a){this._default9SlicedMaterialTiledMode=a}}});Object.assign(zd.prototype,{destroy:function(){this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)},initializeComponentData:function(a,b,c){void 0!==b.enabled&&(a.enabled=b.enabled);a.type=b.type;b.layers&&"array"===za(b.layers)&&(a.layers=b.layers.slice(0));void 0!==
b.drawOrder&&(a.drawOrder=b.drawOrder);void 0!==b.color&&(b.color instanceof J?a.color.set(b.color.r,b.color.g,b.color.b,void 0!==b.opacity?b.opacity:1):a.color.set(b.color[0],b.color[1],b.color[2],void 0!==b.opacity?b.opacity:1),a.color=a.color);void 0!==b.opacity&&(a.opacity=b.opacity);void 0!==b.flipX&&(a.flipX=b.flipX);void 0!==b.flipY&&(a.flipY=b.flipY);void 0!==b.width&&(a.width=b.width);void 0!==b.height&&(a.height=b.height);void 0!==b.spriteAsset&&(a.spriteAsset=b.spriteAsset);b.sprite&&(a.sprite=
b.sprite);void 0!==b.frame&&(a.frame=b.frame);if(b.clips)for(var d in b.clips)a.addClip(b.clips[d]);void 0!==b.speed&&(a.speed=b.speed);b.autoPlayClip&&(a.autoPlayClip=b.autoPlayClip);a.batchGroupId=void 0===b.batchGroupId||null===b.batchGroupId?-1:b.batchGroupId;B.prototype.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){a=a.sprite;return this.addComponent(b,{enabled:a.enabled,type:a.type,spriteAsset:a.spriteAsset,sprite:a.sprite,frame:a.frame,color:a.color.clone(),opacity:a.opacity,
flipX:a.flipX,flipY:a.flipY,speed:a.speed,clips:a.clips,autoPlayClip:a.autoPlayClip,batchGroupId:a.batchGroupId,drawOrder:a.drawOrder,layers:a.layers.slice(0)})},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c];d.data.enabled&&d.entity.enabled&&(d=d.entity.sprite,d._currentClip&&d._currentClip._update(a))}},onBeforeRemove:function(a,b){b.onDestroy()}});Sc.prototype=Object.create(G.prototype);Sc.prototype.constructor=Sc;Object.assign(Sc.prototype,{onEnable:function(){this._checkState()},
onDisable:function(){this._checkState()},_onSetEnabled:function(a,b,c){this._checkState()},_checkState:function(){var a=this.enabled&&this.entity.enabled;a!==this._oldState&&(this._oldState=a,this.fire("enable"),this.fire("state",this.enabled))},_onBeforeRemove:function(){this.fire("remove")}});Object.defineProperty(Sc.prototype,"size",{set:function(a){a instanceof r?this._size.copy(a):a instanceof Array&&3<=a.length&&this.size.set(a[0],a[1],a[2])},get:function(){return this._size}});var km=["enabled"],
pe=function(a){B.call(this,a);this.id="zone";this.ComponentType=Sc;this.DataType=En;this.schema=km;this.on("beforeremove",this._onBeforeRemove,this)};pe.prototype=Object.create(B.prototype);pe.prototype.constructor=pe;G._buildAccessors(Sc.prototype,km);Object.assign(pe.prototype,{initializeComponentData:function(a,b,c){a.enabled=b.hasOwnProperty("enabled")?!!b.enabled:!0;b.size&&(b.size instanceof r?a.size.copy(b.size):b.size instanceof Array&&3<=b.size.length&&a.size.set(b.size[0],b.size[1],b.size[2]))},
cloneComponent:function(a,b){return this.addComponent(b,{size:a.zone.size})},_onBeforeRemove:function(a,b){b._onBeforeRemove()}});Xb.prototype.destroy=function(){this._app=null};Xb.prototype.list=function(){return this._list};Xb.prototype.add=function(a,b){if(this._index.hasOwnProperty(a))return!1;a=new Gk(a,b);b=this._list.push(a);this._index[a.name]=b-1;this._urlIndex[a.url]=b-1;return!0};Xb.prototype.find=function(a){return this._index.hasOwnProperty(a)?this._list[this._index[a]]:null};Xb.prototype.findByUrl=
function(a){return this._urlIndex.hasOwnProperty(a)?this._list[this._urlIndex[a]]:null};Xb.prototype.remove=function(a){if(this._index.hasOwnProperty(a)){var b=this._index[a],c=this._list[b];delete this._urlIndex[c.url];delete this._index[a];this._list.splice(b,1);for(b=0;b<this._list.length;b++)c=this._list[b],this._index[c.name]=b,this._urlIndex[c.url]=b}};Xb.prototype.loadSceneHierarchy=function(a,b){var c=this,d=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&
!Ce.test(a)&&(a=V.join(this._app.assets.prefix,a));d.load(a,function(e,g){e?b&&b(e):c._app._preloadScripts(g,function(){c._app.systems.script.preloading=!0;var f=d.open(a,g);c._app.systems.script.preloading=!1;c._app.loader.clearCache(a,"hierarchy");c._app.root.addChild(f);B.initialize(f);B.postInitialize(f);b&&b(e,f)})})};Xb.prototype.loadSceneSettings=function(a,b){var c=this;this._app.assets&&this._app.assets.prefix&&!Ce.test(a)&&(a=V.join(this._app.assets.prefix,a));this._app.loader.load(a,"scenesettings",
function(a,e){a?b&&b(a):(c._app.applySceneSettings(e),b&&b(null))})};Xb.prototype.loadScene=function(a,b){var c=this,d=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!Ce.test(a)&&(a=V.join(this._app.assets.prefix,a));d.load(a,function(e,g){e?b&&b(e):c._app._preloadScripts(g,function(){c._app.systems.script.preloading=!0;var e=d.open(a,g);c._app.systems.script.preloading=!1;c._app.loader.clearCache(a,"scene");c._app.loader.patch({resource:e,type:"scene"},c._app.assets);
c._app.root.addChild(e.root);c._app.systems.rigidbody&&"undefined"!==typeof Ammo&&c._app.systems.rigidbody.gravity.set(e._gravity.x,e._gravity.y,e._gravity.z);b&&b(null,e)})})};var Me=!1,dd=new Z;f.app=null;Y.prototype=Object.create(H.prototype);Y.prototype.constructor=Y;Y._currentApplication=null;Y._applications={};Y.getApplication=function(a){return a?Y._applications[a]:Y._currentApplication};var lm=function(a){this.length=a;this.count=0;this.inc=function(){this.count++};this.done=function(){return this.count===
this.length}};Object.defineProperty(Y.prototype,"fillMode",{get:function(){return this._fillMode}});Object.defineProperty(Y.prototype,"resolutionMode",{get:function(){return this._resolutionMode}});Object.assign(Y.prototype,{configure:function(a,b){var c=this;qa.get(a,function(a,e){if(a)b(a);else{var d=e.scenes,f=e.assets;c._parseApplicationProperties(e.application_properties,function(a){c._parseScenes(d);c._parseAssets(f);a?b(a):b(null)})}})},preload:function(a){var b=this,c;b.fire("preload:start");
var d=this.assets.list({preload:!0}),e=new lm(d.length),g=!1,f=function(){b.graphicsDevice&&!g&&e.done()&&(g=!0,b.fire("preload:end"),a())};var l=d.length;if(e.length){var h=function(a){e.inc();b.fire("preload:progress",e.count/l);e.done()&&f()},p=function(a,c){e.inc();b.fire("preload:progress",e.count/l);e.done()&&f()};for(c=0;c<d.length;c++)d[c].loaded?(e.inc(),b.fire("preload:progress",e.count/l),e.done()&&f()):(d[c].once("load",h),d[c].once("error",p),this.assets.load(d[c]))}else f()},getSceneUrl:function(a){return(a=
this.scenes.find(a))?a.url:null},loadSceneHierarchy:function(a,b){this.scenes.loadSceneHierarchy(a,b)},loadSceneSettings:function(a,b){this.scenes.loadSceneSettings(a,b)},loadScene:function(a,b){this.scenes.loadScene(a,b)},_preloadScripts:function(a,b){if(ib.legacy){var c=this;c.systems.script.preloading=!0;a=this._getScriptReferences(a);var d=0,e=a.length,g=new lm(e),f=/^http(s)?:\/\//;if(e){var l=function(a,d){a&&console.error(a);g.inc();g.done()&&(c.systems.script.preloading=!1,b())};for(d=0;d<
e;d++){var h=a[d];!f.test(h.toLowerCase())&&c._scriptPrefix&&(h=V.join(c._scriptPrefix,a[d]));this.loader.load(h,"script",l)}}else c.systems.script.preloading=!1,b()}else b()},_parseApplicationProperties:function(a,b){a.useDevicePixelRatio||(a.useDevicePixelRatio=a.use_device_pixel_ratio);a.resolutionMode||(a.resolutionMode=a.resolution_mode);a.fillMode||(a.fillMode=a.fill_mode);this._width=a.width;this._height=a.height;a.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio);
this.setCanvasResolution(a.resolutionMode,this._width,this._height);this.setCanvasFillMode(a.fillMode,this._width,this._height);if(a.layers&&a.layerOrder){var c=new pa,d={};for(g in a.layers){var e=a.layers[g];e.id=parseInt(g,10);e.enabled=1!==e.id;d[g]=new fa(e)}var g=0;for(e=a.layerOrder.length;g<e;g++){var f=a.layerOrder[g],l=d[f.layer];l&&(f.transparent?c.pushTransparent(l):c.pushOpaque(l),c.subLayerEnabled[g]=f.enabled)}this.scene.layers=c}if(a.batchGroups)for(g=0,e=a.batchGroups.length;g<e;g++)c=
a.batchGroups[g],this.batcher.addGroup(c.name,c.dynamic,c.maxAabbSize,c.id,c.layers);a.i18nAssets&&(this.i18n.assets=a.i18nAssets);this._loadLibraries(a.libraries,b)},_loadLibraries:function(a,b){var c=a.length,d=c,e=this,g=/^http(s)?:\/\//;if(c)for(var f=function(a,c){d--;a?b(a):0===d&&(e.onLibrariesLoaded(),b(null))},l=0;l<c;++l){var h=a[l];!g.test(h.toLowerCase())&&e._scriptPrefix&&(h=V.join(e._scriptPrefix,h));this.loader.load(h,"script",f)}else e.onLibrariesLoaded(),b(null)},_parseScenes:function(a){if(a)for(var b=
0;b<a.length;b++)this.scenes.add(a[b].name,a[b].url)},_parseAssets:function(a){var b,c=[],d={},e={};if(ib.legacy){if(this.enableBundles)for(g in a)"bundle"===a[g].type&&(e[g]=!0,c.push(a[g]));for(g in a)e[g]||c.push(a[g])}else{for(b=0;b<this.scriptsOrder.length;b++){var g=this.scriptsOrder[b];a[g]&&(d[g]=!0,c.push(a[g]))}if(this.enableBundles)for(g in a)"bundle"===a[g].type&&(e[g]=!0,c.push(a[g]));for(g in a)d[g]||e[g]||c.push(a[g])}for(b=0;b<c.length;b++){a=c[b];g=new X(a.name,a.type,a.file,a.data);
g.id=parseInt(a.id,10);g.preload=a.preload?a.preload:!1;g.loaded="script"===a.type&&a.data&&0<a.data.loadingType;g.tags.add(a.tags);if(a.i18n)for(var f in a.i18n)g.addLocalizedAssetId(f,a.i18n[f]);this.assets.add(g)}},_getScriptReferences:function(a){var b,c,d=[];a.settings.priority_scripts&&(d=a.settings.priority_scripts);var e=[],g={};for(b=0;b<d.length;b++)e.push(d[b]),g[d[b]]=!0;a=a.entities;for(c in a)if(a[c].components.script)for(d=a[c].components.script.scripts,b=0;b<d.length;b++)g[d[b].url]||
(e.push(d[b].url),g[d[b].url]=!0);return e},start:function(){this.frame=0;this.fire("start",{timestamp:zb(),target:this});if(!this._librariesLoaded)this.onLibrariesLoaded();B.initialize(this.root);this.fire("initialize");B.postInitialize(this.root);this.fire("postinitialize");this.tick()},update:function(a){this.frame++;this.graphicsDevice.updateClientRect();this.vr&&this.vr.poll();ib.legacy&&B.fixedUpdate(1/60,this._inTools);B.update(a,this._inTools);B.animationUpdate(a,this._inTools);B.postUpdate(a,
this._inTools);this.fire("update",a);this.controller&&this.controller.update(a);this.mouse&&this.mouse.update(a);this.keyboard&&this.keyboard.update(a);this.gamepads&&this.gamepads.update(a)},render:function(){this.fire("prerender");this.root.syncHierarchy();this.batcher.updateAll();this.renderer.renderComposition(this.scene.layers);this.fire("postrender")},_fillFrameStats:function(a,b,c){var d=this.stats.frame;d.dt=b;d.ms=c;a>d._timeToCountFrames?(d.fps=d._fpsAccum,d._fpsAccum=0,d._timeToCountFrames=
a+1E3):d._fpsAccum++;d.cameras=this.renderer._camerasRendered;d.materials=this.renderer._materialSwitches;d.shaders=this.graphicsDevice._shaderSwitchesPerFrame;d.shadowMapUpdates=this.renderer._shadowMapUpdates;d.shadowMapTime=this.renderer._shadowMapTime;d.depthMapTime=this.renderer._depthMapTime;d.forwardTime=this.renderer._forwardTime;a=this.graphicsDevice._primsPerFrame;d.triangles=a[4]/3+Math.max(a[5]-2,0)+Math.max(a[6]-2,0);d.cullTime=this.renderer._cullTime;d.sortTime=this.renderer._sortTime;
d.skinTime=this.renderer._skinTime;d.morphTime=this.renderer._morphTime;d.instancingTime=this.renderer._instancingTime;for(b=d.otherPrimitives=0;b<a.length;b++)4>b&&(d.otherPrimitives+=a[b]),a[b]=0;this.renderer._camerasRendered=0;this.renderer._materialSwitches=0;this.renderer._shadowMapUpdates=0;this.graphicsDevice._shaderSwitchesPerFrame=0;this.renderer._cullTime=0;this.renderer._sortTime=0;this.renderer._skinTime=0;this.renderer._morphTime=0;this.renderer._instancingTime=0;this.renderer._shadowMapTime=
0;this.renderer._depthMapTime=0;this.renderer._forwardTime=0;d=this.stats.drawCalls;d.forward=this.renderer._forwardDrawCalls;d.culled=this.renderer._numDrawCallsCulled;d.depth=0;d.shadow=this.renderer._shadowDrawCalls;d.skinned=this.renderer._skinDrawCalls;d.immediate=0;d.instanced=0;d.removedByInstancing=0;d.total=this.graphicsDevice._drawCallsPerFrame;d.misc=d.total-(d.forward+d.shadow);this.renderer._depthDrawCalls=0;this.renderer._shadowDrawCalls=0;this.renderer._forwardDrawCalls=0;this.renderer._numDrawCallsCulled=
0;this.renderer._skinDrawCalls=0;this.renderer._immediateRendered=0;this.renderer._instancedDrawCalls=0;this.renderer._removedByInstancing=0;this.graphicsDevice._drawCallsPerFrame=0;this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime;d=this.stats.particles;d.updatesPerFrame=d._updatesPerFrame;d.frameTime=d._frameTime;d._updatesPerFrame=0;d._frameTime=0},setCanvasFillMode:function(a,b,c){this._fillMode=a;this.resizeCanvas(b,c)},setCanvasResolution:function(a,b,c){this._resolutionMode=
a;"AUTO"===a&&void 0===b&&(b=this.graphicsDevice.canvas.clientWidth,c=this.graphicsDevice.canvas.clientHeight);this.graphicsDevice.resizeCanvas(b,c)},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()},resizeCanvas:function(a,b){if(this._allowResize&&(!this.xr||!this.xr.session)){var c=window.innerWidth,d=window.innerHeight;if(this._fillMode===mg){var e=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;
e>c/d?(a=c,b=a/e):(b=d,a=b*e)}else"FILL_WINDOW"===this._fillMode&&(a=c,b=d);this.graphicsDevice.canvas.style.width=a+"px";this.graphicsDevice.canvas.style.height=b+"px";"AUTO"===this._resolutionMode&&this.setCanvasResolution("AUTO");return{width:a,height:b}}},onLibrariesLoaded:function(){this._librariesLoaded=!0;this.systems.rigidbody.onLibraryLoaded()},applySceneSettings:function(a){if(this.systems.rigidbody&&"undefined"!==typeof Ammo){var b=a.physics.gravity;this.systems.rigidbody.gravity.set(b[0],
b[1],b[2])}this.scene.applySettings(a);if(a.render.hasOwnProperty("skybox"))if(a.render.skybox)if(b=this.assets.get(a.render.skybox))this.setSkybox(b);else this.assets.once("add:"+a.render.skybox,this.setSkybox,this);else this.setSkybox(null)},setSkybox:function(a){a?this._skyboxLast===a.id?0!==this.scene.skyboxMip||a.loadFaces?this._onSkyboxChange(a):this._skyboxLoad(a):(this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,
this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=a.id,this.assets.on("load:"+a.id,this._onSkyboxChange,this),this.assets.once("remove:"+a.id,this._skyboxRemove,this),a.resource&&this.scene.setSkybox(a.resources),this._skyboxLoad(a)):this._skyboxLast&&this._skyboxRemove({id:this._skyboxLast})},enableVr:function(){this.vr||(this.vr=new Mc(this))},disableVr:function(){this.vr&&(this.vr.destroy(),this.vr=null)},_onSkyboxChange:function(a){this.scene.setSkybox(a.resources)},
_skyboxLoad:function(a){0===this.scene.skyboxMip&&(a.loadFaces=!0);this.assets.load(a);this._onSkyboxChange(a)},_skyboxRemove:function(a){this._skyboxLast&&(this.assets.off("add:"+a.id,this.setSkybox,this),this.assets.off("load:"+a.id,this._onSkyboxChange,this),this.assets.off("remove:"+a.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},_firstBake:function(){this.lightmapper.bake(null,this.scene.lightmapMode)},_firstBatch:function(){this.scene._needsStaticPrepare&&(this.renderer.prepareStaticMeshes(this.graphicsDevice,
this.scene),this.scene._needsStaticPrepare=!1);this.batcher.generate()},_processTimestamp:function(a){return a},_preRenderImmediate:function(){for(var a=0;a<this._immediateData.lineBatches.length;a++)this._immediateData.lineBatches[a]&&this._immediateData.lineBatches[a].finalize(this.meshInstanceArray)},_postRenderImmediate:function(){for(var a=0;a<this._immediateData.layers.length;a++)this._immediateData.layers[a].clearMeshInstances(!0);this._immediateData.layers.length=0},_initImmediate:function(){this._immediateData||
(this._immediateData=new Sf(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},_addLines:function(a,b,c){var d=c&&c.layer?c.layer:this.scene.layers.getLayerById(3),e=c&&void 0!==c.depthTest?c.depthTest:!0;c=c&&c.mask?c.mask:void 0;this._initImmediate();this._immediateData.addLayer(d);var g=this._immediateData.getLayerIdx(d);void 0===g?(g=new Qj,g.init(this.graphicsDevice,this._immediateData.lineVertexFormat,d,a.length/2),
g.material.depthTest=e,c&&(g.meshInstance.mask=c),g=this._immediateData.lineBatches.push(g)-1,this._immediateData.addLayerIdx(g,d)):(this._immediateData.lineBatches[g].init(this.graphicsDevice,this._immediateData.lineVertexFormat,d,a.length/2),this._immediateData.lineBatches[g].material.depthTest=e,c&&(this._immediateData.lineBatches[g].meshInstance.mask=c));this._immediateData.lineBatches[g].addLines(a,b)},renderLine:function(a,b,c,d,e){var g=c;if(d instanceof J)if(g=d,"number"===typeof e){Me||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),
Me=!0);var f=1===e?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}}else f=e;else"number"===typeof d?(Me||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),Me=!0),g=c,f=1===d?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):d&&(f=d);this._addLines([a,b],[c,g],f)},renderLines:function(a,b,c){c?"number"===typeof c&&(Me||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),
Me=!0),c=1===c?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):c={layer:this.scene.layers.getLayerById(3),depthTest:!0};b.length&&a.length!==b.length?console.error("renderLines: position/color arrays have different lengths"):0!==a.length%2?console.error("renderLines: array length is not divisible by 2"):this._addLines(a,b,c)},renderWireCube:function(a,b,c){var d;this._initImmediate();this._immediateData.cubeLocalPos||(this._immediateData.cubeLocalPos=
[new r(-.5,-.5,-.5),new r(-.5,.5,-.5),new r(.5,.5,-.5),new r(.5,-.5,-.5),new r(-.5,-.5,.5),new r(-.5,.5,.5),new r(.5,.5,.5),new r(.5,-.5,.5)],this._immediateData.cubeWorldPos=[new r,new r,new r,new r,new r,new r,new r,new r]);var e=this._immediateData.cubeLocalPos,g=this._immediateData.cubeWorldPos;for(d=0;8>d;d++)a.transformPoint(e[d],g[d]);this.renderLines([g[0],g[1],g[1],g[2],g[2],g[3],g[3],g[0],g[4],g[5],g[5],g[6],g[6],g[7],g[7],g[4],g[0],g[4],g[1],g[5],g[2],g[6],g[3],g[7]],b,c)},renderMeshInstance:function(a,
b){b||(b={layer:this.scene.layers.getLayerById(3)});this._initImmediate();this._immediateData.addLayer(b.layer);this.meshInstanceArray[0]=a;b.layer.addMeshInstances(this.meshInstanceArray,!0)},renderMesh:function(a,b,c,d){d||(d={layer:this.scene.layers.getLayerById(3)});this._initImmediate();dd.worldTransform=c;dd._dirtyWorld=dd._dirtyNormal=!1;a=new ma(dd,a,b);a.cull=!1;d.mask&&(a.mask=d.mask);this._immediateData.addLayer(d.layer);this.meshInstanceArray[0]=a;d.layer.addMeshInstances(this.meshInstanceArray,
!0)},renderQuad:function(a,b,c){c||(c={layer:this.scene.layers.getLayerById(3)});this._initImmediate();if(!this._immediateData.quadMesh){var d=new Ka(this.graphicsDevice,[{semantic:"POSITION",components:3,type:6}]);d=new Za(this.graphicsDevice,d,4);var e=new Db(d);e.element.POSITION.set(-.5,-.5,0);e.next();e.element.POSITION.set(.5,-.5,0);e.next();e.element.POSITION.set(-.5,.5,0);e.next();e.element.POSITION.set(.5,.5,0);e.end();this._immediateData.quadMesh=new fb(this.graphicsDevice);this._immediateData.quadMesh.vertexBuffer=
d;this._immediateData.quadMesh.primitive[0].type=5;this._immediateData.quadMesh.primitive[0].base=0;this._immediateData.quadMesh.primitive[0].count=4;this._immediateData.quadMesh.primitive[0].indexed=!1}dd.worldTransform=a;dd._dirtyWorld=dd._dirtyNormal=!1;a=new ma(dd,this._immediateData.quadMesh,b);a.cull=!1;this.meshInstanceArray[0]=a;this._immediateData.addLayer(c.layer);c.layer.addMeshInstances(this.meshInstanceArray,!0)},destroy:function(){var a,b=this.graphicsDevice.canvas.id;this.off("librariesloaded");
document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1);this.onVisibilityChange=this._visibilityChangeHandler=null;this.root.destroy();this.root=null;this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null);this.keyboard&&
(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null);this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null);this.elementInput&&(this.elementInput.detach(),this.elementInput=null);this.controller&&(this.controller=null);var c=this.systems.list;var d=0;for(a=c.length;d<a;d++)c[d].destroy();B.destroy();a=this.assets.list();for(d=0;d<a.length;d++)a[d].unload(),a[d].off();this.assets.off();this.bundles.destroy();this.bundles=null;this.i18n.destroy();this.i18n=null;for(var e in this.loader.getHandler("script")._cache)d=
this.loader.getHandler("script")._cache[e],(a=d.parentNode)&&a.removeChild(d);this.loader.getHandler("script")._cache={};this.loader.destroy();this.loader=null;this.scene.destroy();this.scene=null;this.systems=[];this.context=null;this.scripts.destroy();this.scripts=null;this.scenes.destroy();this.scenes=null;this.lightmapper.destroy();this.lightmapper=null;this.batcher.destroyManager();this.batcher=null;this._entityIndex={};this.defaultLayerDepth.onPreRenderOpaque=null;this.defaultLayerDepth.onPostRenderOpaque=
null;this.defaultLayerDepth.onDisable=null;this.defaultLayerWorld=this.defaultLayerDepth=this.defaultLayerDepth.onEnable=null;hd&&(hd.destroy(),hd=null);this.vr&&(this.vr.destroy(),this.vr=null);this.xr.end();this.graphicsDevice.destroy();this.tick=this.renderer=this.graphicsDevice=null;this.off();this._soundManager&&(this._soundManager.destroy(),this._soundManager=null);ib.app=null;Mb.DEFAULT_PARAM_TEXTURE=null;Y._applications[b]=null;Y._currentApplication===this&&(Y._currentApplication=null)},getEntityFromIndex:function(a){return this._entityIndex[a]}});
var eh={},Gn=function(a){var b;return function(c,d){if(a.graphicsDevice){Y._currentApplication=a;b&&(window.cancelAnimationFrame(b),b=null);f.app=a;c=a._processTimestamp(c)||zb();var e=c-(a._time||c);var g=O.clamp(e/1E3,0,a.maxDeltaTime);g*=a.timeScale;a._time=c;b=a.vr&&a.vr.display?a.vr.display.requestAnimationFrame(a.tick):a.xr.session?a.xr.session.requestAnimationFrame(a.tick):window.requestAnimationFrame(a.tick);if(!a.graphicsDevice.contextLost){a.fire("frameupdate",e);d?(a.xr.update(d),a.graphicsDevice.defaultFramebuffer=
d.session.renderState.baseLayer.framebuffer):a.graphicsDevice.defaultFramebuffer=null;a.update(g);a.fire("framerender");if(a.autoRender||a.renderNextFrame)a.render(),a.renderNextFrame=!1;eh.timestamp=zb();eh.target=a;a.fire("frameend",eh);a.fire("frameEnd",eh);a.vr&&a.vr.display&&a.vr.display.presenting&&a.vr.display.submitFrame()}}}},Hn=0;Object.defineProperty(da.prototype,"shader",{get:function(){return this._shader},set:function(a){this._shader=a}});Object.defineProperty(da.prototype,"blendType",
{get:function(){if(!this.blend&&1===this.blendSrc&&0===this.blendDst&&0===this.blendEquation)return 3;if(!this.blend||6!==this.blendSrc||8!==this.blendDst||0!==this.blendEquation){if(this.blend&&1===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 1;if(this.blend&&6===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 6;if(this.blend&&4===this.blendSrc&&2===this.blendDst&&0===this.blendEquation)return 7;if(this.blend&&5===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 8;
if(this.blend&&1===this.blendSrc&&1===this.blendDst&&3===this.blendEquation)return 9;if(this.blend&&1===this.blendSrc&&1===this.blendDst&&4===this.blendEquation)return 10;if(this.blend&&4===this.blendSrc&&0===this.blendDst&&0===this.blendEquation)return 5;if(this.blend&&1===this.blendSrc&&8===this.blendDst&&0===this.blendEquation)return 4}return 2},set:function(a){var b=this.blend;switch(a){case 3:this.blend=!1;this.blendSrc=1;this.blendEquation=this.blendDst=0;break;case 2:this.blend=!0;this.blendSrc=
6;this.blendDst=8;this.blendEquation=0;break;case 4:this.blend=!0;this.blendSrc=1;this.blendDst=8;this.blendEquation=0;break;case 1:this.blend=!0;this.blendDst=this.blendSrc=1;this.blendEquation=0;break;case 6:this.blend=!0;this.blendSrc=6;this.blendDst=1;this.blendEquation=0;break;case 7:this.blend=!0;this.blendSrc=4;this.blendDst=2;this.blendEquation=0;break;case 8:this.blend=!0;this.blendSrc=5;this.blendDst=1;this.blendEquation=0;break;case 5:this.blend=!0;this.blendSrc=4;this.blendEquation=this.blendDst=
0;break;case 9:this.blend=!0;this.blendDst=this.blendSrc=1;this.blendEquation=3;break;case 10:this.blend=!0,this.blendDst=this.blendSrc=1,this.blendEquation=4}b!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0);this._updateMeshInstanceKeys()}});da.prototype._cloneInternal=function(a){a.name=this.name;a.shader=this.shader;a.alphaTest=this.alphaTest;a.alphaToCoverage=this.alphaToCoverage;a.blend=this.blend;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=
this.blendEquation;a.separateAlphaBlend=this.separateAlphaBlend;a.blendSrcAlpha=this.blendSrcAlpha;a.blendDstAlpha=this.blendDstAlpha;a.blendAlphaEquation=this.blendAlphaEquation;a.cull=this.cull;a.depthTest=this.depthTest;a.depthWrite=this.depthWrite;a.depthBias=this.depthBias;a.slopeDepthBias=this.slopeDepthBias;this.stencilFront&&(a.stencilFront=this.stencilFront.clone());this.stencilBack&&(a.stencilBack=this.stencilFront===this.stencilBack?a.stencilFront:this.stencilBack.clone());a.redWrite=this.redWrite;
a.greenWrite=this.greenWrite;a.blueWrite=this.blueWrite;a.alphaWrite=this.alphaWrite};da.prototype.clone=function(){var a=new da;this._cloneInternal(a);return a};da.prototype._updateMeshInstanceKeys=function(){var a,b=this.meshInstances;for(a=0;a<b.length;a++)b[a].updateKey()};da.prototype.updateUniforms=function(){};da.prototype.updateShader=function(a,b,c){};da.prototype.update=function(){this.dirty=!0};da.prototype.clearParameters=function(){this.parameters={}};da.prototype.getParameters=function(){return this.parameters};
da.prototype.clearVariants=function(){this.variants={};for(var a,b=0;b<this.meshInstances.length;b++){var c=this.meshInstances[b];for(a=0;a<c._shader.length;a++)c._shader[a]=null}};da.prototype.getParameter=function(a){return this.parameters[a]};da.prototype.setParameter=function(a,b,c){void 0===c&&(c=-524285);if(void 0===b&&"object"===typeof a){b=a;if(b.length){for(a=0;a<b.length;a++)this.setParameter(b[a]);return}a=b.name;b=b.value}var d=this.parameters[a];d?(d.data=b,d.passFlags=c):this.parameters[a]=
{scopeId:null,data:b,passFlags:c}};da.prototype.deleteParameter=function(a){this.parameters[a]&&delete this.parameters[a]};da.prototype.setParameters=function(){for(var a in this.parameters){var b=this.parameters[a];b.scopeId.setValue(b.data)}};da.prototype.destroy=function(){this.variants={};this.shader=null;for(var a,b,c=0;c<this.meshInstances.length;c++){a=this.meshInstances[c];for(b=0;b<a._shader.length;b++)a._shader[b]=null;a._material=null;b=Y.getApplication().scene.defaultMaterial;this!==b&&
(a.material=b)}};Ib.prototype.updateMinRef=function(a,b,c,d,e,g,f,l,h){this._updateSharedOptions(a,d,e,f);this._updateMinOptions(a,d);this._updateUVOptions(a,d,e,!0)};Ib.prototype.updateRef=function(a,b,c,d,e,g,f,l,h){this._updateSharedOptions(a,d,e,f);a.useTexCubeLod=b.useTexCubeLod;this._updateEnvOptions(a,d,c,h);this._updateMaterialOptions(a,d);1===f&&(a.gamma&&(a.gamma=3),a.toneMap=0);a.hasTangents=e&&d.normalMap&&0!==(e&512);this._updateLightOptions(a,d,e,l,g);this._updateUVOptions(a,d,e,!1);
a.clearCoat=d.clearCoat;a.clearCoatGlossiness=d.clearCoatGlossiness};Ib.prototype._updateSharedOptions=function(a,b,c,d){a.pass=d;a.alphaTest=0<b.alphaTest;a.forceFragmentPrecision=b.forceFragmentPrecision||"";a.chunks=b.chunks||"";a.blendType=b.blendType;a.forceUv1=b.forceUv1;a.screenSpace=c&&0!==(c&256);a.skin=c&&0!==(c&2);a.useInstancing=c&&0!==(c&32);a.useMorphPosition=c&&0!==(c&1024);a.useMorphNormal=c&&0!==(c&2048);a.nineSlicedMode=b.nineSlicedMode||0};Ib.prototype._updateUVOptions=function(a,
b,c,d){var e=!1,g=!1,f=!1;c&&(e=0!==(c&4),g=0!==(c&8),f=0!==(c&16));a.vertexColors=!1;this._mapXForms=[];for(var l in hc)this._updateTexOptions(a,b,l,e,g,f,d);this._mapXForms=null};Ib.prototype._updateMinOptions=function(a,b){a.opacityTint=1!==b.opacity&&3!==b.blendType;a.lights=[]};Ib.prototype._updateMaterialOptions=function(a,b){var c=1===b.diffuse.r&&1===b.diffuse.g&&1===b.diffuse.b||!b.diffuseTint&&(b.diffuseMap||b.diffuseVertexColor)?0:3,d=!1,e=(b.useMetalness?!0:!!b.specularMap)||!!b.sphereMap||
!!b.cubeMap||!!b.dpAtlas;(e=(e=(e=e||(b.useMetalness?!0:!(0===b.specular.r&&0===b.specular.g&&0===b.specular.b)))||b.enableGGXSpecular)||0<b.clearCoat)&&(!b.specularTint&&(b.specularMap||b.specularVertexColor)||b.useMetalness||(d=1!==b.specular.r||1!==b.specular.g||1!==b.specular.b));var g=b.emissiveMap?0:3;g||(g=(g=(1!==b.emissive.r||1!==b.emissive.g||1!==b.emissive.b||1!==b.emissiveIntensity)&&b.emissiveTint)?3:1!==b.emissiveIntensity?1:0);var f=b.normalMap?10===b.normalMap.format||"swizzleGGGR"===
b.normalMap.type:!1;a.opacityTint=1!==b.opacity&&3!==b.blendType?1:0;a.blendMapsWithColors=!0;a.ambientTint=b.ambientTint;a.diffuseTint=c;a.specularTint=d?3:0;a.metalnessTint=b.useMetalness&&1>b.metalness?1:0;a.glossTint=1;a.emissiveTint=g;a.alphaToCoverage=b.alphaToCoverage;a.normalizeNormalMap=b.normalizeNormalMap;a.sphereMap=!!b.sphereMap;a.cubeMap=!!b.cubeMap;a.dpAtlas=!!b.dpAtlas;a.ambientSH=!!b.ambientSH;a.useSpecular=e;a.emissiveFormat=b.emissiveMap?"rgbm"===b.emissiveMap.type?1:14===b.emissiveMap.format?
2:0:null;a.lightMapFormat=b.lightMap?"rgbm"===b.lightMap.type?1:14===b.lightMap.format?2:0:null;a.specularAntialias=b.specularAntialias&&!!b.normalMap&&!!b.normalMap.mipmaps&&!f;a.conserveEnergy=b.conserveEnergy;a.occludeSpecular=b.occludeSpecular;a.occludeSpecularFloat=1!==b.occludeSpecularIntensity;a.occludeDirect=b.occludeDirect;a.shadingModel=b.shadingModel;a.fresnelModel=b.fresnelModel;a.packedNormal=f;a.fastTbn=b.fastTbn;a.cubeMapProjection=b.cubeMapProjection;a.customFragmentShader=b.customFragmentShader;
a.refraction=!!b.refraction;a.useMetalness=b.useMetalness;a.enableGGXSpecular=b.enableGGXSpecular;a.msdf=!!b.msdfMap;a.twoSidedLighting=b.twoSidedLighting;a.pixelSnap=b.pixelSnap;a.aoMapUv=b.aoUvSet;a.diffuseDetail=!!b.diffuseMap;a.normalDetail=!!b.normalMap;a.diffuseDetailMode=b.diffuseDetailMode;a.detailModes=!!a.diffuseDetail};Ib.prototype._updateEnvOptions=function(a,b,c,d){var e=d&&"rgbm"===d.type||b.cubeMap&&"rgbm"===b.cubeMap.type||b.dpAtlas&&"rgbm"===b.dpAtlas.type,g=d&&("rgbm"===d.type||
14===d.format)||b.cubeMap&&("rgbm"===b.cubeMap.type||14===b.cubeMap.format)||b.dpAtlas&&("rgbm"===b.dpAtlas.type||14===b.dpAtlas.format),f=d&&!b.cubeMap&&!b.sphereMap&&!b.dpAtlas&&"rgbm"===d.type||b.cubeMap&&"rgbm"===b.cubeMap.type||b.sphereMap&&"rgbm"===b.sphereMap.type||b.dpAtlas&&"rgbm"===b.dpAtlas.type,l=(!d||b.cubeMap||b.sphereMap||b.dpAtlas?!1:"rgbm"===d.type||14===d.format)||b.cubeMap&&("rgbm"===b.cubeMap.type||14===b.cubeMap.format)||b.sphereMap&&("rgbm"===b.sphereMap.type||14===b.sphereMap.format)||
b.dpAtlas&&("rgbm"===b.dpAtlas.type||14===b.dpAtlas.format),h;b.useSkybox&&c._skyboxPrefiltered&&(h=c._skyboxPrefiltered[0]);a.fog=b.useFog?c.fog:"none";a.gamma=b.useGammaTonemap?c.gammaCorrection:0;a.toneMap=b.useGammaTonemap?c.toneMapping:-1;a.rgbmAmbient=e;a.hdrAmbient=g;a.rgbmReflection=f;a.hdrReflection=l;a.useRgbm=f||e||b.emissiveMap&&"rgbm"===b.emissiveMap.type||b.lightMap&&"rgbm"===b.lightMap.type;a.fixSeams=d?d.fixCubemapSeams:b.cubeMap?b.cubeMap.fixCubemapSeams:!1;a.prefilteredCubemap=!!d;
a.skyboxIntensity=d&&h&&d===h&&1!==c.skyboxIntensity};Ib.prototype._updateLightOptions=function(a,b,c,d,e){a.lightMap=!1;a.lightMapChannel="";a.lightMapUv=0;a.lightMapTransform=0;a.lightMapWithoutAmbient=!1;a.dirLightMap=!1;c&&(a.noShadow=0!==(c&1),0!==(c&64)&&(a.lightMapFormat=1,a.lightMap=!0,a.lightMapChannel="rgb",a.lightMapUv=1,a.lightMapTransform=0,a.lightMapWithoutAmbient=!b.lightMap,a.useRgbm=!0,0!==(c&128)&&(a.dirLightMap=!0)));b.useLighting?(b=[],c=c?c>>16:1,d&&(this._collectLights(0,d[0],
b,c),this._collectLights(1,d[1],b,c,e),this._collectLights(2,d[2],b,c,e)),a.lights=b):a.lights=[];0===a.lights.length&&(a.noShadow=!0)};Ib.prototype._updateTexOptions=function(a,b,c,d,e,g,f){var k=c+"Map",h=c+"VertexColor",p=c+"VertexColorChannel",n=k+"Channel",m=k+"Transform",q=k+"Uv";"light"!==c&&(a[k]=!1,a[n]="",a[m]=0,a[q]=0);a[h]=!1;a[p]="";var u="opacity"===c;if(u&&3===b.blendType&&0===b.alphaTest&&!b.alphaToCoverage)return a;if(!f||u)"height"!==c&&b[h]&&g&&(a[h]=b[h],a[p]=b[p],a.vertexColors=
!0),b[k]&&(c=!0,0!==b[q]||d||(c=!1),1!==b[q]||e||(c=!1),c&&(a[k]=!!b[k],a[m]=this._getMapTransformID(b[m],b[q]),a[n]=b[n],a[q]=b[q]))};Ib.prototype._collectLights=function(a,b,c,d,e){var g;for(g=0;g<b.length;g++){var f=b[g];f.enabled&&f.mask&d&&(0===a||!f.isStatic)&&c.push(f)}if(e)for(g=0;g<e.length;g++)f=e[g],f._type===a&&c.push(f)};Ib.prototype._getMapTransformID=function(a,b){if(!a)return 0;this._mapXForms[b]||(this._mapXForms[b]=[]);var c;for(c=0;c<this._mapXForms[b].length&&this._mapXForms[b][c][0]==
a.x&&this._mapXForms[b][c][1]==a.y&&this._mapXForms[b][c][2]==a.z&&this._mapXForms[b][c][3]==a.w;)return c+1;c=this._mapXForms[b].length;this._mapXForms[b][c]=[];this._mapXForms[b][c][0]=a.x;this._mapXForms[b][c][1]=a.y;this._mapXForms[b][c][2]=a.z;this._mapXForms[b][c][3]=a.w;return c+1};ea.prototype=Object.create(da.prototype);ea.prototype.constructor=ea;ea.TEXTURE_PARAMETERS=He;ea.CUBEMAP_PARAMETERS=Tg;var Ja=[],mm=[],zj=[],Aj=[],Od={},Bb=function(a,b,c,d,e,g,f){var k="_"+b+"Map",h=k+"Tiling",
p=k+"Offset",n=k.substring(1)+"Transform",m=n+"Uniform",q=k+"Uv",u=k+"Channel",r="_"+b+"VertexColor",y="_"+b+"VertexColorChannel",w="_"+b+"Mode";a[k]=null;a[h]=new M(1,1);a[p]=new M(0,0);a[n]=null;a[m]=null;a[q]=c;0<d&&(c=e?e:1<d?"rgb":"g",a[u]=c,g&&(a[y]=c));g&&(a[r]=!1);f&&(a[w]="mul");hc[b]=d;Object.defineProperty(ea.prototype,k.substring(1),{get:function(){return this[k]},set:function(a){var b=this[k];!!b^!!a&&(this.dirtyShader=!0);b&&a&&(b.type!==a.type||b.fixCubemapSeams!==a.fixCubemapSeams||
b.format!==a.format)&&(this.dirtyShader=!0);this[k]=a}});a=h.substring(1);b=p.substring(1);Object.defineProperty(ea.prototype,a,{get:function(){return this[h]},set:function(a){this.dirtyShader=!0;this[h]=a}});Od[a]=function(a,b,c){a=a._updateMapTransform(c?a[n]:null,b,a[p]);return{name:"texture_"+n,value:a.data}};Object.defineProperty(ea.prototype,b,{get:function(){return this[p]},set:function(a){this.dirtyShader=!0;this[p]=a}});Od[b]=function(a,b,c){a=a._updateMapTransform(c?a[n]:null,a[h],b);return{name:"texture_"+
n,value:a.data}};Object.defineProperty(ea.prototype,q.substring(1),{get:function(){return this[q]},set:function(a){this[q]!==a&&(this.dirtyShader=!0);this[q]=a}});Object.defineProperty(ea.prototype,u.substring(1),{get:function(){return this[u]},set:function(a){this[u]!==a&&(this.dirtyShader=!0);this[u]=a}});g&&(Object.defineProperty(ea.prototype,r.substring(1),{get:function(){return this[r]},set:function(a){this.dirtyShader=!0;this[r]=a}}),Object.defineProperty(ea.prototype,y.substring(1),{get:function(){return this[y]},
set:function(a){this[y]!==a&&(this.dirtyShader=!0);this[y]=a}}));f&&Object.defineProperty(ea.prototype,w.substring(1),{get:function(){return this[w]},set:function(a){this.dirtyShader=!0;this[w]=a}});Ja.push(k.substring(1));Ja.push(h.substring(1));Ja.push(p.substring(1));Ja.push(q.substring(1));Ja.push(u.substring(1));g&&(Ja.push(r.substring(1)),Ja.push(y.substring(1)));f&&Ja.push(w.substring(1));zj.push(n)},fh=[],gh=function(a,b,c,d){var e="_"+b,g=b+"Uniform",f=b+"Intensity",l="_"+f;a[e]=c;a[g]=new Float32Array(3);
Object.defineProperty(ea.prototype,b,{get:function(){this.dirtyShader=this.dirtyColor=!0;return this[e]},set:function(a){var b=this[e];(0===b.r&&0===b.g&&0===b.b||1===b.r&&1===b.g&&1===b.b)^(0===a.r&&0===a.g&&0===a.b||1===a.r&&1===a.g&&1===a.b)&&(this.dirtyShader=!0);this.dirtyColor=!0;this[e]=a}});Ja.push(b);Aj.push(g);fh.push(b);Od[b]=function(a,c,e){e=e?a[g]:new Float32Array(3);var f=!1;a.useGammaTonemap&&(f=(a._scene||Y.getApplication().scene).gammaCorrection);for(var h=0;3>h;h++)e[h]=f?Math.pow(c.data[h],
2.2):c.data[h],d&&(e[h]*=a[l]);return{name:"material_"+b,value:e}};d&&(a[l]=1,Object.defineProperty(ea.prototype,f,{get:function(){return this[l]},set:function(a){var b=this[l];(0===b||1===b)^(0===a||1===a)&&(this.dirtyShader=!0);this.dirtyColor=!0;this[l]=a}}),Ja.push(f),Od[f]=function(a,c,d){c=d?a[g]:new Float32Array(3);d=!1;a.useGammaTonemap&&(d=(a._scene||Y.getApplication().scene).gammaCorrection);for(var f=0;3>f;f++)c[f]=d?Math.pow(a[e].data[f],2.2):a[e].data[f],c[f]*=a[l];return{name:"material_"+
b,value:c}})},nb=function(a,b,c,d){var e="_"+b;a[e]=c;Object.defineProperty(ea.prototype,b,{get:function(){return this[e]},set:function(a){var b=this[e];b!==a&&(this[e]=a,0===b||1===b||0===a||1===a)&&(this.dirtyShader=!0)}});Ja.push(b);Od[b]=void 0!==d?d:function(a,c,d){return{name:"material_"+b,value:c}}},bc=function(a,b,c){var d="_"+b;a[d]=null;Object.defineProperty(ea.prototype,b,{get:function(){return this[d]},set:function(a){!!this[d]^!!a&&(this.dirtyShader=!0);this[d]=a}});Ja.push(b);Od[b]=
c},cc=function(a,b,c){Object.defineProperty(ea.prototype,c,{get:function(){return this[b]},set:function(a){this[b]=a}})},Wo=function(a){Object.defineProperty(ea.prototype,"chunks",{get:function(){this.dirtyShader=!0;return this._chunks},set:function(a){this.dirtyShader=!0;this._chunks=a}});Ja.push("chunks")},xa=function(a,b,c){var d="_"+b;a[d]=c;Object.defineProperty(ea.prototype,b,{get:function(){return this[d]},set:function(a){this[d]!==a&&(this.dirtyShader=!0);this[d]=a}});Ja.push(b)},nm=function(){};
nm.prototype.copy=function(a){for(var b in a)a.hasOwnProperty(b)&&"copy"!==b&&(this[b]=a[b])};Object.assign(ea.prototype,{reset:function(){var a;for(a=0;a<Ja.length;a++){var b=mm[a];this[Ja[a]]=b?b.clone?b.clone():b:b}for(a=0;a<zj.length;a++)this[zj[a]]=null;for(a=0;a<Aj.length;a++)this[Aj[a]]=new Float32Array(3);this._chunks=new nm;this.cubeMapMinUniform=new Float32Array(3);this.cubeMapMaxUniform=new Float32Array(3)},clone:function(){var a=new ea;da.prototype._cloneInternal.call(this,a);for(var b,
c=0;c<Ja.length;c++)b=Ja[c],void 0!==this[b]&&(this[b]&&this[b].copy?a[b]?a[b].copy(this[b]):a[b]=this[b].clone():a[b]=this[b]);return a},_updateMapTransform:function(a,b,c){a=a||new U;a.set(b.x,b.y,c.x,c.y);return 1===a.x&&1===a.y&&0===a.z&&0===a.w?null:a},_setParameter:function(a,b){this.parameters[a]||this._propsSet.push(a);this.setParameter(a,b)},_clearParameters:function(){for(var a=this._propsSet,b=0;b<a.length;b++)delete this.parameters[a[b]];this._propsSet=[]},_updateMap:function(a){a+="Map";
if(this[a]){this._setParameter("texture_"+a,this[a]);var b=a+"Transform",c=a+"TransformUniform";this[b]||(this[c]=new Float32Array(4));this[b]=this._updateMapTransform(this[b],this[a+"Tiling"],this[a+"Offset"]);this[b]&&(this[c][0]=this[b].x,this[c][1]=this[b].y,this[c][2]=this[b].z,this[c][3]=this[b].w,this._setParameter("texture_"+b,this[c]))}},getUniform:function(a,b,c){return(a=Od[a])?a(this,b,c):null},updateUniforms:function(){this._clearParameters();this._setParameter("material_ambient",this.ambientUniform);
this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",this.diffuseUniform);this.useMetalness?((!this.metalnessMap||1>this.metalness)&&this._setParameter("material_metalness",this.metalness),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform);0<this.clearCoat&&(this._setParameter("material_clearCoatSpecularity",this.clearCoat),this._setParameter("material_clearCoatGlossiness",
this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat));var a=this.getUniform("shininess",this.shininess,!0);this._setParameter(a.name,a.value);this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",this.emissiveUniform);this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity);0<this.refraction&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex));
this._setParameter("material_opacity",this.opacity);this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity);1===this.cubeMapProjection&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0));for(var b in hc)this._updateMap(b);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH);this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness);this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",
this.normalDetailMapBumpiness);this.heightMap&&(a=this.getUniform("heightMapFactor",this.heightMapFactor,!0),this._setParameter(a.name,a.value));this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap);this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]&&this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]);this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",
this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]);this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]);this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&
this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]);this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]);this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",
this._scene._skyboxPrefiltered[5]);this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap);this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas);this._setParameter("material_reflectivity",this.reflectivity);if(this.dirtyShader||!this._scene)this.shader=null,this.clearVariants();this._processColor()},_processColor:function(){var a;if(this.dirtyColor&&(this._scene||!this.useGammaTonemap)){var b=!1;this.useGammaTonemap&&(b=this._scene.gammaCorrection);for(a=0;a<fh.length;a++){var c=
this["_"+fh[a]],d=this[fh[a]+"Uniform"];b?(d[0]=Math.pow(c.r,2.2),d[1]=Math.pow(c.g,2.2),d[2]=Math.pow(c.b,2.2)):(d[0]=c.r,d[1]=c.g,d[2]=c.b)}for(a=0;3>a;a++)this.emissiveUniform[a]*=this.emissiveIntensity;this.dirtyColor=!1}},updateShader:function(a,b,c,d,e,g){!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());var f=a.useTexCubeLod,l=!a.extTextureLod;if(this.useSkybox){var h=b._skyboxPrefiltered[0];var p=b._skyboxPrefiltered[1];var n=b._skyboxPrefiltered[2];var m=
b._skyboxPrefiltered[3];var q=b._skyboxPrefiltered[4];var r=b._skyboxPrefiltered[5]}h=this.prefilteredCubeMap128||h;p=this.prefilteredCubeMap64||p;n=this.prefilteredCubeMap32||n;m=this.prefilteredCubeMap16||m;q=this.prefilteredCubeMap8||q;r=this.prefilteredCubeMap4||r;if(h){var t=h&&p&&n&&m&&q&&r;if(l&&t){if(!h.dpAtlas){f=[h,p,n,m,q,r];l=new U;r=new U;p=4*f[0].width;q=K;q=q.createShaderFromCode(a,q.fullscreenQuadVS,q.dpAtlasQuadPS,"dpAtlasQuad");n=a.scope.resolve("source");t=a.scope.resolve("params");
var y=new L(a,{type:f[0].type,format:f[0].format,width:p,height:p,mipmaps:!1});y.name="paraboloid";for(var w=new oa(a,y,{depth:!1}),v=(p+2)/p-1,x=0;6>x;x++){var z=a;var A=f[x],B=x,C=K;C=C.createShaderFromCode(z,C.fullscreenQuadVS,(A.fixCubemapSeams?C.fixCubemapSeamsStretchPS:C.fixCubemapSeamsNonePS)+C.genParaboloidPS,"genParaboloid");var D=z.scope.resolve("source"),E=z.scope.resolve("params"),G=new U,H=A.width,J=A.format;H=2*Math.max(H,8);H=new L(z,{type:A.type,format:J,width:2*H,height:H,mipmaps:!1});
H.name="paraboloid";J=new oa(z,H,{depth:!1});G.x=B;G.y=1;D.setValue(A);E.setValue(G.data);La(z,J,C);z=H;n.setValue(z);z=l;A=x;z.x=.5*O.clamp(A-2,0,1);A-=6*z.x;B=1-z.x;z.y=Math.min(.5*A,.75)*B+z.x;z.z=(1-.5*O.clamp(A,0,1))*B;z.w=.5*z.z;z=1/z.z;r.x=z*v;r.y=2*r.x;r.x+=1;r.y+=1;t.setValue(r.data);l.x*=p;l.y*=p;l.z*=p;l.w*=p;La(a,w,q,l)}h.dpAtlas=y;h.sh=Kk(m)}this.dpAtlas=h.dpAtlas;this.ambientSH=h.sh;this._setParameter("ambientSH[0]",this.ambientSH);this._setParameter("texture_sphereMap",this.dpAtlas)}else f?
6>h._levels.length?t?this._setParameter("texture_prefilteredCubeMap128",h):console.log("Can't use prefiltered cubemap: "+t+", "+f+", "+h._levels):this._setParameter("texture_prefilteredCubeMap128",h):t?(this._setParameter("texture_prefilteredCubeMap128",h),this._setParameter("texture_prefilteredCubeMap64",p),this._setParameter("texture_prefilteredCubeMap32",n),this._setParameter("texture_prefilteredCubeMap16",m),this._setParameter("texture_prefilteredCubeMap8",q),this._setParameter("texture_prefilteredCubeMap4",
r)):console.log("Can't use prefiltered cubemap: "+t+", "+f+", "+h._levels)}f=aa.standard;f=(m=1<e&&18>=e)?f.optionsContextMin:f.optionsContext;m?this.shaderOptBuilder.updateMinRef(f,a,b,this,c,d,e,g,h):this.shaderOptBuilder.updateRef(f,a,b,this,c,d,e,g,h);this.onUpdateShader&&(f=this.onUpdateShader(f));this.shader=a.getProgramLibrary().getProgram("standard",f);c||(this.clearVariants(),this.variants[0]=this.shader);this.dirtyShader=!1}});(function(a){a.dirtyShader=!0;a.dirtyColor=!0;a._scene=null;
a._colorProcessed=!1;gh(a,"ambient",new J(.7,.7,.7));gh(a,"diffuse",new J(1,1,1));gh(a,"specular",new J(0,0,0));gh(a,"emissive",new J(0,0,0),!0);nb(a,"shininess",25,function(a,b){return{name:"material_shininess",value:0===a.shadingModel?Math.pow(2,.11*b):.01*b}});nb(a,"heightMapFactor",1,function(a,b){return{name:"material_heightMapFactor",value:.025*b}});nb(a,"opacity",1);nb(a,"alphaTest",0);nb(a,"bumpiness",1);nb(a,"normalDetailMapBumpiness",1);nb(a,"reflectivity",1);nb(a,"occludeSpecularIntensity",
1);nb(a,"refraction",0);nb(a,"refractionIndex",1/1.5);nb(a,"metalness",1);nb(a,"anisotropy",0);nb(a,"clearCoat",0);nb(a,"clearCoatGlossiness",1);nb(a,"aoUvSet",0,null);bc(a,"ambientSH",function(a,b,e){return{name:"ambientSH[0]",value:b}});bc(a,"cubeMapProjectionBox",function(a,b,e){var c=e?a.cubeMapMinUniform:new Float32Array(3);a=e?a.cubeMapMaxUniform:new Float32Array(3);c[0]=b.center.x-b.halfExtents.x;c[1]=b.center.y-b.halfExtents.y;c[2]=b.center.z-b.halfExtents.z;a[0]=b.center.x+b.halfExtents.x;
a[1]=b.center.y+b.halfExtents.y;a[2]=b.center.z+b.halfExtents.z;return[{name:"envBoxMin",value:c},{name:"envBoxMax",value:a}]});Wo();xa(a,"ambientTint",!1);xa(a,"diffuseTint",!1);xa(a,"specularTint",!1);xa(a,"emissiveTint",!1);xa(a,"fastTbn",!1);xa(a,"specularAntialias",!1);xa(a,"useMetalness",!1);xa(a,"enableGGXSpecular",!1);xa(a,"occludeDirect",!1);xa(a,"normalizeNormalMap",!0);xa(a,"conserveEnergy",!0);xa(a,"occludeSpecular",1);xa(a,"shadingModel",1);xa(a,"fresnelModel",0);xa(a,"cubeMapProjection",
0);xa(a,"customFragmentShader",null);xa(a,"forceFragmentPrecision",null);xa(a,"useFog",!0);xa(a,"useLighting",!0);xa(a,"useGammaTonemap",!0);xa(a,"useSkybox",!0);xa(a,"forceUv1",!1);xa(a,"pixelSnap",!1);xa(a,"twoSidedLighting",!1);xa(a,"nineSlicedMode",void 0);Bb(a,"diffuse",0,3,"",!0);Bb(a,"specular",0,3,"",!0);Bb(a,"emissive",0,3,"",!0);Bb(a,"normal",0,-1,"",!1);Bb(a,"metalness",0,1,"",!0);Bb(a,"gloss",0,1,"",!0);Bb(a,"opacity",0,1,"a",!0);Bb(a,"height",0,1,"",!1);Bb(a,"ao",0,1,"",!0);Bb(a,"light",
1,3,"",!0);Bb(a,"msdf",0,3,"",!1);Bb(a,"diffuseDetail",0,3,"",!1,!0);Bb(a,"normalDetail",0,-1,"",!1);bc(a,"cubeMap");bc(a,"sphereMap");bc(a,"dpAtlas");bc(a,"prefilteredCubeMap128");bc(a,"prefilteredCubeMap64");bc(a,"prefilteredCubeMap32");bc(a,"prefilteredCubeMap16");bc(a,"prefilteredCubeMap8");bc(a,"prefilteredCubeMap4");cc(a,"diffuseTint","diffuseMapTint");cc(a,"specularTint","specularMapTint");cc(a,"emissiveTint","emissiveMapTint");cc(a,"aoVertexColor","aoMapVertexColor");cc(a,"diffuseVertexColor",
"diffuseMapVertexColor");cc(a,"specularVertexColor","specularMapVertexColor");cc(a,"emissiveVertexColor","emissiveMapVertexColor");cc(a,"metalnessVertexColor","metalnessMapVertexColor");cc(a,"glossVertexColor","glossMapVertexColor");cc(a,"opacityVertexColor","opacityMapVertexColor");cc(a,"lightVertexColor","lightMapVertexColor");for(var b=0;b<Ja.length;b++)mm[b]=a[Ja[b]];a._propsSet=[]})(ea.prototype);xb.prototype.register=function(a,b){this.isRegistered(a)||(this._generators[a]=b)};xb.prototype.unregister=
function(a){this.isRegistered(a)&&delete this._generators[a]};xb.prototype.isRegistered=function(a){return void 0!==this._generators[a]};xb.prototype.getProgram=function(a,b){var c=this._generators[a];if(void 0===c)return null;var d=this._device,e=c.generateKey(b),g=this._cache[e];if(!g){if(b.lights){var f=b.lights;b.lights=f.map(function(a){var b=a.clone?a.clone():a;b.key=a.key;return b})}this.storeNewProgram(a,b);b.lights&&(b.lights=f);this._precached&&console.warn("ProgramLibrary#getProgram: Cache miss for shader",
a,"key",e,"after shaders precaching");a=c.createShaderDefinition(d,b);g=this._cache[e]=new Qd(d,a)}return g};xb.prototype.storeNewProgram=function(a,b){var c={};if("standard"===a){var d=this._getDefaultStdMatOptions(b.pass),e;for(e in b)if(b.hasOwnProperty(e)&&d[e]!==b[e]||"pass"===e)c[e]=b[e]}else c=b;this._programsCollection.push(JSON.stringify({name:a,options:c}))};xb.prototype.dumpPrograms=function(){var a="var device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\nvar shaders = [";
this._programsCollection[0]&&(a+="\n\t"+this._programsCollection[0]);for(var b=1;b<this._programsCollection.length;++b)a+=",\n\t"+this._programsCollection[b];a+='\n];\ndevice.programLib.precompile(shaders);\nif (pc.version != "1.29.0" || pc.revision != "fb8f6a3")\n\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';b=document.createElement("a");b.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(a));b.setAttribute("download",
"precompile-shaders.js");b.style.display="none";document.body.appendChild(b);b.click();document.body.removeChild(b)};xb.prototype.clearCache=function(){var a=this._cache;this._isClearingCache=!0;for(var b in a)a.hasOwnProperty(b)&&a[b].destroy();this._cache={};this._isClearingCache=!1};xb.prototype.removeFromCache=function(a){if(!this._isClearingCache){var b=this._cache,c;for(c in b)if(b.hasOwnProperty(c)&&b[c]===a){delete b[c];break}}};xb.prototype._getDefaultStdMatOptions=function(a){return 1<a&&
18>=a?this._defaultStdMatOptionMin:this._defaultStdMatOption};xb.prototype.precompile=function(a){if(a)for(var b=Array(a.length),c=0;c<a.length;c++){if("standard"===a[c].name){var d=a[c].options,e=this._getDefaultStdMatOptions(d.pass),g;for(g in e)e.hasOwnProperty(g)&&void 0===d[g]&&(d[g]=e[g]);d.useTexCubeLod=this._device.useTexCubeLod}b[c]=this.getProgram(a[c].name,a[c].options)}this._precached=!0};Object.assign(Ci.prototype,{equals:function(a){return this.globalId===a.globalId&&this.revision===
a.revision},notequals:function(a){return this.globalId!==a.globalId||this.revision!==a.revision},copy:function(a){this.globalId=a.globalId;this.revision=a.revision},reset:function(){this.revision=this.globalId=0}});var Ik=0;Object.assign(Hk.prototype,{increment:function(){this.version.revision++}});Object.assign(ng.prototype,{setValue:function(a){this.value=a;this.versionObject.increment()},getValue:function(){return this.value}});Object.assign(og.prototype,{resolve:function(a){this.variables.hasOwnProperty(a)||
(this.variables[a]=new ng(a));return this.variables[a]},getSubSpace:function(a){this.namespaces.hasOwnProperty(a)||(this.namespaces[a]=new og(a));return this.namespaces[a]}});var om=function(a,b){var c=a.width,d=a.height;if(c>b||d>b){var e=b/Math.max(c,d),g=Math.floor(c*e);e=Math.floor(d*e);console.warn("Image dimensions larger than max supported texture size of "+b+". Resizing from "+c+", "+d+" to "+g+", "+e+".");b=document.createElement("canvas");b.width=g;b.height=e;b.getContext("2d").drawImage(a,
0,0,c,d,0,0,g,e);return b}return a},kb=function(a,b){H.call(this);var c;this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.vbOffsets=[];this._enableAutoInstancing=!1;this.autoInstancingMaxObjects=16384;this.attributesInvalidated=!0;this.boundElementBuffer=this.boundBuffer=this.defaultFramebuffer=null;this.instancedAttribs={};this.enabledAttributes={};this.activeFramebuffer=this.transformFeedbackBuffer=null;this.textureUnit=0;this.textureUnits=[];this._maxPixelRatio=1;this.feedback=
this.renderTarget=null;this._tempEnableSafariTextureUnitWorkaround=!!window.safari;this._height=this._width=0;this.updateClientRect();this.vertexShaderCache={};this.fragmentShaderCache={};this.shaders=[];this.buffers=[];this.textures=[];this.targets=[];this.contextLost=!1;this._contextLostHandler=function(a){a.preventDefault();this.contextLost=!0;this.fire("devicelost")}.bind(this);this._contextRestoredHandler=function(){this.initializeContext();this.contextLost=!1;this.fire("devicerestored")}.bind(this);
a.addEventListener("webglcontextlost",this._contextLostHandler,!1);a.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1);var d=b&&void 0!==b.preferWebGl2?b.preferWebGl2:!0,e=d?["webgl2","experimental-webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"],g=null;b=b||{};b.stencil=!0;for(c=0;c<e.length;c++){try{g=a.getContext(e[c],b)}catch(q){}if(g){this.webgl2=d&&2>c;break}}if(!g)throw Error("WebGL not supported");this.gl=g;this.initializeExtensions();this.initializeCapabilities();
this.initializeRenderState();for(c=0;c<this.maxCombinedTextures;c++)this.textureUnits.push([null,null,null]);this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3};this.glAddress=[g.REPEAT,g.CLAMP_TO_EDGE,g.MIRRORED_REPEAT];this.glBlendEquation=[g.FUNC_ADD,g.FUNC_SUBTRACT,g.FUNC_REVERSE_SUBTRACT,this.webgl2?g.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:g.FUNC_ADD,this.webgl2?g.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:g.FUNC_ADD];this.glBlendFunction=[g.ZERO,g.ONE,
g.SRC_COLOR,g.ONE_MINUS_SRC_COLOR,g.DST_COLOR,g.ONE_MINUS_DST_COLOR,g.SRC_ALPHA,g.SRC_ALPHA_SATURATE,g.ONE_MINUS_SRC_ALPHA,g.DST_ALPHA,g.ONE_MINUS_DST_ALPHA];this.glComparison=[g.NEVER,g.LESS,g.EQUAL,g.LEQUAL,g.GREATER,g.NOTEQUAL,g.GEQUAL,g.ALWAYS];this.glStencilOp=[g.KEEP,g.ZERO,g.REPLACE,g.INCR,g.INCR_WRAP,g.DECR,g.DECR_WRAP,g.INVERT];this.glClearFlag=[0,g.COLOR_BUFFER_BIT,g.DEPTH_BUFFER_BIT,g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT,g.STENCIL_BUFFER_BIT,g.STENCIL_BUFFER_BIT|g.COLOR_BUFFER_BIT,g.STENCIL_BUFFER_BIT|
g.DEPTH_BUFFER_BIT,g.STENCIL_BUFFER_BIT|g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT];this.glCull=[0,g.BACK,g.FRONT,g.FRONT_AND_BACK];this.glFilter=[g.NEAREST,g.LINEAR,g.NEAREST_MIPMAP_NEAREST,g.NEAREST_MIPMAP_LINEAR,g.LINEAR_MIPMAP_NEAREST,g.LINEAR_MIPMAP_LINEAR];this.glPrimitive=[g.POINTS,g.LINES,g.LINE_LOOP,g.LINE_STRIP,g.TRIANGLES,g.TRIANGLE_STRIP,g.TRIANGLE_FAN];this.glType=[g.BYTE,g.UNSIGNED_BYTE,g.SHORT,g.UNSIGNED_SHORT,g.INT,g.UNSIGNED_INT,g.FLOAT];this.pcUniformType={};this.pcUniformType[g.BOOL]=
0;this.pcUniformType[g.INT]=1;this.pcUniformType[g.FLOAT]=2;this.pcUniformType[g.FLOAT_VEC2]=3;this.pcUniformType[g.FLOAT_VEC3]=4;this.pcUniformType[g.FLOAT_VEC4]=5;this.pcUniformType[g.INT_VEC2]=6;this.pcUniformType[g.INT_VEC3]=7;this.pcUniformType[g.INT_VEC4]=8;this.pcUniformType[g.BOOL_VEC2]=9;this.pcUniformType[g.BOOL_VEC3]=10;this.pcUniformType[g.BOOL_VEC4]=11;this.pcUniformType[g.FLOAT_MAT2]=12;this.pcUniformType[g.FLOAT_MAT3]=13;this.pcUniformType[g.FLOAT_MAT4]=14;this.pcUniformType[g.SAMPLER_2D]=
15;this.pcUniformType[g.SAMPLER_CUBE]=16;this.webgl2&&(this.pcUniformType[g.SAMPLER_2D_SHADOW]=18,this.pcUniformType[g.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[g.SAMPLER_3D]=20);this.targetToSlot={};this.targetToSlot[g.TEXTURE_2D]=0;this.targetToSlot[g.TEXTURE_CUBE_MAP]=1;this.targetToSlot[g.TEXTURE_3D]=2;var f,l,h,p,n;this.commitFunction=[];this.commitFunction[0]=function(a,b){a.value!==b&&(g.uniform1i(a.locationId,b),a.value=b)};this.commitFunction[1]=this.commitFunction[0];this.commitFunction[2]=
function(a,b){a.value!==b&&(g.uniform1f(a.locationId,b),a.value=b)};this.commitFunction[3]=function(a,b){n=a.value;f=b[0];l=b[1];if(n[0]!==f||n[1]!==l)g.uniform2fv(a.locationId,b),n[0]=f,n[1]=l};this.commitFunction[4]=function(a,b){n=a.value;f=b[0];l=b[1];h=b[2];if(n[0]!==f||n[1]!==l||n[2]!==h)g.uniform3fv(a.locationId,b),n[0]=f,n[1]=l,n[2]=h};this.commitFunction[5]=function(a,b){n=a.value;f=b[0];l=b[1];h=b[2];p=b[3];if(n[0]!==f||n[1]!==l||n[2]!==h||n[3]!==p)g.uniform4fv(a.locationId,b),n[0]=f,n[1]=
l,n[2]=h,n[3]=p};this.commitFunction[6]=function(a,b){n=a.value;f=b[0];l=b[1];if(n[0]!==f||n[1]!==l)g.uniform2iv(a.locationId,b),n[0]=f,n[1]=l};this.commitFunction[9]=this.commitFunction[6];this.commitFunction[7]=function(a,b){n=a.value;f=b[0];l=b[1];h=b[2];if(n[0]!==f||n[1]!==l||n[2]!==h)g.uniform3iv(a.locationId,b),n[0]=f,n[1]=l,n[2]=h};this.commitFunction[10]=this.commitFunction[7];this.commitFunction[8]=function(a,b){n=a.value;f=b[0];l=b[1];h=b[2];p=b[3];if(n[0]!==f||n[1]!==l||n[2]!==h||n[3]!==
p)g.uniform4iv(a.locationId,b),n[0]=f,n[1]=l,n[2]=h,n[3]=p};this.commitFunction[11]=this.commitFunction[8];this.commitFunction[12]=function(a,b){g.uniformMatrix2fv(a.locationId,!1,b)};this.commitFunction[13]=function(a,b){g.uniformMatrix3fv(a.locationId,!1,b)};this.commitFunction[14]=function(a,b){g.uniformMatrix4fv(a.locationId,!1,b)};this.commitFunction[17]=function(a,b){g.uniform1fv(a.locationId,b)};this.scope=new og("Device");this.programLib=new xb(this);for(var m in aa)this.programLib.register(m,
aa[m]);this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures;this.useTexCubeLod=this.extTextureLod&&16>this.maxTextures;this.boneLimit=Math.floor((this.vertexUniformsCount-16-8-1-16)/4);this.boneLimit=Math.min(this.boneLimit,128);"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34);this._shaderSwitchesPerFrame=this._drawCallsPerFrame=0;this._primsPerFrame=[];for(c=0;6>=c;c++)this._primsPerFrame[c]=0;this._renderTargetCreationTime=0;this._vram={tex:0,vb:0,ib:0};this._shaderStats=
{vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0};this.constantTexSource=this.scope.resolve("source");this.textureFloatRenderable=this.extTextureFloat?this.webgl2?!!this.extColorBufferFloat:Jk(g,g.FLOAT):!1;this.textureHalfFloatRenderable=this.extTextureHalfFloat?this.webgl2?!!this.extColorBufferFloat:Jk(g,this.extTextureHalfFloat.HALF_FLOAT_OES):!1;this._textureFloatHighPrecision=void 0;this.createGrabPass(b.alpha);Ka.init(this)};kb.prototype=Object.create(H.prototype);kb.prototype.constructor=
kb;Object.assign(kb.prototype,{getPrecision:function(){var a=this.gl,b="highp";if(a.getShaderPrecisionFormat){var c=a.getShaderPrecisionFormat(a.VERTEX_SHADER,a.HIGH_FLOAT),d=a.getShaderPrecisionFormat(a.VERTEX_SHADER,a.MEDIUM_FLOAT),e=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT);a=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT);d=0<d.precision&&0<a.precision;0<c.precision&&0<e.precision||(b=d?"mediump":"lowp")}return b},initializeExtensions:function(){var a=this.gl,b=a.getSupportedExtensions(),
c=function(){for(var c=0;c<arguments.length;c++)if(-1!==b.indexOf(arguments[c]))return a.getExtension(arguments[c]);return null};if(this.webgl2)this.extVertexArrayObject=this.extUintElement=this.extTextureLod=this.extTextureHalfFloatLinear=this.extTextureHalfFloat=this.extTextureFloat=this.extStandardDerivatives=this.extInstancing=this.extDrawBuffers=this.extBlendMinmax=!0,this.extColorBufferFloat=c("EXT_color_buffer_float"),this.extDisjointTimerQuery=c("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query");
else{this.extBlendMinmax=c("EXT_blend_minmax");this.extDrawBuffers=c("EXT_draw_buffers");if(this.extInstancing=c("ANGLE_instanced_arrays")){var d=this.extInstancing;a.drawArraysInstanced=d.drawArraysInstancedANGLE.bind(d);a.drawElementsInstanced=d.drawElementsInstancedANGLE.bind(d);a.vertexAttribDivisor=d.vertexAttribDivisorANGLE.bind(d)}this.extStandardDerivatives=c("OES_standard_derivatives");this.extTextureFloat=c("OES_texture_float");this.extTextureHalfFloat=c("OES_texture_half_float");this.extTextureHalfFloatLinear=
c("OES_texture_half_float_linear");this.extTextureLod=c("EXT_shader_texture_lod");this.extUintElement=c("OES_element_index_uint");if(this.extVertexArrayObject=c("OES_vertex_array_object"))d=this.extVertexArrayObject,a.createVertexArray=d.createVertexArrayOES.bind(d),a.deleteVertexArray=d.deleteVertexArrayOES.bind(d),a.isVertexArray=d.isVertexArrayOES.bind(d),a.bindVertexArray=d.bindVertexArrayOES.bind(d);this.extDisjointTimerQuery=this.extColorBufferFloat=null}this.extDebugRendererInfo=c("WEBGL_debug_renderer_info");
this.extTextureFloatLinear=c("OES_texture_float_linear");this.extTextureFilterAnisotropic=c("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic");this.extCompressedTextureETC1=c("WEBGL_compressed_texture_etc1");this.extCompressedTextureETC=c("WEBGL_compressed_texture_etc");this.extCompressedTexturePVRTC=c("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc");this.extCompressedTextureS3TC=c("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc");
this.extCompressedTextureATC=c("WEBGL_compressed_texture_atc");this.extCompressedTextureASTC=c("WEBGL_compressed_texture_astc");this.extParallelShaderCompile=c("KHR_parallel_shader_compile");this.supportsInstancing=!!this.extInstancing},initializeCapabilities:function(){var a=this.gl;this.maxPrecision=this.precision=this.getPrecision();var b=a.getContextAttributes();this.supportsMsaa=b.antialias;this.supportsStencil=b.stencil;this.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE);this.maxCubeMapSize=
a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE);this.maxRenderBufferSize=a.getParameter(a.MAX_RENDERBUFFER_SIZE);this.maxTextures=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);this.maxCombinedTextures=a.getParameter(a.MAX_COMBINED_TEXTURE_IMAGE_UNITS);this.maxVertexTextures=a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.vertexUniformsCount=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS);this.fragmentUniformsCount=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS);this.webgl2?(this.maxDrawBuffers=a.getParameter(a.MAX_DRAW_BUFFERS),
this.maxColorAttachments=a.getParameter(a.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=a.getParameter(a.MAX_3D_TEXTURE_SIZE)):(this.maxDrawBuffers=(b=this.extDrawBuffers)?a.getParameter(b.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=b?a.getParameter(b.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1);this.unmaskedRenderer=(b=this.extDebugRendererInfo)?a.getParameter(b.UNMASKED_RENDERER_WEBGL):"";this.unmaskedVendor=b?a.getParameter(b.UNMASKED_VENDOR_WEBGL):"";this.maxAnisotropy=(b=this.extTextureFilterAnisotropic)?
a.getParameter(b.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;this.samples=a.getParameter(a.SAMPLES)},initializeRenderState:function(){var a=this.gl;this.blending=!1;a.disable(a.BLEND);this.blendSrc=1;this.blendDst=0;this.blendSrcAlpha=1;this.blendDstAlpha=0;this.separateAlphaBlend=!1;this.blendAlphaEquation=this.blendEquation=0;this.separateAlphaEquation=!1;a.blendFunc(a.ONE,a.ZERO);a.blendEquation(a.FUNC_ADD);this.writeAlpha=this.writeBlue=this.writeGreen=this.writeRed=!0;a.colorMask(!0,!0,!0,!0);this.cullMode=
1;a.enable(a.CULL_FACE);a.cullFace(a.BACK);this.depthTest=!0;a.enable(a.DEPTH_TEST);this.depthFunc=3;a.depthFunc(a.LEQUAL);this.depthWrite=!0;a.depthMask(!0);this.stencil=!1;a.disable(a.STENCIL_TEST);this.stencilFuncFront=this.stencilFuncBack=7;this.stencilRefFront=this.stencilRefBack=0;this.stencilMaskFront=this.stencilMaskBack=255;a.stencilFunc(a.ALWAYS,0,255);this.stencilZpassFront=this.stencilZpassBack=this.stencilZfailFront=this.stencilZfailBack=this.stencilFailFront=this.stencilFailBack=0;this.stencilWriteMaskBack=
this.stencilWriteMaskFront=255;a.stencilOp(a.KEEP,a.KEEP,a.KEEP);a.stencilMask(255);this.alphaToCoverage=!1;this.raster=!0;this.webgl2&&(a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),a.disable(a.RASTERIZER_DISCARD));this.depthBiasEnabled=!1;a.disable(a.POLYGON_OFFSET_FILL);this.clearDepth=1;a.clearDepth(1);this.clearAlpha=this.clearGreen=this.clearBlue=this.clearRed=0;a.clearColor(0,0,0,0);this.clearStencil=0;a.clearStencil(0);this.sx=this.sy=this.sw=this.sh=this.vx=this.vy=this.vw=this.vh=0;this.webgl2?
a.hint(a.FRAGMENT_SHADER_DERIVATIVE_HINT,a.NICEST):this.extStandardDerivatives&&a.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,a.NICEST);a.enable(a.SCISSOR_TEST);a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.NONE);this.unpackFlipY=!1;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);this.unpackPremultiplyAlpha=!1;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)},initializeContext:function(){this.initializeExtensions();this.initializeCapabilities();this.initializeRenderState();
var a;var b=0;for(a=this.shaders.length;b<a;b++)this.compileAndLinkShader(this.shaders[b]);this.shader=null;b=0;for(a=this.buffers.length;b<a;b++)this.buffers[b].bufferId=void 0,this.buffers[b].unlock();this.indexBuffer=this.boundElementBuffer=this.boundBuffer=null;this.attributesInvalidated=!0;this.enabledAttributes={};this.vertexBuffers=[];b=0;for(a=this.textures.length;b<a;b++){var c=this.textures[b];this.destroyTexture(c);c.dirtyAll()}this.textureUnit=0;for(b=this.textureUnits.length=0;b<this.maxCombinedTextures;b++)this.textureUnits.push([null,
null,null]);b=0;for(a=this.targets.length;b<a;b++)this.targets[b]._glFrameBuffer=void 0,this.targets[b]._glDepthBuffer=void 0,this.targets[b]._glResolveFrameBuffer=void 0,this.targets[b]._glMsaaColorBuffer=void 0,this.targets[b]._glMsaaDepthBuffer=void 0;this.transformFeedbackBuffer=this.feedback=this.activeFramebuffer=this.renderTarget=null},createGrabPass:function(a){if(!this.grabPassTexture){a=new L(this,{format:a?7:6,minFilter:1,magFilter:1,addressU:1,addressV:1,mipmaps:!1});a.name="texture_grabPass";
var b=this.scope.resolve(a.name);b.setValue(a);this.grabPassRenderTarget=new oa({colorBuffer:a,depth:!1});this.grabPassTextureId=b;this.grabPassTexture=a}},updateGrabPass:function(){var a=this.gl,b=this.renderTarget,c=b&&b._glResolveFrameBuffer,d=this.grabPassTexture,e=this.width,g=this.height;this.webgl2&&e===d._width&&g===d._height?(c&&b.resolve(!0),c=b?b._glFrameBuffer:null,b=b?b._glResolveFrameBuffer||b._glFrameBuffer:null,this.initRenderTarget(this.grabPassRenderTarget),d=this.grabPassRenderTarget._glFrameBuffer,
a.bindFramebuffer(a.READ_FRAMEBUFFER,b),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,d),a.blitFramebuffer(0,0,e,g,0,0,e,g,a.COLOR_BUFFER_BIT,a.NEAREST),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,c)):(c&&(b.resolve(!0),a.bindFramebuffer(a.FRAMEBUFFER,b._glResolveFrameBuffer)),a.copyTexImage2D(a.TEXTURE_2D,0,d._glFormat,0,0,e,g,0),d._width=e,d._height=g,c&&a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer))},destroyGrabPass:function(){this.grabPassRenderTarget.destroy();this.grabPassTextureId=this.grabPassRenderTarget=
null;this.grabPassTexture.destroy();this.grabPassTexture=null},updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},setViewport:function(a,b,c,d){if(this.vx!==a||this.vy!==b||this.vw!==c||this.vh!==d)this.gl.viewport(a,b,c,d),this.vx=a,this.vy=b,this.vw=c,this.vh=d},setScissor:function(a,b,c,d){if(this.sx!==a||this.sy!==b||this.sw!==c||this.sh!==d)this.gl.scissor(a,b,c,d),this.sx=a,this.sy=b,this.sw=c,this.sh=d},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(a){this.programLib=
a},setFramebuffer:function(a){this.activeFramebuffer!==a&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,a),this.activeFramebuffer=a)},_checkFbo:function(){var a=this.gl;switch(a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");
break;case a.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED")}},copyRenderTarget:function(a,b,c,d){var e=this.gl;if(!this.webgl2&&d)return!1;if(c)if(!b){if(!a._colorBuffer)return!1}else if(!a._colorBuffer||!b._colorBuffer||a._colorBuffer._format!==b._colorBuffer._format)return!1;if(d&&(!a._depthBuffer||!b._depthBuffer||a._depthBuffer._format!==b._depthBuffer._format))return!1;if(this.webgl2&&b){var g=this.renderTarget;this.renderTarget=b;this.updateBegin();e.bindFramebuffer(e.READ_FRAMEBUFFER,
a?a._glFrameBuffer:null);e.bindFramebuffer(e.DRAW_FRAMEBUFFER,b._glFrameBuffer);var f=a?a.width:b.width;a=a?a.height:b.height;e.blitFramebuffer(0,0,f,a,0,0,f,a,(c?e.COLOR_BUFFER_BIT:0)|(d?e.DEPTH_BUFFER_BIT:0),e.NEAREST);this.renderTarget=g;e.bindFramebuffer(e.FRAMEBUFFER,g?g._glFrameBuffer:null)}else c=this.getCopyShader(),this.constantTexSource.setValue(a._colorBuffer),La(this,b,c);return!0},initRenderTarget:function(a){if(!a._glFrameBuffer){a._device=this;var b=this.gl;a._glFrameBuffer=b.createFramebuffer();
this.setFramebuffer(a._glFrameBuffer);var c=a._colorBuffer;c&&(c._glTexture||(c._width=Math.min(c.width,this.maxRenderBufferSize),c._height=Math.min(c.height,this.maxRenderBufferSize),this.setTexture(c,0)),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,c._cubemap?b.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:b.TEXTURE_2D,c._glTexture,0));var d=a._depthBuffer;d&&this.webgl2?(d._glTexture||(d._width=Math.min(d.width,this.maxRenderBufferSize),d._height=Math.min(d.height,this.maxRenderBufferSize),this.setTexture(d,
0)),a._stencil?b.framebufferTexture2D(b.FRAMEBUFFER,b.DEPTH_STENCIL_ATTACHMENT,d._cubemap?b.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:b.TEXTURE_2D,a._depthBuffer._glTexture,0):b.framebufferTexture2D(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,d._cubemap?b.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:b.TEXTURE_2D,a._depthBuffer._glTexture,0)):!a._depth||1<a._samples&&this.webgl2||(a._glDepthBuffer||(a._glDepthBuffer=b.createRenderbuffer()),b.bindRenderbuffer(b.RENDERBUFFER,a._glDepthBuffer),a._stencil?(b.renderbufferStorage(b.RENDERBUFFER,
b.DEPTH_STENCIL,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_STENCIL_ATTACHMENT,b.RENDERBUFFER,a._glDepthBuffer)):(b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,a._glDepthBuffer)),b.bindRenderbuffer(b.RENDERBUFFER,null));this.webgl2&&1<a._samples&&(a._glResolveFrameBuffer=a._glFrameBuffer,a._glFrameBuffer=b.createFramebuffer(),this.setFramebuffer(a._glFrameBuffer),c&&(a._glMsaaColorBuffer||
(a._glMsaaColorBuffer=b.createRenderbuffer()),b.bindRenderbuffer(b.RENDERBUFFER,a._glMsaaColorBuffer),b.renderbufferStorageMultisample(b.RENDERBUFFER,a._samples,c._glInternalFormat,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.RENDERBUFFER,a._glMsaaColorBuffer)),a._depth&&(a._glMsaaDepthBuffer||(a._glMsaaDepthBuffer=b.createRenderbuffer()),b.bindRenderbuffer(b.RENDERBUFFER,a._glMsaaDepthBuffer),a._stencil?(b.renderbufferStorageMultisample(b.RENDERBUFFER,a._samples,
b.DEPTH24_STENCIL8,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_STENCIL_ATTACHMENT,b.RENDERBUFFER,a._glMsaaDepthBuffer)):(b.renderbufferStorageMultisample(b.RENDERBUFFER,a._samples,b.DEPTH_COMPONENT32F,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,a._glMsaaDepthBuffer))));this.targets.push(a)}},getCopyShader:function(){if(!this._copyShader){var a=K;this._copyShader=a.createShaderFromCode(this,a.fullscreenQuadVS,a.outputTex2DPS,"outputTex2D")}return this._copyShader},
updateBegin:function(){this.boundElementBuffer=this.boundBuffer=null;if(this._tempEnableSafariTextureUnitWorkaround)for(var a=0;a<this.textureUnits.length;++a)for(var b=0;3>b;++b)this.textureUnits[a][b]=null;(a=this.renderTarget)?a._glFrameBuffer?this.setFramebuffer(a._glFrameBuffer):this.initRenderTarget(a):this.setFramebuffer(this.defaultFramebuffer)},updateEnd:function(){var a=this.gl,b=this.renderTarget;if(b){var c=b._colorBuffer;c&&c._glTexture&&c.mipmaps&&c.pot&&(this.activeTexture(this.maxCombinedTextures-
1),this.bindTexture(c),a.generateMipmap(c._glTarget));this.webgl2&&1<b._samples&&b.autoResolve&&b.resolve()}},initializeTexture:function(a){var b=this.gl;a._glTexture=b.createTexture();a._glTarget=a._cubemap?b.TEXTURE_CUBE_MAP:a._volume?b.TEXTURE_3D:b.TEXTURE_2D;switch(a._format){case 0:a._glFormat=b.ALPHA;a._glInternalFormat=b.ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case 1:a._glFormat=b.LUMINANCE;a._glInternalFormat=b.LUMINANCE;a._glPixelType=b.UNSIGNED_BYTE;break;case 2:a._glFormat=b.LUMINANCE_ALPHA;
a._glInternalFormat=b.LUMINANCE_ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case 3:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.UNSIGNED_SHORT_5_6_5;break;case 4:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_5_5_5_1;break;case 5:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_4_4_4_4;break;case 6:a._glFormat=b.RGB;a._glInternalFormat=this.webgl2?b.RGB8:b.RGB;a._glPixelType=b.UNSIGNED_BYTE;break;case 7:a._glFormat=b.RGBA;
a._glInternalFormat=this.webgl2?b.RGBA8:b.RGBA;a._glPixelType=b.UNSIGNED_BYTE;break;case 8:var c=this.extCompressedTextureS3TC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:c=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:c=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:c=this.extCompressedTextureETC1;a._glFormat=b.RGB;a._glInternalFormat=
c.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;
break;case 22:c=this.extCompressedTextureETC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB8_ETC2;break;case 23:c=this.extCompressedTextureETC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:c=this.extCompressedTextureASTC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:c=this.extCompressedTextureATC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_ATC_WEBGL;break;case 30:c=this.extCompressedTextureATC;a._glFormat=
b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:c=this.extTextureHalfFloat;a._glFormat=b.RGB;this.webgl2?(a._glInternalFormat=b.RGB16F,a._glPixelType=b.HALF_FLOAT):(a._glInternalFormat=b.RGB,a._glPixelType=c.HALF_FLOAT_OES);break;case 12:c=this.extTextureHalfFloat;a._glFormat=b.RGBA;this.webgl2?(a._glInternalFormat=b.RGBA16F,a._glPixelType=b.HALF_FLOAT):(a._glInternalFormat=b.RGBA,a._glPixelType=c.HALF_FLOAT_OES);break;case 13:a._glFormat=b.RGB;a._glInternalFormat=
this.webgl2?b.RGB32F:b.RGB;a._glPixelType=b.FLOAT;break;case 14:a._glFormat=b.RGBA;a._glInternalFormat=this.webgl2?b.RGBA32F:b.RGBA;a._glPixelType=b.FLOAT;break;case 15:a._glFormat=b.RED;a._glInternalFormat=b.R32F;a._glPixelType=b.FLOAT;break;case 16:this.webgl2?(a._glFormat=b.DEPTH_COMPONENT,a._glInternalFormat=b.DEPTH_COMPONENT32F,a._glPixelType=b.FLOAT):(a._glFormat=b.DEPTH_COMPONENT,a._glInternalFormat=b.DEPTH_COMPONENT,a._glPixelType=b.UNSIGNED_SHORT);break;case 17:a._glFormat=b.DEPTH_STENCIL;
a._glInternalFormat=b.DEPTH24_STENCIL8;a._glPixelType=b.UNSIGNED_INT_24_8;break;case 18:a._glFormat=b.RGB;a._glInternalFormat=b.R11F_G11F_B10F;a._glPixelType=b.FLOAT;break;case 19:a._glFormat=b.RGB;a._glInternalFormat=b.SRGB8;a._glPixelType=b.UNSIGNED_BYTE;break;case 20:a._glFormat=b.RGBA,a._glInternalFormat=b.SRGB8_ALPHA8,a._glPixelType=b.UNSIGNED_BYTE}this.textures.push(a)},destroyTexture:function(a){if(a._glTexture){var b=this.textures.indexOf(a);-1!==b&&this.textures.splice(b,1);for(var c in this.scope.variables)b=
this.scope.variables[c],b.value===a&&(b.value=null);for(c=0;c<this.textureUnits.length;c++){b=this.textureUnits[c];for(var d=0;d<b.length;d++)b[d]===a._glTexture&&(b[d]=null)}this.gl.deleteTexture(a._glTexture);delete a._glTexture;delete a._glTarget;delete a._glFormat;delete a._glInternalFormat;delete a._glPixelType;this._vram.tex-=a._gpuSize}},setUnpackFlipY:function(a){if(this.unpackFlipY!==a){this.unpackFlipY=a;var b=this.gl;b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,a)}},setUnpackPremultiplyAlpha:function(a){if(this.unpackPremultiplyAlpha!==
a){this.unpackPremultiplyAlpha=a;var b=this.gl;b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}},uploadTexture:function(a){var b=this.gl;if(a._needsUpload||!(a._needsMipmapsUpload&&a._mipmapsUploaded||!a.pot)){for(var c=0,d,e,g=Math.log2(Math.max(a._width,a._height))+1;a._levels[c]||0===c;){if(a._needsUpload||0!==c){if(c&&(!a._needsMipmapsUpload||!a._mipmaps))break;d=a._levels[c];1==c&&!a._compressed&&a._levels.length<g&&(b.generateMipmap(a._glTarget),a._mipmapsUploaded=!0);if(a._cubemap){var f;
if(d[0]instanceof HTMLCanvasElement||d[0]instanceof HTMLImageElement||d[0]instanceof HTMLVideoElement)for(f=0;6>f;f++)a._levelsUpdated[0][f]&&(e=d[f],e instanceof HTMLImageElement&&(e.width>this.maxCubeMapSize||e.height>this.maxCubeMapSize)&&(e=om(e,this.maxCubeMapSize),0===c&&(a.width=e.width,a.height=e.height)),this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+f,c,a._glInternalFormat,a._glFormat,a._glPixelType,e));else for(e=1/
Math.pow(2,c),f=0;6>f;f++)if(a._levelsUpdated[0][f]){var l=d[f];a._compressed?b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+f,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),0,l):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+f,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),0,a._glFormat,a._glPixelType,l))}}else a._volume?(e=1/Math.pow(2,c),a._compressed?b.compressedTexImage3D(b.TEXTURE_3D,
c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),Math.max(a._depth*e,1),0,d):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),b.texImage3D(b.TEXTURE_3D,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),Math.max(a._depth*e,1),0,a._glFormat,a._glPixelType,d))):(d instanceof HTMLCanvasElement||d instanceof HTMLImageElement||d instanceof HTMLVideoElement?(d instanceof HTMLImageElement&&(d.width>this.maxTextureSize||d.height>this.maxTextureSize)&&
(d=om(d,this.maxTextureSize),0===c&&(a.width=d.width,a.height=d.height)),this.setUnpackFlipY(a._flipY),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),b.texImage2D(b.TEXTURE_2D,c,a._glInternalFormat,a._glFormat,a._glPixelType,d)):(e=1/Math.pow(2,c),a._compressed?b.compressedTexImage2D(b.TEXTURE_2D,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),0,d):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),b.texImage2D(b.TEXTURE_2D,c,a._glInternalFormat,
Math.max(a._width*e,1),Math.max(a._height*e,1),0,a._glFormat,a._glPixelType,d))),a._mipmapsUploaded=0===c?!1:!0)}c++}if(a._needsUpload)if(a._cubemap)for(c=0;6>c;c++)a._levelsUpdated[0][c]=!1;else a._levelsUpdated[0]=!1;!a._compressed&&a._mipmaps&&a._needsMipmapsUpload&&a.pot&&1===a._levels.length&&(b.generateMipmap(a._glTarget),a._mipmapsUploaded=!0);a._gpuSize&&(this._vram.tex-=a._gpuSize);a._gpuSize=a.gpuSize;this._vram.tex+=a._gpuSize}},activeTexture:function(a){this.textureUnit!==a&&(this.gl.activeTexture(this.gl.TEXTURE0+
a),this.textureUnit=a)},bindTexture:function(a){var b=a._glTarget;a=a._glTexture;var c=this.textureUnit,d=this.targetToSlot[b];this.textureUnits[c][d]!==a&&(this.gl.bindTexture(b,a),this.textureUnits[c][d]=a)},bindTextureOnUnit:function(a,b){var c=a._glTarget;a=a._glTexture;var d=this.targetToSlot[c];this.textureUnits[b][d]!==a&&(this.activeTexture(b),this.gl.bindTexture(c,a),this.textureUnits[b][d]=a)},setTextureParameters:function(a){var b=this.gl,c=a._parameterFlags,d=a._glTarget;if(c&1){var e=
a._minFilter;if(!a.pot||!a._mipmaps||a._compressed&&1===a._levels.length)if(2===e||3===e)e=0;else if(4===e||5===e)e=1;b.texParameteri(d,b.TEXTURE_MIN_FILTER,this.glFilter[e])}c&2&&b.texParameteri(d,b.TEXTURE_MAG_FILTER,this.glFilter[a._magFilter]);c&4&&(this.webgl2?b.texParameteri(d,b.TEXTURE_WRAP_S,this.glAddress[a._addressU]):b.texParameteri(d,b.TEXTURE_WRAP_S,this.glAddress[a.pot?a._addressU:1]));c&8&&(this.webgl2?b.texParameteri(d,b.TEXTURE_WRAP_T,this.glAddress[a._addressV]):b.texParameteri(d,
b.TEXTURE_WRAP_T,this.glAddress[a.pot?a._addressV:1]));c&16&&this.webgl2&&b.texParameteri(d,b.TEXTURE_WRAP_R,this.glAddress[a._addressW]);c&32&&this.webgl2&&b.texParameteri(d,b.TEXTURE_COMPARE_MODE,a._compareOnRead?b.COMPARE_REF_TO_TEXTURE:b.NONE);c&64&&this.webgl2&&b.texParameteri(d,b.TEXTURE_COMPARE_FUNC,this.glComparison[a._compareFunc]);c&128&&(c=this.extTextureFilterAnisotropic)&&b.texParameterf(d,c.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(a._anisotropy),this.maxAnisotropy)))},
setTexture:function(a,b){a._glTexture||this.initializeTexture(a);if(0<a._parameterFlags||a._needsUpload||a._needsMipmapsUpload||a===this.grabPassTexture)if(this.activeTexture(b),this.bindTexture(a),a._parameterFlags&&(this.setTextureParameters(a),a._parameterFlags=0),a===this.grabPassTexture)this.updateGrabPass();else{if(a._needsUpload||a._needsMipmapsUpload)this.uploadTexture(a),a._needsUpload=!1,a._needsMipmapsUpload=!1}else this.bindTextureOnUnit(a,b)},setBuffers:function(a){var b=this.gl,c,d=
this.shader.attributes;if(this.attributesInvalidated){for(var e=0,g=d.length;e<g;e++){var f=d[e];var l=f.scopeId.value;if(null!==l){if(c=this.vertexBuffers[l.stream]){var h=this.vbOffsets[l.stream]||0;c=c.bufferId;this.boundBuffer!==c&&(b.bindBuffer(b.ARRAY_BUFFER,c),this.boundBuffer=c);f=f.locationId;this.enabledAttributes[f]||(b.enableVertexAttribArray(f),this.enabledAttributes[f]=!0);b.vertexAttribPointer(f,l.numComponents,this.glType[l.dataType],l.normalize,l.stride,l.offset+h);1===l.stream&&
0<a?this.instancedAttribs[f]||(b.vertexAttribDivisor(f,1),this.instancedAttribs[f]=!0):this.instancedAttribs[f]&&(b.vertexAttribDivisor(f,0),this.instancedAttribs[f]=!1)}}else this.enabledAttributes[f.locationId]&&(b.disableVertexAttribArray(f.locationId),this.enabledAttributes[f.locationId]=!1)}this.attributesInvalidated=!1}c=this.indexBuffer?this.indexBuffer.bufferId:null;this.boundElementBuffer!==c&&(b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,c),this.boundElementBuffer=c)},draw:function(a,b){var c=this.gl,
d,e,g;var f=this.shader;var l=f.samplers;var h=f.uniforms;0<b&&(this.boundBuffer=null,this.attributesInvalidated=!0);this.setBuffers(b);var p=0;f=0;for(e=l.length;f<e;f++){var n=l[f];if(g=n.scopeId.value)if(g instanceof L){var m=g;this.setTexture(m,p);n.slot!==p&&(c.uniform1i(n.locationId,p),n.slot=p);p++}else{n.array.length=0;var q=g.length;for(d=0;d<q;d++)m=g[d],this.setTexture(m,p),n.array[d]=p,p++;c.uniform1iv(n.locationId,n.array)}}f=0;for(e=h.length;f<e;f++)if(l=h[f],d=l.scopeId,n=l.version,
g=d.versionObject.version,n.globalId!==g.globalId||n.revision!==g.revision)if(n.globalId=g.globalId,n.revision=g.revision,null!==d.value)this.commitFunction[l.dataType](l,d.value);this.webgl2&&this.transformFeedbackBuffer&&(c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),c.beginTransformFeedback(c.POINTS));f=this.glPrimitive[a.type];e=a.count;a.indexed?(l=this.indexBuffer,h=l.glFormat,a=a.base*l.bytesPerIndex,0<b?c.drawElementsInstanced(f,e,h,a,b):c.drawElements(f,
e,h,a)):(a=a.base,0<b?c.drawArraysInstanced(f,a,e,b):c.drawArrays(f,a,e));this.webgl2&&this.transformFeedbackBuffer&&(c.endTransformFeedback(),c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,null))},clear:function(a){var b=this.defaultClearOptions;a=a||b;var c=void 0==a.flags?b.flags:a.flags;if(0!==c){var d=this.gl;if(c&1){var e=void 0==a.color?b.color:a.color;this.setClearColor(e[0],e[1],e[2],e[3])}c&2&&(this.setClearDepth(void 0==a.depth?b.depth:a.depth),this.depthWrite||d.depthMask(!0));c&4&&this.setClearStencil(void 0==
a.stencil?b.stencil:a.stencil);d.clear(this.glClearFlag[c]);c&2&&(this.depthWrite||d.depthMask(!1))}},readPixels:function(a,b,c,d,e){var f=this.gl;f.readPixels(a,b,c,d,f.RGBA,f.UNSIGNED_BYTE,e)},setClearDepth:function(a){a!==this.clearDepth&&(this.gl.clearDepth(a),this.clearDepth=a)},setClearColor:function(a,b,c,d){if(a!==this.clearRed||b!==this.clearGreen||c!==this.clearBlue||d!==this.clearAlpha)this.gl.clearColor(a,b,c,d),this.clearRed=a,this.clearGreen=b,this.clearBlue=c,this.clearAlpha=d},setClearStencil:function(a){a!==
this.clearStencil&&(this.gl.clearStencil(a),this.clearStencil=a)},setRenderTarget:function(a){this.renderTarget=a},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(a){if(this.depthTest!==a){var b=this.gl;a?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST);this.depthTest=a}},setDepthFunc:function(a){this.depthFunc!==a&&(this.gl.depthFunc(this.glComparison[a]),this.depthFunc=a)},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(a){this.depthWrite!==
a&&(this.gl.depthMask(a),this.depthWrite=a)},setColorWrite:function(a,b,c,d){if(this.writeRed!==a||this.writeGreen!==b||this.writeBlue!==c||this.writeAlpha!==d)this.gl.colorMask(a,b,c,d),this.writeRed=a,this.writeGreen=b,this.writeBlue=c,this.writeAlpha=d},setAlphaToCoverage:function(a){this.webgl2&&this.alphaToCoverage!==a&&((this.alphaToCoverage=a)?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},setTransformFeedbackBuffer:function(a){if(this.transformFeedbackBuffer!==
a&&(this.transformFeedbackBuffer=a,this.webgl2)){var b=this.gl;a?(this.feedback||(this.feedback=b.createTransformFeedback()),b.bindTransformFeedback(b.TRANSFORM_FEEDBACK,this.feedback)):b.bindTransformFeedback(b.TRANSFORM_FEEDBACK,null)}},setRaster:function(a){this.raster!==a&&(this.raster=a,this.webgl2&&(a?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},setDepthBias:function(a){this.depthBiasEnabled!==a&&((this.depthBiasEnabled=a)?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):
this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},setDepthBiasValues:function(a,b){this.gl.polygonOffset(b,a)},getBlending:function(){return this.blending},setBlending:function(a){if(this.blending!==a){var b=this.gl;a?b.enable(b.BLEND):b.disable(b.BLEND);this.blending=a}},setStencilTest:function(a){if(this.stencil!==a){var b=this.gl;a?b.enable(b.STENCIL_TEST):b.disable(b.STENCIL_TEST);this.stencil=a}},setStencilFunc:function(a,b,c){if(this.stencilFuncFront!==a||this.stencilRefFront!==b||this.stencilMaskFront!==
c||this.stencilFuncBack!==a||this.stencilRefBack!==b||this.stencilMaskBack!==c)this.gl.stencilFunc(this.glComparison[a],b,c),this.stencilFuncFront=this.stencilFuncBack=a,this.stencilRefFront=this.stencilRefBack=b,this.stencilMaskFront=this.stencilMaskBack=c},setStencilFuncFront:function(a,b,c){if(this.stencilFuncFront!==a||this.stencilRefFront!==b||this.stencilMaskFront!==c){var d=this.gl;d.stencilFuncSeparate(d.FRONT,this.glComparison[a],b,c);this.stencilFuncFront=a;this.stencilRefFront=b;this.stencilMaskFront=
c}},setStencilFuncBack:function(a,b,c){if(this.stencilFuncBack!==a||this.stencilRefBack!==b||this.stencilMaskBack!==c){var d=this.gl;d.stencilFuncSeparate(d.BACK,this.glComparison[a],b,c);this.stencilFuncBack=a;this.stencilRefBack=b;this.stencilMaskBack=c}},setStencilOperation:function(a,b,c,d){if(this.stencilFailFront!==a||this.stencilZfailFront!==b||this.stencilZpassFront!==c||this.stencilFailBack!==a||this.stencilZfailBack!==b||this.stencilZpassBack!==c)this.gl.stencilOp(this.glStencilOp[a],this.glStencilOp[b],
this.glStencilOp[c]),this.stencilFailFront=this.stencilFailBack=a,this.stencilZfailFront=this.stencilZfailBack=b,this.stencilZpassFront=this.stencilZpassBack=c;if(this.stencilWriteMaskFront!==d||this.stencilWriteMaskBack!==d)this.gl.stencilMask(d),this.stencilWriteMaskBack=this.stencilWriteMaskFront=d},setStencilOperationFront:function(a,b,c,d){if(this.stencilFailFront!==a||this.stencilZfailFront!==b||this.stencilZpassFront!==c)this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[a],this.glStencilOp[b],
this.glStencilOp[c]),this.stencilFailFront=a,this.stencilZfailFront=b,this.stencilZpassFront=c;this.stencilWriteMaskFront!==d&&(this.gl.stencilMaskSeparate(this.gl.FRONT,d),this.stencilWriteMaskFront=d)},setStencilOperationBack:function(a,b,c,d){if(this.stencilFailBack!==a||this.stencilZfailBack!==b||this.stencilZpassBack!==c)this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[a],this.glStencilOp[b],this.glStencilOp[c]),this.stencilFailBack=a,this.stencilZfailBack=b,this.stencilZpassBack=c;this.stencilWriteMaskBack!==
d&&(this.gl.stencilMaskSeparate(this.gl.BACK,d),this.stencilWriteMaskBack=d)},setBlendFunction:function(a,b){if(this.blendSrc!==a||this.blendDst!==b||this.separateAlphaBlend)this.gl.blendFunc(this.glBlendFunction[a],this.glBlendFunction[b]),this.blendSrc=a,this.blendDst=b,this.separateAlphaBlend=!1},setBlendFunctionSeparate:function(a,b,c,d){this.blendSrc===a&&this.blendDst===b&&this.blendSrcAlpha===c&&this.blendDstAlpha===d&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[a],
this.glBlendFunction[b],this.glBlendFunction[c],this.glBlendFunction[d]),this.blendSrc=a,this.blendDst=b,this.blendSrcAlpha=c,this.blendDstAlpha=d,this.separateAlphaBlend=!0)},setBlendEquation:function(a){if(this.blendEquation!==a||this.separateAlphaEquation)this.gl.blendEquation(this.glBlendEquation[a]),this.blendEquation=a,this.separateAlphaEquation=!1},setBlendEquationSeparate:function(a,b){this.blendEquation===a&&this.blendAlphaEquation===b&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[a],
this.glBlendEquation[b]),this.blendEquation=a,this.blendAlphaEquation=b,this.separateAlphaEquation=!0)},setCullMode:function(a){if(this.cullMode!==a){if(0===a)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);var b=this.glCull[a];this.cullFace!==b&&(this.gl.cullFace(b),this.cullFace=b)}this.cullMode=a}},getCullMode:function(){return this.cullMode},setIndexBuffer:function(a){this.indexBuffer=a},setVertexBuffer:function(a,b,c){if(this.vertexBuffers[b]!==a||
this.vbOffsets[b]!==c){this.vertexBuffers[b]=a;this.vbOffsets[b]=c;if(a){c=0;a=a.getFormat().elements;for(var d=a.length;c<d;){var e=a[c++];e.stream=b;e.scopeId.setValue(e)}}this.attributesInvalidated=!0}},disableVertexBufferElements:function(a){for(var b=0;b<a.length;b++){var c=this.scope.resolve(a[b]);c.value&&(this.attributesInvalidated=!0,c.setValue(null))}},compileShaderSource:function(a,b){var c=this.gl,d=b?this.vertexShaderCache[a]:this.fragmentShaderCache[a];d||(d=c.createShader(b?c.VERTEX_SHADER:
c.FRAGMENT_SHADER),c.shaderSource(d,a),c.compileShader(d),b?this.vertexShaderCache[a]=d:this.fragmentShaderCache[a]=d);return d},compileAndLinkShader:function(a){var b=this.gl,c=a.definition,d=this.compileShaderSource(c.vshader,!0),e=this.compileShaderSource(c.fshader,!1),f=b.createProgram();b.attachShader(f,d);b.attachShader(f,e);if(this.webgl2&&c.useTransformFeedback){c=c.attributes;var k=[],l;for(l in c)c.hasOwnProperty(l)&&k.push("out_"+l);b.transformFeedbackVaryings(f,k,b.INTERLEAVED_ATTRIBS)}b.linkProgram(f);
a._glVertexShader=d;a._glFragmentShader=e;a._glProgram=f},createShader:function(a){this.compileAndLinkShader(a);this.shaders.push(a)},destroyShader:function(a){var b=this.shaders.indexOf(a);-1!==b&&this.shaders.splice(b,1);a._glProgram&&(this.gl.deleteProgram(a._glProgram),a._glProgram=null,this.removeShaderFromCache(a))},_addLineNumbers:function(a){a=a.split("\n");for(var b=0,c=a.length;b<c;b++)a[b]=b+1+":\t"+a[b];return a.join("\n")},postLink:function(a){var b=this.gl,c=a._glVertexShader,d=a._glFragmentShader,
e=a._glProgram,f=a.definition;if(!b.getShaderParameter(c,b.COMPILE_STATUS))return console.error("Failed to compile vertex shader:\n\n"+this._addLineNumbers(f.vshader)+"\n\n"+b.getShaderInfoLog(c)),!1;if(!b.getShaderParameter(d,b.COMPILE_STATUS))return console.error("Failed to compile fragment shader:\n\n"+this._addLineNumbers(f.fshader)+"\n\n"+b.getShaderInfoLog(d)),!1;if(!b.getProgramParameter(e,b.LINK_STATUS))return console.error("Failed to link shader program. Error: "+b.getProgramInfoLog(e)),
!1;c=0;for(var k=b.getProgramParameter(e,b.ACTIVE_ATTRIBUTES);c<k;){d=b.getActiveAttrib(e,c++);var l=b.getAttribLocation(e,d.name);void 0===f.attributes[d.name]&&console.error('Vertex shader attribute "'+d.name+'" is not mapped to a semantic in shader definition.');l=new Di(this,f.attributes[d.name],this.pcUniformType[d.type],l);a.attributes.push(l)}c=0;for(f=b.getProgramParameter(e,b.ACTIVE_UNIFORMS);c<f;)d=b.getActiveUniform(e,c++),l=b.getUniformLocation(e,d.name),l=new Di(this,d.name,this.pcUniformType[d.type],
l),d.type===b.SAMPLER_2D||d.type===b.SAMPLER_CUBE||this.webgl2&&(d.type===b.SAMPLER_2D_SHADOW||d.type===b.SAMPLER_CUBE_SHADOW||d.type===b.SAMPLER_3D)?a.samplers.push(l):a.uniforms.push(l);return a.ready=!0},setShader:function(a){if(a!==this.shader){if(!a.ready&&!this.postLink(a))return!1;this.shader=a;this.gl.useProgram(a._glProgram);this.attributesInvalidated=!0}return!0},getHdrFormat:function(){return this.textureHalfFloatRenderable?11:this.textureFloatRenderable?13:7},getBoneLimit:function(){return this.boneLimit},
setBoneLimit:function(a){this.boneLimit=a},resizeCanvas:function(a,b){this._width=a;this._height=b;var c=Math.min(this._maxPixelRatio,window.devicePixelRatio);a*=c;b*=c;if(this.canvas.width!==a||this.canvas.height!==b)this.canvas.width=a,this.canvas.height=b,this.fire("resizecanvas",a,b)},setResolution:function(a,b){this._width=a;this._height=b;this.canvas.width=a;this.canvas.height=b;this.fire("resizecanvas",a,b)},clearShaderCache:function(){var a=this.gl,b;for(b in this.fragmentShaderCache)a.deleteShader(this.fragmentShaderCache[b]),
delete this.fragmentShaderCache[b];for(b in this.vertexShaderCache)a.deleteShader(this.vertexShaderCache[b]),delete this.vertexShaderCache[b];this.programLib.clearCache()},removeShaderFromCache:function(a){this.programLib.removeFromCache(a)},destroy:function(){var a=this.gl;this.destroyGrabPass();this.webgl2&&this.feedback&&a.deleteTransformFeedback(this.feedback);this.clearShaderCache();this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1);this.canvas.removeEventListener("webglcontextrestored",
this._contextRestoredHandler,!1);this.gl=this.canvas=this._contextRestoredHandler=this._contextLostHandler=null}});Object.defineProperty(kb.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}});Object.defineProperty(kb.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}});Object.defineProperty(kb.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(a){a?this.gl.canvas.requestFullscreen():
document.exitFullscreen()}});Object.defineProperty(kb.prototype,"enableAutoInstancing",{get:function(){return this._enableAutoInstancing},set:function(a){this._enableAutoInstancing=a&&this.extInstancing}});Object.defineProperty(kb.prototype,"maxPixelRatio",{get:function(){return this._maxPixelRatio},set:function(a){this._maxPixelRatio=a;this.resizeCanvas(this._width,this._height)}});Object.defineProperty(kb.prototype,"textureFloatHighPrecision",{get:function(){if(void 0===this._textureFloatHighPrecision){if(this.textureFloatRenderable){var a=
K;var b=a.createShaderFromCode(this,a.fullscreenQuadVS,a.precisionTestPS,"ptest1"),c=a.createShaderFromCode(this,a.fullscreenQuadVS,a.precisionTest2PS,"ptest2"),d={format:14,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0};a=new L(this,d);a.name="testFHP";var e=new oa(this,a,{depth:!1});La(this,e,b);d.format=7;b=new L(this,d);b.name="testFHP";d=new oa(this,b,{depth:!1});this.constantTexSource.setValue(a);La(this,d,c);c=this.activeFramebuffer;this.setFramebuffer(d._glFrameBuffer);var f=new Uint8Array(4);
this.readPixels(0,0,1,1,f);this.setFramebuffer(c);c=f[0]/255/16777216+f[1]/255/65536+f[2]/255/256+f[3]/255;a.destroy();e.destroy();b.destroy();d.destroy();a=0===c}else a=!1;this._textureFloatHighPrecision=a}return this._textureFloatHighPrecision}});var Xo={depth:!0,face:0},oa=function(a,b,c){a instanceof kb?(this._colorBuffer=b,a=c):this._colorBuffer=a.colorBuffer;this._glDepthBuffer=this._glFrameBuffer=null;a=void 0!==a?a:Xo;this._depthBuffer=a.depthBuffer;this._face=void 0!==a.face?a.face:0;this._depthBuffer?
(b=this._depthBuffer._format,16===b?(this._depth=!0,this._stencil=!1):this._stencil=17===b?this._depth=!0:this._depth=!1):(this._depth=void 0!==a.depth?a.depth:!0,this._stencil=void 0!==a.stencil?a.stencil:!1);this._samples=void 0!==a.samples?a.samples:1;this.autoResolve=void 0!==a.autoResolve?a.autoResolve:!0;this._glMsaaDepthBuffer=this._glMsaaColorBuffer=this._glResolveFrameBuffer=null};Object.assign(oa.prototype,{destroy:function(){if(this._device){var a=this._device,b=a.targets.indexOf(this);
-1!==b&&a.targets.splice(b,1);a=a.gl;this._glFrameBuffer&&(a.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null);this._glDepthBuffer&&(a.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null);this._glResolveFrameBuffer&&(a.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null);this._glMsaaColorBuffer&&(a.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null);this._glMsaaDepthBuffer&&(a.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=
null)}},resolve:function(a,b){if(this._device&&this._device.webgl2){var c=this._device.gl;void 0===a&&(a=!0);void 0===b&&this._depthBuffer&&(b=!0);c.bindFramebuffer(c.READ_FRAMEBUFFER,this._glFrameBuffer);c.bindFramebuffer(c.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer);c.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(a?c.COLOR_BUFFER_BIT:0)|(b?c.DEPTH_BUFFER_BIT:0),c.NEAREST);c.bindFramebuffer(c.FRAMEBUFFER,this._glFrameBuffer)}},copy:function(a,b,c){if(!this._device)if(a._device)this._device=
a._device;else return!1;return this._device.copyRenderTarget(a,this,b,c)}});Object.defineProperty(oa.prototype,"colorBuffer",{get:function(){return this._colorBuffer}});Object.defineProperty(oa.prototype,"depthBuffer",{get:function(){return this._depthBuffer}});Object.defineProperty(oa.prototype,"face",{get:function(){return this._face}});Object.defineProperty(oa.prototype,"width",{get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}});Object.defineProperty(oa.prototype,
"height",{get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}});var In={type:5,base:0,count:4,indexed:!1};Object.assign(Ei.prototype,{render:function(a,b,c){}});cf.createShader=function(a,b,c){return K.createShaderFromCode(a,b,null,c,!0)};Object.assign(cf.prototype,{destroy:function(){this._outputBuffer.destroy()},process:function(a,b){void 0===b&&(b=!0);var c=this.device;c.setRenderTarget(null);c.updateBegin();c.setVertexBuffer(this._inputBuffer,0);c.setRaster(!1);
c.setTransformFeedbackBuffer(this._outputBuffer);c.setShader(a);c.draw({type:0,base:0,count:this._inputBuffer.numVertices,indexed:!1});c.setTransformFeedbackBuffer(null);c.setRaster(!0);c.updateEnd();b&&(a=this._inputBuffer.bufferId,this._inputBuffer.bufferId=this._outputBuffer.bufferId,this._outputBuffer.bufferId=a)}});Object.defineProperty(cf.prototype,"inputBuffer",{get:function(){return this._inputBuffer}});Object.defineProperty(cf.prototype,"outputBuffer",{get:function(){return this._outputBuffer}});
Ad.prototype=Object.create(da.prototype);Ad.prototype.constructor=Ad;Object.assign(Ad.prototype,{clone:function(){var a=new Ad;da.prototype._cloneInternal.call(this,a);return a},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("depth",b)}});Uc.prototype.getSelection=function(a,b,c,d){var e=this.device;"object"===typeof a?(d=a,a=d.x,b=d.y,c=d.width,d=d.height):b=this.layer.renderTarget.height-(b+(d||1));c=c||1;d=d||1;var f=e.renderTarget;
e.setRenderTarget(this.layer.renderTarget);e.updateBegin();var k=new Uint8Array(4*c*d);e.readPixels(a,b,c,d,k);e.updateEnd();e.setRenderTarget(f);a=[];b=this.layer.instances.visibleOpaque[0].list;for(e=0;e<c*d;e++){f=k[4*e];var l=k[4*e+1];var h=k[4*e+2];f=f<<16|l<<8|h;16777215!==f&&(f=b[f],-1===a.indexOf(f)&&a.push(f))}return a};Uc.prototype.prepare=function(a,b,c){var d=this.device,e=this;a instanceof Pa&&(a=a._component);this.scene=b;var f=null,k=null;c instanceof fa?f=c:k=c;if(!this.layer){var l=
d.scope.resolve("uColor");this.layer=new fa({name:"Picker",shaderPass:18,opaqueSortMode:0,onEnable:function(){if(!this.renderTarget){var a=new L(d,{format:7,width:e.width,height:e.height});a.name="pick";a.minFilter=0;a.magFilter=0;a.addressU=1;a.addressV=1;this.renderTarget=new oa(d,a,{depth:!0})}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onDrawCall:function(a,b){e.pickColor[0]=(b>>16&255)/255;e.pickColor[1]=
(b>>8&255)/255;e.pickColor[2]=(b&255)/255;l.setValue(e.pickColor);d.setBlending(!1)}});this.layerComp=new pa;this.layerComp.pushOpaque(this.layer);this.meshInstances=this.layer.opaqueMeshInstances;this._instancesVersion=-1}if(!f){this.layer.clearMeshInstances();c=b.layers.layerList;var h=b.layers.subLayerEnabled,p=b.layers.subLayerList;for(b=0;b<c.length;b++)c[b].overrideClear&&c[b]._clearDepthBuffer&&(c[b]._pickerCleared=!1);for(b=0;b<c.length;b++){var n=c[b];if(n.renderTarget===k&&n.enabled&&h[b]){var m=
n.cameras.indexOf(a);if(!(0>m)){n.overrideClear&&n._clearDepthBuffer&&!n._pickerCleared&&(this.meshInstances.push(this.clearDepthCommand),n._pickerCleared=!0);m=(m=p[b])?n.instances.transparentMeshInstances:n.instances.opaqueMeshInstances;var q=m.length;for(n=0;n<q;n++){var r=m[n];r.pick&&this.meshInstances.push(r)}}}}}else if(this._instancesVersion!==f._version){this.layer.clearMeshInstances();m=f.instances.opaqueMeshInstances;q=m.length;for(n=0;n<q;n++)r=m[n],r.pick&&this.meshInstances.push(r);
m=f.instances.transparentMeshInstances;q=m.length;for(n=0;n<q;n++)r=m[n],r.pick&&this.meshInstances.push(r);this._instancesVersion=f._version}this.layer.cameras[0]!==a&&(this.layer.clearCameras(),this.layer.addCamera(a));this.onLayerPreRender(this.layer,f,k);this.app.renderer.renderComposition(this.layerComp);this.onLayerPostRender(this.layer)};Uc.prototype.onLayerPreRender=function(a,b,c){if(this.width!==a.renderTarget.width||this.height!==a.renderTarget.height)a.onDisable(),a.onEnable();a.oldClear=
a.cameras[0].camera._clearOptions;a.oldAspectMode=a.cameras[0].aspectRatioMode;a.oldAspect=a.cameras[0].aspectRatio;a.cameras[0].camera._clearOptions=this.clearOptions;a.cameras[0].aspectRatioMode=1;a.cameras[0].aspectRatio=a.cameras[0].calculateAspectRatio(c?c:b?b.renderTarget:null);this.app.renderer.updateCameraFrustum(a.cameras[0].camera)};Uc.prototype.onLayerPostRender=function(a){a.cameras[0].camera._clearOptions=a.oldClear;a.cameras[0].aspectRatioMode=a.oldAspectMode;a.cameras[0].aspectRatio=
a.oldAspect};Uc.prototype.resize=function(a,b){this.width=a;this.height=b};Object.defineProperty(Uc.prototype,"renderTarget",{get:function(){return this.layer.renderTarget}});var Ln=function(){try{if("object"===typeof WebAssembly&&"function"===typeof WebAssembly.instantiate){var a=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(a instanceof WebAssembly.Module)return new WebAssembly.Instance(a)instanceof WebAssembly.Instance}}catch(b){}return!1}(),Ii=!1,ef=null,df={},Fi=null,Hi=[];Object.assign(Rk.prototype,
{load:function(a,b,c){throw Error("not implemented");},open:function(a,b,c){throw Error("not implemented");},patch:function(a,b){}});var rg=new Ji,Yo={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};ab.prototype=Object.create(H.prototype);ab.prototype.constructor=ab;ab.prototype.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("keydown",this._keyDownHandler,!1);this._element.addEventListener("keypress",
this._keyPressHandler,!1);this._element.addEventListener("keyup",this._keyUpHandler,!1)};ab.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler);this._element.removeEventListener("keypress",this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};ab.prototype.toKeyIdentifier=function(a){a=sg(a);var b;if(b=Yo[a.toString()])return b;b=a.toString(16).toUpperCase();var c=b.length;for(a=0;a<4-c;a++)b="0"+b;return"U+"+
b};ab.prototype._handleKeyDown=function(a){var b=a.keyCode||a.charCode;void 0!==b&&(b=this.toKeyIdentifier(b),this._keymap[b]=!0,this.fire("keydown",Ki(a)),this.preventDefault&&a.preventDefault(),this.stopPropagation&&a.stopPropagation())};ab.prototype._handleKeyUp=function(a){var b=a.keyCode||a.charCode;void 0!==b&&(b=this.toKeyIdentifier(b),delete this._keymap[b],this.fire("keyup",Ki(a)),this.preventDefault&&a.preventDefault(),this.stopPropagation&&a.stopPropagation())};ab.prototype._handleKeyPress=
function(a){this.fire("keypress",Ki(a));this.preventDefault&&a.preventDefault();this.stopPropagation&&a.stopPropagation()};ab.prototype.update=function(){for(var a in this._lastmap)delete this._lastmap[a];for(a in this._keymap)this._keymap.hasOwnProperty(a)&&(this._lastmap[a]=this._keymap[a])};ab.prototype.isPressed=function(a){a=sg(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]};ab.prototype.wasPressed=function(a){a=sg(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]&&!this._lastmap[a]};
ab.prototype.wasReleased=function(a){a=sg(a);a=this.toKeyIdentifier(a);return!this._keymap[a]&&!!this._lastmap[a]};yb.prototype=Object.create(H.prototype);yb.prototype.constructor=yb;yb.isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)};Object.assign(yb.prototype,{attach:function(a){this._target=a;this._attached||(this._attached=!0,a=va.passiveEvents?{passive:!1}:!1,window.addEventListener("mouseup",this._upHandler,
a),window.addEventListener("mousedown",this._downHandler,a),window.addEventListener("mousemove",this._moveHandler,a),window.addEventListener("wheel",this._wheelHandler,a))},detach:function(){if(this._attached){this._attached=!1;this._target=null;var a=va.passiveEvents?{passive:!1}:!1;window.removeEventListener("mouseup",this._upHandler,a);window.removeEventListener("mousedown",this._downHandler,a);window.removeEventListener("mousemove",this._moveHandler,a);window.removeEventListener("wheel",this._wheelHandler,
a)}},disableContextMenu:function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(a,b){if(document.body.requestPointerLock){var c=function(){a();document.removeEventListener("pointerlockchange",c)},d=function(){b();document.removeEventListener("pointerlockerror",d)};a&&document.addEventListener("pointerlockchange",c,!1);
b&&document.addEventListener("pointerlockerror",d,!1);document.body.requestPointerLock()}else b&&b()},disablePointerLock:function(a){if(document.exitPointerLock){var b=function(){a();document.removeEventListener("pointerlockchange",b)};a&&document.addEventListener("pointerlockchange",b,!1);document.exitPointerLock()}},update:function(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]},isPressed:function(a){return this._buttons[a]},wasPressed:function(a){return this._buttons[a]&&
!this._lastbuttons[a]},wasReleased:function(a){return!this._buttons[a]&&this._lastbuttons[a]},_handleUp:function(a){this._buttons[a.button]=!1;a=new Vc(this,a);a.event&&this.fire("mouseup",a)},_handleDown:function(a){this._buttons[a.button]=!0;a=new Vc(this,a);a.event&&this.fire("mousedown",a)},_handleMove:function(a){a=new Vc(this,a);a.event&&(this.fire("mousemove",a),this._lastX=a.x,this._lastY=a.y)},_handleWheel:function(a){a=new Vc(this,a);a.event&&this.fire("mousewheel",a)},_getTargetCoords:function(a){var b=
this._target.getBoundingClientRect(),c=Math.floor(b.left);b=Math.floor(b.top);return a.clientX<c||a.clientX>=c+this._target.clientWidth||a.clientY<b||a.clientY>=b+this._target.clientHeight?null:{x:a.clientX-c,y:a.clientY-b}}});bb.prototype.attach=function(a){this._element=a;this._keyboard&&this._keyboard.attach(a);this._mouse&&this._mouse.attach(a)};bb.prototype.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};bb.prototype.disableContextMenu=
function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};bb.prototype.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};bb.prototype.update=function(a){this._keyboard&&this._keyboard.update(a);this._mouse&&this._mouse.update(a);this._gamepads&&this._gamepads.update(a);this._axesValues={};for(var b in this._axes)this._axesValues[b]=[]};bb.prototype.registerKeys=function(a,b){this._keyboard||this._enableKeyboard();if(this._actions[a])throw Error("Action: "+
a+" already registered");if(void 0===b)throw Error("Invalid button");b.length||(b=[b]);this._actions[a]?this._actions[a].push({type:"keyboard",keys:b}):this._actions[a]=[{type:"keyboard",keys:b}]};bb.prototype.registerMouse=function(a,b){this._mouse||this._enableMouse();if(void 0===b)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:"mouse",button:b}):this._actions[a]=[{type:"mouse",button:-b}]};bb.prototype.registerPadButton=function(a,b,c){if(void 0===c)throw Error("Invalid button");
this._actions[a]?this._actions[a].push({type:"gamepad",button:c,pad:b}):this._actions[a]=[{type:"gamepad",button:c,pad:b}]};bb.prototype.registerAxis=function(a){var b=a.name;this._axes[b]||(this._axes[b]=[]);var c=this._axes[b].push(b);a=a||{};a.pad=a.pad||0;var d=function(d,f,k,l){switch(f){case "mousex":d._mouse.on("mousemove",function(a){d._axesValues[b][c]=a.dx/10});break;case "mousey":d._mouse.on("mousemove",function(a){d._axesValues[b][c]=a.dy/10});break;case "key":d._axes[b].push(function(){return d._keyboard.isPressed(l)?
k:0});break;case "padrx":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,2)});break;case "padry":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,3)});break;case "padlx":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,0)});break;case "padly":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,1)});break;default:throw Error("Unknown axis");}};d(this,a.positive,1,a.positiveKey);(a.negativeKey||a.negative!==a.positive)&&d(this,a.negative,-1,a.negativeKey)};
bb.prototype.isPressed=function(a){if(!this._actions[a])return!1;var b,c=this._actions[a].length;for(b=0;b<c;++b){var d=this._actions[a][b];switch(d.type){case "keyboard":if(this._keyboard){var e,f=d.keys.length;for(e=0;e<f;e++)if(this._keyboard.isPressed(d.keys[e]))return!0}break;case "mouse":if(this._mouse&&this._mouse.isPressed(d.button))return!0;break;case "gamepad":if(this._gamepads&&this._gamepads.isPressed(d.pad,d.button))return!0}}return!1};bb.prototype.wasPressed=function(a){if(!this._actions[a])return!1;
var b,c=this._actions[a].length;for(b=0;b<c;++b){var d=this._actions[a][b];switch(d.type){case "keyboard":if(this._keyboard){var e,f=d.keys.length;for(e=0;e<f;e++)if(this._keyboard.wasPressed(d.keys[e]))return!0}break;case "mouse":if(this._mouse&&this._mouse.wasPressed(d.button))return!0;break;case "gamepad":if(this._gamepads&&this._gamepads.wasPressed(d.pad,d.button))return!0}}return!1};bb.prototype.getAxis=function(a){var b=0;if(this._axes[a]){var c,d=this._axes[a].length;for(c=0;c<d;c++)if("function"===
za(this._axes[a][c])){var e=this._axes[a][c]();Math.abs(e)>Math.abs(b)&&(b=e)}else this._axesValues[a]&&Math.abs(this._axesValues[a][c])>Math.abs(b)&&(b=this._axesValues[a][c])}return b};bb.prototype._enableMouse=function(){this._mouse=new yb;if(!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element)};bb.prototype._enableKeyboard=function(){this._keyboard=new ab;if(!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element)};
var Qb,ed,pm=new r,qm=new r,fd=new Hc,rm=new Hc,Bj=new Hc;fd.end=new r;rm.end=new r;Bj.end=new r;var qe=new r,tg=new r,Li=new r,Sk=new r,Mi=new r,ug=new r,Tk=new r,Cj=new M,If=new r,hh=new r,ih=new r,Jf=new r,sm=new r,tm=new r,um=new r,vm=new r,Zo=new U;Object.assign(Wc.prototype,{stopPropagation:function(){this._stopPropagation=!0;this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}});Xc.prototype=Object.create(Wc.prototype);Xc.prototype.constructor=Xc;xc.prototype=Object.create(Wc.prototype);
xc.prototype.constructor=xc;Yb.prototype=Object.create(Wc.prototype);Yb.prototype.constructor=Yb;Object.assign(ff.prototype,{attach:function(a){this._attached&&(this._attached=!1,this.detach());this._target=a;this._attached=!0;a=va.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.addEventListener("mouseup",this._upHandler,a),window.addEventListener("mousedown",this._downHandler,a),window.addEventListener("mousemove",this._moveHandler,a),window.addEventListener("wheel",this._wheelHandler,a));
this._useTouch&&va.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,a),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1));this.attachSelectEvents()},attachSelectEvents:function(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),
this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))},detach:function(){if(this._attached){this._attached=!1;var a=va.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,a),window.removeEventListener("mousedown",this._downHandler,a),window.removeEventListener("mousemove",this._moveHandler,a),window.removeEventListener("wheel",this._wheelHandler,a));this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,
a),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1));this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",
this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this));this._target=null}},addElement:function(a){-1===this._elements.indexOf(a)&&this._elements.push(a)},removeElement:function(a){a=this._elements.indexOf(a);-1!==a&&this._elements.splice(a,1)},_handleUp:function(a){this._enabled&&!yb.isPointerLocked()&&(this._calcMouseCoords(a),null!==Qb&&this._onElementMouseEvent("mouseup",a))},_handleDown:function(a){this._enabled&&!yb.isPointerLocked()&&(this._calcMouseCoords(a),null!==
Qb&&this._onElementMouseEvent("mousedown",a))},_handleMove:function(a){this._enabled&&(this._calcMouseCoords(a),null!==Qb&&(this._onElementMouseEvent("mousemove",a),this._lastX=Qb,this._lastY=ed))},_handleWheel:function(a){this._enabled&&(this._calcMouseCoords(a),null!==Qb&&this._onElementMouseEvent("mousewheel",a))},_determineTouchedElements:function(a){var b={},c=this.app.systems.camera.cameras,d,e;for(d=c.length-1;0<=d;d--){var f=c[d],k=0;var l=0;for(e=a.changedTouches.length;l<e;l++)if(b[a.changedTouches[l].identifier])k++;
else{var h=this._calcTouchCoords(a.changedTouches[l]),p=this._getTargetElement(f,h.x,h.y);p&&(k++,b[a.changedTouches[l].identifier]={element:p,camera:f,x:h.x,y:h.y})}if(k===e)break}return b},_handleTouchStart:function(a){if(this._enabled){for(var b=this._determineTouchedElements(a),c=0,d=a.changedTouches.length;c<d;c++){var e=a.changedTouches[c],f=b[e.identifier],k=this._touchedElements[e.identifier];!f||k&&f.element===k.element||(this._fireEvent(a.type,new xc(a,f.element,f.camera,f.x,f.y,e)),this._touchesForWhichTouchLeaveHasFired[e.identifier]=
!1)}for(var l in b)this._touchedElements[l]=b[l]}},_handleTouchEnd:function(a){if(this._enabled){var b=this.app.systems.camera.cameras;for(c in this._clickedEntities)delete this._clickedEntities[c];var c=0;for(var d=a.changedTouches.length;c<d;c++){var e=a.changedTouches[c],f=this._touchedElements[e.identifier];if(f){var k=f.element,l=f.camera,h=f.x;f=f.y;delete this._touchedElements[e.identifier];delete this._touchesForWhichTouchLeaveHasFired[e.identifier];this._fireEvent(a.type,new xc(a,k,l,h,f,
e));if(0===a.touches.length)for(var p=this._calcTouchCoords(e),n=b.length-1;0<=n;n--)this._getTargetElement(b[n],p.x,p.y)!==k||this._clickedEntities[k.entity.getGuid()]||(this._fireEvent("click",new xc(a,k,l,h,f,e)),this._clickedEntities[k.entity.getGuid()]=!0)}}}},_handleTouchMove:function(a){a.preventDefault();if(this._enabled)for(var b=this._determineTouchedElements(a),c=0,d=a.changedTouches.length;c<d;c++){var e=a.changedTouches[c],f=b[e.identifier],k=this._touchedElements[e.identifier];if(k){var l=
this._calcTouchCoords(e);f&&f.element===k.element||this._touchesForWhichTouchLeaveHasFired[e.identifier]||(this._fireEvent("touchleave",new xc(a,k.element,k.camera,l.x,l.y,e)),this._touchesForWhichTouchLeaveHasFired[e.identifier]=!0);this._fireEvent("touchmove",new xc(a,k.element,k.camera,l.x,l.y,e))}}},_onElementMouseEvent:function(a,b){var c,d=this._hoveredElement;this._hoveredElement=null;for(var e=this.app.systems.camera.cameras,f,k=e.length-1;0<=k&&!(f=e[k],c=this._getTargetElement(f,Qb,ed));k--);
c&&(this._fireEvent(a,new Xc(b,c,f,Qb,ed,this._lastX,this._lastY)),this._hoveredElement=c,"mousedown"===a&&(this._pressedElement=c));d!==this._hoveredElement&&(d&&this._fireEvent("mouseleave",new Xc(b,d,f,Qb,ed,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new Xc(b,this._hoveredElement,f,Qb,ed,this._lastX,this._lastY)));"mouseup"===a&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||
this._fireEvent("click",new Xc(b,this._hoveredElement,f,Qb,ed,this._lastX,this._lastY))):this._pressedElement=null)},_onXrStart:function(){this.app.xr.on("end",this._onXrEnd,this);this.app.xr.on("update",this._onXrUpdate,this);this.app.xr.input.on("selectstart",this._onSelectStart,this);this.app.xr.input.on("selectend",this._onSelectEnd,this);this.app.xr.input.on("remove",this._onXrInputRemove,this)},_onXrEnd:function(){this.app.xr.off("update",this._onXrUpdate,this);this.app.xr.input.off("selectstart",
this._onSelectStart,this);this.app.xr.input.off("selectend",this._onSelectEnd,this);this.app.xr.input.off("remove",this._onXrInputRemove,this)},_onXrUpdate:function(){if(this._enabled)for(var a=this.app.xr.input.inputSources,b=0;b<a.length;b++)this._onElementSelectEvent("selectmove",a[b],null)},_onXrInputRemove:function(a){var b=this._selectedElements[a.id];b&&(a._elementEntity=null,this._fireEvent("selectleave",new Yb(null,b,null,a)));delete this._selectedElements[a.id];delete this._selectedPressedElements[a.id]},
_onSelectStart:function(a,b){this._enabled&&this._onElementSelectEvent("selectstart",a,b)},_onSelectEnd:function(a,b){this._enabled&&this._onElementSelectEvent("selectend",a,b)},_onElementSelectEvent:function(a,b,c){var d,e=this._selectedElements[b.id],f=this.app.systems.camera.cameras;if(b.elementInput){Bj.set(b.getOrigin(),b.getDirection());for(var k=f.length-1;0<=k;k--){var l=f[k];if(d=this._getTargetElementByRay(Bj,l))break}}b._elementEntity=d||null;if(d)var h=this._selectedElements[b.id]=d;else delete this._selectedElements[b.id];
e!==h&&(e&&this._fireEvent("selectleave",new Yb(c,e,l,b)),h&&this._fireEvent("selectenter",new Yb(c,h,l,b)));"selectstart"===a&&(this._selectedPressedElements[b.id]=h)&&this._fireEvent("selectstart",new Yb(c,h,l,b));d=this._selectedPressedElements[b.id];!b.elementInput&&d&&(delete this._selectedPressedElements[b.id],e&&this._fireEvent("selectend",new Yb(c,e,l,b)));"selectend"===a&&b.elementInput&&(delete this._selectedPressedElements[b.id],e&&this._fireEvent("selectend",new Yb(c,e,l,b)),d&&d===e&&
this._fireEvent("click",new Yb(c,d,l,b)))},_fireEvent:function(a,b){for(var c=b.element;;){c.fire(a,b);if(b._stopPropagation)break;if(!c.entity.parent)break;c=c.entity.parent.element;if(!c)break}},_calcMouseCoords:function(a){var b=this._target.getBoundingClientRect(),c=Math.floor(b.left);b=Math.floor(b.top);a.clientX<c||a.clientX>=c+this._target.clientWidth||a.clientY<b||a.clientY>=b+this._target.clientHeight?ed=Qb=null:(Qb=a.clientX-c,ed=a.clientY-b)},_calcTouchCoords:function(a){for(var b=0,c=
0,d=a.target;!(d instanceof HTMLElement);)d=d.parentNode;do b+=d.offsetLeft-d.scrollLeft,c+=d.offsetTop-d.scrollTop,d=d.offsetParent;while(d);return{x:a.pageX-b,y:a.pageY-c}},_sortElements:function(a,b){var c=this.app.scene.layers.sortTransparentLayers(a.layers,b.layers);return 0!==c?c:a.screen&&!b.screen?-1:!a.screen&&b.screen?1:a.screen||b.screen?a.screen.screen.screenSpace&&!b.screen.screen.screenSpace?-1:b.screen.screen.screenSpace&&!a.screen.screen.screenSpace?1:b.drawOrder-a.drawOrder:0},_getTargetElement:function(a,
b,c){var d=null;this._elements.sort(this._sortHandler);for(var e,f,k=0,l=this._elements.length;k<l;k++){var h=this._elements[k],p=!1;if(h.screen&&h.screen.screen.screenSpace){void 0===e&&(e=fd,!1===this._calculateRayScreen(b,c,a,e)&&(e=null));var n=e;p=!0}else void 0===f&&(f=rm,!1===this._calculateRay3d(b,c,a,f)&&(f=null)),n=f;if(n&&this._checkElement(n,h,p)){d=h;break}}return d},_getTargetElementByRay:function(a,b){var c=null;fd.origin.copy(a.origin);fd.direction.copy(a.direction);fd.end.copy(fd.direction).scale(2*
b.farClip).add(fd.origin);this._elements.sort(this._sortHandler);a=0;for(b=this._elements.length;a<b;a++){var d=this._elements[a];if((!d.screen||!d.screen.screen.screenSpace)&&this._checkElement(fd,d,!1)){c=d;break}}return c},_buildHitCorners:function(a,b,c,d){if(a.entity&&a.entity.button){var e=a.entity.button.hitPadding||Zo;If.copy(a.entity.up);hh.copy(If).scale(-1);Jf.copy(a.entity.right);ih.copy(Jf).scale(-1);If.scale(e.w*d);hh.scale(e.y*d);Jf.scale(e.z*c);ih.scale(e.x*c);sm.copy(b[0]).add(hh).add(ih);
tm.copy(b[1]).add(hh).add(Jf);um.copy(b[2]).add(If).add(Jf);vm.copy(b[3]).add(If).add(ih);b=[sm,tm,um,vm]}return b},_calculateScaleToScreen:function(a){var b=a.entity;a=a.screen.screen.scale;for(Cj.set(a,a);b&&!b.screen;)Cj.mul(b.getLocalScale()),b=b.parent;return Cj},_calculateRayScreen:function(a,b,c,d){var e=this.app.graphicsDevice.width,f=this.app.graphicsDevice.height,k=c.rect.z*e,l=c.rect.w*f,h=c.rect.x*e;c=(1-c.rect.y)*f;var p=c-l;a=a*e/this._target.clientWidth;b=b*f/this._target.clientHeight;
return a>=h&&a<=h+k&&b<=c&&b>=p?(d.origin.set(e*(a-h)/k,f-f*(b-p)/l,1),d.direction.set(0,0,-1),d.end.copy(d.direction).scale(2).add(d.origin),!0):!1},_calculateRay3d:function(a,b,c,d){var e=this._target.clientWidth,f=this._target.clientHeight,k=c.rect.z*e,l=c.rect.w*f,h=c.rect.x*e,p=(1-c.rect.y)*f,n=p-l,m=b;return a>=h&&a<=h+k&&b<=p&&m>=n?(a=e*(a-h)/k,m=f*(m-n)/l,c.screenToWorld(a,m,c.nearClip,pm),c.screenToWorld(a,m,c.farClip,qm),d.origin.copy(pm),d.direction.set(0,0,-1),d.end.copy(qm),!0):!1},_checkElement:function(a,
b,c){if(b.maskedBy&&!this._checkElement(a,b.maskedBy.element,c))return!1;var d=c?this._calculateScaleToScreen(b):b.entity.getWorldTransform().getScale();b=this._buildHitCorners(b,c?b.screenCorners:b.worldCorners,d.x,d.y);return Mn(a.origin,a.end,b)?!0:!1}});Object.defineProperty(ff.prototype,"enabled",{get:function(){return this._enabled},set:function(a){this._enabled=a}});Object.defineProperty(ff.prototype,"app",{get:function(){return this._app||Y.getApplication()},set:function(a){this._app=a}});
var wm={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),
axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},xm={"Product: 0268":"PS3"};Object.assign(Ni.prototype,{update:function(){var a,b;var c=0;for(b=this.current.length;c<b;c++){var d=this.current[c].pad.buttons;var e=d.length;for(a=0;a<e;a++)void 0===this.previous[c]&&(this.previous[c]=[]),this.previous[c][a]=d[a].pressed}a=this.poll();c=0;for(b=a.length;c<b;c++)this.current[c]=a[c]},poll:function(){var a=[];if(this.gamepadsSupported){var b=navigator.getGamepads?navigator.getGamepads():
navigator.webkitGetGamepads(),c,d=b.length;for(c=0;c<d;c++)b[c]&&a.push({map:this.getMap(b[c]),pad:b[c]})}return a},getMap:function(a){for(var b in xm)if(0<=a.id.indexOf(b))return wm[xm[b]];return wm.DEFAULT},isPressed:function(a,b){return this.current[a]?this.current[a].pad.buttons[pc[this.current[a].map.buttons[b]]].pressed:!1},wasPressed:function(a,b){if(!this.current[a])return!1;b=pc[this.current[a].map.buttons[b]];return this.current[a].pad.buttons[b].pressed&&!this.previous[a][b]},getAxis:function(a,
b){if(!this.current[a])return!1;a=this.current[a].pad.axes[pc[this.current[a].map.axes[b]]];Math.abs(a)<this.deadZone&&(a=0);return a}});Object.assign(Bd.prototype,{getTouchById:function(a,b){var c,d=b.length;for(c=0;c<d;c++)if(b[c].id===a)return b[c];return null}});re.prototype=Object.create(H.prototype);re.prototype.constructor=re;Object.assign(re.prototype,{attach:function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("touchstart",this._startHandler,!1);this._element.addEventListener("touchend",
this._endHandler,!1);this._element.addEventListener("touchmove",this._moveHandler,!1);this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1));this._element=null},_handleTouchStart:function(a){this.fire("touchstart",
new Bd(this,a))},_handleTouchEnd:function(a){this.fire("touchend",new Bd(this,a))},_handleTouchMove:function(a){a.preventDefault();this.fire("touchmove",new Bd(this,a))},_handleTouchCancel:function(a){this.fire("touchcancel",new Bd(this,a))}});lb.prototype=Object.create(H.prototype);lb.prototype.constructor=lb;lb.prototype.createTextures=function(a){a=this._normalizeCharsSet(a);if(a.length!==this.chars.length)this._renderAtlas(a);else for(var b=0;b<a.length;b++)if(a[b]!==this.chars[b]){this._renderAtlas(a);
break}};lb.prototype.updateTextures=function(a){a=this._normalizeCharsSet(a);for(var b=[],c=0;c<a.length;c++){var d=a[c];this.data.chars[d]||b.push(d)}0<b.length&&this._renderAtlas(this.chars.concat(b))};lb.prototype.destroy=function(){for(var a=0;a<this.textures.length;a++)this.textures[a].destroy();this.fontWeight=this.type=this.textures=this.intensity=this.glyphSize=this.fontSize=this.fontName=this.data=this.color=this.chars=null};lb.prototype._getAndClearContext=function(a,b){var c=a.width,d=
a.height;a=a.getContext("2d",{alpha:!0});a.clearRect(0,0,c,d);a.fillStyle=b;a.fillRect(0,0,c,d);return a};lb.prototype._colorToRgbString=function(a,b){var c=Math.round(255*a.r),d=Math.round(255*a.g),e=Math.round(255*a.b);return b?"rgba("+c+", "+d+", "+e+", "+a.a+")":"rgb("+c+", "+d+", "+e+")"};lb.prototype.renderCharacter=function(a,b,c,d,e){a.fillStyle=e;a.fillText(b,c,d)};lb.prototype._renderAtlas=function(a){this.chars=a;a=1;var b=this.textures[a-1].getSource(),c=b.width,d=b.height,e=this._colorToRgbString(this.color,
!1),f=this.color.a;this.color.a=1/255;var k=this._colorToRgbString(this.color,!0);this.color.a=f;f=this._getAndClearContext(b,k);f.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName;f.textAlign="center";f.textBaseline="alphabetic";this.data=this._createJson(this.chars,this.fontName,c,d);var l=dc.getSymbols(this.chars.join("")),h=this.textures.length,p=0,n=0,m={},q;for(q=0;q<l.length;q++)b=l[q],m[b]=this._getTextMetrics(b),p=Math.max(p,m[b].height),n=Math.max(n,m[b].descent);this.glyphSize=
Math.max(this.glyphSize,p);p=this.glyphSize+2*this.padding;var r=this.glyphSize+2*this.padding,t=this.glyphSize/2+this.padding,y=r-n-this.padding,w=0,v=0;for(q=0;q<l.length;q++){b=l[q];var x=dc.getCodePoint(l[q]),z=this.fontSize;f.font=this.fontWeight+" "+z.toString()+"px "+this.fontName;f.textAlign="center";f.textBaseline="alphabetic";var A=f.measureText(b).width;A>z&&(z=this.fontSize*this.fontSize/A,f.font=this.fontWeight+" "+z.toString()+"px "+this.fontName,A=this.fontSize);this.renderCharacter(f,
b,w+t,v+y,e);this._addChar(this.data,b,x,w,v,p,r,this.padding+(this.glyphSize-A)/2,-this.padding+m[b].descent-n,A,a-1,c,d);w+=p;w+p>c&&(w=0,v+=r,v+r>d&&(this.textures[a-1].upload(),a++,v=0,a>h?(b=document.createElement("canvas"),b.height=d,b.width=c,f=this._getAndClearContext(b,k),x=new L(this.app.graphicsDevice,{format:7,autoMipmap:!0}),x.name="font-atlas",x.setSource(b),x.minFilter=5,x.magFilter=1,x.addressU=1,x.addressV=1,this.textures.push(x)):(b=this.textures[a-1].getSource(),f=this._getAndClearContext(b,
k))))}this.textures[a-1].upload();if(a<h){for(q=a;q<h;q++)this.textures[q].destroy();this.textures.splice(a)}this.fire("render")};lb.prototype._createJson=function(a,b,c,d){return{version:3,intensity:this.intensity,info:{face:b,width:c,height:d,maps:[{width:c,height:d}]},chars:{}}};lb.prototype._addChar=function(a,b,c,d,e,f,k,l,h,p,n,m,q){a.info.maps.length<n+1&&a.info.maps.push({width:m,height:q});m=this.fontSize/32;a.chars[b]={id:c,letter:b,x:d,y:e,width:f,height:k,xadvance:p/m,xoffset:l/m,yoffset:(h+
this.padding)/m,scale:m,range:1,map:n,bounds:[0,0,f/m,k/m]}};lb.prototype._normalizeCharsSet=function(a){var b=this.app.systems.element.getUnicodeConverter();b&&(a=b(a));b={};a=dc.getSymbols(a);var c;for(c=0;c<a.length;c++){var d=a[c];b[d]||(b[d]=d)}return Object.keys(b).sort()};lb.prototype._getTextMetrics=function(a){var b=document.createElement("span");b.id="content-span";b.innerHTML=a;a=document.createElement("div");a.id="content-block";a.style.display="inline-block";a.style.width="1px";a.style.height=
"0px";var c=document.createElement("div");c.appendChild(b);c.appendChild(a);c.style.font=this.fontName;c.style.fontSize=this.fontSize+"px";document.body.appendChild(c);var d=-1,e=-1,f=-1;try{a.style["vertical-align"]="baseline",d=a.offsetTop-b.offsetTop,a.style["vertical-align"]="bottom",f=a.offsetTop-b.offsetTop,e=f-d}finally{document.body.removeChild(c)}return{ascent:d,descent:e,height:f}};var Ea=[null,null],Pi=null,Xk,qb=new U,gf=new Float32Array(4),Zb=[],hf=!1,Ri=!1,Qi=!1,Nn=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*;/g,
On=/\S+[ \t\n\r]*;/,Pn=/[ \t\n\r]*;/,Yn=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,Zn=/(float|int|bool|vec2|vec3|vec4|struct|,|;|\{|\})/g,$n=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,ao=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|,|;|\{|\})/g,Qn=/#version/g,Rn=/out highp vec4 pc_fragColor;/g,Sn=/#define gl_FragColor/g,Tn=/gl_FragColor/g,Un=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,
Vn=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,Wn=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,Xn=/void[ \t\n\r]+main/g;Wk.prototype.addToComposition=function(a){this.app.scene.layers.insertTransparent(this.layer,a)};var jh={write:function(a){console.log(a)},open:function(){jh.write("Powered by PlayCanvas 1.29.0 fb8f6a3")},info:function(a){console.info("INFO:\t"+a)},debug:function(a){console.debug("DEBUG:   "+a)},error:function(a){console.error("ERROR:   "+a)},warning:function(a){console.warn("WARNING: "+
a)},alert:function(a){jh.write("ALERT:   "+a);alert(a)},assert:function(a,b){!1===a&&jh.write("ASSERT:  "+b)}};dc.endsWith=function(a,b){return a.endsWith(b)};dc.startsWith=function(a,b){return a.startsWith(b)};var $o={now:zb,Timer:nh};Object.defineProperty(J.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(4));this._data[0]=this.r;this._data[1]=this.g;this._data[2]=this.b;this._data[3]=this.a;return this._data}});Object.defineProperty(J.prototype,"data3",{get:function(){this._data3||
(this._data3=new Float32Array(3));this._data3[0]=this.r;this._data3[1]=this.g;this._data3[2]=this.b;return this._data3}});O.INV_LOG2=Math.LOG2E;O.intToBytes=O.intToBytes32;O.bytesToInt=O.bytesToInt32;Object.defineProperty(M.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(2));this._data[0]=this.x;this._data[1]=this.y;return this._data}});Object.defineProperty(r.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(3));this._data[0]=this.x;this._data[1]=
this.y;this._data[2]=this.z;return this._data}});Object.defineProperty(U.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(4));this._data[0]=this.x;this._data[1]=this.y;this._data[2]=this.z;this._data[3]=this.w;return this._data}});var ap={Aabb:ia,Sphere:Pd,Plane:rh};Pd.prototype.intersectRay=Pd.prototype.intersectsRay;Si.prototype=Error.prototype;Ti.prototype=Error.prototype;var bp={ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,ADDRESS_REPEAT:0,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,
BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,
FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_COLOR:"COLOR",
SEMANTIC_TEXCOORD:"TEXCOORD",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,drawQuadWithShader:La,programlib:aa,shaderChunks:K,ContextCreationError:Ti,Device:kb,IndexBuffer:Rb,ProgramLibrary:xb,RenderTarget:oa,ScopeId:ng,Shader:Qd,ShaderInput:Di,Texture:L,UnsupportedBrowserError:Si,VertexBuffer:Za,VertexFormat:Ka,VertexIterator:Db},cp={createFullscreenQuad:Lk,
drawFullscreenQuad:Mk,PostEffect:Ei,PostEffectQueue:jg};Object.defineProperty(K,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+K.transformVS}});Object.defineProperties(L.prototype,{rgbm:{get:function(){return"rgbm"===this.type},set:function(a){this.type=a?"rgbm":"default"}},swizzleGGGR:{get:function(){return"swizzleGGGR"===this.type},set:function(a){this.type=a?"swizzleGGGR":"default"}}});var dp=ea,ep={partitionSkin:fk,procedural:{calculateTangents:Vj,createMesh:Eb,createTorus:Xj,createCylinder:Ah,
createCapsule:Bh,createCone:Ch,createSphere:Dh,createPlane:Eh,createBox:Xf},BasicMaterial:Jc,Command:Nf,DepthMaterial:Ad,ForwardRenderer:Qf,GraphNode:Z,Material:da,Mesh:fb,MeshInstance:ma,Model:gb,ParticleEmitter:Mb,PhongMaterial:ea,Picker:Uc,Projection:{ORTHOGRAPHIC:1,PERSPECTIVE:0},Scene:ka,Skin:Of,SkinInstance:Rd};Z.prototype._dirtify=function(a){a?this._dirtifyLocal():this._dirtifyWorld()};Z.prototype.addLabel=function(a){this._labels[a]=!0};Z.prototype.getLabels=function(){return Object.keys(this._labels)};
Z.prototype.hasLabel=function(a){return!!this._labels[a]};Z.prototype.removeLabel=function(a){delete this._labels[a]};Z.prototype.findByLabel=function(a,b){var c,d=this._children.length;b=b||[];this.hasLabel(a)&&b.push(this);for(c=0;c<d;++c)b=this._children[c].findByLabel(a,b);return b};Z.prototype.getChildren=function(){return this.children};Z.prototype.getName=function(){return this.name};Z.prototype.getPath=function(){return this.path};Z.prototype.getRoot=function(){return this.root};Z.prototype.getParent=
function(){return this.parent};Z.prototype.setName=function(a){this.name=a};da.prototype.getName=function(){return this.name};da.prototype.setName=function(a){this.name=a};da.prototype.getShader=function(){return this.shader};da.prototype.setShader=function(a){this.shader=a};var fp={Animation:Fb,Key:Yf,Node:Zf,Skeleton:Na},gp={AudioManager:Sb,Channel:Nb,Channel3d:Sa,Listener:Fh,Sound:cg};Sb.prototype.getListener=function(){return this.listener};Sb.prototype.getVolume=function(){return this.volume};
Sb.prototype.setVolume=function(a){this.volume=a};kd.prototype.getAssetById=function(a){return this.get(a)};Object.defineProperty(na.prototype,"ray",{get:function(){return this._rayLocal}});Object.defineProperty(na.prototype,"position",{get:function(){return this._localPosition}});Object.defineProperty(na.prototype,"rotation",{get:function(){return this._localRotation}});var hp={getTouchTargetCoords:Oi,Controller:bb,GamePads:Ni,Keyboard:ab,KeyboardEvent:Ji,Mouse:yb,MouseEvent:Vc,Touch:vg,TouchDevice:re,
TouchEvent:Bd};Object.defineProperty(ff.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});Object.defineProperty(Vc.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});var ip=ge,jp={Application:Y,Component:G,ComponentData:Uk,ComponentSystem:B,Entity:S,FillMode:{NONE:"NONE",FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:mg},ResolutionMode:{AUTO:"AUTO",FIXED:Bi}};Y.prototype.isFullscreen=function(){return!!document.fullscreenElement};Y.prototype.enableFullscreen=function(a,b,c){a=a||this.graphicsDevice.canvas;
var d=function(){b();document.removeEventListener("fullscreenchange",d)},e=function(){c();document.removeEventListener("fullscreenerror",e)};b&&document.addEventListener("fullscreenchange",d,!1);c&&document.addEventListener("fullscreenerror",e,!1);a.requestFullscreen?a.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):c()};Y.prototype.disableFullscreen=function(a){var b=function(){a();document.removeEventListener("fullscreenchange",b)};a&&document.addEventListener("fullscreenchange",b,!1);document.exitFullscreen()};
Object.defineProperty(Qc.prototype,"enable",{get:function(){return this.enabled},set:function(a){this.enabled=a}});Object.defineProperty(Vb.prototype,"bodyType",{get:function(){return this.type},set:function(a){this.type=a}});Vb.prototype.syncBodyToEntity=function(){this._updateDynamic()};td.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};f.ABSOLUTE_URL=Ce;f.ACTION_GAMEPAD="gamepad";f.ACTION_KEYBOARD="keyboard";
f.ACTION_MOUSE="mouse";f.ADDRESS_CLAMP_TO_EDGE=1;f.ADDRESS_MIRRORED_REPEAT=2;f.ADDRESS_REPEAT=0;f.ANIM_EQUAL_TO="EQUAL_TO";f.ANIM_GREATER_THAN="GREATER_THAN";f.ANIM_GREATER_THAN_EQUAL_TO="GREATER_THAN_EQUAL_TO";f.ANIM_INTERRUPTION_NEXT="NEXT_STATE";f.ANIM_INTERRUPTION_NEXT_PREV="NEXT_STATE_PREV_STATE";f.ANIM_INTERRUPTION_NONE="NONE";f.ANIM_INTERRUPTION_PREV="PREV_STATE";f.ANIM_INTERRUPTION_PREV_NEXT="PREV_STATE_NEXT_STATE";f.ANIM_LESS_THAN="LESS_THAN";f.ANIM_LESS_THAN_EQUAL_TO="LESS_THAN_EQUAL_TO";
f.ANIM_NOT_EQUAL_TO="NOT_EQUAL_TO";f.ANIM_PARAMETER_BOOLEAN="BOOLEAN";f.ANIM_PARAMETER_FLOAT="FLOAT";f.ANIM_PARAMETER_INTEGER="INTEGER";f.ANIM_PARAMETER_TRIGGER="TRIGGER";f.ANIM_STATE_END="END";f.ANIM_STATE_START="START";f.ASPECT_AUTO=0;f.ASPECT_MANUAL=1;f.ASSET_ANIMATION="animation";f.ASSET_AUDIO="audio";f.ASSET_CONTAINER="container";f.ASSET_CSS="css";f.ASSET_CUBEMAP="cubemap";f.ASSET_HTML="html";f.ASSET_IMAGE="image";f.ASSET_JSON="json";f.ASSET_MATERIAL="material";f.ASSET_MODEL="model";f.ASSET_SCRIPT=
"script";f.ASSET_SHADER="shader";f.ASSET_TEXT="text";f.ASSET_TEXTURE="texture";f.AXIS_KEY="key";f.AXIS_MOUSE_X="mousex";f.AXIS_MOUSE_Y="mousey";f.AXIS_PAD_L_X="padlx";f.AXIS_PAD_L_Y="padly";f.AXIS_PAD_R_X="padrx";f.AXIS_PAD_R_Y="padry";f.AnimBinder=Tb;f.AnimClip=Se;f.AnimClipHandler=Jh;f.AnimComponent=Oc;f.AnimComponentLayer=gg;f.AnimComponentSystem=Xd;f.AnimController=hg;f.AnimCurve=ag;f.AnimData=Re;f.AnimEvaluator=Ba;f.AnimPropertyLocator=$f;f.AnimSnapshot=ak;f.AnimStateGraph=Kh;f.AnimStateGraphHandler=
Lh;f.AnimTarget=rc;f.AnimTrack=Ud;f.Animation=Fb;f.AnimationComponent=Nc;f.AnimationComponentSystem=Wd;f.AnimationHandler=Ih;f.Application=Y;f.Asset=X;f.AssetListLoader=sb;f.AssetReference=ec;f.AssetRegistry=kd;f.AudioHandler=Ue;f.AudioListenerComponent=md;f.AudioListenerComponentSystem=Yd;f.AudioSourceComponent=nd;f.AudioSourceComponentSystem=Zd;f.BAKE_COLOR=0;f.BAKE_COLORDIR=1;f.BLENDEQUATION_ADD=0;f.BLENDEQUATION_MAX=4;f.BLENDEQUATION_MIN=3;f.BLENDEQUATION_REVERSE_SUBTRACT=2;f.BLENDEQUATION_SUBTRACT=
1;f.BLENDMODE_DST_ALPHA=9;f.BLENDMODE_DST_COLOR=4;f.BLENDMODE_ONE=1;f.BLENDMODE_ONE_MINUS_DST_ALPHA=10;f.BLENDMODE_ONE_MINUS_DST_COLOR=5;f.BLENDMODE_ONE_MINUS_SRC_ALPHA=8;f.BLENDMODE_ONE_MINUS_SRC_COLOR=3;f.BLENDMODE_SRC_ALPHA=6;f.BLENDMODE_SRC_ALPHA_SATURATE=7;f.BLENDMODE_SRC_COLOR=2;f.BLENDMODE_ZERO=0;f.BLEND_ADDITIVE=1;f.BLEND_ADDITIVEALPHA=6;f.BLEND_MAX=10;f.BLEND_MIN=9;f.BLEND_MULTIPLICATIVE=5;f.BLEND_MULTIPLICATIVE2X=7;f.BLEND_NONE=3;f.BLEND_NORMAL=2;f.BLEND_PREMULTIPLIED=4;f.BLEND_SCREEN=8;
f.BLEND_SUBTRACTIVE=0;f.BLUR_BOX=0;f.BLUR_GAUSSIAN=1;f.BODYFLAG_KINEMATIC_OBJECT=2;f.BODYFLAG_NORESPONSE_OBJECT=4;f.BODYFLAG_STATIC_OBJECT=1;f.BODYGROUP_DEFAULT=1;f.BODYGROUP_DYNAMIC=1;f.BODYGROUP_ENGINE_1=8;f.BODYGROUP_ENGINE_2=32;f.BODYGROUP_ENGINE_3=64;f.BODYGROUP_KINEMATIC=4;f.BODYGROUP_NONE=0;f.BODYGROUP_STATIC=yi;f.BODYGROUP_TRIGGER=16;f.BODYGROUP_USER_1=128;f.BODYGROUP_USER_2=256;f.BODYGROUP_USER_3=512;f.BODYGROUP_USER_4=1024;f.BODYGROUP_USER_5=2048;f.BODYGROUP_USER_6=4096;f.BODYGROUP_USER_7=
8192;f.BODYGROUP_USER_8=16384;f.BODYMASK_ALL=65535;f.BODYMASK_NONE=0;f.BODYMASK_NOT_STATIC=lg;f.BODYMASK_NOT_STATIC_KINEMATIC=65529;f.BODYMASK_STATIC=2;f.BODYSTATE_ACTIVE_TAG=1;f.BODYSTATE_DISABLE_DEACTIVATION=4;f.BODYSTATE_DISABLE_SIMULATION=5;f.BODYSTATE_ISLAND_SLEEPING=2;f.BODYSTATE_WANTS_DEACTIVATION=3;f.BODYTYPE_DYNAMIC="dynamic";f.BODYTYPE_KINEMATIC="kinematic";f.BODYTYPE_STATIC=ge;f.BUFFER_DYNAMIC=1;f.BUFFER_GPUDYNAMIC=3;f.BUFFER_STATIC=0;f.BUFFER_STREAM=2;f.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=
1;f.BUTTON_TRANSITION_MODE_TINT=ig;f.BasicMaterial=Jc;f.BasisParser=ki;f.Batch=sh;f.BatchGroup=Ta;f.BatchManager=Aa;f.BinaryHandler=Mh;f.BoundingBox=ia;f.BoundingSphere=Pd;f.Bundle=Ve;f.BundleHandler=Oh;f.BundleRegistry=oi;f.ButtonComponent=od;f.ButtonComponentSystem=$d;f.CLEARFLAG_COLOR=1;f.CLEARFLAG_DEPTH=2;f.CLEARFLAG_STENCIL=4;f.COMPUPDATED_BLEND=8;f.COMPUPDATED_CAMERAS=4;f.COMPUPDATED_INSTANCES=1;f.COMPUPDATED_LIGHTS=2;f.CUBEFACE_NEGX=1;f.CUBEFACE_NEGY=3;f.CUBEFACE_NEGZ=5;f.CUBEFACE_POSX=0;f.CUBEFACE_POSY=
2;f.CUBEFACE_POSZ=4;f.CUBEPROJ_BOX=1;f.CUBEPROJ_NONE=0;f.CULLFACE_BACK=1;f.CULLFACE_FRONT=2;f.CULLFACE_FRONTANDBACK=3;f.CULLFACE_NONE=0;f.CURVE_CARDINAL=3;f.CURVE_CATMULL=2;f.CURVE_LINEAR=0;f.CURVE_SMOOTHSTEP=1;f.CURVE_SPLINE=4;f.CURVE_STEP=5;f.Camera=Pa;f.CameraComponent=Ob;f.CameraComponentSystem=le;f.CanvasFont=lb;f.CollisionComponent=Kd;f.CollisionComponentSystem=ke;f.Color=J;f.Command=Nf;f.Component=G;f.ComponentData=Uk;f.ComponentSystem=B;f.ComponentSystemRegistry=si;f.ContactPoint=Ak;f.ContactResult=
Bk;f.ContainerHandler=Qh;f.ContainerResource=Ph;f.ContextCreationError=Ti;f.Controller=bb;f.CssHandler=Rh;f.CubemapHandler=Sh;f.Curve=Ya;f.CurveSet=rb;f.DETAILMODE_ADD="add";f.DETAILMODE_MAX="max";f.DETAILMODE_MIN="min";f.DETAILMODE_MUL="mul";f.DETAILMODE_OVERLAY="overlay";f.DETAILMODE_SCREEN="screen";f.DISTANCE_EXPONENTIAL="exponential";f.DISTANCE_INVERSE=$e;f.DISTANCE_LINEAR="linear";f.DefaultAnimBinder=Te;f.DepthMaterial=Ad;f.ELEMENTTYPE_FLOAT32=6;f.ELEMENTTYPE_GROUP=sk;f.ELEMENTTYPE_IMAGE="image";
f.ELEMENTTYPE_INT16=2;f.ELEMENTTYPE_INT32=4;f.ELEMENTTYPE_INT8=0;f.ELEMENTTYPE_TEXT="text";f.ELEMENTTYPE_UINT16=3;f.ELEMENTTYPE_UINT32=5;f.ELEMENTTYPE_UINT8=1;f.EMITTERSHAPE_BOX=0;f.EMITTERSHAPE_SPHERE=1;f.EVENT_KEYDOWN="keydown";f.EVENT_KEYUP="keyup";f.EVENT_MOUSEDOWN="mousedown";f.EVENT_MOUSEMOVE="mousemove";f.EVENT_MOUSEUP="mouseup";f.EVENT_MOUSEWHEEL="mousewheel";f.EVENT_SELECT="select";f.EVENT_SELECTEND="selectend";f.EVENT_SELECTSTART="selectstart";f.EVENT_TOUCHCANCEL="touchcancel";f.EVENT_TOUCHEND=
"touchend";f.EVENT_TOUCHMOVE="touchmove";f.EVENT_TOUCHSTART="touchstart";f.ElementComponent=ba;f.ElementComponentSystem=be;f.ElementDragHelper=wc;f.ElementInput=ff;f.ElementInputEvent=Wc;f.ElementMouseEvent=Xc;f.ElementSelectEvent=Yb;f.ElementTouchEvent=xc;f.Entity=S;f.EntityReference=tc;f.EventHandler=H;f.FILLMODE_FILL_WINDOW="FILL_WINDOW";f.FILLMODE_KEEP_ASPECT=mg;f.FILLMODE_NONE="NONE";f.FILTER_LINEAR=1;f.FILTER_LINEAR_MIPMAP_LINEAR=5;f.FILTER_LINEAR_MIPMAP_NEAREST=4;f.FILTER_NEAREST=0;f.FILTER_NEAREST_MIPMAP_LINEAR=
3;f.FILTER_NEAREST_MIPMAP_NEAREST=2;f.FITTING_BOTH=3;f.FITTING_NONE=ui;f.FITTING_SHRINK=2;f.FITTING_STRETCH=1;f.FOG_EXP="exp";f.FOG_EXP2="exp2";f.FOG_LINEAR="linear";f.FOG_NONE="none";f.FONT_BITMAP="bitmap";f.FONT_MSDF="msdf";f.FRESNEL_NONE=0;f.FRESNEL_SCHLICK=2;f.FUNC_ALWAYS=7;f.FUNC_EQUAL=2;f.FUNC_GREATER=4;f.FUNC_GREATEREQUAL=6;f.FUNC_LESS=1;f.FUNC_LESSEQUAL=3;f.FUNC_NEVER=0;f.FUNC_NOTEQUAL=5;f.FolderHandler=Th;f.Font=dg;f.FontHandler=Vh;f.ForwardRenderer=Qf;f.Frustum=ph;f.GAMMA_NONE=0;f.GAMMA_SRGB=
1;f.GAMMA_SRGBFAST=2;f.GAMMA_SRGBHDR=3;f.GamePads=Ni;f.GraphNode=Z;f.GraphicsDevice=kb;f.HierarchyHandler=Wh;f.HtmlHandler=Xh;f.Http=N;f.I18n=Ha;f.INDEXFORMAT_UINT16=1;f.INDEXFORMAT_UINT32=2;f.INDEXFORMAT_UINT8=0;f.INTERPOLATION_CUBIC=2;f.INTERPOLATION_LINEAR=1;f.INTERPOLATION_STEP=0;f.ImageElement=Ua;f.ImgParser=li;f.IndexBuffer=Rb;f.IndexedList=mh;f.JsonHandler=Yh;f.JsonStandardMaterialParser=Vd;f.KEY_0=48;f.KEY_1=49;f.KEY_2=50;f.KEY_3=51;f.KEY_4=52;f.KEY_5=53;f.KEY_6=54;f.KEY_7=55;f.KEY_8=56;f.KEY_9=
57;f.KEY_A=65;f.KEY_ADD=107;f.KEY_ALT=18;f.KEY_B=66;f.KEY_BACKSPACE=8;f.KEY_BACK_SLASH=220;f.KEY_C=67;f.KEY_CAPS_LOCK=20;f.KEY_CLOSE_BRACKET=221;f.KEY_COMMA=188;f.KEY_CONTEXT_MENU=93;f.KEY_CONTROL=17;f.KEY_D=68;f.KEY_DECIMAL=110;f.KEY_DELETE=46;f.KEY_DIVIDE=111;f.KEY_DOWN=40;f.KEY_E=69;f.KEY_END=35;f.KEY_ENTER=13;f.KEY_EQUAL=61;f.KEY_ESCAPE=27;f.KEY_F=70;f.KEY_F1=112;f.KEY_F10=121;f.KEY_F11=122;f.KEY_F12=123;f.KEY_F2=113;f.KEY_F3=114;f.KEY_F4=115;f.KEY_F5=116;f.KEY_F6=117;f.KEY_F7=118;f.KEY_F8=119;
f.KEY_F9=120;f.KEY_G=71;f.KEY_H=72;f.KEY_HOME=36;f.KEY_I=73;f.KEY_INSERT=45;f.KEY_J=74;f.KEY_K=75;f.KEY_L=76;f.KEY_LEFT=37;f.KEY_M=77;f.KEY_META=224;f.KEY_MULTIPLY=106;f.KEY_N=78;f.KEY_NUMPAD_0=96;f.KEY_NUMPAD_1=97;f.KEY_NUMPAD_2=98;f.KEY_NUMPAD_3=99;f.KEY_NUMPAD_4=100;f.KEY_NUMPAD_5=101;f.KEY_NUMPAD_6=102;f.KEY_NUMPAD_7=103;f.KEY_NUMPAD_8=104;f.KEY_NUMPAD_9=105;f.KEY_O=79;f.KEY_OPEN_BRACKET=219;f.KEY_P=80;f.KEY_PAGE_DOWN=34;f.KEY_PAGE_UP=33;f.KEY_PAUSE=19;f.KEY_PERIOD=190;f.KEY_PRINT_SCREEN=44;f.KEY_Q=
81;f.KEY_R=82;f.KEY_RETURN=13;f.KEY_RIGHT=39;f.KEY_S=83;f.KEY_SEMICOLON=59;f.KEY_SEPARATOR=108;f.KEY_SHIFT=16;f.KEY_SLASH=191;f.KEY_SPACE=32;f.KEY_SUBTRACT=109;f.KEY_T=84;f.KEY_TAB=9;f.KEY_U=85;f.KEY_UP=38;f.KEY_V=86;f.KEY_W=87;f.KEY_WINDOWS=91;f.KEY_X=88;f.KEY_Y=89;f.KEY_Z=90;f.Key=Yf;f.Keyboard=ab;f.KeyboardEvent=Ji;f.KtxParser=mi;f.LAYERID_DEPTH=1;f.LAYERID_IMMEDIATE=3;f.LAYERID_SKYBOX=2;f.LAYERID_UI=4;f.LAYERID_WORLD=0;f.LAYER_FX=2;f.LAYER_GIZMO=1;f.LAYER_HUD=0;f.LAYER_WORLD=15;f.LIGHTFALLOFF_INVERSESQUARED=
1;f.LIGHTFALLOFF_LINEAR=0;f.LIGHTTYPE_DIRECTIONAL=0;f.LIGHTTYPE_POINT=1;f.LIGHTTYPE_SPOT=2;f.LINEBATCH_GIZMO=2;f.LINEBATCH_OVERLAY=1;f.LINEBATCH_WORLD=0;f.Layer=fa;f.LayerComposition=pa;f.LayoutCalculator=ti;f.LayoutChildComponent=qd;f.LayoutChildComponentSystem=oe;f.LayoutGroupComponent=Pc;f.LayoutGroupComponentSystem=ce;f.LegacyDdsParser=ni;f.Light=Oa;f.LightComponent=Qc;f.LightComponentSystem=de;f.Lightmapper=wh;f.LocalizedAsset=ya;f.MASK_BAKED=2;f.MASK_DYNAMIC=1;f.MASK_LIGHTMAP=4;f.MOUSEBUTTON_LEFT=
0;f.MOUSEBUTTON_MIDDLE=1;f.MOUSEBUTTON_NONE=-1;f.MOUSEBUTTON_RIGHT=2;f.Mat3=Cb;f.Mat4=C;f.Material=da;f.MaterialHandler=Zh;f.Mesh=fb;f.MeshInstance=ma;f.Model=gb;f.ModelComponent=Ca;f.ModelComponentSystem=ee;f.ModelHandler=$h;f.Morph=Pe;f.MorphInstance=qc;f.MorphTarget=Qe;f.Mouse=yb;f.MouseEvent=Vc;f.Node=Zf;f.ORIENTATION_HORIZONTAL=0;f.ORIENTATION_VERTICAL=1;f.OrientedBox=qh;f.PAD_1=0;f.PAD_2=1;f.PAD_3=2;f.PAD_4=3;f.PAD_DOWN=13;f.PAD_FACE_1=0;f.PAD_FACE_2=1;f.PAD_FACE_3=2;f.PAD_FACE_4=3;f.PAD_LEFT=
14;f.PAD_L_SHOULDER_1=4;f.PAD_L_SHOULDER_2=6;f.PAD_L_STICK_BUTTON=10;f.PAD_L_STICK_X=0;f.PAD_L_STICK_Y=1;f.PAD_RIGHT=15;f.PAD_R_SHOULDER_1=5;f.PAD_R_SHOULDER_2=7;f.PAD_R_STICK_BUTTON=11;f.PAD_R_STICK_X=2;f.PAD_R_STICK_Y=3;f.PAD_SELECT=8;f.PAD_START=9;f.PAD_UP=12;f.PAD_VENDOR=16;f.PARTICLEMODE_CPU=1;f.PARTICLEMODE_GPU=0;f.PARTICLEORIENTATION_EMITTER=2;f.PARTICLEORIENTATION_SCREEN=0;f.PARTICLEORIENTATION_WORLD=1;f.PARTICLESORT_DISTANCE=1;f.PARTICLESORT_NEWER_FIRST=2;f.PARTICLESORT_NONE=0;f.PARTICLESORT_OLDER_FIRST=
3;f.PIXELFORMAT_111110F=18;f.PIXELFORMAT_A8=0;f.PIXELFORMAT_ASTC_4x4=28;f.PIXELFORMAT_ATC_RGB=29;f.PIXELFORMAT_ATC_RGBA=30;f.PIXELFORMAT_DEPTH=16;f.PIXELFORMAT_DEPTHSTENCIL=17;f.PIXELFORMAT_DXT1=8;f.PIXELFORMAT_DXT3=9;f.PIXELFORMAT_DXT5=10;f.PIXELFORMAT_ETC1=21;f.PIXELFORMAT_ETC2_RGB=22;f.PIXELFORMAT_ETC2_RGBA=23;f.PIXELFORMAT_L8=1;f.PIXELFORMAT_L8_A8=2;f.PIXELFORMAT_PVRTC_2BPP_RGBA_1=25;f.PIXELFORMAT_PVRTC_2BPP_RGB_1=24;f.PIXELFORMAT_PVRTC_4BPP_RGBA_1=27;f.PIXELFORMAT_PVRTC_4BPP_RGB_1=26;f.PIXELFORMAT_R32F=
15;f.PIXELFORMAT_R4_G4_B4_A4=5;f.PIXELFORMAT_R5_G5_B5_A1=4;f.PIXELFORMAT_R5_G6_B5=3;f.PIXELFORMAT_R8_G8_B8=6;f.PIXELFORMAT_R8_G8_B8_A8=7;f.PIXELFORMAT_RGB16F=11;f.PIXELFORMAT_RGB32F=13;f.PIXELFORMAT_RGBA16F=12;f.PIXELFORMAT_RGBA32F=14;f.PIXELFORMAT_SRGB=19;f.PIXELFORMAT_SRGBA=20;f.PRIMITIVE_LINELOOP=2;f.PRIMITIVE_LINES=1;f.PRIMITIVE_LINESTRIP=3;f.PRIMITIVE_POINTS=0;f.PRIMITIVE_TRIANGLES=4;f.PRIMITIVE_TRIFAN=6;f.PRIMITIVE_TRISTRIP=5;f.PROJECTION_ORTHOGRAPHIC=1;f.PROJECTION_PERSPECTIVE=0;f.ParticleEmitter=
Mb;f.ParticleSystemComponent=sd;f.ParticleSystemComponentSystem=fe;f.PhongMaterial=dp;f.Picker=Uc;f.Plane=rh;f.PostEffect=Ei;f.PostEffectPass=Wk;f.PostEffectQueue=jg;f.ProgramLibrary=xb;f.Quat=T;f.RENDERSTYLE_POINTS=2;f.RENDERSTYLE_SOLID=0;f.RENDERSTYLE_WIREFRAME=1;f.RESOLUTION_AUTO="AUTO";f.RESOLUTION_FIXED=Bi;f.RIGIDBODY_ACTIVE_TAG=1;f.RIGIDBODY_CF_KINEMATIC_OBJECT=2;f.RIGIDBODY_CF_NORESPONSE_OBJECT=4;f.RIGIDBODY_CF_STATIC_OBJECT=1;f.RIGIDBODY_DISABLE_DEACTIVATION=4;f.RIGIDBODY_DISABLE_SIMULATION=
5;f.RIGIDBODY_ISLAND_SLEEPING=2;f.RIGIDBODY_TYPE_DYNAMIC="dynamic";f.RIGIDBODY_TYPE_KINEMATIC="kinematic";f.RIGIDBODY_TYPE_STATIC=ip;f.RIGIDBODY_WANTS_DEACTIVATION=3;f.Ray=Hc;f.RaycastResult=zi;f.RenderTarget=oa;f.ResourceHandler=Rk;f.ResourceLoader=ai;f.RigidBodyComponent=Vb;f.RigidBodyComponentSystem=td;f.SCALEMODE_BLEND="blend";f.SCALEMODE_NONE=ud;f.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0;f.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1;f.SCROLL_MODE_BOUNCE=1;f.SCROLL_MODE_CLAMP=0;f.SCROLL_MODE_INFINITE=
2;f.SEMANTIC_ATTR="ATTR";f.SEMANTIC_ATTR0="ATTR0";f.SEMANTIC_ATTR1="ATTR1";f.SEMANTIC_ATTR10="ATTR10";f.SEMANTIC_ATTR11="ATTR11";f.SEMANTIC_ATTR12="ATTR12";f.SEMANTIC_ATTR13="ATTR13";f.SEMANTIC_ATTR14="ATTR14";f.SEMANTIC_ATTR15="ATTR15";f.SEMANTIC_ATTR2="ATTR2";f.SEMANTIC_ATTR3="ATTR3";f.SEMANTIC_ATTR4="ATTR4";f.SEMANTIC_ATTR5="ATTR5";f.SEMANTIC_ATTR6="ATTR6";f.SEMANTIC_ATTR7="ATTR7";f.SEMANTIC_ATTR8="ATTR8";f.SEMANTIC_ATTR9="ATTR9";f.SEMANTIC_BLENDINDICES="BLENDINDICES";f.SEMANTIC_BLENDWEIGHT="BLENDWEIGHT";
f.SEMANTIC_COLOR="COLOR";f.SEMANTIC_NORMAL="NORMAL";f.SEMANTIC_POSITION="POSITION";f.SEMANTIC_TANGENT="TANGENT";f.SEMANTIC_TEXCOORD="TEXCOORD";f.SEMANTIC_TEXCOORD0="TEXCOORD0";f.SEMANTIC_TEXCOORD1="TEXCOORD1";f.SEMANTIC_TEXCOORD2="TEXCOORD2";f.SEMANTIC_TEXCOORD3="TEXCOORD3";f.SEMANTIC_TEXCOORD4="TEXCOORD4";f.SEMANTIC_TEXCOORD5="TEXCOORD5";f.SEMANTIC_TEXCOORD6="TEXCOORD6";f.SEMANTIC_TEXCOORD7="TEXCOORD7";f.SHADERDEF_DIRLM=128;f.SHADERDEF_INSTANCING=32;f.SHADERDEF_LM=64;f.SHADERDEF_MORPH_NORMAL=2048;
f.SHADERDEF_MORPH_POSITION=1024;f.SHADERDEF_NOSHADOW=1;f.SHADERDEF_SCREENSPACE=256;f.SHADERDEF_SKIN=2;f.SHADERDEF_TANGENTS=512;f.SHADERDEF_UV0=4;f.SHADERDEF_UV1=8;f.SHADERDEF_VCOLOR=16;f.SHADERTAG_MATERIAL=1;f.SHADER_DEPTH=2;f.SHADER_FORWARD=0;f.SHADER_FORWARDHDR=1;f.SHADER_PICK=18;f.SHADER_SHADOW=3;f.SHADOWUPDATE_NONE=0;f.SHADOWUPDATE_REALTIME=2;f.SHADOWUPDATE_THISFRAME=1;f.SHADOW_DEPTH=0;f.SHADOW_PCF3=0;f.SHADOW_PCF5=4;f.SHADOW_VSM16=2;f.SHADOW_VSM32=3;f.SHADOW_VSM8=1;f.SORTKEY_DEPTH=1;f.SORTKEY_FORWARD=
0;f.SORTMODE_BACK2FRONT=3;f.SORTMODE_CUSTOM=5;f.SORTMODE_FRONT2BACK=4;f.SORTMODE_MANUAL=1;f.SORTMODE_MATERIALMESH=2;f.SORTMODE_NONE=0;f.SPECOCC_AO=1;f.SPECOCC_GLOSSDEPENDENT=2;f.SPECOCC_NONE=0;f.SPECULAR_BLINN=1;f.SPECULAR_PHONG=0;f.SPRITETYPE_ANIMATED="animated";f.SPRITETYPE_SIMPLE="simple";f.SPRITE_RENDERMODE_SIMPLE=0;f.SPRITE_RENDERMODE_SLICED=1;f.SPRITE_RENDERMODE_TILED=2;f.STENCILOP_DECREMENT=5;f.STENCILOP_DECREMENTWRAP=6;f.STENCILOP_INCREMENT=3;f.STENCILOP_INCREMENTWRAP=4;f.STENCILOP_INVERT=
7;f.STENCILOP_KEEP=0;f.STENCILOP_REPLACE=2;f.STENCILOP_ZERO=1;f.Scene=ka;f.SceneHandler=bi;f.SceneRegistry=Xb;f.SceneRegistryItem=Gk;f.SceneSettingsHandler=ci;f.ScopeId=ng;f.ScopeSpace=og;f.ScreenComponent=vb;f.ScreenComponentSystem=he;f.ScriptAttributes=vd;f.ScriptComponent=Qa;f.ScriptComponentSystem=ie;f.ScriptHandler=hb;f.ScriptLegacyComponent=wd;f.ScriptLegacyComponentSystem=me;f.ScriptRegistry=Ub;f.ScriptType=Va;f.ScrollViewComponent=Rc;f.ScrollViewComponentSystem=ne;f.ScrollbarComponent=xd;
f.ScrollbarComponentSystem=je;f.Shader=Qd;f.ShaderHandler=di;f.SingleContactResult=zk;f.Skeleton=Na;f.Skin=Of;f.SkinInstance=Rd;f.SortedLoopArray=Wb;f.Sound=cg;f.SoundComponent=yd;f.SoundComponentSystem=Tc;f.SoundManager=Sb;f.SoundSlot=Da;f.Sprite=Ma;f.SpriteAnimationClip=jb;f.SpriteComponent=ua;f.SpriteComponentSystem=zd;f.SpriteHandler=ei;f.StandardMaterial=ea;f.StencilParameters=pd;f.TEXHINT_ASSET=2;f.TEXHINT_LIGHTMAP=3;f.TEXHINT_NONE=0;f.TEXHINT_SHADOWMAP=1;f.TEXTURELOCK_READ=1;f.TEXTURELOCK_WRITE=
2;f.TEXTURETYPE_DEFAULT="default";f.TEXTURETYPE_RGBE="rgbe";f.TEXTURETYPE_RGBM="rgbm";f.TEXTURETYPE_SWIZZLEGGGR="swizzleGGGR";f.TONEMAP_ACES=3;f.TONEMAP_ACES2=4;f.TONEMAP_FILMIC=1;f.TONEMAP_HEJL=2;f.TONEMAP_LINEAR=0;f.TYPE_FLOAT32=6;f.TYPE_INT16=2;f.TYPE_INT32=4;f.TYPE_INT8=0;f.TYPE_UINT16=3;f.TYPE_UINT32=5;f.TYPE_UINT8=1;f.Tags=Gc;f.Template=Ye;f.TemplateHandler=hi;f.TemplateUtils=mc;f.TextElement=ha;f.TextHandler=ii;f.Texture=L;f.TextureAtlas=fc;f.TextureAtlasHandler=ji;f.TextureHandler=fg;f.TextureParser=
hk;f.Timer=nh;f.Touch=vg;f.TouchDevice=re;f.TouchEvent=Bd;f.TransformFeedback=cf;f.UNIFORMTYPE_BOOL=0;f.UNIFORMTYPE_BVEC2=9;f.UNIFORMTYPE_BVEC3=10;f.UNIFORMTYPE_BVEC4=11;f.UNIFORMTYPE_FLOAT=2;f.UNIFORMTYPE_FLOATARRAY=17;f.UNIFORMTYPE_INT=1;f.UNIFORMTYPE_IVEC2=6;f.UNIFORMTYPE_IVEC3=7;f.UNIFORMTYPE_IVEC4=8;f.UNIFORMTYPE_MAT2=12;f.UNIFORMTYPE_MAT3=13;f.UNIFORMTYPE_MAT4=14;f.UNIFORMTYPE_TEXTURE2D=15;f.UNIFORMTYPE_TEXTURE2D_SHADOW=18;f.UNIFORMTYPE_TEXTURE3D=20;f.UNIFORMTYPE_TEXTURECUBE=16;f.UNIFORMTYPE_TEXTURECUBE_SHADOW=
19;f.UNIFORMTYPE_VEC2=3;f.UNIFORMTYPE_VEC3=4;f.UNIFORMTYPE_VEC4=5;f.URI=Kf;f.UnsupportedBrowserError=Si;f.VIEW_CENTER=0;f.VIEW_LEFT=1;f.VIEW_RIGHT=2;f.Vec2=M;f.Vec3=r;f.Vec4=U;f.VertexBuffer=Za;f.VertexFormat=Ka;f.VertexIterator=Db;f.VrDisplay=ld;f.VrManager=Mc;f.XRHAND_LEFT="left";f.XRHAND_NONE="none";f.XRHAND_RIGHT="right";f.XRSPACE_BOUNDEDFLOOR="bounded-floor";f.XRSPACE_LOCAL="local";f.XRSPACE_LOCALFLOOR="local-floor";f.XRSPACE_UNBOUNDED="unbounded";f.XRSPACE_VIEWER="viewer";f.XRTARGETRAY_GAZE=
"gaze";f.XRTARGETRAY_POINTER="tracked-pointer";f.XRTARGETRAY_SCREEN="screen";f.XRTRACKABLE_MESH="mesh";f.XRTRACKABLE_PLANE="plane";f.XRTRACKABLE_POINT="point";f.XRTYPE_AR="immersive-ar";f.XRTYPE_INLINE="inline";f.XRTYPE_VR="immersive-vr";f.XrHitTest=Gb;f.XrHitTestSource=sc;f.XrInput=tb;f.XrInputSource=na;f.XrLightEstimation=$a;f.XrManager=Ia;f.ZoneComponent=Sc;f.ZoneComponentSystem=pe;f.anim=fp;f.apps={};f.asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",
ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"};f.audio=gp;f.basisDownload=Pk;f.basisDownloadFromConfig=Qk;f.basisInitialize=Gi;f.basisTargetFormat=Nk;f.basisTranscode=function(a,b,c,d){ef?Ok(a,b,c,d):(Hi.push({url:a,data:b,callback:c,options:d}),Ii||Qk())};f.calculateNormals=Uj;f.calculateTangents=Vj;f.common={};f.config={};f.createBox=Xf;f.createCapsule=Bh;f.createCone=Ch;f.createCylinder=Ah;f.createMesh=Eb;f.createPlane=
Eh;f.createScript=wb;f.createSphere=Dh;f.createStyle=function(a){var b=document.createElement("style");b.type="text/css";b.styleSheet?b.styleSheet.cssText=a:b.appendChild(document.createTextNode(a));return b};f.createTorus=Xj;f.createURI=function(a){var b="";if((a.authority||a.scheme)&&(a.host||a.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(a.host&&a.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(a.path&&a.hostpath)throw Error("Can't have 'path' and 'hostpath' option");
a.scheme&&(b+=a.scheme+":");a.authority&&(b+="//"+a.authority);a.host&&(b+=a.host);a.path&&(b+=a.path);a.hostpath&&(b+=a.hostpath);a.query&&(b+="?"+a.query);a.fragment&&(b+="#"+a.fragment);return b};f.data={};f.debug=bo;f.drawFullscreenQuad=Mk;f.drawQuadWithShader=La;f.drawTexture=function(a,b,c,d,e,f,k){d=d||a.getCopyShader();a.constantTexSource.setValue(b);La(a,c,d,e,f,k)};f.events=jf;f.extend=Ec;f.fw=jp;f.getTouchTargetCoords=Oi;f.gfx=bp;f.guid=Yk;f.http=qa;f.inherits=function(a,b){var c=function(){},
d=function(c,d,f,l,h,p,n,m){b.call(this,c,d,f,l,h,p,n,m);a.call(this,c,d,f,l,h,p,n,m)};d._super=b.prototype;c.prototype=b.prototype;d.prototype=new c;return d};f.input=hp;f.isDefined=kh;f.log=jh;f.makeArray=gd;f.math=O;f.now=zb;f.path=V;f.platform=va;f.posteffect=cp;f.prefilterCubemap=function(a){var b=a.device,c=a.sourceCubemap,d=a.method,e=a.samples,f=a.cpuSync;if(f&&!c._levels[0])console.error("ERROR: prefilter: cubemap must have _levels");else{var k=K,l=c.type,h="rgbm"===l;e=k.createShaderFromCode(b,
k.fullscreenQuadVS,k.rgbmPS+k.prefilterCubemapPS.replace(/\$METHOD/g,0===d?"cos":"phong").replace(/\$NUMSAMPLES/g,e).replace(/\$textureCube/g,h?"textureCubeRGBM":"textureCube"),"prefilter"+d+e+h);var p=k.createShaderFromCode(b,k.fullscreenQuadVS,k.outputCubemapPS,"outputCubemap"),n=b.scope.resolve("source"),m=b.scope.resolve("params"),q=new U,r=c.width;k=c.format;var t=[[],a.filteredFixed,a.filteredRgbm,a.filteredFixedRgbm],y=0===d?[.9,.85,.7,.4,.25,.15,.1]:[512,128,32,8,2,1,1],w=[64,32,16,8,4,2,
1],v;var x=!1;f&&(x=c._levels[0][0]instanceof HTMLImageElement);if((6===k||x)&&f){k=7;var z=new L(b,{cubemap:!0,type:l,format:k,width:r,height:r,mipmaps:!1});z.name="prefiltered-cube";for(v=0;6>v;v++){var A=new oa(b,z,{face:v,depth:!1});q.x=v;q.y=0;n.setValue(c);m.setValue(q.data);La(b,A,p);pg(b,A,v)}c=z}if(128<r){var B=Math.round(Math.log2(r))-Math.round(Math.log2(128));for(x=0;x<B;x++){r=.5*c.width;var C=0===d?1:Math.pow(2,Math.round(Math.log2(y[0])+2*(B-x)));z=new L(b,{cubemap:!0,type:l,format:k,
width:r,height:r,mipmaps:!1});z.name="prefiltered-cube";for(v=0;6>v;v++)A=new oa(b,z,{face:v,depth:!1}),q.x=v,q.y=C,q.z=r,q.w=h?3:0,n.setValue(c),m.setValue(q.data),La(b,A,p),x===B-1&&f&&pg(b,A,v);c=z}}a.sourceCubemap=c;z=null;if(!h&&a.filteredFixedRgbm)for(z=new L(b,{cubemap:!0,type:"rgbm",format:7,width:r,height:r,mipmaps:!1}),z.name="prefiltered-cube",v=0;6>v;v++)A=new oa(b,z,{face:v,depth:!1}),q.x=v,q.w=2,n.setValue(c),m.setValue(q.data),La(b,A,p),pg(b,A,v);r=0===d?1:2048;A=0===d?0:-1;t[A]=[];
for(x=0;7>x;x++)for(p=A;p<t.length;p++)null!=t[p]&&(t[p][x]=new L(b,{cubemap:!0,type:2>p?l:"rgbm",format:2>p?k:7,fixCubemapSeams:1===p||3===p,width:w[x],height:w[x],mipmaps:!1}),t[p][x].name="prefiltered-cube");for(p=A;p<t.length;p++)if(null!=t[p])if(1<p&&h)t[p]=t[p-2];else for(x=0;7>x;x++)for(v=0;6>v;v++)A=new oa(b,t[p][x],{face:v,depth:!1}),q.x=v,q.y=0>p?r:y[x],q.z=w[x],q.w=h?3:p,n.setValue(0===x?c:0===d?t[0][x-1]:t[-1][x-1]),m.setValue(q.data),La(b,A,e),f&&pg(b,A,v);a.filtered=t[0];if(f&&a.singleFilteredFixed){c=
[c].concat(a.filteredFixed);l=new L(b,{cubemap:!0,type:l,fixCubemapSeams:!0,format:k,width:128,height:128,addressU:1,addressV:1});l.name="prefiltered-cube";for(x=0;x<c.length;x++)l._levels[x]=c[x]._levels[0];l.upload();l._prefilteredMips=!0;a.singleFilteredFixed=l}if(f&&a.singleFilteredFixedRgbm&&a.filteredFixedRgbm){c=[z].concat(a.filteredFixedRgbm);l=new L(b,{cubemap:!0,type:"rgbm",fixCubemapSeams:!0,format:7,width:128,height:128,addressU:1,addressV:1});l.name="prefiltered-cube";for(x=0;x<c.length;x++)l._levels[x]=
c[x]._levels[0];l.upload();l._prefilteredMips=!0;a.singleFilteredFixedRgbm=l}}};f.programlib=aa;f.registerScript=Ek;f.revision="fb8f6a3";f.scene=ep;f.script=ib;f.shFromCubemap=Kk;f.shaderChunks=K;f.shape=ap;f.string=dc;f.time=$o;f.type=za;f.typedArrayIndexFormats=cl;f.typedArrayIndexFormatsByteSize=[1,2,4];f.typedArrayToType=Vi;f.typedArrayTypes=Mf;f.typedArrayTypesByteSize=Lf;f.version="1.29.0";Object.defineProperty(f,"__esModule",{value:!0})});